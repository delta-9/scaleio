function printStackTrace(t){t=t||{guess:!0};for(var e=t.e||null,i=!!t.guess,o=new printStackTrace.implementation,n=o.run(e),r=i?o.guessAnonymousFunctions(n):n,s=0;s<4;s++)r.shift();return r}printStackTrace.implementation=function(){},printStackTrace.implementation.prototype={run:function(t){t=t||this.createException();var e=this.mode(t);return"other"===e?this.other(arguments.callee):this[e](t)},createException:function(){try{return this.undef(),null}catch(t){return t}},mode:function(t){return t.arguments&&t.stack?this._mode="chrome":t.message&&"undefined"!=typeof window&&window.opera?this._mode=t.stacktrace?"opera10":"opera":t.stack?this._mode="firefox":this._mode="other"},instrumentFunction:function(t,e,i){t=t||window;var o=t[e];t[e]=function(){return i.call(this,printStackTrace().slice(4)),t[e]._instrumented.apply(this,arguments)},t[e]._instrumented=o},deinstrumentFunction:function(t,e){t[e].constructor===Function&&t[e]._instrumented&&t[e]._instrumented.constructor===Function&&(t[e]=t[e]._instrumented)},chrome:function(t){var e=(t.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");return e.pop(),e},firefox:function(t){return t.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n")},opera10:function(t){var e,i,o,n=t.stacktrace,r=n.split("\n"),s=/.*line (\d+), column (\d+) in ((<anonymous function\:?\s*(\S+))|([^\(]+)\([^\)]*\))(?: in )?(.*)\s*$/i;for(e=2,i=0,o=r.length;e<o-2;e++)if(s.test(r[e])){var a=RegExp.$6+":"+RegExp.$1+":"+RegExp.$2,h=RegExp.$3;h=h.replace(/<anonymous function\:?\s?(\S+)?>/g,"{anonymous}"),r[i++]=h+"@"+a}return r.splice(i,r.length-i),r},opera:function(t){var e,i,o,n=t.message.split("\n"),r=/Line\s+(\d+).*script\s+(http\S+)(?:.*in\s+function\s+(\S+))?/i;for(e=4,i=0,o=n.length;e<o;e+=2)r.test(n[e])&&(n[i++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:"{anonymous}()@"+RegExp.$2+":"+RegExp.$1)+" -- "+n[e+1].replace(/^\s+/,""));return n.splice(i,n.length-i),n},other:function(t){for(var e,i,o=/function\s*([\w\-$]+)?\s*\(/i,n=[];t&&n.length<10;)e=o.test(t.toString())?RegExp.$1||"{anonymous}":"{anonymous}",i=Array.prototype.slice.call(t.arguments||[]),n[n.length]=e+"("+this.stringifyArguments(i)+")",t=t.caller;return n},stringifyArguments:function(t){for(var e=Array.prototype.slice,i=0;i<t.length;++i){var o=t[i];void 0===o?t[i]="undefined":null===o?t[i]="null":o.constructor&&(o.constructor===Array?o.length<3?t[i]="["+this.stringifyArguments(o)+"]":t[i]="["+this.stringifyArguments(e.call(o,0,1))+"..."+this.stringifyArguments(e.call(o,-1))+"]":o.constructor===Object?t[i]="#object":o.constructor===Function?t[i]="#function":o.constructor===String&&(t[i]='"'+o+'"'))}return t.join(",")},sourceCache:{},ajax:function(t){var e=this.createXMLHTTPObject();if(e)return e.open("GET",t,!1),e.send(""),e.responseText},createXMLHTTPObject:function(){for(var t,e=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],i=0;i<e.length;i++)try{return t=e[i](),this.createXMLHTTPObject=e[i],t}catch(t){}},isSameDomain:function(t){return-1!==t.indexOf(location.hostname)},getSource:function(t){return t in this.sourceCache||(this.sourceCache[t]=this.ajax(t).split("\n")),this.sourceCache[t]},guessAnonymousFunctions:function(t){for(var e=0;e<t.length;++e){var i=/\{anonymous\}\(.*\)@(\w+:\/\/([\-\w\.]+)+(:\d+)?[^:]+):(\d+):?(\d+)?/,o=t[e],n=i.exec(o);if(n){var r=n[1],s=n[4],a=n[7]||0;if(r&&this.isSameDomain(r)&&s){var h=this.guessAnonymousFunction(r,s,a);t[e]=o.replace("{anonymous}",h)}}}return t},guessAnonymousFunction:function(t,e,i){var o;try{o=this.findFunctionName(this.getSource(t),e)}catch(e){o="getSource failed with url: "+t+", exception: "+e.toString()}return o},findFunctionName:function(t,e){for(var i,o,n=/function\s+([^(]*?)\s*\(([^)]*)\)/,r=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*function\b/,s=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(?:eval|new Function)\b/,a="",h=0;h<10;++h)if(i=t[e-h]){if(a=i+a,(o=r.exec(a))&&o[1])return o[1];if((o=n.exec(a))&&o[1])return o[1];if((o=s.exec(a))&&o[1])return o[1]}return"(?)"}},ige=null,igeVersion="v1.6.0@2015-04-29.001",igeClassStore={},igeConfig={debug:{_enabled:!0,_node:"undefined"!=typeof module&&void 0!==module.exports,_level:["log","warning","error"],_stacks:!0,_throwErrors:!0,_timing:!0,enabled:function(t){return void 0!==t?(this._enabled=t,t||(this._timing=!1,ige&&ige.showStats(0)),this):this._enabled}}},igeConfig.debug._node&&(igeConfig.debug._util=require("util")),Object.defineProperty(Object.prototype,"tween",{enumerable:!1,writable:!0,configurable:!0}),Object.prototype.tween=function(t,e,i){var o=(new IgeTween).targetObj(this).properties(t).duration(e);return i&&(i.beforeTween&&o.beforeTween(i.beforeTween),i.afterTween&&o.afterTween(i.afterTween),i.easing&&o.easing(i.easing),i.startTime&&o.startTime(i.startTime)),o},Object.defineProperty(Object.prototype,"theSameAs",{enumerable:!1,writable:!0,configurable:!0}),Object.prototype.theSameAs=function(t){return JSON.stringify(this)===JSON.stringify(t)},Object.defineProperty(Array.prototype,"clone",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.clone=function(){var t,e=[];for(t in this)this.hasOwnProperty(t)&&(this[t]instanceof Array?e[t]=this[t].clone():e[t]=this[t]);return e},Object.defineProperty(Array.prototype,"pull",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.pull=function(t){var e=this.indexOf(t);return e>-1?(this.splice(e,1),e):-1},Object.defineProperty(Array.prototype,"pushUnique",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.pushUnique=function(t){return-1===this.indexOf(t)&&(this.push(t),!0)},Object.defineProperty(Array.prototype,"each",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.each=function(t){var e,i=this.length;for(e=0;e<i;e++)t(this[e])},Object.defineProperty(Array.prototype,"eachReverse",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.eachReverse=function(t){var e,i=this.length;for(e=i-1;e>=0;e--)t(this[e])},Object.defineProperty(Array.prototype,"destroyAll",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.destroyAll=function(){var t,e=this.length;for(t=e-1;t>=0;t--)"function"==typeof this[t].destroy&&this[t].destroy()},Object.defineProperty(Array.prototype,"eachIsolated",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.eachIsolated=function(t){var e,i=[],o=i.length;for(e=0;e<o;e++)i[e]=this[e];for(e=0;e<o;e++)t(i[e])},Object.defineProperty(Math,"PI180",{enumerable:!1,writable:!0,configurable:!0}),Math.PI180=Math.PI/180,Object.defineProperty(Math,"PI180R",{enumerable:!1,writable:!0,configurable:!0}),Math.PI180R=180/Math.PI,Object.defineProperty(Math,"toIso",{enumerable:!1,writable:!0,configurable:!0}),Math.toIso=function(t,e,i){return{x:t-e,y:1.2247*-i+.5*(t+e)}},Object.defineProperty(Math,"radians",{enumerable:!1,writable:!0,configurable:!0}),Math.radians=function(t){return t*Math.PI180},Object.defineProperty(Math,"degrees",{enumerable:!1,writable:!0,configurable:!0}),Math.degrees=function(t){return t*Math.PI180R},Object.defineProperty(Math,"distance",{enumerable:!1,writable:!0,configurable:!0}),Math.distance=function(t,e,i,o){return Math.sqrt((t-i)*(t-i)+(e-o)*(e-o))},"undefined"!=typeof CanvasRenderingContext2D&&(Object.defineProperty(CanvasRenderingContext2D.prototype,"circle",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(CanvasRenderingContext2D.prototype,"strokeCircle",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(CanvasRenderingContext2D.prototype,"fillCircle",{enumerable:!1,writable:!0,configurable:!0}),CanvasRenderingContext2D.prototype.circle=function(t,e,i){this.arc(t,e,i,0,2*Math.PI,!1)},CanvasRenderingContext2D.prototype.strokeCircle=function(t,e,i){this.save(),this.beginPath(),this.arc(t,e,i,0,2*Math.PI,!1),this.stroke(),this.restore()},CanvasRenderingContext2D.prototype.fillCircle=function(t,e,i){this.save(),this.beginPath(),this.arc(t,e,i,0,2*Math.PI,!1),this.fill(),this.restore()}),"undefined"!=typeof ImageData&&(Object.defineProperty(ImageData.prototype,"pixelAt",{enumerable:!1,writable:!0,configurable:!0}),ImageData.prototype.pixelAt=function(t,e){var i=this.data,o=e*this.width*4+4*t;return{r:i[o],g:i[o+1],b:i[o+2],a:i[o+3]}},Object.defineProperty(ImageData.prototype,"isTransparent",{enumerable:!1,writable:!0,configurable:!0}),ImageData.prototype.isTransparent=function(t,e){return 0===this.data[e*this.width*4+4*t+3]},Object.defineProperty(ImageData.prototype,"makeTransparent",{enumerable:!1,writable:!0,configurable:!0}),ImageData.prototype.makeTransparent=function(t,e){this.data[e*this.width*4+4*t+3]=0});var disableContextMenu=function(t){null!==t&&(t.oncontextmenu=function(){return!1})};Array.prototype.indexOf||(Object.defineProperty(Array.prototype,"indexOf",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.indexOf=function(t){var e,i=this.length;for(e=0;e<i;e++)if(this[e]===t)return e;return-1}),"undefined"!=typeof window?requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){setTimeout(function(){t((new Date).getTime())},1e3/60)}}():requestAnimFrame=function(){return function(t,e){setTimeout(function(){t((new Date).getTime())},1e3/60)}}(),"object"==typeof console?"function"==typeof console.log&&(void 0===console.info&&(console.info=console.log),void 0===console.warn&&(console.warn=console.log)):console={log:function(){},warn:function(){},info:function(){},error:function(){}};var IgeClass=function(){var t=!1,e=(/xyz/.test(function(){xyz}),function(){}),i=function(t,e,i){if(igeConfig.debug._enabled){var o,n;if(n=void 0!==this._id?":"+this._id:"",e=e||"log",void 0!==i&&console.warn(i),"warning"!==e&&"error"!==e||igeConfig.debug._stacks&&(igeConfig.debug._node?console.trace?console.trace():(o=(new Error).stack,console.log("Stack:",o)):"function"==typeof printStackTrace&&console.log("Stack:",printStackTrace().join("\n ---- "))),"error"===e){if("undefined"!=typeof ige&&(console.log("IGE *"+e+"* ["+(this._classId||this.prototype._classId)+n+"] : Error encountered, stopping engine to prevent console spamming..."),ige.stop()),igeConfig.debug._throwErrors)throw"IGE *"+e+"* ["+(this._classId||this.prototype._classId)+n+"] : "+t;console.log("IGE *"+e+"* ["+(this._classId||this.prototype._classId)+n+"] : "+t)}else console.log("IGE *"+e+"* ["+(this._classId||this.prototype._classId)+n+"] : "+t)}return this},o=function(){return this._classId},n=function(t,e){var i=new t(this,e);return this[i.componentId]=i,this._components=this._components||[],this._components.push(i),this},r=function(t){return this[t]&&this[t].destroy&&this[t].destroy(),this._components&&this._components.pull(this[t]),delete this[t],this},s=function(t,e){var i,o=t.prototype||t;for(i in o)o.hasOwnProperty(i)&&(e||void 0===this[i])&&(this[i]=o[i]);return this},a=function(t,e){if(void 0!==t)return void 0!==e?(this._data=this._data||{},this._data[t]=e,this):this._data?this._data[t]:null};return e.extend=function(){function e(){!t&&this.init&&this.init.apply(this,arguments)}var h,l,c,u,m,d,p,_=arguments[arguments.length-1],f=arguments[0];if(!_.classId)throw console.log(_),"Cannot create a new class without giving the class a classId property!";if(igeClassStore[_.classId])throw'Cannot create class with classId "'+_.classId+'" because a class with that ID has already been created!';t=!0,l=new this,t=!1;for(h in _)_.hasOwnProperty(h)&&(l[h]=_[h]);if(arguments.length>1&&f&&f.length)for(m=0;m<f.length;m++){c=f[m],p=c.extension.prototype||c.extension,u=c.overwrite;for(d in p)p.hasOwnProperty(d)&&(u||void 0===l[d])&&(l[d]=p[d])}return e.prototype=l,e.prototype.constructor=e,e.extend=arguments.callee,e.prototype.log=i,e.prototype.data=a,e.prototype.classId=o,e.prototype._classId=_.classId||"IgeClass",e.prototype.addComponent=n,e.prototype.removeComponent=r,e.prototype.implement=s,e.prototype.__igeEditor=_.editorOptions,igeClassStore[_.classId]=e,e},e.vanilla=function(t){var e=t.init||function(){},h=new this;for(name in t)t.hasOwnProperty(name)&&"init"!==name&&(h[name]=t[name]);return e.prototype=h,e.prototype.constructor=e,e.extend=this.extend,e.prototype.log=i,e.prototype.data=a,e.prototype.classId=o,e.prototype._classId=t.classId||"IgeClass",e.prototype.addComponent=n,e.prototype.removeComponent=r,e.prototype.implement=s,igeClassStore[t.classId]=e,e},e.prototype._classId="IgeClass",e}();"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeClass);var IgeEventingClass=IgeClass.extend({classId:"IgeEventingClass",on:function(t,e,i,o,n){var r,s,a,h,l,c,u,m,d,p=this;if(this._eventListeners=this._eventListeners||{},"function"==typeof e){if("string"==typeof t)return r={call:e,context:i,oneShot:o,sendEventName:n},h=this._eventListeners[t]=this._eventListeners[t]||[],s=!0,a=h.indexOf(r),a>-1&&(s=!1),s&&h.push(r),r;if(t.length){l=[],l[0]=0,l[1]=0,l[3]=function(t){l[1]++,l[0]===l[1]&&e.apply(i||p)};for(c in t)t.hasOwnProperty(c)&&(u=t[c],m=u[0],d=u[1],l[0]++,m.on(d,l[3],null,!0,!0))}}else"string"!=typeof t&&(t="*Multi-Event*"),this.log('Cannot register event listener for event "'+t+'" because the passed callback is not a function!',"error")},off:function(t,e,i){if(this._eventListeners){if(this._eventListeners._processing)return this._eventListeners._removeQueue=this._eventListeners._removeQueue||[],this._eventListeners._removeQueue.push([t,e,i]),-1;if(this._eventListeners[t]){var o=this._eventListeners[t].indexOf(e);if(o>-1)return this._eventListeners[t].splice(o,1),i&&i(!0),!0;this.log('Failed to cancel event listener for event named "'+t+'" !',"warning",e)}else this.log("Failed to cancel event listener!")}return i&&i(!1),!1},emit:function(t,e){if(this._eventListeners&&this._eventListeners[t]){var i,o,n,r,s,a,h=this._eventListeners[t].length,l=this._eventListeners[t].length-1;if(h){if(i=[],"object"==typeof e&&null!==e&&null!==e[0]&&void 0!==e[0])for(o in e)e.hasOwnProperty(o)&&(i[o]=e[o]);else i=[e];for(n=!1,this._eventListeners._processing=!0;h--;)r=l-h,s=this._eventListeners[t][r],s.sendEventName&&(i=[t]),a=s.call.apply(s.context||this,i),!0===a&&(n=!0),s.oneShot&&!0===this.off(t,s)&&l--;if(this._eventListeners&&(this._eventListeners._processing=!1,this._processRemovals()),n)return 1}}},eventList:function(){return this._eventListeners},_processRemovals:function(){if(this._eventListeners){var t,e,i,o=this._eventListeners._removeQueue;if(o)for(t=o.length;t--;)e=o[t],i=this.off(e[0],e[1]),"function"==typeof o[2]&&o[2](i);delete this._eventListeners._removeQueue}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeEventingClass);var IgePoint2d=IgeClass.extend({classId:"IgePoint2d",init:function(t,e,i){return this.x=t=void 0!==t?t:0,this.y=e=void 0!==e?e:0,this._floor=void 0!==i,this._floor?(this.x2=Math.floor(t/2),this.y2=Math.floor(e/2)):(this.x2=t/2,this.y2=e/2),this},floor:function(t){return void 0!==t?(this._floor=t,this):this._floor},compare:function(t){return t&&this.x===t.x&&this.y===t.y},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},toIso:function(){return{x:this.x-this.y,y:.5*(this.x+this.y)}},thisToIso:function(){var t=this.toIso();return this.x=t.x,this.y=t.y,this},to2d:function(){return{x:this.y+this.x/2,y:this.y-this.x/2}},thisTo2d:function(){var t=this.to2d();return this.x=t.x,this.y=t.y,this},addPoint:function(t){return new IgePoint2d(this.x+t.x,this.y+t.y)},thisAddPoint:function(t){return this.x+=t.x,this.y+=t.y,this},minusPoint:function(t){return new IgePoint2d(this.x-t.x,this.y-t.y)},thisMinusPoint:function(t){return this.x-=t.x,this.y-=t.y,this},multiply:function(t,e){return new IgePoint2d(this.x*t,this.y*e)},multiplyPoint:function(t){return new IgePoint2d(this.x*t.x,this.y*t.y)},thisMultiply:function(t,e){return this.x*=t,this.y*=e,this},divide:function(t,e){return new IgePoint2d(this.x/t,this.y/e)},dividePoint:function(t){var e=this.x,i=this.y;return t.x&&(e=this.x/t.x),t.y&&(i=this.y/t.y),new IgePoint2d(e,i)},thisDivide:function(t,e){return this.x/=t,this.y/=e,this},clone:function(){return new IgePoint2d(this.x,this.y)},interpolate:function(t,e,i,o){var n=t.x-this.x,r=t.y-this.y,s=o-e,a=s-(i-e),h=a/s;return new IgePoint2d(t.x-n*h,t.y-r*h)},rotate:function(t){var e=Math.sin(t),i=Math.cos(t),o=i*this.x-e*this.y,n=e*this.x-i*this.y;return new IgePoint2d(o,n)},thisRotate:function(t){var e=Math.sin(t),i=Math.cos(t),o=this.x,n=this.y;return this.x=i*o-e*n,this.y=e*o-i*n,this},toString:function(t){return void 0===t&&(t=2),this.x.toFixed(t)+","+this.y.toFixed(t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePoint2d);var IgePoint3d=IgeClass.extend({classId:"IgePoint3d",init:function(t,e,i,o){return this.x=t=void 0!==t?t:0,this.y=e=void 0!==e?e:0,this.z=i=void 0!==i?i:0,this._floor=void 0!==o,this._floor?(this.x2=Math.floor(t/2),this.y2=Math.floor(e/2),this.z2=Math.floor(i/2)):(this.x2=t/2,this.y2=e/2,this.z2=i/2),this},floor:function(t){return void 0!==t?(this._floor=t,this):this._floor},compare:function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},toIso:function(){return{x:this.x-this.y,y:1.2247*-this.z+.5*(this.x+this.y)}},thisToIso:function(){var t=this.toIso();return this.x=t.x,this.y=t.y,this},to2d:function(){return{x:this.y+this.x/2,y:this.y-this.x/2}},thisTo2d:function(){var t=this.to2d();return this.x=t.x,this.y=t.y,this.z=0,this},addPoint:function(t){return new IgePoint3d(this.x+t.x,this.y+t.y,this.z+t.z)},thisAddPoint:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},minusPoint:function(t){return new IgePoint3d(this.x-t.x,this.y-t.y,this.z-t.z)},thisMinusPoint:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},multiply:function(t,e,i){return new IgePoint3d(this.x*t,this.y*e,this.z*i)},multiplyPoint:function(t){return new IgePoint3d(this.x*t.x,this.y*t.y,this.z*t.z)},thisMultiply:function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},divide:function(t,e,i){return new IgePoint3d(this.x/t,this.y/e,this.z/i)},dividePoint:function(t){var e=this.x,i=this.y,o=this.z;return t.x&&(e=this.x/t.x),t.y&&(i=this.y/t.y),t.z&&(o=this.z/t.z),new IgePoint3d(e,i,o)},thisDivide:function(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this},clone:function(){return new IgePoint3d(this.x,this.y,this.z)},interpolate:function(t,e,i,o){var n=t.x-this.x,r=t.y-this.y,s=t.z-this.z,a=o-e,h=a-(i-e),l=h/a;return new IgePoint3d(t.x-n*l,t.y-r*l,t.z-s*l)},rotate:function(t){var e=Math.sin(t),i=Math.cos(t),o=i*this.x-e*this.y,n=e*this.x-i*this.y;return new IgePoint3d(o,n,this.z)},thisRotate:function(t){var e=Math.sin(t),i=Math.cos(t),o=this.x,n=this.y;return this.x=i*o-e*n,this.y=e*o-i*n,this},toString:function(t){return void 0===t&&(t=2),this.x.toFixed(t)+","+this.y.toFixed(t)+","+this.z.toFixed(t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePoint3d);var IgePoly2d=IgeClass.extend({classId:"IgePoly2d",init:function(){this._poly=[],this._scale=new IgePoint2d(1,1)},scale:function(t,e){return void 0!==t&&void 0!==e?(this._scale.x=t,this._scale.y=e,this):this._scale},multiply:function(t){if(void 0!==t){var e,i=this._poly,o=i.length;for(e=0;e<o;e++)i[e].x*=t,i[e].y*=t}return this},divide:function(t){if(void 0!==t){var e,i=this._poly,o=i.length;for(e=0;e<o;e++)i[e].x/=t,i[e].y/=t}return this},addPoint:function(t,e){return this._poly.push(new IgePoint2d(t,e)),this},length:function(){return this._poly.length},pointInPoly:function(t){var e,i=this._poly,o=i.length,n=o-1,r=0;for(e=0;e<o;n=e++)i[e].y>t.y!=i[n].y>t.y&&t.x<(i[n].x-i[e].x)*(t.y-i[e].y)/(i[n].y-i[e].y)+i[e].x&&(r=!r);return Boolean(r)},xyInside:function(t,e){var i,o=this._poly,n=o.length,r=n-1,s=0;for(i=0;i<n;r=i++)o[i].y>e!=o[r].y>e&&t<(o[r].x-o[i].x)*(e-o[i].y)/(o[r].y-o[i].y)+o[i].x&&(s=!s);return Boolean(s)},aabb:function(){var t,e,i,o,n,r=[],s=[],a=this._poly,h=a.length;for(n=0;n<h;n++)r.push(a[n].x),s.push(a[n].y);return t=Math.min.apply(Math,r),e=Math.min.apply(Math,s),i=Math.max.apply(Math,r),o=Math.max.apply(Math,s),new IgeRect(t,e,i-t,o-e)},clone:function(){var t,e=new IgePoly2d,i=this._poly,o=i.length;for(t=0;t<o;t++)e.addPoint(i[t].x,i[t].y);return e.scale(this._scale.x,this._scale.y),e},clockWiseTriangle:function(){var t,e,i,o=this._poly;return t=o[0],e=o[1],i=o[2],t.x*e.y+e.x*i.y+i.x*t.y-e.y*i.x-i.y*t.x-t.y*e.x>0},makeClockWiseTriangle:function(){if(!this.clockWiseTriangle()){var t=(this._poly[0],this._poly[1]),e=this._poly[2];this._poly[2]=t,this._poly[1]=e}},triangulate:function(){var t,e,i,o,n,r=this._poly,s=[],a=this.triangulationIndices();for(t=0;t<a.length;t+=3)e=r[a[t]],i=r[a[t+1]],o=r[a[t+2]],n=new IgePoly2d,n.addPoint(e.x,e.y),n.addPoint(i.x,i.y),n.addPoint(o.x,o.y),n.makeClockWiseTriangle(),s.push(n);return s},triangulationIndices:function(){var t,e,i,o,n,r,s,a,h,l,c=[],u=this._poly.length,m=[],d=[];if(u<3)return c;if(this._area()>0)for(m=0;m<u;m++)d[m]=m;else for(m=0;m<u;m++)d[m]=u-1-m;for(t=u,e=2*t,i=0,m=t-1;t>2;){if(e--<=0)return c;if(o=m,t<=o&&(o=0),m=o+1,t<=m&&(m=0),n=m+1,t<=n&&(n=0),this._snip(o,m,n,t,d)){for(r=d[o],s=d[m],a=d[n],c.push(r),c.push(s),c.push(a),i++,h=m,l=m+1;l<t;l++)d[h]=d[l],h++;t--,e=2*t}}return c.reverse(),c},_area:function(){var t,e,i,o=this._poly.length,n=0,r=0;for(t=o-1;r<o;t=r++)e=this._poly[t],i=this._poly[r],n+=e.x*i.y-i.x*e.y;return.5*n},_snip:function(t,e,i,o,n){var r,s,a=this._poly[n[t]],h=this._poly[n[e]],l=this._poly[n[i]];if(1e-5>(h.x-a.x)*(l.y-a.y)-(h.y-a.y)*(l.x-a.x))return!1;for(r=0;r<o;r++)if(r!=t&&r!=e&&r!=i&&(s=this._poly[n[r]],this._insideTriangle(a,h,l,s)))return!1;return!0},_insideTriangle:function(t,e,i,o){var n,r,s,a,h,l,c,u,m,d,p,_,f,y,g;return n=i.x-e.x,r=i.y-e.y,s=t.x-i.x,a=t.y-i.y,h=e.x-t.x,l=e.y-t.y,c=o.x-t.x,u=o.y-t.y,m=o.x-e.x,d=o.y-e.y,p=o.x-i.x,_=o.y-i.y,g=n*d-r*m,f=h*u-l*c,y=s*_-a*p,g>=0&&y>=0&&f>=0},render:function(t,e){var i,o=this._poly,n=o.length,r=this._scale.x,s=this._scale.y;for(t.beginPath(),t.moveTo(o[0].x*r,o[0].y*s),i=1;i<n;i++)t.lineTo(o[i].x*r,o[i].y*s);return t.lineTo(o[0].x*r,o[0].y*s),e&&t.fill(),t.stroke(),this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePoly2d);var IgeRect=IgeClass.extend({classId:"IgeRect",init:function(t,e,i,o){return this.x=t=void 0!==t?t:0,this.y=e=void 0!==e?e:0,this.width=i=void 0!==i?i:0,this.height=o=void 0!==o?o:0,this.x2=this.x/2,this.y2=this.y/2,this},combineRect:function(t){var e=this.x+this.width,i=this.y+this.height,o=t.x+t.width,n=t.y+t.height,r=Math.min(this.x,t.x),s=Math.min(this.y,t.y),a=Math.max(e-this.x,o-this.x),h=Math.max(i-this.y,n-this.y);return new IgeRect(r,s,a,h)},thisCombineRect:function(t){var e=this.x+this.width,i=this.y+this.height,o=t.x+t.width,n=t.y+t.height;this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.width=Math.max(e-this.x,o-this.x),this.height=Math.max(i-this.y,n-this.y)},minusPoint:function(t){return new IgeRect(this.x-t.x,this.y-t.y,this.width,this.height)},compare:function(t){return t&&this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},xyInside:function(t,e){return t>=this.x&&e>this.y&&t<=this.x+this.width&&e<=this.y+this.height},pointInside:function(t){return t.x>=this.x&&t.y>this.y&&t.x<=this.x+this.width&&t.y<=this.y+this.height},rectIntersect:function(t){return this.log('rectIntersect has been renamed to "intersects". Please update your code. rectIntersect will be removed in a later version of IGE.',"warning"),this.intersects(t)},intersects:function(t){if(t){var e=this.x,i=this.y,o=this.width,n=this.height,r=t.x,s=t.y,a=t.width,h=t.height,l=e+o,c=i+n,u=r+a,m=s+h;if(e<u&&l>r&&i<m&&c>s)return!0}return!1},multiply:function(t,e,i,o){return new IgeRect(this.x*t,this.y*e,this.width*i,this.height*o)},thisMultiply:function(t,e,i,o){return this.x*=t,this.y*=e,this.width*=i,this.height*=o,this},clone:function(){return new IgeRect(this.x,this.y,this.width,this.height)},toString:function(t){return void 0===t&&(t=2),this.x.toFixed(t)+","+this.y.toFixed(t)+","+this.width.toFixed(t)+","+this.height.toFixed(t)},render:function(t,e){return t.rect(this.x,this.y,this.width,this.height),e&&t.fill(),t.stroke(),this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeRect);var IgeMatrix2d=function(){this.matrix=[1,0,0,0,1,0,0,0,1],this._rotateOrigin=new IgePoint3d(0,0,0),this._scaleOrigin=new IgePoint3d(0,0,0)};IgeMatrix2d.prototype={matrix:null,transformCoord:function(t,e){var i=t.x,o=t.y,n=this.matrix;return t.x=i*n[0]+o*n[1]+n[2],t.y=i*n[3]+o*n[4]+n[5],(isNaN(n[0])||isNaN(n[1])||isNaN(n[2])||isNaN(n[3])||isNaN(n[4])||isNaN(n[5]))&&e.log("The matrix operation produced a NaN value!","error"),t},transformCoordInverse:function(t,e){var i=t.x,o=t.y,n=this.matrix;return t.x=i*n[0]-o*n[1]+n[2],t.y=i*n[3]+o*n[4]-n[5],(isNaN(n[0])||isNaN(n[1])||isNaN(n[2])||isNaN(n[3])||isNaN(n[4])||isNaN(n[5]))&&e.log("The matrix operation produced a NaN value!","error"),t},transform:function(t,e){var i,o=t.length;for(i=0;i<o;i++)this.transformCoord(t[i],e);return t},_newRotate:function(t){var e=new IgeMatrix2d;return e.rotateTo(t),e},rotateBy:function(t){var e=new IgeMatrix2d;return e.translateBy(this._rotateOrigin.x,this._rotateOrigin.y),e.rotateTo(t),e.translateBy(-this._rotateOrigin.x,-this._rotateOrigin.y),this.multiply(e),this},rotateTo:function(t){var e=this.matrix,i=Math.cos(t),o=Math.sin(t);return e[0]=i,e[1]=-o,e[3]=o,e[4]=i,(isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(e[3])||isNaN(e[4])||isNaN(e[5]))&&console.log("The matrix operation produced a NaN value!","error"),this},rotationRadians:function(){return Math.asin(this.matrix[3])},rotationDegrees:function(){return Math.degrees(Math.acos(this.matrix[0]))},_newScale:function(t,e){var i=new IgeMatrix2d;return i.matrix[0]=t,i.matrix[4]=e,i},scaleBy:function(t,e){var i=new IgeMatrix2d;return i.matrix[0]=t,i.matrix[4]=e,this.multiply(i),this},scaleTo:function(t,e){var i=this.matrix;return i[0]=t,i[4]=e,(isNaN(i[0])||isNaN(i[1])||isNaN(i[2])||isNaN(i[3])||isNaN(i[4])||isNaN(i[5]))&&this.log("The matrix operation produced a NaN value!","error"),this},_newTranslate:function(t,e){var i=new IgeMatrix2d;return i.matrix[2]=t,i.matrix[5]=e,i},translateBy:function(t,e){var i=new IgeMatrix2d;return i.matrix[2]=t,i.matrix[5]=e,this.multiply(i),this},translateTo:function(t,e){var i=this.matrix;return i[2]=t,i[5]=e,(isNaN(i[0])||isNaN(i[1])||isNaN(i[2])||isNaN(i[3])||isNaN(i[4])||isNaN(i[5]))&&this.log("The matrix operation produced a NaN value!","error"),this},copy:function(t){t=t.matrix;var e=this.matrix;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},compare:function(t){for(var e=this.matrix,i=t.matrix,o=0;o<9;o++)if(e[o]!==i[o])return!1;return!0},identity:function(){var t=this.matrix;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},multiply:function(t){var e=this.matrix,i=t.matrix,o=e[0],n=e[1],r=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],m=i[0],d=i[1],p=i[2],_=i[3],f=i[4],y=i[5],g=i[6],v=i[7],x=i[8];return e[0]=o*m+n*_+r*g,e[1]=o*d+n*f+r*v,e[2]=o*p+n*y+r*x,e[3]=s*m+a*_+h*g,e[4]=s*d+a*f+h*v,e[5]=s*p+a*y+h*x,e[6]=l*m+c*_+u*g,e[7]=l*d+c*f+u*v,e[8]=l*p+c*y+u*x,this},premultiply:function(t){var e=t.matrix[0]*this.matrix[0]+t.matrix[1]*this.matrix[3]+t.matrix[2]*this.matrix[6],i=t.matrix[0]*this.matrix[1]+t.matrix[1]*this.matrix[4]+t.matrix[2]*this.matrix[7],o=t.matrix[0]*this.matrix[2]+t.matrix[1]*this.matrix[5]+t.matrix[2]*this.matrix[8],n=t.matrix[3]*this.matrix[0]+t.matrix[4]*this.matrix[3]+t.matrix[5]*this.matrix[6],r=t.matrix[3]*this.matrix[1]+t.matrix[4]*this.matrix[4]+t.matrix[5]*this.matrix[7],s=t.matrix[3]*this.matrix[2]+t.matrix[4]*this.matrix[5]+t.matrix[5]*this.matrix[8],a=t.matrix[6]*this.matrix[0]+t.matrix[7]*this.matrix[3]+t.matrix[8]*this.matrix[6],h=t.matrix[6]*this.matrix[1]+t.matrix[7]*this.matrix[4]+t.matrix[8]*this.matrix[7],l=t.matrix[6]*this.matrix[2]+t.matrix[7]*this.matrix[5]+t.matrix[8]*this.matrix[8];return this.matrix[0]=e,this.matrix[1]=i,this.matrix[2]=o,this.matrix[3]=n,this.matrix[4]=r,this.matrix[5]=s,this.matrix[6]=a,this.matrix[7]=h,this.matrix[8]=l,this},getInverse:function(){var t=this.matrix,e=t[0],i=t[1],o=t[2],n=t[3],r=t[4],s=t[5],a=t[6],h=t[7],l=t[8],c=new IgeMatrix2d,u=e*(r*l-h*s)-n*(i*l-h*o)+a*(i*s-r*o);if(0===u)return null;var m=c.matrix;return m[0]=r*l-s*h,m[1]=o*h-i*l,m[2]=i*s-o*r,m[3]=s*a-n*l,m[4]=e*l-o*a,m[5]=o*n-e*s,m[6]=n*h-r*a,m[7]=i*a-e*h,m[8]=e*r-i*n,c.multiplyScalar(1/u),c},multiplyScalar:function(t){var e;for(e=0;e<9;e++)this.matrix[e]*=t;return this},transformRenderingContextSet:function(t){var e=this.matrix;return t.setTransform(e[0],e[3],e[1],e[4],e[2],e[5]),this},transformRenderingContext:function(t){var e=this.matrix;return t.transform(e[0],e[3],e[1],e[4],e[2],e[5]),this}},"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMatrix2d);var IgeTimeComponent=IgeEventingClass.extend({classId:"IgeTimeComponent",componentId:"time",init:function(t,e){this._entity=t,this._timers=[],this._additions=[],this._removals=[],t.addBehaviour("time",this._update)},addTimer:function(t){return t&&(this._updating?this._additions.push(t):this._timers.push(t)),this},removeTimer:function(t){return t&&(this._updating?this._removals.push(t):this._timers.pull(t)),this},_update:function(){for(var t=ige.time,e=ige._tickDelta,i=t._timers,o=i.length;o--;)i[o].addTime(e).update();return t._processRemovals(),t._processAdditions(),t},_processAdditions:function(){var t=this._additions,e=t.length;if(e){for(;e--;)this._timers.push(t[e]);this._additions=[]}return this},_processRemovals:function(){var t=this._removals,e=t.length;if(e){for(;e--;)this._timers.pull(t[e]);this._removals=[]}return this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTimeComponent);var IgeAnimationComponent=IgeEventingClass.extend({classId:"IgeAnimationComponent",componentId:"animation",init:function(t,e){this._entity=t,this._anims={},t.addBehaviour("tween",this._update)},define:function(t,e,i,o,n){if(e&&e.length){var r,s;if(this._anims.length=this._anims.length||0,void 0===n&&(n=!0),n)for(r=0;r<e.length;r++)if("string"==typeof(s=e[r])){if(!this._entity._texture){this.log("You can increase the performance of id-based cell animations by specifying the animation.define AFTER you have assigned your sprite sheet to the entity on entity with ID: "+this._entity.id(),"warning");break}s=this._entity._texture.cellIdToIndex(s),e[r]=s}var a=1e3/i|0;this._anims[t]={frames:e,frameTime:a,loop:void 0!==o?o:-1,frameCount:e.length,totalTime:e.length*a,currentDelta:0,currentLoop:0},this._anims.length++}else this.log("Cannot define an animation without a frame array!","error");return this._entity},addFrame:function(t,e){if(this._anims[t]){var i=this._anims[t];"string"==typeof e&&(e=this._entity._texture.cellIdToIndex(e)),i.frames.push(e),i.frameCount++,i.totalTime=i.frames.length*i.frameTime}},removeFrame:function(t,e){if(this._anims[t]){var i=this._anims[t];i.frames.splice(e,1),i.frameCount--,i.totalTime=i.frames.length*i.frameTime}},remove:function(t){return delete this._anims[t],this._anims.length--,this._entity},defined:function(t){return Boolean(this._anims[t])},setFps:function(t,e){if(this._anims){var i=this._anims[t];i&&(i.frameTime=1e3/e|0,i.totalTime=i.frameCount*i.frameTime)}return this._entity},setAllFps:function(t){if(this._anims)for(id in this._anims)this._anims.hasOwnProperty(id)&&this.setFps(id,t);return this._entity},playing:function(){return this._playing},start:function(t,e){if(this._anims){var i=this._anims[t];i?(i.currentDelta=0,i.currentLoop=0,i.startTime=ige._currentTime,this._anim=i,this._animId=t,void 0!==e&&(this._completeCallback=e.onComplete,this._loopCallback=e.onLoop,
this._stoppedCallback=e.onStopped),this._playing=!0,this.emit("started",i)):this.log('Cannot set animation to "'+t+'" because the animation does not exist!',"warning")}else this.log('Cannot set animation to "'+t+'" because no animations have been defined with defineAnim(...);',"warning");return this._entity},select:function(t,e){return this._animId!==t&&this.start(t,e),this._entity},stop:function(){return this._stoppedCallback&&this._stoppedCallback.call(this,this._anim),this.emit("stopped",this._anim),this._playing=!1,delete this._anim,delete this._animId,delete this._completeCallback,delete this._loopCallback,delete this._stoppedCallback,this._entity},_update:function(t,e){var i=this.animation;if(e=e||ige._tickDelta,i._anim){var o,n,r,s=i._anim;s.currentDelta+=e,s.currentDelta>s.totalTime&&(s.loop?-1===s.loop?(o=s.currentDelta/s.totalTime,Math.abs(o)>1&&(s.currentDelta-=(0|o)*s.totalTime),i._loopCallback&&i._loopCallback.call(i,s),i.emit("loopComplete",s)):(s.currentLoop++,s.loop>0&&s.currentLoop<=s.loop?(o=s.currentDelta/s.totalTime,Math.abs(o)>1&&(s.currentDelta-=(0|o)*s.totalTime),i._loopCallback&&i._loopCallback.call(i,s),i.emit("loopComplete",s)):(i._completeCallback&&i._completeCallback.call(i,s),i.emit("complete",s),i.stop())):(i._completeCallback&&i._completeCallback.call(i,s),i.emit("complete",s),i.stop())),r=s.currentDelta/s.frameTime|0,r>=s.frameCount&&(r=s.frameCount-1),n=s.frames[r],"string"==typeof n?i._entity.cellById(n):i._entity.cell(n)}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeAnimationComponent);var IgeVelocityComponent=IgeClass.extend({classId:"IgeVelocityComponent",componentId:"velocity",init:function(t,e){this._entity=t,this._velocity=new IgePoint3d(0,0,0),this._friction=new IgePoint3d(1,1,1),t.addBehaviour("velocity",this._behaviour)},_behaviour:function(t){this.velocity.tick(t)},byAngleAndPower:function(t,e,i){var o=this._velocity,n=Math.cos(t)*e,r=Math.sin(t)*e;return i?(o.x+=n,o.y+=r,o.z+=0):(o.x=n,o.y=r,o.z=0),this._entity},xyz:function(t,e,i,o){var n=this._velocity;return o?(n.x+=t,n.y+=e,n.z+=i):(n.x=t,n.y=e,n.z=i),this._entity},x:function(t,e){var i=this._velocity;return e?i.x+=t:i.x=t,this._entity},y:function(t,e){var i=this._velocity;return e?i.y+=t:i.y=t,this._entity},z:function(t,e){var i=this._velocity;return e?i.z+=t:i.z=y,this._entity},vector3:function(t,e){"number"!=typeof t.scale&&(t.scale=1);var i=this._velocity,o=t.x,n=t.y,r=t.z;return e?(i.x+=o,i.y+=n,i.z+=r):(i.x=o,i.y=n,i.z=r),this._entity},friction:function(t){var e=1-t;return e<0&&(e=0),this._friction=new IgePoint3d(e,e,e),this._entity},linearForce:function(t,e){e/=1e3;var i=t*Math.PI/180,o=Math.cos(i)*e,n=Math.sin(i)*e,r=o*n;return this._linearForce=new IgePoint3d(o,n,r),this._entity},linearForceXYZ:function(t,e,i){return this._linearForce=new IgePoint3d(t,e,i),this._entity},linearForceVector3:function(t,e,i){var o=this._linearForce=this._linearForce||new IgePoint3d(0,0,0),n=t.x/1e3,r=t.y/1e3,s=t.z/1e3;return i?(o.x+=n||0,o.y+=r||0,o.z+=s||0):(o.x=n||0,o.y=r||0,o.z=s||0),this._entity},_applyLinearForce:function(t){if(this._linearForce){var e=this._velocity;e.x+=this._linearForce.x*t,e.y+=this._linearForce.y*t,e.z+=this._linearForce.z*t}},_applyFriction:function(){var t=this._velocity,e=this._friction;t.x*=e.x,t.y*=e.y,t.z*=e.z},tick:function(t){var e,i,o,n=ige._tickDelta,r=this._velocity;n&&(this._applyLinearForce(n),e=r.x*n,i=r.y*n,o=r.z*n,(e||i||o)&&this._entity.translateBy(e,i,o))}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeVelocityComponent);var IgeTweenComponent=IgeClass.extend({classId:"IgeTweenComponent",componentId:"tween",init:function(t,e){this._entity=t,this._transform=t.transform,this._tweens=[],t.addBehaviour("tween",this.update)},start:function(t){return t._startTime>ige._currentTime?this._tweens.push(t):(t._currentStep=0,this._setupStep(t,!1)&&this._tweens.push(t)),this.enable(),t},_setupStep:function(t,e){var i,o,n,r=t._targetObj,s=t._steps[t._currentStep],a=[];if(s&&(i=s.props),r){0!==t._currentStep||e?t._startTime=ige._currentTime:void 0===t._startTime&&(t._startTime=ige._currentTime),o=s.durationMs?s.durationMs:t._durationMs,t._selectedEasing=s.easing?s.easing:t._easing,t._endTime=t._startTime+o;for(n in i)i.hasOwnProperty(n)&&a.push({targetObj:r,propName:n,deltaVal:i[n]-(s.isDelta?0:r[n]),oldDelta:0});return t._targetData=a,t._destTime=t._endTime-t._startTime,t}this.log('Cannot start tweening properties of the specified object "'+obj+'" because it does not exist!',"error")},stop:function(t){return this._tweens.pull(t),this._tweens.length||this.disable(),this},stopAll:function(){return this.disable(),delete this._tweens,this._tweens=[],this},enable:function(){return this._tweening||(this._tweening=!0),this},disable:function(){return this._tweening&&(this._tweening=!1),this},update:function(t){var e=this.tween;if(e._tweens&&e._tweens.length)for(var i,o,n,r,s,a,h,l,c,u,m,d,p=ige._tickStart,_=e._tweens,f=_.length;f--;)if(i=_[f],m=!1,i._started||p>=i._startTime)if(i._started||(-1===i._currentStep&&(i._currentStep=0,e._setupStep(i,!1)),"function"==typeof i._beforeTween&&(i._beforeTween(i),delete i._beforeTween),"function"==typeof i._beforeStep&&(u=i._stepDirection?i._steps.length-(i._currentStep+1):i._currentStep,i._beforeStep(i,u)),i._started=!0),o=p-i._startTime,n=i._destTime,r=i._selectedEasing,o>=n){l=i._targetData;for(c in l)if(l.hasOwnProperty(c)){s=l[c],a=s.targetObj,h=a[s.propName],d=0!==n?e.easing[r](n,s.deltaVal,n):s.deltaVal,h+=d-s.oldDelta;var y=Math.pow(10,15-h.toFixed(0).toString().length);a[s.propName]=Math.round(h*y)/y}"function"==typeof i._afterStep&&(u=i._stepDirection?i._steps.length-(i._currentStep+1):i._currentStep,i._afterStep(i,u)),i._steps.length===i._currentStep+1?(i._repeatMode?(-1!==i._repeatCount&&(i._repeatedCount++,i._repeatCount===i._repeatedCount&&(m=!0)),m||(1===i._repeatMode&&(i._currentStep=0),2===i._repeatMode&&(i._stepDirection=!i._stepDirection,i._steps.reverse(),i._currentStep=1),"function"==typeof i._stepsComplete&&i._stepsComplete(i,i._currentStep),"function"==typeof i._beforeStep&&(u=i._stepDirection?i._steps.length-(i._currentStep+1):i._currentStep,i._beforeStep(i,u)),e._setupStep(i,!0))):m=!0,m&&(i.stop(),"function"==typeof i._afterTween&&(i._afterTween(i),delete i._afterTween))):(i._currentStep++,"function"==typeof i._beforeStep&&(u=i._stepDirection?i._steps.length-(i._currentStep+1):i._currentStep,i._beforeStep(i,u)),e._setupStep(i,!0)),"function"==typeof i._afterChange&&i._afterChange(i,u)}else{l=i._targetData;for(c in l)if(l.hasOwnProperty(c)){s=l[c];var d=e.easing[r](o,s.deltaVal,n);s.targetObj[s.propName]+=d-s.oldDelta,s.oldDelta=d}"function"==typeof i._afterChange&&i._afterChange(i,u)}},easing:{none:function(t,e,i){return e*t/i},inQuad:function(t,e,i){return e*(t/=i)*t},outQuad:function(t,e,i){return-e*(t/=i)*(t-2)},inOutQuad:function(t,e,i){return(t/=i/2)<1?e/2*t*t:-e/2*(--t*(t-2)-1)},inCubic:function(t,e,i){return e*(t/=i)*t*t},outCubic:function(t,e,i){return e*((t=t/i-1)*t*t+1)},inOutCubic:function(t,e,i){return(t/=i/2)<1?e/2*t*t*t:e/2*((t-=2)*t*t+2)},outInCubic:function(t,e,i){return t<i/2?this.outCubic(2*t,e/2,i):this.inCubic(2*t-i,e/2,e/2,i)},inQuart:function(t,e,i){return e*(t/=i)*t*t*t},outQuart:function(t,e,i){return-e*((t=t/i-1)*t*t*t-1)},inOutQuart:function(t,e,i){return(t/=i/2)<1?e/2*t*t*t*t:-e/2*((t-=2)*t*t*t-2)},outInQuart:function(t,e,i){return t<i/2?this.outQuart(2*t,e/2,i):this.inQuart(2*t-i,e/2,e/2,i)},inQuint:function(t,e,i){return e*(t/=i)*t*t*t*t},outQuint:function(t,e,i){return e*((t=t/i-1)*t*t*t*t+1)},inOutQuint:function(t,e,i){return(t/=i/2)<1?e/2*t*t*t*t*t:e/2*((t-=2)*t*t*t*t+2)},outInQuint:function(t,e,i){return t<i/2?this.outQuint(2*t,e/2,i):this.inQuint(2*t-i,e/2,e/2,i)},inSine:function(t,e,i){return-e*Math.cos(t/i*(Math.PI/2))+e},outSine:function(t,e,i){return e*Math.sin(t/i*(Math.PI/2))},inOutSine:function(t,e,i){return-e/2*(Math.cos(Math.PI*t/i)-1)},outInSine:function(t,e,i){return t<i/2?this.outSine(2*t,e/2,i):this.inSine(2*t-i,e/2,e/2,i)},inExpo:function(t,e,i){return 0===t?0:e*Math.pow(2,10*(t/i-1))-.001*e},outExpo:function(t,e,i){return t===i?e:1.001*e*(1-Math.pow(2,-10*t/i))},inOutExpo:function(t,e,i){return 0===t?0:t===i?e:(t/=i/2)<1?e/2*Math.pow(2,10*(t-1))-5e-4*e:e/2*1.0005*(2-Math.pow(2,-10*--t))},outInExpo:function(t,e,i){return t<i/2?this.outExpo(2*t,e/2,i):this.inExpo(2*t-i,e/2,e/2,i)},inCirc:function(t,e,i){return-e*(Math.sqrt(1-(t/=i)*t)-1)},outCirc:function(t,e,i){return e*Math.sqrt(1-(t=t/i-1)*t)},inOutCirc:function(t,e,i){return(t/=i/2)<1?-e/2*(Math.sqrt(1-t*t)-1):e/2*(Math.sqrt(1-(t-=2)*t)+1)},outInCirc:function(t,e,i){return t<i/2?this.outCirc(2*t,e/2,i):this.inCirc(2*t-i,e/2,e/2,i)},inElastic:function(t,e,i,o,n){var r;return 0===t?0:1==(t/=i)?e:(n||(n=.3*i),!o||o<Math.abs(e)?(o=e,r=n/4):r=n/(2*Math.PI)*Math.asin(e/o),-o*Math.pow(2,10*(t-=1))*Math.sin((t*i-r)*(2*Math.PI)/n))},outElastic:function(t,e,i,o,n){var r;return 0===t?0:1==(t/=i)?e:(n||(n=.3*i),!o||o<Math.abs(e)?(o=e,r=n/4):r=n/(2*Math.PI)*Math.asin(e/o),o*Math.pow(2,-10*t)*Math.sin((t*i-r)*(2*Math.PI)/n)+e)},inOutElastic:function(t,e,i,o,n){var r;return 0===t?0:2==(t/=i/2)?e:(n||(n=i*(.3*1.5)),!o||o<Math.abs(e)?(o=e,r=n/4):r=n/(2*Math.PI)*Math.asin(e/o),t<1?o*Math.pow(2,10*(t-=1))*Math.sin((t*i-r)*(2*Math.PI)/n)*-.5:o*Math.pow(2,-10*(t-=1))*Math.sin((t*i-r)*(2*Math.PI)/n)*.5+e)},outInElastic:function(t,e,i,o,n){return t<i/2?this.outElastic(2*t,e/2,i,o,n):this.inElastic(2*t-i,e/2,e/2,i,o,n)},inBack:function(t,e,i,o){return void 0===o&&(o=1.70158),e*(t/=i)*t*((o+1)*t-o)},outBack:function(t,e,i,o){return void 0===o&&(o=1.70158),e*((t=t/i-1)*t*((o+1)*t+o)+1)},inOutBack:function(t,e,i,o){return void 0===o&&(o=1.70158),(t/=i/2)<1?e/2*(t*t*((1+(o*=1.525))*t-o)):e/2*((t-=2)*t*((1+(o*=1.525))*t+o)+2)},outInBack:function(t,e,i,o){return t<i/2?this.outBack(2*t,e/2,i,o):this.inBack(2*t-i,e/2,e/2,i,o)},inBounce:function(t,e,i){return e-this.outBounce(i-t,0,e,i)},outBounce:function(t,e,i){return(t/=i)<1/2.75?e*(7.5625*t*t):t<2/2.75?e*(7.5625*(t-=1.5/2.75)*t+.75):t<2.5/2.75?e*(7.5625*(t-=2.25/2.75)*t+.9375):e*(7.5625*(t-=2.625/2.75)*t+.984375)},inOutBounce:function(t,e,i){return t<i/2?.5*this.inBounce(2*t,0,e,i):.5*this.outBounce(2*t-i,0,e,i)+.5*e},outInBounce:function(t,e,i){return t<i/2?this.outBounce(2*t,e/2,i):this.inBounce(2*t-i,e/2,e/2,i)}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTweenComponent);var IgePathComponent=IgeEventingClass.extend({classId:"IgePathComponent",componentId:"path",init:function(t,e){this._entity=t,this._points=[],this._speed=.001,this._previousPointFrom=0,this._currentPointFrom=0,this._previousPointTo=0,this._currentPointTo=0,t.addBehaviour("path",this._updateBehaviour,!1)},tileMap:function(t){return void 0!==t?(this._tileMap=t,this):this._tileMap},finder:function(t){return void 0!==t?(this._finder=t,this):this._finder},dynamic:function(t){return void 0!==t?(this._dynamic=t,this):this._dynamic},tileChecker:function(t){if(void 0!==t){var e=this;return this._tileChecker=function(){return t.apply(e._entity,arguments)},this}return this._tileChecker},lookAheadSteps:function(t){return void 0!==t?(this._lookAheadSteps=t,this):this._lookAheadSteps},allowSquare:function(t){return void 0!==t?(this._allowSquare=t,this):this._allowSquare},allowDiagonal:function(t){return void 0!==t?(this._allowDiagonal=t,this):this._allowDiagonal},set:function(t,e,i,o,n,r,s){this.clear();var a=this._finder.generate(this._tileMap,new IgePoint3d(t,e,i),new IgePoint3d(o,n,r),this._tileChecker,this._allowSquare,this._allowDiagonal,s);return this.addPoints(a),this},add:function(t,e,i,o){var n=this.getEndPoint(),r=!0;n||(n=this._entity._parent.pointToTile(this._entity._translate),r=!1);var s=this._finder.generate(this._tileMap,n,new IgePoint3d(t,e,i),this._tileChecker,this._allowSquare,this._allowDiagonal,o);return r&&s.shift(),this.addPoints(s),this},addPoints:function(t){return void 0!==t&&(t.length?(this._points=this._points.concat(t),this._calculatePathData()):this.log("Cannot add an empty path to the path queue!","warning")),this},getFromPoint:function(){return this._points[this._currentPointFrom]},getToPoint:function(){return this._points[this._currentPointTo]},getDirection:function(){if(this._finished)e="";else{var t=this.getToPoint(),e="";if(t&&(e=t.direction,1===this._entity._mode))switch(e){case"E":e="SE";break;case"S":e="SW";break;case"W":e="NW";break;case"N":e="NE";break;case"NE":e="E";break;case"SW":e="W";break;case"NW":e="N";break;case"SE":e="S"}}return e},warnTime:function(t){return void 0!==t?(this._warnTime=t,this):this._warnTime},autoStop:function(t){return void 0!==t?(this._autoStop=t,this):this._autoStop},speed:function(t){return void 0!==t?(this._speed=t/1e3,this._active&&(this.stop(),this.start(this._startTime)),this):this._speed},start:function(t){return this._active?this._finished=!1:(this._active=!0,this._finished=!1,this._startTime=t||ige._currentTime,this._calculatePathData()),this},getEndPoint:function(){return this._points[this._points.length-1]},pause:function(){return this._active=!1,this._paused=!0,this._pauseTime=ige._currentTime,this.emit("paused",this._entity),this},clear:function(){return this._active&&this.stop(),this._previousPointFrom=0,this._currentPointFrom=0,this._previousPointTo=0,this._currentPointTo=0,this._points=[],this.emit("cleared",this._entity),this},stop:function(){return this._active=!1,this._finished=!0,this.emit("stopped",this._entity),this},drawPath:function(t){return void 0!==t?(this._drawPath=t,t?this._entity.addBehaviour("path",this._tickBehaviour,!0):this._entity.removeBehaviour("path",!0),this):this._drawPath},drawPathGlow:function(t){return void 0!==t?(this._drawPathGlow=t,this):this._drawPathGlow},drawPathText:function(t){return void 0!==t?(this._drawPathText=t,this):this._drawPathText},multiplyPoint:function(t){return t.multiply(this._entity._parent._tileWidth,this._entity._parent._tileHeight,1)},dividePoint:function(t){return t.divide(this._entity._parent._tileWidth,this._entity._parent._tileHeight,1)},transformPoint:function(t){return new IgePoint3d(t.x+this._entity._parent._tileWidth/2,t.y+this._entity._parent._tileHeight/2,t.z)},unTransformPoint:function(t){return new IgePoint3d(t.x-this._entity._parent._tileWidth/2,t.y-this._entity._parent._tileHeight/2,t.z)},_updateBehaviour:function(t){var e=this.path,i=ige._currentTime,o=i-e._startTime;if(e._active&&0!==e._totalDistance&&i>=e._startTime&&(o<=e._totalTime||!e._finished)){var n,r,s,a,h,l=e._speed*o,c=0,u=e._points,m=u.length;for(n=0;n<m;n++)if((c+=u[n]._distanceToNext)>l){e._finished=!1,e._currentPointFrom=n,e._currentPointTo=n+1,r=u[n],s=u[n+1];break}r&&s?(e._currentPointFrom!==e._previousPointFrom&&e.emit("pointComplete",[this,u[e._previousPointFrom].x,u[e._previousPointFrom].y,u[e._currentPointFrom].x,u[e._currentPointFrom].y]),e._dynamic&&(h=e._processDynamic(r,s,u[m-1]),!0===h&&(r=u[e._currentPointFrom],s=u[e._currentPointTo],e.emit("pathRecalculated",[this,u[e._previousPointFrom].x,u[e._previousPointFrom].y,u[e._currentPointFrom].x,u[e._currentPointFrom].y])),-1===h&&(e._finished=!0)),a=e._positionAlongVector(r,s,e._speed,r._deltaTimeToNext-(r._absoluteTimeToNext-o)),a=e.multiplyPoint(a),a=e.transformPoint(a),this.translateToPoint(a),e._previousPointFrom=e._currentPointFrom,e._previousPointTo=e._currentPointTo):(s=u[m-1],a=e.multiplyPoint(s),a=e.transformPoint(a),e._previousPointFrom=m-1,e._previousPointTo=m-1,e._currentPointFrom=m-1,e._currentPointTo=m-1,this.translateToPoint(a),e._finished=!0,e.emit("pathComplete",[this,u[e._previousPointFrom].x,u[e._previousPointFrom].y]))}else e._active&&0==e._totalDistance&&!e._finished&&(e._finished=!0)},_processDynamic:function(t,e,i){var o,n,r,s=this;return o=s._tileMap.map._mapData,n=o[e.y]&&o[e.y][e.x]?o[e.y][e.x]:null,!s._tileChecker(n,e.x,e.y,null,null,null,!0)&&(r=s._finder.generate(s._tileMap,new IgePoint3d(t.x,t.y,t.z),new IgePoint3d(i.x,i.y,i.z),s._tileChecker,s._allowSquare,s._allowDiagonal,!1),r.length?(s.replacePoints(s._currentPointFrom,s._points.length-s._currentPointFrom,r),!0):(s.emit("dynamicFail",[this,new IgePoint3d(t.x,t.y,t.z),new IgePoint3d(i.x,i.y,i.z)]),s.clear(),-1))},_calculatePathData:function(){var t,e,i,o,n=0;for(0===this._currentPointFrom&&(t=this._entity._translate.clone(),t=this.unTransformPoint(t),t=this.dividePoint(t),this._points[0]=t),o=1;o<this._points.length;o++)e=this._points[o-1],i=this._points[o],e._distanceToNext=Math.distance(e.x,e.y,i.x,i.y),n+=Math.abs(e._distanceToNext),e._deltaTimeToNext=e._distanceToNext/this._speed,e._absoluteTimeToNext=n/this._speed;return this._totalDistance=n,this._totalTime=n/this._speed,this},replacePoints:function(t,e,i){var o=[t,e].concat(i);this._points.splice.apply(this._points,o),this._calculatePathData()},_tickBehaviour:function(t){if(ige.isClient){var e,i,o,n,r=this.path,s=this,a=r._points;if(a.length&&a&&r._drawPath){for(t.save(),e=void 0,o=0;o<a.length;o++){if(t.strokeStyle="#0096ff",t.fillStyle="#0096ff",i=new IgePoint3d(a[o].x,a[o].y,a[o].z),i=r.multiplyPoint(i),i=r.transformPoint(i),1===s._parent._mountMode&&(i=i.toIso()),e){if(r._drawPathGlow){t.globalAlpha=.1;for(var h=3;h>=0;h--)t.lineWidth=4*(h+1)-3.5,t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),o<r._currentPointTo&&(t.strokeStyle="#666666",t.fillStyle="#333333"),0===h&&(t.globalAlpha=1),t.stroke()}else t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),o<r._currentPointTo&&(t.strokeStyle="#666666",t.fillStyle="#333333"),t.stroke();o===r._currentPointTo?(t.save(),t.fillStyle="#24b9ea",t.fillRect(i.x-5,i.y-5,10,10),r._drawPathText&&(t.fillStyle="#eade24",r._drawPathGlow&&(t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=4,t.shadowColor="rgba(0, 0, 0, 1)"),n="Entity: "+s.id(),t.fillText(n,i.x-Math.floor(t.measureText(n).width/2),i.y+16),n="Point ("+a[o].x+", "+a[o].y+")",t.fillText(n,i.x-Math.floor(t.measureText(n).width/2),i.y+28),n="Abs ("+Math.floor(s._translate.x)+", "+Math.floor(s._translate.y)+")",t.fillText(n,i.x-Math.floor(t.measureText(n).width/2),i.y+40)),t.restore()):t.fillRect(i.x-2.5,i.y-2.5,5,5)}else t.beginPath(),t.arc(i.x,i.y,5,0,2*Math.PI,!0),t.closePath(),t.fill();e=i}t.restore()}}},getPreviousPoint:function(t){return this._points[this._currentPointFrom-t]},getNextPoint:function(t){return this._points[this._currentPointTo+t]},_positionAlongVector:function(t,e,i,o){var n=t.x,r=t.y,s=e.x,a=e.y,h=s-n,l=a-r,c=Math.sqrt(h*h+l*l),u=h/c,m=l/c;return 0!==h||0!==l?new IgePoint3d(n+u*(i*o),r+m*(i*o),0):new IgePoint3d(0,0,0)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePathComponent);var IgeInputComponent=IgeEventingClass.extend({classId:"IgeInputComponent",componentId:"input",init:function(){this._eventQueue=[],this._eventControl={_cancelled:!1,stopPropagation:function(){this._cancelled=!0}},this.tick(),this.mouse={dblClick:-302,down:-301,up:-300,move:-259,wheel:-258,wheelUp:-257,wheelDown:-256,x:-255,y:-254,button1:-253,button2:-252,button3:-251},this.pad1={button1:-250,button2:-249,button3:-248,button4:-247,button5:-246,button6:-245,button7:-244,button8:-243,button9:-242,button10:-241,button11:-240,button12:-239,button13:-238,button14:-237,button15:-236,button16:-235,button17:-234,button18:-233,button19:-232,button20:-231,stick1:-230,stick2:-229,stick1Up:-228,stick1Down:-227,stick1Left:-226,stick1Right:-225,stick2Up:-224,stick2Down:-223,stick2Left:-222,stick2Right:-221},this.pad2={button1:-220,button2:-219,button3:-218,button4:-217,button5:-216,button6:-215,button7:-214,button8:-213,button9:-212,button10:-211,button11:-210,button12:-209,button13:-208,button14:-207,button15:-206,button16:-205,button17:-204,button18:-203,button19:-202,button20:-201,stick1:-200,stick2:-199,stick1Up:-198,stick1Down:-197,stick1Left:-196,stick1Right:-195,stick2Up:-194,stick2Down:-193,stick2Left:-192,stick2Right:-191},this.key={shift:-3,ctrl:-2,alt:-1,backspace:8,tab:9,enter:13,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,del:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},this._controlMap=[],this._state=[],this._state[this.mouse.x]=0,this._state[this.mouse.y]=0},debug:function(t){return void 0!==t?(this._debug=t,this):this._debug},setupListeners:function(t){this.log("Setting up input event listeners..."),this._canvas=t;var e=this;this._evRef={mousedown:function(t){t.igeType="mouse",e._rationalise(t),e._mouseDown(t)},mouseup:function(t){t.igeType="mouse",e._rationalise(t),e._mouseUp(t)},mousemove:function(t){t.igeType="mouse",e._rationalise(t),e._mouseMove(t)},mousewheel:function(t){t.igeType="mouse",e._rationalise(t),e._mouseWheel(t)},touchmove:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseMove(t)},touchstart:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseDown(t)},touchend:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseUp(t)},contextmenu:function(t){t.preventDefault(),t.igeType="mouse",e._rationalise(t),e._contextMenu(t)},keydown:function(t){t.igeType="key",e._rationalise(t),e._keyDown(t)},keyup:function(t){t.igeType="key",e._rationalise(t),e._keyUp(t)}},t.addEventListener("mousedown",this._evRef.mousedown,!1),t.addEventListener("mouseup",this._evRef.mouseup,!1),t.addEventListener("mousemove",this._evRef.mousemove,!1),t.addEventListener("mousewheel",this._evRef.mousewheel,!1),t.addEventListener("touchmove",this._evRef.touchmove,!1),t.addEventListener("touchstart",this._evRef.touchstart,!1),t.addEventListener("touchend",this._evRef.touchend,!1),t.addEventListener("contextmenu",this._evRef.contextmenu,!1),window.addEventListener("keydown",this._evRef.keydown,!1),window.addEventListener("keyup",this._evRef.keyup,!1)},destroyListeners:function(){this.log("Removing input event listeners...");var t=this._canvas;t.removeEventListener("mousedown",this._evRef.mousedown,!1),t.removeEventListener("mouseup",this._evRef.mouseup,!1),t.removeEventListener("mousemove",this._evRef.mousemove,!1),t.removeEventListener("mousewheel",this._evRef.mousewheel,!1),t.removeEventListener("touchmove",this._evRef.touchmove,!1),t.removeEventListener("touchstart",this._evRef.touchstart,!1),t.removeEventListener("touchend",this._evRef.touchend,!1),t.removeEventListener("contextmenu",this._evRef.contextmenu,!1),window.removeEventListener("keydown",this._evRef.keydown,!1),window.removeEventListener("keyup",this._evRef.keyup,!1)},fireManualEvent:function(t,e){t&&e?this._evRef[t]?this._evRef[t](e):this.log('Cannot fire manual event "'+t+'" because no listener exists in the engine for this event type!',"warning"):this.log("Cannot fire manual event because both eventName and eventObj params are required.","warning")},_rationalise:function(t,e){if("key"===t.igeType&&8===t.keyCode){"body"===(t.srcElement||t.target).tagName.toLowerCase()&&t.preventDefault()}"touch"===t.igeType&&t.preventDefault(),e?(t.button=0,t.changedTouches&&t.changedTouches.length&&(t.igePageX=t.changedTouches[0].pageX,t.igePageY=t.changedTouches[0].pageY)):(t.igePageX=t.pageX,t.igePageY=t.pageY),t.igeX=t.igePageX-ige._canvasPosition().left,t.igeY=t.igePageY-ige._canvasPosition().top,this.emit("inputEvent",t)},_mouseDown:function(t){this._debug&&console.log("Mouse Down",t),this._updateMouseData(t);var e=t.igeX-ige._bounds2d.x2,i=t.igeY-ige._bounds2d.y2,o=this;0===t.button&&(this._state[this.mouse.button1]=!0),1===t.button&&(this._state[this.mouse.button2]=!0),2===t.button&&(this._state[this.mouse.button3]=!0),this.mouseDown=t,o.emit("preMouseDown",[t,e,i,t.button+1])||this.queueEvent(this,function(){o.emit("mouseDown",[t,e,i,t.button+1])})},_mouseUp:function(t){this._debug&&console.log("Mouse Up",t),this._updateMouseData(t);var e=t.igeX-ige._bounds2d.x2,i=t.igeY-ige._bounds2d.y2,o=this;0===t.button&&(this._state[this.mouse.button1]=!1),1===t.button&&(this._state[this.mouse.button2]=!1),2===t.button&&(this._state[this.mouse.button3]=!1),this.mouseUp=t,o.emit("preMouseUp",[t,e,i,t.button+1])||this.queueEvent(this,function(){o.emit("mouseUp",[t,e,i,t.button+1])})},_contextMenu:function(t){this._debug&&console.log("Context Menu",t),this._updateMouseData(t);var e=t.igeX-ige._bounds2d.x2,i=t.igeY-ige._bounds2d.y2,o=this;0===t.button&&(this._state[this.mouse.button1]=!1),1===t.button&&(this._state[this.mouse.button2]=!1),2===t.button&&(this._state[this.mouse.button3]=!1),this.contextMenu=t,o.emit("preContextMenu",[t,e,i,t.button+1])||this.queueEvent(this,function(){o.emit("contextMenu",[t,e,i,t.button+1])})},_mouseMove:function(t){ige._mouseOverVp=this._updateMouseData(t);var e=t.igeX-ige._bounds2d.x2,i=t.igeY-ige._bounds2d.y2,o=this;this._state[this.mouse.x]=e,this._state[this.mouse.y]=i,this.mouseMove=t,o.emit("preMouseMove",[t,e,i,t.button+1])||this.queueEvent(this,function(){o.emit("mouseMove",[t,e,i,t.button+1])})},_mouseWheel:function(t){this._updateMouseData(t);var e=t.igeX-ige._bounds2d.x2,i=t.igeY-ige._bounds2d.y2,o=this;this._state[this.mouse.wheel]=t.wheelDelta,t.wheelDelta>0?this._state[this.mouse.wheelUp]=!0:this._state[this.mouse.wheelDown]=!0,this.mouseWheel=t,o.emit("preMouseWheel",[t,e,i,t.button+1])||this.queueEvent(this,function(){o.emit("mouseWheel",[t,e,i,t.button+1])})},_keyDown:function(t){var e=this;this._state[t.keyCode]=!0,this._debug&&console.log("Key Down",t),e.emit("preKeyDown",[t,t.keyCode])||this.queueEvent(this,function(){e.emit("keyDown",[t,t.keyCode])})},_keyUp:function(t){var e=this;this._state[t.keyCode]=!1,this._debug&&console.log("Key Up",t),e.emit("preKeyUp",[t,t.keyCode])||this.queueEvent(this,function(){e.emit("keyUp",[t,t.keyCode])})},_updateMouseData:function(t){var e,i,o=ige._children,n=o.length,r=t.igeX-ige._bounds2d.x2-ige._translate.x,s=t.igeY-ige._bounds2d.y2-ige._translate.y;for(ige._mousePos.x=r,ige._mousePos.y=s;n--;)if(e=o[o.length-(n+1)],r>e._translate.x-e._bounds2d.x/2&&r<e._translate.x+e._bounds2d.x/2&&s>e._translate.y-e._bounds2d.y/2&&s<e._translate.y+e._bounds2d.y/2){e._mousePos=new IgePoint3d(Math.floor((r-e._translate.x)/e.camera._scale.x+e.camera._translate.x),Math.floor((s-e._translate.y)/e.camera._scale.y+e.camera._translate.y),0),i=e,t.igeViewport=e;break}return i},mapAction:function(t,e){this._controlMap[t]=e},actionVal:function(t){return this._state[this._controlMap[t]]},actionState:function(t){return!!this._state[this._controlMap[t]]},val:function(t){return this._state[t]},state:function(t){return!!this._state[t]},stopPropagation:function(){return this._eventControl._cancelled=!0,this},queueEvent:function(t,e,i){return void 0!==e&&this._eventQueue.push([t,e,i]),this},tick:function(){for(var t=this._eventQueue,e=t.length,i=this._eventControl;e--&&(t[e][1].apply(t[e][0],[i,t[e][2]]),!i._cancelled););this._eventQueue=[],this._eventControl._cancelled=!1,this.dblClick=!1,this.mouseMove=!1,this.mouseDown=!1,this.mouseUp=!1,this.mouseWheel=!1},emit:function(t,e){if(this._eventListeners&&this._eventListeners[t]){var i,o,n,r,s,a,h=this._eventListeners[t].length,l=this._eventListeners[t].length-1,c=this._eventControl;if(h){if(i=[],"object"==typeof e&&null!==e&&null!==e[0])for(o in e)e.hasOwnProperty(o)&&(i[o]=e[o]);else i=[e];for(n=!1,this._eventListeners._processing=!0;h--&&!c._cancelled;)r=l-h,s=this._eventListeners[t][r],s.sendEventName&&(i=[t]),a=s.call.apply(s.context||this,i),!0!==a&&!0!==c._cancelled||(n=!0),s.oneShot&&this.off(t,s);if(this._eventListeners._processing=!1,this._processRemovals(),n)return 1}}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeInputComponent);var IgeGamePadComponent=IgeEventingClass.extend({classId:"IgeGamePadComponent",componentId:"gamePad",init:function(t,e){var i=this;this._entity=t,this._options=e,this.gamepadAvailable=null,this.TYPICAL_BUTTON_COUNT=16,this.TYPICAL_AXIS_COUNT=4,this.ticking=!1,this.gamepads=[],this.prevRawGamepadTypes=[],this.prevTimestamps=[],ige.isClient&&(this.gamepadAvailable=!!navigator.webkitGetGamepads||!!navigator.webkitGamepads||-1!=navigator.userAgent.indexOf("Firefox/"),this.gamepadAvailable?(window.addEventListener("MozGamepadConnected",function(){i.onGamepadConnect.apply(i,arguments)},!1),window.addEventListener("MozGamepadDisconnected",function(){i.onGamepadDisconnect.apply(i,arguments)},!1),(navigator.webkitGamepads||navigator.webkitGetGamepads)&&this.startPolling()):this.emit("notSupported"),t.addBehaviour("gamePadComponent",this._behaviour))},onGamepadConnect:function(t){this.gamepads.push(t.gamepad),this.startPolling(),this.emit("change")},onGamepadDisconnect:function(t){for(var e in this.gamepads)if(this.gamepads[e].index==t.gamepad.index){this.gamepads.splice(e,1);break}0==this.gamepads.length&&this.stopPolling(),this.emit("change")},startPolling:function(){this.ticking=!0},stopPolling:function(){this.ticking=!1},_behaviour:function(){this.gamePad.pollStatus()},pollStatus:function(){this.pollGamepads();for(var t in this.gamepads){var e=this.gamepads[t];e.timestamp&&e.timestamp==this.prevTimestamps[t]||(this.prevTimestamps[t]=e.timestamp)}},pollGamepads:function(){var t=navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(t){this.gamepads=[];for(var e=!1,i=0;i<t.length;i++)typeof t[i]!=this.prevRawGamepadTypes[i]&&(e=!0,this.prevRawGamepadTypes[i]=typeof t[i]),t[i]&&this.gamepads.push(t[i]);e&&this.emit("change")}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeGamePadComponent);var IgeMousePanComponent=IgeEventingClass.extend({classId:"IgeMousePanComponent",componentId:"mousePan",init:function(t,e){this._entity=t,this._options=e,this._enabled=!1,this._startThreshold=5},startThreshold:function(t){return void 0!==t?(this._startThreshold=t,this._entity):this._startThreshold},limit:function(t){return void 0!==t?(this._limit=t,this._entity):this._limit},enabled:function(t){var e=this;return void 0!==t?(this._enabled=t,this._panPreStart=!1,this._panStarted=!1,this._enabled?(this._entity.mouseDown(function(t){e._mouseDown(t)}),this._entity.mouseMove(function(t){e._mouseMove(t)}),this._entity.mouseUp(function(t){e._mouseUp(t)})):(delete this._panStartMouse,delete this._panStartCamera),this._entity):this._enabled},_mouseDown:function(t){if(!this._panStarted&&this._enabled&&t.igeViewport.id()===this._entity.id()){var e=ige._mousePos;this._panStartMouse=e.clone(),this._panStartCamera={x:this._entity.camera._translate.x,y:this._entity.camera._translate.y},this._panPreStart=!0,this._panStarted=!1}},_mouseMove:function(t){if(this._enabled&&this._panStartMouse){var e=ige._mousePos,i={x:this._panStartMouse.x-e.x,y:this._panStartMouse.y-e.y},o=Math.abs(i.x),n=Math.abs(i.y),r=i.x/this._entity.camera._scale.x+this._panStartCamera.x,s=i.y/this._entity.camera._scale.y+this._panStartCamera.y;this._limit&&(r<this._limit.x&&(r=this._limit.x),r>this._limit.x+this._limit.width&&(r=this._limit.x+this._limit.width),s<this._limit.y&&(s=this._limit.y),s>this._limit.y+this._limit.height&&(s=this._limit.y+this._limit.height)),this._panPreStart?(o>this._startThreshold||n>this._startThreshold)&&(this._entity.camera.translateTo(r,s,0),this.emit("panStart"),this._panPreStart=!1,this._panStarted=!0,this.emit("panMove")):(this._entity.camera.translateTo(r,s,0),this.emit("panMove"))}},_mouseUp:function(t){if(this._enabled)if(this._panStarted){if(this._panStartMouse){var e=ige._mousePos,i={x:this._panStartMouse.x-e.x,y:this._panStartMouse.y-e.y},o=i.x/this._entity.camera._scale.x+this._panStartCamera.x,n=i.y/this._entity.camera._scale.y+this._panStartCamera.y;this._limit&&(o<this._limit.x&&(o=this._limit.x),o>this._limit.x+this._limit.width&&(o=this._limit.x+this._limit.width),n<this._limit.y&&(n=this._limit.y),n>this._limit.y+this._limit.height&&(n=this._limit.y+this._limit.height)),this._entity.camera.translateTo(o,n,0),delete this._panStartMouse,delete this._panStartCamera,this.emit("panEnd"),this._panStarted=!1}}else delete this._panStartMouse,
delete this._panStartCamera,this._panStarted=!1}}),IgeMouseZoomComponent=IgeEventingClass.extend({classId:"IgeMouseZoomComponent",componentId:"mouseZoom",init:function(t,e){this._entity=t,this._options=e,this._enabled=!1},enabled:function(t){var e=this;return void 0!==t?(this._enabled=t,this._enabled?(this._entity.mouseDown(function(t){e._mouseDown(t)}),this._entity.mouseMove(function(t){e._mouseMove(t)}),this._entity.mouseUp(function(t){e._mouseUp(t)})):(delete this._zoomStartMouse,delete this._zoomStartCamera),this._entity):this._enabled},_mouseDown:function(t){if(this._enabled&&t.igeViewport.id()===this._entity.id()){var e=ige._mousePos;this._zoomStartMouse={x:e.x,y:e.y},this._zoomStartCamera={x:this._entity.camera._scale.x,y:this._entity.camera._scale.y}}},_mouseMove:function(t){if(this._enabled&&this._zoomStartMouse){var e=ige._mousePos,i={x:-(this._zoomStartMouse.x-e.x)/100,y:-(this._zoomStartMouse.y-e.y)/100};this._entity.camera.scaleTo(i.x+this._zoomStartCamera.x>.02?i.x+this._zoomStartCamera.x:.02,i.x+this._zoomStartCamera.x>.02?i.x+this._zoomStartCamera.x:.02,0)}},_mouseUp:function(t){if(this._enabled&&this._zoomStartMouse){var e=ige._mousePos,i={x:-(this._zoomStartMouse.x-e.x)/100,y:-(this._zoomStartMouse.y-e.y)/100};this._entity.camera.scaleTo(i.x+this._zoomStartCamera.x>.02?i.x+this._zoomStartCamera.x:.02,i.x+this._zoomStartCamera.x>.02?i.x+this._zoomStartCamera.x:.02,0),delete this._zoomStartMouse,delete this._zoomStartCamera}}}),IgeTiledComponent=IgeClass.extend({classId:"IgeTiledComponent",componentId:"tiled",init:function(t,e){this._entity=t,this._options=e},loadJson:function(t,e){var i,o=this;"string"==typeof t?ige.isClient?(i=document.createElement("script"),i.src=t,i.onload=function(){o.log("Tiled data loaded, processing..."),o._processData(tiled,e)},document.getElementsByTagName("head")[0].appendChild(i)):this.log("URL-based Tiled data is only available client-side. If you want to load Tiled map data on the server please include the map file in your ServerConfig.js file and then specify the map's data object instead of the URL.","error"):o._processData(t,e)},_processData:function(t,e){var i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y=!0===ige.isServer?IgeTileMap2d:IgeTextureMap,g=t.width,v=t.height,x=t.layers,b=x.length,E=[],T={},w=t.tilesets,S=w.length,C=S,R=0,M=[],D=[];if(u=function(){for(m=0;m<b;m++){if(i=x[m],"tilelayer"===(o=i.type)){if(n=i.data,E[m]=(new y).id(i.name).tileWidth(t.tilewidth).tileHeight(t.tilewidth).depth(m),E[m].type=o,"isometric"===t.orientation&&E[m].isometricMounts(!0),T[i.name]=E[m],S=w.length,ige.isClient)for(d=0;d<S;d++)E[m].addTexture(D[d]);for(r=n.length,_=0;_<v;_++)for(p=0;p<g;p++)f=p+_*g,n[f]>0&&2147483712!==n[f]&&(ige.isClient?(a=M[n[f]])&&(h=n[f]-(a._tiledStartingId-1),E[m].paintTile(p,_,E[m]._textureList.indexOf(a),h)):E[m].occupyTile(p,_,1,1,n[f]))}"objectgroup"===o&&(E[m]=i,T[i.name]=E[m])}e(E,T)},ige.isClient)for(l=function(t,e,i){return function(){var e,o;new IgeCellSheet(i.image,this.width/i.tilewidth,this.height/i.tileheight).id(i.name).on("loaded",function(){for(o=this.cellCount(),this._tiledStartingId=i.firstgid,e=0;e<o;e++)M[this._tiledStartingId+e]=this;t.push(this),++R===C&&u()})}};S--;)c=new Image,s=w[S],c.onload=l(D,S,s),c.src=s.image;else u()}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTiledComponent);var IgeUiManagerComponent=IgeClass.extend({classId:"IgeUiManagerComponent",componentId:"ui",init:function(t,e){var i=this;this._entity=t,this._options=e,this._focus=null,this._caret=null,this._register=[],this._styles={},this._elementsByStyle={},ige.input.on("keyDown",function(t){i._keyDown(t)})},style:function(t,e){return void 0!==t?void 0!==e?(this._styles[t]=e,this):this._styles[t]:this},registerElement:function(t){this._register.push(t)},unRegisterElement:function(t){this._register.pull(t),delete this._styles["#"+t._id],delete this._styles["#"+t._id+":active"],delete this._styles["#"+t._id+":focus"],delete this._styles["#"+t._id+":hover"]},registerElementStyle:function(t){t&&t._styleClass&&(this._elementsByStyle[t._styleClass]=this._elementsByStyle[t._styleClass]||[],this._elementsByStyle[t._styleClass].push(t))},unRegisterElementStyle:function(t){t&&t._styleClass&&(this._elementsByStyle[t._styleClass]=this._elementsByStyle[t._styleClass]||[],this._elementsByStyle[t._styleClass].push(t))},canFocus:function(t){return t._allowFocus},focus:function(t){if(void 0!==t){if(t===this._focus)return!0;var e=this._focus;if(!(e&&e.emit("blur",t)||(e&&(e._focused=!1,e.blur()),t.emit("focus",e))))return this._focus=t,t._focused=!0,!0}return!1},blur:function(t){return void 0!==t&&t===this._focus&&!t.emit("blur")&&(this._focus=null,t._focused=!1,t._updateStyle(),!0)},_keyUp:function(t){this._focus&&(this._focus.emit("keyUp",t),ige.input.stopPropagation())},_keyDown:function(t){this._focus&&(this._focus.emit("keyDown",t),ige.input.stopPropagation())}}),IgeEntityManager=IgeEventingClass.extend({classId:"IgeEntityManager",componentId:"entityManager",init:function(t,e){this._entity=t,this._options=e,this._mountQueue=[],this._unMountQueue=[],this._maxMountsPerOp=0,this._maxUnMountsPerOp=0,t._orphans=[],t.addBehaviour("entManager",this._updateBehaviour,!1)},_updateBehaviour:function(t){var e=(ige._currentViewport.viewArea(),this.entityManager);e._updateOrphans(),e._updateChildren(),e._processMountQueue(),e._processUnMountQueue()},_updateOrphans:function(){for(var t,e,i,o,n=this._entity._children,r=n.length,s=ige._children,a=s.length;r--;)if(t=n[r],t._managed)if(t.aabb){for(e=1===t._mode||t._parent&&1===t._parent._mountMode?t.bounds3dPolygon().aabb():t.aabb(),o=!1,i=0;i<a;i++)if(s[i].viewArea().intersects(e)){o=!0;break}o?2===t._managed&&(t._inView=!0):1===t._managed?this._unMountQueue.push(t):2===t._managed&&(t._inView=!1)}else this._unMountQueue.push(t)},_updateChildren:function(){for(var t,e,i,o,n=this._entity._orphans,r=n.length,s=ige._children,a=s.length;r--;)if(t=n[r],t._managed)if(t.aabb){for(e=1===t._mode||t._parent&&1===t._parent._mountMode?t.bounds3dPolygon().aabb():t.aabb(),o=!1,i=0;i<a;i++)if(s[i].viewArea().intersects(e)){o=!0;break}o&&(1===t._managed?this._mountQueue.push(t):2===t._managed&&(t._inView=!0))}else this._mountQueue.push(t)},_processMountQueue:function(){for(var t,e=this._mountQueue,i=e.length;i--;)t=e[i],this._entity._orphans.pull(t),t.mount(this._entity);this._mountQueue=[]},_processUnMountQueue:function(){for(var t,e=this._unMountQueue,i=e.length;i--;)t=e[i],t.unMount(),this._entity._orphans.push(t);this._unMountQueue=[]}}),IgeEntityManagerComponent=IgeClass.extend({classId:"IgeEntityManagerComponent",componentId:"entityManager",init:function(t,e){this._entity=t,this._options=e,this._entity.pointToTile||this.log("Warning, IgeEntityManagerComponent is only meant to be added to a tile map!","warning"),this._maps=[],this._overwatchMode=0,this._removeMode=0,this._createArr=[],this._removeArr=[],t.addBehaviour("entityManager",this._behaviour)},addMap:function(t){return void 0!==t&&this._maps.push(t),this._entity},active:function(t){return void 0!==t?(this._active=t,this._entity):this._active},maxCreatePerTick:function(t){return void 0!==t?(this._maxCreatePerTick=t,this._entity):this._maxCreatePerTick},maxRemovePerTick:function(t){return void 0!==t?(this._maxRemovePerTick=t,this._entity):this._maxRemovePerTick},overwatchMode:function(t){return void 0!==t?(this._overwatchMode=t,this._entity):this._overwatchMode},createCheck:function(t){return void 0!==t?(this._createCheck=t,this._entity):this._createCheck},createEntityFromMapData:function(t){return void 0!==t?(this._createEntityFromMapData=t,this._entity):this._createEntityFromMapData},removeCheck:function(t){return void 0!==t?(this._removeCheck=t,this._entity):this._removeCheck},trackTranslate:function(t){return void 0!==t?(this._trackTranslateTarget=t,this):this._trackTranslateTarget},unTrackTranslate:function(){delete this._trackTranslateTarget},areaCenter:function(t,e){if(void 0!==t&&void 0!==e){var i,o=this._entity;return 0===o._mode&&(i=o._translate),1===o._mode&&(i=o._translate.toIso()),t-=i.x,e-=i.y,this._areaCenter=new IgePoint3d(t,e,0),this._entity}return this._areaCenter},areaRect:function(t,e,i,o){return void 0!==t&&void 0!==e&&void 0!==i&&void 0!==o?(this._areaRect=new IgeRect(t,e,i,o),this._entity):this._areaRect},areaRectAutoSize:function(t,e){return void 0!==t?(this._areaRectAutoSize=t,this._areaRectAutoSizeOptions=e,this._entity):this._areaRectAutoSize},currentArea:function(){this._trackTranslateTarget&&(!0===this._trackTranslateTarget.isometric()?entTranslate=this._trackTranslateTarget._translate.toIso():entTranslate=this._trackTranslateTarget._translate,this.areaCenter(entTranslate.x,entTranslate.y));var t=this._areaRect,e=this._areaCenter;return t&&e?new IgeRect(Math.floor(t.x+e.x),Math.floor(t.y+e.y),Math.floor(t.width),Math.floor(t.height)):new IgeRect(0,0,0,0)},removeMode:function(t){return void 0!==t?(this._removeMode=t,this._entity):this._removeMode},_behaviour:function(t){var e,i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y=this.entityManager,g=this._children,v=g.length,x=y._maps;if(y._areaRect&&!ige._resized||!y._areaRectAutoSize||y._resizeEvent(),e=y.currentArea(),y._areaCenter&&y._areaRect&&!e.compare(y._lastArea)){for(a=this.pointToTile(y._areaCenter),h=a.x,l=a.y,c=Math.ceil(e.width/this._tileWidth),u=Math.ceil(e.height/this._tileHeight),e.x-=this._tileWidth,e.y-=this._tileHeight/2,e.width+=2*this._tileWidth,e.height+=this._tileHeight,0===this._mountMode&&(i=new IgeRect(h-Math.floor(c/2)-1,l-Math.floor(u/2)-1,h+Math.floor(c/2)+1-(h-Math.floor(c/2)-1),l+Math.floor(u/2)+1-(l-Math.floor(u/2)-1))),1===this._mountMode&&(_=Math.abs(c)>Math.abs(u)?c:u,f=.6,i=new IgeRect(h-Math.floor(_*f),l-Math.floor(_*f),h+Math.floor(_*f)+1-(h-Math.floor(_*f)),l+Math.floor(_*f)+1-(l-Math.floor(_*f)))),this._drawBounds&&(t.strokeStyle="#ff0000",t.strokeRect(e.x,e.y,e.width,e.height),this._highlightTileRect=i),n=this.map;v--;)o=g[v],y._removeCheck&&!y._removeCheck(o)||i.intersects(o._occupiedRect)||y._removeArr.push(o);for(r in x)if(x.hasOwnProperty(r))for(n=x[r],s=n.map._mapData,d=i.y;d<i.y+i.height;d++)if(s[d])for(m=i.x;m<i.x+i.width;m++)(p=s[d][m])&&(y._createCheck&&!y._createCheck(n,m,d,p)||y._createArr.push([n,m,d,p]));y._lastArea=e,y.processQueues()}},processQueues:function(){var t,e=this._createArr,i=e.length,o=void 0!==this._maxCreatePerTick?this._maxCreatePerTick:0,n=this._createEntityFromMapData,r=this._removeArr,s=r.length,a=void 0!==this._maxRemovePerTick?this._maxRemovePerTick:0;for(o&&i>o&&(i=o),a&&s>a&&(s=a),t=0;t<s;t++)0===this._removeMode&&r.shift().destroy();for(t=0;t<i;t++)n.apply(this,e.shift())},_resizeEvent:function(t){if(this._areaRectAutoSize){var e=this._entity._parent._bounds2d,i=0,o=0;this._areaRectAutoSizeOptions&&(this._areaRectAutoSizeOptions.bufferMultiple&&(i=e.x*this._areaRectAutoSizeOptions.bufferMultiple.x-e.x,o=e.y*this._areaRectAutoSizeOptions.bufferMultiple.y-e.y),this._areaRectAutoSizeOptions.bufferPixels&&(i=this._areaRectAutoSizeOptions.bufferPixels.x,o=this._areaRectAutoSizeOptions.bufferPixels.y)),this.areaRect(-Math.floor((e.x+i)/2),-Math.floor((e.y+o)/2),e.x+i,e.y+o),this._caching>0&&this._resizeCacheCanvas()}}}),IgeEditorComponent=IgeEventingClass.extend({classId:"IgeEditorComponent",componentId:"editor",init:function(t,e){var i=this;this._entity=t,this._options=e,this._showStats=0,this._templateCache={},this._cacheTemplates=!0,this.ui={},this._interceptMouse=!1,this._activateKeyHandle=ige.input.on("keyUp",function(t){if("U+00BB"===t.keyIdentifier)return i.toggle(),!0}),this._activateKeyHandle=ige.input.on("keyUp",function(t){if("U+00BD"===t.keyIdentifier)return i.toggleStats(),!0}),this._mouseUpHandle=ige.input.on("preMouseUp",function(t){if(i._enabled&&i._interceptMouse)return i.emit("mouseUp",t),!0}),this._mouseDownHandle=ige.input.on("preMouseDown",function(t){if(i._enabled&&i._interceptMouse)return i.emit("mouseDown",t),!0}),this._mouseMoveHandle=ige.input.on("preMouseMove",function(t){if(i._enabled&&i._interceptMouse)return i.emit("mouseMove",t),!0}),this._contextMenuHandle=ige.input.on("preContextMenu",function(t){if(i._enabled&&i._interceptMouse)return i.emit("contextMenu",t),!0}),ige.requireScript(igeRoot+"components/editor/vendor/jsRender.js"),ige.requireScript(igeRoot+"components/editor/vendor/jquery.2.0.3.min.js"),ige.on("allRequireScriptsLoaded",function(){$(function(){$("body").on("dragover",function(t){t.preventDefault()}).on("drop",function(t){t.preventDefault()})}),i.loadHtml(igeRoot+"components/editor/root.html",function(t){$("body").append($(t)),ige.requireScript(igeRoot+"components/editor/vendor/jsrender-helpers.js"),ige.requireScript(igeRoot+"components/editor/vendor/observe.js"),ige.requireStylesheet(igeRoot+"components/editor/vendor/glyphicons/css/halflings.css"),ige.requireStylesheet(igeRoot+"components/editor/vendor/glyphicons/css/glyphicons.css"),ige.requireStylesheet(igeRoot+"components/editor/vendor/treeview_simple/css/style.css"),ige.requireStylesheet(igeRoot+"components/editor/css/editor.css"),ige.on("sgTreeSelectionChanged",function(t){i._objectSelected(ige.$(t))}),ige.on("allRequireScriptsLoaded",function(){ige.sync(ige.requireScript,igeRoot+"components/editor/ui/dialogs/dialogs.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/scenegraph/scenegraph.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/menu/menu.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/toolbox/toolbox.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/panels/panels.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/textures/textures.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/textureEditor/textureEditor.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/ui/animationEditor/animationEditor.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/vendor/autoback.jquery.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/vendor/tree/tree.jquery.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/vendor/tabs/tabs.jquery.js"),ige.sync(ige.requireScript,igeRoot+"components/editor/vendor/treeview_simple/treeview_simple.jquery.js"),ige.on("syncComplete",function(){setInterval(function(){$("#editorFps").html(ige._fps+" fps"),$("#editorDps").html(ige._dps+" dps"),$("#editorDpf").html(ige._dpf+" dpf"),$("#editorUd").html(ige._updateTime+" ud/ms"),$("#editorRd").html(ige._renderTime+" rd/ms"),$("#editorTd").html(ige._tickTime+" td/ms")},1e3),$(".backed").autoback();for(var t in i.ui)i.ui.hasOwnProperty(t)&&i.ui[t].ready&&i.ui[t].ready();$(".tabGroup").tabs(),$("#statsToggle").on("click",function(){ige.editor.toggleStats()}),$("#editorToggle").on("click",function(){ige.editor.toggle()})},null,!0)},null,!0)})},null,!0),this._enabled=!1,this._show=!1,this.objectDefault={IgeTextureMap:{drawGrid:100}},this.log("Init complete")},interceptMouse:function(t){this._interceptMouse=t},enabled:function(t){return void 0!==t?(this._enabled=t,this._entity):this._enabled},toggle:function(){$("#editorToggle").hasClass("active")?ige.editor.hide():ige.editor.show()},show:function(){this.enabled(!0),this._show=!0,$("#editorToggle").html("Editor On").removeClass("active").addClass("active"),$(".editorElem.toggleHide").addClass("shown")},hide:function(){this.enabled(!1),this._show=!1,$("#editorToggle").html("Editor Off").removeClass("active"),$(".editorElem.toggleHide").removeClass("shown")},toggleStats:function(){$("#statsToggle").hasClass("active")?ige.editor.hideStats():ige.editor.showStats()},showStats:function(){$("#statsToggle").html("Stats On").removeClass("active").addClass("active"),$(".counter").show()},hideStats:function(){$("#statsToggle").html("Stats Off").removeClass("active"),$(".counter").hide()},loadHtml:function(t,e){$.ajax({url:t,success:e,dataType:"html"})},template:function(t,e){var i=this;this._cacheTemplates&&this._templateCache[t]?e&&e(!1,this._templateCache[t]):(this.log("Loading template data from: "+t),$.ajax(t,{async:!0,dataType:"text",complete:function(o,n){if("success"===n){var r=jsviews.templates(o.responseText);i._cacheTemplates&&(i._templateCache[t]=r),e&&e(!1,r)}else e&&e(!0,n)}}))},renderTemplate:function(t,e,i){this.template(t,function(t,o){t?i(t):i(t,$($.parseHTML(o.render(e))))})},selectObject:function(t){void 0!==t&&(t?(this._selectedObject=ige.$(t),this._objectSelected(this._selectedObject)):delete this._selectedObject)},_objectSelected:function(t){if(t){ige.editor.ui.panels.showPanelByInstance(t),this._selectedObjectClassList=ige.getClassDerivedList(t),$("[data-active-for]").removeClass("disabled").addClass("disabled");var e,i=this._selectedObjectClassList;for(e=0;e<i.length;e++)$('[data-active-for~="'+i[e]+'"]').removeClass("disabled");this.emit("selectedObject",t.id())}},destroySelected:function(){this._selectedObject&&(this._selectedObject.destroy(),this.selectObject(null))},createObject:function(t,e){if(this._selectedObject){var i=ige.newClassInstance(t);if(i.mount(this._selectedObject),this.ui.scenegraph.updateSceneGraph(),e&&(this.selectObject(i.id()),this.ui.toolbox.select("toolSelect")),this.objectDefault[t])for(var o in this.objectDefault[t])this.objectDefault[t].hasOwnProperty(o)&&(this.objectDefault[t][o]instanceof Array?i[o].apply(i,this.objectDefault[t][o]):i[o].call(i,this.objectDefault[t][o]))}},_statsTick:function(){var t=ige.editor;t._showStats&&!t._statsPauseUpdate&&t._showStats},addToSgTree:function(t){var e,i,o,n,r,s,a=document.createElement("li");if(n=function(t){t.stopPropagation();var e=document.getElementsByClassName("sgItem selected");for(o=0;o<e.length;o++)e[o].className="sgItem";this.className+=" selected",ige._sgTreeSelected=this.id,ige._currentViewport.drawBounds(!0),"ige"!==this.id?ige._currentViewport.drawBoundsLimitId(this.id):ige._currentViewport.drawBoundsLimitId(""),ige.emit("sgTreeSelectionChanged",ige._sgTreeSelected)},r=function(t){t.stopPropagation()},a.addEventListener("mouseup",n,!1),a.addEventListener("dblclick",r,!1),a.id=t.id,a.innerHTML=t.text,a.className="sgItem",ige._sgTreeSelected===t.id&&(a.className+=" selected"),igeConfig.debug._timing&&ige._timeSpentInTick[t.id]&&(s="<span>"+ige._timeSpentInTick[t.id]+"ms</span>",a.innerHTML+=" "+s),document.getElementById(t.parentId+"_items").appendChild(a),t.items)for(a=document.createElement("ul"),a.id=t.id+"_items",document.getElementById(t.id).appendChild(a),e=t.items,i=e.length,o=0;o<i;o++)ige.addToSgTree(e[o])},toggleShowEditor:function(){if(this._showSgTree=!this._showSgTree,this._showSgTree){var t,e,i=this,o=document.createElement("div");e=ige._canvasPosition(),o.id="igeSgTree",o.style.top=parseInt(e.top)+5+"px",o.style.left=parseInt(e.left)+5+"px",o.style.height=ige._bounds2d.y-30+"px",o.style.overflow="auto",o.addEventListener("mousemove",function(t){t.stopPropagation()}),o.addEventListener("mouseup",function(t){t.stopPropagation()}),o.addEventListener("mousedown",function(t){t.stopPropagation()}),t=document.createElement("ul"),t.id="sceneGraph_items",o.appendChild(t),document.body.appendChild(o);var n=document.createElement("div"),r=document.createElement("input"),s=document.createElement("div"),a=document.createElement("iframe");n.id="igeSgConsoleHolder",n.innerHTML="<div><b>Console</b>: Double-Click a SceneGraph Object to Script it Here</div>",r.type="text",r.id="igeSgConsole",s.id="igeSgItemClassChain",a.id="igeSgDocPage",a.name="igeSgDocPage",n.appendChild(r),n.appendChild(s),n.appendChild(a),document.body.appendChild(n),this.sgTreeUpdate();var h=document.createElement("input");h.type="button",h.id="igeSgRefreshTree",h.style.position="absolute",h.style.top="0px",h.style.right="0px",h.value="Refresh",h.addEventListener("click",function(){i.sgTreeUpdate()},!1),document.getElementById("igeSgTree").appendChild(h);var l=document.createElement("div"),c=document.createElement("input"),u=document.createElement("input"),m=document.createElement("input"),d=document.createElement("span");l.id="igeSgEditorRoot",d.id="igeSgEditorStatus",c.type="button",c.id="igeSgEditorTranslate",c.value="Translate",c.addEventListener("click",function(){ige.editorRotate.enabled(!1),ige.editorTranslate.enabled()?(ige.editorTranslate.enabled(!1),i.log("Editor: Translate mode disabled")):(ige.editorTranslate.enabled(!0),i.log("Editor: Translate mode enabled"))}),u.type="button",u.id="igeSgEditorRotate",u.value="Rotate",u.addEventListener("click",function(){ige.editorTranslate.enabled(!1),ige.editorRotate.enabled()?(ige.editorRotate.enabled(!1),i.log("Editor: Rotate mode disabled")):(ige.editorRotate.enabled(!0),i.log("Editor: Rotate mode enabled"))}),m.type="button",m.id="igeSgEditorScale",m.value="Scale",l.appendChild(c),l.appendChild(u),l.appendChild(m),l.appendChild(d),document.body.appendChild(l),ige.addComponent(IgeEditorTranslateComponent),ige.addComponent(IgeEditorRotateComponent),ige._sgTreeUpdateInterval=setInterval(function(){i.sgTreeUpdate()},1e3)}else{clearInterval(ige._sgTreeUpdateInterval);var p=document.getElementById("igeSgTree");p.parentNode.removeChild(p),p=document.getElementById("igeSgConsoleHolder"),p.parentNode.removeChild(p),p=document.getElementById("igeSgEditorRoot"),p.parentNode.removeChild(p),ige.removeComponent("editorTranslate"),ige.removeComponent("editorRotate")}},sgTreeUpdate:function(){document.getElementById("sceneGraph_items").innerHTML="",this.addToSgTree(this.getSceneGraphData(this,!0))}}),Box2D={};!function(t,e){function i(){}!(Object.defineProperty instanceof Function)&&Object.__defineGetter__ instanceof Function&&Object.__defineSetter__ instanceof Function&&(Object.defineProperty=function(t,e,i){i.get instanceof Function&&t.__defineGetter__(e,i.get),i.set instanceof Function&&t.__defineSetter__(e,i.set)}),t.inherit=function(t,e){var o=t;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=o},t.generateCallback=function(t,e){return function(){e.apply(t,arguments)}},t.NVector=function(t){void 0===t&&(t=0);for(var e=new Array(t||0),i=0;i<t;++i)e[i]=0;return e},t.is=function(t,e){return null!==t&&(e instanceof Function&&t instanceof e||!(void 0==t.constructor.__implements||!t.constructor.__implements[e]))},t.parseUInt=function(t){return Math.abs(parseInt(t))}}(Box2D);var Vector=Array,Vector_a2j_Number=Box2D.NVector;void 0===Box2D&&(Box2D={}),void 0===Box2D.Collision&&(Box2D.Collision={}),void 0===Box2D.Collision.Shapes&&(Box2D.Collision.Shapes={}),void 0===Box2D.Common&&(Box2D.Common={}),void 0===Box2D.Common.Math&&(Box2D.Common.Math={}),void 0===Box2D.Dynamics&&(Box2D.Dynamics={}),void 0===Box2D.Dynamics.Contacts&&(Box2D.Dynamics.Contacts={}),void 0===Box2D.Dynamics.Controllers&&(Box2D.Dynamics.Controllers={}),void 0===Box2D.Dynamics.Joints&&(Box2D.Dynamics.Joints={}),function(){function t(){t.b2AABB.apply(this,arguments)}function e(){e.b2Bound.apply(this,arguments)}function i(){i.b2BoundValues.apply(this,arguments),this.constructor===i&&this.b2BoundValues.apply(this,arguments)}function o(){o.b2Collision.apply(this,arguments)}function n(){n.b2ContactID.apply(this,arguments),this.constructor===n&&this.b2ContactID.apply(this,arguments)}function r(){r.b2ContactPoint.apply(this,arguments)}function s(){s.b2Distance.apply(this,arguments)}function a(){a.b2DistanceInput.apply(this,arguments)}function h(){h.b2DistanceOutput.apply(this,arguments)}function l(){l.b2DistanceProxy.apply(this,arguments)}function c(){c.b2DynamicTree.apply(this,arguments),this.constructor===c&&this.b2DynamicTree.apply(this,arguments)}function u(){u.b2DynamicTreeBroadPhase.apply(this,arguments)}function m(){m.b2DynamicTreeNode.apply(this,arguments)}function d(){d.b2DynamicTreePair.apply(this,arguments)}function p(){p.b2Manifold.apply(this,arguments),this.constructor===p&&this.b2Manifold.apply(this,arguments)}function _(){_.b2ManifoldPoint.apply(this,arguments),this.constructor===_&&this.b2ManifoldPoint.apply(this,arguments)}function f(){f.b2Point.apply(this,arguments)}function y(){y.b2RayCastInput.apply(this,arguments),this.constructor===y&&this.b2RayCastInput.apply(this,arguments)}function g(){g.b2RayCastOutput.apply(this,arguments)}function v(){v.b2Segment.apply(this,arguments)}function x(){x.b2SeparationFunction.apply(this,arguments)}function b(){b.b2Simplex.apply(this,arguments),this.constructor===b&&this.b2Simplex.apply(this,arguments)}function E(){E.b2SimplexCache.apply(this,arguments)}function T(){T.b2SimplexVertex.apply(this,arguments)}function w(){w.b2TimeOfImpact.apply(this,arguments)}function S(){S.b2TOIInput.apply(this,arguments)}function C(){C.b2WorldManifold.apply(this,arguments),this.constructor===C&&this.b2WorldManifold.apply(this,arguments)}function R(){R.ClipVertex.apply(this,arguments)}function M(){M.Features.apply(this,arguments)}function D(){D.b2CircleShape.apply(this,arguments),this.constructor===D&&this.b2CircleShape.apply(this,arguments)}function A(){A.b2EdgeChainDef.apply(this,arguments),this.constructor===A&&this.b2EdgeChainDef.apply(this,arguments)}function B(){B.b2EdgeShape.apply(this,arguments),this.constructor===B&&this.b2EdgeShape.apply(this,arguments)}function I(){I.b2MassData.apply(this,arguments)}function H(){H.b2PolygonShape.apply(this,arguments),this.constructor===H&&this.b2PolygonShape.apply(this,arguments)}function P(){P.b2Shape.apply(this,arguments),this.constructor===P&&this.b2Shape.apply(this,arguments)}function L(){L.b2Color.apply(this,arguments),this.constructor===L&&this.b2Color.apply(this,arguments)}function V(){V.b2Settings.apply(this,arguments)}function k(){k.b2Mat22.apply(this,arguments),this.constructor===k&&this.b2Mat22.apply(this,arguments)}function F(){F.b2Mat33.apply(this,arguments),this.constructor===F&&this.b2Mat33.apply(this,arguments)}function z(){z.b2Math.apply(this,arguments)}function N(){N.b2Sweep.apply(this,arguments)}function U(){U.b2Transform.apply(this,arguments),this.constructor===U&&this.b2Transform.apply(this,arguments)}function O(){O.b2Vec2.apply(this,arguments),this.constructor===O&&this.b2Vec2.apply(this,arguments)}function G(){G.b2Vec3.apply(this,arguments),this.constructor===G&&this.b2Vec3.apply(this,arguments)}function W(){W.b2Body.apply(this,arguments),this.constructor===W&&this.b2Body.apply(this,arguments)}function j(){j.b2BodyDef.apply(this,arguments),this.constructor===j&&this.b2BodyDef.apply(this,arguments)}function q(){q.b2ContactFilter.apply(this,arguments)}function J(){J.b2ContactImpulse.apply(this,arguments)}function X(){X.b2ContactListener.apply(this,arguments)}function Y(){Y.b2ContactManager.apply(this,arguments),this.constructor===Y&&this.b2ContactManager.apply(this,arguments)}function K(){K.b2DebugDraw.apply(this,arguments),this.constructor===K&&this.b2DebugDraw.apply(this,arguments)}function Z(){Z.b2DestructionListener.apply(this,arguments)}function $(){$.b2FilterData.apply(this,arguments)}function Q(){Q.b2Fixture.apply(this,arguments),this.constructor===Q&&this.b2Fixture.apply(this,arguments)}function tt(){tt.b2FixtureDef.apply(this,arguments),this.constructor===tt&&this.b2FixtureDef.apply(this,arguments)}function et(){et.b2Island.apply(this,arguments),this.constructor===et&&this.b2Island.apply(this,arguments)}function it(){it.b2TimeStep.apply(this,arguments)}function ot(){ot.b2World.apply(this,arguments),this.constructor===ot&&this.b2World.apply(this,arguments)}function nt(){nt.b2CircleContact.apply(this,arguments)}function rt(){rt.b2Contact.apply(this,arguments),this.constructor===rt&&this.b2Contact.apply(this,arguments)}function st(){st.b2ContactConstraint.apply(this,arguments),this.constructor===st&&this.b2ContactConstraint.apply(this,arguments)}function at(){at.b2ContactConstraintPoint.apply(this,arguments)}function ht(){ht.b2ContactEdge.apply(this,arguments)}function lt(){lt.b2ContactFactory.apply(this,arguments),this.constructor===lt&&this.b2ContactFactory.apply(this,arguments)}function ct(){ct.b2ContactRegister.apply(this,arguments)}function ut(){ut.b2ContactResult.apply(this,arguments)}function mt(){mt.b2ContactSolver.apply(this,arguments),this.constructor===mt&&this.b2ContactSolver.apply(this,arguments)}function dt(){dt.b2EdgeAndCircleContact.apply(this,arguments)}function pt(){pt.b2NullContact.apply(this,arguments),this.constructor===pt&&this.b2NullContact.apply(this,arguments)}function _t(){_t.b2PolyAndCircleContact.apply(this,arguments)}function ft(){ft.b2PolyAndEdgeContact.apply(this,arguments)}function yt(){yt.b2PolygonContact.apply(this,arguments)}function gt(){gt.b2PositionSolverManifold.apply(this,arguments),this.constructor===gt&&this.b2PositionSolverManifold.apply(this,arguments)}function vt(){vt.b2BuoyancyController.apply(this,arguments)}function xt(){xt.b2ConstantAccelController.apply(this,arguments)}function bt(){bt.b2ConstantForceController.apply(this,arguments)}function Et(){Et.b2Controller.apply(this,arguments)}function Tt(){Tt.b2ControllerEdge.apply(this,arguments)}function wt(){wt.b2GravityController.apply(this,arguments)}function St(){St.b2TensorDampingController.apply(this,arguments)}function Ct(){Ct.b2DistanceJoint.apply(this,arguments),this.constructor===Ct&&this.b2DistanceJoint.apply(this,arguments)}function Rt(){Rt.b2DistanceJointDef.apply(this,arguments),this.constructor===Rt&&this.b2DistanceJointDef.apply(this,arguments)}function Mt(){Mt.b2FrictionJoint.apply(this,arguments),this.constructor===Mt&&this.b2FrictionJoint.apply(this,arguments)}function Dt(){Dt.b2FrictionJointDef.apply(this,arguments),this.constructor===Dt&&this.b2FrictionJointDef.apply(this,arguments)}function At(){At.b2GearJoint.apply(this,arguments),this.constructor===At&&this.b2GearJoint.apply(this,arguments)}function Bt(){Bt.b2GearJointDef.apply(this,arguments),this.constructor===Bt&&this.b2GearJointDef.apply(this,arguments)}function It(){It.b2Jacobian.apply(this,arguments)}function Ht(){Ht.b2Joint.apply(this,arguments),this.constructor===Ht&&this.b2Joint.apply(this,arguments)}function Pt(){Pt.b2JointDef.apply(this,arguments),this.constructor===Pt&&this.b2JointDef.apply(this,arguments)}function Lt(){Lt.b2JointEdge.apply(this,arguments)}function Vt(){Vt.b2LineJoint.apply(this,arguments),this.constructor===Vt&&this.b2LineJoint.apply(this,arguments)}function kt(){kt.b2LineJointDef.apply(this,arguments),this.constructor===kt&&this.b2LineJointDef.apply(this,arguments)}function Ft(){Ft.b2MouseJoint.apply(this,arguments),this.constructor===Ft&&this.b2MouseJoint.apply(this,arguments)}function zt(){zt.b2MouseJointDef.apply(this,arguments),this.constructor===zt&&this.b2MouseJointDef.apply(this,arguments)}function Nt(){Nt.b2PrismaticJoint.apply(this,arguments),this.constructor===Nt&&this.b2PrismaticJoint.apply(this,arguments)}function Ut(){Ut.b2PrismaticJointDef.apply(this,arguments),this.constructor===Ut&&this.b2PrismaticJointDef.apply(this,arguments)}function Ot(){Ot.b2PulleyJoint.apply(this,arguments),this.constructor===Ot&&this.b2PulleyJoint.apply(this,arguments)}function Gt(){Gt.b2PulleyJointDef.apply(this,arguments),this.constructor===Gt&&this.b2PulleyJointDef.apply(this,arguments)}function Wt(){Wt.b2RevoluteJoint.apply(this,arguments),this.constructor===Wt&&this.b2RevoluteJoint.apply(this,arguments)}function jt(){jt.b2RevoluteJointDef.apply(this,arguments),this.constructor===jt&&this.b2RevoluteJointDef.apply(this,arguments)}function qt(){qt.b2WeldJoint.apply(this,arguments),this.constructor===qt&&this.b2WeldJoint.apply(this,arguments)}function Jt(){Jt.b2WeldJointDef.apply(this,arguments),this.constructor===Jt&&this.b2WeldJointDef.apply(this,arguments)}Box2D.Collision.IBroadPhase="Box2D.Collision.IBroadPhase",Box2D.Collision.b2AABB=t,Box2D.Collision.b2Bound=e,Box2D.Collision.b2BoundValues=i,Box2D.Collision.b2Collision=o,Box2D.Collision.b2ContactID=n,Box2D.Collision.b2ContactPoint=r,Box2D.Collision.b2Distance=s,Box2D.Collision.b2DistanceInput=a,Box2D.Collision.b2DistanceOutput=h,Box2D.Collision.b2DistanceProxy=l,Box2D.Collision.b2DynamicTree=c,Box2D.Collision.b2DynamicTreeBroadPhase=u,Box2D.Collision.b2DynamicTreeNode=m,Box2D.Collision.b2DynamicTreePair=d,Box2D.Collision.b2Manifold=p,Box2D.Collision.b2ManifoldPoint=_,
Box2D.Collision.b2Point=f,Box2D.Collision.b2RayCastInput=y,Box2D.Collision.b2RayCastOutput=g,Box2D.Collision.b2Segment=v,Box2D.Collision.b2SeparationFunction=x,Box2D.Collision.b2Simplex=b,Box2D.Collision.b2SimplexCache=E,Box2D.Collision.b2SimplexVertex=T,Box2D.Collision.b2TimeOfImpact=w,Box2D.Collision.b2TOIInput=S,Box2D.Collision.b2WorldManifold=C,Box2D.Collision.ClipVertex=R,Box2D.Collision.Features=M,Box2D.Collision.Shapes.b2CircleShape=D,Box2D.Collision.Shapes.b2EdgeChainDef=A,Box2D.Collision.Shapes.b2EdgeShape=B,Box2D.Collision.Shapes.b2MassData=I,Box2D.Collision.Shapes.b2PolygonShape=H,Box2D.Collision.Shapes.b2Shape=P,Box2D.Common.b2internal="Box2D.Common.b2internal",Box2D.Common.b2Color=L,Box2D.Common.b2Settings=V,Box2D.Common.Math.b2Mat22=k,Box2D.Common.Math.b2Mat33=F,Box2D.Common.Math.b2Math=z,Box2D.Common.Math.b2Sweep=N,Box2D.Common.Math.b2Transform=U,Box2D.Common.Math.b2Vec2=O,Box2D.Common.Math.b2Vec3=G,Box2D.Dynamics.b2Body=W,Box2D.Dynamics.b2BodyDef=j,Box2D.Dynamics.b2ContactFilter=q,Box2D.Dynamics.b2ContactImpulse=J,Box2D.Dynamics.b2ContactListener=X,Box2D.Dynamics.b2ContactManager=Y,Box2D.Dynamics.b2DebugDraw=K,Box2D.Dynamics.b2DestructionListener=Z,Box2D.Dynamics.b2FilterData=$,Box2D.Dynamics.b2Fixture=Q,Box2D.Dynamics.b2FixtureDef=tt,Box2D.Dynamics.b2Island=et,Box2D.Dynamics.b2TimeStep=it,Box2D.Dynamics.b2World=ot,Box2D.Dynamics.Contacts.b2CircleContact=nt,Box2D.Dynamics.Contacts.b2Contact=rt,Box2D.Dynamics.Contacts.b2ContactConstraint=st,Box2D.Dynamics.Contacts.b2ContactConstraintPoint=at,Box2D.Dynamics.Contacts.b2ContactEdge=ht,Box2D.Dynamics.Contacts.b2ContactFactory=lt,Box2D.Dynamics.Contacts.b2ContactRegister=ct,Box2D.Dynamics.Contacts.b2ContactResult=ut,Box2D.Dynamics.Contacts.b2ContactSolver=mt,Box2D.Dynamics.Contacts.b2EdgeAndCircleContact=dt,Box2D.Dynamics.Contacts.b2NullContact=pt,Box2D.Dynamics.Contacts.b2PolyAndCircleContact=_t,Box2D.Dynamics.Contacts.b2PolyAndEdgeContact=ft,Box2D.Dynamics.Contacts.b2PolygonContact=yt,Box2D.Dynamics.Contacts.b2PositionSolverManifold=gt,Box2D.Dynamics.Controllers.b2BuoyancyController=vt,Box2D.Dynamics.Controllers.b2ConstantAccelController=xt,Box2D.Dynamics.Controllers.b2ConstantForceController=bt,Box2D.Dynamics.Controllers.b2Controller=Et,Box2D.Dynamics.Controllers.b2ControllerEdge=Tt,Box2D.Dynamics.Controllers.b2GravityController=wt,Box2D.Dynamics.Controllers.b2TensorDampingController=St,Box2D.Dynamics.Joints.b2DistanceJoint=Ct,Box2D.Dynamics.Joints.b2DistanceJointDef=Rt,Box2D.Dynamics.Joints.b2FrictionJoint=Mt,Box2D.Dynamics.Joints.b2FrictionJointDef=Dt,Box2D.Dynamics.Joints.b2GearJoint=At,Box2D.Dynamics.Joints.b2GearJointDef=Bt,Box2D.Dynamics.Joints.b2Jacobian=It,Box2D.Dynamics.Joints.b2Joint=Ht,Box2D.Dynamics.Joints.b2JointDef=Pt,Box2D.Dynamics.Joints.b2JointEdge=Lt,Box2D.Dynamics.Joints.b2LineJoint=Vt,Box2D.Dynamics.Joints.b2LineJointDef=kt,Box2D.Dynamics.Joints.b2MouseJoint=Ft,Box2D.Dynamics.Joints.b2MouseJointDef=zt,Box2D.Dynamics.Joints.b2PrismaticJoint=Nt,Box2D.Dynamics.Joints.b2PrismaticJointDef=Ut,Box2D.Dynamics.Joints.b2PulleyJoint=Ot,Box2D.Dynamics.Joints.b2PulleyJointDef=Gt,Box2D.Dynamics.Joints.b2RevoluteJoint=Wt,Box2D.Dynamics.Joints.b2RevoluteJointDef=jt,Box2D.Dynamics.Joints.b2WeldJoint=qt,Box2D.Dynamics.Joints.b2WeldJointDef=Jt}(),Box2D.postDefs=[],function(){var t=Box2D.Collision.Shapes.b2CircleShape,e=(Box2D.Collision.Shapes.b2EdgeChainDef,Box2D.Collision.Shapes.b2EdgeShape,Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),i=Box2D.Collision.Shapes.b2Shape,o=(Box2D.Common.b2Color,Box2D.Common.b2internal,Box2D.Common.b2Settings),n=(Box2D.Common.Math.b2Mat22,Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math),r=Box2D.Common.Math.b2Sweep,s=Box2D.Common.Math.b2Transform,a=Box2D.Common.Math.b2Vec2,h=(Box2D.Common.Math.b2Vec3,Box2D.Collision.b2AABB),l=Box2D.Collision.b2Bound,c=Box2D.Collision.b2BoundValues,u=Box2D.Collision.b2Collision,m=Box2D.Collision.b2ContactID,d=Box2D.Collision.b2ContactPoint,p=Box2D.Collision.b2Distance,_=Box2D.Collision.b2DistanceInput,f=Box2D.Collision.b2DistanceOutput,y=Box2D.Collision.b2DistanceProxy,g=Box2D.Collision.b2DynamicTree,v=Box2D.Collision.b2DynamicTreeBroadPhase,x=Box2D.Collision.b2DynamicTreeNode,b=Box2D.Collision.b2DynamicTreePair,E=Box2D.Collision.b2Manifold,T=Box2D.Collision.b2ManifoldPoint,w=Box2D.Collision.b2Point,S=Box2D.Collision.b2RayCastInput,C=Box2D.Collision.b2RayCastOutput,R=Box2D.Collision.b2Segment,M=Box2D.Collision.b2SeparationFunction,D=Box2D.Collision.b2Simplex,A=Box2D.Collision.b2SimplexCache,B=Box2D.Collision.b2SimplexVertex,I=Box2D.Collision.b2TimeOfImpact,H=Box2D.Collision.b2TOIInput,P=Box2D.Collision.b2WorldManifold,L=Box2D.Collision.ClipVertex,V=Box2D.Collision.Features,k=Box2D.Collision.IBroadPhase;h.b2AABB=function(){this.lowerBound=new a,this.upperBound=new a},h.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y,i=t>=0&&e>=0;return i=i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},h.prototype.GetCenter=function(){return new a((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},h.prototype.GetExtents=function(){return new a((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},h.prototype.Contains=function(t){var e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y},h.prototype.RayCast=function(t,e){var i=-Number.MAX_VALUE,o=Number.MAX_VALUE,n=e.p1.x,r=e.p1.y,s=e.p2.x-e.p1.x,a=e.p2.y-e.p1.y,h=Math.abs(s),l=Math.abs(a),c=t.normal,u=0,m=0,d=0,p=0,_=0;if(h<Number.MIN_VALUE){if(n<this.lowerBound.x||this.upperBound.x<n)return!1}else if(u=1/s,m=(this.lowerBound.x-n)*u,d=(this.upperBound.x-n)*u,_=-1,m>d&&(p=m,m=d,d=p,_=1),m>i&&(c.x=_,c.y=0,i=m),o=Math.min(o,d),i>o)return!1;if(l<Number.MIN_VALUE){if(r<this.lowerBound.y||this.upperBound.y<r)return!1}else if(u=1/a,m=(this.lowerBound.y-r)*u,d=(this.upperBound.y-r)*u,_=-1,m>d&&(p=m,m=d,d=p,_=1),m>i&&(c.y=_,c.x=0,i=m),o=Math.min(o,d),i>o)return!1;return t.fraction=i,!0},h.prototype.TestOverlap=function(t){var e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,o=this.lowerBound.x-t.upperBound.x,n=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0)&&!(o>0||n>0)},h.Combine=function(t,e){var i=new h;return i.Combine(t,e),i},h.prototype.Combine=function(t,e){this.lowerBound.x=Math.min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,e.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,e.upperBound.y)},l.b2Bound=function(){},l.prototype.IsLower=function(){return 0==(1&this.value)},l.prototype.IsUpper=function(){return 1==(1&this.value)},l.prototype.Swap=function(t){var e=this.value,i=this.proxy,o=this.stabbingCount;this.value=t.value,this.proxy=t.proxy,this.stabbingCount=t.stabbingCount,t.value=e,t.proxy=i,t.stabbingCount=o},c.b2BoundValues=function(){},c.prototype.b2BoundValues=function(){this.lowerValues=new Vector_a2j_Number,this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=new Vector_a2j_Number,this.upperValues[0]=0,this.upperValues[1]=0},u.b2Collision=function(){},u.ClipSegmentToLine=function(t,e,i,o){void 0===o&&(o=0);var n,r=0;n=e[0];var s=n.v;n=e[1];var a=n.v,h=i.x*s.x+i.y*s.y-o,l=i.x*a.x+i.y*a.y-o;if(h<=0&&t[r++].Set(e[0]),l<=0&&t[r++].Set(e[1]),h*l<0){var c=h/(h-l);n=t[r];var u=n.v;u.x=s.x+c*(a.x-s.x),u.y=s.y+c*(a.y-s.y),n=t[r];var m;h>0?(m=e[0],n.id=m.id):(m=e[1],n.id=m.id),++r}return r},u.EdgeSeparation=function(t,e,i,o,n){void 0===i&&(i=0);var r,s,a=(parseInt(t.m_vertexCount),t.m_vertices),h=t.m_normals,l=parseInt(o.m_vertexCount),c=o.m_vertices;r=e.R,s=h[i];var u=r.col1.x*s.x+r.col2.x*s.y,m=r.col1.y*s.x+r.col2.y*s.y;r=n.R;for(var d=r.col1.x*u+r.col1.y*m,p=r.col2.x*u+r.col2.y*m,_=0,f=Number.MAX_VALUE,y=0;y<l;++y){s=c[y];var g=s.x*d+s.y*p;g<f&&(f=g,_=y)}s=a[i],r=e.R;var v=e.position.x+(r.col1.x*s.x+r.col2.x*s.y),x=e.position.y+(r.col1.y*s.x+r.col2.y*s.y);s=c[_],r=n.R;var b=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),E=n.position.y+(r.col1.y*s.x+r.col2.y*s.y);return b-=v,E-=x,b*u+E*m},u.FindMaxSeparation=function(t,e,i,o,n){var r,s,a=parseInt(e.m_vertexCount),h=e.m_normals;s=n.R,r=o.m_centroid;var l=n.position.x+(s.col1.x*r.x+s.col2.x*r.y),c=n.position.y+(s.col1.y*r.x+s.col2.y*r.y);s=i.R,r=e.m_centroid,l-=i.position.x+(s.col1.x*r.x+s.col2.x*r.y),c-=i.position.y+(s.col1.y*r.x+s.col2.y*r.y);for(var m=l*i.R.col1.x+c*i.R.col1.y,d=l*i.R.col2.x+c*i.R.col2.y,p=0,_=-Number.MAX_VALUE,f=0;f<a;++f){r=h[f];var y=r.x*m+r.y*d;y>_&&(_=y,p=f)}var g=u.EdgeSeparation(e,i,p,o,n),v=parseInt(p-1>=0?p-1:a-1),x=u.EdgeSeparation(e,i,v,o,n),b=parseInt(p+1<a?p+1:0),E=u.EdgeSeparation(e,i,b,o,n),T=0,w=0,S=0;if(x>g&&x>E)S=-1,T=v,w=x;else{if(!(E>g))return t[0]=p,g;S=1,T=b,w=E}for(;;){if(p=-1==S?T-1>=0?T-1:a-1:T+1<a?T+1:0,!((g=u.EdgeSeparation(e,i,p,o,n))>w))break;T=p,w=g}return t[0]=T,w},u.FindIncidentEdge=function(t,e,i,o,n,r){void 0===o&&(o=0);var s,a,h=(parseInt(e.m_vertexCount),e.m_normals),l=parseInt(n.m_vertexCount),c=n.m_vertices,u=n.m_normals;s=i.R,a=h[o];var m=s.col1.x*a.x+s.col2.x*a.y,d=s.col1.y*a.x+s.col2.y*a.y;s=r.R;var p=s.col1.x*m+s.col1.y*d;d=s.col2.x*m+s.col2.y*d,m=p;for(var _=0,f=Number.MAX_VALUE,y=0;y<l;++y){a=u[y];var g=m*a.x+d*a.y;g<f&&(f=g,_=y)}var v,x=parseInt(_),b=parseInt(x+1<l?x+1:0);v=t[0],a=c[x],s=r.R,v.v.x=r.position.x+(s.col1.x*a.x+s.col2.x*a.y),v.v.y=r.position.y+(s.col1.y*a.x+s.col2.y*a.y),v.id.features.referenceEdge=o,v.id.features.incidentEdge=x,v.id.features.incidentVertex=0,v=t[1],a=c[b],s=r.R,v.v.x=r.position.x+(s.col1.x*a.x+s.col2.x*a.y),v.v.y=r.position.y+(s.col1.y*a.x+s.col2.y*a.y),v.id.features.referenceEdge=o,v.id.features.incidentEdge=b,v.id.features.incidentVertex=1},u.MakeClipPointVector=function(){var t=new Vector(2);return t[0]=new L,t[1]=new L,t},u.CollidePolygons=function(t,e,i,n,r){var s;t.m_pointCount=0;var a=e.m_radius+n.m_radius,h=0;u.s_edgeAO[0]=h;var l=u.FindMaxSeparation(u.s_edgeAO,e,i,n,r);if(h=u.s_edgeAO[0],!(l>a)){var c=0;u.s_edgeBO[0]=c;var m=u.FindMaxSeparation(u.s_edgeBO,n,r,e,i);if(c=u.s_edgeBO[0],!(m>a)){var d,p,_,f,y,g=0,v=0;m>.98*l+.001?(d=n,p=e,_=r,f=i,g=c,t.m_type=E.e_faceB,v=1):(d=e,p=n,_=i,f=r,g=h,t.m_type=E.e_faceA,v=0);var x=u.s_incidentEdge;u.FindIncidentEdge(x,d,_,g,p,f);var b,T=parseInt(d.m_vertexCount),w=d.m_vertices,S=w[g];b=g+1<T?w[parseInt(g+1)]:w[0];var C=u.s_localTangent;C.Set(b.x-S.x,b.y-S.y),C.Normalize();var R=u.s_localNormal;R.x=C.y,R.y=-C.x;var M=u.s_planePoint;M.Set(.5*(S.x+b.x),.5*(S.y+b.y));var D=u.s_tangent;y=_.R,D.x=y.col1.x*C.x+y.col2.x*C.y,D.y=y.col1.y*C.x+y.col2.y*C.y;var A=u.s_tangent2;A.x=-D.x,A.y=-D.y;var B=u.s_normal;B.x=D.y,B.y=-D.x;var I=u.s_v11,H=u.s_v12;I.x=_.position.x+(y.col1.x*S.x+y.col2.x*S.y),I.y=_.position.y+(y.col1.y*S.x+y.col2.y*S.y),H.x=_.position.x+(y.col1.x*b.x+y.col2.x*b.y),H.y=_.position.y+(y.col1.y*b.x+y.col2.y*b.y);var P=B.x*I.x+B.y*I.y,L=-D.x*I.x-D.y*I.y+a,V=D.x*H.x+D.y*H.y+a,k=u.s_clipPoints1,F=u.s_clipPoints2;if(!(u.ClipSegmentToLine(k,x,A,L)<2||u.ClipSegmentToLine(F,k,D,V)<2)){t.m_localPlaneNormal.SetV(R),t.m_localPoint.SetV(M);for(var z=0,N=0;N<o.b2_maxManifoldPoints;++N){s=F[N];if(B.x*s.v.x+B.y*s.v.y-P<=a){var U=t.m_points[z];y=f.R;var O=s.v.x-f.position.x,G=s.v.y-f.position.y;U.m_localPoint.x=O*y.col1.x+G*y.col1.y,U.m_localPoint.y=O*y.col2.x+G*y.col2.y,U.m_id.Set(s.id),U.m_id.features.flip=v,++z}}t.m_pointCount=z}}}},u.CollideCircles=function(t,e,i,o,n){t.m_pointCount=0;var r,s;r=i.R,s=e.m_p;var a=i.position.x+(r.col1.x*s.x+r.col2.x*s.y),h=i.position.y+(r.col1.y*s.x+r.col2.y*s.y);r=n.R,s=o.m_p;var l=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),c=n.position.y+(r.col1.y*s.x+r.col2.y*s.y),u=l-a,m=c-h,d=u*u+m*m,p=e.m_radius+o.m_radius;d>p*p||(t.m_type=E.e_circles,t.m_localPoint.SetV(e.m_p),t.m_localPlaneNormal.SetZero(),t.m_pointCount=1,t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0)},u.CollidePolygonAndCircle=function(t,e,i,o,n){t.m_pointCount=0;var r,s,a=0,h=0;s=n.R,r=o.m_p;var l=n.position.x+(s.col1.x*r.x+s.col2.x*r.y),c=n.position.y+(s.col1.y*r.x+s.col2.y*r.y);a=l-i.position.x,h=c-i.position.y,s=i.R;for(var u=a*s.col1.x+h*s.col1.y,m=a*s.col2.x+h*s.col2.y,d=0,p=-Number.MAX_VALUE,_=e.m_radius+o.m_radius,f=parseInt(e.m_vertexCount),y=e.m_vertices,g=e.m_normals,v=0;v<f;++v){r=y[v],a=u-r.x,h=m-r.y,r=g[v];var x=r.x*a+r.y*h;if(x>_)return;x>p&&(p=x,d=v)}var b=parseInt(d),T=parseInt(b+1<f?b+1:0),w=y[b],S=y[T];if(p<Number.MIN_VALUE)return t.m_pointCount=1,t.m_type=E.e_faceA,t.m_localPlaneNormal.SetV(g[d]),t.m_localPoint.x=.5*(w.x+S.x),t.m_localPoint.y=.5*(w.y+S.y),t.m_points[0].m_localPoint.SetV(o.m_p),void(t.m_points[0].m_id.key=0);var C=(u-w.x)*(S.x-w.x)+(m-w.y)*(S.y-w.y),R=(u-S.x)*(w.x-S.x)+(m-S.y)*(w.y-S.y);if(C<=0){if((u-w.x)*(u-w.x)+(m-w.y)*(m-w.y)>_*_)return;t.m_pointCount=1,t.m_type=E.e_faceA,t.m_localPlaneNormal.x=u-w.x,t.m_localPlaneNormal.y=m-w.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(w),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}else if(R<=0){if((u-S.x)*(u-S.x)+(m-S.y)*(m-S.y)>_*_)return;t.m_pointCount=1,t.m_type=E.e_faceA,t.m_localPlaneNormal.x=u-S.x,t.m_localPlaneNormal.y=m-S.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(S),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}else{var M=.5*(w.x+S.x),D=.5*(w.y+S.y);if((p=(u-M)*g[b].x+(m-D)*g[b].y)>_)return;t.m_pointCount=1,t.m_type=E.e_faceA,t.m_localPlaneNormal.x=g[b].x,t.m_localPlaneNormal.y=g[b].y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.Set(M,D),t.m_points[0].m_localPoint.SetV(o.m_p),t.m_points[0].m_id.key=0}},u.TestOverlap=function(t,e){var i=e.lowerBound,o=t.upperBound,n=i.x-o.x,r=i.y-o.y;i=t.lowerBound,o=e.upperBound;var s=i.x-o.x,a=i.y-o.y;return!(n>0||r>0)&&!(s>0||a>0)},Box2D.postDefs.push(function(){Box2D.Collision.b2Collision.s_incidentEdge=u.MakeClipPointVector(),Box2D.Collision.b2Collision.s_clipPoints1=u.MakeClipPointVector(),Box2D.Collision.b2Collision.s_clipPoints2=u.MakeClipPointVector(),Box2D.Collision.b2Collision.s_edgeAO=new Vector_a2j_Number(1),Box2D.Collision.b2Collision.s_edgeBO=new Vector_a2j_Number(1),Box2D.Collision.b2Collision.s_localTangent=new a,Box2D.Collision.b2Collision.s_localNormal=new a,Box2D.Collision.b2Collision.s_planePoint=new a,Box2D.Collision.b2Collision.s_normal=new a,Box2D.Collision.b2Collision.s_tangent=new a,Box2D.Collision.b2Collision.s_tangent2=new a,Box2D.Collision.b2Collision.s_v11=new a,Box2D.Collision.b2Collision.s_v12=new a,Box2D.Collision.b2Collision.b2CollidePolyTempVec=new a,Box2D.Collision.b2Collision.b2_nullFeature=255}),m.b2ContactID=function(){this.features=new V},m.prototype.b2ContactID=function(){this.features._m_id=this},m.prototype.Set=function(t){this.key=t._key},m.prototype.Copy=function(){var t=new m;return t.key=this.key,t},Object.defineProperty(m.prototype,"key",{enumerable:!1,configurable:!0,get:function(){return this._key}}),Object.defineProperty(m.prototype,"key",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._key=t,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}}),d.b2ContactPoint=function(){this.position=new a,this.velocity=new a,this.normal=new a,this.id=new m},p.b2Distance=function(){},p.Distance=function(t,e,i){++p.b2_gjkCalls;var r=i.proxyA,s=i.proxyB,h=i.transformA,l=i.transformB,c=p.s_simplex;c.ReadCache(e,r,h,s,l);for(var u,m=c.m_vertices,d=p.s_saveA,_=p.s_saveB,f=0,y=c.GetClosestPoint(),g=y.LengthSquared(),v=g,x=0,b=0;b<20;){for(f=c.m_count,x=0;x<f;x++)d[x]=m[x].indexA,_[x]=m[x].indexB;switch(c.m_count){case 1:break;case 2:c.Solve2();break;case 3:c.Solve3();break;default:o.b2Assert(!1)}if(3==c.m_count)break;u=c.GetClosestPoint(),v=u.LengthSquared(),g=v;var E=c.GetSearchDirection();if(E.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;var T=m[c.m_count];T.indexA=r.GetSupport(n.MulTMV(h.R,E.GetNegative())),T.wA=n.MulX(h,r.GetVertex(T.indexA)),T.indexB=s.GetSupport(n.MulTMV(l.R,E)),T.wB=n.MulX(l,s.GetVertex(T.indexB)),T.w=n.SubtractVV(T.wB,T.wA),++b,++p.b2_gjkIters;var w=!1;for(x=0;x<f;x++)if(T.indexA==d[x]&&T.indexB==_[x]){w=!0;break}if(w)break;++c.m_count}if(p.b2_gjkMaxIters=n.Max(p.b2_gjkMaxIters,b),c.GetWitnessPoints(t.pointA,t.pointB),t.distance=n.SubtractVV(t.pointA,t.pointB).Length(),t.iterations=b,c.WriteCache(e),i.useRadii){var S=r.m_radius,C=s.m_radius;if(t.distance>S+C&&t.distance>Number.MIN_VALUE){t.distance-=S+C;var R=n.SubtractVV(t.pointB,t.pointA);R.Normalize(),t.pointA.x+=S*R.x,t.pointA.y+=S*R.y,t.pointB.x-=C*R.x,t.pointB.y-=C*R.y}else u=new a,u.x=.5*(t.pointA.x+t.pointB.x),u.y=.5*(t.pointA.y+t.pointB.y),t.pointA.x=t.pointB.x=u.x,t.pointA.y=t.pointB.y=u.y,t.distance=0}},Box2D.postDefs.push(function(){Box2D.Collision.b2Distance.s_simplex=new D,Box2D.Collision.b2Distance.s_saveA=new Vector_a2j_Number(3),Box2D.Collision.b2Distance.s_saveB=new Vector_a2j_Number(3)}),_.b2DistanceInput=function(){},f.b2DistanceOutput=function(){this.pointA=new a,this.pointB=new a},y.b2DistanceProxy=function(){},y.prototype.Set=function(n){switch(n.GetType()){case i.e_circleShape:var r=n instanceof t?n:null;this.m_vertices=new Vector(1,!0),this.m_vertices[0]=r.m_p,this.m_count=1,this.m_radius=r.m_radius;break;case i.e_polygonShape:var s=n instanceof e?n:null;this.m_vertices=s.m_vertices,this.m_count=s.m_vertexCount,this.m_radius=s.m_radius;break;default:o.b2Assert(!1)}},y.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_count;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return e},y.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_count;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return this.m_vertices[e]},y.prototype.GetVertexCount=function(){return this.m_count},y.prototype.GetVertex=function(t){return void 0===t&&(t=0),o.b2Assert(0<=t&&t<this.m_count),this.m_vertices[t]},g.b2DynamicTree=function(){},g.prototype.b2DynamicTree=function(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0},g.prototype.CreateProxy=function(t,e){var i=this.AllocateNode(),n=o.b2_aabbExtension,r=o.b2_aabbExtension;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-r,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+r,i.userData=e,this.InsertLeaf(i),i},g.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},g.prototype.MoveProxy=function(t,e,i){if(o.b2Assert(t.IsLeaf()),t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var n=o.b2_aabbExtension+o.b2_aabbMultiplier*(i.x>0?i.x:-i.x),r=o.b2_aabbExtension+o.b2_aabbMultiplier*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+r,this.InsertLeaf(t),!0},g.prototype.Rebalance=function(t){if(void 0===t&&(t=0),null!=this.m_root)for(var e=0;e<t;e++){for(var i=this.m_root,o=0;0==i.IsLeaf();)i=this.m_path>>o&1?i.child2:i.child1,o=o+1&31;++this.m_path,this.RemoveLeaf(i),this.InsertLeaf(i)}},g.prototype.GetFatAABB=function(t){return t.aabb},g.prototype.GetUserData=function(t){return t.userData},g.prototype.Query=function(t,e){if(null!=this.m_root){var i=new Vector,o=0;for(i[o++]=this.m_root;o>0;){var n=i[--o];if(n.aabb.TestOverlap(e))if(n.IsLeaf()){var r=t(n);if(!r)return}else i[o++]=n.child1,i[o++]=n.child2}}},g.prototype.RayCast=function(t,e){if(null!=this.m_root){var i=e.p1,o=e.p2,r=n.SubtractVV(i,o);r.Normalize();var s=n.CrossFV(1,r),a=n.AbsV(s),l=e.maxFraction,c=new h,u=0,m=0;u=i.x+l*(o.x-i.x),m=i.y+l*(o.y-i.y),c.lowerBound.x=Math.min(i.x,u),c.lowerBound.y=Math.min(i.y,m),c.upperBound.x=Math.max(i.x,u),c.upperBound.y=Math.max(i.y,m);var d=new Vector,p=0;for(d[p++]=this.m_root;p>0;){var _=d[--p];if(0!=_.aabb.TestOverlap(c)){var f=_.aabb.GetCenter(),y=_.aabb.GetExtents();if(!(Math.abs(s.x*(i.x-f.x)+s.y*(i.y-f.y))-a.x*y.x-a.y*y.y>0))if(_.IsLeaf()){var g=new S;if(g.p1=e.p1,g.p2=e.p2,g.maxFraction=e.maxFraction,0==(l=t(g,_)))return;l>0&&(u=i.x+l*(o.x-i.x),m=i.y+l*(o.y-i.y),c.lowerBound.x=Math.min(i.x,u),c.lowerBound.y=Math.min(i.y,m),c.upperBound.x=Math.max(i.x,u),c.upperBound.y=Math.max(i.y,m))}else d[p++]=_.child1,d[p++]=_.child2}}}},g.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t}return new x},g.prototype.FreeNode=function(t){t.parent=this.m_freeList,this.m_freeList=t},g.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);var e=t.aabb.GetCenter(),i=this.m_root;if(0==i.IsLeaf())do{var o=i.child1,n=i.child2,r=Math.abs((o.aabb.lowerBound.x+o.aabb.upperBound.x)/2-e.x)+Math.abs((o.aabb.lowerBound.y+o.aabb.upperBound.y)/2-e.y),s=Math.abs((n.aabb.lowerBound.x+n.aabb.upperBound.x)/2-e.x)+Math.abs((n.aabb.lowerBound.y+n.aabb.upperBound.y)/2-e.y);i=r<s?o:n}while(0==i.IsLeaf());var a=i.parent,h=this.AllocateNode();if(h.parent=a,h.userData=null,h.aabb.Combine(t.aabb,i.aabb),a){i.parent.child1==i?a.child1=h:a.child2=h,h.child1=i,h.child2=t,i.parent=h,t.parent=h;do{if(a.aabb.Contains(h.aabb))break;a.aabb.Combine(a.child1.aabb,a.child2.aabb),h=a,a=a.parent}while(a)}else h.child1=i,h.child2=t,i.parent=h,t.parent=h,this.m_root=h},g.prototype.RemoveLeaf=function(t){if(t==this.m_root)return void(this.m_root=null);var e,i=t.parent,o=i.parent;if(e=i.child1==t?i.child2:i.child1,o)for(o.child1==i?o.child1=e:o.child2=e,e.parent=o,this.FreeNode(i);o;){var n=o.aabb;if(o.aabb=h.Combine(o.child1.aabb,o.child2.aabb),n.Contains(o.aabb))break;o=o.parent}else this.m_root=e,e.parent=null,this.FreeNode(i)},v.b2DynamicTreeBroadPhase=function(){this.m_tree=new g,this.m_moveBuffer=new Vector,this.m_pairBuffer=new Vector,this.m_pairCount=0},v.prototype.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},v.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},v.prototype.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},v.prototype.TestOverlap=function(t,e){var i=this.m_tree.GetFatAABB(t),o=this.m_tree.GetFatAABB(e);return i.TestOverlap(o)},v.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},v.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},v.prototype.GetProxyCount=function(){return this.m_proxyCount},v.prototype.UpdatePairs=function(t){function e(t){if(t==o)return!0;i.m_pairCount==i.m_pairBuffer.length&&(i.m_pairBuffer[i.m_pairCount]=new b);var e=i.m_pairBuffer[i.m_pairCount];return e.proxyA=t<o?t:o,e.proxyB=t>=o?t:o,++i.m_pairCount,!0}var i=this;i.m_pairCount=0;var o,n=0;for(n=0;n<i.m_moveBuffer.length;++n){o=i.m_moveBuffer[n];var r=i.m_tree.GetFatAABB(o);i.m_tree.Query(e,r)}i.m_moveBuffer.length=0;for(var n=0;n<i.m_pairCount;){var s=i.m_pairBuffer[n],a=i.m_tree.GetUserData(s.proxyA),h=i.m_tree.GetUserData(s.proxyB);for(t(a,h),++n;n<i.m_pairCount;){var l=i.m_pairBuffer[n];if(l.proxyA!=s.proxyA||l.proxyB!=s.proxyB)break;++n}}},v.prototype.Query=function(t,e){this.m_tree.Query(t,e)},v.prototype.RayCast=function(t,e){this.m_tree.RayCast(t,e)},v.prototype.Validate=function(){},v.prototype.Rebalance=function(t){void 0===t&&(t=0),this.m_tree.Rebalance(t)},v.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveBuffer.length]=t},v.prototype.UnBufferMove=function(t){var e=parseInt(this.m_moveBuffer.indexOf(t));this.m_moveBuffer.splice(e,1)},v.prototype.ComparePairs=function(t,e){return 0},v.__implements={},v.__implements[k]=!0,x.b2DynamicTreeNode=function(){this.aabb=new h},x.prototype.IsLeaf=function(){return null==this.child1},b.b2DynamicTreePair=function(){},E.b2Manifold=function(){this.m_pointCount=0},E.prototype.b2Manifold=function(){this.m_points=new Vector(o.b2_maxManifoldPoints);for(var t=0;t<o.b2_maxManifoldPoints;t++)this.m_points[t]=new T;this.m_localPlaneNormal=new a,this.m_localPoint=new a},E.prototype.Reset=function(){for(var t=0;t<o.b2_maxManifoldPoints;t++)(this.m_points[t]instanceof T?this.m_points[t]:null).Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_type=0,this.m_pointCount=0},E.prototype.Set=function(t){this.m_pointCount=t.m_pointCount;for(var e=0;e<o.b2_maxManifoldPoints;e++)(this.m_points[e]instanceof T?this.m_points[e]:null).Set(t.m_points[e]);this.m_localPlaneNormal.SetV(t.m_localPlaneNormal),this.m_localPoint.SetV(t.m_localPoint),this.m_type=t.m_type},E.prototype.Copy=function(){var t=new E;return t.Set(this),t},Box2D.postDefs.push(function(){Box2D.Collision.b2Manifold.e_circles=1,Box2D.Collision.b2Manifold.e_faceA=2,Box2D.Collision.b2Manifold.e_faceB=4}),T.b2ManifoldPoint=function(){this.m_localPoint=new a,this.m_id=new m},T.prototype.b2ManifoldPoint=function(){this.Reset()},T.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_normalImpulse=0,this.m_tangentImpulse=0,this.m_id.key=0},T.prototype.Set=function(t){this.m_localPoint.SetV(t.m_localPoint),this.m_normalImpulse=t.m_normalImpulse,this.m_tangentImpulse=t.m_tangentImpulse,this.m_id.Set(t.m_id)},w.b2Point=function(){this.p=new a},w.prototype.Support=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=0),this.p},w.prototype.GetFirstVertex=function(t){return this.p},S.b2RayCastInput=function(){this.p1=new a,this.p2=new a},S.prototype.b2RayCastInput=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=1),t&&this.p1.SetV(t),e&&this.p2.SetV(e),this.maxFraction=i},C.b2RayCastOutput=function(){this.normal=new a},R.b2Segment=function(){this.p1=new a,this.p2=new a},R.prototype.TestSegment=function(t,e,i,o){void 0===o&&(o=0);var n=i.p1,r=i.p2.x-n.x,s=i.p2.y-n.y,a=this.p2.x-this.p1.x,h=this.p2.y-this.p1.y,l=h,c=-a,u=100*Number.MIN_VALUE,m=-(r*l+s*c);if(m>u){var d=n.x-this.p1.x,p=n.y-this.p1.y,_=d*l+p*c;if(0<=_&&_<=o*m){var f=-r*p+s*d;if(-u*m<=f&&f<=m*(1+u)){_/=m;var y=Math.sqrt(l*l+c*c);return l/=y,c/=y,t[0]=_,e.Set(l,c),!0}}}return!1},R.prototype.Extend=function(t){this.ExtendForward(t),this.ExtendBackward(t)},R.prototype.ExtendForward=function(t){var e=this.p2.x-this.p1.x,i=this.p2.y-this.p1.y,o=Math.min(e>0?(t.upperBound.x-this.p1.x)/e:e<0?(t.lowerBound.x-this.p1.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p1.y)/i:i<0?(t.lowerBound.y-this.p1.y)/i:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+e*o,this.p2.y=this.p1.y+i*o},R.prototype.ExtendBackward=function(t){var e=-this.p2.x+this.p1.x,i=-this.p2.y+this.p1.y,o=Math.min(e>0?(t.upperBound.x-this.p2.x)/e:e<0?(t.lowerBound.x-this.p2.x)/e:Number.POSITIVE_INFINITY,i>0?(t.upperBound.y-this.p2.y)/i:i<0?(t.lowerBound.y-this.p2.y)/i:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+e*o,this.p1.y=this.p2.y+i*o},M.b2SeparationFunction=function(){this.m_localPoint=new a,this.m_axis=new a},M.prototype.Initialize=function(t,e,i,r,s){this.m_proxyA=e,this.m_proxyB=r;var h=parseInt(t.count);o.b2Assert(0<h&&h<3);var l,c,u,m,d,p,_,f,y=0,g=0,v=0,x=0,b=0,E=0,T=0;if(1==h)this.m_type=M.e_points,l=this.m_proxyA.GetVertex(t.indexA[0]),m=this.m_proxyB.GetVertex(t.indexB[0]),f=l,_=i.R,y=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),g=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=s.R,v=s.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=s.position.y+(_.col1.y*f.x+_.col2.y*f.y),this.m_axis.x=v-y,this.m_axis.y=x-g,this.m_axis.Normalize();else if(t.indexB[0]==t.indexB[1])this.m_type=M.e_faceA,c=this.m_proxyA.GetVertex(t.indexA[0]),u=this.m_proxyA.GetVertex(t.indexA[1]),m=this.m_proxyB.GetVertex(t.indexB[0]),this.m_localPoint.x=.5*(c.x+u.x),this.m_localPoint.y=.5*(c.y+u.y),this.m_axis=n.CrossVF(n.SubtractVV(u,c),1),this.m_axis.Normalize(),f=this.m_axis,_=i.R,b=_.col1.x*f.x+_.col2.x*f.y,E=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=i.R,y=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),g=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=s.R,v=s.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=s.position.y+(_.col1.y*f.x+_.col2.y*f.y),(T=(v-y)*b+(x-g)*E)<0&&this.m_axis.NegativeSelf();else if(t.indexA[0]==t.indexA[0])this.m_type=M.e_faceB,d=this.m_proxyB.GetVertex(t.indexB[0]),p=this.m_proxyB.GetVertex(t.indexB[1]),l=this.m_proxyA.GetVertex(t.indexA[0]),this.m_localPoint.x=.5*(d.x+p.x),this.m_localPoint.y=.5*(d.y+p.y),this.m_axis=n.CrossVF(n.SubtractVV(p,d),1),this.m_axis.Normalize(),f=this.m_axis,_=s.R,b=_.col1.x*f.x+_.col2.x*f.y,E=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=s.R,v=s.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=s.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=l,_=i.R,y=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),g=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),(T=(y-v)*b+(g-x)*E)<0&&this.m_axis.NegativeSelf();else{c=this.m_proxyA.GetVertex(t.indexA[0]),u=this.m_proxyA.GetVertex(t.indexA[1]),d=this.m_proxyB.GetVertex(t.indexB[0]),p=this.m_proxyB.GetVertex(t.indexB[1]);var w=(n.MulX(i,l),n.MulMV(i.R,n.SubtractVV(u,c))),S=(n.MulX(s,m),n.MulMV(s.R,n.SubtractVV(p,d))),C=w.x*w.x+w.y*w.y,R=S.x*S.x+S.y*S.y,D=n.SubtractVV(S,w),A=w.x*D.x+w.y*D.y,B=S.x*D.x+S.y*D.y,I=w.x*S.x+w.y*S.y,H=C*R-I*I;T=0,0!=H&&(T=n.Clamp((I*B-A*R)/H,0,1));var P=(I*T+B)/R;P<0&&(P=0,T=n.Clamp((I-A)/C,0,1)),l=new a,l.x=c.x+T*(u.x-c.x),l.y=c.y+T*(u.y-c.y),m=new a,m.x=d.x+T*(p.x-d.x),m.y=d.y+T*(p.y-d.y),0==T||1==T?(this.m_type=M.e_faceB,this.m_axis=n.CrossVF(n.SubtractVV(p,d),1),this.m_axis.Normalize(),this.m_localPoint=m,f=this.m_axis,_=s.R,b=_.col1.x*f.x+_.col2.x*f.y,E=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=s.R,v=s.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=s.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=l,_=i.R,y=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),g=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),(y-v)*b+(g-x)*E,T<0&&this.m_axis.NegativeSelf()):(this.m_type=M.e_faceA,this.m_axis=n.CrossVF(n.SubtractVV(u,c),1),this.m_localPoint=l,f=this.m_axis,_=i.R,b=_.col1.x*f.x+_.col2.x*f.y,E=_.col1.y*f.x+_.col2.y*f.y,f=this.m_localPoint,_=i.R,y=i.position.x+(_.col1.x*f.x+_.col2.x*f.y),g=i.position.y+(_.col1.y*f.x+_.col2.y*f.y),f=m,_=s.R,v=s.position.x+(_.col1.x*f.x+_.col2.x*f.y),x=s.position.y+(_.col1.y*f.x+_.col2.y*f.y),(v-y)*b+(x-g)*E,T<0&&this.m_axis.NegativeSelf())}},M.prototype.Evaluate=function(t,e){var i,r,s,a,h,l,c;switch(this.m_type){case M.e_points:return i=n.MulTMV(t.R,this.m_axis),r=n.MulTMV(e.R,this.m_axis.GetNegative()),s=this.m_proxyA.GetSupportVertex(i),a=this.m_proxyB.GetSupportVertex(r),h=n.MulX(t,s),l=n.MulX(e,a),(l.x-h.x)*this.m_axis.x+(l.y-h.y)*this.m_axis.y;case M.e_faceA:return c=n.MulMV(t.R,this.m_axis),h=n.MulX(t,this.m_localPoint),r=n.MulTMV(e.R,c.GetNegative()),a=this.m_proxyB.GetSupportVertex(r),l=n.MulX(e,a),(l.x-h.x)*c.x+(l.y-h.y)*c.y;case M.e_faceB:return c=n.MulMV(e.R,this.m_axis),l=n.MulX(e,this.m_localPoint),i=n.MulTMV(t.R,c.GetNegative()),s=this.m_proxyA.GetSupportVertex(i),h=n.MulX(t,s),(h.x-l.x)*c.x+(h.y-l.y)*c.y;default:return o.b2Assert(!1),0}},Box2D.postDefs.push(function(){Box2D.Collision.b2SeparationFunction.e_points=1,Box2D.Collision.b2SeparationFunction.e_faceA=2,Box2D.Collision.b2SeparationFunction.e_faceB=4}),D.b2Simplex=function(){this.m_v1=new B,this.m_v2=new B,this.m_v3=new B,this.m_vertices=new Vector(3)},D.prototype.b2Simplex=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},D.prototype.ReadCache=function(t,e,i,r,s){o.b2Assert(0<=t.count&&t.count<=3);var a,h;this.m_count=t.count;for(var l=this.m_vertices,c=0;c<this.m_count;c++){var u=l[c];u.indexA=t.indexA[c],u.indexB=t.indexB[c],a=e.GetVertex(u.indexA),h=r.GetVertex(u.indexB),u.wA=n.MulX(i,a),u.wB=n.MulX(s,h),u.w=n.SubtractVV(u.wB,u.wA),u.a=0}if(this.m_count>1){var m=t.metric,d=this.GetMetric();(d<.5*m||2*m<d||d<Number.MIN_VALUE)&&(this.m_count=0)}0==this.m_count&&(u=l[0],u.indexA=0,u.indexB=0,a=e.GetVertex(0),h=r.GetVertex(0),u.wA=n.MulX(i,a),u.wB=n.MulX(s,h),u.w=n.SubtractVV(u.wB,u.wA),this.m_count=1)},
D.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=Box2D.parseUInt(this.m_count);for(var e=this.m_vertices,i=0;i<this.m_count;i++)t.indexA[i]=Box2D.parseUInt(e[i].indexA),t.indexB[i]=Box2D.parseUInt(e[i].indexB)},D.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var t=n.SubtractVV(this.m_v2.w,this.m_v1.w);return n.CrossVV(t,this.m_v1.w.GetNegative())>0?n.CrossFV(1,t):n.CrossVF(t,1);default:return o.b2Assert(!1),new a}},D.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:return o.b2Assert(!1),new a;case 1:return this.m_v1.w;case 2:return new a(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);default:return o.b2Assert(!1),new a}},D.prototype.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:o.b2Assert(!1);break;case 1:t.SetV(this.m_v1.wA),e.SetV(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break;default:o.b2Assert(!1)}},D.prototype.GetMetric=function(){switch(this.m_count){case 0:return o.b2Assert(!1),0;case 1:return 0;case 2:return n.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return n.CrossVV(n.SubtractVV(this.m_v2.w,this.m_v1.w),n.SubtractVV(this.m_v3.w,this.m_v1.w));default:return o.b2Assert(!1),0}},D.prototype.Solve2=function(){var t=this.m_v1.w,e=this.m_v2.w,i=n.SubtractVV(e,t),o=-(t.x*i.x+t.y*i.y);if(o<=0)return this.m_v1.a=1,void(this.m_count=1);var r=e.x*i.x+e.y*i.y;if(r<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);var s=1/(r+o);this.m_v1.a=r*s,this.m_v2.a=o*s,this.m_count=2},D.prototype.Solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,o=n.SubtractVV(e,t),r=n.Dot(t,o),s=n.Dot(e,o),a=s,h=-r,l=n.SubtractVV(i,t),c=n.Dot(t,l),u=n.Dot(i,l),m=u,d=-c,p=n.SubtractVV(i,e),_=n.Dot(e,p),f=n.Dot(i,p),y=f,g=-_,v=n.CrossVV(o,l),x=v*n.CrossVV(e,i),b=v*n.CrossVV(i,t),E=v*n.CrossVV(t,e);if(h<=0&&d<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&h>0&&E<=0){var T=1/(a+h);return this.m_v1.a=a*T,this.m_v2.a=h*T,void(this.m_count=2)}if(m>0&&d>0&&b<=0){var w=1/(m+d);return this.m_v1.a=m*w,this.m_v3.a=d*w,this.m_count=2,void this.m_v2.Set(this.m_v3)}if(a<=0&&g<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);if(m<=0&&y<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Set(this.m_v3);if(y>0&&g>0&&x<=0){var S=1/(y+g);return this.m_v2.a=y*S,this.m_v3.a=g*S,this.m_count=2,void this.m_v1.Set(this.m_v3)}var C=1/(x+b+E);this.m_v1.a=x*C,this.m_v2.a=b*C,this.m_v3.a=E*C,this.m_count=3},A.b2SimplexCache=function(){this.indexA=new Vector_a2j_Number(3),this.indexB=new Vector_a2j_Number(3)},B.b2SimplexVertex=function(){},B.prototype.Set=function(t){this.wA.SetV(t.wA),this.wB.SetV(t.wB),this.w.SetV(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB},I.b2TimeOfImpact=function(){},I.TimeOfImpact=function(t){++I.b2_toiCalls;var e=t.proxyA,i=t.proxyB,r=t.sweepA,s=t.sweepB;o.b2Assert(r.t0==s.t0),o.b2Assert(1-r.t0>Number.MIN_VALUE);var a=e.m_radius+i.m_radius,h=t.tolerance,l=0,c=0,u=0;for(I.s_cache.count=0,I.s_distanceInput.useRadii=!1;;){if(r.GetTransform(I.s_xfA,l),s.GetTransform(I.s_xfB,l),I.s_distanceInput.proxyA=e,I.s_distanceInput.proxyB=i,I.s_distanceInput.transformA=I.s_xfA,I.s_distanceInput.transformB=I.s_xfB,p.Distance(I.s_distanceOutput,I.s_cache,I.s_distanceInput),I.s_distanceOutput.distance<=0){l=1;break}I.s_fcn.Initialize(I.s_cache,e,I.s_xfA,i,I.s_xfB);var m=I.s_fcn.Evaluate(I.s_xfA,I.s_xfB);if(m<=0){l=1;break}if(0==c&&(u=m>a?n.Max(a-h,.75*a):n.Max(m-h,.02*a)),m-u<.5*h){if(0==c){l=1;break}break}var d=l,_=l,f=1,y=m;r.GetTransform(I.s_xfA,f),s.GetTransform(I.s_xfB,f);var g=I.s_fcn.Evaluate(I.s_xfA,I.s_xfB);if(g>=u){l=1;break}for(var v=0;;){var x=0;x=1&v?_+(u-y)*(f-_)/(g-y):.5*(_+f),r.GetTransform(I.s_xfA,x),s.GetTransform(I.s_xfB,x);var b=I.s_fcn.Evaluate(I.s_xfA,I.s_xfB);if(n.Abs(b-u)<.025*h){d=x;break}if(b>u?(_=x,y=b):(f=x,g=b),++v,++I.b2_toiRootIters,50==v)break}if(I.b2_toiMaxRootIters=n.Max(I.b2_toiMaxRootIters,v),d<(1+100*Number.MIN_VALUE)*l)break;if(l=d,c++,++I.b2_toiIters,1e3==c)break}return I.b2_toiMaxIters=n.Max(I.b2_toiMaxIters,c),l},Box2D.postDefs.push(function(){Box2D.Collision.b2TimeOfImpact.b2_toiCalls=0,Box2D.Collision.b2TimeOfImpact.b2_toiIters=0,Box2D.Collision.b2TimeOfImpact.b2_toiMaxIters=0,Box2D.Collision.b2TimeOfImpact.b2_toiRootIters=0,Box2D.Collision.b2TimeOfImpact.b2_toiMaxRootIters=0,Box2D.Collision.b2TimeOfImpact.s_cache=new A,Box2D.Collision.b2TimeOfImpact.s_distanceInput=new _,Box2D.Collision.b2TimeOfImpact.s_xfA=new s,Box2D.Collision.b2TimeOfImpact.s_xfB=new s,Box2D.Collision.b2TimeOfImpact.s_fcn=new M,Box2D.Collision.b2TimeOfImpact.s_distanceOutput=new f}),H.b2TOIInput=function(){this.proxyA=new y,this.proxyB=new y,this.sweepA=new r,this.sweepB=new r},P.b2WorldManifold=function(){this.m_normal=new a},P.prototype.b2WorldManifold=function(){this.m_points=new Vector(o.b2_maxManifoldPoints);for(var t=0;t<o.b2_maxManifoldPoints;t++)this.m_points[t]=new a},P.prototype.Initialize=function(t,e,i,o,n){if(void 0===i&&(i=0),void 0===n&&(n=0),0!=t.m_pointCount){var r,s,a=0,h=0,l=0,c=0,u=0,m=0,d=0;switch(t.m_type){case E.e_circles:s=e.R,r=t.m_localPoint;var p=e.position.x+s.col1.x*r.x+s.col2.x*r.y,_=e.position.y+s.col1.y*r.x+s.col2.y*r.y;s=o.R,r=t.m_points[0].m_localPoint;var f=o.position.x+s.col1.x*r.x+s.col2.x*r.y,y=o.position.y+s.col1.y*r.x+s.col2.y*r.y,g=f-p,v=y-_,x=g*g+v*v;if(x>Number.MIN_VALUE*Number.MIN_VALUE){var b=Math.sqrt(x);this.m_normal.x=g/b,this.m_normal.y=v/b}else this.m_normal.x=1,this.m_normal.y=0;var T=p+i*this.m_normal.x,w=_+i*this.m_normal.y,S=f-n*this.m_normal.x,C=y-n*this.m_normal.y;this.m_points[0].x=.5*(T+S),this.m_points[0].y=.5*(w+C);break;case E.e_faceA:for(s=e.R,r=t.m_localPlaneNormal,h=s.col1.x*r.x+s.col2.x*r.y,l=s.col1.y*r.x+s.col2.y*r.y,s=e.R,r=t.m_localPoint,c=e.position.x+s.col1.x*r.x+s.col2.x*r.y,u=e.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_normal.x=h,this.m_normal.y=l,a=0;a<t.m_pointCount;a++)s=o.R,r=t.m_points[a].m_localPoint,m=o.position.x+s.col1.x*r.x+s.col2.x*r.y,d=o.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_points[a].x=m+.5*(i-(m-c)*h-(d-u)*l-n)*h,this.m_points[a].y=d+.5*(i-(m-c)*h-(d-u)*l-n)*l;break;case E.e_faceB:for(s=o.R,r=t.m_localPlaneNormal,h=s.col1.x*r.x+s.col2.x*r.y,l=s.col1.y*r.x+s.col2.y*r.y,s=o.R,r=t.m_localPoint,c=o.position.x+s.col1.x*r.x+s.col2.x*r.y,u=o.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_normal.x=-h,this.m_normal.y=-l,a=0;a<t.m_pointCount;a++)s=e.R,r=t.m_points[a].m_localPoint,m=e.position.x+s.col1.x*r.x+s.col2.x*r.y,d=e.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_points[a].x=m+.5*(n-(m-c)*h-(d-u)*l-i)*h,this.m_points[a].y=d+.5*(n-(m-c)*h-(d-u)*l-i)*l}}},L.ClipVertex=function(){this.v=new a,this.id=new m},L.prototype.Set=function(t){this.v.SetV(t.v),this.id.Set(t.id)},V.Features=function(){},Object.defineProperty(V.prototype,"referenceEdge",{enumerable:!1,configurable:!0,get:function(){return this._referenceEdge}}),Object.defineProperty(V.prototype,"referenceEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._referenceEdge=t,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}}),Object.defineProperty(V.prototype,"incidentEdge",{enumerable:!1,configurable:!0,get:function(){return this._incidentEdge}}),Object.defineProperty(V.prototype,"incidentEdge",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentEdge=t,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}}),Object.defineProperty(V.prototype,"incidentVertex",{enumerable:!1,configurable:!0,get:function(){return this._incidentVertex}}),Object.defineProperty(V.prototype,"incidentVertex",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._incidentVertex=t,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}}),Object.defineProperty(V.prototype,"flip",{enumerable:!1,configurable:!0,get:function(){return this._flip}}),Object.defineProperty(V.prototype,"flip",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._flip=t,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}})}(),function(){var t=(Box2D.Common.b2Color,Box2D.Common.b2internal,Box2D.Common.b2Settings),e=Box2D.Collision.Shapes.b2CircleShape,i=Box2D.Collision.Shapes.b2EdgeChainDef,o=Box2D.Collision.Shapes.b2EdgeShape,n=Box2D.Collision.Shapes.b2MassData,r=Box2D.Collision.Shapes.b2PolygonShape,s=Box2D.Collision.Shapes.b2Shape,a=Box2D.Common.Math.b2Mat22,h=(Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math),l=(Box2D.Common.Math.b2Sweep,Box2D.Common.Math.b2Transform),c=Box2D.Common.Math.b2Vec2,u=(Box2D.Common.Math.b2Vec3,Box2D.Dynamics.b2Body,Box2D.Dynamics.b2BodyDef,Box2D.Dynamics.b2ContactFilter,Box2D.Dynamics.b2ContactImpulse,Box2D.Dynamics.b2ContactListener,Box2D.Dynamics.b2ContactManager,Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.b2DestructionListener,Box2D.Dynamics.b2FilterData,Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2FixtureDef,Box2D.Dynamics.b2Island,Box2D.Dynamics.b2TimeStep,Box2D.Dynamics.b2World,Box2D.Collision.b2AABB,Box2D.Collision.b2Bound,Box2D.Collision.b2BoundValues,Box2D.Collision.b2Collision,Box2D.Collision.b2ContactID,Box2D.Collision.b2ContactPoint,Box2D.Collision.b2Distance),m=Box2D.Collision.b2DistanceInput,d=Box2D.Collision.b2DistanceOutput,p=Box2D.Collision.b2DistanceProxy,_=(Box2D.Collision.b2DynamicTree,Box2D.Collision.b2DynamicTreeBroadPhase,Box2D.Collision.b2DynamicTreeNode,Box2D.Collision.b2DynamicTreePair,Box2D.Collision.b2Manifold,Box2D.Collision.b2ManifoldPoint,Box2D.Collision.b2Point,Box2D.Collision.b2RayCastInput,Box2D.Collision.b2RayCastOutput,Box2D.Collision.b2Segment,Box2D.Collision.b2SeparationFunction,Box2D.Collision.b2Simplex,Box2D.Collision.b2SimplexCache);Box2D.Collision.b2SimplexVertex,Box2D.Collision.b2TimeOfImpact,Box2D.Collision.b2TOIInput,Box2D.Collision.b2WorldManifold,Box2D.Collision.ClipVertex,Box2D.Collision.Features,Box2D.Collision.IBroadPhase;Box2D.inherit(e,Box2D.Collision.Shapes.b2Shape),e.prototype.__super=Box2D.Collision.Shapes.b2Shape.prototype,e.b2CircleShape=function(){Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.m_p=new c},e.prototype.Copy=function(){var t=new e;return t.Set(this),t},e.prototype.Set=function(t){if(this.__super.Set.call(this,t),Box2D.is(t,e)){var i=t instanceof e?t:null;this.m_p.SetV(i.m_p)}},e.prototype.TestPoint=function(t,e){var i=t.R,o=t.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),n=t.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);return o=e.x-o,n=e.y-n,o*o+n*n<=this.m_radius*this.m_radius},e.prototype.RayCast=function(t,e,i){var o=i.R,n=i.position.x+(o.col1.x*this.m_p.x+o.col2.x*this.m_p.y),r=i.position.y+(o.col1.y*this.m_p.x+o.col2.y*this.m_p.y),s=e.p1.x-n,a=e.p1.y-r,h=s*s+a*a-this.m_radius*this.m_radius,l=e.p2.x-e.p1.x,c=e.p2.y-e.p1.y,u=s*l+a*c,m=l*l+c*c,d=u*u-m*h;if(d<0||m<Number.MIN_VALUE)return!1;var p=-(u+Math.sqrt(d));return 0<=p&&p<=e.maxFraction*m&&(p/=m,t.fraction=p,t.normal.x=s+p*l,t.normal.y=a+p*c,t.normal.Normalize(),!0)},e.prototype.ComputeAABB=function(t,e){var i=e.R,o=e.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),n=e.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y);t.lowerBound.Set(o-this.m_radius,n-this.m_radius),t.upperBound.Set(o+this.m_radius,n+this.m_radius)},e.prototype.ComputeMass=function(e,i){void 0===i&&(i=0),e.mass=i*t.b2_pi*this.m_radius*this.m_radius,e.center.SetV(this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},e.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var n=h.MulX(i,this.m_p),r=-(h.Dot(t,n)-e);if(r<-this.m_radius+Number.MIN_VALUE)return 0;if(r>this.m_radius)return o.SetV(n),Math.PI*this.m_radius*this.m_radius;var s=this.m_radius*this.m_radius,a=r*r,l=s*(Math.asin(r/this.m_radius)+Math.PI/2)+r*Math.sqrt(s-a),c=-2/3*Math.pow(s-a,1.5)/l;return o.x=n.x+t.x*c,o.y=n.y+t.y*c,l},e.prototype.GetLocalPosition=function(){return this.m_p},e.prototype.SetLocalPosition=function(t){this.m_p.SetV(t)},e.prototype.GetRadius=function(){return this.m_radius},e.prototype.SetRadius=function(t){void 0===t&&(t=0),this.m_radius=t},e.prototype.b2CircleShape=function(t){void 0===t&&(t=0),this.__super.b2Shape.call(this),this.m_type=s.e_circleShape,this.m_radius=t},i.b2EdgeChainDef=function(){},i.prototype.b2EdgeChainDef=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},Box2D.inherit(o,Box2D.Collision.Shapes.b2Shape),o.prototype.__super=Box2D.Collision.Shapes.b2Shape.prototype,o.b2EdgeShape=function(){Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments),this.s_supportVec=new c,this.m_v1=new c,this.m_v2=new c,this.m_coreV1=new c,this.m_coreV2=new c,this.m_normal=new c,this.m_direction=new c,this.m_cornerDir1=new c,this.m_cornerDir2=new c},o.prototype.TestPoint=function(t,e){return!1},o.prototype.RayCast=function(t,e,i){var o,n=e.p2.x-e.p1.x,r=e.p2.y-e.p1.y;o=i.R;var s=i.position.x+(o.col1.x*this.m_v1.x+o.col2.x*this.m_v1.y),a=i.position.y+(o.col1.y*this.m_v1.x+o.col2.y*this.m_v1.y),h=i.position.y+(o.col1.y*this.m_v2.x+o.col2.y*this.m_v2.y)-a,l=-(i.position.x+(o.col1.x*this.m_v2.x+o.col2.x*this.m_v2.y)-s),c=100*Number.MIN_VALUE,u=-(n*h+r*l);if(u>c){var m=e.p1.x-s,d=e.p1.y-a,p=m*h+d*l;if(0<=p&&p<=e.maxFraction*u){var _=-n*d+r*m;if(-c*u<=_&&_<=u*(1+c)){p/=u,t.fraction=p;var f=Math.sqrt(h*h+l*l);return t.normal.x=h/f,t.normal.y=l/f,!0}}}return!1},o.prototype.ComputeAABB=function(t,e){var i=e.R,o=e.position.x+(i.col1.x*this.m_v1.x+i.col2.x*this.m_v1.y),n=e.position.y+(i.col1.y*this.m_v1.x+i.col2.y*this.m_v1.y),r=e.position.x+(i.col1.x*this.m_v2.x+i.col2.x*this.m_v2.y),s=e.position.y+(i.col1.y*this.m_v2.x+i.col2.y*this.m_v2.y);o<r?(t.lowerBound.x=o,t.upperBound.x=r):(t.lowerBound.x=r,t.upperBound.x=o),n<s?(t.lowerBound.y=n,t.upperBound.y=s):(t.lowerBound.y=s,t.upperBound.y=n)},o.prototype.ComputeMass=function(t,e){void 0===e&&(e=0),t.mass=0,t.center.SetV(this.m_v1),t.I=0},o.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var n=new c(t.x*e,t.y*e),r=h.MulX(i,this.m_v1),s=h.MulX(i,this.m_v2),a=h.Dot(t,r)-e,l=h.Dot(t,s)-e;if(a>0){if(l>0)return 0;r.x=-l/(a-l)*r.x+a/(a-l)*s.x,r.y=-l/(a-l)*r.y+a/(a-l)*s.y}else l>0&&(s.x=-l/(a-l)*r.x+a/(a-l)*s.x,s.y=-l/(a-l)*r.y+a/(a-l)*s.y);return o.x=(n.x+r.x+s.x)/3,o.y=(n.y+r.y+s.y)/3,.5*((r.x-n.x)*(s.y-n.y)-(r.y-n.y)*(s.x-n.x))},o.prototype.GetLength=function(){return this.m_length},o.prototype.GetVertex1=function(){return this.m_v1},o.prototype.GetVertex2=function(){return this.m_v2},o.prototype.GetCoreVertex1=function(){return this.m_coreV1},o.prototype.GetCoreVertex2=function(){return this.m_coreV2},o.prototype.GetNormalVector=function(){return this.m_normal},o.prototype.GetDirectionVector=function(){return this.m_direction},o.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},o.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},o.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},o.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},o.prototype.GetFirstVertex=function(t){var e=t.R;return new c(t.position.x+(e.col1.x*this.m_coreV1.x+e.col2.x*this.m_coreV1.y),t.position.y+(e.col1.y*this.m_coreV1.x+e.col2.y*this.m_coreV1.y))},o.prototype.GetNextEdge=function(){return this.m_nextEdge},o.prototype.GetPrevEdge=function(){return this.m_prevEdge},o.prototype.Support=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=t.R,n=t.position.x+(o.col1.x*this.m_coreV1.x+o.col2.x*this.m_coreV1.y),r=t.position.y+(o.col1.y*this.m_coreV1.x+o.col2.y*this.m_coreV1.y),s=t.position.x+(o.col1.x*this.m_coreV2.x+o.col2.x*this.m_coreV2.y),a=t.position.y+(o.col1.y*this.m_coreV2.x+o.col2.y*this.m_coreV2.y);return n*e+r*i>s*e+a*i?(this.s_supportVec.x=n,this.s_supportVec.y=r):(this.s_supportVec.x=s,this.s_supportVec.y=a),this.s_supportVec},o.prototype.b2EdgeShape=function(e,i){this.__super.b2Shape.call(this),this.m_type=s.e_edgeShape,this.m_prevEdge=null,this.m_nextEdge=null,this.m_v1=e,this.m_v2=i,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-t.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-t.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-t.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-t.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},o.prototype.SetPrevEdge=function(t,e,i,o){this.m_prevEdge=t,this.m_coreV1=e,this.m_cornerDir1=i,this.m_cornerConvex1=o},o.prototype.SetNextEdge=function(t,e,i,o){this.m_nextEdge=t,this.m_coreV2=e,this.m_cornerDir2=i,this.m_cornerConvex2=o},n.b2MassData=function(){this.mass=0,this.center=new c(0,0),this.I=0},Box2D.inherit(r,Box2D.Collision.Shapes.b2Shape),r.prototype.__super=Box2D.Collision.Shapes.b2Shape.prototype,r.b2PolygonShape=function(){Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this,arguments)},r.prototype.Copy=function(){var t=new r;return t.Set(this),t},r.prototype.Set=function(t){if(this.__super.Set.call(this,t),Box2D.is(t,r)){var e=t instanceof r?t:null;this.m_centroid.SetV(e.m_centroid),this.m_vertexCount=e.m_vertexCount,this.Reserve(this.m_vertexCount);for(var i=0;i<this.m_vertexCount;i++)this.m_vertices[i].SetV(e.m_vertices[i]),this.m_normals[i].SetV(e.m_normals[i])}},r.prototype.SetAsArray=function(t,e){void 0===e&&(e=0);var i,o=new Vector,n=0;for(n=0;n<t.length;++n)i=t[n],o.push(i);this.SetAsVector(o,e)},r.AsArray=function(t,e){void 0===e&&(e=0);var i=new r;return i.SetAsArray(t,e),i},r.prototype.SetAsVector=function(e,i){void 0===i&&(i=0),0==i&&(i=e.length),t.b2Assert(2<=i),this.m_vertexCount=i,this.Reserve(i);var o=0;for(o=0;o<this.m_vertexCount;o++)this.m_vertices[o].SetV(e[o]);for(o=0;o<this.m_vertexCount;++o){var n=parseInt(o),s=parseInt(o+1<this.m_vertexCount?o+1:0),a=h.SubtractVV(this.m_vertices[s],this.m_vertices[n]);t.b2Assert(a.LengthSquared()>Number.MIN_VALUE),this.m_normals[o].SetV(h.CrossVF(a,1)),this.m_normals[o].Normalize()}this.m_centroid=r.ComputeCentroid(this.m_vertices,this.m_vertexCount)},r.AsVector=function(t,e){void 0===e&&(e=0);var i=new r;return i.SetAsVector(t,e),i},r.prototype.SetAsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},r.AsBox=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=new r;return i.SetAsBox(t,e),i},r.prototype.SetAsOrientedBox=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===o&&(o=0),this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=i;var n=new l;n.position=i,n.R.Set(o);for(var r=0;r<this.m_vertexCount;++r)this.m_vertices[r]=h.MulX(n,this.m_vertices[r]),this.m_normals[r]=h.MulMV(n.R,this.m_normals[r])},r.AsOrientedBox=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===o&&(o=0);var n=new r;return n.SetAsOrientedBox(t,e,i,o),n},r.prototype.SetAsEdge=function(t,e){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(t),this.m_vertices[1].SetV(e),this.m_centroid.x=.5*(t.x+e.x),this.m_centroid.y=.5*(t.y+e.y),this.m_normals[0]=h.CrossVF(h.SubtractVV(e,t),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},r.AsEdge=function(t,e){var i=new r;return i.SetAsEdge(t,e),i},r.prototype.TestPoint=function(t,e){for(var i,o=t.R,n=e.x-t.position.x,r=e.y-t.position.y,s=n*o.col1.x+r*o.col1.y,a=n*o.col2.x+r*o.col2.y,h=0;h<this.m_vertexCount;++h){i=this.m_vertices[h],n=s-i.x,r=a-i.y,i=this.m_normals[h];if(i.x*n+i.y*r>0)return!1}return!0},r.prototype.RayCast=function(t,e,i){var o,n,r=0,s=e.maxFraction,a=0,h=0;a=e.p1.x-i.position.x,h=e.p1.y-i.position.y,o=i.R;var l=a*o.col1.x+h*o.col1.y,c=a*o.col2.x+h*o.col2.y;a=e.p2.x-i.position.x,h=e.p2.y-i.position.y,o=i.R;for(var u=a*o.col1.x+h*o.col1.y,m=a*o.col2.x+h*o.col2.y,d=u-l,p=m-c,_=parseInt(-1),f=0;f<this.m_vertexCount;++f){n=this.m_vertices[f],a=n.x-l,h=n.y-c,n=this.m_normals[f];var y=n.x*a+n.y*h,g=n.x*d+n.y*p;if(0==g){if(y<0)return!1}else g<0&&y<r*g?(r=y/g,_=f):g>0&&y<s*g&&(s=y/g);if(s<r-Number.MIN_VALUE)return!1}return _>=0&&(t.fraction=r,o=i.R,n=this.m_normals[_],t.normal.x=o.col1.x*n.x+o.col2.x*n.y,t.normal.y=o.col1.y*n.x+o.col2.y*n.y,!0)},r.prototype.ComputeAABB=function(t,e){for(var i=e.R,o=this.m_vertices[0],n=e.position.x+(i.col1.x*o.x+i.col2.x*o.y),r=e.position.y+(i.col1.y*o.x+i.col2.y*o.y),s=n,a=r,h=1;h<this.m_vertexCount;++h){o=this.m_vertices[h];var l=e.position.x+(i.col1.x*o.x+i.col2.x*o.y),c=e.position.y+(i.col1.y*o.x+i.col2.y*o.y);n=n<l?n:l,r=r<c?r:c,s=s>l?s:l,a=a>c?a:c}t.lowerBound.x=n-this.m_radius,t.lowerBound.y=r-this.m_radius,t.upperBound.x=s+this.m_radius,t.upperBound.y=a+this.m_radius},r.prototype.ComputeMass=function(t,e){if(void 0===e&&(e=0),2==this.m_vertexCount)return t.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),t.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),t.mass=0,void(t.I=0);for(var i=0,o=0,n=0,r=0,s=0;s<this.m_vertexCount;++s){var a=this.m_vertices[s],h=s+1<this.m_vertexCount?this.m_vertices[parseInt(s+1)]:this.m_vertices[0],l=a.x-0,c=a.y-0,u=h.x-0,m=h.y-0,d=l*m-c*u,p=.5*d;n+=p,i+=p*(1/3)*(0+a.x+h.x),o+=p*(1/3)*(0+a.y+h.y);var _=l,f=c,y=u,g=m;r+=d*(1/3*(.25*(_*_+y*_+y*y)+(0*_+0*y))+0+(1/3*(.25*(f*f+g*f+g*g)+(0*f+0*g))+0))}t.mass=e*n,i*=1/n,o*=1/n,t.center.Set(i,o),t.I=e*r},r.prototype.ComputeSubmergedArea=function(t,e,i,o){void 0===e&&(e=0);var r=h.MulTMV(i.R,t),s=e-h.Dot(t,i.position),a=new Vector_a2j_Number,l=0,u=parseInt(-1),m=parseInt(-1),d=!1,p=0;for(p=0;p<this.m_vertexCount;++p){a[p]=h.Dot(r,this.m_vertices[p])-s;var _=a[p]<-Number.MIN_VALUE;p>0&&(_?d||(u=p-1,l++):d&&(m=p-1,l++)),d=_}switch(l){case 0:if(d){var f=new n;return this.ComputeMass(f,1),o.SetV(h.MulX(i,f.center)),f.mass}return 0;case 1:-1==u?u=this.m_vertexCount-1:m=this.m_vertexCount-1}var y,g=parseInt((u+1)%this.m_vertexCount),v=parseInt((m+1)%this.m_vertexCount),x=(0-a[u])/(a[g]-a[u]),b=(0-a[m])/(a[v]-a[m]),E=new c(this.m_vertices[u].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[u].y*(1-x)+this.m_vertices[g].y*x),T=new c(this.m_vertices[m].x*(1-b)+this.m_vertices[v].x*b,this.m_vertices[m].y*(1-b)+this.m_vertices[v].y*b),w=0,S=new c,C=this.m_vertices[g];for(p=g;p!=v;){p=(p+1)%this.m_vertexCount,y=p==v?T:this.m_vertices[p];var R=.5*((C.x-E.x)*(y.y-E.y)-(C.y-E.y)*(y.x-E.x));w+=R,S.x+=R*(E.x+C.x+y.x)/3,S.y+=R*(E.y+C.y+y.y)/3,C=y}return S.Multiply(1/w),o.SetV(h.MulX(i,S)),w},r.prototype.GetVertexCount=function(){return this.m_vertexCount},r.prototype.GetVertices=function(){return this.m_vertices},r.prototype.GetNormals=function(){return this.m_normals},r.prototype.GetSupport=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_vertexCount;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return e},r.prototype.GetSupportVertex=function(t){for(var e=0,i=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,o=1;o<this.m_vertexCount;++o){var n=this.m_vertices[o].x*t.x+this.m_vertices[o].y*t.y;n>i&&(e=o,i=n)}return this.m_vertices[e]},r.prototype.Validate=function(){return!1},r.prototype.b2PolygonShape=function(){this.__super.b2Shape.call(this),this.m_type=s.e_polygonShape,this.m_centroid=new c,this.m_vertices=new Vector,this.m_normals=new Vector},r.prototype.Reserve=function(t){void 0===t&&(t=0);for(var e=parseInt(this.m_vertices.length);e<t;e++)this.m_vertices[e]=new c,this.m_normals[e]=new c},r.ComputeCentroid=function(t,e){void 0===e&&(e=0);for(var i=new c,o=0,n=0;n<e;++n){var r=t[n],s=n+1<e?t[parseInt(n+1)]:t[0],a=r.x-0,h=r.y-0,l=s.x-0,u=s.y-0,m=a*u-h*l,d=.5*m;o+=d,i.x+=d*(1/3)*(0+r.x+s.x),i.y+=d*(1/3)*(0+r.y+s.y)}return i.x*=1/o,i.y*=1/o,i},r.ComputeOBB=function(t,e,i){void 0===i&&(i=0);var o=0,n=new Vector(i+1);for(o=0;o<i;++o)n[o]=e[o];n[i]=n[0];var r=Number.MAX_VALUE;for(o=1;o<=i;++o){var s=n[parseInt(o-1)],a=n[o].x-s.x,h=n[o].y-s.y,l=Math.sqrt(a*a+h*h);a/=l,h/=l;for(var c=-h,u=a,m=Number.MAX_VALUE,d=Number.MAX_VALUE,p=-Number.MAX_VALUE,_=-Number.MAX_VALUE,f=0;f<i;++f){var y=n[f].x-s.x,g=n[f].y-s.y,v=a*y+h*g,x=c*y+u*g;v<m&&(m=v),x<d&&(d=x),v>p&&(p=v),x>_&&(_=x)}var b=(p-m)*(_-d);if(b<.95*r){r=b,t.R.col1.x=a,t.R.col1.y=h,t.R.col2.x=c,t.R.col2.y=u;var E=.5*(m+p),T=.5*(d+_),w=t.R;t.center.x=s.x+(w.col1.x*E+w.col2.x*T),t.center.y=s.y+(w.col1.y*E+w.col2.y*T),t.extents.x=.5*(p-m),t.extents.y=.5*(_-d)}}},Box2D.postDefs.push(function(){Box2D.Collision.Shapes.b2PolygonShape.s_mat=new a}),s.b2Shape=function(){},s.prototype.Copy=function(){return null},s.prototype.Set=function(t){this.m_radius=t.m_radius},s.prototype.GetType=function(){return this.m_type},s.prototype.TestPoint=function(t,e){return!1},s.prototype.RayCast=function(t,e,i){return!1},s.prototype.ComputeAABB=function(t,e){},s.prototype.ComputeMass=function(t,e){void 0===e&&(e=0)},s.prototype.ComputeSubmergedArea=function(t,e,i,o){return void 0===e&&(e=0),0},s.TestOverlap=function(t,e,i,o){var n=new m;n.proxyA=new p,n.proxyA.Set(t),n.proxyB=new p,n.proxyB.Set(i),n.transformA=e,n.transformB=o,n.useRadii=!0;var r=new _;r.count=0;var s=new d;return u.Distance(s,r,n),s.distance<10*Number.MIN_VALUE},s.prototype.b2Shape=function(){this.m_type=s.e_unknownShape,this.m_radius=t.b2_linearSlop},Box2D.postDefs.push(function(){Box2D.Collision.Shapes.b2Shape.e_unknownShape=parseInt(-1),Box2D.Collision.Shapes.b2Shape.e_circleShape=0,Box2D.Collision.Shapes.b2Shape.e_polygonShape=1,Box2D.Collision.Shapes.b2Shape.e_edgeShape=2,Box2D.Collision.Shapes.b2Shape.e_shapeTypeCount=3,Box2D.Collision.Shapes.b2Shape.e_hitCollide=1,Box2D.Collision.Shapes.b2Shape.e_missCollide=0,Box2D.Collision.Shapes.b2Shape.e_startsInsideCollide=parseInt(-1)})}(),function(){var t=Box2D.Common.b2Color,e=(Box2D.Common.b2internal,Box2D.Common.b2Settings),i=(Box2D.Common.Math.b2Mat22,Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math);Box2D.Common.Math.b2Sweep,Box2D.Common.Math.b2Transform,Box2D.Common.Math.b2Vec2,Box2D.Common.Math.b2Vec3;t.b2Color=function(){this._r=0,this._g=0,this._b=0},t.prototype.b2Color=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===o&&(o=0),this._r=Box2D.parseUInt(255*i.Clamp(t,0,1)),this._g=Box2D.parseUInt(255*i.Clamp(e,0,1)),this._b=Box2D.parseUInt(255*i.Clamp(o,0,1))},t.prototype.Set=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===o&&(o=0),this._r=Box2D.parseUInt(255*i.Clamp(t,0,1)),this._g=Box2D.parseUInt(255*i.Clamp(e,0,1)),this._b=Box2D.parseUInt(255*i.Clamp(o,0,1))},Object.defineProperty(t.prototype,"r",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._r=Box2D.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"g",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._g=Box2D.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"b",{enumerable:!1,configurable:!0,set:function(t){void 0===t&&(t=0),this._b=Box2D.parseUInt(255*i.Clamp(t,0,1))}}),Object.defineProperty(t.prototype,"color",{enumerable:!1,configurable:!0,get:function(){return this._r<<16|this._g<<8|this._b}}),e.b2Settings=function(){},e.b2MixFriction=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),Math.sqrt(t*e)},e.b2MixRestitution=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},e.b2Assert=function(t){if(!t)throw"Assertion Failed"},Box2D.postDefs.push(function(){Box2D.Common.b2Settings.VERSION="2.1alpha",Box2D.Common.b2Settings.USHRT_MAX=65535,Box2D.Common.b2Settings.b2_pi=Math.PI,Box2D.Common.b2Settings.b2_maxManifoldPoints=2,Box2D.Common.b2Settings.b2_aabbExtension=.1,Box2D.Common.b2Settings.b2_aabbMultiplier=2,Box2D.Common.b2Settings.b2_polygonRadius=2*e.b2_linearSlop,Box2D.Common.b2Settings.b2_linearSlop=.005,Box2D.Common.b2Settings.b2_angularSlop=2/180*e.b2_pi,Box2D.Common.b2Settings.b2_toiSlop=8*e.b2_linearSlop,Box2D.Common.b2Settings.b2_maxTOIContactsPerIsland=32,Box2D.Common.b2Settings.b2_maxTOIJointsPerIsland=32,Box2D.Common.b2Settings.b2_velocityThreshold=1,Box2D.Common.b2Settings.b2_maxLinearCorrection=.2,Box2D.Common.b2Settings.b2_maxAngularCorrection=8/180*e.b2_pi,Box2D.Common.b2Settings.b2_maxTranslation=2,Box2D.Common.b2Settings.b2_maxTranslationSquared=e.b2_maxTranslation*e.b2_maxTranslation,Box2D.Common.b2Settings.b2_maxRotation=.5*e.b2_pi,Box2D.Common.b2Settings.b2_maxRotationSquared=e.b2_maxRotation*e.b2_maxRotation,Box2D.Common.b2Settings.b2_contactBaumgarte=.2,Box2D.Common.b2Settings.b2_timeToSleep=.5,Box2D.Common.b2Settings.b2_linearSleepTolerance=.01,Box2D.Common.b2Settings.b2_angularSleepTolerance=2/180*e.b2_pi})}(),function(){var t=(Box2D.Collision.b2AABB,Box2D.Common.b2Color,Box2D.Common.b2internal,Box2D.Common.b2Settings,Box2D.Common.Math.b2Mat22),e=Box2D.Common.Math.b2Mat33,i=Box2D.Common.Math.b2Math,o=Box2D.Common.Math.b2Sweep,n=Box2D.Common.Math.b2Transform,r=Box2D.Common.Math.b2Vec2,s=Box2D.Common.Math.b2Vec3;t.b2Mat22=function(){this.col1=new r,this.col2=new r},t.prototype.b2Mat22=function(){this.SetIdentity()},t.FromAngle=function(e){void 0===e&&(e=0);var i=new t;return i.Set(e),i},t.FromVV=function(e,i){var o=new t;return o.SetVV(e,i),o},t.prototype.Set=function(t){void 0===t&&(t=0);var e=Math.cos(t),i=Math.sin(t);this.col1.x=e,this.col2.x=-i,this.col1.y=i,this.col2.y=e},t.prototype.SetVV=function(t,e){this.col1.SetV(t),this.col2.SetV(e)},t.prototype.Copy=function(){var e=new t;return e.SetM(this),e},t.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2)},t.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y},t.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},t.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},t.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},t.prototype.GetInverse=function(t){var e=this.col1.x,i=this.col2.x,o=this.col1.y,n=this.col2.y,r=e*n-i*o;return 0!=r&&(r=1/r),t.col1.x=r*n,t.col2.x=-r*i,t.col1.y=-r*o,t.col2.y=r*e,t},t.prototype.Solve=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=this.col1.x,n=this.col2.x,r=this.col1.y,s=this.col2.y,a=o*s-n*r;return 0!=a&&(a=1/a),t.x=a*(s*e-n*i),t.y=a*(o*i-r*e),t},t.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},e.b2Mat33=function(){this.col1=new s,this.col2=new s,this.col3=new s},e.prototype.b2Mat33=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),t||e||i?(this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},e.prototype.SetVVV=function(t,e,i){this.col1.SetV(t),this.col2.SetV(e),this.col3.SetV(i)},e.prototype.Copy=function(){return new e(this.col1,this.col2,this.col3)},e.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2),this.col3.SetV(t.col3)},e.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col1.z+=t.col1.z,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y,this.col2.z+=t.col2.z,this.col3.x+=t.col3.x,this.col3.y+=t.col3.y,this.col3.z+=t.col3.z},e.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,
this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},e.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},e.prototype.Solve22=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=this.col1.x,n=this.col2.x,r=this.col1.y,s=this.col2.y,a=o*s-n*r;return 0!=a&&(a=1/a),t.x=a*(s*e-n*i),t.y=a*(o*i-r*e),t},e.prototype.Solve33=function(t,e,i,o){void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0);var n=this.col1.x,r=this.col1.y,s=this.col1.z,a=this.col2.x,h=this.col2.y,l=this.col2.z,c=this.col3.x,u=this.col3.y,m=this.col3.z,d=n*(h*m-l*u)+r*(l*c-a*m)+s*(a*u-h*c);return 0!=d&&(d=1/d),t.x=d*(e*(h*m-l*u)+i*(l*c-a*m)+o*(a*u-h*c)),t.y=d*(n*(i*m-o*u)+r*(o*c-e*m)+s*(e*u-i*c)),t.z=d*(n*(h*o-l*i)+r*(l*e-a*o)+s*(a*i-h*e)),t},i.b2Math=function(){},i.IsValid=function(t){return void 0===t&&(t=0),isFinite(t)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y},i.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},i.CrossVF=function(t,e){return void 0===e&&(e=0),new r(e*t.y,-e*t.x)},i.CrossFV=function(t,e){return void 0===t&&(t=0),new r(-t*e.y,t*e.x)},i.MulMV=function(t,e){return new r(t.col1.x*e.x+t.col2.x*e.y,t.col1.y*e.x+t.col2.y*e.y)},i.MulTMV=function(t,e){return new r(i.Dot(e,t.col1),i.Dot(e,t.col2))},i.MulX=function(t,e){var o=i.MulMV(t.R,e);return o.x+=t.position.x,o.y+=t.position.y,o},i.MulXT=function(t,e){var o=i.SubtractVV(e,t.position),n=o.x*t.R.col1.x+o.y*t.R.col1.y;return o.y=o.x*t.R.col2.x+o.y*t.R.col2.y,o.x=n,o},i.AddVV=function(t,e){return new r(t.x+e.x,t.y+e.y)},i.SubtractVV=function(t,e){return new r(t.x-e.x,t.y-e.y)},i.Distance=function(t,e){var i=t.x-e.x,o=t.y-e.y;return Math.sqrt(i*i+o*o)},i.DistanceSquared=function(t,e){var i=t.x-e.x,o=t.y-e.y;return i*i+o*o},i.MulFV=function(t,e){return void 0===t&&(t=0),new r(t*e.x,t*e.y)},i.AddMM=function(e,o){return t.FromVV(i.AddVV(e.col1,o.col1),i.AddVV(e.col2,o.col2))},i.MulMM=function(e,o){return t.FromVV(i.MulMV(e,o.col1),i.MulMV(e,o.col2))},i.MulTMM=function(e,o){var n=new r(i.Dot(e.col1,o.col1),i.Dot(e.col2,o.col1)),s=new r(i.Dot(e.col1,o.col2),i.Dot(e.col2,o.col2));return t.FromVV(n,s)},i.Abs=function(t){return void 0===t&&(t=0),t>0?t:-t},i.AbsV=function(t){return new r(i.Abs(t.x),i.Abs(t.y))},i.AbsM=function(e){return t.FromVV(i.AbsV(e.col1),i.AbsV(e.col2))},i.Min=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t<e?t:e},i.MinV=function(t,e){return new r(i.Min(t.x,e.x),i.Min(t.y,e.y))},i.Max=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),t>e?t:e},i.MaxV=function(t,e){return new r(i.Max(t.x,e.x),i.Max(t.y,e.y))},i.Clamp=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),t<e?e:t>i?i:t},i.ClampV=function(t,e,o){return i.MaxV(e,i.MinV(t,o))},i.Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},i.Random=function(){return 2*Math.random()-1},i.RandomRange=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var i=Math.random();return i=(e-t)*i+t},i.NextPowerOfTwo=function(t){return void 0===t&&(t=0),t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1},i.IsPowerOfTwo=function(t){return void 0===t&&(t=0),t>0&&0==(t&t-1)},Box2D.postDefs.push(function(){Box2D.Common.Math.b2Math.b2Vec2_zero=new r(0,0),Box2D.Common.Math.b2Math.b2Mat22_identity=t.FromVV(new r(1,0),new r(0,1)),Box2D.Common.Math.b2Math.b2Transform_identity=new n(i.b2Vec2_zero,i.b2Mat22_identity)}),o.b2Sweep=function(){this.localCenter=new r,this.c0=new r,this.c=new r},o.prototype.Set=function(t){this.localCenter.SetV(t.localCenter),this.c0.SetV(t.c0),this.c.SetV(t.c),this.a0=t.a0,this.a=t.a,this.t0=t.t0},o.prototype.Copy=function(){var t=new o;return t.localCenter.SetV(this.localCenter),t.c0.SetV(this.c0),t.c.SetV(this.c),t.a0=this.a0,t.a=this.a,t.t0=this.t0,t},o.prototype.GetTransform=function(t,e){void 0===e&&(e=0),t.position.x=(1-e)*this.c0.x+e*this.c.x,t.position.y=(1-e)*this.c0.y+e*this.c.y;var i=(1-e)*this.a0+e*this.a;t.R.Set(i);var o=t.R;t.position.x-=o.col1.x*this.localCenter.x+o.col2.x*this.localCenter.y,t.position.y-=o.col1.y*this.localCenter.x+o.col2.y*this.localCenter.y},o.prototype.Advance=function(t){if(void 0===t&&(t=0),this.t0<t&&1-this.t0>Number.MIN_VALUE){var e=(t-this.t0)/(1-this.t0);this.c0.x=(1-e)*this.c0.x+e*this.c.x,this.c0.y=(1-e)*this.c0.y+e*this.c.y,this.a0=(1-e)*this.a0+e*this.a,this.t0=t}},n.b2Transform=function(){this.position=new r,this.R=new t},n.prototype.b2Transform=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),t&&(this.position.SetV(t),this.R.SetM(e))},n.prototype.Initialize=function(t,e){this.position.SetV(t),this.R.SetM(e)},n.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},n.prototype.Set=function(t){this.position.SetV(t.position),this.R.SetM(t.R)},n.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},r.b2Vec2=function(){},r.prototype.b2Vec2=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},r.prototype.SetZero=function(){this.x=0,this.y=0},r.prototype.Set=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e},r.prototype.SetV=function(t){this.x=t.x,this.y=t.y},r.prototype.GetNegative=function(){return new r(-this.x,-this.y)},r.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},r.Make=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new r(t,e)},r.prototype.Copy=function(){return new r(this.x,this.y)},r.prototype.Add=function(t){this.x+=t.x,this.y+=t.y},r.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y},r.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t},r.prototype.MulM=function(t){var e=this.x;this.x=t.col1.x*e+t.col2.x*this.y,this.y=t.col1.y*e+t.col2.y*this.y},r.prototype.MulTM=function(t){var e=i.Dot(this,t.col1);this.y=i.Dot(this,t.col2),this.x=e},r.prototype.CrossVF=function(t){void 0===t&&(t=0);var e=this.x;this.x=t*this.y,this.y=-t*e},r.prototype.CrossFV=function(t){void 0===t&&(t=0);var e=this.x;this.x=-t*this.y,this.y=t*e},r.prototype.MinV=function(t){this.x=this.x<t.x?this.x:t.x,this.y=this.y<t.y?this.y:t.y},r.prototype.MaxV=function(t){this.x=this.x>t.x?this.x:t.x,this.y=this.y>t.y?this.y:t.y},r.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},r.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},r.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},r.prototype.Normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<Number.MIN_VALUE)return 0;var e=1/t;return this.x*=e,this.y*=e,t},r.prototype.IsValid=function(){return i.IsValid(this.x)&&i.IsValid(this.y)},s.b2Vec3=function(){},s.prototype.b2Vec3=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},s.prototype.SetZero=function(){this.x=this.y=this.z=0},s.prototype.Set=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i},s.prototype.SetV=function(t){this.x=t.x,this.y=t.y,this.z=t.z},s.prototype.GetNegative=function(){return new s(-this.x,-this.y,-this.z)},s.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},s.prototype.Copy=function(){return new s(this.x,this.y,this.z)},s.prototype.Add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},s.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},s.prototype.Multiply=function(t){void 0===t&&(t=0),this.x*=t,this.y*=t,this.z*=t}}(),function(){var t=(Box2D.Dynamics.Controllers.b2ControllerEdge,Box2D.Common.Math.b2Mat22,Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math),e=Box2D.Common.Math.b2Sweep,i=Box2D.Common.Math.b2Transform,o=Box2D.Common.Math.b2Vec2,n=(Box2D.Common.Math.b2Vec3,Box2D.Common.b2Color),r=(Box2D.Common.b2internal,Box2D.Common.b2Settings),s=Box2D.Collision.b2AABB,a=(Box2D.Collision.b2Bound,Box2D.Collision.b2BoundValues,Box2D.Collision.b2Collision,Box2D.Collision.b2ContactID,Box2D.Collision.b2ContactPoint),h=(Box2D.Collision.b2Distance,Box2D.Collision.b2DistanceInput,Box2D.Collision.b2DistanceOutput,Box2D.Collision.b2DistanceProxy,Box2D.Collision.b2DynamicTree,Box2D.Collision.b2DynamicTreeBroadPhase),l=(Box2D.Collision.b2DynamicTreeNode,Box2D.Collision.b2DynamicTreePair,Box2D.Collision.b2Manifold,Box2D.Collision.b2ManifoldPoint,Box2D.Collision.b2Point,Box2D.Collision.b2RayCastInput),c=Box2D.Collision.b2RayCastOutput,u=(Box2D.Collision.b2Segment,Box2D.Collision.b2SeparationFunction,Box2D.Collision.b2Simplex,Box2D.Collision.b2SimplexCache,Box2D.Collision.b2SimplexVertex,Box2D.Collision.b2TimeOfImpact,Box2D.Collision.b2TOIInput,Box2D.Collision.b2WorldManifold,Box2D.Collision.ClipVertex,Box2D.Collision.Features,Box2D.Collision.IBroadPhase,Box2D.Collision.Shapes.b2CircleShape),m=(Box2D.Collision.Shapes.b2EdgeChainDef,Box2D.Collision.Shapes.b2EdgeShape),d=Box2D.Collision.Shapes.b2MassData,p=Box2D.Collision.Shapes.b2PolygonShape,_=Box2D.Collision.Shapes.b2Shape,f=Box2D.Dynamics.b2Body,y=Box2D.Dynamics.b2BodyDef,g=Box2D.Dynamics.b2ContactFilter,v=Box2D.Dynamics.b2ContactImpulse,x=Box2D.Dynamics.b2ContactListener,b=Box2D.Dynamics.b2ContactManager,E=Box2D.Dynamics.b2DebugDraw,T=Box2D.Dynamics.b2DestructionListener,w=Box2D.Dynamics.b2FilterData,S=Box2D.Dynamics.b2Fixture,C=Box2D.Dynamics.b2FixtureDef,R=Box2D.Dynamics.b2Island,M=Box2D.Dynamics.b2TimeStep,D=Box2D.Dynamics.b2World,A=(Box2D.Dynamics.Contacts.b2CircleContact,Box2D.Dynamics.Contacts.b2Contact),B=(Box2D.Dynamics.Contacts.b2ContactConstraint,Box2D.Dynamics.Contacts.b2ContactConstraintPoint,Box2D.Dynamics.Contacts.b2ContactEdge,Box2D.Dynamics.Contacts.b2ContactFactory),I=(Box2D.Dynamics.Contacts.b2ContactRegister,Box2D.Dynamics.Contacts.b2ContactResult,Box2D.Dynamics.Contacts.b2ContactSolver),H=(Box2D.Dynamics.Contacts.b2EdgeAndCircleContact,Box2D.Dynamics.Contacts.b2NullContact,Box2D.Dynamics.Contacts.b2PolyAndCircleContact,Box2D.Dynamics.Contacts.b2PolyAndEdgeContact,Box2D.Dynamics.Contacts.b2PolygonContact,Box2D.Dynamics.Contacts.b2PositionSolverManifold,Box2D.Dynamics.Controllers.b2Controller,Box2D.Dynamics.Joints.b2DistanceJoint,Box2D.Dynamics.Joints.b2DistanceJointDef,Box2D.Dynamics.Joints.b2FrictionJoint,Box2D.Dynamics.Joints.b2FrictionJointDef,Box2D.Dynamics.Joints.b2GearJoint,Box2D.Dynamics.Joints.b2GearJointDef,Box2D.Dynamics.Joints.b2Jacobian,Box2D.Dynamics.Joints.b2Joint),P=(Box2D.Dynamics.Joints.b2JointDef,Box2D.Dynamics.Joints.b2JointEdge,Box2D.Dynamics.Joints.b2LineJoint,Box2D.Dynamics.Joints.b2LineJointDef,Box2D.Dynamics.Joints.b2MouseJoint,Box2D.Dynamics.Joints.b2MouseJointDef,Box2D.Dynamics.Joints.b2PrismaticJoint,Box2D.Dynamics.Joints.b2PrismaticJointDef,Box2D.Dynamics.Joints.b2PulleyJoint);Box2D.Dynamics.Joints.b2PulleyJointDef,Box2D.Dynamics.Joints.b2RevoluteJoint,Box2D.Dynamics.Joints.b2RevoluteJointDef,Box2D.Dynamics.Joints.b2WeldJoint,Box2D.Dynamics.Joints.b2WeldJointDef;f.b2Body=function(){this.m_xf=new i,this.m_sweep=new e,this.m_linearVelocity=new o,this.m_force=new o},f.prototype.connectEdges=function(e,i,o){void 0===o&&(o=0);var n=Math.atan2(i.GetDirectionVector().y,i.GetDirectionVector().x),s=Math.tan(.5*(n-o)),a=t.MulFV(s,i.GetDirectionVector());a=t.SubtractVV(a,i.GetNormalVector()),a=t.MulFV(r.b2_toiSlop,a),a=t.AddVV(a,i.GetVertex1());var h=t.AddVV(e.GetDirectionVector(),i.GetDirectionVector());h.Normalize();var l=t.Dot(e.GetDirectionVector(),i.GetNormalVector())>0;return e.SetNextEdge(i,a,h,l),i.SetPrevEdge(e,a,h,l),n},f.prototype.CreateFixture=function(t){if(1==this.m_world.IsLocked())return null;var e=new S;if(e.Create(this,this.m_xf,t),this.m_flags&f.e_activeFlag){var i=this.m_world.m_contactManager.m_broadPhase;e.CreateProxy(i,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_body=this,e.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=D.e_newFixture,e},f.prototype.CreateFixture2=function(t,e){void 0===e&&(e=0);var i=new C;return i.shape=t,i.density=e,this.CreateFixture(i)},f.prototype.DestroyFixture=function(t){if(1!=this.m_world.IsLocked()){for(var e=this.m_fixtureList,i=null;null!=e;){if(e==t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next,!0;break}i=e,e=e.m_next}for(var o=this.m_contactList;o;){var n=o.contact;o=o.next;var r=n.GetFixtureA(),s=n.GetFixtureB();t!=r&&t!=s||this.m_world.m_contactManager.Destroy(n)}if(this.m_flags&f.e_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxy(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},f.prototype.SetPositionAndAngle=function(t,e){void 0===e&&(e=0);var i;if(1!=this.m_world.IsLocked()){this.m_xf.R.Set(e),this.m_xf.position.SetV(t);var o=this.m_xf.R,n=this.m_sweep.localCenter;this.m_sweep.c.x=o.col1.x*n.x+o.col2.x*n.y,this.m_sweep.c.y=o.col1.y*n.x+o.col2.y*n.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=e;var r=this.m_world.m_contactManager.m_broadPhase;for(i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(r,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},f.prototype.SetTransform=function(t){this.SetPositionAndAngle(t.position,t.GetAngle())},f.prototype.GetTransform=function(){return this.m_xf},f.prototype.GetPosition=function(){return this.m_xf.position},f.prototype.SetPosition=function(t){this.SetPositionAndAngle(t,this.GetAngle())},f.prototype.GetAngle=function(){return this.m_sweep.a},f.prototype.SetAngle=function(t){void 0===t&&(t=0),this.SetPositionAndAngle(this.GetPosition(),t)},f.prototype.GetWorldCenter=function(){return this.m_sweep.c},f.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},f.prototype.SetLinearVelocity=function(t){this.m_type!=f.b2_staticBody&&this.m_linearVelocity.SetV(t)},f.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},f.prototype.SetAngularVelocity=function(t){void 0===t&&(t=0),this.m_type!=f.b2_staticBody&&(this.m_angularVelocity=t)},f.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},f.prototype.GetDefinition=function(){var t=new y;return t.type=this.GetType(),t.allowSleep=(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag,t.bullet=(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag,t.awake=(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.SetV(this.GetLinearVelocity()),t.position=this.GetPosition(),t.userData=this.GetUserData(),t},f.prototype.ApplyForce=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)},f.prototype.ApplyTorque=function(t){void 0===t&&(t=0),this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=t)},f.prototype.ApplyImpulse=function(t,e){this.m_type==f.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))},f.prototype.Split=function(e){for(var i,o=this.GetLinearVelocity().Copy(),n=this.GetAngularVelocity(),r=this.GetWorldCenter(),s=this,a=this.m_world.CreateBody(this.GetDefinition()),h=s.m_fixtureList;h;)if(e(h)){var l=h.m_next;i?i.m_next=l:s.m_fixtureList=l,s.m_fixtureCount--,h.m_next=a.m_fixtureList,a.m_fixtureList=h,a.m_fixtureCount++,h.m_body=a,h=l}else i=h,h=h.m_next;s.ResetMassData(),a.ResetMassData();var c=s.GetWorldCenter(),u=a.GetWorldCenter(),m=t.AddVV(o,t.CrossFV(n,t.SubtractVV(c,r))),d=t.AddVV(o,t.CrossFV(n,t.SubtractVV(u,r)));return s.SetLinearVelocity(m),a.SetLinearVelocity(d),s.SetAngularVelocity(n),a.SetAngularVelocity(n),s.SynchronizeFixtures(),a.SynchronizeFixtures(),a},f.prototype.Merge=function(t){var e;for(e=t.m_fixtureList;e;){var i=e.m_next;t.m_fixtureCount--,e.m_next=this.m_fixtureList,this.m_fixtureList=e,this.m_fixtureCount++,e.m_body=n,e=i}o.m_fixtureCount=0;var o=this,n=t;o.GetWorldCenter(),n.GetWorldCenter(),o.GetLinearVelocity().Copy(),n.GetLinearVelocity().Copy(),o.GetAngularVelocity(),n.GetAngularVelocity();o.ResetMassData(),this.SynchronizeFixtures()},f.prototype.GetMass=function(){return this.m_mass},f.prototype.GetInertia=function(){return this.m_I},f.prototype.GetMassData=function(t){t.mass=this.m_mass,t.I=this.m_I,t.center.SetV(this.m_sweep.localCenter)},f.prototype.SetMassData=function(e){if(r.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==f.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&0==(this.m_flags&f.e_fixedRotationFlag)&&(this.m_I=e.I-this.m_mass*(e.center.x*e.center.x+e.center.y*e.center.y),this.m_invI=1/this.m_I);var i=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e.center),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-i.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-i.x)}},f.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type!=f.b2_staticBody&&this.m_type!=f.b2_kinematicBody){for(var e=o.Make(0,0),i=this.m_fixtureList;i;i=i.m_next)if(0!=i.m_density){var n=i.GetMassData();this.m_mass+=n.mass,e.x+=n.center.x*n.mass,e.y+=n.center.y*n.mass,this.m_I+=n.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&0==(this.m_flags&f.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(e.x*e.x+e.y*e.y),this.m_I*=this.m_inertiaScale,r.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var s=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(e),this.m_sweep.c0.SetV(t.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-s.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-s.x)}},f.prototype.GetWorldPoint=function(t){var e=this.m_xf.R,i=new o(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,i},f.prototype.GetWorldVector=function(e){return t.MulMV(this.m_xf.R,e)},f.prototype.GetLocalPoint=function(e){return t.MulXT(this.m_xf,e)},f.prototype.GetLocalVector=function(e){return t.MulTMV(this.m_xf.R,e)},f.prototype.GetLinearVelocityFromWorldPoint=function(t){return new o(this.m_linearVelocity.x-this.m_angularVelocity*(t.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(t.x-this.m_sweep.c.x))},f.prototype.GetLinearVelocityFromLocalPoint=function(t){var e=this.m_xf.R,i=new o(e.col1.x*t.x+e.col2.x*t.y,e.col1.y*t.x+e.col2.y*t.y);return i.x+=this.m_xf.position.x,i.y+=this.m_xf.position.y,new o(this.m_linearVelocity.x-this.m_angularVelocity*(i.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(i.x-this.m_sweep.c.x))},f.prototype.GetLinearDamping=function(){return this.m_linearDamping},f.prototype.SetLinearDamping=function(t){void 0===t&&(t=0),this.m_linearDamping=t},f.prototype.GetAngularDamping=function(){return this.m_angularDamping},f.prototype.SetAngularDamping=function(t){void 0===t&&(t=0),this.m_angularDamping=t},f.prototype.SetType=function(t){if(void 0===t&&(t=0),this.m_type!=t){this.m_type=t,this.ResetMassData(),this.m_type==f.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var e=this.m_contactList;e;e=e.next)e.contact.FlagForFiltering()}},f.prototype.GetType=function(){return this.m_type},f.prototype.SetBullet=function(t){t?this.m_flags|=f.e_bulletFlag:this.m_flags&=~f.e_bulletFlag},f.prototype.IsBullet=function(){return(this.m_flags&f.e_bulletFlag)==f.e_bulletFlag},f.prototype.SetSleepingAllowed=function(t){t?this.m_flags|=f.e_allowSleepFlag:(this.m_flags&=~f.e_allowSleepFlag,this.SetAwake(!0))},f.prototype.SetAwake=function(t){t?(this.m_flags|=f.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~f.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},f.prototype.IsAwake=function(){return(this.m_flags&f.e_awakeFlag)==f.e_awakeFlag},f.prototype.SetFixedRotation=function(t){t?this.m_flags|=f.e_fixedRotationFlag:this.m_flags&=~f.e_fixedRotationFlag,this.ResetMassData()},f.prototype.IsFixedRotation=function(){return(this.m_flags&f.e_fixedRotationFlag)==f.e_fixedRotationFlag},f.prototype.SetActive=function(t){if(t!=this.IsActive()){var e,i;if(t)for(this.m_flags|=f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.CreateProxy(e,this.m_xf);else{for(this.m_flags&=~f.e_activeFlag,e=this.m_world.m_contactManager.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxy(e);for(var o=this.m_contactList;o;){var n=o;o=o.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null}}},f.prototype.IsActive=function(){return(this.m_flags&f.e_activeFlag)==f.e_activeFlag},f.prototype.IsSleepingAllowed=function(){return(this.m_flags&f.e_allowSleepFlag)==f.e_allowSleepFlag},f.prototype.GetFixtureList=function(){return this.m_fixtureList},f.prototype.GetJointList=function(){return this.m_jointList},f.prototype.GetControllerList=function(){return this.m_controllerList},f.prototype.GetContactList=function(){return this.m_contactList},f.prototype.GetNext=function(){return this.m_next},f.prototype.GetUserData=function(){return this.m_userData},f.prototype.SetUserData=function(t){this.m_userData=t},f.prototype.GetWorld=function(){return this.m_world},f.prototype.b2Body=function(t,e){this.m_flags=0,t.bullet&&(this.m_flags|=f.e_bulletFlag),t.fixedRotation&&(this.m_flags|=f.e_fixedRotationFlag),t.allowSleep&&(this.m_flags|=f.e_allowSleepFlag),t.awake&&(this.m_flags|=f.e_awakeFlag),t.active&&(this.m_flags|=f.e_activeFlag),this.m_world=e,this.m_xf.position.SetV(t.position),this.m_xf.R.Set(t.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=t.angle;var i=this.m_xf.R,o=this.m_sweep.localCenter;this.m_sweep.c.x=i.col1.x*o.x+i.col2.x*o.y,this.m_sweep.c.y=i.col1.y*o.x+i.col2.y*o.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_jointList=null,this.m_controllerList=null,this.m_contactList=null,this.m_controllerCount=0,this.m_prev=null,this.m_next=null,this.m_linearVelocity.SetV(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_force.Set(0,0),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,this.m_type==f.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_inertiaScale=t.inertiaScale,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0},f.prototype.SynchronizeFixtures=function(){var t=f.s_xf1;t.R.Set(this.m_sweep.a0);var e=t.R,i=this.m_sweep.localCenter;t.position.x=this.m_sweep.c0.x-(e.col1.x*i.x+e.col2.x*i.y),t.position.y=this.m_sweep.c0.y-(e.col1.y*i.x+e.col2.y*i.y);var o,n=this.m_world.m_contactManager.m_broadPhase;for(o=this.m_fixtureList;o;o=o.m_next)o.Synchronize(n,t,this.m_xf)},f.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var t=this.m_xf.R,e=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(t.col1.x*e.x+t.col2.x*e.y),this.m_xf.position.y=this.m_sweep.c.y-(t.col1.y*e.x+t.col2.y*e.y)},f.prototype.ShouldCollide=function(t){if(this.m_type!=f.b2_dynamicBody&&t.m_type!=f.b2_dynamicBody)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&0==e.joint.m_collideConnected)return!1;return!0},f.prototype.Advance=function(t){void 0===t&&(t=0),this.m_sweep.Advance(t),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},Box2D.postDefs.push(function(){Box2D.Dynamics.b2Body.s_xf1=new i,Box2D.Dynamics.b2Body.e_islandFlag=1,Box2D.Dynamics.b2Body.e_awakeFlag=2,Box2D.Dynamics.b2Body.e_allowSleepFlag=4,Box2D.Dynamics.b2Body.e_bulletFlag=8,Box2D.Dynamics.b2Body.e_fixedRotationFlag=16,Box2D.Dynamics.b2Body.e_activeFlag=32,Box2D.Dynamics.b2Body.b2_staticBody=0,Box2D.Dynamics.b2Body.b2_kinematicBody=1,Box2D.Dynamics.b2Body.b2_dynamicBody=2}),y.b2BodyDef=function(){this.position=new o,this.linearVelocity=new o},y.prototype.b2BodyDef=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.type=f.b2_staticBody,this.active=!0,this.inertiaScale=1},g.b2ContactFilter=function(){},g.prototype.ShouldCollide=function(t,e){var i=t.GetFilterData(),o=e.GetFilterData();return i.groupIndex==o.groupIndex&&0!=i.groupIndex?i.groupIndex>0:0!=(i.maskBits&o.categoryBits)&&0!=(i.categoryBits&o.maskBits)},g.prototype.RayCollide=function(t,e){return!t||this.ShouldCollide(t instanceof S?t:null,e)},Box2D.postDefs.push(function(){Box2D.Dynamics.b2ContactFilter.b2_defaultFilter=new g}),v.b2ContactImpulse=function(){this.normalImpulses=new Vector_a2j_Number(r.b2_maxManifoldPoints),this.tangentImpulses=new Vector_a2j_Number(r.b2_maxManifoldPoints)},x.b2ContactListener=function(){},x.prototype.BeginContact=function(t){},x.prototype.EndContact=function(t){},x.prototype.PreSolve=function(t,e){},x.prototype.PostSolve=function(t,e){},Box2D.postDefs.push(function(){Box2D.Dynamics.b2ContactListener.b2_defaultListener=new x}),b.b2ContactManager=function(){},b.prototype.b2ContactManager=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=g.b2_defaultFilter,this.m_contactListener=x.b2_defaultListener,this.m_contactFactory=new B(this.m_allocator),this.m_broadPhase=new h},b.prototype.AddPair=function(t,e){var i=t instanceof S?t:null,o=e instanceof S?e:null,n=i.GetBody(),r=o.GetBody();if(n!=r){for(var s=r.GetContactList();s;){if(s.other==n){var a=s.contact.GetFixtureA(),h=s.contact.GetFixtureB();if(a==i&&h==o)return;if(a==o&&h==i)return}s=s.next}if(0!=r.ShouldCollide(n)&&0!=this.m_contactFilter.ShouldCollide(i,o)){var l=this.m_contactFactory.Create(i,o);i=l.GetFixtureA(),o=l.GetFixtureB(),n=i.m_body,r=o.m_body,l.m_prev=null,l.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=l),this.m_world.m_contactList=l,l.m_nodeA.contact=l,l.m_nodeA.other=r,l.m_nodeA.prev=null,l.m_nodeA.next=n.m_contactList,null!=n.m_contactList&&(n.m_contactList.prev=l.m_nodeA),n.m_contactList=l.m_nodeA,l.m_nodeB.contact=l,l.m_nodeB.other=n,l.m_nodeB.prev=null,l.m_nodeB.next=r.m_contactList,null!=r.m_contactList&&(r.m_contactList.prev=l.m_nodeB),r.m_contactList=l.m_nodeB,++this.m_world.m_contactCount}}},b.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(Box2D.generateCallback(this,this.AddPair))},b.prototype.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),n=i.GetBody();t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_world.m_contactList&&(this.m_world.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},b.prototype.Collide=function(){for(var t=this.m_world.m_contactList;t;){var e=t.GetFixtureA(),i=t.GetFixtureB(),o=e.GetBody(),n=i.GetBody();if(0!=o.IsAwake()||0!=n.IsAwake()){if(t.m_flags&A.e_filterFlag){if(0==n.ShouldCollide(o)){var r=t;t=r.GetNext(),this.Destroy(r);continue}if(0==this.m_contactFilter.ShouldCollide(e,i)){r=t,t=r.GetNext(),this.Destroy(r);continue}t.m_flags&=~A.e_filterFlag}var s=e.m_proxy,a=i.m_proxy;if(s&&a){if(0==this.m_broadPhase.TestOverlap(s,a)){r=t,t=r.GetNext(),this.Destroy(r);continue}}t.Update(this.m_contactListener),t=t.GetNext()}else t=t.GetNext()}},Box2D.postDefs.push(function(){Box2D.Dynamics.b2ContactManager.s_evalCP=new a}),E.b2DebugDraw=function(){},E.prototype.b2DebugDraw=function(){},E.prototype.SetFlags=function(t){void 0===t&&(t=0)},E.prototype.GetFlags=function(){},E.prototype.AppendFlags=function(t){void 0===t&&(t=0)},E.prototype.ClearFlags=function(t){void 0===t&&(t=0)},E.prototype.SetSprite=function(t){},E.prototype.GetSprite=function(){},E.prototype.SetDrawScale=function(t){void 0===t&&(t=0)},E.prototype.GetDrawScale=function(){},E.prototype.SetLineThickness=function(t){void 0===t&&(t=0)},E.prototype.GetLineThickness=function(){},E.prototype.SetAlpha=function(t){void 0===t&&(t=0)},E.prototype.GetAlpha=function(){},E.prototype.SetFillAlpha=function(t){void 0===t&&(t=0)},E.prototype.GetFillAlpha=function(){},E.prototype.SetXFormScale=function(t){void 0===t&&(t=0)},E.prototype.GetXFormScale=function(){},E.prototype.DrawPolygon=function(t,e,i){void 0===e&&(e=0)},E.prototype.DrawSolidPolygon=function(t,e,i){void 0===e&&(e=0)},E.prototype.DrawCircle=function(t,e,i){void 0===e&&(e=0)},E.prototype.DrawSolidCircle=function(t,e,i,o){void 0===e&&(e=0)},E.prototype.DrawSegment=function(t,e,i){},E.prototype.DrawTransform=function(t){},Box2D.postDefs.push(function(){Box2D.Dynamics.b2DebugDraw.e_shapeBit=1,Box2D.Dynamics.b2DebugDraw.e_jointBit=2,Box2D.Dynamics.b2DebugDraw.e_aabbBit=4,Box2D.Dynamics.b2DebugDraw.e_pairBit=8,Box2D.Dynamics.b2DebugDraw.e_centerOfMassBit=16,Box2D.Dynamics.b2DebugDraw.e_controllerBit=32}),T.b2DestructionListener=function(){},T.prototype.SayGoodbyeJoint=function(t){},T.prototype.SayGoodbyeFixture=function(t){},w.b2FilterData=function(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0},w.prototype.Copy=function(){var t=new w;return t.categoryBits=this.categoryBits,t.maskBits=this.maskBits,t.groupIndex=this.groupIndex,t},S.b2Fixture=function(){this.m_filter=new w},S.prototype.GetType=function(){return this.m_shape.GetType()},S.prototype.GetShape=function(){return this.m_shape},S.prototype.SetSensor=function(t){if(this.m_isSensor!=t&&(this.m_isSensor=t,null!=this.m_body))for(var e=this.m_body.GetContactList();e;){var i=e.contact,o=i.GetFixtureA(),n=i.GetFixtureB();o!=this&&n!=this||i.SetSensor(o.IsSensor()||n.IsSensor()),e=e.next}},S.prototype.IsSensor=function(){return this.m_isSensor},S.prototype.SetFilterData=function(t){if(this.m_filter=t.Copy(),!this.m_body)for(var e=this.m_body.GetContactList();e;){var i=e.contact,o=i.GetFixtureA(),n=i.GetFixtureB();o!=this&&n!=this||i.FlagForFiltering(),e=e.next}},S.prototype.GetFilterData=function(){return this.m_filter.Copy()},S.prototype.GetBody=function(){return this.m_body},S.prototype.GetNext=function(){return this.m_next},S.prototype.GetUserData=function(){return this.m_userData},S.prototype.SetUserData=function(t){this.m_userData=t},S.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},S.prototype.RayCast=function(t,e){return this.m_shape.RayCast(t,e,this.m_body.GetTransform())},S.prototype.GetMassData=function(t){return void 0===t&&(t=null),null==t&&(t=new d),this.m_shape.ComputeMass(t,this.m_density),t},S.prototype.SetDensity=function(t){void 0===t&&(t=0),this.m_density=t},S.prototype.GetDensity=function(){return this.m_density},S.prototype.GetFriction=function(){return this.m_friction},S.prototype.SetFriction=function(t){void 0===t&&(t=0),this.m_friction=t},S.prototype.GetRestitution=function(){return this.m_restitution},S.prototype.SetRestitution=function(t){void 0===t&&(t=0),
this.m_restitution=t},S.prototype.GetAABB=function(){return this.m_aabb},S.prototype.b2Fixture=function(){this.m_aabb=new s,this.m_userData=null,this.m_body=null,this.m_next=null,this.m_shape=null,this.m_density=0,this.m_friction=0,this.m_restitution=0},S.prototype.Create=function(t,e,i){this.m_userData=i.userData,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_body=t,this.m_next=null,this.m_filter=i.filter.Copy(),this.m_isSensor=i.isSensor,this.m_shape=i.shape.Copy(),this.m_density=i.density},S.prototype.Destroy=function(){this.m_shape=null},S.prototype.CreateProxy=function(t,e){this.m_shape.ComputeAABB(this.m_aabb,e),this.m_proxy=t.CreateProxy(this.m_aabb,this)},S.prototype.DestroyProxy=function(t){null!=this.m_proxy&&(t.DestroyProxy(this.m_proxy),this.m_proxy=null)},S.prototype.Synchronize=function(e,i,o){if(this.m_proxy){var n=new s,r=new s;this.m_shape.ComputeAABB(n,i),this.m_shape.ComputeAABB(r,o),this.m_aabb.Combine(n,r);var a=t.SubtractVV(o.position,i.position);e.MoveProxy(this.m_proxy,this.m_aabb,a)}},C.b2FixtureDef=function(){this.filter=new w},C.prototype.b2FixtureDef=function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},R.b2Island=function(){},R.prototype.b2Island=function(){this.m_bodies=new Vector,this.m_contacts=new Vector,this.m_joints=new Vector},R.prototype.Initialize=function(t,e,i,o,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var s=0;for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=o,this.m_listener=n,this.m_contactSolver=r,s=this.m_bodies.length;s<t;s++)this.m_bodies[s]=null;for(s=this.m_contacts.length;s<e;s++)this.m_contacts[s]=null;for(s=this.m_joints.length;s<i;s++)this.m_joints[s]=null},R.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},R.prototype.Solve=function(e,i,o){var n,s,a=0,h=0,l=i.x,c=i.y;for(a=0;a<this.m_bodyCount;++a)n=this.m_bodies[a],n.GetType()==f.b2_dynamicBody&&(n.m_nonGravitic?(n.m_linearVelocity.x+=e.dt*(n.m_invMass*n.m_force.x),n.m_linearVelocity.y+=e.dt*(n.m_invMass*n.m_force.y)):(n.m_linearVelocity.x+=e.dt*(l+n.m_invMass*n.m_force.x),n.m_linearVelocity.y+=e.dt*(c+n.m_invMass*n.m_force.y)),n.m_angularVelocity+=e.dt*n.m_invI*n.m_torque,n.m_linearVelocity.Multiply(t.Clamp(1-e.dt*n.m_linearDamping,0,1)),n.m_angularVelocity*=t.Clamp(1-e.dt*n.m_angularDamping,0,1));this.m_contactSolver.Initialize(e,this.m_contacts,this.m_contactCount,this.m_allocator);var u=this.m_contactSolver;for(u.InitVelocityConstraints(e),a=0;a<this.m_jointCount;++a)s=this.m_joints[a],s.InitVelocityConstraints(e);for(a=0;a<e.velocityIterations;++a){for(h=0;h<this.m_jointCount;++h)s=this.m_joints[h],s.SolveVelocityConstraints(e);u.SolveVelocityConstraints()}for(a=0;a<this.m_jointCount;++a)s=this.m_joints[a],s.FinalizeVelocityConstraints();for(u.FinalizeVelocityConstraints(),a=0;a<this.m_bodyCount;++a)if(n=this.m_bodies[a],n.GetType()!=f.b2_staticBody){var m=e.dt*n.m_linearVelocity.x,d=e.dt*n.m_linearVelocity.y;m*m+d*d>r.b2_maxTranslationSquared&&(n.m_linearVelocity.Normalize(),n.m_linearVelocity.x*=r.b2_maxTranslation*e.inv_dt,n.m_linearVelocity.y*=r.b2_maxTranslation*e.inv_dt);var p=e.dt*n.m_angularVelocity;p*p>r.b2_maxRotationSquared&&(n.m_angularVelocity<0?n.m_angularVelocity=-r.b2_maxRotation*e.inv_dt:n.m_angularVelocity=r.b2_maxRotation*e.inv_dt),n.m_sweep.c0.SetV(n.m_sweep.c),n.m_sweep.a0=n.m_sweep.a,n.m_sweep.c.x+=e.dt*n.m_linearVelocity.x,n.m_sweep.c.y+=e.dt*n.m_linearVelocity.y,n.m_sweep.a+=e.dt*n.m_angularVelocity,n.SynchronizeTransform()}for(a=0;a<e.positionIterations;++a){var _=u.SolvePositionConstraints(r.b2_contactBaumgarte),y=!0;for(h=0;h<this.m_jointCount;++h){s=this.m_joints[h];var g=s.SolvePositionConstraints(r.b2_contactBaumgarte);y=y&&g}if(_&&y)break}if(this.Report(u.m_constraints),o){var v=Number.MAX_VALUE,x=r.b2_linearSleepTolerance*r.b2_linearSleepTolerance,b=r.b2_angularSleepTolerance*r.b2_angularSleepTolerance;for(a=0;a<this.m_bodyCount;++a)n=this.m_bodies[a],n.GetType()!=f.b2_staticBody&&(0==(n.m_flags&f.e_allowSleepFlag)&&(n.m_sleepTime=0,v=0),0==(n.m_flags&f.e_allowSleepFlag)||n.m_angularVelocity*n.m_angularVelocity>b||t.Dot(n.m_linearVelocity,n.m_linearVelocity)>x?(n.m_sleepTime=0,v=0):(n.m_sleepTime+=e.dt,v=t.Min(v,n.m_sleepTime)));if(v>=r.b2_timeToSleep)for(a=0;a<this.m_bodyCount;++a)n=this.m_bodies[a],n.SetAwake(!1)}},R.prototype.SolveTOI=function(t){var e=0,i=0;this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var o=this.m_contactSolver;for(e=0;e<this.m_jointCount;++e)this.m_joints[e].InitVelocityConstraints(t);for(e=0;e<t.velocityIterations;++e)for(o.SolveVelocityConstraints(),i=0;i<this.m_jointCount;++i)this.m_joints[i].SolveVelocityConstraints(t);for(e=0;e<this.m_bodyCount;++e){var n=this.m_bodies[e];if(n.GetType()!=f.b2_staticBody){var s=t.dt*n.m_linearVelocity.x,a=t.dt*n.m_linearVelocity.y;s*s+a*a>r.b2_maxTranslationSquared&&(n.m_linearVelocity.Normalize(),n.m_linearVelocity.x*=r.b2_maxTranslation*t.inv_dt,n.m_linearVelocity.y*=r.b2_maxTranslation*t.inv_dt);var h=t.dt*n.m_angularVelocity;h*h>r.b2_maxRotationSquared&&(n.m_angularVelocity<0?n.m_angularVelocity=-r.b2_maxRotation*t.inv_dt:n.m_angularVelocity=r.b2_maxRotation*t.inv_dt),n.m_sweep.c0.SetV(n.m_sweep.c),n.m_sweep.a0=n.m_sweep.a,n.m_sweep.c.x+=t.dt*n.m_linearVelocity.x,n.m_sweep.c.y+=t.dt*n.m_linearVelocity.y,n.m_sweep.a+=t.dt*n.m_angularVelocity,n.SynchronizeTransform()}}for(e=0;e<t.positionIterations;++e){var l=o.SolvePositionConstraints(.75),c=!0;for(i=0;i<this.m_jointCount;++i){var u=this.m_joints[i].SolvePositionConstraints(r.b2_contactBaumgarte);c=c&&u}if(l&&c)break}this.Report(o.m_constraints)},R.prototype.Report=function(t){if(null!=this.m_listener)for(var e=0;e<this.m_contactCount;++e){for(var i=this.m_contacts[e],o=t[e],n=0;n<o.pointCount;++n)R.s_impulse.normalImpulses[n]=o.points[n].normalImpulse,R.s_impulse.tangentImpulses[n]=o.points[n].tangentImpulse;this.m_listener.PostSolve(i,R.s_impulse)}},R.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},R.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},R.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},Box2D.postDefs.push(function(){Box2D.Dynamics.b2Island.s_impulse=new v}),M.b2TimeStep=function(){},M.prototype.Set=function(t){this.dt=t.dt,this.inv_dt=t.inv_dt,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting},D.b2World=function(){this.s_stack=new Vector,this.m_contactManager=new b,this.m_contactSolver=new I,this.m_island=new R},D.prototype.b2World=function(t,e){this.m_destructionListener=null,this.m_debugDraw=null,this.m_bodyList=null,this.m_contactList=null,this.m_jointList=null,this.m_controllerList=null,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_controllerCount=0,D.m_warmStarting=!0,D.m_continuousPhysics=!0,this.m_allowSleep=e,this.m_gravity=t,this.m_inv_dt0=0,this.m_contactManager.m_world=this;var i=new y;this.m_groundBody=this.CreateBody(i)},D.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},D.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},D.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},D.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},D.prototype.SetBroadPhase=function(t){var e=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=t;for(var i=this.m_bodyList;i;i=i.m_next)for(var o=i.m_fixtureList;o;o=o.m_next)o.m_proxy=t.CreateProxy(e.GetFatAABB(o.m_proxy),o)},D.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},D.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},D.prototype.CreateBody=function(t){if(1==this.IsLocked())return null;var e=new f(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},D.prototype.DestroyBody=function(t){if(1!=this.IsLocked()){for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint)}for(var o=t.m_controllerList;o;){var n=o;o=o.nextController,n.controller.RemoveBody(t)}for(var r=t.m_contactList;r;){var s=r;r=r.next,this.m_contactManager.Destroy(s.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var h=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(h),h.DestroyProxy(this.m_contactManager.m_broadPhase),h.Destroy()}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},D.prototype.CreateJoint=function(t){var e=H.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.joint=e,e.m_edgeA.other=e.m_bodyB,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.joint=e,e.m_edgeB.other=e.m_bodyA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;var i=t.bodyA,o=t.bodyB;if(0==t.collideConnected)for(var n=o.GetContactList();n;)n.other==i&&n.contact.FlagForFiltering(),n=n.next;return e},D.prototype.DestroyJoint=function(t){var e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,o=t.m_bodyB;if(i.SetAwake(!0),o.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==o.m_jointList&&(o.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,H.Destroy(t,null),--this.m_jointCount,0==e)for(var n=o.GetContactList();n;)n.other==i&&n.contact.FlagForFiltering(),n=n.next},D.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList=t,t.m_world=this,this.m_controllerCount++,t},D.prototype.RemoveController=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList==t&&(this.m_controllerList=t.m_next),this.m_controllerCount--},D.prototype.CreateController=function(t){if(t.m_world!=this)throw new Error("Controller can only be a member of one world");return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t.m_world=this,t},D.prototype.DestroyController=function(t){t.Clear(),t.m_next&&(t.m_next.m_prev=t.m_prev),t.m_prev&&(t.m_prev.m_next=t.m_next),t==this.m_controllerList&&(this.m_controllerList=t.m_next),--this.m_controllerCount},D.prototype.SetWarmStarting=function(t){D.m_warmStarting=t},D.prototype.SetContinuousPhysics=function(t){D.m_continuousPhysics=t},D.prototype.GetBodyCount=function(){return this.m_bodyCount},D.prototype.GetJointCount=function(){return this.m_jointCount},D.prototype.GetContactCount=function(){return this.m_contactCount},D.prototype.SetGravity=function(t){this.m_gravity=t},D.prototype.GetGravity=function(){return this.m_gravity},D.prototype.GetGroundBody=function(){return this.m_groundBody},D.prototype.Step=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.m_flags&D.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~D.e_newFixture),this.m_flags|=D.e_locked;var o=D.s_timestep2;o.dt=t,o.velocityIterations=e,o.positionIterations=i,o.inv_dt=t>0?1/t:0,o.dtRatio=this.m_inv_dt0*t,o.warmStarting=D.m_warmStarting,this.m_contactManager.Collide(),o.dt>0&&this.Solve(o),D.m_continuousPhysics&&o.dt>0&&this.SolveTOI(o),o.dt>0&&(this.m_inv_dt0=o.inv_dt),this.m_flags&=~D.e_locked},D.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},D.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.m_sprite.graphics.clear();var t,e,i,r,a,h,l=this.m_debugDraw.GetFlags(),c=(new o,new o,new o,new s,new s,[new o,new o,new o,new o]),u=new n(0,0,0);if(l&E.e_shapeBit)for(t=this.m_bodyList;t;t=t.m_next)if(!t._entity||!t._entity._box2dNoDebug)for(h=t.m_xf,e=t.GetFixtureList();e;e=e.m_next)i=e.GetShape(),0==t.IsActive()?(u.Set(.5,.5,.3),this.DrawShape(i,h,u)):t.GetType()==f.b2_staticBody?(u.Set(.5,.9,.5),this.DrawShape(i,h,u)):t.GetType()==f.b2_kinematicBody?(u.Set(.5,.5,.9),this.DrawShape(i,h,u)):0==t.IsAwake()?(u.Set(.6,.6,.6),this.DrawShape(i,h,u)):(u.Set(.9,.7,.7),this.DrawShape(i,h,u));if(l&E.e_jointBit)for(r=this.m_jointList;r;r=r.m_next)this.DrawJoint(r);if(l&E.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw);if(l&E.e_pairBit){u.Set(.3,.9,.9);for(var d=this.m_contactManager.m_contactList;d;d=d.GetNext()){var p=d.GetFixtureA(),_=d.GetFixtureB(),y=p.GetAABB().GetCenter(),g=_.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(y,g,u)}}if(l&E.e_aabbBit)for(a=this.m_contactManager.m_broadPhase,c=[new o,new o,new o,new o],t=this.m_bodyList;t;t=t.GetNext())if(0!=t.IsActive())for(e=t.GetFixtureList();e;e=e.GetNext()){var v=a.GetFatAABB(e.m_proxy);c[0].Set(v.lowerBound.x,v.lowerBound.y),c[1].Set(v.upperBound.x,v.lowerBound.y),c[2].Set(v.upperBound.x,v.upperBound.y),c[3].Set(v.lowerBound.x,v.upperBound.y),this.m_debugDraw.DrawPolygon(c,4,u)}if(l&E.e_centerOfMassBit)for(t=this.m_bodyList;t;t=t.m_next)h=D.s_xf,h.R=t.m_xf.R,h.position=t.GetWorldCenter(),this.m_debugDraw.DrawTransform(h)}},D.prototype.QueryAABB=function(t,e){function i(e){return t(n.GetUserData(e))}var o=this,n=o.m_contactManager.m_broadPhase;n.Query(i,e)},D.prototype.QueryShape=function(t,e,o){function n(i){var n=a.GetUserData(i)instanceof S?a.GetUserData(i):null;return!_.TestOverlap(e,o,n.GetShape(),n.GetBody().GetTransform())||t(n)}var r=this;void 0===o&&(o=null),null==o&&(o=new i,o.SetIdentity());var a=r.m_contactManager.m_broadPhase,h=new s;e.ComputeAABB(h,o),a.Query(n,h)},D.prototype.QueryPoint=function(t,e){function i(i){var o=n.GetUserData(i)instanceof S?n.GetUserData(i):null;return!o.TestPoint(e)||t(o)}var o=this,n=o.m_contactManager.m_broadPhase,a=new s;a.lowerBound.Set(e.x-r.b2_linearSlop,e.y-r.b2_linearSlop),a.upperBound.Set(e.x+r.b2_linearSlop,e.y+r.b2_linearSlop),n.Query(i,a)},D.prototype.RayCast=function(t,e,i){function n(n,r){var h=s.GetUserData(r),l=h instanceof S?h:null;if(l.RayCast(a,n)){var c=a.fraction,u=new o((1-c)*e.x+c*i.x,(1-c)*e.y+c*i.y);return t(l,u,a.normal,c)}return n.maxFraction}var r=this,s=r.m_contactManager.m_broadPhase,a=new c,h=new l(e,i);s.RayCast(n,h)},D.prototype.RayCastOne=function(t,e){function i(t,e,i,n){return void 0===n&&(n=0),o=t,n}var o,n=this;return n.RayCast(i,t,e),o},D.prototype.RayCastAll=function(t,e){function i(t,e,i,o){return void 0===o&&(o=0),n[n.length]=t,1}var o=this,n=new Vector;return o.RayCast(i,t,e),n},D.prototype.GetBodyList=function(){return this.m_bodyList},D.prototype.GetJointList=function(){return this.m_jointList},D.prototype.GetContactList=function(){return this.m_contactList},D.prototype.IsLocked=function(){return(this.m_flags&D.e_locked)>0},D.prototype.Solve=function(t){for(var e,i=this.m_controllerList;i;i=i.m_next)i.Step(t);var o=this.m_island;for(o.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag;for(var n=this.m_contactList;n;n=n.m_next)n.m_flags&=~A.e_islandFlag;for(var r=this.m_jointList;r;r=r.m_next)r.m_islandFlag=!1;for(var s=(parseInt(this.m_bodyCount),this.s_stack),a=this.m_bodyList;a;a=a.m_next)if(!(a.m_flags&f.e_islandFlag)&&0!=a.IsAwake()&&0!=a.IsActive()&&a.GetType()!=f.b2_staticBody){o.Clear();var h=0;for(s[h++]=a,a.m_flags|=f.e_islandFlag;h>0;)if(e=s[--h],o.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()!=f.b2_staticBody){for(var l,c=e.m_contactList;c;c=c.next)c.contact.m_flags&A.e_islandFlag||1!=c.contact.IsSensor()&&0!=c.contact.IsEnabled()&&0!=c.contact.IsTouching()&&(o.AddContact(c.contact),c.contact.m_flags|=A.e_islandFlag,l=c.other,l.m_flags&f.e_islandFlag||(s[h++]=l,l.m_flags|=f.e_islandFlag));for(var u=e.m_jointList;u;u=u.next)1!=u.joint.m_islandFlag&&(l=u.other,0!=l.IsActive()&&(o.AddJoint(u.joint),u.joint.m_islandFlag=!0,l.m_flags&f.e_islandFlag||(s[h++]=l,l.m_flags|=f.e_islandFlag)))}o.Solve(t,this.m_gravity,this.m_allowSleep);for(var m=0;m<o.m_bodyCount;++m)e=o.m_bodies[m],e.GetType()==f.b2_staticBody&&(e.m_flags&=~f.e_islandFlag)}for(m=0;m<s.length&&s[m];++m)s[m]=null;for(e=this.m_bodyList;e;e=e.m_next)0!=e.IsAwake()&&0!=e.IsActive()&&e.GetType()!=f.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},D.prototype.SolveTOI=function(t){var e,i,o,n,s,a,h,l=this.m_island;l.Initialize(this.m_bodyCount,r.b2_maxTOIContactsPerIsland,r.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var c=D.s_queue;for(e=this.m_bodyList;e;e=e.m_next)e.m_flags&=~f.e_islandFlag,e.m_sweep.t0=0;var u;for(u=this.m_contactList;u;u=u.m_next)u.m_flags&=~(A.e_toiFlag|A.e_islandFlag);for(h=this.m_jointList;h;h=h.m_next)h.m_islandFlag=!1;for(;;){var m=null,d=1;for(u=this.m_contactList;u;u=u.m_next)if(1!=u.IsSensor()&&0!=u.IsEnabled()&&0!=u.IsContinuous()){var p=1;if(u.m_flags&A.e_toiFlag)p=u.m_toi;else{if(i=u.m_fixtureA,o=u.m_fixtureB,n=i.m_body,s=o.m_body,!(n.GetType()==f.b2_dynamicBody&&0!=n.IsAwake()||s.GetType()==f.b2_dynamicBody&&0!=s.IsAwake()))continue;var _=n.m_sweep.t0;n.m_sweep.t0<s.m_sweep.t0?(_=s.m_sweep.t0,n.m_sweep.Advance(_)):s.m_sweep.t0<n.m_sweep.t0&&(_=n.m_sweep.t0,s.m_sweep.Advance(_)),p=u.ComputeTOI(n.m_sweep,s.m_sweep),r.b2Assert(0<=p&&p<=1),p>0&&p<1&&(p=(1-p)*_+p)>1&&(p=1),u.m_toi=p,u.m_flags|=A.e_toiFlag}Number.MIN_VALUE<p&&p<d&&(m=u,d=p)}if(null==m||1-100*Number.MIN_VALUE<d)break;if(i=m.m_fixtureA,o=m.m_fixtureB,n=i.m_body,s=o.m_body,D.s_backupA.Set(n.m_sweep),D.s_backupB.Set(s.m_sweep),n.Advance(d),s.Advance(d),m.Update(this.m_contactManager.m_contactListener),m.m_flags&=~A.e_toiFlag,1!=m.IsSensor()&&0!=m.IsEnabled()){if(0!=m.IsTouching()){var y=n;y.GetType()!=f.b2_dynamicBody&&(y=s),l.Clear();var g=0,v=0;for(c[g+v++]=y,y.m_flags|=f.e_islandFlag;v>0;)if(e=c[g++],--v,l.AddBody(e),0==e.IsAwake()&&e.SetAwake(!0),e.GetType()==f.b2_dynamicBody){for(a=e.m_contactList;a&&l.m_contactCount!=l.m_contactCapacity;a=a.next)if(!(a.contact.m_flags&A.e_islandFlag)&&1!=a.contact.IsSensor()&&0!=a.contact.IsEnabled()&&0!=a.contact.IsTouching()){l.AddContact(a.contact),a.contact.m_flags|=A.e_islandFlag;var x=a.other;x.m_flags&f.e_islandFlag||(x.GetType()!=f.b2_staticBody&&(x.Advance(d),x.SetAwake(!0)),c[g+v]=x,++v,x.m_flags|=f.e_islandFlag)}for(var b=e.m_jointList;b;b=b.next)l.m_jointCount!=l.m_jointCapacity&&1!=b.joint.m_islandFlag&&(x=b.other,0!=x.IsActive()&&(l.AddJoint(b.joint),b.joint.m_islandFlag=!0,x.m_flags&f.e_islandFlag||(x.GetType()!=f.b2_staticBody&&(x.Advance(d),x.SetAwake(!0)),c[g+v]=x,++v,x.m_flags|=f.e_islandFlag)))}var E=D.s_timestep;E.warmStarting=!1,E.dt=(1-d)*t.dt,E.inv_dt=1/E.dt,E.dtRatio=0,E.velocityIterations=t.velocityIterations,E.positionIterations=t.positionIterations,l.SolveTOI(E);var T=0;for(T=0;T<l.m_bodyCount;++T)if(e=l.m_bodies[T],e.m_flags&=~f.e_islandFlag,0!=e.IsAwake()&&e.GetType()==f.b2_dynamicBody)for(e.SynchronizeFixtures(),a=e.m_contactList;a;a=a.next)a.contact.m_flags&=~A.e_toiFlag;for(T=0;T<l.m_contactCount;++T)u=l.m_contacts[T],u.m_flags&=~(A.e_toiFlag|A.e_islandFlag);for(T=0;T<l.m_jointCount;++T)h=l.m_joints[T],h.m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}else n.m_sweep.Set(D.s_backupA),s.m_sweep.Set(D.s_backupB),n.SynchronizeTransform(),s.SynchronizeTransform()}},D.prototype.DrawJoint=function(t){var e=t.GetBodyA(),i=t.GetBodyB(),o=e.m_xf,n=i.m_xf,r=o.position,s=n.position,a=t.GetAnchorA(),h=t.GetAnchorB(),l=D.s_jointColor;switch(t.m_type){case H.e_distanceJoint:this.m_debugDraw.DrawSegment(a,h,l);break;case H.e_pulleyJoint:var c=t instanceof P?t:null,u=c.GetGroundAnchorA(),m=c.GetGroundAnchorB();this.m_debugDraw.DrawSegment(u,a,l),this.m_debugDraw.DrawSegment(m,h,l),this.m_debugDraw.DrawSegment(u,m,l);break;case H.e_mouseJoint:this.m_debugDraw.DrawSegment(a,h,l);break;default:e!=this.m_groundBody&&this.m_debugDraw.DrawSegment(r,a,l),this.m_debugDraw.DrawSegment(a,h,l),i!=this.m_groundBody&&this.m_debugDraw.DrawSegment(s,h,l)}},D.prototype.DrawShape=function(e,i,o){switch(e.m_type){case _.e_circleShape:var n=e instanceof u?e:null,r=t.MulX(i,n.m_p),s=n.m_radius,a=i.R.col1;this.m_debugDraw.DrawSolidCircle(r,s,a,o);break;case _.e_polygonShape:var h=0,l=e instanceof p?e:null,c=parseInt(l.GetVertexCount()),d=l.GetVertices(),f=new Vector(c);for(h=0;h<c;++h)f[h]=t.MulX(i,d[h]);this.m_debugDraw.DrawSolidPolygon(f,c,o);break;case _.e_edgeShape:var y=e instanceof m?e:null;this.m_debugDraw.DrawSegment(t.MulX(i,y.GetVertex1()),t.MulX(i,y.GetVertex2()),o)}},Box2D.postDefs.push(function(){Box2D.Dynamics.b2World.s_timestep2=new M,Box2D.Dynamics.b2World.s_xf=new i,Box2D.Dynamics.b2World.s_backupA=new e,Box2D.Dynamics.b2World.s_backupB=new e,Box2D.Dynamics.b2World.s_timestep=new M,Box2D.Dynamics.b2World.s_queue=new Vector,Box2D.Dynamics.b2World.s_jointColor=new n(.5,.8,.8),Box2D.Dynamics.b2World.e_newFixture=1,Box2D.Dynamics.b2World.e_locked=2})}(),function(){var t=Box2D.Collision.Shapes.b2CircleShape,e=(Box2D.Collision.Shapes.b2EdgeChainDef,Box2D.Collision.Shapes.b2EdgeShape),i=(Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),o=Box2D.Collision.Shapes.b2Shape,n=Box2D.Dynamics.Contacts.b2CircleContact,r=Box2D.Dynamics.Contacts.b2Contact,s=Box2D.Dynamics.Contacts.b2ContactConstraint,a=Box2D.Dynamics.Contacts.b2ContactConstraintPoint,h=Box2D.Dynamics.Contacts.b2ContactEdge,l=Box2D.Dynamics.Contacts.b2ContactFactory,c=Box2D.Dynamics.Contacts.b2ContactRegister,u=Box2D.Dynamics.Contacts.b2ContactResult,m=Box2D.Dynamics.Contacts.b2ContactSolver,d=Box2D.Dynamics.Contacts.b2EdgeAndCircleContact,p=Box2D.Dynamics.Contacts.b2NullContact,_=Box2D.Dynamics.Contacts.b2PolyAndCircleContact,f=Box2D.Dynamics.Contacts.b2PolyAndEdgeContact,y=Box2D.Dynamics.Contacts.b2PolygonContact,g=Box2D.Dynamics.Contacts.b2PositionSolverManifold,v=Box2D.Dynamics.b2Body,x=(Box2D.Dynamics.b2BodyDef,Box2D.Dynamics.b2ContactFilter,Box2D.Dynamics.b2ContactImpulse,Box2D.Dynamics.b2ContactListener,Box2D.Dynamics.b2ContactManager,Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.b2DestructionListener,Box2D.Dynamics.b2FilterData,Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2FixtureDef,Box2D.Dynamics.b2Island,Box2D.Dynamics.b2TimeStep),b=(Box2D.Dynamics.b2World,Box2D.Common.b2Color,Box2D.Common.b2internal,Box2D.Common.b2Settings),E=Box2D.Common.Math.b2Mat22,T=(Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math),w=(Box2D.Common.Math.b2Sweep,Box2D.Common.Math.b2Transform,Box2D.Common.Math.b2Vec2),S=(Box2D.Common.Math.b2Vec3,Box2D.Collision.b2AABB,Box2D.Collision.b2Bound,Box2D.Collision.b2BoundValues,Box2D.Collision.b2Collision),C=Box2D.Collision.b2ContactID,R=(Box2D.Collision.b2ContactPoint,Box2D.Collision.b2Distance,Box2D.Collision.b2DistanceInput,Box2D.Collision.b2DistanceOutput,Box2D.Collision.b2DistanceProxy,Box2D.Collision.b2DynamicTree,Box2D.Collision.b2DynamicTreeBroadPhase,Box2D.Collision.b2DynamicTreeNode,Box2D.Collision.b2DynamicTreePair,Box2D.Collision.b2Manifold),M=(Box2D.Collision.b2ManifoldPoint,Box2D.Collision.b2Point,Box2D.Collision.b2RayCastInput,Box2D.Collision.b2RayCastOutput,Box2D.Collision.b2Segment,Box2D.Collision.b2SeparationFunction,Box2D.Collision.b2Simplex,Box2D.Collision.b2SimplexCache,Box2D.Collision.b2SimplexVertex,Box2D.Collision.b2TimeOfImpact),D=Box2D.Collision.b2TOIInput,A=Box2D.Collision.b2WorldManifold;Box2D.Collision.ClipVertex,Box2D.Collision.Features,Box2D.Collision.IBroadPhase;Box2D.inherit(n,Box2D.Dynamics.Contacts.b2Contact),n.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,n.b2CircleContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},n.Create=function(t){return new n},n.Destroy=function(t,e){},n.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},n.prototype.Evaluate=function(){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody();S.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape()instanceof t?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,i.m_xf)},r.b2Contact=function(){this.m_nodeA=new h,this.m_nodeB=new h,this.m_manifold=new R,this.m_oldManifold=new R},r.prototype.GetManifold=function(){return this.m_manifold},r.prototype.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),o=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),o.m_radius,i.GetTransform(),n.m_radius)},r.prototype.IsTouching=function(){return(this.m_flags&r.e_touchingFlag)==r.e_touchingFlag},r.prototype.IsContinuous=function(){return(this.m_flags&r.e_continuousFlag)==r.e_continuousFlag},r.prototype.SetSensor=function(t){t?this.m_flags|=r.e_sensorFlag:this.m_flags&=~r.e_sensorFlag},r.prototype.IsSensor=function(){return(this.m_flags&r.e_sensorFlag)==r.e_sensorFlag},r.prototype.SetEnabled=function(t){t?this.m_flags|=r.e_enabledFlag:this.m_flags&=~r.e_enabledFlag},r.prototype.IsEnabled=function(){return(this.m_flags&r.e_enabledFlag)==r.e_enabledFlag},r.prototype.GetNext=function(){return this.m_next},r.prototype.GetFixtureA=function(){return this.m_fixtureA},r.prototype.GetFixtureB=function(){return this.m_fixtureB},r.prototype.FlagForFiltering=function(){this.m_flags|=r.e_filterFlag},r.prototype.b2Contact=function(){},r.prototype.Reset=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=null),this.m_flags=r.e_enabledFlag,!t||!e)return this.m_fixtureA=null,void(this.m_fixtureB=null);(t.IsSensor()||e.IsSensor())&&(this.m_flags|=r.e_sensorFlag);var i=t.GetBody(),o=e.GetBody();(i.GetType()!=v.b2_dynamicBody||i.IsBullet()||o.GetType()!=v.b2_dynamicBody||o.IsBullet())&&(this.m_flags|=r.e_continuousFlag),this.m_fixtureA=t,this.m_fixtureB=e,this.m_manifold.m_pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null},r.prototype.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_flags|=r.e_enabledFlag;var i=!1,n=(this.m_flags&r.e_touchingFlag)==r.e_touchingFlag,s=this.m_fixtureA.m_body,a=this.m_fixtureB.m_body,h=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&r.e_sensorFlag){if(h){var l=this.m_fixtureA.GetShape(),c=this.m_fixtureB.GetShape(),u=s.GetTransform(),m=a.GetTransform();i=o.TestOverlap(l,u,c,m)}this.m_manifold.m_pointCount=0}else{if(s.GetType()!=v.b2_dynamicBody||s.IsBullet()||a.GetType()!=v.b2_dynamicBody||a.IsBullet()?this.m_flags|=r.e_continuousFlag:this.m_flags&=~r.e_continuousFlag,h){this.Evaluate(),i=this.m_manifold.m_pointCount>0;for(var d=0;d<this.m_manifold.m_pointCount;++d){var p=this.m_manifold.m_points[d];p.m_normalImpulse=0,p.m_tangentImpulse=0;for(var _=p.m_id,f=0;f<this.m_oldManifold.m_pointCount;++f){var y=this.m_oldManifold.m_points[f];if(y.m_id.key==_.key){p.m_normalImpulse=y.m_normalImpulse,p.m_tangentImpulse=y.m_tangentImpulse;break}}}}else this.m_manifold.m_pointCount=0;i!=n&&(s.SetAwake(!0),a.SetAwake(!0))}i?this.m_flags|=r.e_touchingFlag:this.m_flags&=~r.e_touchingFlag,0==n&&1==i&&t.BeginContact(this),1==n&&0==i&&t.EndContact(this),0==(this.m_flags&r.e_sensorFlag)&&t.PreSolve(this,this.m_oldManifold)},r.prototype.Evaluate=function(){},r.prototype.ComputeTOI=function(t,e){return r.s_input.proxyA.Set(this.m_fixtureA.GetShape()),r.s_input.proxyB.Set(this.m_fixtureB.GetShape()),r.s_input.sweepA=t,r.s_input.sweepB=e,r.s_input.tolerance=b.b2_linearSlop,M.TimeOfImpact(r.s_input)},Box2D.postDefs.push(function(){Box2D.Dynamics.Contacts.b2Contact.e_sensorFlag=1,Box2D.Dynamics.Contacts.b2Contact.e_continuousFlag=2,Box2D.Dynamics.Contacts.b2Contact.e_islandFlag=4,Box2D.Dynamics.Contacts.b2Contact.e_toiFlag=8,Box2D.Dynamics.Contacts.b2Contact.e_touchingFlag=16,Box2D.Dynamics.Contacts.b2Contact.e_enabledFlag=32,Box2D.Dynamics.Contacts.b2Contact.e_filterFlag=64,Box2D.Dynamics.Contacts.b2Contact.s_input=new D}),s.b2ContactConstraint=function(){this.localPlaneNormal=new w,this.localPoint=new w,this.normal=new w,this.normalMass=new E,this.K=new E},s.prototype.b2ContactConstraint=function(){this.points=new Vector(b.b2_maxManifoldPoints);for(var t=0;t<b.b2_maxManifoldPoints;t++)this.points[t]=new a},a.b2ContactConstraintPoint=function(){this.localPoint=new w,this.rA=new w,this.rB=new w},h.b2ContactEdge=function(){},l.b2ContactFactory=function(){},l.prototype.b2ContactFactory=function(t){this.m_allocator=t,this.InitializeRegisters()},l.prototype.AddType=function(t,e,i,o){void 0===i&&(i=0),void 0===o&&(o=0),this.m_registers[i][o].createFcn=t,this.m_registers[i][o].destroyFcn=e,this.m_registers[i][o].primary=!0,i!=o&&(this.m_registers[o][i].createFcn=t,this.m_registers[o][i].destroyFcn=e,this.m_registers[o][i].primary=!1)},l.prototype.InitializeRegisters=function(){this.m_registers=new Vector(o.e_shapeTypeCount);for(var t=0;t<o.e_shapeTypeCount;t++){this.m_registers[t]=new Vector(o.e_shapeTypeCount);for(var e=0;e<o.e_shapeTypeCount;e++)this.m_registers[t][e]=new c}this.AddType(n.Create,n.Destroy,o.e_circleShape,o.e_circleShape),this.AddType(_.Create,_.Destroy,o.e_polygonShape,o.e_circleShape),this.AddType(y.Create,y.Destroy,o.e_polygonShape,o.e_polygonShape),this.AddType(d.Create,d.Destroy,o.e_edgeShape,o.e_circleShape),this.AddType(f.Create,f.Destroy,o.e_polygonShape,o.e_edgeShape)},l.prototype.Create=function(t,e){var i,o=parseInt(t.GetType()),n=parseInt(e.GetType()),r=this.m_registers[o][n];if(r.pool)return i=r.pool,r.pool=i.m_next,r.poolCount--,i.Reset(t,e),i;var s=r.createFcn;return null!=s?r.primary?(i=s(this.m_allocator),i.Reset(t,e),i):(i=s(this.m_allocator),i.Reset(e,t),i):null},l.prototype.Destroy=function(t){t.m_manifold.m_pointCount>0&&(t.m_fixtureA.m_body.SetAwake(!0),t.m_fixtureB.m_body.SetAwake(!0));var e=parseInt(t.m_fixtureA.GetType()),i=parseInt(t.m_fixtureB.GetType()),o=this.m_registers[e][i];o.poolCount++,t.m_next=o.pool,o.pool=t,(0,o.destroyFcn)(t,this.m_allocator)},c.b2ContactRegister=function(){},u.b2ContactResult=function(){this.position=new w,this.normal=new w,this.id=new C},m.b2ContactSolver=function(){this.m_step=new x,this.m_constraints=new Vector},m.prototype.b2ContactSolver=function(){},m.prototype.Initialize=function(t,e,i,o){void 0===i&&(i=0);var n;this.m_step.Set(t),this.m_allocator=o;var r=0;for(this.m_constraintCount=i;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new s;for(r=0;r<i;++r){n=e[r];var a=n.m_fixtureA,h=n.m_fixtureB,l=a.m_shape,c=h.m_shape,u=l.m_radius,d=c.m_radius,p=a.m_body,_=h.m_body,f=n.GetManifold(),y=b.b2MixFriction(a.GetFriction(),h.GetFriction()),g=b.b2MixRestitution(a.GetRestitution(),h.GetRestitution()),v=p.m_linearVelocity.x,x=p.m_linearVelocity.y,E=_.m_linearVelocity.x,T=_.m_linearVelocity.y,w=p.m_angularVelocity,S=_.m_angularVelocity;b.b2Assert(f.m_pointCount>0),m.s_worldManifold.Initialize(f,p.m_xf,u,_.m_xf,d)
;var C=m.s_worldManifold.m_normal.x,R=m.s_worldManifold.m_normal.y,M=this.m_constraints[r];M.bodyA=p,M.bodyB=_,M.manifold=f,M.normal.x=C,M.normal.y=R,M.pointCount=f.m_pointCount,M.friction=y,M.restitution=g,M.localPlaneNormal.x=f.m_localPlaneNormal.x,M.localPlaneNormal.y=f.m_localPlaneNormal.y,M.localPoint.x=f.m_localPoint.x,M.localPoint.y=f.m_localPoint.y,M.radius=u+d,M.type=f.m_type;for(var D=0;D<M.pointCount;++D){var A=f.m_points[D],B=M.points[D];B.normalImpulse=A.m_normalImpulse,B.tangentImpulse=A.m_tangentImpulse,B.localPoint.SetV(A.m_localPoint);var I=B.rA.x=m.s_worldManifold.m_points[D].x-p.m_sweep.c.x,H=B.rA.y=m.s_worldManifold.m_points[D].y-p.m_sweep.c.y,P=B.rB.x=m.s_worldManifold.m_points[D].x-_.m_sweep.c.x,L=B.rB.y=m.s_worldManifold.m_points[D].y-_.m_sweep.c.y,V=I*R-H*C,k=P*R-L*C;V*=V,k*=k;var F=p.m_invMass+_.m_invMass+p.m_invI*V+_.m_invI*k;B.normalMass=1/F;var z=p.m_mass*p.m_invMass+_.m_mass*_.m_invMass;z+=p.m_mass*p.m_invI*V+_.m_mass*_.m_invI*k,B.equalizedMass=1/z;var N=R,U=-C,O=I*U-H*N,G=P*U-L*N;O*=O,G*=G;var W=p.m_invMass+_.m_invMass+p.m_invI*O+_.m_invI*G;B.tangentMass=1/W,B.velocityBias=0;var j=E+-S*L-v- -w*H,q=T+S*P-x-w*I,J=M.normal.x*j+M.normal.y*q;J<-b.b2_velocityThreshold&&(B.velocityBias+=-M.restitution*J)}if(2==M.pointCount){var X=M.points[0],Y=M.points[1],K=p.m_invMass,Z=p.m_invI,$=_.m_invMass,Q=_.m_invI,tt=X.rA.x*R-X.rA.y*C,et=X.rB.x*R-X.rB.y*C,it=Y.rA.x*R-Y.rA.y*C,ot=Y.rB.x*R-Y.rB.y*C,nt=K+$+Z*tt*tt+Q*et*et,rt=K+$+Z*it*it+Q*ot*ot,st=K+$+Z*tt*it+Q*et*ot;nt*nt<100*(nt*rt-st*st)?(M.K.col1.Set(nt,st),M.K.col2.Set(st,rt),M.K.GetInverse(M.normalMass)):M.pointCount=1}}},m.prototype.InitVelocityConstraints=function(t){for(var e=0;e<this.m_constraintCount;++e){var i=this.m_constraints[e],o=i.bodyA,n=i.bodyB,r=o.m_invMass,s=o.m_invI,a=n.m_invMass,h=n.m_invI,l=i.normal.x,c=i.normal.y,u=c,m=-l,d=0,p=0;if(t.warmStarting)for(p=i.pointCount,d=0;d<p;++d){var _=i.points[d];_.normalImpulse*=t.dtRatio,_.tangentImpulse*=t.dtRatio;var f=_.normalImpulse*l+_.tangentImpulse*u,y=_.normalImpulse*c+_.tangentImpulse*m;o.m_angularVelocity-=s*(_.rA.x*y-_.rA.y*f),o.m_linearVelocity.x-=r*f,o.m_linearVelocity.y-=r*y,n.m_angularVelocity+=h*(_.rB.x*y-_.rB.y*f),n.m_linearVelocity.x+=a*f,n.m_linearVelocity.y+=a*y}else for(p=i.pointCount,d=0;d<p;++d){var g=i.points[d];g.normalImpulse=0,g.tangentImpulse=0}}},m.prototype.SolveVelocityConstraints=function(){for(var t,e,i=0,o=0,n=0,r=0,s=0,a=0,h=0,l=0,c=0,u=0,m=0,d=0,p=0,_=0,f=0,y=0,g=0;g<this.m_constraintCount;++g){var v=this.m_constraints[g],x=v.bodyA,b=v.bodyB,E=x.m_angularVelocity,w=b.m_angularVelocity,S=x.m_linearVelocity,C=b.m_linearVelocity,R=x.m_invMass,M=x.m_invI,D=b.m_invMass,A=b.m_invI,B=v.normal.x,I=v.normal.y,H=I,P=-B,L=v.friction;for(i=0;i<v.pointCount;i++)t=v.points[i],o=C.x-w*t.rB.y-S.x+E*t.rA.y,n=C.y+w*t.rB.x-S.y-E*t.rA.x,s=o*H+n*P,a=t.tangentMass*-s,h=L*t.normalImpulse,l=T.Clamp(t.tangentImpulse+a,-h,h),a=l-t.tangentImpulse,c=a*H,u=a*P,S.x-=R*c,S.y-=R*u,E-=M*(t.rA.x*u-t.rA.y*c),C.x+=D*c,C.y+=D*u,w+=A*(t.rB.x*u-t.rB.y*c),t.tangentImpulse=l;parseInt(v.pointCount);if(1==v.pointCount)t=v.points[0],o=C.x+-w*t.rB.y-S.x- -E*t.rA.y,n=C.y+w*t.rB.x-S.y-E*t.rA.x,r=o*B+n*I,a=-t.normalMass*(r-t.velocityBias),l=t.normalImpulse+a,l=l>0?l:0,a=l-t.normalImpulse,c=a*B,u=a*I,S.x-=R*c,S.y-=R*u,E-=M*(t.rA.x*u-t.rA.y*c),C.x+=D*c,C.y+=D*u,w+=A*(t.rB.x*u-t.rB.y*c),t.normalImpulse=l;else{var V=v.points[0],k=v.points[1],F=V.normalImpulse,z=k.normalImpulse,N=C.x-w*V.rB.y-S.x+E*V.rA.y,U=C.y+w*V.rB.x-S.y-E*V.rA.x,O=C.x-w*k.rB.y-S.x+E*k.rA.y,G=C.y+w*k.rB.x-S.y-E*k.rA.x,W=N*B+U*I,j=O*B+G*I,q=W-V.velocityBias,J=j-k.velocityBias;e=v.K,q-=e.col1.x*F+e.col2.x*z,J-=e.col1.y*F+e.col2.y*z;for(;;){e=v.normalMass;var X=-(e.col1.x*q+e.col2.x*J),Y=-(e.col1.y*q+e.col2.y*J);if(X>=0&&Y>=0){m=X-F,d=Y-z,p=m*B,_=m*I,f=d*B,y=d*I,S.x-=R*(p+f),S.y-=R*(_+y),E-=M*(V.rA.x*_-V.rA.y*p+k.rA.x*y-k.rA.y*f),C.x+=D*(p+f),C.y+=D*(_+y),w+=A*(V.rB.x*_-V.rB.y*p+k.rB.x*y-k.rB.y*f),V.normalImpulse=X,k.normalImpulse=Y;break}if(X=-V.normalMass*q,Y=0,W=0,j=v.K.col1.y*X+J,X>=0&&j>=0){m=X-F,d=Y-z,p=m*B,_=m*I,f=d*B,y=d*I,S.x-=R*(p+f),S.y-=R*(_+y),E-=M*(V.rA.x*_-V.rA.y*p+k.rA.x*y-k.rA.y*f),C.x+=D*(p+f),C.y+=D*(_+y),w+=A*(V.rB.x*_-V.rB.y*p+k.rB.x*y-k.rB.y*f),V.normalImpulse=X,k.normalImpulse=Y;break}if(X=0,Y=-k.normalMass*J,W=v.K.col2.x*Y+q,j=0,Y>=0&&W>=0){m=X-F,d=Y-z,p=m*B,_=m*I,f=d*B,y=d*I,S.x-=R*(p+f),S.y-=R*(_+y),E-=M*(V.rA.x*_-V.rA.y*p+k.rA.x*y-k.rA.y*f),C.x+=D*(p+f),C.y+=D*(_+y),w+=A*(V.rB.x*_-V.rB.y*p+k.rB.x*y-k.rB.y*f),V.normalImpulse=X,k.normalImpulse=Y;break}if(X=0,Y=0,W=q,j=J,W>=0&&j>=0){m=X-F,d=Y-z,p=m*B,_=m*I,f=d*B,y=d*I,S.x-=R*(p+f),S.y-=R*(_+y),E-=M*(V.rA.x*_-V.rA.y*p+k.rA.x*y-k.rA.y*f),C.x+=D*(p+f),C.y+=D*(_+y),w+=A*(V.rB.x*_-V.rB.y*p+k.rB.x*y-k.rB.y*f),V.normalImpulse=X,k.normalImpulse=Y;break}break}}x.m_angularVelocity=E,b.m_angularVelocity=w}},m.prototype.FinalizeVelocityConstraints=function(){for(var t=0;t<this.m_constraintCount;++t)for(var e=this.m_constraints[t],i=e.manifold,o=0;o<e.pointCount;++o){var n=i.m_points[o],r=e.points[o];n.m_normalImpulse=r.normalImpulse,n.m_tangentImpulse=r.tangentImpulse}},m.prototype.SolvePositionConstraints=function(t){void 0===t&&(t=0);for(var e=0,i=0;i<this.m_constraintCount;i++){var o=this.m_constraints[i],n=o.bodyA,r=o.bodyB,s=n.m_mass*n.m_invMass,a=n.m_mass*n.m_invI,h=r.m_mass*r.m_invMass,l=r.m_mass*r.m_invI;m.s_psm.Initialize(o);for(var c=m.s_psm.m_normal,u=0;u<o.pointCount;u++){var d=o.points[u],p=m.s_psm.m_points[u],_=m.s_psm.m_separations[u],f=p.x-n.m_sweep.c.x,y=p.y-n.m_sweep.c.y,g=p.x-r.m_sweep.c.x,v=p.y-r.m_sweep.c.y;e=e<_?e:_;var x=T.Clamp(t*(_+b.b2_linearSlop),-b.b2_maxLinearCorrection,0),E=-d.equalizedMass*x,w=E*c.x,S=E*c.y;n.m_sweep.c.x-=s*w,n.m_sweep.c.y-=s*S,n.m_sweep.a-=a*(f*S-y*w),n.SynchronizeTransform(),r.m_sweep.c.x+=h*w,r.m_sweep.c.y+=h*S,r.m_sweep.a+=l*(g*S-v*w),r.SynchronizeTransform()}}return e>-1.5*b.b2_linearSlop},Box2D.postDefs.push(function(){Box2D.Dynamics.Contacts.b2ContactSolver.s_worldManifold=new A,Box2D.Dynamics.Contacts.b2ContactSolver.s_psm=new g}),Box2D.inherit(d,Box2D.Dynamics.Contacts.b2Contact),d.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,d.b2EdgeAndCircleContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},d.Create=function(t){return new d},d.Destroy=function(t,e){},d.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},d.prototype.Evaluate=function(){var i=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof e?this.m_fixtureA.GetShape():null,i.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,o.m_xf)},d.prototype.b2CollideEdgeAndCircle=function(t,e,i,o,n){},Box2D.inherit(p,Box2D.Dynamics.Contacts.b2Contact),p.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,p.b2NullContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},p.prototype.b2NullContact=function(){this.__super.b2Contact.call(this)},p.prototype.Evaluate=function(){},Box2D.inherit(_,Box2D.Dynamics.Contacts.b2Contact),_.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,_.b2PolyAndCircleContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},_.Create=function(t){return new _},_.Destroy=function(t,e){},_.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),b.b2Assert(t.GetType()==o.e_polygonShape),b.b2Assert(e.GetType()==o.e_circleShape)},_.prototype.Evaluate=function(){var e=this.m_fixtureA.m_body,o=this.m_fixtureB.m_body;S.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,e.m_xf,this.m_fixtureB.GetShape()instanceof t?this.m_fixtureB.GetShape():null,o.m_xf)},Box2D.inherit(f,Box2D.Dynamics.Contacts.b2Contact),f.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,f.b2PolyAndEdgeContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},f.Create=function(t){return new f},f.Destroy=function(t,e){},f.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e),b.b2Assert(t.GetType()==o.e_polygonShape),b.b2Assert(e.GetType()==o.e_edgeShape)},f.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof e?this.m_fixtureB.GetShape():null,o.m_xf)},f.prototype.b2CollidePolyAndEdge=function(t,e,i,o,n){},Box2D.inherit(y,Box2D.Dynamics.Contacts.b2Contact),y.prototype.__super=Box2D.Dynamics.Contacts.b2Contact.prototype,y.b2PolygonContact=function(){Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this,arguments)},y.Create=function(t){return new y},y.Destroy=function(t,e){},y.prototype.Reset=function(t,e){this.__super.Reset.call(this,t,e)},y.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),e=this.m_fixtureB.GetBody();S.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape()instanceof i?this.m_fixtureA.GetShape():null,t.m_xf,this.m_fixtureB.GetShape()instanceof i?this.m_fixtureB.GetShape():null,e.m_xf)},g.b2PositionSolverManifold=function(){},g.prototype.b2PositionSolverManifold=function(){this.m_normal=new w,this.m_separations=new Vector_a2j_Number(b.b2_maxManifoldPoints),this.m_points=new Vector(b.b2_maxManifoldPoints);for(var t=0;t<b.b2_maxManifoldPoints;t++)this.m_points[t]=new w},g.prototype.Initialize=function(t){b.b2Assert(t.pointCount>0);var e,i,o=0,n=0,r=0,s=0,a=0;switch(t.type){case R.e_circles:e=t.bodyA.m_xf.R,i=t.localPoint;var h=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),l=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y);e=t.bodyB.m_xf.R,i=t.points[0].localPoint;var c=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),u=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),m=c-h,d=u-l,p=m*m+d*d;if(p>Number.MIN_VALUE*Number.MIN_VALUE){var _=Math.sqrt(p);this.m_normal.x=m/_,this.m_normal.y=d/_}else this.m_normal.x=1,this.m_normal.y=0;this.m_points[0].x=.5*(h+c),this.m_points[0].y=.5*(l+u),this.m_separations[0]=m*this.m_normal.x+d*this.m_normal.y-t.radius;break;case R.e_faceA:for(e=t.bodyA.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyA.m_xf.R,i=t.localPoint,s=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyB.m_xf.R,o=0;o<t.pointCount;++o)i=t.points[o].localPoint,n=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),r=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[o]=(n-s)*this.m_normal.x+(r-a)*this.m_normal.y-t.radius,this.m_points[o].x=n,this.m_points[o].y=r;break;case R.e_faceB:for(e=t.bodyB.m_xf.R,i=t.localPlaneNormal,this.m_normal.x=e.col1.x*i.x+e.col2.x*i.y,this.m_normal.y=e.col1.y*i.x+e.col2.y*i.y,e=t.bodyB.m_xf.R,i=t.localPoint,s=t.bodyB.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),a=t.bodyB.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),e=t.bodyA.m_xf.R,o=0;o<t.pointCount;++o)i=t.points[o].localPoint,n=t.bodyA.m_xf.position.x+(e.col1.x*i.x+e.col2.x*i.y),r=t.bodyA.m_xf.position.y+(e.col1.y*i.x+e.col2.y*i.y),this.m_separations[o]=(n-s)*this.m_normal.x+(r-a)*this.m_normal.y-t.radius,this.m_points[o].Set(n,r);this.m_normal.x*=-1,this.m_normal.y*=-1}},Box2D.postDefs.push(function(){Box2D.Dynamics.Contacts.b2PositionSolverManifold.circlePointA=new w,Box2D.Dynamics.Contacts.b2PositionSolverManifold.circlePointB=new w})}(),function(){var t=(Box2D.Dynamics.b2Body,Box2D.Dynamics.b2BodyDef,Box2D.Dynamics.b2ContactFilter,Box2D.Dynamics.b2ContactImpulse,Box2D.Dynamics.b2ContactListener,Box2D.Dynamics.b2ContactManager,Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.b2DestructionListener,Box2D.Dynamics.b2FilterData,Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2FixtureDef,Box2D.Dynamics.b2Island,Box2D.Dynamics.b2TimeStep,Box2D.Dynamics.b2World,Box2D.Common.Math.b2Mat22),e=(Box2D.Common.Math.b2Mat33,Box2D.Common.Math.b2Math),i=(Box2D.Common.Math.b2Sweep,Box2D.Common.Math.b2Transform,Box2D.Common.Math.b2Vec2),o=(Box2D.Common.Math.b2Vec3,Box2D.Common.b2Color),n=(Box2D.Common.b2internal,Box2D.Common.b2Settings,Box2D.Collision.Shapes.b2CircleShape,Box2D.Collision.Shapes.b2EdgeChainDef,Box2D.Collision.Shapes.b2EdgeShape,Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape,Box2D.Collision.Shapes.b2Shape,Box2D.Dynamics.Controllers.b2BuoyancyController),r=Box2D.Dynamics.Controllers.b2ConstantAccelController,s=Box2D.Dynamics.Controllers.b2ConstantForceController,a=Box2D.Dynamics.Controllers.b2Controller,h=Box2D.Dynamics.Controllers.b2ControllerEdge,l=Box2D.Dynamics.Controllers.b2GravityController,c=Box2D.Dynamics.Controllers.b2TensorDampingController;Box2D.inherit(n,Box2D.Dynamics.Controllers.b2Controller),n.prototype.__super=Box2D.Dynamics.Controllers.b2Controller.prototype,n.b2BuoyancyController=function(){Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.normal=new i(0,-1),this.offset=0,this.density=0,this.velocity=new i(0,0),this.linearDrag=2,this.angularDrag=1,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=null},n.prototype.Step=function(t){if(this.m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var e=this.m_bodyList;e;e=e.nextBody){var o=e.body;if(0!=o.IsAwake()){for(var n=new i,r=new i,s=0,a=0,h=o.GetFixtureList();h;h=h.GetNext()){var l=new i,c=h.GetShape().ComputeSubmergedArea(this.normal,this.offset,o.GetTransform(),l);s+=c,n.x+=c*l.x,n.y+=c*l.y;var u=0;u=(this.useDensity,1),a+=c*u,r.x+=c*l.x*u,r.y+=c*l.y*u}if(n.x/=s,n.y/=s,r.x/=a,r.y/=a,!(s<Number.MIN_VALUE)){var m=this.gravity.GetNegative();m.Multiply(this.density*s),o.ApplyForce(m,r);var d=o.GetLinearVelocityFromWorldPoint(n);d.Subtract(this.velocity),d.Multiply(-this.linearDrag*s),o.ApplyForce(d,n),o.ApplyTorque(-o.GetInertia()/o.GetMass()*s*o.GetAngularVelocity()*this.angularDrag)}}}}},n.prototype.Draw=function(t){var e=1e3,n=new i,r=new i;n.x=this.normal.x*this.offset+this.normal.y*e,n.y=this.normal.y*this.offset-this.normal.x*e,r.x=this.normal.x*this.offset-this.normal.y*e,r.y=this.normal.y*this.offset+this.normal.x*e;var s=new o(0,0,1);t.DrawSegment(n,r,s)},Box2D.inherit(r,Box2D.Dynamics.Controllers.b2Controller),r.prototype.__super=Box2D.Dynamics.Controllers.b2Controller.prototype,r.b2ConstantAccelController=function(){Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.A=new i(0,0)},r.prototype.Step=function(t){for(var e=new i(this.A.x*t.dt,this.A.y*t.dt),o=this.m_bodyList;o;o=o.nextBody){var n=o.body;n.IsAwake()&&n.SetLinearVelocity(new i(n.GetLinearVelocity().x+e.x,n.GetLinearVelocity().y+e.y))}},Box2D.inherit(s,Box2D.Dynamics.Controllers.b2Controller),s.prototype.__super=Box2D.Dynamics.Controllers.b2Controller.prototype,s.b2ConstantForceController=function(){Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.F=new i(0,0)},s.prototype.Step=function(t){for(var e=this.m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.ApplyForce(this.F,i.GetWorldCenter())}},a.b2Controller=function(){},a.prototype.Step=function(t){},a.prototype.Draw=function(t){},a.prototype.AddBody=function(t){var e=new h;e.controller=this,e.body=t,e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList=e,e.nextBody&&(e.nextBody.prevBody=e),this.m_bodyCount++,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList=e,e.nextController&&(e.nextController.prevController=e),t.m_controllerCount++},a.prototype.RemoveBody=function(t){for(var e=t.m_controllerList;e&&e.controller!=this;)e=e.nextController;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),this.m_bodyList==e&&(this.m_bodyList=e.nextBody),t.m_controllerList==e&&(t.m_controllerList=e.nextController),t.m_controllerCount--,this.m_bodyCount--},a.prototype.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body)},a.prototype.GetNext=function(){return this.m_next},a.prototype.GetWorld=function(){return this.m_world},a.prototype.GetBodyList=function(){return this.m_bodyList},h.b2ControllerEdge=function(){},Box2D.inherit(l,Box2D.Dynamics.Controllers.b2Controller),l.prototype.__super=Box2D.Dynamics.Controllers.b2Controller.prototype,l.b2GravityController=function(){Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.G=1,this.invSqr=!0},l.prototype.Step=function(t){var e=null,o=null,n=null,r=0,s=null,a=null,h=null,l=0,c=0,u=0,m=null;if(this.invSqr)for(e=this.m_bodyList;e;e=e.nextBody)for(o=e.body,n=o.GetWorldCenter(),r=o.GetMass(),s=this.m_bodyList;s!=e;s=s.nextBody)a=s.body,h=a.GetWorldCenter(),l=h.x-n.x,c=h.y-n.y,(u=l*l+c*c)<Number.MIN_VALUE||(m=new i(l,c),m.Multiply(this.G/u/Math.sqrt(u)*r*a.GetMass()),o.IsAwake()&&o.ApplyForce(m,n),m.Multiply(-1),a.IsAwake()&&a.ApplyForce(m,h));else for(e=this.m_bodyList;e;e=e.nextBody)for(o=e.body,n=o.GetWorldCenter(),r=o.GetMass(),s=this.m_bodyList;s!=e;s=s.nextBody)a=s.body,h=a.GetWorldCenter(),l=h.x-n.x,c=h.y-n.y,(u=l*l+c*c)<Number.MIN_VALUE||(m=new i(l,c),m.Multiply(this.G/u*r*a.GetMass()),o.IsAwake()&&o.ApplyForce(m,n),m.Multiply(-1),a.IsAwake()&&a.ApplyForce(m,h))},Box2D.inherit(c,Box2D.Dynamics.Controllers.b2Controller),c.prototype.__super=Box2D.Dynamics.Controllers.b2Controller.prototype,c.b2TensorDampingController=function(){Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this,arguments),this.T=new t,this.maxTimestep=0},c.prototype.SetAxisAligned=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.T.col1.x=-t,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-e,this.maxTimestep=t>0||e>0?1/Math.max(t,e):0},c.prototype.Step=function(t){var o=t.dt;if(!(o<=Number.MIN_VALUE)){o>this.maxTimestep&&this.maxTimestep>0&&(o=this.maxTimestep);for(var n=this.m_bodyList;n;n=n.nextBody){var r=n.body;if(r.IsAwake()){var s=r.GetWorldVector(e.MulMV(this.T,r.GetLocalVector(r.GetLinearVelocity())));r.SetLinearVelocity(new i(r.GetLinearVelocity().x+s.x*o,r.GetLinearVelocity().y+s.y*o))}}}}}(),function(){var t=(Box2D.Common.b2Color,Box2D.Common.b2internal,Box2D.Common.b2Settings),e=Box2D.Common.Math.b2Mat22,i=Box2D.Common.Math.b2Mat33,o=Box2D.Common.Math.b2Math,n=(Box2D.Common.Math.b2Sweep,Box2D.Common.Math.b2Transform,Box2D.Common.Math.b2Vec2),r=Box2D.Common.Math.b2Vec3,s=Box2D.Dynamics.Joints.b2DistanceJoint,a=Box2D.Dynamics.Joints.b2DistanceJointDef,h=Box2D.Dynamics.Joints.b2FrictionJoint,l=Box2D.Dynamics.Joints.b2FrictionJointDef,c=Box2D.Dynamics.Joints.b2GearJoint,u=Box2D.Dynamics.Joints.b2GearJointDef,m=Box2D.Dynamics.Joints.b2Jacobian,d=Box2D.Dynamics.Joints.b2Joint,p=Box2D.Dynamics.Joints.b2JointDef,_=Box2D.Dynamics.Joints.b2JointEdge,f=Box2D.Dynamics.Joints.b2LineJoint,y=Box2D.Dynamics.Joints.b2LineJointDef,g=Box2D.Dynamics.Joints.b2MouseJoint,v=Box2D.Dynamics.Joints.b2MouseJointDef,x=Box2D.Dynamics.Joints.b2PrismaticJoint,b=Box2D.Dynamics.Joints.b2PrismaticJointDef,E=Box2D.Dynamics.Joints.b2PulleyJoint,T=Box2D.Dynamics.Joints.b2PulleyJointDef,w=Box2D.Dynamics.Joints.b2RevoluteJoint,S=Box2D.Dynamics.Joints.b2RevoluteJointDef,C=Box2D.Dynamics.Joints.b2WeldJoint,R=Box2D.Dynamics.Joints.b2WeldJointDef;Box2D.Dynamics.b2Body,Box2D.Dynamics.b2BodyDef,Box2D.Dynamics.b2ContactFilter,Box2D.Dynamics.b2ContactImpulse,Box2D.Dynamics.b2ContactListener,Box2D.Dynamics.b2ContactManager,Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.b2DestructionListener,Box2D.Dynamics.b2FilterData,Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2FixtureDef,Box2D.Dynamics.b2Island,Box2D.Dynamics.b2TimeStep,Box2D.Dynamics.b2World;Box2D.inherit(s,Box2D.Dynamics.Joints.b2Joint),s.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,s.b2DistanceJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_u=new n},s.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},s.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},s.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},s.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),0},s.prototype.GetLength=function(){return this.m_length},s.prototype.SetLength=function(t){void 0===t&&(t=0),this.m_length=t},s.prototype.GetFrequency=function(){return this.m_frequencyHz},s.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},s.prototype.GetDampingRatio=function(){return this.m_dampingRatio},s.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},s.prototype.b2DistanceJoint=function(t){this.__super.b2Joint.call(this,t);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_length=t.length,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_impulse=0,this.m_gamma=0,this.m_bias=0},s.prototype.InitVelocityConstraints=function(e){var i,o=0,n=this.m_bodyA,r=this.m_bodyB;i=n.m_xf.R;var s=this.m_localAnchor1.x-n.m_sweep.localCenter.x,a=this.m_localAnchor1.y-n.m_sweep.localCenter.y;o=i.col1.x*s+i.col2.x*a,a=i.col1.y*s+i.col2.y*a,s=o,i=r.m_xf.R;var h=this.m_localAnchor2.x-r.m_sweep.localCenter.x,l=this.m_localAnchor2.y-r.m_sweep.localCenter.y;o=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=o,this.m_u.x=r.m_sweep.c.x+h-n.m_sweep.c.x-s,this.m_u.y=r.m_sweep.c.y+l-n.m_sweep.c.y-a;var c=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);c>t.b2_linearSlop?this.m_u.Multiply(1/c):this.m_u.SetZero();var u=s*this.m_u.y-a*this.m_u.x,m=h*this.m_u.y-l*this.m_u.x,d=n.m_invMass+n.m_invI*u*u+r.m_invMass+r.m_invI*m*m;if(this.m_mass=0!=d?1/d:0,this.m_frequencyHz>0){var p=c-this.m_length,_=2*Math.PI*this.m_frequencyHz,f=2*this.m_mass*this.m_dampingRatio*_,y=this.m_mass*_*_;this.m_gamma=e.dt*(f+e.dt*y),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=p*e.dt*y*this.m_gamma,this.m_mass=d+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}if(e.warmStarting){this.m_impulse*=e.dtRatio;var g=this.m_impulse*this.m_u.x,v=this.m_impulse*this.m_u.y;n.m_linearVelocity.x-=n.m_invMass*g,n.m_linearVelocity.y-=n.m_invMass*v,n.m_angularVelocity-=n.m_invI*(s*v-a*g),r.m_linearVelocity.x+=r.m_invMass*g,r.m_linearVelocity.y+=r.m_invMass*v,r.m_angularVelocity+=r.m_invI*(h*v-l*g)}else this.m_impulse=0},s.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,o=this.m_bodyB;e=i.m_xf.R;var n=this.m_localAnchor1.x-i.m_sweep.localCenter.x,r=this.m_localAnchor1.y-i.m_sweep.localCenter.y,s=e.col1.x*n+e.col2.x*r;r=e.col1.y*n+e.col2.y*r,n=s,e=o.m_xf.R;var a=this.m_localAnchor2.x-o.m_sweep.localCenter.x,h=this.m_localAnchor2.y-o.m_sweep.localCenter.y;s=e.col1.x*a+e.col2.x*h,h=e.col1.y*a+e.col2.y*h,a=s;var l=i.m_linearVelocity.x+-i.m_angularVelocity*r,c=i.m_linearVelocity.y+i.m_angularVelocity*n,u=o.m_linearVelocity.x+-o.m_angularVelocity*h,m=o.m_linearVelocity.y+o.m_angularVelocity*a,d=this.m_u.x*(u-l)+this.m_u.y*(m-c),p=-this.m_mass*(d+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=p;var _=p*this.m_u.x,f=p*this.m_u.y;i.m_linearVelocity.x-=i.m_invMass*_,i.m_linearVelocity.y-=i.m_invMass*f,i.m_angularVelocity-=i.m_invI*(n*f-r*_),o.m_linearVelocity.x+=o.m_invMass*_,o.m_linearVelocity.y+=o.m_invMass*f,o.m_angularVelocity+=o.m_invI*(a*f-h*_)},s.prototype.SolvePositionConstraints=function(e){void 0===e&&(e=0);var i;if(this.m_frequencyHz>0)return!0;var n=this.m_bodyA,r=this.m_bodyB;i=n.m_xf.R;var s=this.m_localAnchor1.x-n.m_sweep.localCenter.x,a=this.m_localAnchor1.y-n.m_sweep.localCenter.y,h=i.col1.x*s+i.col2.x*a;a=i.col1.y*s+i.col2.y*a,s=h,i=r.m_xf.R;var l=this.m_localAnchor2.x-r.m_sweep.localCenter.x,c=this.m_localAnchor2.y-r.m_sweep.localCenter.y;h=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=h;var u=r.m_sweep.c.x+l-n.m_sweep.c.x-s,m=r.m_sweep.c.y+c-n.m_sweep.c.y-a,d=Math.sqrt(u*u+m*m);u/=d,m/=d;var p=d-this.m_length;p=o.Clamp(p,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection);var _=-this.m_mass*p;this.m_u.Set(u,m);var f=_*this.m_u.x,y=_*this.m_u.y;return n.m_sweep.c.x-=n.m_invMass*f,n.m_sweep.c.y-=n.m_invMass*y,n.m_sweep.a-=n.m_invI*(s*y-a*f),r.m_sweep.c.x+=r.m_invMass*f,r.m_sweep.c.y+=r.m_invMass*y,r.m_sweep.a+=r.m_invI*(l*y-c*f),n.SynchronizeTransform(),r.SynchronizeTransform(),o.Abs(p)<t.b2_linearSlop},Box2D.inherit(a,Box2D.Dynamics.Joints.b2JointDef),a.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,a.b2DistanceJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},a.prototype.b2DistanceJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_distanceJoint,this.length=1,this.frequencyHz=0,this.dampingRatio=0},a.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(o));var n=o.x-i.x,r=o.y-i.y;this.length=Math.sqrt(n*n+r*r),this.frequencyHz=0,this.dampingRatio=0},Box2D.inherit(h,Box2D.Dynamics.Joints.b2Joint),h.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,h.b2FrictionJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new n,this.m_localAnchorB=new n,this.m_linearMass=new e,this.m_linearImpulse=new n},h.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},h.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},h.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},h.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_angularImpulse},h.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},h.prototype.GetMaxForce=function(){return this.m_maxForce},h.prototype.SetMaxTorque=function(t){void 0===t&&(t=0),this.m_maxTorque=t},h.prototype.GetMaxTorque=function(){return this.m_maxTorque},h.prototype.b2FrictionJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque},h.prototype.InitVelocityConstraints=function(t){var i,o=0,n=this.m_bodyA,r=this.m_bodyB;i=n.m_xf.R;var s=this.m_localAnchorA.x-n.m_sweep.localCenter.x,a=this.m_localAnchorA.y-n.m_sweep.localCenter.y;o=i.col1.x*s+i.col2.x*a,a=i.col1.y*s+i.col2.y*a,s=o,i=r.m_xf.R;var h=this.m_localAnchorB.x-r.m_sweep.localCenter.x,l=this.m_localAnchorB.y-r.m_sweep.localCenter.y;o=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=o;var c=n.m_invMass,u=r.m_invMass,m=n.m_invI,d=r.m_invI,p=new e;if(p.col1.x=c+u,p.col2.x=0,p.col1.y=0,p.col2.y=c+u,p.col1.x+=m*a*a,p.col2.x+=-m*s*a,p.col1.y+=-m*s*a,p.col2.y+=m*s*s,p.col1.x+=d*l*l,p.col2.x+=-d*h*l,p.col1.y+=-d*h*l,p.col2.y+=d*h*h,p.GetInverse(this.m_linearMass),this.m_angularMass=m+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.x*=t.dtRatio,this.m_linearImpulse.y*=t.dtRatio,this.m_angularImpulse*=t.dtRatio;var _=this.m_linearImpulse;n.m_linearVelocity.x-=c*_.x,n.m_linearVelocity.y-=c*_.y,n.m_angularVelocity-=m*(s*_.y-a*_.x+this.m_angularImpulse),r.m_linearVelocity.x+=u*_.x,r.m_linearVelocity.y+=u*_.y,r.m_angularVelocity+=d*(h*_.y-l*_.x+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0},h.prototype.SolveVelocityConstraints=function(t){var e,i=0,r=this.m_bodyA,s=this.m_bodyB,a=r.m_linearVelocity,h=r.m_angularVelocity,l=s.m_linearVelocity,c=s.m_angularVelocity,u=r.m_invMass,m=s.m_invMass,d=r.m_invI,p=s.m_invI;e=r.m_xf.R;var _=this.m_localAnchorA.x-r.m_sweep.localCenter.x,f=this.m_localAnchorA.y-r.m_sweep.localCenter.y;i=e.col1.x*_+e.col2.x*f,f=e.col1.y*_+e.col2.y*f,_=i,e=s.m_xf.R;var y=this.m_localAnchorB.x-s.m_sweep.localCenter.x,g=this.m_localAnchorB.y-s.m_sweep.localCenter.y;i=e.col1.x*y+e.col2.x*g,g=e.col1.y*y+e.col2.y*g,y=i;var v=0,x=c-h,b=-this.m_angularMass*x,E=this.m_angularImpulse;v=t.dt*this.m_maxTorque,this.m_angularImpulse=o.Clamp(this.m_angularImpulse+b,-v,v),b=this.m_angularImpulse-E,h-=d*b,c+=p*b;var T=l.x-c*g-a.x+h*f,w=l.y+c*y-a.y-h*_,S=o.MulMV(this.m_linearMass,new n(-T,-w)),C=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(S),v=t.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>v*v&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(v)),S=o.SubtractVV(this.m_linearImpulse,C),a.x-=u*S.x,a.y-=u*S.y,h-=d*(_*S.y-f*S.x),l.x+=m*S.x,l.y+=m*S.y,c+=p*(y*S.y-g*S.x),r.m_angularVelocity=h,s.m_angularVelocity=c},h.prototype.SolvePositionConstraints=function(t){return void 0===t&&(t=0),!0},Box2D.inherit(l,Box2D.Dynamics.Joints.b2JointDef),l.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,l.b2FrictionJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},l.prototype.b2FrictionJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_frictionJoint,this.maxForce=0,this.maxTorque=0},l.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i))},Box2D.inherit(c,Box2D.Dynamics.Joints.b2Joint),c.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,c.b2GearJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new n,this.m_groundAnchor2=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_J=new m},c.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},c.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},c.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_J.linearB.x,t*this.m_impulse*this.m_J.linearB.y)},c.prototype.GetReactionTorque=function(t){void 0===t&&(t=0);var e=this.m_bodyB.m_xf.R,i=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,o=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,n=e.col1.x*i+e.col2.x*o;o=e.col1.y*i+e.col2.y*o,i=n;var r=this.m_impulse*this.m_J.linearB.x,s=this.m_impulse*this.m_J.linearB.y;return t*(this.m_impulse*this.m_J.angularB-i*s+o*r)},c.prototype.GetRatio=function(){return this.m_ratio},c.prototype.SetRatio=function(t){void 0===t&&(t=0),this.m_ratio=t},c.prototype.b2GearJoint=function(t){this.__super.b2Joint.call(this,t);var e=parseInt(t.joint1.m_type),i=parseInt(t.joint2.m_type);this.m_revolute1=null,this.m_prismatic1=null,this.m_revolute2=null,this.m_prismatic2=null;var o=0,n=0;this.m_ground1=t.joint1.GetBodyA(),this.m_bodyA=t.joint1.GetBodyB(),e==d.e_revoluteJoint?(this.m_revolute1=t.joint1 instanceof w?t.joint1:null,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),o=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=t.joint1 instanceof x?t.joint1:null,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),o=this.m_prismatic1.GetJointTranslation()),this.m_ground2=t.joint2.GetBodyA(),this.m_bodyB=t.joint2.GetBodyB(),i==d.e_revoluteJoint?(this.m_revolute2=t.joint2 instanceof w?t.joint2:null,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),n=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=t.joint2 instanceof x?t.joint2:null,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),n=this.m_prismatic2.GetJointTranslation()),this.m_ratio=t.ratio,this.m_constant=o+this.m_ratio*n,this.m_impulse=0},c.prototype.InitVelocityConstraints=function(t){
var e,i,o=this.m_ground1,n=this.m_ground2,r=this.m_bodyA,s=this.m_bodyB,a=0,h=0,l=0,c=0,u=0,m=0,d=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,d+=r.m_invI):(e=o.m_xf.R,i=this.m_prismatic1.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,h=e.col1.y*i.x+e.col2.y*i.y,e=r.m_xf.R,l=this.m_localAnchor1.x-r.m_sweep.localCenter.x,c=this.m_localAnchor1.y-r.m_sweep.localCenter.y,m=e.col1.x*l+e.col2.x*c,c=e.col1.y*l+e.col2.y*c,l=m,u=l*h-c*a,this.m_J.linearA.Set(-a,-h),this.m_J.angularA=-u,d+=r.m_invMass+r.m_invI*u*u),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,d+=this.m_ratio*this.m_ratio*s.m_invI):(e=n.m_xf.R,i=this.m_prismatic2.m_localXAxis1,a=e.col1.x*i.x+e.col2.x*i.y,h=e.col1.y*i.x+e.col2.y*i.y,e=s.m_xf.R,l=this.m_localAnchor2.x-s.m_sweep.localCenter.x,c=this.m_localAnchor2.y-s.m_sweep.localCenter.y,m=e.col1.x*l+e.col2.x*c,c=e.col1.y*l+e.col2.y*c,l=m,u=l*h-c*a,this.m_J.linearB.Set(-this.m_ratio*a,-this.m_ratio*h),this.m_J.angularB=-this.m_ratio*u,d+=this.m_ratio*this.m_ratio*(s.m_invMass+s.m_invI*u*u)),this.m_mass=d>0?1/d:0,t.warmStarting?(r.m_linearVelocity.x+=r.m_invMass*this.m_impulse*this.m_J.linearA.x,r.m_linearVelocity.y+=r.m_invMass*this.m_impulse*this.m_J.linearA.y,r.m_angularVelocity+=r.m_invI*this.m_impulse*this.m_J.angularA,s.m_linearVelocity.x+=s.m_invMass*this.m_impulse*this.m_J.linearB.x,s.m_linearVelocity.y+=s.m_invMass*this.m_impulse*this.m_J.linearB.y,s.m_angularVelocity+=s.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},c.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,o=this.m_J.Compute(e.m_linearVelocity,e.m_angularVelocity,i.m_linearVelocity,i.m_angularVelocity),n=-this.m_mass*o;this.m_impulse+=n,e.m_linearVelocity.x+=e.m_invMass*n*this.m_J.linearA.x,e.m_linearVelocity.y+=e.m_invMass*n*this.m_J.linearA.y,e.m_angularVelocity+=e.m_invI*n*this.m_J.angularA,i.m_linearVelocity.x+=i.m_invMass*n*this.m_J.linearB.x,i.m_linearVelocity.y+=i.m_invMass*n*this.m_J.linearB.y,i.m_angularVelocity+=i.m_invI*n*this.m_J.angularB},c.prototype.SolvePositionConstraints=function(e){void 0===e&&(e=0);var i=this.m_bodyA,o=this.m_bodyB,n=0,r=0;n=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),r=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();var s=this.m_constant-(n+this.m_ratio*r),a=-this.m_mass*s;return i.m_sweep.c.x+=i.m_invMass*a*this.m_J.linearA.x,i.m_sweep.c.y+=i.m_invMass*a*this.m_J.linearA.y,i.m_sweep.a+=i.m_invI*a*this.m_J.angularA,o.m_sweep.c.x+=o.m_invMass*a*this.m_J.linearB.x,o.m_sweep.c.y+=o.m_invMass*a*this.m_J.linearB.y,o.m_sweep.a+=o.m_invI*a*this.m_J.angularB,i.SynchronizeTransform(),o.SynchronizeTransform(),0<t.b2_linearSlop},Box2D.inherit(u,Box2D.Dynamics.Joints.b2JointDef),u.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,u.b2GearJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments)},u.prototype.b2GearJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_gearJoint,this.joint1=null,this.joint2=null,this.ratio=1},m.b2Jacobian=function(){this.linearA=new n,this.linearB=new n},m.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},m.prototype.Set=function(t,e,i,o){void 0===e&&(e=0),void 0===o&&(o=0),this.linearA.SetV(t),this.angularA=e,this.linearB.SetV(i),this.angularB=o},m.prototype.Compute=function(t,e,i,o){return void 0===e&&(e=0),void 0===o&&(o=0),this.linearA.x*t.x+this.linearA.y*t.y+this.angularA*e+(this.linearB.x*i.x+this.linearB.y*i.y)+this.angularB*o},d.b2Joint=function(){this.m_edgeA=new _,this.m_edgeB=new _,this.m_localCenterA=new n,this.m_localCenterB=new n},d.prototype.GetType=function(){return this.m_type},d.prototype.GetAnchorA=function(){return null},d.prototype.GetAnchorB=function(){return null},d.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),null},d.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),0},d.prototype.GetBodyA=function(){return this.m_bodyA},d.prototype.GetBodyB=function(){return this.m_bodyB},d.prototype.GetNext=function(){return this.m_next},d.prototype.GetUserData=function(){return this.m_userData},d.prototype.SetUserData=function(t){this.m_userData=t},d.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},d.Create=function(t,e){var i=null;switch(t.type){case d.e_distanceJoint:i=new s(t instanceof a?t:null);break;case d.e_mouseJoint:i=new g(t instanceof v?t:null);break;case d.e_prismaticJoint:i=new x(t instanceof b?t:null);break;case d.e_revoluteJoint:i=new w(t instanceof S?t:null);break;case d.e_pulleyJoint:i=new E(t instanceof T?t:null);break;case d.e_gearJoint:i=new c(t instanceof u?t:null);break;case d.e_lineJoint:i=new f(t instanceof y?t:null);break;case d.e_weldJoint:i=new C(t instanceof R?t:null);break;case d.e_frictionJoint:i=new h(t instanceof l?t:null)}return i},d.Destroy=function(t,e){},d.prototype.b2Joint=function(e){t.b2Assert(e.bodyA!=e.bodyB),this.m_type=e.type,this.m_prev=null,this.m_next=null,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=e.collideConnected,this.m_islandFlag=!1,this.m_userData=e.userData},d.prototype.InitVelocityConstraints=function(t){},d.prototype.SolveVelocityConstraints=function(t){},d.prototype.FinalizeVelocityConstraints=function(){},d.prototype.SolvePositionConstraints=function(t){return void 0===t&&(t=0),!1},Box2D.postDefs.push(function(){Box2D.Dynamics.Joints.b2Joint.e_unknownJoint=0,Box2D.Dynamics.Joints.b2Joint.e_revoluteJoint=1,Box2D.Dynamics.Joints.b2Joint.e_prismaticJoint=2,Box2D.Dynamics.Joints.b2Joint.e_distanceJoint=3,Box2D.Dynamics.Joints.b2Joint.e_pulleyJoint=4,Box2D.Dynamics.Joints.b2Joint.e_mouseJoint=5,Box2D.Dynamics.Joints.b2Joint.e_gearJoint=6,Box2D.Dynamics.Joints.b2Joint.e_lineJoint=7,Box2D.Dynamics.Joints.b2Joint.e_weldJoint=8,Box2D.Dynamics.Joints.b2Joint.e_frictionJoint=9,Box2D.Dynamics.Joints.b2Joint.e_inactiveLimit=0,Box2D.Dynamics.Joints.b2Joint.e_atLowerLimit=1,Box2D.Dynamics.Joints.b2Joint.e_atUpperLimit=2,Box2D.Dynamics.Joints.b2Joint.e_equalLimits=3}),p.b2JointDef=function(){},p.prototype.b2JointDef=function(){this.type=d.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1},_.b2JointEdge=function(){},Box2D.inherit(f,Box2D.Dynamics.Joints.b2Joint),f.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,f.b2LineJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_localXAxis1=new n,this.m_localYAxis1=new n,this.m_axis=new n,this.m_perp=new n,this.m_K=new e,this.m_impulse=new n},f.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},f.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},f.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},f.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},f.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),o=e.GetWorldPoint(this.m_localAnchor2),n=o.x-i.x,r=o.y-i.y,s=t.GetWorldVector(this.m_localXAxis1);return s.x*n+s.y*r},f.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var o=this.m_localAnchor1.x-e.m_sweep.localCenter.x,n=this.m_localAnchor1.y-e.m_sweep.localCenter.y,r=t.col1.x*o+t.col2.x*n;n=t.col1.y*o+t.col2.y*n,o=r,t=i.m_xf.R;var s=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;r=t.col1.x*s+t.col2.x*a,a=t.col1.y*s+t.col2.y*a,s=r;var h=e.m_sweep.c.x+o,l=e.m_sweep.c.y+n,c=i.m_sweep.c.x+s,u=i.m_sweep.c.y+a,m=c-h,d=u-l,p=e.GetWorldVector(this.m_localXAxis1),_=e.m_linearVelocity,f=i.m_linearVelocity,y=e.m_angularVelocity,g=i.m_angularVelocity;return m*(-y*p.y)+d*(y*p.x)+(p.x*(f.x+-g*a-_.x- -y*n)+p.y*(f.y+g*s-_.y-y*o))},f.prototype.IsLimitEnabled=function(){return this.m_enableLimit},f.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},f.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},f.prototype.GetUpperLimit=function(){return this.m_upperTranslation},f.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},f.prototype.IsMotorEnabled=function(){return this.m_enableMotor},f.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},f.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},f.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},f.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},f.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},f.prototype.GetMotorForce=function(){return this.m_motorImpulse},f.prototype.b2LineJoint=function(t){this.__super.b2Joint.call(this,t);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=d.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},f.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,r=this.m_bodyB,s=0;this.m_localCenterA.SetV(n.GetLocalCenter()),this.m_localCenterB.SetV(r.GetLocalCenter());var a=n.GetTransform();r.GetTransform();i=n.m_xf.R;var h=this.m_localAnchor1.x-this.m_localCenterA.x,l=this.m_localAnchor1.y-this.m_localCenterA.y;s=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=s,i=r.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,u=this.m_localAnchor2.y-this.m_localCenterB.y;s=i.col1.x*c+i.col2.x*u,u=i.col1.y*c+i.col2.y*u,c=s;var m=r.m_sweep.c.x+c-n.m_sweep.c.x-h,p=r.m_sweep.c.y+u-n.m_sweep.c.y-l;this.m_invMassA=n.m_invMass,this.m_invMassB=r.m_invMass,this.m_invIA=n.m_invI,this.m_invIB=r.m_invI,this.m_axis.SetV(o.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(m+h)*this.m_axis.y-(p+l)*this.m_axis.x,this.m_a2=c*this.m_axis.y-u*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(o.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(m+h)*this.m_perp.y-(p+l)*this.m_perp.x,this.m_s2=c*this.m_perp.y-u*this.m_perp.x;var _=this.m_invMassA,f=this.m_invMassB,y=this.m_invIA,g=this.m_invIB;if(this.m_K.col1.x=_+f+y*this.m_s1*this.m_s1+g*this.m_s2*this.m_s2,this.m_K.col1.y=y*this.m_s1*this.m_a1+g*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=_+f+y*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2,this.m_enableLimit){var v=this.m_axis.x*m+this.m_axis.y*p;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=d.e_equalLimits:v<=this.m_lowerTranslation?this.m_limitState!=d.e_atLowerLimit&&(this.m_limitState=d.e_atLowerLimit,this.m_impulse.y=0):v>=this.m_upperTranslation?this.m_limitState!=d.e_atUpperLimit&&(this.m_limitState=d.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=d.e_inactiveLimit,this.m_impulse.y=0)}else this.m_limitState=d.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,b=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,E=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,T=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;n.m_linearVelocity.x-=this.m_invMassA*x,n.m_linearVelocity.y-=this.m_invMassA*b,n.m_angularVelocity-=this.m_invIA*E,r.m_linearVelocity.x+=this.m_invMassB*x,r.m_linearVelocity.y+=this.m_invMassB*b,r.m_angularVelocity+=this.m_invIB*T}else this.m_impulse.SetZero(),this.m_motorImpulse=0},f.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,r=e.m_linearVelocity,s=e.m_angularVelocity,a=i.m_linearVelocity,h=i.m_angularVelocity,l=0,c=0,u=0,m=0;if(this.m_enableMotor&&this.m_limitState!=d.e_equalLimits){var p=this.m_axis.x*(a.x-r.x)+this.m_axis.y*(a.y-r.y)+this.m_a2*h-this.m_a1*s,_=this.m_motorMass*(this.m_motorSpeed-p),f=this.m_motorImpulse,y=t.dt*this.m_maxMotorForce;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+_,-y,y),_=this.m_motorImpulse-f,l=_*this.m_axis.x,c=_*this.m_axis.y,u=_*this.m_a1,m=_*this.m_a2,r.x-=this.m_invMassA*l,r.y-=this.m_invMassA*c,s-=this.m_invIA*u,a.x+=this.m_invMassB*l,a.y+=this.m_invMassB*c,h+=this.m_invIB*m}var g=this.m_perp.x*(a.x-r.x)+this.m_perp.y*(a.y-r.y)+this.m_s2*h-this.m_s1*s;if(this.m_enableLimit&&this.m_limitState!=d.e_inactiveLimit){var v=this.m_axis.x*(a.x-r.x)+this.m_axis.y*(a.y-r.y)+this.m_a2*h-this.m_a1*s,x=this.m_impulse.Copy(),b=this.m_K.Solve(new n,-g,-v);this.m_impulse.Add(b),this.m_limitState==d.e_atLowerLimit?this.m_impulse.y=o.Max(this.m_impulse.y,0):this.m_limitState==d.e_atUpperLimit&&(this.m_impulse.y=o.Min(this.m_impulse.y,0));var E=-g-(this.m_impulse.y-x.y)*this.m_K.col2.x,T=0;T=0!=this.m_K.col1.x?E/this.m_K.col1.x+x.x:x.x,this.m_impulse.x=T,b.x=this.m_impulse.x-x.x,b.y=this.m_impulse.y-x.y,l=b.x*this.m_perp.x+b.y*this.m_axis.x,c=b.x*this.m_perp.y+b.y*this.m_axis.y,u=b.x*this.m_s1+b.y*this.m_a1,m=b.x*this.m_s2+b.y*this.m_a2,r.x-=this.m_invMassA*l,r.y-=this.m_invMassA*c,s-=this.m_invIA*u,a.x+=this.m_invMassB*l,a.y+=this.m_invMassB*c,h+=this.m_invIB*m}else{var w=0;w=0!=this.m_K.col1.x?-g/this.m_K.col1.x:0,this.m_impulse.x+=w,l=w*this.m_perp.x,c=w*this.m_perp.y,u=w*this.m_s1,m=w*this.m_s2,r.x-=this.m_invMassA*l,r.y-=this.m_invMassA*c,s-=this.m_invIA*u,a.x+=this.m_invMassB*l,a.y+=this.m_invMassB*c,h+=this.m_invIB*m}e.m_linearVelocity.SetV(r),e.m_angularVelocity=s,i.m_linearVelocity.SetV(a),i.m_angularVelocity=h},f.prototype.SolvePositionConstraints=function(i){void 0===i&&(i=0);var r,s=this.m_bodyA,a=this.m_bodyB,h=s.m_sweep.c,l=s.m_sweep.a,c=a.m_sweep.c,u=a.m_sweep.a,m=0,d=0,p=0,_=0,f=0,y=0,g=0,v=!1,x=0,b=e.FromAngle(l),E=e.FromAngle(u);r=b;var T=this.m_localAnchor1.x-this.m_localCenterA.x,w=this.m_localAnchor1.y-this.m_localCenterA.y;m=r.col1.x*T+r.col2.x*w,w=r.col1.y*T+r.col2.y*w,T=m,r=E;var S=this.m_localAnchor2.x-this.m_localCenterB.x,C=this.m_localAnchor2.y-this.m_localCenterB.y;m=r.col1.x*S+r.col2.x*C,C=r.col1.y*S+r.col2.y*C,S=m;var R=c.x+S-h.x-T,M=c.y+C-h.y-w;if(this.m_enableLimit){this.m_axis=o.MulMV(b,this.m_localXAxis1),this.m_a1=(R+T)*this.m_axis.y-(M+w)*this.m_axis.x,this.m_a2=S*this.m_axis.y-C*this.m_axis.x;var D=this.m_axis.x*R+this.m_axis.y*M;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(x=o.Clamp(D,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),y=o.Abs(D),v=!0):D<=this.m_lowerTranslation?(x=o.Clamp(D-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),y=this.m_lowerTranslation-D,v=!0):D>=this.m_upperTranslation&&(x=o.Clamp(D-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),y=D-this.m_upperTranslation,v=!0)}this.m_perp=o.MulMV(b,this.m_localYAxis1),this.m_s1=(R+T)*this.m_perp.y-(M+w)*this.m_perp.x,this.m_s2=S*this.m_perp.y-C*this.m_perp.x;var A=new n,B=this.m_perp.x*R+this.m_perp.y*M;if(y=o.Max(y,o.Abs(B)),g=0,v)d=this.m_invMassA,p=this.m_invMassB,_=this.m_invIA,f=this.m_invIB,this.m_K.col1.x=d+p+_*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2,this.m_K.col1.y=_*this.m_s1*this.m_a1+f*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=d+p+_*this.m_a1*this.m_a1+f*this.m_a2*this.m_a2,this.m_K.Solve(A,-B,-x);else{d=this.m_invMassA,p=this.m_invMassB,_=this.m_invIA,f=this.m_invIB;var I=d+p+_*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2,H=0;H=0!=I?-B/I:0,A.x=H,A.y=0}var P=A.x*this.m_perp.x+A.y*this.m_axis.x,L=A.x*this.m_perp.y+A.y*this.m_axis.y,V=A.x*this.m_s1+A.y*this.m_a1,k=A.x*this.m_s2+A.y*this.m_a2;return h.x-=this.m_invMassA*P,h.y-=this.m_invMassA*L,l-=this.m_invIA*V,c.x+=this.m_invMassB*P,c.y+=this.m_invMassB*L,u+=this.m_invIB*k,s.m_sweep.a=l,a.m_sweep.a=u,s.SynchronizeTransform(),a.SynchronizeTransform(),y<=t.b2_linearSlop&&g<=t.b2_angularSlop},Box2D.inherit(y,Box2D.Dynamics.Joints.b2JointDef),y.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,y.b2LineJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n,this.localAxisA=new n},y.prototype.b2LineJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},y.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(o)},Box2D.inherit(g,Box2D.Dynamics.Joints.b2Joint),g.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,g.b2MouseJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.m_localAnchor=new n,this.m_target=new n,this.m_impulse=new n,this.m_mass=new e,this.m_C=new n},g.prototype.GetAnchorA=function(){return this.m_target},g.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},g.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},g.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),0},g.prototype.GetTarget=function(){return this.m_target},g.prototype.SetTarget=function(t){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=t},g.prototype.GetMaxForce=function(){return this.m_maxForce},g.prototype.SetMaxForce=function(t){void 0===t&&(t=0),this.m_maxForce=t},g.prototype.GetFrequency=function(){return this.m_frequencyHz},g.prototype.SetFrequency=function(t){void 0===t&&(t=0),this.m_frequencyHz=t},g.prototype.GetDampingRatio=function(){return this.m_dampingRatio},g.prototype.SetDampingRatio=function(t){void 0===t&&(t=0),this.m_dampingRatio=t},g.prototype.b2MouseJoint=function(t){this.__super.b2Joint.call(this,t),this.m_target.SetV(t.target);var e=this.m_target.x-this.m_bodyB.m_xf.position.x,i=this.m_target.y-this.m_bodyB.m_xf.position.y,o=this.m_bodyB.m_xf.R;this.m_localAnchor.x=e*o.col1.x+i*o.col1.y,this.m_localAnchor.y=e*o.col2.x+i*o.col2.y,this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0},g.prototype.InitVelocityConstraints=function(t){var e=this.m_bodyB,i=e.GetMass(),o=2*Math.PI*this.m_frequencyHz,n=2*i*this.m_dampingRatio*o,r=i*o*o;this.m_gamma=t.dt*(n+t.dt*r),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=t.dt*r*this.m_gamma;var s;s=e.m_xf.R;var a=this.m_localAnchor.x-e.m_sweep.localCenter.x,h=this.m_localAnchor.y-e.m_sweep.localCenter.y,l=s.col1.x*a+s.col2.x*h;h=s.col1.y*a+s.col2.y*h,a=l;var c=e.m_invMass,u=e.m_invI;this.K1.col1.x=c,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=c,this.K2.col1.x=u*h*h,this.K2.col2.x=-u*a*h,this.K2.col1.y=-u*a*h,this.K2.col2.y=u*a*a,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=e.m_sweep.c.x+a-this.m_target.x,this.m_C.y=e.m_sweep.c.y+h-this.m_target.y,e.m_angularVelocity*=.98,this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,e.m_linearVelocity.x+=c*this.m_impulse.x,e.m_linearVelocity.y+=c*this.m_impulse.y,e.m_angularVelocity+=u*(a*this.m_impulse.y-h*this.m_impulse.x)},g.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyB,o=0,n=0;e=i.m_xf.R;var r=this.m_localAnchor.x-i.m_sweep.localCenter.x,s=this.m_localAnchor.y-i.m_sweep.localCenter.y;o=e.col1.x*r+e.col2.x*s,s=e.col1.y*r+e.col2.y*s,r=o;var a=i.m_linearVelocity.x+-i.m_angularVelocity*s,h=i.m_linearVelocity.y+i.m_angularVelocity*r;e=this.m_mass,o=a+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,n=h+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var l=-(e.col1.x*o+e.col2.x*n),c=-(e.col1.y*o+e.col2.y*n),u=this.m_impulse.x,m=this.m_impulse.y;this.m_impulse.x+=l,this.m_impulse.y+=c;var d=t.dt*this.m_maxForce;this.m_impulse.LengthSquared()>d*d&&this.m_impulse.Multiply(d/this.m_impulse.Length()),l=this.m_impulse.x-u,c=this.m_impulse.y-m,i.m_linearVelocity.x+=i.m_invMass*l,i.m_linearVelocity.y+=i.m_invMass*c,i.m_angularVelocity+=i.m_invI*(r*c-s*l)},g.prototype.SolvePositionConstraints=function(t){return void 0===t&&(t=0),!0},Box2D.inherit(v,Box2D.Dynamics.Joints.b2JointDef),v.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,v.b2MouseJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.target=new n},v.prototype.b2MouseJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},Box2D.inherit(x,Box2D.Dynamics.Joints.b2Joint),x.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,x.b2PrismaticJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_localXAxis1=new n,this.m_localYAxis1=new n,this.m_axis=new n,this.m_perp=new n,this.m_K=new i,this.m_impulse=new r},x.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},x.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},x.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},x.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.y},x.prototype.GetJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchor1),o=e.GetWorldPoint(this.m_localAnchor2),n=o.x-i.x,r=o.y-i.y,s=t.GetWorldVector(this.m_localXAxis1);return s.x*n+s.y*r},x.prototype.GetJointSpeed=function(){var t,e=this.m_bodyA,i=this.m_bodyB;t=e.m_xf.R;var o=this.m_localAnchor1.x-e.m_sweep.localCenter.x,n=this.m_localAnchor1.y-e.m_sweep.localCenter.y,r=t.col1.x*o+t.col2.x*n;n=t.col1.y*o+t.col2.y*n,o=r,t=i.m_xf.R;var s=this.m_localAnchor2.x-i.m_sweep.localCenter.x,a=this.m_localAnchor2.y-i.m_sweep.localCenter.y;r=t.col1.x*s+t.col2.x*a,a=t.col1.y*s+t.col2.y*a,s=r;var h=e.m_sweep.c.x+o,l=e.m_sweep.c.y+n,c=i.m_sweep.c.x+s,u=i.m_sweep.c.y+a,m=c-h,d=u-l,p=e.GetWorldVector(this.m_localXAxis1),_=e.m_linearVelocity,f=i.m_linearVelocity,y=e.m_angularVelocity,g=i.m_angularVelocity;return m*(-y*p.y)+d*(y*p.x)+(p.x*(f.x+-g*a-_.x- -y*n)+p.y*(f.y+g*s-_.y-y*o))},x.prototype.IsLimitEnabled=function(){return this.m_enableLimit},x.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},x.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},x.prototype.GetUpperLimit=function(){return this.m_upperTranslation},x.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e},x.prototype.IsMotorEnabled=function(){return this.m_enableMotor},x.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},x.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},x.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},x.prototype.SetMaxMotorForce=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},x.prototype.GetMotorForce=function(){return this.m_motorImpulse},x.prototype.b2PrismaticJoint=function(t){this.__super.b2Joint.call(this,t);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=d.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},x.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,r=this.m_bodyB,s=0;this.m_localCenterA.SetV(n.GetLocalCenter()),this.m_localCenterB.SetV(r.GetLocalCenter());var a=n.GetTransform();r.GetTransform();i=n.m_xf.R;var h=this.m_localAnchor1.x-this.m_localCenterA.x,l=this.m_localAnchor1.y-this.m_localCenterA.y;s=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=s,i=r.m_xf.R;var c=this.m_localAnchor2.x-this.m_localCenterB.x,u=this.m_localAnchor2.y-this.m_localCenterB.y;s=i.col1.x*c+i.col2.x*u,u=i.col1.y*c+i.col2.y*u,c=s;var m=r.m_sweep.c.x+c-n.m_sweep.c.x-h,p=r.m_sweep.c.y+u-n.m_sweep.c.y-l;this.m_invMassA=n.m_invMass,this.m_invMassB=r.m_invMass,this.m_invIA=n.m_invI,this.m_invIB=r.m_invI,this.m_axis.SetV(o.MulMV(a.R,this.m_localXAxis1)),this.m_a1=(m+h)*this.m_axis.y-(p+l)*this.m_axis.x,this.m_a2=c*this.m_axis.y-u*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(o.MulMV(a.R,this.m_localYAxis1)),this.m_s1=(m+h)*this.m_perp.y-(p+l)*this.m_perp.x,this.m_s2=c*this.m_perp.y-u*this.m_perp.x;var _=this.m_invMassA,f=this.m_invMassB,y=this.m_invIA,g=this.m_invIB;if(this.m_K.col1.x=_+f+y*this.m_s1*this.m_s1+g*this.m_s2*this.m_s2,this.m_K.col1.y=y*this.m_s1+g*this.m_s2,this.m_K.col1.z=y*this.m_s1*this.m_a1+g*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=y+g,this.m_K.col2.z=y*this.m_a1+g*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=_+f+y*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2,this.m_enableLimit){var v=this.m_axis.x*m+this.m_axis.y*p;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?this.m_limitState=d.e_equalLimits:v<=this.m_lowerTranslation?this.m_limitState!=d.e_atLowerLimit&&(this.m_limitState=d.e_atLowerLimit,this.m_impulse.z=0):v>=this.m_upperTranslation?this.m_limitState!=d.e_atUpperLimit&&(this.m_limitState=d.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=d.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=d.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,b=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,E=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,T=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;n.m_linearVelocity.x-=this.m_invMassA*x,n.m_linearVelocity.y-=this.m_invMassA*b,n.m_angularVelocity-=this.m_invIA*E,r.m_linearVelocity.x+=this.m_invMassB*x,r.m_linearVelocity.y+=this.m_invMassB*b,r.m_angularVelocity+=this.m_invIB*T}else this.m_impulse.SetZero(),this.m_motorImpulse=0},x.prototype.SolveVelocityConstraints=function(t){var e=this.m_bodyA,i=this.m_bodyB,s=e.m_linearVelocity,a=e.m_angularVelocity,h=i.m_linearVelocity,l=i.m_angularVelocity,c=0,u=0,m=0,p=0;if(this.m_enableMotor&&this.m_limitState!=d.e_equalLimits){var _=this.m_axis.x*(h.x-s.x)+this.m_axis.y*(h.y-s.y)+this.m_a2*l-this.m_a1*a,f=this.m_motorMass*(this.m_motorSpeed-_),y=this.m_motorImpulse,g=t.dt*this.m_maxMotorForce;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+f,-g,g),f=this.m_motorImpulse-y,c=f*this.m_axis.x,u=f*this.m_axis.y,m=f*this.m_a1,p=f*this.m_a2,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*u,a-=this.m_invIA*m,h.x+=this.m_invMassB*c,h.y+=this.m_invMassB*u,l+=this.m_invIB*p}var v=this.m_perp.x*(h.x-s.x)+this.m_perp.y*(h.y-s.y)+this.m_s2*l-this.m_s1*a,x=l-a;if(this.m_enableLimit&&this.m_limitState!=d.e_inactiveLimit){var b=this.m_axis.x*(h.x-s.x)+this.m_axis.y*(h.y-s.y)+this.m_a2*l-this.m_a1*a,E=this.m_impulse.Copy(),T=this.m_K.Solve33(new r,-v,-x,-b);this.m_impulse.Add(T),this.m_limitState==d.e_atLowerLimit?this.m_impulse.z=o.Max(this.m_impulse.z,0):this.m_limitState==d.e_atUpperLimit&&(this.m_impulse.z=o.Min(this.m_impulse.z,0));var w=-v-(this.m_impulse.z-E.z)*this.m_K.col3.x,S=-x-(this.m_impulse.z-E.z)*this.m_K.col3.y,C=this.m_K.Solve22(new n,w,S);C.x+=E.x,C.y+=E.y,this.m_impulse.x=C.x,this.m_impulse.y=C.y,T.x=this.m_impulse.x-E.x,T.y=this.m_impulse.y-E.y,T.z=this.m_impulse.z-E.z,c=T.x*this.m_perp.x+T.z*this.m_axis.x,u=T.x*this.m_perp.y+T.z*this.m_axis.y,m=T.x*this.m_s1+T.y+T.z*this.m_a1,p=T.x*this.m_s2+T.y+T.z*this.m_a2,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*u,a-=this.m_invIA*m,h.x+=this.m_invMassB*c,h.y+=this.m_invMassB*u,l+=this.m_invIB*p}else{var R=this.m_K.Solve22(new n,-v,-x);this.m_impulse.x+=R.x,this.m_impulse.y+=R.y,c=R.x*this.m_perp.x,u=R.x*this.m_perp.y,m=R.x*this.m_s1+R.y,p=R.x*this.m_s2+R.y,s.x-=this.m_invMassA*c,s.y-=this.m_invMassA*u,a-=this.m_invIA*m,h.x+=this.m_invMassB*c,h.y+=this.m_invMassB*u,l+=this.m_invIB*p}e.m_linearVelocity.SetV(s),e.m_angularVelocity=a,i.m_linearVelocity.SetV(h),i.m_angularVelocity=l},x.prototype.SolvePositionConstraints=function(i){void 0===i&&(i=0);var s,a=this.m_bodyA,h=this.m_bodyB,l=a.m_sweep.c,c=a.m_sweep.a,u=h.m_sweep.c,m=h.m_sweep.a,d=0,p=0,_=0,f=0,y=0,g=0,v=0,x=!1,b=0,E=e.FromAngle(c),T=e.FromAngle(m);s=E;var w=this.m_localAnchor1.x-this.m_localCenterA.x,S=this.m_localAnchor1.y-this.m_localCenterA.y;d=s.col1.x*w+s.col2.x*S,S=s.col1.y*w+s.col2.y*S,w=d,s=T;var C=this.m_localAnchor2.x-this.m_localCenterB.x,R=this.m_localAnchor2.y-this.m_localCenterB.y;d=s.col1.x*C+s.col2.x*R,R=s.col1.y*C+s.col2.y*R,C=d;var M=u.x+C-l.x-w,D=u.y+R-l.y-S;if(this.m_enableLimit){this.m_axis=o.MulMV(E,this.m_localXAxis1),this.m_a1=(M+w)*this.m_axis.y-(D+S)*this.m_axis.x,this.m_a2=C*this.m_axis.y-R*this.m_axis.x;var A=this.m_axis.x*M+this.m_axis.y*D;o.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*t.b2_linearSlop?(b=o.Clamp(A,-t.b2_maxLinearCorrection,t.b2_maxLinearCorrection),g=o.Abs(A),x=!0):A<=this.m_lowerTranslation?(b=o.Clamp(A-this.m_lowerTranslation+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),g=this.m_lowerTranslation-A,x=!0):A>=this.m_upperTranslation&&(b=o.Clamp(A-this.m_upperTranslation+t.b2_linearSlop,0,t.b2_maxLinearCorrection),g=A-this.m_upperTranslation,x=!0)}this.m_perp=o.MulMV(E,this.m_localYAxis1),this.m_s1=(M+w)*this.m_perp.y-(D+S)*this.m_perp.x,this.m_s2=C*this.m_perp.y-R*this.m_perp.x;var B=new r,I=this.m_perp.x*M+this.m_perp.y*D,H=m-c-this.m_refAngle;if(g=o.Max(g,o.Abs(I)),v=o.Abs(H),x)p=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,y=this.m_invIB,this.m_K.col1.x=p+_+f*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,this.m_K.col1.y=f*this.m_s1+y*this.m_s2,this.m_K.col1.z=f*this.m_s1*this.m_a1+y*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=f+y,this.m_K.col2.z=f*this.m_a1+y*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,
this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=p+_+f*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_K.Solve33(B,-I,-H,-b);else{p=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,y=this.m_invIB;var P=p+_+f*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,L=f*this.m_s1+y*this.m_s2,V=f+y;this.m_K.col1.Set(P,L,0),this.m_K.col2.Set(L,V,0);var k=this.m_K.Solve22(new n,-I,-H);B.x=k.x,B.y=k.y,B.z=0}var F=B.x*this.m_perp.x+B.z*this.m_axis.x,z=B.x*this.m_perp.y+B.z*this.m_axis.y,N=B.x*this.m_s1+B.y+B.z*this.m_a1,U=B.x*this.m_s2+B.y+B.z*this.m_a2;return l.x-=this.m_invMassA*F,l.y-=this.m_invMassA*z,c-=this.m_invIA*N,u.x+=this.m_invMassB*F,u.y+=this.m_invMassB*z,m+=this.m_invIB*U,a.m_sweep.a=c,h.m_sweep.a=m,a.SynchronizeTransform(),h.SynchronizeTransform(),g<=t.b2_linearSlop&&v<=t.b2_angularSlop},Box2D.inherit(b,Box2D.Dynamics.Joints.b2JointDef),b.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,b.b2PrismaticJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n,this.localAxisA=new n},b.prototype.b2PrismaticJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},b.prototype.Initialize=function(t,e,i,o){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.localAxisA=this.bodyA.GetLocalVector(o),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},Box2D.inherit(E,Box2D.Dynamics.Joints.b2Joint),E.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,E.b2PulleyJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_groundAnchor1=new n,this.m_groundAnchor2=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_u1=new n,this.m_u2=new n},E.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},E.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},E.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse*this.m_u2.x,t*this.m_impulse*this.m_u2.y)},E.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),0},E.prototype.GetGroundAnchorA=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor1),t},E.prototype.GetGroundAnchorB=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor2),t},E.prototype.GetLength1=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),e=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,o=t.x-e,n=t.y-i;return Math.sqrt(o*o+n*n)},E.prototype.GetLength2=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),e=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,i=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,o=t.x-e,n=t.y-i;return Math.sqrt(o*o+n*n)},E.prototype.GetRatio=function(){return this.m_ratio},E.prototype.b2PulleyJoint=function(t){this.__super.b2Joint.call(this,t);this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=t.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=t.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=t.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=t.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_maxLength1=o.Min(t.maxLengthA,this.m_constant-this.m_ratio*E.b2_minPulleyLength),this.m_maxLength2=o.Min(t.maxLengthB,(this.m_constant-E.b2_minPulleyLength)/this.m_ratio),this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},E.prototype.InitVelocityConstraints=function(e){var i,o=this.m_bodyA,n=this.m_bodyB;i=o.m_xf.R;var r=this.m_localAnchor1.x-o.m_sweep.localCenter.x,s=this.m_localAnchor1.y-o.m_sweep.localCenter.y,a=i.col1.x*r+i.col2.x*s;s=i.col1.y*r+i.col2.y*s,r=a,i=n.m_xf.R;var h=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;a=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=a;var c=o.m_sweep.c.x+r,u=o.m_sweep.c.y+s,m=n.m_sweep.c.x+h,p=n.m_sweep.c.y+l,_=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,f=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,y=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,g=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(c-_,u-f),this.m_u2.Set(m-y,p-g);var v=this.m_u1.Length(),x=this.m_u2.Length();v>t.b2_linearSlop?this.m_u1.Multiply(1/v):this.m_u1.SetZero(),x>t.b2_linearSlop?this.m_u2.Multiply(1/x):this.m_u2.SetZero(),this.m_constant-v-this.m_ratio*x>0?(this.m_state=d.e_inactiveLimit,this.m_impulse=0):this.m_state=d.e_atUpperLimit,v<this.m_maxLength1?(this.m_limitState1=d.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=d.e_atUpperLimit,x<this.m_maxLength2?(this.m_limitState2=d.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=d.e_atUpperLimit;var b=r*this.m_u1.y-s*this.m_u1.x,E=h*this.m_u2.y-l*this.m_u2.x;if(this.m_limitMass1=o.m_invMass+o.m_invI*b*b,this.m_limitMass2=n.m_invMass+n.m_invI*E*E,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,e.warmStarting){this.m_impulse*=e.dtRatio,this.m_limitImpulse1*=e.dtRatio,this.m_limitImpulse2*=e.dtRatio;var T=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,w=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,S=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,C=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;o.m_linearVelocity.x+=o.m_invMass*T,o.m_linearVelocity.y+=o.m_invMass*w,o.m_angularVelocity+=o.m_invI*(r*w-s*T),n.m_linearVelocity.x+=n.m_invMass*S,n.m_linearVelocity.y+=n.m_invMass*C,n.m_angularVelocity+=n.m_invI*(h*C-l*S)}else this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},E.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB;e=i.m_xf.R;var r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y,a=e.col1.x*r+e.col2.x*s;s=e.col1.y*r+e.col2.y*s,r=a,e=n.m_xf.R;var h=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;a=e.col1.x*h+e.col2.x*l,l=e.col1.y*h+e.col2.y*l,h=a;var c=0,u=0,m=0,p=0,_=0,f=0,y=0,g=0,v=0,x=0,b=0;this.m_state==d.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*s,u=i.m_linearVelocity.y+i.m_angularVelocity*r,m=n.m_linearVelocity.x+-n.m_angularVelocity*l,p=n.m_linearVelocity.y+n.m_angularVelocity*h,v=-(this.m_u1.x*c+this.m_u1.y*u)-this.m_ratio*(this.m_u2.x*m+this.m_u2.y*p),x=this.m_pulleyMass*-v,b=this.m_impulse,this.m_impulse=o.Max(0,this.m_impulse+x),x=this.m_impulse-b,_=-x*this.m_u1.x,f=-x*this.m_u1.y,y=-this.m_ratio*x*this.m_u2.x,g=-this.m_ratio*x*this.m_u2.y,i.m_linearVelocity.x+=i.m_invMass*_,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(r*f-s*_),n.m_linearVelocity.x+=n.m_invMass*y,n.m_linearVelocity.y+=n.m_invMass*g,n.m_angularVelocity+=n.m_invI*(h*g-l*y)),this.m_limitState1==d.e_atUpperLimit&&(c=i.m_linearVelocity.x+-i.m_angularVelocity*s,u=i.m_linearVelocity.y+i.m_angularVelocity*r,v=-(this.m_u1.x*c+this.m_u1.y*u),x=-this.m_limitMass1*v,b=this.m_limitImpulse1,this.m_limitImpulse1=o.Max(0,this.m_limitImpulse1+x),x=this.m_limitImpulse1-b,_=-x*this.m_u1.x,f=-x*this.m_u1.y,i.m_linearVelocity.x+=i.m_invMass*_,i.m_linearVelocity.y+=i.m_invMass*f,i.m_angularVelocity+=i.m_invI*(r*f-s*_)),this.m_limitState2==d.e_atUpperLimit&&(m=n.m_linearVelocity.x+-n.m_angularVelocity*l,p=n.m_linearVelocity.y+n.m_angularVelocity*h,v=-(this.m_u2.x*m+this.m_u2.y*p),x=-this.m_limitMass2*v,b=this.m_limitImpulse2,this.m_limitImpulse2=o.Max(0,this.m_limitImpulse2+x),x=this.m_limitImpulse2-b,y=-x*this.m_u2.x,g=-x*this.m_u2.y,n.m_linearVelocity.x+=n.m_invMass*y,n.m_linearVelocity.y+=n.m_invMass*g,n.m_angularVelocity+=n.m_invI*(h*g-l*y))},E.prototype.SolvePositionConstraints=function(e){void 0===e&&(e=0);var i,n=this.m_bodyA,r=this.m_bodyB,s=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,a=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,h=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,l=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,c=0,u=0,m=0,p=0,_=0,f=0,y=0,g=0,v=0,x=0,b=0,E=0,T=0,w=0;return this.m_state==d.e_atUpperLimit&&(i=n.m_xf.R,c=this.m_localAnchor1.x-n.m_sweep.localCenter.x,u=this.m_localAnchor1.y-n.m_sweep.localCenter.y,T=i.col1.x*c+i.col2.x*u,u=i.col1.y*c+i.col2.y*u,c=T,i=r.m_xf.R,m=this.m_localAnchor2.x-r.m_sweep.localCenter.x,p=this.m_localAnchor2.y-r.m_sweep.localCenter.y,T=i.col1.x*m+i.col2.x*p,p=i.col1.y*m+i.col2.y*p,m=T,_=n.m_sweep.c.x+c,f=n.m_sweep.c.y+u,y=r.m_sweep.c.x+m,g=r.m_sweep.c.y+p,this.m_u1.Set(_-s,f-a),this.m_u2.Set(y-h,g-l),v=this.m_u1.Length(),x=this.m_u2.Length(),v>t.b2_linearSlop?this.m_u1.Multiply(1/v):this.m_u1.SetZero(),x>t.b2_linearSlop?this.m_u2.Multiply(1/x):this.m_u2.SetZero(),b=this.m_constant-v-this.m_ratio*x,w=o.Max(w,-b),b=o.Clamp(b+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),E=-this.m_pulleyMass*b,_=-E*this.m_u1.x,f=-E*this.m_u1.y,y=-this.m_ratio*E*this.m_u2.x,g=-this.m_ratio*E*this.m_u2.y,n.m_sweep.c.x+=n.m_invMass*_,n.m_sweep.c.y+=n.m_invMass*f,n.m_sweep.a+=n.m_invI*(c*f-u*_),r.m_sweep.c.x+=r.m_invMass*y,r.m_sweep.c.y+=r.m_invMass*g,r.m_sweep.a+=r.m_invI*(m*g-p*y),n.SynchronizeTransform(),r.SynchronizeTransform()),this.m_limitState1==d.e_atUpperLimit&&(i=n.m_xf.R,c=this.m_localAnchor1.x-n.m_sweep.localCenter.x,u=this.m_localAnchor1.y-n.m_sweep.localCenter.y,T=i.col1.x*c+i.col2.x*u,u=i.col1.y*c+i.col2.y*u,c=T,_=n.m_sweep.c.x+c,f=n.m_sweep.c.y+u,this.m_u1.Set(_-s,f-a),v=this.m_u1.Length(),v>t.b2_linearSlop?(this.m_u1.x*=1/v,this.m_u1.y*=1/v):this.m_u1.SetZero(),b=this.m_maxLength1-v,w=o.Max(w,-b),b=o.Clamp(b+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),E=-this.m_limitMass1*b,_=-E*this.m_u1.x,f=-E*this.m_u1.y,n.m_sweep.c.x+=n.m_invMass*_,n.m_sweep.c.y+=n.m_invMass*f,n.m_sweep.a+=n.m_invI*(c*f-u*_),n.SynchronizeTransform()),this.m_limitState2==d.e_atUpperLimit&&(i=r.m_xf.R,m=this.m_localAnchor2.x-r.m_sweep.localCenter.x,p=this.m_localAnchor2.y-r.m_sweep.localCenter.y,T=i.col1.x*m+i.col2.x*p,p=i.col1.y*m+i.col2.y*p,m=T,y=r.m_sweep.c.x+m,g=r.m_sweep.c.y+p,this.m_u2.Set(y-h,g-l),x=this.m_u2.Length(),x>t.b2_linearSlop?(this.m_u2.x*=1/x,this.m_u2.y*=1/x):this.m_u2.SetZero(),b=this.m_maxLength2-x,w=o.Max(w,-b),b=o.Clamp(b+t.b2_linearSlop,-t.b2_maxLinearCorrection,0),E=-this.m_limitMass2*b,y=-E*this.m_u2.x,g=-E*this.m_u2.y,r.m_sweep.c.x+=r.m_invMass*y,r.m_sweep.c.y+=r.m_invMass*g,r.m_sweep.a+=r.m_invI*(m*g-p*y),r.SynchronizeTransform()),w<t.b2_linearSlop},Box2D.postDefs.push(function(){Box2D.Dynamics.Joints.b2PulleyJoint.b2_minPulleyLength=2}),Box2D.inherit(T,Box2D.Dynamics.Joints.b2JointDef),T.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,T.b2PulleyJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.groundAnchorA=new n,this.groundAnchorB=new n,this.localAnchorA=new n,this.localAnchorB=new n},T.prototype.b2PulleyJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.lengthA=0,this.maxLengthA=0,this.lengthB=0,this.maxLengthB=0,this.ratio=1,this.collideConnected=!0},T.prototype.Initialize=function(t,e,i,o,n,r,s){void 0===s&&(s=0),this.bodyA=t,this.bodyB=e,this.groundAnchorA.SetV(i),this.groundAnchorB.SetV(o),this.localAnchorA=this.bodyA.GetLocalPoint(n),this.localAnchorB=this.bodyB.GetLocalPoint(r);var a=n.x-i.x,h=n.y-i.y;this.lengthA=Math.sqrt(a*a+h*h);var l=r.x-o.x,c=r.y-o.y;this.lengthB=Math.sqrt(l*l+c*c),this.ratio=s;var u=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=u-this.ratio*E.b2_minPulleyLength,this.maxLengthB=(u-E.b2_minPulleyLength)/this.ratio},Box2D.inherit(w,Box2D.Dynamics.Joints.b2Joint),w.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,w.b2RevoluteJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.K=new e,this.K1=new e,this.K2=new e,this.K3=new e,this.impulse3=new r,this.impulse2=new n,this.reduced=new n,this.m_localAnchor1=new n,this.m_localAnchor2=new n,this.m_impulse=new r,this.m_mass=new i},w.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},w.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},w.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},w.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},w.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},w.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},w.prototype.IsLimitEnabled=function(){return this.m_enableLimit};w.prototype.EnableLimit=function(t){this.m_enableLimit=t},w.prototype.GetLowerLimit=function(){return this.m_lowerAngle},w.prototype.GetUpperLimit=function(){return this.m_upperAngle},w.prototype.SetLimits=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.m_lowerAngle=t,this.m_upperAngle=e},w.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},w.prototype.EnableMotor=function(t){this.m_enableMotor=t},w.prototype.SetMotorSpeed=function(t){void 0===t&&(t=0),this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},w.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},w.prototype.SetMaxMotorTorque=function(t){void 0===t&&(t=0),this.m_maxMotorTorque=t},w.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},w.prototype.b2RevoluteJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=d.e_inactiveLimit},w.prototype.InitVelocityConstraints=function(e){var i,n=this.m_bodyA,r=this.m_bodyB,s=0;this.m_enableMotor||this.m_enableLimit,i=n.m_xf.R;var a=this.m_localAnchor1.x-n.m_sweep.localCenter.x,h=this.m_localAnchor1.y-n.m_sweep.localCenter.y;s=i.col1.x*a+i.col2.x*h,h=i.col1.y*a+i.col2.y*h,a=s,i=r.m_xf.R;var l=this.m_localAnchor2.x-r.m_sweep.localCenter.x,c=this.m_localAnchor2.y-r.m_sweep.localCenter.y;s=i.col1.x*l+i.col2.x*c,c=i.col1.y*l+i.col2.y*c,l=s;var u=n.m_invMass,m=r.m_invMass,p=n.m_invI,_=r.m_invI;if(this.m_mass.col1.x=u+m+h*h*p+c*c*_,this.m_mass.col2.x=-h*a*p-c*l*_,this.m_mass.col3.x=-h*p-c*_,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=u+m+a*a*p+l*l*_,this.m_mass.col3.y=a*p+l*_,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+_,this.m_motorMass=1/(p+_),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var f=r.m_sweep.a-n.m_sweep.a-this.m_referenceAngle;o.Abs(this.m_upperAngle-this.m_lowerAngle)<2*t.b2_angularSlop?this.m_limitState=d.e_equalLimits:f<=this.m_lowerAngle?(this.m_limitState!=d.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=d.e_atLowerLimit):f>=this.m_upperAngle?(this.m_limitState!=d.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=d.e_atUpperLimit):(this.m_limitState=d.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=d.e_inactiveLimit;if(e.warmStarting){this.m_impulse.x*=e.dtRatio,this.m_impulse.y*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var y=this.m_impulse.x,g=this.m_impulse.y;n.m_linearVelocity.x-=u*y,n.m_linearVelocity.y-=u*g,n.m_angularVelocity-=p*(a*g-h*y+this.m_motorImpulse+this.m_impulse.z),r.m_linearVelocity.x+=m*y,r.m_linearVelocity.y+=m*g,r.m_angularVelocity+=_*(l*g-c*y+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0},w.prototype.SolveVelocityConstraints=function(t){var e,i=this.m_bodyA,n=this.m_bodyB,r=0,s=0,a=0,h=0,l=0,c=i.m_linearVelocity,u=i.m_angularVelocity,m=n.m_linearVelocity,p=n.m_angularVelocity,_=i.m_invMass,f=n.m_invMass,y=i.m_invI,g=n.m_invI;if(this.m_enableMotor&&this.m_limitState!=d.e_equalLimits){var v=p-u-this.m_motorSpeed,x=this.m_motorMass*-v,b=this.m_motorImpulse,E=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=o.Clamp(this.m_motorImpulse+x,-E,E),x=this.m_motorImpulse-b,u-=y*x,p+=g*x}if(this.m_enableLimit&&this.m_limitState!=d.e_inactiveLimit){e=i.m_xf.R,s=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,r=e.col1.x*s+e.col2.x*a,a=e.col1.y*s+e.col2.y*a,s=r,e=n.m_xf.R,h=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y,r=e.col1.x*h+e.col2.x*l,l=e.col1.y*h+e.col2.y*l,h=r;var T=m.x+-p*l-c.x- -u*a,w=m.y+p*h-c.y-u*s,S=p-u;this.m_mass.Solve33(this.impulse3,-T,-w,-S),this.m_limitState==d.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==d.e_atLowerLimit?this.m_impulse.z+this.impulse3.z<0&&(this.m_mass.Solve22(this.reduced,-T,-w),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0):this.m_limitState==d.e_atUpperLimit&&this.m_impulse.z+this.impulse3.z>0&&(this.m_mass.Solve22(this.reduced,-T,-w),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0),c.x-=_*this.impulse3.x,c.y-=_*this.impulse3.y,u-=y*(s*this.impulse3.y-a*this.impulse3.x+this.impulse3.z),m.x+=f*this.impulse3.x,m.y+=f*this.impulse3.y,p+=g*(h*this.impulse3.y-l*this.impulse3.x+this.impulse3.z)}else{e=i.m_xf.R,s=this.m_localAnchor1.x-i.m_sweep.localCenter.x,a=this.m_localAnchor1.y-i.m_sweep.localCenter.y,r=e.col1.x*s+e.col2.x*a,a=e.col1.y*s+e.col2.y*a,s=r,e=n.m_xf.R,h=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y,r=e.col1.x*h+e.col2.x*l,l=e.col1.y*h+e.col2.y*l,h=r;var C=m.x+-p*l-c.x- -u*a,R=m.y+p*h-c.y-u*s;this.m_mass.Solve22(this.impulse2,-C,-R),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,c.x-=_*this.impulse2.x,c.y-=_*this.impulse2.y,u-=y*(s*this.impulse2.y-a*this.impulse2.x),m.x+=f*this.impulse2.x,m.y+=f*this.impulse2.y,p+=g*(h*this.impulse2.y-l*this.impulse2.x)}i.m_linearVelocity.SetV(c),i.m_angularVelocity=u,n.m_linearVelocity.SetV(m),n.m_angularVelocity=p},w.prototype.SolvePositionConstraints=function(e){void 0===e&&(e=0);var i,n=0,r=this.m_bodyA,s=this.m_bodyB,a=0,h=0,l=0,c=0,u=0;if(this.m_enableLimit&&this.m_limitState!=d.e_inactiveLimit){var m=s.m_sweep.a-r.m_sweep.a-this.m_referenceAngle,p=0;this.m_limitState==d.e_equalLimits?(n=o.Clamp(m-this.m_lowerAngle,-t.b2_maxAngularCorrection,t.b2_maxAngularCorrection),p=-this.m_motorMass*n,a=o.Abs(n)):this.m_limitState==d.e_atLowerLimit?(n=m-this.m_lowerAngle,a=-n,n=o.Clamp(n+t.b2_angularSlop,-t.b2_maxAngularCorrection,0),p=-this.m_motorMass*n):this.m_limitState==d.e_atUpperLimit&&(n=m-this.m_upperAngle,a=n,n=o.Clamp(n-t.b2_angularSlop,0,t.b2_maxAngularCorrection),p=-this.m_motorMass*n),r.m_sweep.a-=r.m_invI*p,s.m_sweep.a+=s.m_invI*p,r.SynchronizeTransform(),s.SynchronizeTransform()}i=r.m_xf.R;var _=this.m_localAnchor1.x-r.m_sweep.localCenter.x,f=this.m_localAnchor1.y-r.m_sweep.localCenter.y;l=i.col1.x*_+i.col2.x*f,f=i.col1.y*_+i.col2.y*f,_=l,i=s.m_xf.R;var y=this.m_localAnchor2.x-s.m_sweep.localCenter.x,g=this.m_localAnchor2.y-s.m_sweep.localCenter.y;l=i.col1.x*y+i.col2.x*g,g=i.col1.y*y+i.col2.y*g,y=l;var v=s.m_sweep.c.x+y-r.m_sweep.c.x-_,x=s.m_sweep.c.y+g-r.m_sweep.c.y-f,b=v*v+x*x,E=Math.sqrt(b);h=E;var T=r.m_invMass,S=s.m_invMass,C=r.m_invI,R=s.m_invI,M=10*t.b2_linearSlop;if(b>M*M){var D=T+S,A=1/D;c=A*-v,u=A*-x;r.m_sweep.c.x-=.5*T*c,r.m_sweep.c.y-=.5*T*u,s.m_sweep.c.x+=.5*S*c,s.m_sweep.c.y+=.5*S*u,v=s.m_sweep.c.x+y-r.m_sweep.c.x-_,x=s.m_sweep.c.y+g-r.m_sweep.c.y-f}return this.K1.col1.x=T+S,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=T+S,this.K2.col1.x=C*f*f,this.K2.col2.x=-C*_*f,this.K2.col1.y=-C*_*f,this.K2.col2.y=C*_*_,this.K3.col1.x=R*g*g,this.K3.col2.x=-R*y*g,this.K3.col1.y=-R*y*g,this.K3.col2.y=R*y*y,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(w.tImpulse,-v,-x),c=w.tImpulse.x,u=w.tImpulse.y,r.m_sweep.c.x-=r.m_invMass*c,r.m_sweep.c.y-=r.m_invMass*u,r.m_sweep.a-=r.m_invI*(_*u-f*c),s.m_sweep.c.x+=s.m_invMass*c,s.m_sweep.c.y+=s.m_invMass*u,s.m_sweep.a+=s.m_invI*(y*u-g*c),r.SynchronizeTransform(),s.SynchronizeTransform(),h<=t.b2_linearSlop&&a<=t.b2_angularSlop},Box2D.postDefs.push(function(){Box2D.Dynamics.Joints.b2RevoluteJoint.tImpulse=new n}),Box2D.inherit(S,Box2D.Dynamics.Joints.b2JointDef),S.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,S.b2RevoluteJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},S.prototype.b2RevoluteJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.referenceAngle=0,this.lowerAngle=0,this.upperAngle=0,this.maxMotorTorque=0,this.motorSpeed=0,this.enableLimit=!1,this.enableMotor=!1},S.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA=this.bodyA.GetLocalPoint(i),this.localAnchorB=this.bodyB.GetLocalPoint(i),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},Box2D.inherit(C,Box2D.Dynamics.Joints.b2Joint),C.prototype.__super=Box2D.Dynamics.Joints.b2Joint.prototype,C.b2WeldJoint=function(){Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this,arguments),this.m_localAnchorA=new n,this.m_localAnchorB=new n,this.m_impulse=new r,this.m_mass=new i},C.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},C.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},C.prototype.GetReactionForce=function(t){return void 0===t&&(t=0),new n(t*this.m_impulse.x,t*this.m_impulse.y)},C.prototype.GetReactionTorque=function(t){return void 0===t&&(t=0),t*this.m_impulse.z},C.prototype.b2WeldJoint=function(t){this.__super.b2Joint.call(this,t),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new i},C.prototype.InitVelocityConstraints=function(t){var e,i=0,o=this.m_bodyA,n=this.m_bodyB;e=o.m_xf.R;var r=this.m_localAnchorA.x-o.m_sweep.localCenter.x,s=this.m_localAnchorA.y-o.m_sweep.localCenter.y;i=e.col1.x*r+e.col2.x*s,s=e.col1.y*r+e.col2.y*s,r=i,e=n.m_xf.R;var a=this.m_localAnchorB.x-n.m_sweep.localCenter.x,h=this.m_localAnchorB.y-n.m_sweep.localCenter.y;i=e.col1.x*a+e.col2.x*h,h=e.col1.y*a+e.col2.y*h,a=i;var l=o.m_invMass,c=n.m_invMass,u=o.m_invI,m=n.m_invI;this.m_mass.col1.x=l+c+s*s*u+h*h*m,this.m_mass.col2.x=-s*r*u-h*a*m,this.m_mass.col3.x=-s*u-h*m,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=l+c+r*r*u+a*a*m,this.m_mass.col3.y=r*u+a*m,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=u+m,t.warmStarting?(this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_impulse.z*=t.dtRatio,o.m_linearVelocity.x-=l*this.m_impulse.x,o.m_linearVelocity.y-=l*this.m_impulse.y,o.m_angularVelocity-=u*(r*this.m_impulse.y-s*this.m_impulse.x+this.m_impulse.z),n.m_linearVelocity.x+=c*this.m_impulse.x,n.m_linearVelocity.y+=c*this.m_impulse.y,n.m_angularVelocity+=m*(a*this.m_impulse.y-h*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},C.prototype.SolveVelocityConstraints=function(t){var e,i=0,o=this.m_bodyA,n=this.m_bodyB,s=o.m_linearVelocity,a=o.m_angularVelocity,h=n.m_linearVelocity,l=n.m_angularVelocity,c=o.m_invMass,u=n.m_invMass,m=o.m_invI,d=n.m_invI;e=o.m_xf.R;var p=this.m_localAnchorA.x-o.m_sweep.localCenter.x,_=this.m_localAnchorA.y-o.m_sweep.localCenter.y;i=e.col1.x*p+e.col2.x*_,_=e.col1.y*p+e.col2.y*_,p=i,e=n.m_xf.R;var f=this.m_localAnchorB.x-n.m_sweep.localCenter.x,y=this.m_localAnchorB.y-n.m_sweep.localCenter.y;i=e.col1.x*f+e.col2.x*y,y=e.col1.y*f+e.col2.y*y,f=i;var g=h.x-l*y-s.x+a*_,v=h.y+l*f-s.y-a*p,x=l-a,b=new r;this.m_mass.Solve33(b,-g,-v,-x),this.m_impulse.Add(b),s.x-=c*b.x,s.y-=c*b.y,a-=m*(p*b.y-_*b.x+b.z),h.x+=u*b.x,h.y+=u*b.y,l+=d*(f*b.y-y*b.x+b.z),o.m_angularVelocity=a,n.m_angularVelocity=l},C.prototype.SolvePositionConstraints=function(e){void 0===e&&(e=0);var i,n=0,s=this.m_bodyA,a=this.m_bodyB;i=s.m_xf.R;var h=this.m_localAnchorA.x-s.m_sweep.localCenter.x,l=this.m_localAnchorA.y-s.m_sweep.localCenter.y;n=i.col1.x*h+i.col2.x*l,l=i.col1.y*h+i.col2.y*l,h=n,i=a.m_xf.R;var c=this.m_localAnchorB.x-a.m_sweep.localCenter.x,u=this.m_localAnchorB.y-a.m_sweep.localCenter.y;n=i.col1.x*c+i.col2.x*u,u=i.col1.y*c+i.col2.y*u,c=n;var m=s.m_invMass,d=a.m_invMass,p=s.m_invI,_=a.m_invI,f=a.m_sweep.c.x+c-s.m_sweep.c.x-h,y=a.m_sweep.c.y+u-s.m_sweep.c.y-l,g=a.m_sweep.a-s.m_sweep.a-this.m_referenceAngle,v=10*t.b2_linearSlop,x=Math.sqrt(f*f+y*y),b=o.Abs(g);x>v&&(p*=1,_*=1),this.m_mass.col1.x=m+d+l*l*p+u*u*_,this.m_mass.col2.x=-l*h*p-u*c*_,this.m_mass.col3.x=-l*p-u*_,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+d+h*h*p+c*c*_,this.m_mass.col3.y=h*p+c*_,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=p+_;var E=new r;return this.m_mass.Solve33(E,-f,-y,-g),s.m_sweep.c.x-=m*E.x,s.m_sweep.c.y-=m*E.y,s.m_sweep.a-=p*(h*E.y-l*E.x+E.z),a.m_sweep.c.x+=d*E.x,a.m_sweep.c.y+=d*E.y,a.m_sweep.a+=_*(c*E.y-u*E.x+E.z),s.SynchronizeTransform(),a.SynchronizeTransform(),x<=t.b2_linearSlop&&b<=t.b2_angularSlop},Box2D.inherit(R,Box2D.Dynamics.Joints.b2JointDef),R.prototype.__super=Box2D.Dynamics.Joints.b2JointDef.prototype,R.b2WeldJointDef=function(){Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this,arguments),this.localAnchorA=new n,this.localAnchorB=new n},R.prototype.b2WeldJointDef=function(){this.__super.b2JointDef.call(this),this.type=d.e_weldJoint,this.referenceAngle=0},R.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(i)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}(),function(){var t=Box2D.Dynamics.b2DebugDraw;t.b2DebugDraw=function(){this.m_drawScale=1,this.m_lineThickness=1,this.m_alpha=1,this.m_fillAlpha=1,this.m_xformScale=1;var t=this;this.m_sprite={graphics:{clear:function(){},setTranslation:function(e,i){t.m_ctx.translate(e,i)}}}},t.prototype._color=function(t,e){return"rgba("+((16711680&t)>>16)+","+((65280&t)>>8)+","+(255&t)+","+e+")"},t.prototype.b2DebugDraw=function(){this.m_drawFlags=0},t.prototype.SetFlags=function(t){void 0===t&&(t=0),this.m_drawFlags=t},t.prototype.GetFlags=function(){return this.m_drawFlags},t.prototype.AppendFlags=function(t){void 0===t&&(t=0),this.m_drawFlags|=t},t.prototype.ClearFlags=function(t){void 0===t&&(t=0),this.m_drawFlags&=~t},t.prototype.SetSprite=function(t){this.m_ctx=t},t.prototype.GetSprite=function(){return this.m_ctx},t.prototype.SetDrawScale=function(t){void 0===t&&(t=0),this.m_drawScale=t},t.prototype.GetDrawScale=function(){return this.m_drawScale},t.prototype.SetLineThickness=function(t){void 0===t&&(t=0),this.m_lineThickness=t,this.m_ctx.strokeWidth=t},t.prototype.GetLineThickness=function(){return this.m_lineThickness},t.prototype.SetAlpha=function(t){void 0===t&&(t=0),this.m_alpha=t},t.prototype.GetAlpha=function(){return this.m_alpha},t.prototype.SetFillAlpha=function(t){void 0===t&&(t=0),this.m_fillAlpha=t},t.prototype.GetFillAlpha=function(){return this.m_fillAlpha},t.prototype.SetXFormScale=function(t){void 0===t&&(t=0),this.m_xformScale=t},t.prototype.GetXFormScale=function(){return this.m_xformScale},t.prototype.DrawPolygon=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.moveTo(t[0].x*n,t[0].y*n);for(var r=1;r<e;r++)o.lineTo(t[r].x*n,t[r].y*n);o.lineTo(t[0].x*n,t[0].y*n),o.closePath(),o.stroke()}},t.prototype.DrawSolidPolygon=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.fillStyle=this._color(i.color,this.m_fillAlpha),o.moveTo(t[0].x*n,t[0].y*n);for(var r=1;r<e;r++)o.lineTo(t[r].x*n,t[r].y*n);o.lineTo(t[0].x*n,t[0].y*n),o.closePath(),o.fill(),o.stroke()}},t.prototype.DrawCircle=function(t,e,i){if(e){var o=this.m_ctx,n=this.m_drawScale;o.beginPath(),o.strokeStyle=this._color(i.color,this.m_alpha),o.arc(t.x*n,t.y*n,e*n,0,2*Math.PI,!0),o.closePath(),o.stroke()}},t.prototype.DrawSolidCircle=function(t,e,i,o){if(e){var n=this.m_ctx,r=this.m_drawScale,s=t.x*r,a=t.y*r;n.moveTo(0,0),n.beginPath(),n.strokeStyle=this._color(o.color,this.m_alpha),n.fillStyle=this._color(o.color,this.m_fillAlpha),n.arc(s,a,e*r,0,2*Math.PI,!0),n.moveTo(s,a),n.lineTo((t.x+i.x*e)*r,(t.y+i.y*e)*r),n.closePath(),n.fill(),n.stroke()}},t.prototype.DrawSegment=function(t,e,i){var o=this.m_ctx,n=this.m_drawScale;o.strokeStyle=this._color(i.color,this.m_alpha),o.beginPath(),o.moveTo(t.x*n,t.y*n),o.lineTo(e.x*n,e.y*n),o.closePath(),o.stroke()},t.prototype.DrawTransform=function(t){var e=this.m_ctx,i=this.m_drawScale;e.beginPath(),e.strokeStyle=this._color(16711680,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col1.x)*i,(t.position.y+this.m_xformScale*t.R.col1.y)*i),e.strokeStyle=this._color(65280,this.m_alpha),e.moveTo(t.position.x*i,t.position.y*i),e.lineTo((t.position.x+this.m_xformScale*t.R.col2.x)*i,(t.position.y+this.m_xformScale*t.R.col2.y)*i),e.closePath(),e.stroke()}}();var i;for(i=0;i<Box2D.postDefs.length;++i)Box2D.postDefs[i]();delete Box2D.postDefs,"undefined"==typeof window&&(exports.Box2D=Box2D),function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Broadphase=function(){this.world=null},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(t){throw"collisionPairs not implemented for this BroadPhase class!"},t.NaiveBroadphase=function(){this.temp={r:new t.Vec3,normal:new t.Vec3,quat:new t.Quaternion}},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(e){for(var i=[],o=[],n=e.numObjects(),r=e.bodies,s=t.Shape.types,a=s.SPHERE|s.BOX|s.COMPOUND|s.CONVEXPOLYHEDRON,h=s.PLANE,l=t.Body.STATIC|t.Body.KINEMATIC,c=this.temp.r,u=this.temp.normal,m=(this.temp.quat,0);m<n;m++)for(var d=0;d<m;d++){var p=r[m],_=r[d];if(p.shape&&_.shape){var f=p.shape.type,y=_.shape.type;if((0!=(p.motionstate&l)||p.isSleeping())&&(0!=(_.motionstate&l)||_.isSleeping()))continue;if(f&a&&y&a){_.position.vsub(p.position,c);var g=p.shape.boundingSphereRadius()+_.shape.boundingSphereRadius();c.norm2()<g*g&&(i.push(p),o.push(_))}else if(f&a&&y&s.PLANE||y&a&&f&s.PLANE){var v=f===h?m:d,x=f!==h?m:d;r[x].position.vsub(r[v].position,c),r[v].quaternion.vmult(r[v].shape.normal,u);var b=c.dot(u)-r[x].shape.boundingSphereRadius();b<0&&(i.push(p),o.push(_))}}}return[i,o]},t.Ray=function(e,i){function o(t,e,i){return i.vsub(t,x),c=x.dot(e),e.mult(c,b),b.vadd(t,b),u=i.distanceTo(b)}function n(t,e,i,o){return o.vsub(e,x),i.vsub(e,E),t.vsub(e,T),m=x.dot(x),d=x.dot(E),p=x.dot(T),_=E.dot(E),f=E.dot(T),y=1/(m*_-d*d),g=(_*p-d*f)*y,v=(m*f-d*p)*y,g>=0&&v>=0&&g+v<1}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var r=1e-4;this.setPrecision=function(t){r=t}
;var s=new t.Vec3,a=new t.Vec3,h=new t.Vec3,l=(new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3);this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):void console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},this.intersectShape=function(e,i,c,u){var m,d=[];if(e instanceof t.ConvexPolyhedron){if(o(this.origin,this.direction,c)>e.boundingSphereRadius())return d;var p,_,f=e.faces,y=e.vertices,g=e.faceNormals;for(fi=0;fi<f.length;fi++){var v=f[fi],x=g[fi],b=i,E=c,T=new t.Vec3;y[v[0]].copy(T),T.vsub(this.origin,T),b.vmult(T,T),T.vadd(E,T);var w=new t.Vec3;if(b.vmult(x,w),p=this.direction.dot(w),!(Math.abs(p)<r)&&!((_=w.dot(T)/p)<0)&&p<0){this.direction.mult(_,l),l.vadd(this.origin,l),y[v[0]].copy(s),b.vmult(s,s),E.vadd(s,s);for(var S=1;S<v.length-1;S++)if(y[v[S]].copy(a),y[v[S+1]].copy(h),b.vmult(a,a),b.vmult(h,h),E.vadd(a,a),E.vadd(h,h),n(l,s,a,h)){m={distance:this.origin.distanceTo(l),point:l.copy(),face:v,body:u},d.push(m);break}}}}return d},this.intersectBodies=function(t){for(var e=[],i=0,o=t.length;i<o;i++){var n=this.intersectBody(t[i]);Array.prototype.push.apply(e,n)}return e.sort(function(t,e){return t.distance-e.distance}),e};var c,u,m,d,p,_,f,y,g,v,x=new t.Vec3,b=new t.Vec3,E=new t.Vec3,T=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Mat3=function(t){this.elements=t?new Float32Array(t):new Float32Array(9)},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.vmult=function(e,i){void 0===i&&(i=new t.Vec3);for(var o=[e.x,e.y,e.z],n=[0,0,0],r=0;r<3;r++)for(var s=0;s<3;s++)n[r]+=this.elements[r+3*s]*o[r];return i.x=n[0],i.y=n[1],i.z=n[2],i},t.Mat3.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,o=0;o<3;o++)for(var n=0;n<3;n++){for(var r=0,s=0;s<3;s++)r+=this.elements[o+s]*e.elements[s+3*n];i.elements[o+3*n]=r}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;var o,n,r=new Float32Array(12);for(o=0;o<3;o++)for(n=0;n<3;n++)r[o+4*n]=this.elements[o+3*n];r[3]=e.x,r[7]=e.y,r[11]=e.z;var s,a,h,l=3,c=l;do{if(o=c-l,0===r[o+4*o])for(n=o+1;n<c;n++)if(0!==r[o+4*n]){h=[],s=4;do{a=4-s,h.push(r[a+4*o]+r[a+4*n])}while(--s);r[o+0]=h[0],r[o+4]=h[1],r[o+8]=h[2];break}if(0!==r[o+4*o])for(n=o+1;n<c;n++){var u=r[o+4*n]/r[o+4*o];h=[],s=4;do{a=4-s,h.push(a<=o?0:r[a+4*n]-r[a+4*o]*u)}while(--s);r[n+0]=h[0],r[n+4]=h[1],r[n+8]=h[2]}}while(--l);if(i.z=r[11]/r[10],i.y=(r[7]-r[6]*i.z)/r[5],i.x=(r[3]-r[2]*i.z-r[1]*i.y)/r[0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||i.x===1/0||i.y===1/0||i.z===1/0)throw"Could not solve equation! Got x=["+i.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return i},t.Mat3.prototype.e=function(t,e,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;i<this.elements.length;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=0;e<9;e++)t+=this.elements[e]+",";return t},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){i=i||new t.Vec3;var o=[this.x,this.y,this.z],n=[e.x,e.y,e.z];return i.x=o[1]*n[2]-o[2]*n[1],i.y=o[2]*n[0]-o[0]*n[2],i.z=o[0]*n[1]-o[1]*n[0],i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){if(!i)return new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z);i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z},t.Vec3.prototype.vsub=function(e,i){if(!i)return new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z);i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return t>0?(this.x/=t,this.y/=t,this.z/=t):(this.x=0,this.y=0,this.z=0),t},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return i>0?(i=1/i,e.x=this.x*i,e.y=this.y*i,e.z=this.z*i):(e.x=0,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)+(t.z-this.z)*(t.z-this.z))},t.Vec3.prototype.mult=function(e,i){return i||(i=new t.Vec3),i.x=e*this.x,i.y=e*this.y,i.z=e*this.z,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e},t.Vec3.prototype.tangents=function(e,i){var o=this.norm();if(o>0){var n=new t.Vec3(this.x/o,this.y/o,this.z/o);if(n.x<.9){var r=Math.random();n.cross(new t.Vec3(r,1e-7,0).unit(),e)}else n.cross(new t.Vec3(1e-7,r,0).unit(),e);n.cross(e,i)}else e.set(1,0,0).normalize(),i.set(0,1,0).normalize()},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){i.x=this.x+(t.x-this.x)*e,i.y=this.y+(t.y-this.y)*e,i.z=this.z+(t.z-this.z)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)},t.Quaternion=function(t,e,i,o){this.x=void 0!=t?t:0,this.y=void 0!=e?e:0,this.z=void 0!=i?i:0,this.w=void 0!=o?o:1},t.Quaternion.prototype.set=function(t,e,i,o){this.x=t,this.y=e,this.z=i,this.w=o},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),o=Math.sqrt(1-this.w*this.w);return o<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/o,e.y=this.y/o,e.z=this.z/o),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()},t.Quaternion.prototype.mult=function(e,i){void 0==i&&(i=new t.Quaternion);var o=new t.Vec3(this.x,this.y,this.z),n=new t.Vec3(e.x,e.y,e.z);return i.w=this.w*e.w-o.dot(n),vaxvb=o.cross(n),i.x=this.w*n.x+e.w*o.x+vaxvb.x,i.y=this.w*n.y+e.w*o.y+vaxvb.y,i.z=this.w*n.z+e.w*o.z+vaxvb.z,i},t.Quaternion.prototype.inverse=function(e){void 0==e&&(e=new t.Quaternion),this.conjugate(e);var i=1/(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return e.x*=i,e.y*=i,e.z*=i,e.w*=i,e},t.Quaternion.prototype.conjugate=function(e){return void 0==e&&(e=new t.Quaternion),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0==this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var o=e.x,n=e.y,r=e.z,s=this.x,a=this.y,h=this.z,l=this.w,c=l*o+a*r-h*n,u=l*n+h*o-s*r,m=l*r+s*n-a*o,d=-s*o-a*n-h*r;i.x=c*l+d*-s+u*-h-m*-a,i.y=u*l+d*-a+m*-s-c*-h,i.z=m*l+d*-h+c*-a-u*-s}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,o,n,r=this.x,s=this.y,a=this.z,h=this.w;switch(e){case"YZX":var l=r*s+a*h;if(l>.499&&(i=2*Math.atan2(r,h),o=Math.PI/2,n=0),l<-.499&&(i=-2*Math.atan2(r,h),o=-Math.PI/2,n=0),isNaN(i)){var c=r*r,u=s*s,m=a*a;i=Math.atan2(2*s*h-2*r*a,1-2*u-2*m),o=Math.asin(2*l),n=Math.atan2(2*r*h-2*s*a,1-2*c-2*m)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=o,t.x=n},t.Shape=function(){this.type=0,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.boundingSphereRadius=function(){throw"boundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type},t.Shape.prototype.calculateTransformedInertia=function(e,i,o){void 0==o&&(o=new t.Vec3),i.normalize();var n=this.calculateLocalInertia(e),r=i.vmult(n);return o.x=Math.abs(r.x),o.y=Math.abs(r.y),o.z=Math.abs(r.z),o},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e;this.world=null,this.preStep=null,this.postStep=null},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if(void 0!==i&&!(i instanceof t.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle");var o=this;this.position=new t.Vec3,this.initPosition=new t.Vec3,this.velocity=new t.Vec3,this.initVelocity=new t.Vec3,this.force=new t.Vec3,this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=e<=0?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0;var n=0;this.isAwake=function(){return 0==n},this.isSleepy=function(){return 1==n},this.isSleeping=function(){return 2==n},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1e3;var r=(new Date).getTime();this.wakeUp=function(){n=0,o.dispatchEvent({type:"wakeup"})},this.sleep=function(){n=2},this.sleepTick=function(){o.allowSleep&&(0==n&&o.velocity.norm()<o.sleepSpeedLimit?(n=1,r=(new Date).getTime(),o.dispatchEvent({type:"sleepy"})):1==n&&o.velocity.norm()>o.sleepSpeedLimit?o.wakeUp():1==n&&(new Date).getTime()-r>o.sleepTimeLimit&&(n=2,o.dispatchEvent({type:"sleep"})))}},t.RigidBody=function(e,i,o){if("number"!=typeof e)throw new Error("Argument 1 (mass) must be a number.");if("object"!=typeof i||!(i instanceof t.Shape))throw new Error("Argument 2 (shape) must be an instance of CANNON.Shape.");if(void 0!==o&&!(o instanceof t.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,o);this.tau=new t.Vec3,this.quaternion=new t.Quaternion,this.initQuaternion=new t.Quaternion,this.angularVelocity=new t.Vec3,this.initAngularVelocity=new t.Vec3,this.shape=i,this.inertia=new t.Vec3,i.calculateLocalInertia(e,this.inertia),this.invInertia=new t.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.angularDamping=.01},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!=e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var o=2*e*this.radius*this.radius/5;return i.x=o,i.y=o,i.z=o,i},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.boundingSphereRadius=function(){return this.radius},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,i=this.halfExtents.y,o=this.halfExtents.z,n=t.Vec3,r=new t.ConvexPolyhedron([new n(-e,-i,-o),new n(e,-i,-o),new n(e,i,-o),new n(-e,i,-o),new n(-e,-i,o),new n(e,-i,o),new n(e,i,o),new n(-e,i,o)],[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new n(0,0,-1),new n(0,0,1),new n(0,-1,0),new n(0,1,0),new n(-1,0,0),new n(1,0,0)]);this.convexPolyhedronRepresentation=r},t.Box.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3,i.x=1/12*e*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.z*2*this.halfExtents.z),i.y=1/12*e*(2*this.halfExtents.x*2*this.halfExtents.x+2*this.halfExtents.z*2*this.halfExtents.z),i.z=1/12*e*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.x*2*this.halfExtents.x),i},t.Box.prototype.getCorners=function(e){var i=[],o=this.halfExtents;i.push(new t.Vec3(o.x,o.y,o.z)),i.push(new t.Vec3(-o.x,o.y,o.z)),i.push(new t.Vec3(-o.x,-o.y,o.z)),i.push(new t.Vec3(-o.x,-o.y,-o.z)),i.push(new t.Vec3(o.x,-o.y,-o.z)),i.push(new t.Vec3(o.x,o.y,-o.z)),i.push(new t.Vec3(-o.x,o.y,-o.z)),i.push(new t.Vec3(o.x,-o.y,o.z));for(var n=0;void 0!=e&&n<i.length;n++)e.vmult(i[n],i[n]);return i},t.Box.prototype.getSideNormals=function(e,i){var o=[],n=this.halfExtents;o.push(new t.Vec3(n.x,0,0)),o.push(new t.Vec3(0,n.y,0)),o.push(new t.Vec3(0,0,n.z)),void 0!=e&&e&&(o.push(new t.Vec3(-n.x,0,0)),o.push(new t.Vec3(0,-n.y,0)),o.push(new t.Vec3(0,0,-n.z)));for(var r=0;void 0!=i&&r<o.length;r++)i.vmult(o[r],o[r]);return o},t.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},t.Box.prototype.boundingSphereRadius=function(){return this.halfExtents.norm()},t.Plane=function(e){t.Shape.call(this),e.normalize(),this.normal=e,this.type=t.Shape.types.PLANE},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3},t.Plane.prototype.volume=function(){return 1/0},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(e,i,o){i=i||new t.Vec3,o=o||new t.Quaternion,this.childShapes.push(e),this.childOffsets.push(i),this.childOrientations.push(o)},t.Compound.prototype.volume=function(){for(var t=0,e=0;e<this.childShapes.length;e++)t+=this.childShapes[e].volume();return t},t.Compound.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;for(var o=this.volume(),n=0;n<this.childShapes.length;n++){var r=this.childShapes[n],s=this.childOffsets[n],a=this.childOrientations[n],h=r.volume()/o*e,l=r.calculateTransformedInertia(h,a);i.vadd(l,i);var c=new t.Vec3(h*s.x*s.x,h*s.y*s.y,h*s.z*s.z);i.vadd(c,i)}return i},t.Compound.prototype.boundingSphereRadius=function(){for(var t=0,e=0;e<this.childShapes.length;e++){var i=this.childOffsets[e].norm()+this.childShapes[e].boundingSphereRadius();t<i&&(t=i)}return t},t.ConvexPolyhedron=function(e,i,o){function n(e,i,o,n,r){for(var s=e.vertices.length,a=null,h=null,l=e.vertices,c=new t.Vec3,u=0;u<s;u++){l[u].copy(c),n.vmult(c,c),c.vadd(o,c);var m=c.dot(i);(null===a||m>a)&&(a=m),(null===h||m<h)&&(h=m)}if(h>a){var d=h;h=a,a=d}r[0]=a,r[1]=h}function r(t,e){var i=s.faces[t],o=s.faceNormals[t],n=s.vertices[i[0]];return-o.dot(n)}var s=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON,this.vertices=[],this.faces=i,this.faceNormals=o,this.uniqueEdges=[];for(pi in e){var a=e[pi];if(!(a instanceof t.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.vertices.push(a)}for(var h=0;h<i.length;h++)for(var l=i[h].length,c=l,u=0;u<c;u++){var m=(u+1)%l,d=new t.Vec3;this.vertices[i[h][u]].vsub(this.vertices[i[h][m]],d),d.normalize();for(var p=!1,a=0;a<this.uniqueEdges.length;a++)if(this.uniqueEdges[a].almostEquals(d)||this.uniqueEdges[a].almostEquals(d)){p=!0;break}if(p||this.uniqueEdges.push(d),d)d.face1=h;else{var _;_.m_face0=h,edges.insert(vp,_)}}this.testSepAxis=function(t,e,i,o,r,s){var a=[],h=[];n(this,t,i,o,a),n(e,t,r,s,h);var l=a[0],c=a[1],u=h[0],m=h[1];if(l<m||u<c)return!1;var d=l-m,p=u-c;return depth=d<p?d:p,depth},this.findSeparatingAxis=function(e,i,o,n,r,s){for(var a=1/0,h=this,l=0,c=h.faces.length,u=new t.Vec3,m=0;m<c;m++){h.faceNormals[m].copy(u),o.vmult(u,u);var d=h.testSepAxis(u,e,i,o,n,r);if(!1===d)return!1;d<a&&(a=d,u.copy(s))}for(var p=new t.Vec3,_=e.faces.length,m=0;m<_;m++){e.faceNormals[m].copy(p),r.vmult(p,p),l++;var d=h.testSepAxis(p,e,i,o,n,r);if(!1===d)return!1;d<a&&(a=d,p.copy(s))}for(var f=0,y=new t.Vec3,g=new t.Vec3,v=new t.Vec3,x=0;x<h.uniqueEdges.length;x++){h.uniqueEdges[x].copy(y),o.vmult(y,y);for(var b=0;b<e.uniqueEdges.length;b++)if(e.uniqueEdges[b].copy(g),r.vmult(g,g),y.cross(g,v),f++,!v.almostZero()){v.normalize();var E=h.testSepAxis(v,e,i,o,n,r);if(!1===E)return!1;E<a&&(a=E,v.copy(s))}}var T=new t.Vec3;return n.vsub(i,T),T.dot(s)>0&&s.negate(s),!0},this.clipAgainstHull=function(e,i,o,n,r,s,a,h,l){if(!(e instanceof t.Vec3))throw new Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw new Error("quatA must be Quaternion");for(var c=-1,u=-1/0,m=new t.Vec3,d=0;d<o.faces.length;d++){o.faceNormals[d].copy(m),r.vmult(m,m),n.vadd(m,m);var p=m.dot(s);p>u&&(u=p,c=d)}var _=[];polyB=o.faces[c];for(var f=polyB.length,y=0;y<f;y++){var g=o.vertices[polyB[y]],v=new t.Vec3;g.copy(v),r.vmult(v,v),n.vadd(v,v),_.push(v)}c>=0&&this.clipFaceAgainstHull(s,e,i,_,a,h,l)},this.clipFaceAgainstHull=function(e,i,o,n,s,a,h){if(!(e instanceof t.Vec3))throw new Error("sep normal must be vector");if(!(n instanceof Array))throw new Error("world verts must be array");s=Number(s),a=Number(a);for(var l=this,c=[],u=n,m=c,d=-1,p=1/0,_=new t.Vec3,f=0;f<l.faces.length;f++){l.faceNormals[f].copy(_),o.vmult(_,_),i.vadd(_,_);var y=_.dot(e);y<p&&(p=y,d=f)}if(d<0)return void console.log("--- did not find any closest face... ---");var g=l.faces[d];g.connectedFaces=[];for(var v=0;v<l.faces.length;v++)for(var x=0;x<l.faces[v].length;x++)-1!==g.indexOf(l.faces[v][x])&&v!==d&&-1===g.connectedFaces.indexOf(v)&&g.connectedFaces.push(v);for(var b=(u.length,g.length),E=new t.Vec3,T=new t.Vec3,w=new t.Vec3,S=new t.Vec3,C=0;C<b;C++){var R=l.vertices[g[C]],M=l.vertices[g[(C+1)%b]];R.vsub(M,E),E.copy(T),o.vmult(T,T),i.vadd(T,T),this.faceNormals[d].copy(w),o.vmult(w,w),i.vadd(w,w),T.cross(w,S),S.negate(S);var D=new t.Vec3;R.copy(D),o.vmult(D,D),i.vadd(D,D);var A,B,I=(D.dot(S),g.connectedFaces[C]),H=new t.Vec3;this.faceNormals[I].copy(H);var P=r(I),A=new t.Vec3;H.copy(A),o.vmult(A,A);var B=P-A.dot(i);for(this.clipFaceAgainstPlane(u,m,A,B);u.length;)u.shift();for(;m.length;)u.push(m.shift())}var H=new t.Vec3;this.faceNormals[d].copy(H);var P=r(d),A=new t.Vec3;H.copy(A),o.vmult(A,A);for(var B=P-A.dot(i),v=0;v<u.length;v++){var L=A.dot(u[v])+B;if(L<=s&&(console.log("clamped: depth="+L+" to minDist="+s),L=s),L<=a){var V=u[v],k={point:V,normal:A,depth:L};h.push(k)}}},this.clipFaceAgainstPlane=function(e,i,o,n){if(!(o instanceof t.Vec3))throw new Error("planeNormal must be Vec3, "+o+" given");if(!(e instanceof Array))throw new Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw new Error("outvertices must be Array, "+i+" given");var r,s,a=e.length;if(a<2)return i;var h=e[e.length-1],l=e[0];r=o.dot(h)+n;for(var c=0;c<a;c++){if(l=e[c],s=o.dot(l)+n,r<0)if(s<0){var u=new t.Vec3;l.copy(u),i.push(u)}else{var u=new t.Vec3;h.lerp(l,r/(r-s),u),i.push(u)}else if(s<0){var u=new t.Vec3;h.lerp(l,r/(r-s),u),i.push(u),i.push(l)}h=l,r=s}return i};var s=this;this.calculateLocalInertia=function(t,e){var i=this.aabbmax.x-this.aabbmin.x,o=this.aabbmax.y-this.aabbmin.y,n=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*o*2*o+2*n*2*n),e.y=1/12*t*(2*i*2*i+2*n*2*n),e.z=1/12*t*(2*o*2*o+2*i*2*i)},this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,o=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var n=0;n<t;n++){var r=o[n];r.x<e.x?e.x=r.x:r.x>i.x&&(i.x=r.x),r.y<e.y?e.y=r.y:r.y>i.y&&(i.y=r.y),r.z<e.z?e.z=r.z:r.z>i.z&&(i.z=r.z)}},this.boundingSphereRadius=function(){for(var t=0,e=0;e<this.vertices.length;e++){var i=this.vertices[e].norm2();i>t&&(t=i)}return Math.sqrt(t)},this.computeAABB()},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.Solver=function(){this.iterations=10,this.h=1/60,this.k=1e3,this.d=4,this.a=0,this.b=0,this.eps=0,this.setSpookParams(this.k,this.d),this.reset(0),this.debug=!1,this.debug&&console.log("a:",this.a,"b",this.b,"eps",this.eps,"k",this.k,"d",this.d)},t.Solver.prototype.setSpookParams=function(t,e){var i=this.h;this.k=t,this.d=e,this.a=4/(i*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(i*i*t*(1+4*e))},t.Solver.prototype.reset=function(t){this.G=[],this.MinvTrace=[],this.Fext=[],this.q=[],this.qdot=[],this.n=0,this.upper=[],this.lower=[],this.hasupper=[],this.haslower=[],this.i=[],this.j=[],this.vxlambda=[],this.vylambda=[],this.vzlambda=[],this.wxlambda=[],this.wylambda=[],this.wzlambda=[];for(var e=0;e<t;e++)this.vxlambda.push(0),this.vylambda.push(0),this.vzlambda.push(0),this.wxlambda.push(0),this.wylambda.push(0),this.wzlambda.push(0)},t.Solver.prototype.addConstraint=function(t,e,i,o,n,r,s,a,h){this.debug&&(console.log("Adding constraint ",this.n," between body ",a," and ",h),console.log("G:",t),console.log("q:",i),console.log("qdot:",o),console.log("Fext:",n),console.log("lower:",r),console.log("upper:",s));for(var l=0;l<12;l++)this.q.push(i[l]),this.qdot.push(o[l]),this.MinvTrace.push(e[l]),this.G.push(t[l]),this.Fext.push(n[l]);return this.upper.push(s),this.hasupper.push(!isNaN(s)),this.lower.push(r),this.haslower.push(!isNaN(r)),this.i.push(a),this.j.push(h),this.n+=1,this.n-1},t.Solver.prototype.addConstraint2=function(t,e,i){t.update();for(var o=0;o<t.equations.length;o++){var n=t.equations[o];this.addConstraint([n.G1.x,n.G1.y,n.G1.z,n.G2.x,n.G2.y,n.G2.z,n.G3.x,n.G3.y,n.G3.z,n.G4.x,n.G4.y,n.G4.z],[n.iM1.x,n.iM1.y,n.iM1.z,n.iM2.x,n.iM2.y,n.iM2.z,n.iM3.x,n.iM3.y,n.iM3.z,n.iM4.x,n.iM4.y,n.iM4.z],[n.g1.x,n.g1.y,n.g1.z,n.g2.x,n.g2.y,n.g2.z,n.g3.x,n.g3.y,n.g3.z,n.g4.x,n.g4.y,n.g4.z],[n.W1.x,n.W1.y,n.W1.z,n.W2.x,n.W2.y,n.W2.z,n.W3.x,n.W3.y,n.W3.z,n.W4.x,n.W4.y,n.W4.z],[n.f1.x,n.f1.y,n.f1.z,n.f2.x,n.f2.y,n.f2.z,n.f3.x,n.f3.y,n.f3.z,n.f4.x,n.f4.y,n.f4.z],n.lambdamin,n.lambdamax,e,i)}},t.Solver.prototype.addNonPenetrationConstraint=function(t,e,i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g){var v=r.cross(n),x=m.vsub(u),b=o.vadd(s).vsub(i.vadd(r));b.dot(n)<0&&(this.debug&&(console.log("i:",t,"j",e,"xi",i.toString(),"xj",o.toString()),console.log("ni",n.toString(),"ri",r.toString(),"rj",s.toString()),console.log("iMi",a.toString(),"iMj",h.toString(),"iIi",l.toString(),"iIj",c.toString(),"vi",u.toString(),"vj",m.toString(),"wi",d.toString(),"wj",p.toString(),"fi",_.toString(),"fj",f.toString(),"taui",y.toString(),"tauj",g.toString())),this.addConstraint([-n.x,-n.y,-n.z,-v.x,-v.y,-v.z,n.x,n.y,n.z,v.x,v.y,v.z],[a.x,a.y,a.z,l.z,l.y,l.z,h.x,h.y,h.z,c.z,c.y,c.z],[-b.x,-b.y,-b.z,0,0,0,b.x,b.y,b.z,0,0,0],[-x.x,-x.y,-x.z,0,0,0,x.x,x.y,x.z,0,0,0],[_.x,_.y,_.z,y.x,y.y,y.z,f.x,f.y,f.z,g.x,g.y,g.z],0,"inf",t,e))},t.Solver.prototype.solve=function(){for(var t=this.n,e=[],i=[],o=[],n=[],r=[],s=this.iterations,a=this.G,h=this.debug,l=this.a,c=this.eps,u=this.lower,m=this.haslower,d=this.upper,p=this.hasupper,_=this.vxlambda,f=this.vylambda,y=this.vzlambda,g=this.wxlambda,v=this.wylambda,x=this.wzlambda,b=this.MinvTrace,E=0;E<t;E++){e.push(0),i.push(0),o.push(0),n.push(0),r.push(0);for(var T=0;T<12;T++)i.push(0)}for(var w=0;w<s;w++)for(var S=0;S<t;S++){var C=this.i[S],R=this.j[S],M=12*S;if(!r[S]){for(var D=0,A=0,B=0,I=0,E=0;E<12;E++){var H=M+E;D+=a[H]*b[H]*a[H],A+=a[H]*this.q[H],B+=a[H]*this.qdot[H],I+=a[H]*b[H]*this.Fext[H]}n[S]=1/(D+c),o[S]=-l*A-this.b*B-this.h*I,r[S]=1,h&&(console.log("G_Minv_Gt["+S+"]:",D),console.log("Gq["+S+"]:",A),console.log("GW["+S+"]:",B),console.log("GMinvf["+S+"]:",I))}var P=0;C>=0&&(P+=a[0+M]*_[C],P+=a[1+M]*f[C],P+=a[2+M]*y[C],P+=a[3+M]*g[C],P+=a[4+M]*v[C],P+=a[5+M]*x[C],h&&isNaN(P)&&console.log("found NaN Gulambda",_)),-1!==R&&(P+=a[6+M]*_[R],P+=a[7+M]*f[R],P+=a[8+M]*y[R],P+=a[9+M]*g[R],P+=a[10+M]*v[R],P+=a[11+M]*x[R]),i[S]=n[S]*(o[S]-P-c*e[S]),h&&console.log("dlambda["+S+"]=",i[S],"rest = ",n[S],o[S],P,c,e[S],S,C,R),e[S]=e[S]+i[S],m[S]&&e[S]<u[S]&&(h&&console.log("hit lower bound for constraint "+S+", truncating "+e[S]+" to the bound "+u[S]),e[S]=u[S],i[S]=u[S]-e[S]),p&&e[S]>d[S]&&(h&&console.log("hit upper bound for constraint "+S+", truncating "+e[S]+" to the bound "+d[S]),e[S]=d[S],i[S]=d[S]-e[S]),-1!==C&&(_[C]+=i[S]*b[M+0]*a[M+0],f[C]+=i[S]*b[M+1]*a[M+1],y[C]+=i[S]*b[M+2]*a[M+2],g[C]+=i[S]*b[M+3]*a[M+3],v[C]+=i[S]*b[M+4]*a[M+4],x[C]+=i[S]*b[M+5]*a[M+5]),-1!==R&&(_[R]+=i[S]*b[M+6]*a[M+6],f[R]+=i[S]*b[M+7]*a[M+7],y[R]+=i[S]*b[M+8]*a[M+8],g[R]+=i[S]*b[M+9]*a[M+9],v[R]+=i[S]*b[M+10]*a[M+10],x[R]+=i[S]*b[M+11]*a[M+11])}if(h)for(var E=0;E<this.vxlambda.length;E++)console.log("dv["+E+"]=",_[E],f[E],y[E],g[E],v[E],x[E])},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0==t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var o=t[e].indexOf(i);-1!==o&&t[e].splice(o,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t in arguments)this.objects.push(arguments[t])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=t.Vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return new t.Vec3},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,o){this.id=-1,this.materials=[t,e],this.friction=void 0!=i?Number(i):.3,this.restitution=void 0!=o?Number(o):.3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new t.Vec3,this.broadphase=null,this.bodies=[];this.solver=new t.Solver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.temp={gvec:new t.Vec3,vi:new t.Vec3,vj:new t.Vec3,wi:new t.Vec3,wj:new t.Vec3,t1:new t.Vec3,t2:new t.Vec3,rixn:new t.Vec3,rjxn:new t.Vec3,step_q:new t.Quaternion,step_w:new t.Quaternion,step_wq:new t.Quaternion}},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var o=e.id,n=i.id;if(o<n){var r=o;o=n,n=r}return this.contactmaterials[this.mats2cmat[o+n*this.materials.length]]}},t.World.prototype._addImpulse=function(e,i,o,n,r,s,a,h){var l=o.crossmat(),c=n.crossmat(),u=this.inertiax[e]>0?1/this.inertiax[e]:0,m=new t.Mat3([u,0,0,0,u,0,0,0,u]);u=this.inertiax[i]>0?1/this.inertiax[i]:0;var d=new t.Mat3([u,0,0,0,u,0,0,0,u]),p=this.invm[e]+this.invm[i],_=new t.Mat3([p,0,0,0,p,0,0,0,p]),f=(l.mmult(m.mmult(l)),c.mmult(d.mmult(c)),s.mult(-a*r.dot(s))),y=_.solve(f.vsub(r)),g=this.invm[e],v=this.invm[i];this.vx[e]+=y.x*g-(this.vx[i]-r.x),this.vy[e]+=y.y*g-(this.vy[i]-r.y),this.vz[e]+=y.z*g-(this.vz[i]-r.z),this.vx[i]-=y.x*v+(this.vx[e]+r.x),this.vy[i]-=y.y*v+(this.vy[e]+r.y),this.vz[i]-=y.z*v+(this.vz[e]+r.z);var x=o.cross(y);x.mult(1/this.inertiax[e])},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.clearCollisionState=function(t){for(var e=this.numObjects(),i=t.id,o=0;o<e;o++){var n=o;i>n?this.collision_matrix[n+i*e]=0:this.collision_matrix[i+n*e]=0}},t.World.prototype.add=function(e){var i=this.numObjects();this.bodies.push(e),e.id=this.id(),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e instanceof t.RigidBody&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion)),this.collision_matrix=new Int16Array((i+1)*(i+1))},t.World.prototype.addConstraint=function(e){e instanceof t.Constraint&&(this.constraints.push(e),e.id=this.id())},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects(),i=this.bodies;for(var o in i)i[o].id==t.id&&i.splice(o,1);this.collision_matrix=new Int16Array((e-1)*(e-1))},t.World.prototype.addMaterial=function(t){if(-1==t.id){this.materials.push(t),t.id=this.materials.length-1;for(var e=new Int16Array(this.materials.length*this.materials.length),i=0;i<e.length;i++)e[i]=-1;for(var i=0;i<this.materials.length-1;i++)for(var o=0;o<this.materials.length-1;o++)e[i+this.materials.length*o]=this.mats2cmat[i+(this.materials.length-1)*o];this.mats2cmat=e}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]),t.materials[0].id>t.materials[1].id?(i=t.materials[0].id,j=t.materials[1].id):(j=t.materials[0].id,i=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=t.id},t.World.prototype._id2index=function(t){for(var e=0;e<this.bodies.length;e++)if(this.bodies[e].id===t)return e;return-1},t.World.prototype.step=function(e){function i(t,e,i){if(void 0===i&&(i=!0),i&&t<e||!i&&t>e){var o=e;e=t,t=o}return r.collision_matrix[t+e*s]}function o(t,e,i,o){if(void 0===o&&(o=!0),o&&t<e||!o&&t>e){var n=e;e=t,t=n}r.collision_matrix[t+e*s]=parseInt(i)}var n=this,r=this,s=this.numObjects(),a=this.bodies;void 0==e&&(e=this.last_dt?this.last_dt:this.default_dt);for(var h=0;h<s;h++){var l=a[h];if(l.motionstate&t.Body.DYNAMIC){var c=a[h].force,u=a[h].mass;c.x+=n.gravity.x*u,c.y+=n.gravity.y*u,c.z+=n.gravity.z*u}}var m=this.broadphase.collisionPairs(this),d=m[0],p=m[1];t.Shape.types.SPHERE,t.Shape.types.PLANE,t.Shape.types.BOX,t.Shape.types.COMPOUND;!function(){for(var t=0;t<a.length;t++)for(var e=0;e<t;e++){var n=i(t,e,!0);o(t,e,n,!1),o(t,e,0,!0)}}(),this.solver.reset(s);var _=this.contacts;this.contacts=[],this.contactgen.getContacts(d,p,this,this.contacts,_);for(var f=this.temp,y=0;y<this.contacts.length;y++){var g=this.contacts[y],l=g.bi,v=g.bj,h=this._id2index(l.id),x=this._id2index(v.id),b=(i(h,x,!1),.3),E=this.getContactMaterial(l.material,v.material);E&&(b=E.friction,E.restitution);var T=f.gvec;T.set(v.position.x+g.rj.x-l.position.x-g.ri.x,v.position.y+g.rj.y-l.position.y-g.ri.y,v.position.z+g.rj.z-l.position.z-g.ri.z);var w=T.dot(g.ni);if(w<0){o(h,x,1,!0),i(h,x,!0)!=i(h,x,!1)&&(l.dispatchEvent({type:"collide",with:v}),v.dispatchEvent({type:"collide",with:l}),l.wakeUp(),v.wakeUp());var S=l.velocity,C=l.angularVelocity,R=v.velocity,M=v.angularVelocity,D=g.ni,A=[f.t1,f.t2];D.tangents(A[0],A[1]);var B=S.vadd(C.cross(g.ri)),I=R.vadd(M.cross(g.rj)),H=I.vsub(B),P=M.cross(g.rj).vsub(C.cross(g.ri)),L=R.vsub(S),V=g.rj.cross(M).vsub(g.ri.cross(C));L.vsub(V,L);var k=l.invMass,F=v.invMass,z=l.invInertia.x,N=l.invInertia.y,U=l.invInertia.z,O=v.invInertia.x,G=v.invInertia.y,W=v.invInertia.z,j=f.rixn,q=f.rjxn;g.ri.cross(D,j),g.rj.cross(D,q);var J=D.mult(.5*H.dot(D)),X=(j.unit().mult(P.dot(j.unit())),q.unit().mult(-P.dot(q.unit())),g.ni.mult(w));if(this.solver.addConstraint([-D.x,-D.y,-D.z,-j.x,-j.y,-j.z,D.x,D.y,D.z,q.x,q.y,q.z],[k,k,k,z,N,U,F,F,F,O,G,W],[-X.x,-X.y,-X.z,0,0,0,X.x,X.y,X.z,0,0,0],[-J.x,-J.y,-J.z,0,0,0,J.x,J.y,J.z,0,0,0],[l.force.x,l.force.y,l.force.z,l.tau.x,l.tau.y,l.tau.z,-v.force.x,-v.force.y,-v.force.z,-v.tau.x,-v.tau.y,-v.tau.z],0,"inf",h,x),b>0)for(var w=r.gravity.norm(),Y=0;Y<A.length;Y++){var K=A[Y],Z=g.ri.cross(K),$=g.rj.cross(K),Q=K.mult(H.dot(K))
;Z.unit().mult(H.dot(Z.unit())),$.unit().mult(-H.dot($.unit()));this.solver.addConstraint([-K.x,-K.y,-K.z,-Z.x,-Z.y,-Z.z,K.x,K.y,K.z,$.x,$.y,$.z],[k,k,k,z,N,U,F,F,F,O,G,W],[0,0,0,0,0,0,0,0,0,0,0,0],[-Q.x,-Q.y,-Q.z,0,0,0,Q.x,Q.y,Q.z,0,0,0],[l.force.x,l.force.y,l.force.z,l.tau.x,l.tau.y,l.tau.z,v.force.x,v.force.y,v.force.z,v.tau.x,v.tau.y,v.tau.z],100*-b*(l.mass+v.mass),100*b*(l.mass+v.mass),h,x)}}}for(var h=0;h<this.constraints.length;h++){for(var v=-1,l=-1,x=0;x<this.bodies.length;x++)this.bodies[x].id===this.constraints[h].body_i.id?l=x:this.bodies[x].id===this.constraints[h].body_j.id&&(v=x);this.solver.addConstraint2(this.constraints[h],l,v)}var l;if(this.solver.n){this.solver.h=e,this.solver.solve();for(var h=0;h<s;h++)if(l=a[h],l.motionstate&t.Body.DYNAMIC){var tt=a[h];tt.velocity.x+=this.solver.vxlambda[h],tt.velocity.y+=this.solver.vylambda[h],tt.velocity.z+=this.solver.vzlambda[h],tt.angularVelocity&&(tt.angularVelocity.x+=this.solver.wxlambda[h],tt.angularVelocity.y+=this.solver.wylambda[h],tt.angularVelocity.z+=this.solver.wzlambda[h])}}for(var h=0;h<s;h++)if(l=a[h],l.motionstate&t.Body.DYNAMIC){var et=1-l.linearDamping,it=1-l.angularDamping;l.velocity.mult(et,l.velocity),l.angularVelocity&&l.angularVelocity.mult(it,l.angularVelocity)}r.dispatchEvent({type:"preStep"});for(var h in a){var l=a[h];l.preStep&&l.preStep.call(l)}for(var ot=(f.step_q,f.step_w),nt=f.step_wq,rt=t.Body.DYNAMIC|t.Body.KINEMATIC,h=0;h<s;h++){var tt=a[h];tt.motionstate&rt&&(tt.velocity.x+=tt.force.x*tt.invMass*e,tt.velocity.y+=tt.force.y*tt.invMass*e,tt.velocity.z+=tt.force.z*tt.invMass*e,tt.angularVelocity&&(tt.angularVelocity.x+=tt.tau.x*tt.invInertia.x*e,tt.angularVelocity.y+=tt.tau.y*tt.invInertia.y*e,tt.angularVelocity.z+=tt.tau.z*tt.invInertia.z*e),tt.isSleeping()||(tt.position.x+=tt.velocity.x*e,tt.position.y+=tt.velocity.y*e,tt.position.z+=tt.velocity.z*e,tt.angularVelocity&&(ot.set(tt.angularVelocity.x,tt.angularVelocity.y,tt.angularVelocity.z,0),ot.mult(tt.quaternion,nt),tt.quaternion.x+=.5*e*nt.x,tt.quaternion.y+=.5*e*nt.y,tt.quaternion.z+=.5*e*nt.z,tt.quaternion.w+=.5*e*nt.w,n.stepnumber%3==0&&tt.quaternion.normalizeFast()))),tt.force.set(0,0,0),tt.tau&&tt.tau.set(0,0,0)}n.time+=e,n.stepnumber+=1,r.dispatchEvent({type:"postStep"});for(var h in a){var l=a[h];l.postStep&&l.postStep.call(l)}if(n.allowSleep)for(var h=0;h<s;h++){var l=a[h];l.sleepTick()}},t.ContactPoint=function(e,i,o,n,r){this.ri=new t.Vec3,this.rj=new t.Vec3,this.ni=new t.Vec3,o&&o.copy(this.ri),n&&n.copy(this.rj),r&&r.copy(this.ni),this.bi=e,this.bj=i},t.ContactGenerator=function(){function e(n,r,s,a,h,l,c,u,m){function d(e,o){if(i.length){var n=i.pop();return n.bi=e,n.bj=o,n}return new t.ContactPoint(e,o)}function p(t,i,o,n,r,s,a,h,l){for(var c=0;c<o.childShapes.length;c++){var u=[];e(u,i,o.childShapes[c],n,r.vadd(a.vmult(o.childOffsets[c])),s,a.mult(o.childOrientations[c]),h,l);for(var m=0;m<u.length;m++)u[m].rj.vadd(a.vmult(o.childOffsets[c]),u[m].rj),t.push(u[m])}}var _=!1;if(r.type>s.type){var f;f=s,s=r,r=f,f=h,h=a,a=f,f=c,c=l,l=f,f=m,m=u,u=f,_=!0}if(r.type==t.Shape.types.SPHERE){if(s.type==t.Shape.types.SPHERE){var y=d(u,m);h.vsub(a,y.ni),y.ni.normalize(),y.ni.copy(y.ri),y.ni.copy(y.rj),y.ri.mult(r.radius,y.ri),y.rj.mult(-s.radius,y.rj),n.push(y)}else if(s.type==t.Shape.types.PLANE){var y=d(u,m);s.normal.copy(y.ni),c.vmult(y.ni,y.ni),y.ni.negate(y.ni),y.ni.normalize(),y.ni.mult(r.radius,y.ri);var g=a.vsub(h),v=y.ni.mult(y.ni.dot(g));y.rj=g.vsub(v),v.norm()<=r.radius&&n.push(y)}else if(s.type==t.Shape.types.BOX){for(var x=a.vsub(h),b=s.getSideNormals(!0,c),E=r.radius,T=!1,w=0;w<b.length&&!T;w++){var S=b[w].copy(),C=S.norm();S.normalize();var R=x.dot(S);if(R<C+E&&R>0){var M=b[(w+1)%3].copy(),D=b[(w+2)%3].copy(),A=M.norm(),B=D.norm();M.normalize(),D.normalize();var I=x.dot(M),H=x.dot(D);if(I<A&&I>-A&&H<B&&H>-B){T=!0;var y=d(u,m);S.mult(-E,y.ri),S.copy(y.ni),y.ni.negate(y.ni),S.mult(C).vadd(M.mult(I)).vadd(D.mult(H),y.rj),n.push(y)}}}for(var P=o.get(),L=0;L<2&&!T;L++)for(var V=0;V<2&&!T;V++)for(var k=0;k<2&&!T;k++){P.set(0,0,0),L?P.vadd(b[0],P):P.vsub(b[0],P),V?P.vadd(b[1],P):P.vsub(b[1],P),k?P.vadd(b[2],P):P.vsub(b[2],P);var F=h.vadd(P).vsub(a);if(F.norm()<E){T=!0;var y=d(u,m);F.copy(y.ri),y.ri.normalize(),y.ri.copy(y.ni),y.ri.mult(E,y.ri),P.copy(y.rj),n.push(y)}}o.release(P),P=null;for(var z=o.get(),N=o.get(),y=o.get(),U=o.get(),O=o.get(),L=0;L<b.length&&!T;L++)for(var V=0;V<b.length&&!T;V++)if(L%3!=V%3){b[V].cross(b[L],z),z.normalize(),b[L].vadd(b[V],N),a.copy(y),y.vsub(N,y),y.vsub(h,y);var G=y.dot(z);z.mult(G,U);for(var k=0;k==L%3||k==V%3;)k++;a.copy(O),O.vsub(U,O),O.vsub(N,O),O.vsub(h,O);var W=Math.abs(G),j=O.norm();if(W<b[k].norm()&&j<E){T=!0;var q=d(u,m);N.vadd(U,q.rj),q.rj.copy(q.rj),O.negate(q.ni),q.ni.normalize(),q.rj.copy(q.ri),q.ri.vadd(h,q.ri),q.ri.vsub(a,q.ri),q.ri.normalize(),q.ri.mult(E,q.ri),n.push(q)}}o.release(z,N,y,U,O)}else if(s.type==t.Shape.types.COMPOUND)p(n,r,s,a,h,l,c,u,m);else if(s.type==t.Shape.types.CONVEXPOLYHEDRON)throw new Error("sphere/convexpolyhedron contacts not implemented yet.")}else if(r.type==t.Shape.types.PLANE){if(s.type==t.Shape.types.PLANE)throw"Plane-plane collision... wait, you did WHAT?";if(s.type==t.Shape.types.BOX)for(var J=r.normal.copy(),X=0,Y=s.getCorners(c),w=0;w<Y.length&&X<=4;w++){var y=d(u,m),K=Y[w].vadd(h);Y[w].copy(y.rj);var Z=K.vsub(a),$=J.dot(Z);if($<=0){X++;var Q=J.mult($);Z.vsub(Q,y.ri),J.copy(y.ni),n.push(y)}}else if(s.type==t.Shape.types.COMPOUND)p(n,r,s,a,h,l,c,u,m);else if(s.type==t.Shape.types.CONVEXPOLYHEDRON){var tt=o.get(),et=o.get();r.normal.tangents(tt,et),tt.mult(1e5,tt),et.mult(1e5,et);var J=o.get();r.normal.copy(J);var it=[new t.Vec3(-tt.x-et.x-J.x,-tt.y-et.y-J.y,-tt.z-et.z-J.z),new t.Vec3(tt.x-et.x+0*J.x,tt.y-et.y+0*J.y,tt.z-et.z+0*J.z),new t.Vec3(tt.x+et.x-J.x,tt.y+et.y-J.y,tt.z+et.z-J.z),new t.Vec3(-tt.x+et.x-J.x,-tt.y+et.y-J.y,-tt.z+et.z-J.z),new t.Vec3(-tt.x-et.x+0*J.x,-tt.y-et.y+0*J.y,-tt.z-et.z+0*J.z),new t.Vec3(+tt.x-et.x+0*J.x,tt.y-et.y+0*J.y,tt.z-et.z+0*J.z),new t.Vec3(+tt.x+et.x+0*J.x,+tt.y+et.y+0*J.y,tt.z+et.z+0*J.z),new t.Vec3(-tt.x+et.x+0*J.x,-tt.y+et.y+0*J.y,-tt.z+et.z+0*J.z)];tt.normalize(),et.normalize();var ot=new t.ConvexPolyhedron(it,[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new t.Vec3(-J.x,-J.y,-J.z),new t.Vec3(J.x,J.y,J.z),new t.Vec3(-et.x,-et.y,-et.z),new t.Vec3(et.x,et.y,et.z),new t.Vec3(-tt.x,-tt.y,-tt.z),new t.Vec3(tt.x,tt.y,tt.z)]),nt=o.get();J.negate(nt);var rt=o.get();if(!1!==s.testSepAxis(nt,ot,h,c,a,l)){var q=[];ot.clipAgainstHull(a,l,s,h,c,nt,-100,100,q);for(var L=0;L<q.length;L++){var y=d(u,m);nt.negate(y.ni),q[L].normal.negate(rt),rt.mult(q[L].depth,rt),y.ri.set(q[L].point.x+rt.x,q[L].point.y+rt.y,q[L].point.z+rt.z),y.rj.set(q[L].point.x,q[L].point.y,q[L].point.z),y.rj.vsub(h,y.rj),y.ri.vsub(a,y.ri),n.push(y)}}o.release(rt,tt,et,nt,J)}}else if(r.type==t.Shape.types.BOX)s.type==t.Shape.types.BOX?e(n,r.convexPolyhedronRepresentation,s.convexPolyhedronRepresentation,a,h,l,c,u,m):s.type==t.Shape.types.COMPOUND?p(n,r,s,a,h,l,c,u,m):s.type==t.Shape.types.CONVEXPOLYHEDRON&&e(n,r.convexPolyhedronRepresentation,s,a,h,l,c,u,m);else if(r.type==t.Shape.types.COMPOUND)s.type==t.Shape.types.COMPOUND?p(n,r,s,a,h,l,c,u,m):s.type==t.Shape.types.CONVEXPOLYHEDRON&&p(n,s,r,h,a,c,l,m,u);else if(r.type==t.Shape.types.CONVEXPOLYHEDRON&&s.type==t.Shape.types.CONVEXPOLYHEDRON){var nt=new t.Vec3;if(r.findSeparatingAxis(s,a,l,h,c,nt)){var q=[],rt=new t.Vec3;r.clipAgainstHull(a,l,s,h,c,nt,-100,100,q);for(var L=0;L<q.length;L++){var y=d(u,m);nt.negate(y.ni),q[L].normal.negate(rt),rt.mult(q[L].depth,rt),y.ri.set(q[L].point.x+rt.x,q[L].point.y+rt.y,q[L].point.z+rt.z),y.rj.set(q[L].point.x,q[L].point.y,q[L].point.z),y.rj.vsub(h,y.rj),y.ri.vsub(a,y.ri),n.push(y)}}}for(var st=0;_&&st<n.length;st++)!function(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e}(n[st])}this.contactReduction=!0;var i=[],o=new t.Vec3Pool;this.reduceContacts=function(t){},this.getContacts=function(t,o,n,r,s){for(var a=0;s&&a<s.length;a++)i.push(s[a]);for(var h=0;h<t.length;h++){var l=t[h],c=o[h];e(r,l.shape,c.shape,l.position,c.position,l.quaternion,c.quaternion,l,c)}}},t.Constraint=function(){this.equations=[],this.id=-1},t.Constraint.prototype.constructor=t.Constraint,t.Constraint.prototype.update=function(){throw"update() not implemented in this Constraint subclass!"},t.ContactConstraint=function(e,i,o){t.Constraint.call(this),this.body_i=e,this.body_j=i,this.contact=contact,this.slipForce=o,this.unused_equations=[],this.temp={rixn:new t.Vec3,rjxn:new t.Vec3,t1:new t.Vec3,t2:new t.Vec3}},t.ContactConstraint.prototype=new t.Constraint,t.ContactConstraint.prototype.constructor=t.ContactConstraint,t.ContactConstraint.prototype.update=function(){var t=this.body_i,e=this.body_j,i=t.velocity,o=t.angularVelocity,r=e.velocity,s=e.angularVelocity,a=[this.temp.t1,this.temp.t2];for(var h in t.contacts)for(var l in e.contacts)if(t.contacts[h].to.id==e.id&&e.contacts[l].to.id==t.id){t.contacts[h].r,e.contacts[l].r,t.contacts[h].n;n.tangents(a[0],a[1]);var u=i.vadd(o.cross(c.ri)),m=r.vadd(s.cross(c.rj)),d=m.vsub(u),p=s.cross(c.rj).vsub(o.cross(c.ri)),_=r.vsub(i),f=c.rj.cross(s).vsub(c.ri.cross(o));_.vsub(f,_);var y=(t.invMass,e.invMass,t.invInertia.x,t.invInertia.y,t.invInertia.z,e.invInertia.x,e.invInertia.y,e.invInertia.z,this.temp.rixn),v=this.temp.rjxn;c.ri.cross(n,y),c.rj.cross(n,v);var x=n.mult(d.dot(n)),b=(y.unit().mult(p.dot(y.unit())),v.unit().mult(-p.dot(v.unit())),c.ni.mult(g));n.negate(eq.G1),y.negate(eq.G2),n.copy(eq.G3),v.copy(eq.G4),eq.setDefaultMassProps(),b.negate(eq.g1),b.copy(eq.g3),x.negate(eq.W1),x.copy(eq.W3),t.force.copy(eq.f1),t.tau.copy(eq.f2),e.force.copy(eq.f3),e.tau.copy(eq.f4),eq.lambdamin=0,eq.lambdamax="inf"}},t.DistanceConstraint=function(e,i,o){t.Constraint.call(this),this.body_i=e,this.body_j=i,this.distance=Number(o);var n=new t.Equation(e,i instanceof t.Vec3?null:i);this.equations.push(n)},t.DistanceConstraint.prototype=new t.Constraint,t.DistanceConstraint.prototype.constructor=t.DistanceConstraint,t.DistanceConstraint.prototype.update=function(){var t=this.equations[0],e=this.body_i,i=this.body_j,o="number"==typeof i.mass;o?i.position.vsub(e.position,t.G1):e.position.vsub(i,t.G1),t.G1.normalize(),t.G1.isZero()&&t.G1.set(1,0,0),t.G1.negate(t.G3),t.setDefaultMassProps(),t.setDefaultForce(),t.g1.set((o?i.position.x:i.x)-e.position.x-t.G1.x*this.distance,(o?i.position.y:i.y)-e.position.y-t.G1.y*this.distance,(o?i.position.z:i.z)-e.position.z-t.G1.z*this.distance),t.g1.negate(t.g1),t.g1.negate(t.g3)},t.DistanceConstraint.prototype.setMaxForce=function(t){this.equations[0].lambdamax=Math.abs(t),this.equations[0].lambdamin=-this.equations[0].lambdamax},t.Equation=function(e,i){this.G1=new t.Vec3,this.G2=new t.Vec3,this.G3=new t.Vec3,this.G4=new t.Vec3,this.iM1=new t.Vec3,this.iM2=new t.Vec3,this.iM3=new t.Vec3,this.iM4=new t.Vec3,this.g1=new t.Vec3,this.g2=new t.Vec3,this.g3=new t.Vec3,this.g4=new t.Vec3,this.W1=new t.Vec3,this.W2=new t.Vec3,this.W3=new t.Vec3,this.W4=new t.Vec3,this.f1=new t.Vec3,this.f2=new t.Vec3,this.f3=new t.Vec3,this.f4=new t.Vec3,this.lambdamax=1e6,this.lambdamin=-1e6,this.body_i=e,this.body_j=i},t.Equation.prototype.setDefaultMassProps=function(){var t=this.body_i,e=this.body_j;t&&(this.iM1.set(t.invMass,t.invMass,t.invMass),t.invInertia&&t.invInertia.copy(this.iM2)),e&&(this.iM3.set(e.invMass,e.invMass,e.invMass),e.invInertia&&e.invInertia.copy(this.iM4))},t.Equation.prototype.setDefaultForce=function(){var t=this.body_i,e=this.body_j;t&&(t.force.copy(this.f1),t.tau&&t.tau.copy(this.f2)),e&&(e.force.copy(this.f3),e.tau&&e.tau.copy(this.f4))},t.PointToPointConstraint=function(e,i,o,n){t.Constraint.call(this),this.body_i=e,this.body_j=o,this.pivot_i=i,this.pivot_j=n;for(var r=0;r<3;r++)this.equations.push(new Equation(e,o))},t.PointToPointConstraint.prototype=new t.Constraint,t.PointToPointConstraint.prototype.constructor=t.PointToPointConstraint,t.PointToPointConstraint.prototype.update=function(){},"undefined"!=typeof module?module.exports=t:this.CANNON=t}.apply(this);var IgeCannonComponent=IgeEventingClass.extend({classId:"IgeCannonComponent",componentId:"cannon",init:function(t,e){this._entity=t,this._options=e,this._active=!0,this._sleep=!0,this._scaleRatio=1,this._solverIterations=10,this._gravity=new CANNON.Vec3(0,0,-60),this._broadphase=new CANNON.NaiveBroadphase,this._removeWhenReady=[],this._normalMaterial=new CANNON.Material("normalMaterial"),this._slipperyMaterial=new CANNON.Material("slipperyMaterial"),this._slipperyNormalCm=new CANNON.ContactMaterial(this._normalMaterial,this._slipperyMaterial,0,.3),ige.addBehaviour("cannonStep",this._behaviour)},sleep:function(t){return void 0!==t?(this._sleep=t,this._entity):this._sleep},scaleRatio:function(t){return void 0!==t?(this._scaleRatio=t,this._entity):this._scaleRatio},gravity:function(t,e,i){return void 0!==t&&void 0!==e?(this._gravity=new CANNON.Vec3(t,e,i),this._world&&this._world.gravity.set(this._gravity.x,this._gravity.y,this._gravity.z),this._entity):this._gravity},solverIterations:function(){return void 0!==val?(this._solverIterations=val,this._entity):this._solverIterations},createWorld:function(){return this._world=new CANNON.World,this._world.gravity.set(this._gravity.x,this._gravity.y,this._gravity.z),this._world.broadphase=this._broadphase,this._world.solver.iterations=this._solverIterations,this._world.allowSleep=this._sleep,this._world.addContactMaterial(this._slipperyNormalCm),this._entity},createFloor:function(t,e,i){var o=new CANNON.Plane(new CANNON.Vec3(t,e,i)),n=new CANNON.RigidBody(0,o,this._slipperyMaterial);this._world.add(n)},createBody:function(t,e){var i,o,n,r,s;switch(e.type){case"static":CANNON.Body.STATIC;break;case"kinematic":CANNON.Body.KINEMATIC;break;case"dynamic":CANNON.Body.DYNAMIC}for(i in e)if(e.hasOwnProperty(i))switch(i){case"fixtures":for(s=0;s<e.fixtures.length;s++)if(o=e.fixtures[s],o.shape)switch(o.shape.type){case"box":n=o.shape.data?void 0!==o.shape.data.sizeX&&void 0!==o.shape.data.sizeY&&void 0!==o.shape.data.sizeZ?new CANNON.Box(new CANNON.Vec3(o.shape.data.sizeX/this._scaleRatio,o.shape.data.sizeY/this._scaleRatio,o.shape.data.sizeZ/this._scaleRatio)):new CANNON.Box(new CANNON.Vec3(t._bounds3d.x2+1/this._scaleRatio,t._bounds3d.y2/this._scaleRatio,t._bounds3d.z2/this._scaleRatio)):new CANNON.Box(new CANNON.Vec3(t._bounds3d.x2+1/this._scaleRatio,t._bounds3d.y2+1/this._scaleRatio,t._bounds3d.z2+1/this._scaleRatio))}}return r=new CANNON.RigidBody(e.mass,n,this._normalMaterial),r.sleepSpeedLimit=.1,r.sleepTimeLimit=1e3,void 0!==e.allowSleep&&(r.allowSleep=e.allowSleep),void 0!==e.sleepSpeedLimit&&(r.sleepSpeedLimit=e.sleepSpeedLimit),void 0!==e.sleepTimeLimit&&(r.sleepTimeLimit=e.sleepTimeLimit),void 0!==e.angularDamping&&(r.angularDamping=e.angularDamping),void 0!==e.linearDamping&&(r.linearDamping=e.linearDamping),r.position.set(t._translate.x/this._scaleRatio,t._translate.y/this._scaleRatio,(t._translate.z+t._bounds3d.z2)/this._scaleRatio),r._igeEntity=t,this._world.add(r),r},enableDebug:function(t){var e=new this.b2DebugDraw;this._cannonDebug=!0,this._debugCanvas=document.getElementById(t),this._debugCtx=this._debugCanvas.getContext("2d"),e.SetSprite(this._debugCtx),e.SetDrawScale(this._scaleRatio),e.SetFillAlpha(.3),e.SetLineThickness(1),e.SetFlags(this.b2DebugDraw.e_controllerBit|this.b2DebugDraw.e_jointBit|this.b2DebugDraw.e_pairBit|this.b2DebugDraw.e_shapeBit),this._world.SetDebugDraw(e)},_behaviour:function(t){var e,i,o=ige.cannon,n=o._world.bodies,r=n.length;if(o._active){for(o._world.step(1/60);r--;)e=n[r],e._igeEntity&&e.isAwake()&&(i=e._igeEntity,e._igeUpdating=!0,i.translateTo(Math.ceil(e.position.x*o._scaleRatio),Math.ceil(e.position.y*o._scaleRatio),Math.ceil(e.position.z*o._scaleRatio-i._bounds3d.z2)),e._igeUpdating=!1);"function"==typeof o._updateCallback&&o._updateCallback()}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeCannonComponent);var IgeTimeSyncExtension={timeSyncInterval:function(t){return void 0!==t?(this._timeSyncInterval=t,this._entity):this._timeSyncInterval},timeSyncStart:function(){if(ige.isServer){this._timeSyncStarted=!0,this._sendTimeSync();var t=this;this.log("Starting client/server clock sync..."),this._timeSyncTimer=setInterval(function(){t._sendTimeSync()},this._timeSyncInterval)}return this._entity},timeSyncStop:function(){return this.log("Stopping client/server clock sync..."),clearInterval(this._timeSyncTimer),this._timeSyncStarted=!1,this._entity},_sendTimeSync:function(t,e){t||(t=ige._currentTime),this.send("_igeNetTimeSync",t,e)},timeToServerTime:function(t){return void 0!==t?t+this._latency:this._latency},_onTimeSync:function(t,e){var i,o=Math.floor(ige._currentTime);ige.isClient&&(i=parseInt(t,10),this._latency=o-i,this._sendTimeSync([t,o])),ige.isServer&&(i=parseInt(t[1],10),o-parseInt(t[0],10),this._timeSyncLog[e]=o-i)}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTimeSyncExtension);var IgeStreamComponent=IgeEventingClass.extend({classId:"IgeStreamComponent",componentId:"stream",init:function(t,e){this._entity=t,this._options=e;var i=this;this._sectionDesignator="",ige.isServer&&(this._entity.define("_igeStreamCreate"),this._entity.define("_igeStreamDestroy"),this._entity.define("_igeStreamData"),this._entity.define("_igeStreamTime"),this._queuedData={},this._streamClientData={},this._streamClientCreated={}),ige.isClient&&(this._entity.define("_igeStreamCreate",function(){i._onStreamCreate.apply(i,arguments)}),this._entity.define("_igeStreamDestroy",function(){i._onStreamDestroy.apply(i,arguments)}),this._entity.define("_igeStreamData",function(){i._onStreamData.apply(i,arguments)}),this._entity.define("_igeStreamTime",function(){i._onStreamTime.apply(i,arguments)})),this._renderLatency=100,this._streamInterval=50},renderLatency:function(t){return void 0!==t?(this._renderLatency=t,this._entity):this._renderLatency},sendInterval:function(t){return void 0!==t?(this.log("Setting delta stream interval to "+t/ige._timeScale+"ms"),this._streamInterval=t/ige._timeScale,this._entity):this._streamInterval},start:function(){var t=this;return this.log("Starting delta stream..."),this._streamTimer=setInterval(function(){t._sendQueue()},this._streamInterval),this._entity},stop:function(){return this._stopTimeSync(),this.log("Stopping delta stream..."),clearInterval(this._streamTimer),this._entity},queue:function(t,e,i){return this._queuedData[t]=[e,i],this._entity},_sendQueue:function(){var t,e,i,o,n=(new Date).getTime(),r=this._queuedData,s=this._entity,a=ige._currentTime,h={};for(i in r)if(r.hasOwnProperty(i)&&(o=r[i],h[o[1]]||(s.send("_igeStreamTime",a,o[1]),h[o[1]]=!0),s.send("_igeStreamData",o[0],o[1]),delete r[i]),t=(new Date).getTime(),(e=t-n)>this._streamInterval){console.log("WARNING, Stream send is taking too long: "+e+"ms");break}},_onStreamTime:function(t){this._streamDataTime=t},_onStreamCreate:function(t){var e,i,o=t[0],n=t[1],r=t[2],s=t[3],a=t[4],h=ige.$(r);h?ige.$(n)||(e=igeClassStore[o],e?(i=new e(a).id(n).mount(h),i.streamSectionData("transform",s,!0),i._streamJustCreated=!0,i._streamEmitCreated&&i.emit("streamCreated"),this.emit("entityCreated",i)):(ige.network.stop(),ige.stop(),this.log("Network stream cannot create entity with class "+o+" because the class has not been defined! The engine will now stop.","error"))):this.log("Cannot properly handle network streamed entity with id "+n+" because it's parent with id "+r+" does not exist on the scenegraph!","warning")},_onStreamDestroy:function(t){var e=ige.$(t[1]),i=this;if(e){var o=ige.network.stream._renderLatency+(ige._currentTime-t[0]);o>0?e.lifeSpan(o,function(){i.emit("entityDestroyed",e)}):(i.emit("entityDestroyed",e),e.destroy())}},_onStreamData:function(t){var e,i,o,n,r,s=t.split(ige.network.stream._sectionDesignator),a=s.length;if(e=s.shift(),i=ige.$(e)){for(r=i._streamJustCreated,o=i._streamSections,n=0;n<a;n++)i.streamSectionData(o[n],s[n],r);delete i._streamJustCreated}else this.log("+++ Stream: Data received for unknown entity ("+e+")")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeStreamComponent);var io="undefined"==typeof module?{}:module.exports;!function(){if(function(t,e){var i=t;i.version="0.9.11",i.protocol=1,i.transports=[],i.j=[],i.sockets={},i.connect=function(t,o){var n,r,s=i.util.parseUri(t);e&&e.location&&(s.protocol=s.protocol||e.location.protocol.slice(0,-1),s.host=s.host||(e.document?e.document.domain:e.location.hostname),s.port=s.port||e.location.port),n=i.util.uniqueUri(s);var a={host:s.host,secure:"https"==s.protocol,port:s.port||("https"==s.protocol?443:80),query:s.query||""};return i.util.merge(a,o),!a["force new connection"]&&i.sockets[n]||(r=new i.Socket(a)),!a["force new connection"]&&r&&(i.sockets[n]=r),r=r||i.sockets[n],r.of(s.path.length>1?s.path:"")}}("object"==typeof module?module.exports:this.io={},this),function(t,e){var i=t.util={},o=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,n=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];i.parseUri=function(t){for(var e=o.exec(t||""),i={},r=14;r--;)i[n[r]]=e[r]||"";return i},i.uniqueUri=function(t){var i=t.protocol,o=t.host,n=t.port;return"document"in e?(o=o||document.domain,n=n||("https"==i&&"https:"!==document.location.protocol?443:document.location.port)):(o=o||"localhost",!n&&"https"==i&&(n=443)),(i||"http")+"://"+o+":"+(n||80)},i.query=function(t,e){var o=i.chunkQuery(t||""),n=[];i.merge(o,i.chunkQuery(e||""));for(var r in o)o.hasOwnProperty(r)&&n.push(r+"="+o[r]);return n.length?"?"+n.join("&"):""},i.chunkQuery=function(t){for(var e,i={},o=t.split("&"),n=0,r=o.length;n<r;++n)e=o[n].split("="),e[0]&&(i[e[0]]=e[1]);return i};var r=!1;i.load=function(t){if("document"in e&&"complete"===document.readyState||r)return t();i.on(e,"load",t,!1)},i.on=function(t,e,i,o){t.attachEvent?t.attachEvent("on"+e,i):t.addEventListener&&t.addEventListener(e,i,o)},i.request=function(t){if(t&&"undefined"!=typeof XDomainRequest&&!i.ua.hasCORS)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!t||i.ua.hasCORS))return new XMLHttpRequest;if(!t)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}return null},"undefined"!=typeof window&&i.load(function(){r=!0}),i.defer=function(t){if(!i.ua.webkit||"undefined"!=typeof importScripts)return t();i.load(function(){setTimeout(t,100)})},i.merge=function(t,e,o,n){var r,s=n||[],a=void 0===o?2:o;for(r in e)e.hasOwnProperty(r)&&i.indexOf(s,r)<0&&("object"==typeof t[r]&&a?i.merge(t[r],e[r],a-1,s):(t[r]=e[r],s.push(e[r])));return t},i.mixin=function(t,e){i.merge(t.prototype,e.prototype)},i.inherit=function(t,e){function i(){}i.prototype=e.prototype,t.prototype=new i},i.isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},i.intersect=function(t,e){for(var o=[],n=t.length>e.length?t:e,r=t.length>e.length?e:t,s=0,a=r.length;s<a;s++)~i.indexOf(n,r[s])&&o.push(r[s]);return o},i.indexOf=function(t,e,i){for(var o=t.length,i=i<0?i+o<0?0:i+o:i||0;i<o&&t[i]!==e;i++);return o<=i?-1:i},i.toArray=function(t){for(var e=[],i=0,o=t.length;i<o;i++)e.push(t[i]);return e},i.ua={},i.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var t=new XMLHttpRequest}catch(t){return!1}return void 0!=t.withCredentials}(),i.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),i.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}(void 0!==io?io:module.exports,this),function(t,e){function i(){}t.EventEmitter=i,i.prototype.on=function(t,i){return this.$events||(this.$events={}),this.$events[t]?e.util.isArray(this.$events[t])?this.$events[t].push(i):this.$events[t]=[this.$events[t],i]:this.$events[t]=i,this},i.prototype.addListener=i.prototype.on,i.prototype.once=function(t,e){function i(){o.removeListener(t,i),e.apply(this,arguments)}var o=this;return i.listener=e,this.on(t,i),this},i.prototype.removeListener=function(t,i){if(this.$events&&this.$events[t]){var o=this.$events[t];if(e.util.isArray(o)){for(var n=-1,r=0,s=o.length;r<s;r++)if(o[r]===i||o[r].listener&&o[r].listener===i){n=r;break}if(n<0)return this;o.splice(n,1),o.length||delete this.$events[t]}else(o===i||o.listener&&o.listener===i)&&delete this.$events[t]}return this},i.prototype.removeAllListeners=function(t){return void 0===t?(this.$events={},this):(this.$events&&this.$events[t]&&(this.$events[t]=null),this)},i.prototype.listeners=function(t){return this.$events||(this.$events={}),this.$events[t]||(this.$events[t]=[]),e.util.isArray(this.$events[t])||(this.$events[t]=[this.$events[t]]),this.$events[t]},i.prototype.emit=function(t){if(!this.$events)return!1;var i=this.$events[t];if(!i)return!1;var o=Array.prototype.slice.call(arguments,1);if("function"==typeof i)i.apply(this,o);else{if(!e.util.isArray(i))return!1;for(var n=i.slice(),r=0,s=n.length;r<s;r++)n[r].apply(this,o)}return!0}}(void 0!==io?io:module.exports,void 0!==io?io:module.parent.exports),function(exports,nativeJSON){function f(t){return t<10?"0"+t:t}function date(t,e){return isFinite(t.valueOf())?t.getUTCFullYear()+"-"+f(t.getUTCMonth()+1)+"-"+f(t.getUTCDate())+"T"+f(t.getUTCHours())+":"+f(t.getUTCMinutes())+":"+f(t.getUTCSeconds())+"Z":null}function quote(t){return escapable.lastIndex=0,escapable.test(t)?'"'+t.replace(escapable,function(t){var e=meta[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var i,o,n,r,s,a=gap,h=e[t];switch(h instanceof Date&&(h=date(t)),"function"==typeof rep&&(h=rep.call(e,t,h)),typeof h){case"string":return quote(h);case"number":return isFinite(h)?String(h):"null";case"boolean":case"null":return String(h);case"object":if(!h)return"null";if(gap+=indent,s=[],"[object Array]"===Object.prototype.toString.apply(h)){for(r=h.length,i=0;i<r;i+=1)s[i]=str(i,h)||"null";return n=0===s.length?"[]":gap?"[\n"+gap+s.join(",\n"+gap)+"\n"+a+"]":"["+s.join(",")+"]",gap=a,n}if(rep&&"object"==typeof rep)for(r=rep.length,i=0;i<r;i+=1)"string"==typeof rep[i]&&(o=rep[i],(n=str(o,h))&&s.push(quote(o)+(gap?": ":":")+n));else for(o in h)Object.prototype.hasOwnProperty.call(h,o)&&(n=str(o,h))&&s.push(quote(o)+(gap?": ":":")+n);return n=0===s.length?"{}":gap?"{\n"+gap+s.join(",\n"+gap)+"\n"+a+"}":"{"+s.join(",")+"}",gap=a,n}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(t,e,i){var o;if(gap="",indent="","number"==typeof i)for(o=0;o<i;o+=1)indent+=" ";else"string"==typeof i&&(indent=i);if(rep=e,!e||"function"==typeof e||"object"==typeof e&&"number"==typeof e.length)return str("",{"":t});throw new Error("JSON.stringify")},JSON.parse=function(text,reviver){function walk(t,e){var i,o,n=t[e];if(n&&"object"==typeof n)for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(o=walk(n,i),void 0!==o?n[i]=o:delete n[i]);return reviver.call(t,e,n)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}(void 0!==io?io:module.exports,"undefined"!=typeof JSON?JSON:void 0),function(t,e){var i=t.parser={},o=i.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],n=i.reasons=["transport not supported","client not handshaken","unauthorized"],r=i.advice=["reconnect"],s=e.JSON,a=e.util.indexOf;i.encodePacket=function(t){var e=a(o,t.type),i=t.id||"",h=t.endpoint||"",l=t.ack,c=null;switch(t.type){case"error":var u=t.reason?a(n,t.reason):"",m=t.advice?a(r,t.advice):"";""===u&&""===m||(c=u+(""!==m?"+"+m:""));break;case"message":""!==t.data&&(c=t.data);break;case"event":var d={name:t.name};t.args&&t.args.length&&(d.args=t.args),c=s.stringify(d);break;case"json":c=s.stringify(t.data);break;case"connect":t.qs&&(c=t.qs);break;case"ack":c=t.ackId+(t.args&&t.args.length?"+"+s.stringify(t.args):"")}var p=[e,i+("data"==l?"+":""),h];return null!==c&&void 0!==c&&p.push(c),p.join(":")},i.encodePayload=function(t){var e="";if(1==t.length)return t[0];for(var i=0,o=t.length;i<o;i++){e+=""+t[i].length+""+t[i]}return e};i.decodePacket=function(t){var e=t.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(!e)return{};var i=e[2]||"",t=e[5]||"",a={type:o[e[1]],endpoint:e[4]||""};switch(i&&(a.id=i,e[3]?a.ack="data":a.ack=!0),a.type){case"error":var e=t.split("+");a.reason=n[e[0]]||"",a.advice=r[e[1]]||"";break;case"message":a.data=t||"";break;case"event":try{var h=s.parse(t);a.name=h.name,a.args=h.args}catch(t){}a.args=a.args||[];break;case"json":try{a.data=s.parse(t)}catch(t){}break;case"connect":a.qs=t||"";break;case"ack":var e=t.match(/^([0-9]+)(\+)?(.*)/);if(e&&(a.ackId=e[1],a.args=[],e[3]))try{a.args=e[3]?s.parse(e[3]):[]}catch(t){}}return a},i.decodePayload=function(t){if(""==t.charAt(0)){for(var e=[],o=1,n="";o<t.length;o++)""==t.charAt(o)?(e.push(i.decodePacket(t.substr(o+1).substr(0,n))),o+=Number(n)+1,n=""):n+=t.charAt(o);return e}return[i.decodePacket(t)]}}(void 0!==io?io:module.exports,void 0!==io?io:module.parent.exports),function(t,e){function i(t,e){this.socket=t,this.sessid=e}t.Transport=i,e.util.mixin(i,e.EventEmitter),i.prototype.heartbeats=function(){return!0},i.prototype.onData=function(t){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==t){var i=e.parser.decodePayload(t);if(i&&i.length)for(var o=0,n=i.length;o<n;o++)this.onPacket(i[o])}return this},i.prototype.onPacket=function(t){return this.socket.setHeartbeatTimeout(),"heartbeat"==t.type?this.onHeartbeat():("connect"==t.type&&""==t.endpoint&&this.onConnect(),"error"==t.type&&"reconnect"==t.advice&&(this.isOpen=!1),this.socket.onPacket(t),this)},i.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var t=this;this.closeTimeout=setTimeout(function(){t.onDisconnect()},this.socket.closeTimeout)}},i.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},i.prototype.onConnect=function(){return this.socket.onConnect(),this},i.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},i.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},i.prototype.packet=function(t){this.send(e.parser.encodePacket(t))},i.prototype.onHeartbeat=function(t){this.packet({type:"heartbeat"})},i.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},i.prototype.onClose=function(){this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},i.prototype.prepareUrl=function(){var t=this.socket.options;return this.scheme()+"://"+t.host+":"+t.port+"/"+t.resource+"/"+e.protocol+"/"+this.name+"/"+this.sessid},i.prototype.ready=function(t,e){e.call(this)}}(void 0!==io?io:module.exports,void 0!==io?io:module.parent.exports),function(t,e,i){function o(t){if(this.options={port:80,secure:!1,document:"document"in i&&document,resource:"socket.io",
transports:e.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},e.util.merge(this.options,t),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||e.util.ua.hasCORS)){var o=this;e.util.on(i,"beforeunload",function(){o.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function n(){}t.Socket=o,e.util.mixin(o,e.EventEmitter),o.prototype.of=function(t){return this.namespaces[t]||(this.namespaces[t]=new e.SocketNamespace(this,t),""!==t&&this.namespaces[t].packet({type:"connect"})),this.namespaces[t]},o.prototype.publish=function(){this.emit.apply(this,arguments);var t;for(var e in this.namespaces)this.namespaces.hasOwnProperty(e)&&(t=this.of(e),t.$emit.apply(t,arguments))},o.prototype.handshake=function(t){function i(e){e instanceof Error?(o.connecting=!1,o.onError(e.message)):t.apply(null,e.split(":"))}var o=this,r=this.options,s=["http"+(r.secure?"s":"")+":/",r.host+":"+r.port,r.resource,e.protocol,e.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!e.util.ua.hasCORS){var a=document.getElementsByTagName("script")[0],h=document.createElement("script");h.src=s+"&jsonp="+e.j.length,a.parentNode.insertBefore(h,a),e.j.push(function(t){i(t),h.parentNode.removeChild(h)})}else{var l=e.util.request();l.open("GET",s,!0),this.isXDomain()&&(l.withCredentials=!0),l.onreadystatechange=function(){4==l.readyState&&(l.onreadystatechange=n,200==l.status?i(l.responseText):403==l.status?o.onError(l.responseText):(o.connecting=!1,!o.reconnecting&&o.onError(l.responseText)))},l.send(null)}},o.prototype.getTransport=function(t){for(var i,o=t||this.transports,n=0;i=o[n];n++)if(e.Transport[i]&&e.Transport[i].check(this)&&(!this.isXDomain()||e.Transport[i].xdomainCheck(this)))return new e.Transport[i](this,this.sessionid);return null},o.prototype.connect=function(t){if(this.connecting)return this;var i=this;return i.connecting=!0,this.handshake(function(o,n,r,s){function a(t){if(i.transport&&i.transport.clearTimeouts(),i.transport=i.getTransport(t),!i.transport)return i.publish("connect_failed");i.transport.ready(i,function(){i.connecting=!0,i.publish("connecting",i.transport.name),i.transport.open(),i.options["connect timeout"]&&(i.connectTimeoutTimer=setTimeout(function(){if(!i.connected&&(i.connecting=!1,i.options["try multiple transports"])){for(var t=i.transports;t.length>0&&t.splice(0,1)[0]!=i.transport.name;);t.length?a(t):i.publish("connect_failed")}},i.options["connect timeout"]))})}i.sessionid=o,i.closeTimeout=1e3*r,i.heartbeatTimeout=1e3*n,i.transports||(i.transports=i.origTransports=s?e.util.intersect(s.split(","),i.options.transports):i.options.transports),i.setHeartbeatTimeout(),a(i.transports),i.once("connect",function(){clearTimeout(i.connectTimeoutTimer),t&&"function"==typeof t&&t()})}),this},o.prototype.setHeartbeatTimeout=function(){if(clearTimeout(this.heartbeatTimeoutTimer),!this.transport||this.transport.heartbeats()){var t=this;this.heartbeatTimeoutTimer=setTimeout(function(){t.transport.onClose()},this.heartbeatTimeout)}},o.prototype.packet=function(t){return this.connected&&!this.doBuffer?this.transport.packet(t):this.buffer.push(t),this},o.prototype.setBuffer=function(t){this.doBuffer=t,!t&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},o.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},o.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this},o.prototype.disconnectSync=function(){var t=e.util.request(),i=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,e.protocol,"",this.sessionid].join("/")+"/?disconnect=1";t.open("GET",i,!1),t.send(null),this.onDisconnect("booted")},o.prototype.isXDomain=function(){var t=i.location.port||("https:"==i.location.protocol?443:80);return this.options.host!==i.location.hostname||this.options.port!=t},o.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},o.prototype.onOpen=function(){this.open=!0},o.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},o.prototype.onPacket=function(t){this.of(t.endpoint).onPacket(t)},o.prototype.onError=function(t){t&&t.advice&&"reconnect"===t.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",t&&t.reason?t.reason:t)},o.prototype.onDisconnect=function(t){var e=this.connected,i=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(e||i)&&(this.transport.close(),this.transport.clearTimeouts(),e&&(this.publish("disconnect",t),"booted"!=t&&this.options.reconnect&&!this.reconnecting&&this.reconnect()))},o.prototype.reconnect=function(){function t(){if(i.connected){for(var t in i.namespaces)i.namespaces.hasOwnProperty(t)&&""!==t&&i.namespaces[t].packet({type:"connect"});i.publish("reconnect",i.transport.name,i.reconnectionAttempts)}clearTimeout(i.reconnectionTimer),i.removeListener("connect_failed",e),i.removeListener("connect",e),i.reconnecting=!1,delete i.reconnectionAttempts,delete i.reconnectionDelay,delete i.reconnectionTimer,delete i.redoTransports,i.options["try multiple transports"]=n}function e(){if(i.reconnecting)return i.connected?t():i.connecting&&i.reconnecting?i.reconnectionTimer=setTimeout(e,1e3):void(i.reconnectionAttempts++>=o?i.redoTransports?(i.publish("reconnect_failed"),t()):(i.on("connect_failed",e),i.options["try multiple transports"]=!0,i.transports=i.origTransports,i.transport=i.getTransport(),i.redoTransports=!0,i.connect()):(i.reconnectionDelay<r&&(i.reconnectionDelay*=2),i.connect(),i.publish("reconnecting",i.reconnectionDelay,i.reconnectionAttempts),i.reconnectionTimer=setTimeout(e,i.reconnectionDelay)))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var i=this,o=this.options["max reconnection attempts"],n=this.options["try multiple transports"],r=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(e,this.reconnectionDelay),this.on("connect",e)}}(void 0!==io?io:module.exports,void 0!==io?io:module.parent.exports,this),function(t,e){function i(t,e){this.socket=t,this.name=e||"",this.flags={},this.json=new o(this,"json"),this.ackPackets=0,this.acks={}}function o(t,e){this.namespace=t,this.name=e}t.SocketNamespace=i,e.util.mixin(i,e.EventEmitter),i.prototype.$emit=e.EventEmitter.prototype.emit,i.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},i.prototype.packet=function(t){return t.endpoint=this.name,this.socket.packet(t),this.flags={},this},i.prototype.send=function(t,e){var i={type:this.flags.json?"json":"message",data:t};return"function"==typeof e&&(i.id=++this.ackPackets,i.ack=!0,this.acks[i.id]=e),this.packet(i)},i.prototype.emit=function(t){var e=Array.prototype.slice.call(arguments,1),i=e[e.length-1],o={type:"event",name:t};return"function"==typeof i&&(o.id=++this.ackPackets,o.ack="data",this.acks[o.id]=i,e=e.slice(0,e.length-1)),o.args=e,this.packet(o)},i.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},i.prototype.onPacket=function(t){function i(){o.packet({type:"ack",args:e.util.toArray(arguments),ackId:t.id})}var o=this;switch(t.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(t.reason||"booted"):this.$emit("disconnect",t.reason);break;case"message":case"json":var n=["message",t.data];"data"==t.ack?n.push(i):t.ack&&this.packet({type:"ack",ackId:t.id}),this.$emit.apply(this,n);break;case"event":var n=[t.name].concat(t.args);"data"==t.ack&&n.push(i),this.$emit.apply(this,n);break;case"ack":this.acks[t.ackId]&&(this.acks[t.ackId].apply(this,t.args),delete this.acks[t.ackId]);break;case"error":t.advice?this.socket.onError(t):"unauthorized"==t.reason?this.$emit("connect_failed",t.reason):this.$emit("error",t.reason)}},o.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},o.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}(void 0!==io?io:module.exports,void 0!==io?io:module.parent.exports),function(t,e,i){function o(t){e.Transport.apply(this,arguments)}t.websocket=o,e.util.inherit(o,e.Transport),o.prototype.name="websocket",o.prototype.open=function(){var t,o=e.util.query(this.socket.options.query),n=this;return t||(t=i.MozWebSocket||i.WebSocket),this.websocket=new t(this.prepareUrl()+o),this.websocket.onopen=function(){n.onOpen(),n.socket.setBuffer(!1)},this.websocket.onmessage=function(t){n.onData(t.data)},this.websocket.onclose=function(){n.onClose(),n.socket.setBuffer(!0)},this.websocket.onerror=function(t){n.onError(t)},this},e.util.ua.iDevice?o.prototype.send=function(t){var e=this;return setTimeout(function(){e.websocket.send(t)},0),this}:o.prototype.send=function(t){return this.websocket.send(t),this},o.prototype.payload=function(t){for(var e=0,i=t.length;e<i;e++)this.packet(t[e]);return this},o.prototype.close=function(){return this.websocket.close(),this},o.prototype.onError=function(t){this.socket.onError(t)},o.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},o.check=function(){return"WebSocket"in i&&!("__addTask"in WebSocket)||"MozWebSocket"in i},o.xdomainCheck=function(){return!0},e.transports.push("websocket")}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports,this),function(t,e){function i(){e.Transport.websocket.apply(this,arguments)}t.flashsocket=i,e.util.inherit(i,e.Transport.websocket),i.prototype.name="flashsocket",i.prototype.open=function(){var t=this,i=arguments;return WebSocket.__addTask(function(){e.Transport.websocket.prototype.open.apply(t,i)}),this},i.prototype.send=function(){var t=this,i=arguments;return WebSocket.__addTask(function(){e.Transport.websocket.prototype.send.apply(t,i)}),this},i.prototype.close=function(){return WebSocket.__tasks.length=0,e.Transport.websocket.prototype.close.call(this),this},i.prototype.ready=function(t,o){function n(){var e=t.options,n=e["flash policy port"],s=["http"+(e.secure?"s":"")+":/",e.host+":"+e.port,e.resource,"static/flashsocket","WebSocketMain"+(t.isXDomain()?"Insecure":"")+".swf"];i.loaded||("undefined"==typeof WEB_SOCKET_SWF_LOCATION&&(WEB_SOCKET_SWF_LOCATION=s.join("/")),843!==n&&WebSocket.loadFlashPolicyFile("xmlsocket://"+e.host+":"+n),WebSocket.__initialize(),i.loaded=!0),o.call(r)}var r=this;if(document.body)return n();e.util.load(n)},i.check=function(){return!!("undefined"!=typeof WebSocket&&"__initialize"in WebSocket&&swfobject)&&swfobject.getFlashPlayerVersion().major>=10},i.xdomainCheck=function(){return!0},"undefined"!=typeof window&&(WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0),e.transports.push("flashsocket")}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports),"undefined"!=typeof window)var swfobject=function(){function t(){if(!O){try{var t=L.getElementsByTagName("body")[0].appendChild(f("span"));t.parentNode.removeChild(t)}catch(t){return}O=!0;for(var e=F.length,i=0;i<e;i++)F[i]()}}function e(t){O?t():F[F.length]=t}function i(t){if(typeof P.addEventListener!=M)P.addEventListener("load",t,!1);else if(typeof L.addEventListener!=M)L.addEventListener("load",t,!1);else if(typeof P.attachEvent!=M)y(P,"onload",t);else if("function"==typeof P.onload){var e=P.onload;P.onload=function(){e(),t()}}else P.onload=t}function o(){k?n():r()}function n(){var t=L.getElementsByTagName("body")[0],e=f(D);e.setAttribute("type",B);var i=t.appendChild(e);if(i){var o=0;!function(){if(typeof i.GetVariable!=M){var n=i.GetVariable("$version");n&&(n=n.split(" ")[1].split(","),j.pv=[parseInt(n[0],10),parseInt(n[1],10),parseInt(n[2],10)])}else if(o<10)return o++,void setTimeout(arguments.callee,10);t.removeChild(e),i=null,r()}()}else r()}function r(){var t=z.length;if(t>0)for(var e=0;e<t;e++){var i=z[e].id,o=z[e].callbackFn,n={success:!1,id:i};if(j.pv[0]>0){var r=_(i);if(r)if(!g(z[e].swfVersion)||j.wk&&j.wk<312)if(z[e].expressInstall&&a()){var c={};c.data=z[e].expressInstall,c.width=r.getAttribute("width")||"0",c.height=r.getAttribute("height")||"0",r.getAttribute("class")&&(c.styleclass=r.getAttribute("class")),r.getAttribute("align")&&(c.align=r.getAttribute("align"));for(var u={},m=r.getElementsByTagName("param"),d=m.length,p=0;p<d;p++)"movie"!=m[p].getAttribute("name").toLowerCase()&&(u[m[p].getAttribute("name")]=m[p].getAttribute("value"));h(c,u,i,o)}else l(r),o&&o(n);else x(i,!0),o&&(n.success=!0,n.ref=s(i),o(n))}else if(x(i,!0),o){var f=s(i);f&&typeof f.SetVariable!=M&&(n.success=!0,n.ref=f),o(n)}}}function s(t){var e=null,i=_(t);if(i&&"OBJECT"==i.nodeName)if(typeof i.SetVariable!=M)e=i;else{var o=i.getElementsByTagName(D)[0];o&&(e=o)}return e}function a(){return!G&&g("6.0.65")&&(j.win||j.mac)&&!(j.wk&&j.wk<312)}function h(t,e,i,o){G=!0,w=o||null,S={success:!1,id:i};var n=_(i);if(n){"OBJECT"==n.nodeName?(E=c(n),T=null):(E=n,T=i),t.id=I,(typeof t.width==M||!/%$/.test(t.width)&&parseInt(t.width,10)<310)&&(t.width="310"),(typeof t.height==M||!/%$/.test(t.height)&&parseInt(t.height,10)<137)&&(t.height="137"),L.title=L.title.slice(0,47)+" - Flash Player Installation";var r=j.ie&&j.win?["Active"].concat("").join("X"):"PlugIn",s="MMredirectURL="+P.location.toString().replace(/&/g,"%26")+"&MMplayerType="+r+"&MMdoctitle="+L.title;if(typeof e.flashvars!=M?e.flashvars+="&"+s:e.flashvars=s,j.ie&&j.win&&4!=n.readyState){var a=f("div");i+="SWFObjectNew",a.setAttribute("id",i),n.parentNode.insertBefore(a,n),n.style.display="none",function(){4==n.readyState?n.parentNode.removeChild(n):setTimeout(arguments.callee,10)}()}u(t,e,i)}}function l(t){if(j.ie&&j.win&&4!=t.readyState){var e=f("div");t.parentNode.insertBefore(e,t),e.parentNode.replaceChild(c(t),e),t.style.display="none",function(){4==t.readyState?t.parentNode.removeChild(t):setTimeout(arguments.callee,10)}()}else t.parentNode.replaceChild(c(t),t)}function c(t){var e=f("div");if(j.win&&j.ie)e.innerHTML=t.innerHTML;else{var i=t.getElementsByTagName(D)[0];if(i){var o=i.childNodes;if(o)for(var n=o.length,r=0;r<n;r++)(1!=o[r].nodeType||"PARAM"!=o[r].nodeName)&&8!=o[r].nodeType&&e.appendChild(o[r].cloneNode(!0))}}return e}function u(t,e,i){var o,n=_(i);if(j.wk&&j.wk<312)return o;if(n)if(typeof t.id==M&&(t.id=i),j.ie&&j.win){var r="";for(var s in t)t[s]!=Object.prototype[s]&&("data"==s.toLowerCase()?e.movie=t[s]:"styleclass"==s.toLowerCase()?r+=' class="'+t[s]+'"':"classid"!=s.toLowerCase()&&(r+=" "+s+'="'+t[s]+'"'));var a="";for(var h in e)e[h]!=Object.prototype[h]&&(a+='<param name="'+h+'" value="'+e[h]+'" />');n.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+r+">"+a+"</object>",N[N.length]=t.id,o=_(t.id)}else{var l=f(D);l.setAttribute("type",B);for(var c in t)t[c]!=Object.prototype[c]&&("styleclass"==c.toLowerCase()?l.setAttribute("class",t[c]):"classid"!=c.toLowerCase()&&l.setAttribute(c,t[c]));for(var u in e)e[u]!=Object.prototype[u]&&"movie"!=u.toLowerCase()&&m(l,u,e[u]);n.parentNode.replaceChild(l,n),o=l}return o}function m(t,e,i){var o=f("param");o.setAttribute("name",e),o.setAttribute("value",i),t.appendChild(o)}function d(t){var e=_(t);e&&"OBJECT"==e.nodeName&&(j.ie&&j.win?(e.style.display="none",function(){4==e.readyState?p(t):setTimeout(arguments.callee,10)}()):e.parentNode.removeChild(e))}function p(t){var e=_(t);if(e){for(var i in e)"function"==typeof e[i]&&(e[i]=null);e.parentNode.removeChild(e)}}function _(t){var e=null;try{e=L.getElementById(t)}catch(t){}return e}function f(t){return L.createElement(t)}function y(t,e,i){t.attachEvent(e,i),U[U.length]=[t,e,i]}function g(t){var e=j.pv,i=t.split(".");return i[0]=parseInt(i[0],10),i[1]=parseInt(i[1],10)||0,i[2]=parseInt(i[2],10)||0,e[0]>i[0]||e[0]==i[0]&&e[1]>i[1]||e[0]==i[0]&&e[1]==i[1]&&e[2]>=i[2]}function v(t,e,i,o){if(!j.ie||!j.mac){var n=L.getElementsByTagName("head")[0];if(n){var r=i&&"string"==typeof i?i:"screen";if(o&&(C=null,R=null),!C||R!=r){var s=f("style");s.setAttribute("type","text/css"),s.setAttribute("media",r),C=n.appendChild(s),j.ie&&j.win&&typeof L.styleSheets!=M&&L.styleSheets.length>0&&(C=L.styleSheets[L.styleSheets.length-1]),R=r}j.ie&&j.win?C&&typeof C.addRule==D&&C.addRule(t,e):C&&typeof L.createTextNode!=M&&C.appendChild(L.createTextNode(t+" {"+e+"}"))}}}function x(t,e){if(W){var i=e?"visible":"hidden";O&&_(t)?_(t).style.visibility=i:v("#"+t,"visibility:"+i)}}function b(t){return null!=/[\\\"<>\.;]/.exec(t)&&typeof encodeURIComponent!=M?encodeURIComponent(t):t}var E,T,w,S,C,R,M="undefined",D="object",A="Shockwave Flash",B="application/x-shockwave-flash",I="SWFObjectExprInst",H="onreadystatechange",P=window,L=document,V=navigator,k=!1,F=[o],z=[],N=[],U=[],O=!1,G=!1,W=!0,j=function(){var t=typeof L.getElementById!=M&&typeof L.getElementsByTagName!=M&&typeof L.createElement!=M,e=V.userAgent.toLowerCase(),i=V.platform.toLowerCase(),o=/win/.test(i?i:e),n=/mac/.test(i?i:e),r=!!/webkit/.test(e)&&parseFloat(e.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")),s=!1,a=[0,0,0],h=null;if(typeof V.plugins!=M&&typeof V.plugins[A]==D)(h=V.plugins[A].description)&&(typeof V.mimeTypes==M||!V.mimeTypes[B]||!!V.mimeTypes[B].enabledPlugin)&&(k=!0,s=!1,h=h.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),a[0]=parseInt(h.replace(/^(.*)\..*$/,"$1"),10),a[1]=parseInt(h.replace(/^.*\.(.*)\s.*$/,"$1"),10),a[2]=/[a-zA-Z]/.test(h)?parseInt(h.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof P[["Active"].concat("Object").join("X")]!=M)try{var l=new(window[["Active"].concat("Object").join("X")])("ShockwaveFlash.ShockwaveFlash");l&&(h=l.GetVariable("$version"))&&(s=!0,h=h.split(" ")[1].split(","),a=[parseInt(h[0],10),parseInt(h[1],10),parseInt(h[2],10)])}catch(t){}return{w3:t,pv:a,wk:r,ie:s,win:o,mac:n}}();(function(){j.w3&&((typeof L.readyState!=M&&"complete"==L.readyState||typeof L.readyState==M&&(L.getElementsByTagName("body")[0]||L.body))&&t(),O||(typeof L.addEventListener!=M&&L.addEventListener("DOMContentLoaded",t,!1),j.ie&&j.win&&(L.attachEvent(H,function(){"complete"==L.readyState&&(L.detachEvent(H,arguments.callee),t())}),P==top&&function(){if(!O){try{L.documentElement.doScroll("left")}catch(t){return void setTimeout(arguments.callee,0)}t()}}()),j.wk&&function(){if(!O)/loaded|complete/.test(L.readyState)?t():setTimeout(arguments.callee,0)}(),i(t)))})(),function(){j.ie&&j.win&&window.attachEvent("onunload",function(){for(var t=U.length,e=0;e<t;e++)U[e][0].detachEvent(U[e][1],U[e][2]);for(var i=N.length,o=0;o<i;o++)d(N[o]);for(var n in j)j[n]=null;j=null;for(var r in swfobject)swfobject[r]=null;swfobject=null})}();return{registerObject:function(t,e,i,o){if(j.w3&&t&&e){var n={};n.id=t,n.swfVersion=e,n.expressInstall=i,n.callbackFn=o,z[z.length]=n,x(t,!1)}else o&&o({success:!1,id:t})},getObjectById:function(t){if(j.w3)return s(t)},embedSWF:function(t,i,o,n,r,s,l,c,m,d){var p={success:!1,id:i};j.w3&&!(j.wk&&j.wk<312)&&t&&i&&o&&n&&r?(x(i,!1),e(function(){o+="",n+="";var e={};if(m&&typeof m===D)for(var _ in m)e[_]=m[_];e.data=t,e.width=o,e.height=n;var f={};if(c&&typeof c===D)for(var y in c)f[y]=c[y];if(l&&typeof l===D)for(var v in l)typeof f.flashvars!=M?f.flashvars+="&"+v+"="+l[v]:f.flashvars=v+"="+l[v];if(g(r)){var b=u(e,f,i);e.id==i&&x(i,!0),p.success=!0,p.ref=b}else{if(s&&a())return e.data=s,void h(e,f,i,d);x(i,!0)}d&&d(p)})):d&&d(p)},switchOffAutoHideShow:function(){W=!1},ua:j,getFlashPlayerVersion:function(){return{major:j.pv[0],minor:j.pv[1],release:j.pv[2]}},hasFlashPlayerVersion:g,createSWF:function(t,e,i){return j.w3?u(t,e,i):void 0},showExpressInstall:function(t,e,i,o){j.w3&&a()&&h(t,e,i,o)},removeSWF:function(t){j.w3&&d(t)},createCSS:function(t,e,i,o){j.w3&&v(t,e,i,o)},addDomLoadEvent:e,addLoadEvent:i,getQueryParamValue:function(t){var e=L.location.search||L.location.hash;if(e){if(/\?/.test(e)&&(e=e.split("?")[1]),null==t)return b(e);for(var i=e.split("&"),o=0;o<i.length;o++)if(i[o].substring(0,i[o].indexOf("="))==t)return b(i[o].substring(i[o].indexOf("=")+1))}return""},expressInstallCallback:function(){if(G){var t=_(I);t&&E&&(t.parentNode.replaceChild(E,t),T&&(x(T,!0),j.ie&&j.win&&(E.style.display="block")),w&&w(S)),G=!1}}}}();(function(){if("undefined"!=typeof window&&!window.WebSocket){var t=window.console;if(t&&t.log&&t.error||(t={log:function(){},error:function(){}}),!swfobject.hasFlashPlayerVersion("10.0.0"))return void t.error("Flash Player >= 10.0.0 is required.");"file:"==location.protocol&&t.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(t,e,i,o,n){var r=this;r.__id=WebSocket.__nextId++,WebSocket.__instances[r.__id]=r,r.readyState=WebSocket.CONNECTING,r.bufferedAmount=0,r.__events={},e?"string"==typeof e&&(e=[e]):e=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(r.__id,t,e,i||null,o||0,n||null)})},0)},WebSocket.prototype.send=function(t){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var e=WebSocket.__flash.send(this.__id,encodeURIComponent(t));return e<0||(this.bufferedAmount+=e,!1)},WebSocket.prototype.close=function(){this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(t,e,i){t in this.__events||(this.__events[t]=[]),this.__events[t].push(e)},WebSocket.prototype.removeEventListener=function(t,e,i){if(t in this.__events)for(var o=this.__events[t],n=o.length-1;n>=0;--n)if(o[n]===e){o.splice(n,1);break}},WebSocket.prototype.dispatchEvent=function(t){for(var e=this.__events[t.type]||[],i=0;i<e.length;++i)e[i](t);var o=this["on"+t.type];o&&o(t)},WebSocket.prototype.__handleEvent=function(t){"readyState"in t&&(this.readyState=t.readyState),"protocol"in t&&(this.protocol=t.protocol);var e;if("open"==t.type||"error"==t.type)e=this.__createSimpleEvent(t.type);else if("close"==t.type)e=this.__createSimpleEvent("close");else{if("message"!=t.type)throw"unknown event type: "+t.type;var i=decodeURIComponent(t.message);e=this.__createMessageEvent("message",i)}this.dispatchEvent(e)},WebSocket.prototype.__createSimpleEvent=function(t){if(document.createEvent&&window.Event){var e=document.createEvent("Event");return e.initEvent(t,!1,!1),e}return{type:t,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(t,e){if(document.createEvent&&window.MessageEvent&&!window.opera){var i=document.createEvent("MessageEvent");return i.initMessageEvent("message",!1,!1,e,null,null,window,null),i}return{type:t,data:e,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(t){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(t)})},WebSocket.__initialize=function(){if(!WebSocket.__flash){if(WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),!window.WEB_SOCKET_SWF_LOCATION)return void t.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");var e=document.createElement("div");e.id="webSocketContainer",e.style.position="absolute",WebSocket.__isFlashLite()?(e.style.left="0px",e.style.top="0px"):(e.style.left="-100px",e.style.top="-100px");var i=document.createElement("div");i.id="webSocketFlash",e.appendChild(i),document.body.appendChild(e),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(e){e.success||t.error("[WebSocket] swfobject.embedSWF failed")})}},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var t=0;t<WebSocket.__tasks.length;++t)WebSocket.__tasks[t]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{for(var e=WebSocket.__flash.receiveEvents(),i=0;i<e.length;++i)WebSocket.__instances[e[i].webSocketId].__handleEvent(e[i])}catch(e){t.error(e)}},0),!0},WebSocket.__log=function(e){t.log(decodeURIComponent(e))},WebSocket.__error=function(e){t.error(decodeURIComponent(e))},WebSocket.__addTask=function(t){WebSocket.__flash?t():WebSocket.__tasks.push(t)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var t=window.navigator.mimeTypes["application/x-shockwave-flash"];return!!(t&&t.enabledPlugin&&t.enabledPlugin.filename)&&!!t.enabledPlugin.filename.match(/flashlite/i)},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))}})(),function(t,e,i){function o(t){t&&(e.Transport.apply(this,arguments),this.sendBuffer=[])}function n(){}t.XHR=o,e.util.inherit(o,e.Transport),o.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},o.prototype.payload=function(t){for(var i=[],o=0,n=t.length;o<n;o++)i.push(e.parser.encodePacket(t[o]));this.send(e.parser.encodePayload(i))},o.prototype.send=function(t){return this.post(t),this},o.prototype.post=function(t){function e(){4==this.readyState&&(this.onreadystatechange=n,r.posting=!1,200==this.status?r.socket.setBuffer(!1):r.onClose())}function o(){this.onload=n,r.socket.setBuffer(!1)}var r=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),i.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=o:this.sendXHR.onreadystatechange=e,this.sendXHR.send(t)},o.prototype.close=function(){return this.onClose(),this},o.prototype.request=function(t){var i=e.util.request(this.socket.isXDomain()),o=e.util.query(this.socket.options.query,"t="+ +new Date);if(i.open(t||"GET",this.prepareUrl()+o,!0),"POST"==t)try{i.setRequestHeader?i.setRequestHeader("Content-type","text/plain;charset=UTF-8"):i.contentType="text/plain"}catch(t){}return i},o.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},o.check=function(t,o){try{var n=e.util.request(o),r=i.XDomainRequest&&n instanceof XDomainRequest,s=t&&t.options&&t.options.secure?"https:":"http:",a=i.location&&s!=i.location.protocol;if(n&&(!r||!a))return!0}catch(t){}return!1},o.xdomainCheck=function(t){return o.check(t,!0)}}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports,this),function(t,e){function i(t){e.Transport.XHR.apply(this,arguments)}t.htmlfile=i,e.util.inherit(i,e.Transport.XHR),i.prototype.name="htmlfile",i.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var t=this.doc.createElement("div");t.className="socketio",this.doc.body.appendChild(t),this.iframe=this.doc.createElement("iframe"),t.appendChild(this.iframe);var i=this,o=e.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+o,e.util.on(window,"unload",function(){i.destroy()})},i.prototype._=function(t,e){this.onData(t);try{var i=e.getElementsByTagName("script")[0];i.parentNode.removeChild(i)}catch(t){}},i.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(t){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},i.prototype.close=function(){return this.destroy(),e.Transport.XHR.prototype.close.call(this)},i.check=function(t){if("undefined"!=typeof window&&["Active"].concat("Object").join("X")in window)try{return new(window[["Active"].concat("Object").join("X")])("htmlfile")&&e.Transport.XHR.check(t)}catch(t){}return!1},i.xdomainCheck=function(){return!1},e.transports.push("htmlfile")}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports),function(t,e,i){function o(){e.Transport.XHR.apply(this,arguments)}function n(){}t["xhr-polling"]=o,e.util.inherit(o,e.Transport.XHR),e.util.merge(o,e.Transport.XHR),o.prototype.name="xhr-polling",o.prototype.heartbeats=function(){return!1},o.prototype.open=function(){var t=this;return e.Transport.XHR.prototype.open.call(t),!1},o.prototype.get=function(){function t(){4==this.readyState&&(this.onreadystatechange=n,200==this.status?(r.onData(this.responseText),r.get()):r.onClose())}function e(){this.onload=n,this.onerror=n,r.retryCounter=1,r.onData(this.responseText),r.get()}function o(){r.retryCounter++,!r.retryCounter||r.retryCounter>3?r.onClose():r.get()}if(this.isOpen){var r=this;this.xhr=this.request(),i.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=e,this.xhr.onerror=o):this.xhr.onreadystatechange=t,this.xhr.send(null)}},o.prototype.onClose=function(){if(e.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=n;try{this.xhr.abort()}catch(t){}this.xhr=null}},o.prototype.ready=function(t,i){var o=this;e.util.defer(function(){i.call(o)})},e.transports.push("xhr-polling")}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports,this),function(t,e,i){function o(t){e.Transport["xhr-polling"].apply(this,arguments),this.index=e.j.length;var i=this;e.j.push(function(t){i._(t)})}var n=i.document&&"MozAppearance"in i.document.documentElement.style;t["jsonp-polling"]=o,e.util.inherit(o,e.Transport["xhr-polling"]),o.prototype.name="jsonp-polling",o.prototype.post=function(t){function i(){o(),n.socket.setBuffer(!1)}function o(){n.iframe&&n.form.removeChild(n.iframe);try{s=document.createElement('<iframe name="'+n.iframeId+'">')}catch(t){s=document.createElement("iframe"),s.name=n.iframeId}s.id=n.iframeId,n.form.appendChild(s),n.iframe=s}var n=this,r=e.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var s,a=document.createElement("form"),h=document.createElement("textarea"),l=this.iframeId="socketio_iframe_"+this.index;a.className="socketio",a.style.position="absolute",a.style.top="0px",a.style.left="0px",a.style.display="none",a.target=l,a.method="POST",a.setAttribute("accept-charset","utf-8"),h.name="d",a.appendChild(h),document.body.appendChild(a),this.form=a,this.area=h}this.form.action=this.prepareUrl()+r,o(),this.area.value=e.JSON.stringify(t);try{this.form.submit()}catch(t){}this.iframe.attachEvent?s.onreadystatechange=function(){"complete"==n.iframe.readyState&&i()}:this.iframe.onload=i,this.socket.setBuffer(!0)},o.prototype.get=function(){var t=this,i=document.createElement("script"),o=e.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),i.async=!0,i.src=this.prepareUrl()+o,i.onerror=function(){t.onClose()};var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(i,r),this.script=i,n&&setTimeout(function(){var t=document.createElement("iframe");document.body.appendChild(t),document.body.removeChild(t)},100)},o.prototype._=function(t){return this.onData(t),this.isOpen&&this.get(),this},o.prototype.ready=function(t,i){var o=this;if(!n)return i.call(this);e.util.load(function(){i.call(o)})},o.check=function(){
return"document"in i},o.xdomainCheck=function(){return!0},e.transports.push("jsonp-polling")}(void 0!==io?io.Transport:module.exports,void 0!==io?io:module.parent.exports,this),"function"==typeof define&&define.amd&&define([],function(){return io})}();var IgeSocketIoClient={_initDone:!1,_idCounter:0,_requests:{},id:function(){return this._io&&this._io.socket?this._io.socket.sessionid:""},start:function(t,e){var i=this;void 0===io&&(io=ioNoDom),i._startCallback=e,void 0!==t&&(this._port=t),this.log('Connecting to socket.io server at "'+this._port+'"...'),this._io=io.connect(t),this._io.on("connect",function(){i._onConnectToServer.apply(i,arguments)}),this._io.on("message",function(t){if(!i._initDone){var e,o=0;if("init"===t.cmd){i._initDone=!0,i._networkCommandsLookup=t.ncmds;for(e in i._networkCommandsLookup)i._networkCommandsLookup.hasOwnProperty(e)&&(i._networkCommandsIndex[i._networkCommandsLookup[e]]=e,o++);i.define("_igeRequest",function(){i._onRequest.apply(i,arguments)}),i.define("_igeResponse",function(){i._onResponse.apply(i,arguments)}),i.define("_igeNetTimeSync",function(){i._onTimeSync.apply(i,arguments)}),i.log("Received network command list with count: "+o),"function"==typeof i._startCallback&&(i._startCallback(),delete i._startCallback)}}i._onMessageFromServer.apply(i,arguments)}),this._io.on("disconnect",function(){i._onDisconnectFromServer.apply(i,arguments)})},define:function(t,e){if(void 0!==t&&void 0!==e)return void 0!==this._networkCommandsLookup[t]?this._networkCommands[t]=e:this.log('Cannot define network command "'+t+'" because it does not exist on the server. Please edit your server code and define the network command there before trying to define it on the client!',"error"),this._entity;this.log("Cannot define network command either the commandName or callback parameters were undefined!","error")},send:function(t,e){var i=this._networkCommandsLookup[t];void 0!==i?this._io.json.send([i,e]):this.log('Cannot send network packet with command "'+t+'" because the command has not been defined!',"error")},request:function(t,e,i){var o={id:this.newIdHex(),cmd:t,data:e,callback:i,timestamp:(new Date).getTime()};this._requests[o.id]=o,this.send("_igeRequest",{id:o.id,cmd:t,data:o.data})},response:function(t,e){var i=this._requests[t];i&&(this.send("_igeResponse",{id:t,cmd:i.commandName,data:e}),delete this._requests[t])},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},_onRequest:function(t){this._requests[t.id]=t,this.debug()&&(console.log("onRequest",t),this._debugCounter++),this._networkCommands[t.cmd]&&this._networkCommands[t.cmd](t.id,t.data),this.emit(t.cmd,[t.id,t.data])},_onResponse:function(t){var e=t.id,i=this._requests[e];this.debug()&&(console.log("onResponse",t),this._debugCounter++),i&&(i.callback&&i.callback(i.cmd,t.data),delete this._requests[e])},_onConnectToServer:function(){this.log("Connected to server!"),this.emit("connected")},_onMessageFromServer:function(t){var e=this._networkCommandsIndex[t[0]];this._networkCommands[e]&&this._networkCommands[e](t[1]),this.emit(e,t[1])},_onDisconnectFromServer:function(t){"booted"===t?this.log("Server rejected our connection because it is not accepting connections at this time!","warning"):this.log("Disconnected from server!"),this.emit("disconnected")}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeSocketIoClient);var IgeSocketIoServer={_idCounter:0,_requests:{},start:function(t,e){var i=this;return this._socketById={},this._socketsByRoomId={},void 0!==t&&(this._port=t),this.log("Starting socket.io listener on port "+this._port),this._io=this._socketio.listen(this._port),this._io.set("log level",0),this._io.enable("browser client minification"),this._io.enable("gzip"),this._io.sockets.on("connection",function(t){i._onClientConnect(t)}),"function"==typeof e&&e(),this.define("_igeRequest",function(){i._onRequest.apply(i,arguments)}),this.define("_igeResponse",function(){i._onResponse.apply(i,arguments)}),this.define("_igeNetTimeSync",function(){i._onTimeSync.apply(i,arguments)}),this.timeSyncStart(),this._entity},define:function(t,e){if(void 0!==t){this._networkCommands[t]=e;var i=this._networkCommandsIndex.length;return this._networkCommandsIndex[i]=t,this._networkCommandsLookup[t]=i,this._entity}this.log("Cannot define a network command without a commandName parameter!","error")},clientJoinRoom:function(t,e){return void 0!==t?void 0!==e?(this._clientRooms[t]=this._clientRooms[t]||[],this._clientRooms[t].push(e),this._socketsByRoomId[e]=this._socketsByRoomId[e]||{},this._socketsByRoomId[e][t]=this._socketById[t],this.debug()&&this.log("Client "+t+" joined room "+e),this._entity):(this.log("Cannot add client to room because no roomId was provided!","warning"),this._entity):(this.log("Cannot add client to room because no clientId was provided!","warning"),this._entity)},clientLeaveRoom:function(t,e){return void 0!==t?void 0!==e?(this._clientRooms[t]&&(this._clientRooms[t].pull(e),delete this._socketsByRoomId[e][t]),this._entity):(this.log("Cannot remove client from room because no roomId was provided!","warning"),this._entity):(this.log("Cannot remove client from room because no clientId was provided!","warning"),this._entity)},clientLeaveAllRooms:function(t){if(void 0!==t){for(var e=this._clientRooms[t],i=e.length;i--;)this.clientLeaveRoom(t,e[i]);return delete this._clientRooms[t],this._entity}return this.log("Cannot remove client from room because no clientId was provided!","warning"),this._entity},clientRooms:function(t){return void 0!==t?this._clientRooms[t]||[]:(this.log("Cannot get/set the clientRoom id because no clientId was provided!","warning"),[])},clients:function(t){return void 0!==t?this._socketsByRoomId[t]:this._socketById},socket:function(t){return this._socketById[t]},acceptConnections:function(t){return void 0!==t?(this._acceptConnections=t,t?this.log("Server now accepting connections!"):this.log("Server no longer accepting connections!"),this._entity):this._acceptConnections},send:function(t,e,i){var o,n,r=this._networkCommandsLookup[t];if(void 0!==r)if(i)if("object"==typeof i)for(o=i.length;o--;)n=this._socketById[i[o]],n?n.json.send([r,e]):this.log("Warning, client with ID "+i[o]+" not found in socket list!");else n=this._socketById[i],n?n.json.send([r,e]):this.log("Warning, client with ID "+i+" not found in socket list!");else this._io.sockets.json.send([r,e]);else this.log('Cannot send network packet with command "'+t+'" because the command has not been defined!',"error")},request:function(t,e,i){var o={id:this.newIdHex(),cmd:t,data:e,callback:i,timestamp:(new Date).getTime()};this._requests[o.id]=o,this.send("_igeRequest",{id:o.id,cmd:t,data:o.data})},response:function(t,e){var i=this._requests[t];i?(this.send("_igeResponse",{id:t,cmd:i.commandName,data:e},i.clientId),delete this._requests[t]):this.log("Cannot send response to unidentified request ID: "+t,"warning")},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},_onClientConnect:function(t){var e=this;this._acceptConnections?this.emit("connect",t)?t.disconnect():(this.log("Accepted connection with id "+t.id),this._socketById[t.id]=t,this._clientRooms[t.id]=this._clientRooms[t.id]||[],t.on("message",function(i){e._onClientMessage(i,t.id)}),t.on("disconnect",function(i){e._onClientDisconnect(i,t)}),t.json.send({cmd:"init",ncmds:this._networkCommandsLookup})):(this.log("Rejecting connection with id "+t.id+" - we are not accepting connections at the moment!"),t.disconnect())},_onClientMessage:function(t,e){var i=this._networkCommandsIndex[t[0]];this._networkCommands[i]&&this._networkCommands[i](t[1],e),this.emit(i,[t[1],e])},_onRequest:function(t,e){t.clientId=e,this._requests[t.id]=t,this.debug()&&(console.log("onRequest",t),console.log("emitting",t.cmd,[t.id,t.data]),this._debugCounter++),this._networkCommands[t.cmd]&&this._networkCommands[t.cmd](t.data,e,t.id),this.emit(t.cmd,[t.id,t.data,e])},_onResponse:function(t,e){id=t.id,req=this._requests[id],this.debug()&&(console.log("onResponse",t),this._debugCounter++),req&&(req.callback(req.cmd,[t.data,e]),delete this._requests[id])},_onClientDisconnect:function(t,e){this.log("Client disconnected with id "+e.id),this.emit("disconnect",e.id),this.clientLeaveAllRooms(e.id),delete this._socketById[e.id]}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeSocketIoServer);var IgeSocketIoComponent=IgeEventingClass.extend([{extension:IgeTimeSyncExtension,overwrite:!1}],{classId:"IgeSocketIoComponent",componentId:"network",init:function(t,e){this._entity=t,this._options=e,this._networkCommands={},this._networkCommandsIndex=[],this._networkCommandsLookup={},this._port=8e3,this._debug=!1,this._debugMax=0,this._clientRooms={},this._timeSyncInterval=1e4,this._timeSyncLog={},this._latency=0,ige.isServer&&(this.implement(IgeSocketIoServer),this._socketio=require("../../../"+modulePath+"socket.io"),this._acceptConnections=!1),ige.isClient&&(this._socketio=IgeSocketIoClient,this.implement(IgeSocketIoClient)),this.log("Network component initiated with socket.io version: "+this._socketio.version)},debug:function(t){return void 0!==t?(this._debug=t,this._entity):(this._debugMax>0&&this._debugCounter>=this._debugMax&&(this._debug=!1,this._debugCounter=0),this._debug)},debugMax:function(t){return void 0!==t?(this._debugMax=t,this._entity):this._debugMax}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeSocketIoComponent);var NetIo={};NetIo._debug={_enabled:!0,_node:"undefined"!=typeof module&&void 0!==module.exports,_level:["log","warning","error"],_stacks:!1,_throwErrors:!0,_trace:{setup:!1,enabled:!1,match:""},enabled:function(t){return void 0!==t?(this._enabled=t,this):this._enabled}},NetIo.Class=IgeClass,NetIo.EventingClass=IgeEventingClass,NetIo.Client=NetIo.EventingClass.extend({classId:"NetIo.Client",init:function(t,e){this.log("Net.io client starting..."),this._options=e||{},this._socket=null,this._state=0,this._debug=!1,this._connectionAttempts=0,void 0===this._options.connectionRetry&&(this._options.connectionRetry=!0),void 0===this._options.connectionRetryMax&&(this._options.connectionRetryMax=10),void 0===this._options.reconnect&&(this._options.reconnect=!0),void 0!==t&&this.connect(t)},debug:function(t){return void 0!==t?(this._debug=t,this):this._debug},connect:function(t){this.log("Connecting to server at "+t);var e=this;this._state=1,t=t.replace("http://","ws://"),this._socket=new WebSocket(t,"netio1"),this._socket.onopen=function(){e._onOpen.apply(e,arguments)},this._socket.onmessage=function(){e._onData.apply(e,arguments)},this._socket.onclose=function(){e._onClose.apply(e,arguments)},this._socket.onerror=function(){e._onError.apply(e,arguments)}},disconnect:function(t){this._socket.close(1e3,t)},send:function(t){this._socket.send(this._encode(t))},_onOpen:function(){this._state=2},_onData:function(t){var e=this._decode(t.data);if(this._debug&&console.log("Incoming data (event, decoded data):",t,e),e._netioCmd)switch(e._netioCmd){case"id":this.id=e.data,this._state=3,this.emit("connect",this.id);break;case"close":this._disconnectReason=e.data}else this.emit("message",[e])},_onClose:function(t,e,i){3===this._state&&(this._state=0,this.emit("disconnect",{reason:this._disconnectReason,wasClean:i,code:t})),2===this._state&&(this._state=0,this.emit("disconnect",{reason:this._disconnectReason,wasClean:i,code:t})),1===this._state&&(this._state=0,this.emit("error",{reason:"Cannot establish connection, is server running?"})),delete this._disconnectReason},_onError:function(){this.log("An error occurred with the net.io socket!","error",arguments),this.emit("error",arguments)},_encode:function(t){return JSON.stringify(t)},_decode:function(t){return JSON.parse(t)}});var IgeNetIoClient={version:"1.0.0",_initDone:!1,_idCounter:0,_requests:{},_state:0,id:function(){return this._id||""},start:function(t,e){if(3===this._state)"function"==typeof e&&e();else{var i=this;i._startCallback=e,void 0!==t&&(this._url=t),this.log('Connecting to net.io server at "'+this._url+'"...'),"undefined"!=typeof WebSocket&&(this._io=new NetIo.Client(t),i._state=1,this._io.on("connect",function(t){i._state=2,i._id=t,i._onConnectToServer.apply(i,arguments)}),this._io.on("message",function(t){if(i._initDone)i._onMessageFromServer.apply(i,arguments);else{var e,o=0;if("init"===t.cmd){i._initDone=!0,i._state=3,i._networkCommandsLookup=t.ncmds;for(e in i._networkCommandsLookup)i._networkCommandsLookup.hasOwnProperty(e)&&(i._networkCommandsIndex[i._networkCommandsLookup[e]]=e,o++);i.define("_igeRequest",function(){i._onRequest.apply(i,arguments)}),i.define("_igeResponse",function(){i._onResponse.apply(i,arguments)}),i.define("_igeNetTimeSync",function(){i._onTimeSync.apply(i,arguments)}),i.log("Received network command list with count: "+o),ige.timeScale(parseFloat(t.ts)),ige._currentTime=parseInt(t.ct),"function"==typeof i._startCallback&&(i._startCallback(),delete i._startCallback)}}}),this._io.on("disconnect",function(){i._state=0,i._onDisconnectFromServer.apply(i,arguments)}),this._io.on("error",function(){i._onError.apply(i,arguments)}))}},stop:function(){3===self._state&&this._io.disconnect("Client requested disconnect")},define:function(t,e){if(void 0!==t&&void 0!==e)return void 0!==this._networkCommandsLookup[t]?this._networkCommands[t]=e:this.log('Cannot define network command "'+t+'" because it does not exist on the server. Please edit your server code and define the network command there before trying to define it on the client!',"error"),this._entity;this.log("Cannot define network command either the commandName or callback parameters were undefined!","error")},send:function(t,e){var i,o=this._networkCommandsLookup[t];void 0!==o?(this.debug()&&(console.log('Sending "'+t+'" (index '+o+") with data:",e),this._debugCounter++),i=String.fromCharCode(o),this._io.send([i,e])):this.log('Cannot send network packet with command "'+t+'" because the command has not been defined!',"error")},request:function(t,e,i){var o={id:this.newIdHex(),cmd:t,data:e,callback:i,timestamp:(new Date).getTime()};this._requests[o.id]=o,this.send("_igeRequest",{id:o.id,cmd:t,data:o.data})},response:function(t,e){var i=this._requests[t];i&&(this.send("_igeResponse",{id:t,cmd:i.commandName,data:e}),delete this._requests[t])},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},_onRequest:function(t){this._requests[t.id]=t,this.debug()&&(console.log("onRequest",t),this._debugCounter++),this._networkCommands[t.cmd]&&this._networkCommands[t.cmd](t.id,t.data),this.emit(t.cmd,[t.id,t.data])},_onResponse:function(t){var e,i;e=t.id,i=this._requests[e],this.debug()&&(console.log("onResponse",t),this._debugCounter++),i&&(i.callback(i.cmd,t.data),delete this._requests[e])},_onConnectToServer:function(){this.log("Connected to server!"),this.emit("connected")},_onMessageFromServer:function(t){var e=t[0].charCodeAt(0),i=this._networkCommandsIndex[e];this._networkCommands[i]&&(this.debug()&&(console.log('Received "'+i+'" (index '+e+") with data:",t[1]),this._debugCounter++),this._networkCommands[i](t[1])),this.emit(i,t[1])},_onDisconnectFromServer:function(t){"booted"===t?this.log("Server rejected our connection because it is not accepting connections at this time!","warning"):this.log("Disconnected from server!"),this.emit("disconnected")},_onError:function(t){this.log("Error with connection: "+t.reason,"error")}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeNetIoClient);var IgeNetIoServer={_idCounter:0,_requests:{},start:function(t,e){var i=this;return this._socketById={},this._socketsByRoomId={},void 0!==t&&(this._port=t),this.log("Starting net.io listener on port "+this._port),this._io=new this._netio(this._port,e),this._io.on("connection",function(){i._onClientConnect.apply(i,arguments)}),this.define("_igeRequest",function(){i._onRequest.apply(i,arguments)}),this.define("_igeResponse",function(){i._onResponse.apply(i,arguments)}),this.define("_igeNetTimeSync",function(){i._onTimeSync.apply(i,arguments)}),this.timeSyncStart(),this._entity},define:function(t,e){if(void 0!==t){this._networkCommands[t]=e;var i=this._networkCommandsIndex.length;return this._networkCommandsIndex[i]=t,this._networkCommandsLookup[t]=i,this._entity}this.log("Cannot define a network command without a commandName parameter!","error")},clientJoinRoom:function(t,e){return void 0!==t?void 0!==e?(this._clientRooms[t]=this._clientRooms[t]||[],this._clientRooms[t].push(e),this._socketsByRoomId[e]=this._socketsByRoomId[e]||{},this._socketsByRoomId[e][t]=this._socketById[t],this.debug()&&this.log("Client "+t+" joined room "+e),this._entity):(this.log("Cannot add client to room because no roomId was provided!","warning"),this._entity):(this.log("Cannot add client to room because no clientId was provided!","warning"),this._entity)},clientLeaveRoom:function(t,e){return void 0!==t?void 0!==e?(this._clientRooms[t]&&(this._clientRooms[t].pull(e),delete this._socketsByRoomId[e][t]),this._entity):(this.log("Cannot remove client from room because no roomId was provided!","warning"),this._entity):(this.log("Cannot remove client from room because no clientId was provided!","warning"),this._entity)},clientLeaveAllRooms:function(t){if(void 0!==t){for(var e=this._clientRooms[t],i=e.length;i--;)this.clientLeaveRoom(t,e[i]);return delete this._clientRooms[t],this._entity}return this.log("Cannot remove client from room because no clientId was provided!","warning"),this._entity},clientRooms:function(t){return void 0!==t?this._clientRooms[t]||[]:(this.log("Cannot get/set the clientRoom id because no clientId was provided!","warning"),[])},clients:function(t){return void 0!==t?this._socketsByRoomId[t]:this._socketById},socket:function(t){return this._socketById[t]},acceptConnections:function(t){return void 0!==t?(this._acceptConnections=t,t?this.log("Server now accepting connections!"):this.log("Server no longer accepting connections!"),this._entity):this._acceptConnections},send:function(t,e,i){var o,n=this._networkCommandsLookup[t];void 0!==n?(o=String.fromCharCode(n),this._io.send([o,e],i)):this.log('Cannot send network packet with command "'+t+'" because the command has not been defined!',"error")},request:function(t,e,i){var o={id:this.newIdHex(),cmd:t,data:e,callback:i,timestamp:(new Date).getTime()};this._requests[o.id]=o,this.send("_igeRequest",{id:o.id,cmd:t,data:o.data})},response:function(t,e){var i=this._requests[t];i&&(this.send("_igeResponse",{id:t,cmd:i.commandName,data:e},i.clientId),delete this._requests[t])},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},_originIsAllowed:function(t){return!0},_onClientConnect:function(t){var e=this;this._acceptConnections?this.emit("connect",t)?t.close():(this.log("Accepted connection with id "+t.id),this._socketById[t.id]=t,this._clientRooms[t.id]=this._clientRooms[t.id]||[],t.on("message",function(i){e._onClientMessage.apply(e,[i,t.id])}),t.on("disconnect",function(i){e._onClientDisconnect.apply(e,[i,t])}),t.send({cmd:"init",ncmds:this._networkCommandsLookup,ts:ige._timeScale,ct:ige._currentTime}),this._sendTimeSync(void 0,t.id)):(this.log("Rejecting connection with id "+t.id+" - we are not accepting connections at the moment!"),t.close())},_onClientMessage:function(t,e){var i=t[0].charCodeAt(0),o=this._networkCommandsIndex[i];this._networkCommands[o]&&this._networkCommands[o](t[1],e),this.emit(o,[t[1],e])},_onRequest:function(t,e){t.clientId=e,this._requests[t.id]=t,this.debug()&&(console.log("onRequest",t),console.log("emitting",t.cmd,[t.id,t.data]),this._debugCounter++),this._networkCommands[t.cmd]&&this._networkCommands[t.cmd](t.data,e,t.id),this.emit(t.cmd,[t.id,t.data,e])},_onResponse:function(t,e){id=t.id,req=this._requests[id],this.debug()&&(console.log("onResponse",t),this._debugCounter++),req&&(req.callback(req.cmd,[t.data,e]),delete this._requests[id])},_onClientDisconnect:function(t,e){this.log("Client disconnected with id "+e.id),this.emit("disconnect",e.id),this.clientLeaveAllRooms(e.id),delete this._socketById[e.id]}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeNetIoServer);var IgeNetIoComponent=IgeEventingClass.extend([{extension:IgeTimeSyncExtension,overwrite:!1}],{classId:"IgeNetIoComponent",componentId:"network",init:function(t,e){this._entity=t,this._options=e,this._networkCommands={},this._networkCommandsIndex=[],this._networkCommandsLookup={},this._port=8e3,this._debug=!1,this._debugCounter=0,this._debugMax=0,this._clientRooms={},this._timeSyncInterval=1e4,this._timeSyncLog={},this._latency=0,ige.isServer&&(this.implement(IgeNetIoServer),this._netio=require("../../../"+modulePath+"net.io-server").Server,this._acceptConnections=!1),ige.isClient&&(this._netio=IgeNetIoClient,this.implement(IgeNetIoClient)),this.log("Network component initiated with Net.IO version: "+this._netio.version)},debug:function(t){return void 0!==t?(this._debug=t,this._entity):(this._debugMax>0&&this._debugCounter>=this._debugMax&&(this._debug=!1,this._debugCounter=0),this._debug)},debugMax:function(t){return void 0!==t?(this._debugMax=t,this._entity):this._debugMax}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeNetIoComponent);var IgeChatClient={joinRoom:function(t){ige.network.send("igeChatJoinRoom",t)},sendToRoom:function(t,e,i){void 0!==t&&void 0!==e&&(msg={roomId:t,text:e,to:i},ige.network.send("igeChatMsg",msg))},_onMessageFromServer:function(t){ige.chat.emit("messageFromServer",[t])||console.log('Server sent us a message in the room "'+t.roomId+'" from the user id "'+t.from+'":',t.text)},_onJoinedRoom:function(t){ige.chat.emit("joinedRoom",[t])||(!0===t.joined?console.log("Server says we have joined room:",t.roomId):console.log("Server says we failed to join room:",t.roomId))},_onLeftRoom:function(t){ige.chat.emit("leftRoom",[t])||console.log("We have left room:",t)},_onServerSentRoomList:function(t){ige.chat.emit("roomList",[t])||console.log("Server sent room list:",t)},_onServerSentRoomUserList:function(t){ige.chat.emit("roomUserList",[t])||console.log("Server sent room user list:",t)},_onRoomCreated:function(t){ige.chat.emit("roomCreated",[t])||console.log("Server told us room was created:",t)},_onRoomRemoved:function(t){ige.chat.emit("roomRemoved",[t])||console.log("Server told us room was removed:",t)}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeChatClient);var IgeChatServer={createRoom:function(t,e,i){var o=ige.chat,n=i||ige.newIdHex();return o._rooms[i]={id:n,name:t,options:e,users:[]},o._entity.network.send("igeChatRoomCreated",i),i},removeRoom:function(t){var e=ige.chat;return!!e._rooms[t]&&(e._entity.network.send("igeChatRoomRemoved",t),delete e._rooms[t],!0)},sendToRoom:function(t,e,i,o){var n=ige.chat;if(n._rooms[t]){var r,s=n._rooms[t];void 0!==e?(r={roomId:t,text:e,from:o,to:i},i?s.users.indexOf(i)>-1?n._entity.network.send("igeChatMsg",r,i):n.log("Cannot send to user because specified user is not in room: "+i):(n.log("Sending to all users..."),n._entity.network.send("igeChatMsg",r,s.users))):n.log("Cannot send message to room with blank message!")}else n.log('Cannot send message to room with id "'+t+'" because it does not exist!')},_onMessageFromClient:function(t,e){var i,o=ige.chat;o.emit("messageFromClient",[t,e])||(console.log("Message from client: ("+e+")",t),t.roomId?(i=o._rooms[t.roomId],i?i.users.indexOf(e)>-1?t.text?(console.log("Sending message to room..."),o.sendToRoom(t.roomId,t.text,t.to,e)):console.log("Cannot send message because message text is empty!",t):console.log("User tried to send message to room they are not joined in!",t):console.log("User tried to send message to room that doesn't exist!",t)):console.log("User tried to send message to room but didn't specify room id!",t))},_onJoinRoomRequestFromClient:function(t,e){var i=ige.chat;if(!i.emit("clientJoinRoomRequest",[t,e])){var o=i._rooms[t];i.log("Client wants to join room: ("+e+")",t),o&&(o.users[e]||(o.users.push(e),ige.network.send("igeChatJoinRoom",{roomId:t,joined:!0},e),console.log('User "'+e+'" joined room '+t)))}},_onLeaveRoomRequestFromClient:function(t,e){self.emit("clientLeaveRoomRequest",[t,e])||console.log("Client wants to leave room: ("+e+")",t)},_onClientWantsRoomList:function(t,e){self.emit("clientRoomListRequest",[t,e])||console.log("Client wants the room list: ("+e+")",t)},_onClientWantsRoomUserList:function(t,e){self.emit("clientRoomUserListRequest",[t,e])||console.log("Client wants the room user list: ("+e+")",t)}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeChatServer);var IgeChatComponent=IgeEventingClass.extend({classId:"IgeChatComponent",componentId:"chat",init:function(t,e){this._entity=t,this._options=e,this._rooms={},ige.isServer&&(this.implement(IgeChatServer),this._entity.network.define("igeChatMsg",this._onMessageFromClient).network.define("igeChatJoinRoom",this._onJoinRoomRequestFromClient).network.define("igeChatLeaveRoom",this._onLeaveRoomRequestFromClient).network.define("igeChatRoomList",this._onClientWantsRoomList).network.define("igeChatRoomUserList",this._onClientWantsRoomUserList).network.define("igeChatRoomCreated").network.define("igeChatRoomRemoved")),ige.isClient&&(this.implement(IgeChatClient),this._entity.network.define("igeChatMsg",this._onMessageFromServer).network.define("igeChatJoinRoom",this._onJoinedRoom).network.define("igeChatLeaveRoom",this._onLeftRoom).network.define("igeChatRoomList",this._onServerSentRoomList).network.define("igeChatRoomUserList",this._onServerSentRoomUserList).network.define("igeChatRoomCreated",this._onRoomCreated).network.define("igeChatRoomRemoved",this._onRoomRemoved)),this.log("Chat component initiated!")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeChatComponent);var IgeMySql={settings:function(t){this._host=t.host,this._port=t.port,this._database=t.dbName,this._username=t.user,this._password=t.pass,this._port||(this._port=3306),this.log("Settings initialised")},connect:function(t){var e=this;this.log('Connecting to mysql database "'+this._database+'" @'+this._host+":"+this._port),e.client=this._mysql.createConnection({host:e._host,port:parseInt(e._port,10),user:e._username,password:e._password,database:e._database}),e.client.on("error",function(t){if(t.fatal){if("PROTOCOL_CONNECTION_LOST"!==t.code)throw t;e.log("Re-connecting lost connection: "+t.stack),e.client=e._mysql.createConnection({host:e._host,port:parseInt(e._port,10),user:e._username,password:e._password,database:e._database}),e.client.connect(function(t){e.escape=e.client.escape,e.emit("reconnected",[t,e.client])})}}),e.client.connect(function(i){e.escape=e.client.escape,e._connected.apply(e,[i,e.client,t])})},disconnect:function(t){this.log("Closing DB connection..."),this.client.end(function(){t()})},_connected:function(t,e,i){if(t){switch(t.code){case"ER_DBACCESS_DENIED_ERROR":this.log("MySQL connection error, access denied. Are you using the correct login details?","warning",t);break;default:this.log("MySQL connection error","warning",t)}this.emit("connectionError")}else this.log("MySQL connected successfully."),this.emit("connected");"function"==typeof i&&i.apply(this,[t,e])},query:function(t,e){this.client.query(t,e)},findAll:function(t,e,i){var o,n,r="SELECT * FROM "+t;for(o in e)e.hasOwnProperty(o)&&(n&&(n+=" AND "),n+=o+' = "'+e[o]+'"');n&&(n=" WHERE "+n),this.query(r+n,i)},insert:function(t,e,i){var o=this;this.client.collection(t,function(n,r){n?this.log("Mongo cannot get collection "+t+" with error: "+n,"warning",r):r.insert(e,function(n,r){var s;if(n)o.log("Items you submit to be inserted in the database must be wrapped in an array. Are you wrapping it like [jsonObj] ?"),o.log("Mongo cannot insert item into database, error: "+n,"warning",e);else if(r.length>1)for(s in r)r.hasOwnProperty(s)&&o.idToCollectionId(t,r[s]);else r=r[0],o.idToCollectionId(t,r);"function"==typeof i&&i(n,r)})})},remove:function(t,e,i){var o=this;this.client.collection(t,function(n,r){n?o.log("Mongo cannot run a remove on collection "+t+" with error: "+n,"error",r):(o.collectionIdToId(t,e),r.remove(e,{safe:!0},function(t,e){"function"==typeof i&&i.apply(o,[t])}))})},idToCollectionId:function(t,e){e[t+"_db_id"]=String(e._id),delete e._id},collectionIdToId:function(t,e){e[t+"_db_id"]&&(e._id=new this.client.bson_serializer.ObjectID(e[t+"_db_id"]),delete e[t+"_db_id"])}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMySql);var IgeMySqlComponent=IgeEventingClass.extend({classId:"IgeMySqlComponent",componentId:"mysql",init:function(t,e){this._entity=t,this._options=e,this._mysql=require("../../../"+modulePath+"mysql"),this.implement(IgeMySql),this.settings(e),this.log("Database component initiated!")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMySqlComponent);var IgeMongoDb={settings:function(t){this._host=t.host,this._port=t.port,this._database=t.dbName,this._username=t.user,this._password=t.pass,this._strict=t.strict,this._nativeParser=t.nativeParser,this._port||(this._port=27017),this.log("Settings initialised")},connect:function(t){this.log('Connecting to mongo database "'+this._database+'" @'+this._host+":"+this._port);var e=new this._mongo.Server(this._host,parseInt(this._port),{}),i=this;this.client=new this._mongo.Db(this._database,e,{native_parser:this._nativeParser}),this.client.strict=this._strict,this.client.open(function(e,o){i._username?i.client.authenticate(i._username,i._password,function(e){e?(i.log("Error when authenticating with the database!"),"function"==typeof t&&t.apply(i,[e])):(i.log("Connected to mongo DB ok, processing callbacks..."),i._connected.apply(i,[e,o,t]))}):e?(i.log("Error when connecting to the database!"),"function"==typeof t&&t.apply(i,[e])):(i.log("Connected to mongo DB ok, processing callbacks..."),i._connected.apply(i,[e,o,t]))})},disconnect:function(t){this.log("Closing DB connection..."),this.client.close(),t()},_connected:function(t,e,i){t?(this.log("MongoDB connection error","error",t),this.emit("connectionError")):(this.log("MongoDB connected successfully."),this.emit("connected")),"function"==typeof i&&i.apply(this,[t,e])},insert:function(t,e,i){var o=this;this.client.collection(t,function(n,r){n?this.log("Mongo cannot get collection "+t+" with error: "+n,"warning",r):(o.collectionIdToId(t,e),r.insert(e,function(n,r){var s;if(n)o.log("Items you submit to be inserted in the database must be wrapped in an array. Are you wrapping it like [jsonObj] ?"),o.log("Mongo cannot insert item into database, error: "+n,"warning",e);else if(r.length>1)for(s in r)r.hasOwnProperty(s)&&o.idToCollectionId(t,r[s]);else r=r[0],o.idToCollectionId(t,r);"function"==typeof i&&i(n,r)}))})},remove:function(t,e,i){var o=this;this.client.collection(t,function(n,r){n?o.log("Mongo cannot run a remove on collection "+t+" with error: "+n,"error",r):(o.collectionIdToId(t,e),r.remove(e,{safe:!0,single:!1},function(t,e){"function"==typeof i&&i.apply(o,[t])}))})},findAll:function(t,e,i){var o=this;this.client.collection(t,function(n,r){n?o.log("Mongo cannot run a findAll on collection "+t+" with error: "+n,"error",r):r.find(e,function(e,n){n.toArray(function(e,n){var r;if(n)for(r in n)n.hasOwnProperty(r)&&o.idToCollectionId(t,n[r]);"function"==typeof i&&i.apply(o,[e,n])})})})},update:function(t,e,i,o,n){var r=this;n=n||{safe:!0,multi:!0,upsert:!1},
this.client.collection(t,function(s,a){if(s)r.log("Mongo cannot run a findAll on collection "+t+" with error: "+s,"error",a);else{var h;r.collectionIdToId(t,e),r.collectionIdToId(t,i),h={$set:i},a.update(e,h,n,function(t,e){"function"==typeof o&&o.apply(r,[t,e])})}})},overwrite:function(t,e,i,o,n){var r=this;n=n||{safe:!0,multi:!0,upsert:!1},this.client.collection(t,function(s,a){s?r.log("Mongo cannot run a findAll on collection "+t+" with error: "+s,"error",a):(r.collectionIdToId(t,e),r.collectionIdToId(t,i),a.update(e,i,n,function(e,i){e||i.toArray(function(e,i){var o;if(i)for(o in i)i.hasOwnProperty(o)&&r.idToCollectionId(t,i[o])}),"function"==typeof o&&o.apply(r,[e,results])}))})},idToCollectionId:function(t,e){e[t+"_db_id"]=String(e._id),delete e._id},collectionIdToId:function(t,e){e[t+"_db_id"]&&(e._id=new this.client.bson_serializer.ObjectID(e[t+"_db_id"]),delete e[t+"_db_id"])}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMongoDb);var IgeMongoDbComponent=IgeEventingClass.extend({classId:"IgeMongoDbComponent",componentId:"mongo",init:function(t,e){this._entity=t,this._options=e,this._mongo={},this._mongo.Db=require("../../../"+modulePath+"mongodb").Db,this._mongo.Connection=require("../../../"+modulePath+"mongodb").Connection,this._mongo.Server=require("../../../"+modulePath+"mongodb").Server,this._mongo.BSON=this._mongo.Db.bson_serializer,this.implement(IgeMongoDb),this.settings(e),this.log("Database component initiated!")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMongoDbComponent);var IgeCocoonJsComponent=IgeEventingClass.extend({classId:"IgeCocoonJsComponent",componentId:"cocoonJs",init:function(){this.detected="undefined"!=typeof ext&&void 0!==ext.IDTK_APP,this.detected&&this.log("CocoonJS support enabled!")},showInputDialog:function(t,e,i,o,n,r){this.detected?(t=t||"",e=e||"",i=i||"",o=o||"text",n=n||"Cancel",r=r||"OK",ext.IDTK_APP.makeCall("showTextDialog",t,e,i,o,n,r)):this.log("Cannot open CocoonJS input dialog! CocoonJS is not detected!","error")},showWebView:function(t){this.detected&&(ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('loadPath', '"+t+"')"),ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('show');"))},hideWebView:function(){this.detected&&ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('hide');")}}),IgeUiPositionExtension={left:function(t,e){if(void 0!==t){if(null===t)delete this._uiLeft,delete this._uiLeftPercent;else if(delete this._uiCenter,delete this._uiCenterPercent,"string"==typeof t){this._uiLeftPercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.x:ige._bounds2d.x,o=i/100*n|0,this._uiLeft=o}else this._uiLeft=t,delete this._uiLeftPercent;return e||this._updateUiPosition(),this}return this._uiLeft},right:function(t,e){if(void 0!==t){if(null===t)delete this._uiRight,delete this._uiRightPercent;else if(delete this._uiCenter,delete this._uiCenterPercent,"string"==typeof t){this._uiRightPercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.x:ige._bounds2d.x,o=i/100*n|0,this._uiRight=o}else this._uiRight=t,delete this._uiRightPercent;return e||this._updateUiPosition(),this}return this._uiRight},center:function(t,e){if(void 0!==t){if(null===t)delete this._uiCenter,delete this._uiCenterPercent;else if(delete this._uiLeft,delete this._uiLeftPercent,delete this._uiRight,delete this._uiRightPercent,"string"==typeof t){this._uiCenterPercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.x2:ige._bounds2d.x2,o=i/100*n|0,this._uiCenter=o}else this._uiCenter=t,delete this._uiCenterPercent;return e||this._updateUiPosition(),this}return this._uiCenter},top:function(t,e){if(void 0!==t){if(null===t)delete this._uiTop,delete this._uiTopPercent;else if(delete this._uiMiddle,delete this._uiMiddlePercent,"string"==typeof t){this._uiTopPercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.y:ige._bounds2d.y,o=i/100*n|0,this._uiTop=o}else this._uiTop=t,delete this._uiTopPercent;return e||this._updateUiPosition(),this}return this._uiTop},bottom:function(t,e){if(void 0!==t){if(null===t)delete this._uiBottom,delete this._uiBottomPercent;else if(delete this._uiMiddle,delete this._uiMiddlePercent,"string"==typeof t){this._uiBottomPercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.y:ige._bounds2d.y,o=i/100*n|0,this._uiBottom=o}else this._uiBottom=t,delete this._uiBottomPercent;return e||this._updateUiPosition(),this}return this._uiBottom},middle:function(t,e){if(void 0!==t){if(null===t)delete this._uiMiddle,delete this._uiMiddlePercent;else if(delete this._uiTop,delete this._uiTopPercent,delete this._uiBottom,delete this._uiBottomPercent,"string"==typeof t){this._uiMiddlePercent=t;var i,o,n=parseInt(t,10);i=this._parent?this._parent._bounds2d.y2:ige._bounds2d.y2,o=i/100*n|0,this._uiMiddle=o}else this._uiMiddle=t,delete this._uiMiddlePercent;return e||this._updateUiPosition(),this}return this._uiMiddle},width:function(t,e,i,o){if(void 0!==t){if(null===t)delete this._uiWidth,this._bounds2d.x=0,this._bounds2d.x2=0;else if(this._uiWidth=t,this._widthModifier=void 0!==i?i:0,"string"==typeof t)if(this._parent){var n,r,s=this._parent._bounds2d.x,a=parseInt(t,10);n=s/100*a+this._widthModifier|0,e&&(r=n/this._bounds2d.x,this.height(this._bounds2d.y/r,!1,0,o)),this._bounds2d.x=n,this._bounds2d.x2=Math.floor(this._bounds2d.x/2)}else{var s=ige._bounds2d.x,a=parseInt(t,10);this._bounds2d.x=s/100*a+this._widthModifier|0,this._bounds2d.x2=Math.floor(this._bounds2d.x/2)}else{if(e){var r=t/this._bounds2d.x;this.height(this._bounds2d.y*r,!1,0,o)}this._bounds2d.x=t,this._bounds2d.x2=Math.floor(this._bounds2d.x/2)}return o||this._updateUiPosition(),this}return this._bounds2d.x},height:function(t,e,i,o){if(void 0!==t){if(null===t)delete this._uiHeight,this._bounds2d.y=0,this._bounds2d.y2=0;else if(this._uiHeight=t,this._heightModifier=void 0!==i?i:0,"string"==typeof t)if(this._parent){var n,r,s=this._parent._bounds2d.y,a=parseInt(t,10);n=s/100*a+this._heightModifier|0,e&&(r=n/this._bounds2d.y,this.width(this._bounds2d.x/r,!1,0,o)),this._bounds2d.y=n,this._bounds2d.y2=Math.floor(this._bounds2d.y/2)}else{var s=ige._bounds2d.y,a=parseInt(t,10);this._bounds2d.y=s/100*a+this._heightModifier|0,this._bounds2d.y2=Math.floor(this._bounds2d.y/2)}else{if(e){var r=t/this._bounds2d.y;this.width(this._bounds2d.x*r,!1,0,o)}this._bounds2d.y=t,this._bounds2d.y2=Math.floor(this._bounds2d.y/2)}return o||this._updateUiPosition(),this}return this._bounds2d.y},autoScaleX:function(t,e){return void 0!==t?(this._autoScaleX=t,this._autoScaleLockAspect=e,this._updateUiPosition(),this):this._autoScaleX},autoScaleY:function(t,e){return void 0!==t?(this._autoScaleY=t,this._autoScaleLockAspect=e,this._updateUiPosition(),this):this._autoScaleY},updateUiChildren:function(){var t,e,i=this._children;if(i)for(t=i.length;t--;)e=i[t],e._updateUiPosition&&e._updateUiPosition(),"function"==typeof e.updateUiChildren&&e.updateUiChildren();return this},_updateUiPosition:function(){if(this._parent){var t,e,i,o=this._parent._bounds2d,n=this._bounds2d.multiplyPoint(this._scale);this._autoScaleX&&(t=parseInt(this._autoScaleX,10),e=o.x/100*t,i=e/this._bounds2d.x,this._scale.x=i,this._autoScaleLockAspect&&(this._scale.y=i)),this._autoScaleY&&(t=parseInt(this._autoScaleY,10),e=o.y/100*t,i=e/this._bounds2d.y,this._scale.y=i,this._autoScaleLockAspect&&(this._scale.x=i)),this._uiWidth&&this.width(this._uiWidth,!1,this._widthModifier,!0),this._uiHeight&&this.height(this._uiHeight,!1,this._heightModifier,!0),this._uiCenterPercent&&this.center(this._uiCenterPercent,!0),this._uiMiddlePercent&&this.middle(this._uiMiddlePercent,!0),this._uiLeftPercent&&this.left(this._uiLeftPercent,!0),this._uiRightPercent&&this.right(this._uiRightPercent,!0),this._uiTopPercent&&this.top(this._uiTopPercent,!0),this._uiBottomPercent&&this.bottom(this._uiBottomPercent,!0),void 0!==this._uiCenter?this._translate.x=Math.floor(this._uiCenter):void 0!==this._uiLeft&&void 0!==this._uiRight?(this.width(o.x-this._uiLeft-this._uiRight,!1,0,!0),this._translate.x=Math.floor(this._uiLeft+n.x2-o.x2)):(void 0!==this._uiLeft&&(this._translate.x=Math.floor(this._uiLeft+n.x2-o.x2)),void 0!==this._uiRight&&(this._translate.x=Math.floor(o.x2-n.x2-this._uiRight))),void 0!==this._uiMiddle?this._translate.y=Math.floor(this._uiMiddle):void 0!==this._uiTop&&void 0!==this._uiBottom?(this.height(o.y-this._uiTop-this._uiBottom,!1,0,!0),this._translate.y=Math.floor(this._uiTop+n.y2-o.y2)):(void 0!==this._uiTop&&(this._translate.y=Math.floor(this._uiTop+n.y2-o.y2)),void 0!==this._uiBottom&&(this._translate.y=Math.floor(o.y2-n.y2-this._uiBottom))),this.emit("uiUpdate"),this.cacheDirty(!0)}}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiPositionExtension);var IgeUiStyleExtension={color:function(t){return void 0!==t?(this._color=t,this.cacheDirty(!0),this):this._color},backgroundImage:function(t,e){if(t&&t.image){if(e||(e="no-repeat"),this._patternRepeat=e,this._patternTexture=t,this._backgroundSize?(t.resize(this._backgroundSize.x,this._backgroundSize.y),this._patternWidth=this._backgroundSize.x,this._patternHeight=this._backgroundSize.y):(this._patternWidth=t.image.width,this._patternHeight=t.image.height),this._cell>1){var i=document.createElement("canvas"),o=i.getContext("2d"),n=t._cells[this._cell];i.width=n[2],i.height=n[3],o.drawImage(t.image,n[0],n[1],n[2],n[3],0,0,n[2],n[3]),this._patternFill=ige._ctx.createPattern(i,e)}else this._patternFill=ige._ctx.createPattern(t.image,e);return t.restoreOriginal(),this.cacheDirty(!0),this}return this._patternFill},backgroundSize:function(t,e){return void 0!==t&&void 0!==e?("string"==typeof t&&"auto"!==t&&(t=this._bounds2d.x/100*parseInt(t,10)),"string"==typeof e&&"auto"!==e&&(e=this._bounds2d.y/100*parseInt(e,10)),"auto"===t&&"auto"===e?(this.log("Cannot set background x and y both to auto!","error"),this):("auto"===t?t=this._patternTexture&&this._patternTexture.image?this._patternTexture.image.width*(e/this._patternTexture.image.height):this._bounds2d.x*(e/this._bounds2d.y):"auto"===e&&(e=this._patternTexture&&this._patternTexture.image?this._patternTexture.image.height*(t/this._patternTexture.image.width):this._bounds2d.y*(t/this._bounds2d.x)),0!==t&&0!==e?(this._backgroundSize={x:t,y:e},this._patternTexture&&this._patternRepeat&&this.backgroundImage(this._patternTexture,this._patternRepeat),this.cacheDirty(!0)):this.log("Cannot set background to zero-sized x or y!","error"),this)):this._backgroundSize},backgroundColor:function(t){return void 0!==t?(this._backgroundColor=t,this.cacheDirty(!0),this):this._backgroundColor},backgroundPosition:function(t,e){return void 0!==t&&void 0!==e?(this._backgroundPosition={x:t,y:e},this.cacheDirty(!0),this):this._backgroundPosition},borderColor:function(t){return void 0!==t?(this._borderColor=t,this._borderLeftColor=t,this._borderTopColor=t,this._borderRightColor=t,this._borderBottomColor=t,this.cacheDirty(!0),this):this._borderColor},borderLeftColor:function(t){return void 0!==t?(this._borderLeftColor=t,this.cacheDirty(!0),this):this._borderLeftColor},borderTopColor:function(t){return void 0!==t?(this._borderTopColor=t,this.cacheDirty(!0),this):this._borderTopColor},borderRightColor:function(t){return void 0!==t?(this._borderRightColor=t,this.cacheDirty(!0),this):this._borderRightColor},borderBottomColor:function(t){return void 0!==t?(this._borderBottomColor=t,this.cacheDirty(!0),this):this._borderBottomColor},borderWidth:function(t){return void 0!==t?(this._borderWidth=t,this._borderLeftWidth=t,this._borderTopWidth=t,this._borderRightWidth=t,this._borderBottomWidth=t,this.cacheDirty(!0),this):this._borderWidth},borderLeftWidth:function(t){return void 0!==t?(this._borderLeftWidth=t,this.cacheDirty(!0),this):this._borderLeftWidth},borderTopWidth:function(t){return void 0!==t?(this._borderTopWidth=t,this.cacheDirty(!0),this):this._borderTopWidth},borderRightWidth:function(t){return void 0!==t?(this._borderRightWidth=t,this.cacheDirty(!0),this):this._borderRightWidth},borderBottomWidth:function(t){return void 0!==t?(this._borderBottomWidth=t,this.cacheDirty(!0),this):this._borderBottomWidth},borderRadius:function(t){return void 0!==t?(this._borderRadius=t,this._borderTopLeftRadius=t,this._borderTopRightRadius=t,this._borderBottomRightRadius=t,this._borderBottomLeftRadius=t,this.cacheDirty(!0),this):this._borderRadius},padding:function(t,e,i,o){return this._paddingLeft=t,this._paddingTop=e,this._paddingRight=i,this._paddingBottom=o,this.cacheDirty(!0),this},paddingLeft:function(t){return void 0!==t?(this._paddingLeft=t,this.cacheDirty(!0),this):this._paddingLeft},paddingTop:function(t){return void 0!==t?(this._paddingTop=t,this.cacheDirty(!0),this):this._paddingTop},paddingRight:function(t){return void 0!==t?(this._paddingRight=t,this.cacheDirty(!0),this):this._paddingRight},paddingBottom:function(t){return void 0!==t?(this._paddingBottom=t,this.cacheDirty(!0),this):this._paddingBottom}};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiStyleExtension);var IgeFSM=IgeClass.extend({classId:"IgeFSM",init:function(){this._states={},this._transitions={},this._initialStateName="",this._currentStateName="",this._previousStateName="",this._debug=!1},initialStateName:function(){return this._currentStateName},previousStateName:function(){return this._currentStateName},currentStateName:function(){return this._currentStateName},debug:function(t){return void 0!==t?(this._debug=t,this):this._debug},defineState:function(t,e){return this._states[t]=e,this._initialStateName||(this._initialStateName=t),this},defineTransition:function(t,e,i){return!!(t&&e&&i)&&(this._states[t]||this.log('fromState "'+t+'" specified is not defined as a state!',"error"),this._states[e]||this.log('toState "'+e+'" specified is not defined as a state!',"error"),this._transitions[t]=this._transitions[t]||{},this._transitions[t][e]=i,this)},initialState:function(t,e,i){var o=this.getState(t);this._currentStateName=t,this._debug&&this.log("Entering initial state: "+t),o.enter&&o.enter.apply(o,[e,function(t,e){i&&i(t,e)}])},getState:function(t){return this._states[t]},enterState:function(t,e,i){var o=this;o._transitions[o._currentStateName]&&o._transitions[o._currentStateName][t]?o._transitions[o._currentStateName][t](e,function(n){n?(i&&i(n),this.log('Cannot transition from "'+o._currentStateName+'" to "'+t+'" states.',"warning")):o._transitionStates(o._currentStateName,t,e,i)}):o._transitionStates(o._currentStateName,t,e,i)},exitState:function(t){this.enterState(this._previousStateName,null,t)},_transitionStates:function(t,e,i,o){var n=this,r=n.getState(n._currentStateName),s=n.getState(e);r&&s?(n._debug&&n.log("Exiting state: "+n._currentStateName),r.exit&&r.exit.apply(r,[i,function(t,r){n._previousStateName=n._currentStateName,n._currentStateName=e,n._debug&&n.log("Entering state: "+e),s.enter&&s.enter.apply(s,[i,function(t,e){o&&o(t,i)}])}])):(o&&o('Cannot change states from "'+n._currentStateName+'" to "'+e+'" states.'),n.log('Cannot change states from "'+n._currentStateName+'" to "'+e+'" states.',"warning"))}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeFSM);var IgeSceneGraph=IgeClass.extend({classId:"IgeSceneGraph",interfaceImplements:["addGraph","removeGraph"],addGraph:function(t){},removeGraph:function(){}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeSceneGraph);var IgeBaseScene=IgeSceneGraph.extend({classId:"IgeBaseScene",init:function(){},addGraph:function(t){ige.$("baseScene")&&this.destroyGraph();var e=(new IgeScene2d).id("baseScene");(new IgeViewport).id("vp1").autoSize(!0).scene(e).drawBounds(!1).mount(ige)},removeGraph:function(){ige.$("vp1").destroy(),ige.$("baseScene").destroy()}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeBaseScene);var nullMethod=function(){},IgeDummyCanvas=function(){this.dummy=!0,this.width=0,this.height=0};IgeDummyCanvas.prototype.getContext=function(){return IgeDummyContext},"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeDummyCanvas);var nullMethod=function(){},IgeDummyContext={dummy:!0,save:nullMethod,restore:nullMethod,translate:nullMethod,rotate:nullMethod,scale:nullMethod,drawImage:nullMethod,fillRect:nullMethod,strokeRect:nullMethod,stroke:nullMethod,fill:nullMethod,rect:nullMethod,moveTo:nullMethod,lineTo:nullMethod,arc:nullMethod,clearRect:nullMethod,beginPath:nullMethod,clip:nullMethod,transform:nullMethod,setTransform:nullMethod,fillText:nullMethod};"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeDummyContext);var IgePathNode=IgePoint3d.extend({classId:"IgePathNode",init:function(t,e,i,o,n,r,s){this.z=0,this.x=t,this.y=e,this.g=i+o,this.h=n,this.moveCost=o,this.f=i+n,this.link=r,this.hash=t+","+e,this.listType=0,this.direction=s,this.mode=0},mode:function(t){return void 0!==t?(this.mode=t,this):this.mode}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePathNode);var IgePathFinder=IgeEventingClass.extend({classId:"IgePathFinder",init:function(){this._neighbourLimit=1e3,this._squareCost=10,this._diagonalCost=10},squareCost:function(t){return void 0!==t?(this._squareCost=t,this):this._squareCost},diagonalCost:function(t){return void 0!==t?(this._diagonalCost=t,this):this._diagonalCost},neighbourLimit:function(t){return void 0!==t?(this._neighbourLimit=t,this):this._neighbourLimit},aStar:function(){this.log('The "IgePathFinder.aStar" method has been renamed to "generate". Please update your code.',"error")},generate:function(t,e,i,o,n,r,s){var a,h,l,c,u,m,d,p,_,f,y,g,v,x=[],b=[],E={};if(void 0===n&&(n=!0),void 0===r&&(r=!1),y=t.map._mapData,f=y[i.y]&&y[i.y][i.x]?y[i.y][i.x]:null,!s&&!o(f,i.x,i.y))return this.emit("noPathFound"),[];for(a=new IgePathNode(e.x,e.y,0,0,this._heuristic(e.x,e.y,i.x,i.y,10)),a.link=1,x.push(a),E[a.hash]=a,a.listType=1,v=a;x.length;){if(x.length>this._neighbourLimit){this.emit("exceededLimit");break}for(h=0,l=x.length;l--;)x[l].f<x[h].f&&(h=l);if(c=x[h],c.x===i.x&&c.y===i.y){for(u=c,m=[];u.link;)m.push(u),u=u.link;return this.emit("pathFound",m),m.reverse()}for(x.splice(h,1),b.push(c),c.listType=-1,d=this._getNeighbours(c,i,t,o,n,r),p=d.length;p--;)_=d[p],g=E[_.hash],g&&-1===g.listType||(g&&1===g.listType?g.g>_.g&&(g.link=_.link,g.g=_.g,g.f=_.f):(x.push(_),E[_.hash]=_,_.listType=1,g=_)),(!v||g.h<v.h)&&(v=g)}if(!s||s&&!v)return this.emit("noPathFound"),[];for(u=v,m=[];u.link;)m.push(u),u=u.link;return m=m.reverse(),this.emit("pathFound",m),m},_getNeighbours:function(t,e,i,o,n,r){var s,a,h=[],l=t.x,c=t.y,u=0,m=0,d=i.map._mapData,p=d[c]&&d[c][l]?d[c][l]:void 0;return n&&(u=l-1,m=c,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._squareCost,this._heuristic(u,m,e.x,e.y,this._squareCost),t,"W"),h.push(s)),u=l+1,m=c,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._squareCost,this._heuristic(u,m,e.x,e.y,this._squareCost),t,"E"),h.push(s)),u=l,m=c-1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._squareCost,this._heuristic(u,m,e.x,e.y,this._squareCost),t,"N"),h.push(s)),u=l,m=c+1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._squareCost,this._heuristic(u,m,e.x,e.y,this._squareCost),t,"S"),h.push(s))),r&&(u=l-1,m=c-1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._diagonalCost,this._heuristic(u,m,e.x,e.y,this._diagonalCost),t,"NW"),h.push(s)),u=l+1,m=c-1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._diagonalCost,this._heuristic(u,m,e.x,e.y,this._diagonalCost),t,"NE"),h.push(s)),u=l-1,m=c+1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._diagonalCost,this._heuristic(u,m,e.x,e.y,this._diagonalCost),t,"SW"),h.push(s)),u=l+1,m=c+1,a=d[m]&&d[m][u]?d[m][u]:null,o(a,u,m,p,l,c)&&(s=new IgePathNode(u,m,t.g,this._diagonalCost,this._heuristic(u,m,e.x,e.y,this._diagonalCost),t,"SE"),h.push(s))),h},_heuristic:function(t,e,i,o,n){return n*(Math.abs(t-i)+Math.abs(e-o))},as:function(t,e,i){var o=[];o.push(e)},_as:function(t,e,i,o){}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgePathFinder);var IgeTween=IgeClass.extend({classId:"IgeTween",init:function(t,e,i,o){this._targetObj=t,this._steps=[],this._currentStep=-1,void 0!==e&&this.stepTo(e),this._durationMs=void 0!==i?i:0,this._started=!1,this._stepDirection=!1,o&&o.easing?this.easing(o.easing):this.easing("none"),o&&void 0!==o.startTime&&this.startTime(o.startTime),o&&void 0!==o.beforeTween&&this.beforeTween(o.beforeTween),o&&void 0!==o.afterTween&&this.afterTween(o.afterTween)},targetObj:function(t){return void 0!==t&&(this._targetObj=t),this},properties:function(t){return void 0!==t&&(this._steps=[],this._currentStep=-1,this.stepTo(t)),this},repeatMode:function(t,e){return void 0!==t?(this._repeatMode=t,this.repeatCount(e),this):this._repeatMode},repeatCount:function(t){return void 0!==t?(this._repeatCount=t,this._repeatedCount=0,this):this._repeatCount},step:function(t,e,i){return this.log("The step method has been renamed to stepTo(). Please update your code as the step() method will soon be removed.","warning"),this.stepTo(t,e,i),this},stepTo:function(t,e,i,o){return void 0!==t&&this._steps.push({props:t,durationMs:e,easing:i,isDelta:o}),this},stepBy:function(t,e,i){return this.stepTo(t,e,i,!0),this},duration:function(t){return void 0!==t&&(this._durationMs=t),this},beforeTween:function(t){return void 0!==t&&(this._beforeTween=t),this},afterTween:function(t){return void 0!==t&&(this._afterTween=t),this},beforeStep:function(t){return void 0!==t&&(this._beforeStep=t),this},afterStep:function(t){return void 0!==t&&(this._afterStep=t),this},afterChange:function(t){return void 0!==t&&(this._afterChange=t),this},targetObject:function(){return this._targetObj},easing:function(t){return void 0!==t&&(ige.tween.easing[t]?this._easing=t:this.log("The easing method you have selected does not exist, please use a valid easing method. For a list of easing methods please inspect ige.tween.easing from your console.","error",ige.tween.easing)),this},startTime:function(t){return void 0!==t&&(this._startTime=t),this},start:function(t){return void 0!==t&&this.startTime(t+ige._currentTime),ige.tween.start(this),this._targetObj._tweenArr=this._targetObj._tweenArr||[],this._targetObj._tweenArr.push(this),this},stop:function(){return ige.tween.stop(this),this._targetObj._tweenArr&&this._targetObj._tweenArr.pull(this),this},startAll:function(){return this._targetObj._tweenArr&&this._targetObj._tweenArr.eachReverse(function(t){t.start()}),this},stopAll:function(){return this._targetObj._tweenArr&&this._targetObj._tweenArr.eachReverse(function(t){t.stop()}),this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTween);var IgeTexture=IgeEventingClass.extend({classId:"IgeTexture",IgeTexture:!0,init:function(t){if(this._loaded=!1,ige.isServer)return this.log('Cannot create a texture on the server. Textures are only client-side objects. Please alter your code so that you don\'t try to load a texture on the server-side using something like an if statement around your texture laoding such as "if (ige.isClient) {}".',"error"),this;this._cells=[],this._smoothing=ige._globalSmoothing,this._applyFilters=[],this._applyFiltersData=[],this._preFilters=[],this._preFiltersData=[];var e=typeof t;"string"===e&&t&&this.url(t),"object"===e&&this.assignSmartTextureImage(t)},id:function(t){if(void 0!==t){if(!ige._register[t])return this._id&&ige._register[this._id]&&ige.unRegister(this),this._id=t,ige.register(this),this;if(ige._register[t]===this)return this;this.log('Cannot set ID of object to "'+t+'" because that ID is already in use by another object!',"error")}return this._id||(this._url?this._id=ige.newIdFromString(this._url):this._id=ige.newIdHex(),ige.register(this)),this._id},url:function(t){return void 0!==t?(this._url=t,"js"===t.substr(t.length-2,2)?this._loadScript(t):this._loadImage(t),this):this._url},_loadImage:function(t){var e,i=this;ige.isClient&&(ige.textureLoadStart(t,this),ige._textureImageStore[t]?(e=this.image=this._originalImage=ige._textureImageStore[t],e._igeTextures.push(this),e._loaded&&(i._mode=0,i.sizeX(e.width),i.sizeY(e.height),e.width%2&&this.log("This texture's width is not divisible by 2 which will cause the texture to use sub-pixel rendering resulting in a blurred image. This may also slow down the renderer on some browsers. Image file: "+this._url,"warning"),e.height%2&&this.log("This texture's height is not divisible by 2 which will cause the texture to use sub-pixel rendering resulting in a blurred image. This may also slow down the renderer on some browsers. Image file: "+this._url,"warning"),i._cells[1]=[0,0,i._sizeX,i._sizeY],i._textureLoaded())):(e=ige._textureImageStore[t]=this.image=this._originalImage=new Image,e._igeTextures=e._igeTextures||[],e._igeTextures.push(this),e.onload=function(){e._loaded=!0,ige.log("Texture image ("+t+") loaded successfully");var i,o,n=e._igeTextures,r=n.length;for(i=0;i<r;i++)o=n[i],o._mode=0,o.sizeX(e.width),o.sizeY(e.height),o._cells[1]=[0,0,o._sizeX,o._sizeY],o._textureLoaded()},e.src=t))},_textureLoaded:function(){var t=this;setTimeout(function(){t._loaded=!0,t.emit("loaded"),ige.textureLoadEnd(t.image.src,t)},5)},_loadScript:function(scriptUrl){var textures=ige.textures,rs_sandboxContext,self=this,scriptElem;ige.textureLoadStart(scriptUrl,this),ige.isClient&&(scriptElem=document.createElement("script"),scriptElem.onload=function(data){self.log('Texture script "'+scriptUrl+'" loaded successfully'),eval(data),self._mode=1,self.script=image,"function"==typeof image.init&&image.init.apply(image,[self]),self._loaded=!0,self.emit("loaded"),ige.textureLoadEnd(scriptUrl,self)},scriptElem.addEventListener("error",function(){self.log("Error loading smart texture script file: "+scriptUrl,"error")},!0),scriptElem.src=scriptUrl,document.getElementsByTagName("head")[0].appendChild(scriptElem))},assignSmartTextureImage:function(t){var e=(ige.textures,this);"function"==typeof t.render?(e._mode=1,e.script=t,"function"==typeof t.init&&t.init.apply(t,[e]),e._loaded=!0,e.emit("loaded")):this.log("Cannot assign smart texture because it doesn't have a render() method!","error")},_setImage:function(t){var e;ige.isClient&&(e=this.image=this._originalImage=t,e._igeTextures=e._igeTextures||[],e._loaded=!0,this._mode=0,this.sizeX(e.width),this.sizeY(e.height),this._cells[1]=[0,0,this._sizeX,this._sizeY])},textureFromCell:function(t){var e=new IgeTexture,i=this;return this._loaded?this._textureFromCell(e,t):this.on("loaded",function(){i._textureFromCell(e,t)}),e},_textureFromCell:function(t,e){var i,o,n,r;i="string"==typeof e?this.cellIdToIndex(e):e,this._cells[i]?(o=this._cells[i],n=document.createElement("canvas"),r=n.getContext("2d"),this._smoothing?(r.imageSmoothingEnabled=!0,r.mozImageSmoothingEnabled=!0):(r.imageSmoothingEnabled=!1,r.mozImageSmoothingEnabled=!1),n.width=o[2],n.height=o[3],r.drawImage(this._originalImage,o[0],o[1],o[2],o[3],0,0,o[2],o[3]),t._setImage(n),t._loaded=!0,setTimeout(function(){t.emit("loaded")},1)):this.log("Unable to create new texture from passed cell index ("+e+") because the cell does not exist!","warning")},sizeX:function(t){this._sizeX=t},sizeY:function(t){this._sizeY=t},resize:function(t,e,i){this._originalImage&&(this._loaded?(this._textureCtx||(this._textureCanvas=document.createElement("canvas")),this._textureCanvas.width=t,this._textureCanvas.height=e,this._textureCtx=this._textureCanvas.getContext("2d"),this._smoothing?(this._textureCtx.imageSmoothingEnabled=!0,this._textureCtx.mozImageSmoothingEnabled=!0):(this._textureCtx.imageSmoothingEnabled=!1,this._textureCtx.mozImageSmoothingEnabled=!1),i||this._textureCtx.drawImage(this._originalImage,0,0,this._originalImage.width,this._originalImage.height,0,0,t,e),this.image=this._textureCanvas):this.log("Cannot resize texture because the texture image ("+this._url+") has not loaded into memory yet!","error"))},resizeByPercent:function(t,e,i){this._originalImage&&(this._loaded?(t=Math.floor(this.image.width/100*t),e=Math.floor(this.image.height/100*e),this._textureCtx||(this._textureCanvas=document.createElement("canvas")),this._textureCanvas.width=t,this._textureCanvas.height=e,this._textureCtx=this._textureCanvas.getContext("2d"),this._smoothing?(this._textureCtx.imageSmoothingEnabled=!0,this._textureCtx.mozImageSmoothingEnabled=!0):(this._textureCtx.imageSmoothingEnabled=!1,this._textureCtx.mozImageSmoothingEnabled=!1),i||this._textureCtx.drawImage(this._originalImage,0,0,this._originalImage.width,this._originalImage.height,0,0,t,e),this.image=this._textureCanvas):this.log("Cannot resize texture because the texture image ("+this._url+") has not loaded into memory yet!","error"))},restoreOriginal:function(){this.image=this._originalImage,delete this._textureCtx,delete this._textureCanvas,this.removeFilters()},smoothing:function(t){return void 0!==t?(this._smoothing=t,this):this._smoothing},render:function(t,e){if(null!==e._cell){if(this._smoothing?(ige._ctx.imageSmoothingEnabled=!0,ige._ctx.mozImageSmoothingEnabled=!0):(ige._ctx.imageSmoothingEnabled=!1,ige._ctx.mozImageSmoothingEnabled=!1),0===this._mode){var i=this._cells[e._cell],o=e._bounds2d,n=e._renderPos;if(i){if(this._preFilters.length>0&&this._textureCtx){this._textureCtx.clearRect(0,0,this._textureCanvas.width,this._textureCanvas.height),this._textureCtx.drawImage(this._originalImage,0,0);var r=this;this._applyFilters.forEach(function(t,e){r._textureCtx.save(),t(r._textureCanvas,r._textureCtx,r._originalImage,r,r._applyFiltersData[e]),r._textureCtx.restore()}),this._preFilters.forEach(function(t,e){r._textureCtx.save(),t(r._textureCanvas,r._textureCtx,r._originalImage,r,r._preFiltersData[e]),r._textureCtx.restore()})}t.drawImage(this.image,i[0],i[1],i[2],i[3],n.x,n.y,o.x,o.y),ige._drawCount++}else this.log("Cannot render texture using cell "+e._cell+" because the cell does not exist in the assigned texture!","error")}1===this._mode&&(t.save(),this.script.render(t,e,this),t.restore(),ige._drawCount++)}},removeFilter:function(t){for(var e;(e=this._preFilters.indexOf(t))>-1;)this._preFilters[e]=void 0,this._preFiltersData[e]=void 0;for(;(e=this._applyFilters.indexOf(t))>-1;)this._applyFilters[e]=void 0,this._applyFiltersData[e]=void 0;this._preFilters=this._preFilters.clean(),this._preFiltersData=this._preFiltersData.clean(),this._applyFilters=this._applyFilters.clean(),this._applyFiltersData=this._applyFiltersData.clean(),this._rerenderFilters()},removeFilters:function(){this._applyFilters=[],this._applyFiltersData=[],this._preFilters=[],this._preFiltersData=[],this._rerenderFilters()},_rerenderFilters:function(){if(this._textureCanvas){this.resize(this._textureCanvas.width,this._textureCanvas.height,!1);var t=this;this._applyFilters.forEach(function(e,i){t._textureCtx.save(),e(t._textureCanvas,t._textureCtx,t._originalImage,t,t._applyFiltersData[i]),t._textureCtx.restore()})}},preFilter:function(t,e){return void 0!==t?(this._originalImage&&(this._textureCtx||(this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=this._originalImage.width,this._textureCanvas.height=this._originalImage.height,this._textureCtx=this._textureCanvas.getContext("2d"),this._smoothing?(this._textureCtx.imageSmoothingEnabled=!0,this._textureCtx.mozImageSmoothingEnabled=!0):(this._textureCtx.imageSmoothingEnabled=!1,this._textureCtx.mozImageSmoothingEnabled=!1)),this.image=this._textureCanvas,this._preFilters[this._preFilters.length]=t,this._preFiltersData[this._preFiltersData.length]=e||{}),this):(this.log("Cannot use pre-filter, no filter method was passed!","warning"),this._preFilters[this._preFilters.length-1])},applyFilter:function(t,e){return this._loaded?void 0!==t?this._originalImage&&(this._textureCtx||(this._textureCanvas=document.createElement("canvas"),
this._textureCanvas.width=this._originalImage.width,this._textureCanvas.height=this._originalImage.height,this._textureCtx=this._textureCanvas.getContext("2d"),this._textureCtx.clearRect(0,0,this._textureCanvas.width,this._textureCanvas.height),this._textureCtx.drawImage(this._originalImage,0,0),this._smoothing?(this._textureCtx.imageSmoothingEnabled=!0,this._textureCtx.mozImageSmoothingEnabled=!0):(this._textureCtx.imageSmoothingEnabled=!1,this._textureCtx.mozImageSmoothingEnabled=!1)),this.image=this._textureCanvas,this._preFilters.length<=0&&(this._textureCtx.save(),t(this._textureCanvas,this._textureCtx,this._originalImage,this,e),this._textureCtx.restore()),this._applyFilters[this._applyFilters.length]=t,this._applyFiltersData[this._applyFiltersData.length]=e||{}):this.log("Cannot apply filter, no filter method was passed!","warning"):this.log("Cannot apply filter, the texture you are trying to apply the filter to has not yet loaded!","error"),this},pixelData:function(t,e){if(this._loaded){if(this.image)return this._textureCtx?this._textureCtx=this._textureCtx:(this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=this.image.width,this._textureCanvas.height=this.image.height,this._textureCtx=this._textureCanvas.getContext("2d"),this._smoothing?(this._textureCtx.imageSmoothingEnabled=!0,this._textureCtx.mozImageSmoothingEnabled=!0):(this._textureCtx.imageSmoothingEnabled=!1,this._textureCtx.mozImageSmoothingEnabled=!1),this._textureCtx.drawImage(this.image,0,0)),this._textureCtx.getImageData(t,e,1,1).data}else this.log("Cannot read pixel data, the texture you are trying to read data from has not yet loaded!","error");return this},clone:function(){return this.textureFromCell(1)},stringify:function(){var t="new "+this.classId()+"('"+this._url+"')";return t+=this._stringify()},_stringify:function(){return""},destroy:function(){delete this._eventListeners,this.image&&this.image._igeTextures&&this.image._igeTextures.pull(this),ige._textureStore.pull(this),delete this.image,delete this.script,delete this._textureCanvas,delete this._textureCtx,this._destroyed=!0}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTexture);var IgeCellSheet=IgeTexture.extend({classId:"IgeCellSheet",IgeSpriteSheet:!0,init:function(t,e,i){var o=this;o.horizontalCells(e||1),o.verticalCells(i||1),IgeTexture.prototype.init.call(this,t)},_textureLoaded:function(){this.image?(this._sheetImage=this.image,this._applyCells()):this.log("Cannot create cell-sheet because texture has not loaded an image!","error"),IgeTexture.prototype._textureLoaded.call(this)},cellCount:function(){return this.horizontalCells()*this.verticalCells()},horizontalCells:function(t){return void 0!==t?(this._cellColumns=t,this):this._cellColumns},verticalCells:function(t){return void 0!==t?(this._cellRows=t,this):this._cellRows},_applyCells:function(){var t,e,i,o,n,r,s,a,h;if(this.image&&this._cellRows&&this._cellColumns)if(t=this._sizeX,e=this._sizeY,i=this._cellRows,o=this._cellColumns,n=this._cellWidth=t/o,r=this._cellHeight=e/i,n!==parseInt(n,10)&&this.log("Cell width is a floating-point number! (Image Width "+t+" / Number of Columns "+o+" = "+n+") in file: "+this._url,"warning"),r!==parseInt(r,10)&&this.log("Cell height is a floating-point number! (Image Height "+e+" / Number of Rows "+i+" = "+r+")  in file: "+this._url,"warning"),i>1||o>1)for(s=1;s<=i*o;s++)h=Math.ceil(s/o)-1,a=s-o*h-1,this._cells[s]=[a*n,h*r,n,r];else this._cells[1]=[0,0,this._sizeX,this._sizeY]},stringify:function(){return"new "+this.classId()+"('"+this.url()+"', "+this.horizontalCells()+", "+this.verticalCells()+")"}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTexture);var IgeSpriteSheet=IgeTexture.extend({classId:"IgeSpriteSheet",IgeSpriteSheet:!0,init:function(t,e){this._spriteCells=e,IgeTexture.prototype.init.call(this,t)},_textureLoaded:function(){if(this.image){this._sheetImage=this.image;var t,e=this._spriteCells;for(e||(this.log("No cell data provided for sprite sheet, attempting to automatically detect sprite bounds..."),e=this.detectCells(this._sheetImage)),t=0;t<e.length;t++)this._cells[t+1]=e[t],this._checkModulus&&(e[t][2]%2&&this.log("This texture's cell definition defines a cell width is not divisible by 2 which can cause the texture to use sub-pixel rendering resulting in a blurred image. This may also slow down the renderer on some browsers. Image file: "+this._url,"warning",e[t]),e[t][3]%2&&this.log("This texture's cell definition defines a cell height is not divisible by 2 which can cause the texture to use sub-pixel rendering resulting in a blurred image. This may also slow down the renderer on some browsers. Image file: "+this._url,"warning",e[t]))}else this.log("Cannot create cell-sheet because texture has not loaded an image!","error");IgeTexture.prototype._textureLoaded.call(this)},detectCells:function(t){var e,i,o,n,r=document.createElement("canvas"),s=r.getContext("2d"),a=[];for(r.width=t.width,r.height=t.height,s.drawImage(t,0,0),e=s.getImageData(0,0,r.width,r.height),o=0;o<r.height;o++)for(i=0;i<r.width;i++)if(!e.isTransparent(i,o)&&!this._pixelInRects(a,i,o)){if(!(n=this._determineRect(e,i,o)))return this.log("Cannot automatically determine sprite bounds!","warning"),[];a.push(n)}return a},_pixelInRects:function(t,e,i){var o,n,r=t.length;for(o=0;o<r;o++)if(n=t[o],e>=n.x&&e<=n.x+n.width&&i>=n.y&&i<=n.y+n.height)return!0;return!1},_determineRect:function(t,e,i){for(var o,n=[{x:e,y:i}],r={x:e,y:i,width:1,height:1};n.length;)o=n.shift(),o.x>r.x+r.width&&(r.width=o.x-r.x+1),o.y>r.y+r.height&&(r.height=o.y-r.y+1),o.x<r.x&&(r.width+=r.x-o.x,r.x=o.x),o.y<r.y&&(r.height+=r.y-o.y,r.y=o.y),t.isTransparent(o.x-1,o.y-1)||(t.makeTransparent(o.x-1,o.y-1),n.push({x:o.x-1,y:o.y-1})),t.isTransparent(o.x,o.y-1)||(t.makeTransparent(o.x,o.y-1),n.push({x:o.x,y:o.y-1})),t.isTransparent(o.x+1,o.y-1)||(t.makeTransparent(o.x+1,o.y-1),n.push({x:o.x+1,y:o.y-1})),t.isTransparent(o.x-1,o.y)||(t.makeTransparent(o.x-1,o.y),n.push({x:o.x-1,y:o.y})),t.isTransparent(o.x+1,o.y)||(t.makeTransparent(o.x+1,o.y),n.push({x:o.x+1,y:o.y})),t.isTransparent(o.x-1,o.y+1)||(t.makeTransparent(o.x-1,o.y+1),n.push({x:o.x-1,y:o.y+1})),t.isTransparent(o.x,o.y+1)||(t.makeTransparent(o.x,o.y+1),n.push({x:o.x,y:o.y+1})),t.isTransparent(o.x+1,o.y+1)||(t.makeTransparent(o.x+1,o.y+1),n.push({x:o.x+1,y:o.y+1}));return[r.x,r.y,r.width,r.height]},cellCount:function(){return this._cells.length},cellIdToIndex:function(t){var e,i=this._cells;for(e=1;e<i.length;e++)if(i[e][4]===t)return e;return-1},stringify:function(){return"new "+this.classId()+"('"+this.url()+"', "+this._cells.toString()+")"}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeSpriteSheet);var IgeFontSheet=IgeTexture.extend({classId:"IgeFontSheet",init:function(t){IgeTexture.prototype.init.call(this,t),arguments[1]&&this.log("Font sheets no longer accept a caching limit value. All font output is now cached by default via the actual font entity - fontEntity.cache(true);","warning"),this._noDimensions=!0,this.on("loaded",function(){if(this.image)if(this._sheetImage=this.image,this._fontData=this.decodeHeader(),this._charCodeMap=this._fontData.characters.charCodes,this._charPosMap=this._fontData.characters.charPosition,this._measuredWidthMap=this._fontData.characters.measuredWidth,this._pixelWidthMap=this._fontData.characters.pixelWidth,this._fontData){var t=this._fontData.font;this.log("Loaded font sheet for font: "+t.fontName+" @ "+t.fontSize+t.fontSizeUnit+" in "+t.fontColor)}else this.log("Could not load data header for font sheet: "+this.image.src,"error")})},decodeHeader:function(){var t=document.createElement("canvas"),e=t.getContext("2d");return t.width=this.image.width,t.height=1,e.drawImage(this.image,0,0),this._decode(t,0,0,this.image.width)},_decode:function(t,e,i,o){"use strict";for(var n=t.getContext("2d"),r=n.getImageData(e,i,o,t.height).data,s=!0,a=0,h="";s;){if("3 2 1"===String(r[a])+" "+String(r[a+1])+" "+String(r[a+2]))return s=!1,JSON.parse(h);h+=String.fromCharCode(r[a])+String.fromCharCode(r[a+1])+String.fromCharCode(r[a+2]),a+=4,a>r.length&&(s=!1,console.log("Image JSON Decode Error!"))}},lineHeightModifier:function(t){void 0!==t&&(this._lineHeightModifier=t)},measureTextWidth:function(t){if(this._loaded){var e,i,o,n,r=this._charCodeMap,s=this._measuredWidthMap,a=[],h=0;for(t.indexOf("\n")>-1?a=t.split("\n"):a.push(t),o=0;o<a.length;o++){for(n=0,e=0;e<a[o].length;e++)i=r[a[o].charCodeAt(e)],n+=s[i]||0;n>h&&(h=n)}return n}return-1},render:function(t,e){if(e._renderText&&this._loaded){var i,o,n,r,s=t,a=e._renderText,h=[],l=this._charCodeMap,c=this._charPosMap,u=this._measuredWidthMap,m=this._pixelWidthMap,d=0,p=0,_=0,f=[],y=this._sizeY-2,g=0,v=0;switch(a.indexOf("\n")>-1?h=a.split("\n"):h.push(a),y*h.length,e._textAlignY){case 0:case 1:case 2:_=-y*h.length/2-e._textLineSpacing*((h.length-1)/2)}for(o=0;o<h.length;o++){for(i=h[o],n=0;n<i.length;n++)r=l[i.charCodeAt(n)],g+=u[r]||0;f[o]=g,g>v&&(v=g),g=0}switch(e._textAlignX){case 0:-e._bounds2d.x2;break;case 1:-v/2;break;case 2:e._bounds2d.x2-v}for(o=0;o<h.length;o++){switch(i=h[o],p=y*o+e._textLineSpacing*o,e._textAlignX){case 0:d=-e._bounds2d.x2;break;case 1:d=-f[o]/2;break;case 2:d=e._bounds2d.x2-f[o]}for(n=0;n<i.length;n++)r=l[i.charCodeAt(n)],s.drawImage(this.image,c[r],2,m[r],this._sizeY-2,Math.floor(0+d),Math.floor(0+_+p),m[r],this._sizeY-2),e._colorOverlay&&(s.save(),s.globalCompositeOperation="source-atop",s.fillStyle=e._colorOverlay,s.fillRect(Math.floor(0+d),Math.floor(0+_+p),m[r],this._sizeY-2),s.restore()),d+=u[r]||0,ige._drawCount++;d=0}}},destroy:function(){this.image=null,this.script=null}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeFontSheet);var IgeFontSmartTexture={measureTextWidth:function(t,e){if(e._nativeFont){var i,o,n=[],r=0,s=document.createElement("canvas"),a=s.getContext("2d");for(t.indexOf("\n")>-1?n=t.split("\n"):n.push(t),a.font=e._nativeFont,a.textBaseline="middle",e._nativeStroke&&(a.lineWidth=e._nativeStroke,e._nativeStrokeColor?a.strokeStyle=e._nativeStrokeColor:a.strokeStyle=e._colorOverlay),i=0;i<n.length;i++)(o=a.measureText(n[i]).width)>r&&(r=o);return r}return-1},render:function(t,e){if(e._nativeFont&&e._renderText){var i,o,n,r,s=e._renderText,a=[];for(t.font=e._nativeFont,e._colorOverlay&&(t.fillStyle=e._colorOverlay),0===e._textAlignX&&(t.textAlign="left",t.translate(-e._bounds2d.x2,0)),1===e._textAlignX&&(t.textAlign="center"),2===e._textAlignX&&(t.textAlign="right",t.translate(e._bounds2d.x2,0)),e._nativeStroke&&(t.lineWidth=e._nativeStroke,e._nativeStrokeColor?t.strokeStyle=e._nativeStrokeColor:t.strokeStyle=e._colorOverlay),s.indexOf("\n")>-1?a=s.split("\n"):a.push(s),0===e._textAlignY&&(t.textBaseline="top",i=-e._bounds2d.y/2),1===e._textAlignY&&(t.textBaseline="middle",i=-e._textLineSpacing/2*(a.length-1)),2===e._textAlignY&&(t.textBaseline="bottom",i=e._bounds2d.y/2-e._textLineSpacing*(a.length-1)),3===e._textAlignY&&(t.textBaseline="middle",n=Math.floor(e._bounds2d.y/a.length),i=-(n+e._textLineSpacing)/2*(a.length-1)),r=0;r<a.length;r++)o=3===e._textAlignY?i+n*r+e._textLineSpacing*r:i+e._textLineSpacing*r,t.measureText(a[r]),e._nativeStroke&&t.strokeText(a[r],0,o),t.fillText(a[r],0,o)}}},IgeObject=IgeEventingClass.extend({classId:"IgeObject",init:function(){this._newBorn=!0,this._alive=!0,this._mode=0,this._mountMode=0,this._parent=null,this._children=[],this._layer=0,this._depth=0,this._depthSortMode=0,this._timeStream=[],this._inView=!0,this._managed=1,this._specialProp=["_id","_parent","_children"]},alive:function(t){return void 0!==t?(this._alive=t,this):this._alive},managed:function(t){return void 0!==t?(this._managed=t,this):this._managed},id:function(t){if(void 0!==t){if(t===this._id)return this;if(!ige._register[t])return this._id&&ige._register[this._id]&&ige.unRegister(this),this._id=t,ige.register(this),this;ige._register[t]!==this&&this.log('Cannot set ID of object to "'+t+'" because that ID is already in use by another object!',"error")}return this._id||(this._id=ige.newIdHex(),ige.register(this)),this._id},category:function(t){return void 0!==t?(this._category&&this._category!==t&&ige.categoryUnRegister(this),this._category=t,t&&ige.categoryRegister(this),this):this._category},group:function(){this.log("The group() method has been renamed to category(). Please update your code.","error")},addGroup:function(){for(var t,e,i=arguments.length;i--;)if((t=arguments[i])instanceof Array)for(e=t.length;e--;)this._groups&&-1!==this._groups.indexOf(t[e])||(this._groups=this._groups||[],this._groups.push(t[e]),ige.groupRegister(this,t[e]));else this._groups&&-1!==this._groups.indexOf(t)||(this._groups=this._groups||[],this._groups.push(t),ige.groupRegister(this,t));return this},inGroup:function(t,e){return!!t&&(e?this.inAllGroups(t):this.inAnyGroup(t))},inAllGroups:function(t){var e,i;if(!(t instanceof Array))return!(!this._groups||-1===this._groups.indexOf(t));for(i=t.length;i--;)if((e=t[i])&&(!this._groups||-1===this._groups.indexOf(e)))return!1;return!0},inAnyGroup:function(t){var e,i;if(!(t instanceof Array))return this._groups&&this._groups.indexOf(t)>-1;for(i=t.length;i--;)if((e=t[i])&&this._groups&&this._groups.indexOf(e)>-1)return!0;return!1},groups:function(){return this._groups||[]},groupCount:function(){return this._groups?this._groups.length:0},removeGroup:function(){if(this._groups)for(var t,e,i=arguments.length;i--;)if((t=arguments[i])instanceof Array)for(e=t.length;e--;)this._groups.pull(t[e]),ige.groupUnRegister(this,t[e]);else this._groups.pull(t),ige.groupUnRegister(this,t);return this},removeAllGroups:function(){if(this._groups){for(var t=this._groups,e=t.length;e--;)ige.groupUnRegister(this,t[e]);delete this._groups}return this},addBehaviour:function(t,e,i){if("string"==typeof t){if("function"==typeof e)return i?(this._tickBehaviours=this._tickBehaviours||[],this._tickBehaviours.push({id:t,method:e})):(this._updateBehaviours=this._updateBehaviours||[],this._updateBehaviours.push({id:t,method:e})),this;this.log("The behaviour you passed is not a function! The second parameter of the call must be a function!","error")}else this.log("Cannot add behaviour to object because the specified behaviour id is not a string. You must provide two parameters with the addBehaviour() call, an id:String and a behaviour:Function. Adding a behaviour with an id allows you to remove it by it's id at a later stage!","error");return!1},removeBehaviour:function(t,e){if(void 0!==t){var i,o;if(i=e?this._tickBehaviours:this._updateBehaviours)for(o=i.length;o--;)if(i[o].id===t)return i.splice(o,1),this}return!1},hasBehaviour:function(t,e){if(void 0!==t){var i,o;if(i=e?this._tickBehaviours:this._updateBehaviours)for(o=i.length;o--;)if(i[o].id===t)return!0}return!1},drawBounds:function(t){return void 0!==t?(this._drawBounds=t,this):this._drawBounds},drawBoundsData:function(t){return void 0!==t?(this._drawBoundsData=t,this):this._drawBoundsData},drawMouse:function(t){return void 0!==t?(this._drawMouse=t,this):this._drawMouse},drawMouseData:function(t){return void 0!==t?(this._drawMouseData=t,this):this._drawMouseData},$:function(t){var e=ige.$(t);return e._parent===this?e:e.parent(this.id())?e:void 0},$$:function(t){for(var e,i=ige.$$(t),o=i.length,n=[],r=this.id();o--;)e=i[o],(e._parent===this||e.parent(r))&&n.push(e);return n},parent:function(t){return t?this._parent?this._parent.id()===t?this._parent:this._parent.parent(t):void 0:this._parent},children:function(){return this._children},mount:function(t){if(t){if(t===this)return this.log("Cannot mount an object to itself!","error"),this;if(t._children){if(this.id(),this._parent){if(this._parent===t)return this;this.unMount()}return this._parent=t,!this._ignoreCamera&&this._parent._ignoreCamera&&(this._ignoreCamera=this._parent._ignoreCamera),this._parent._streamRoomId&&(this._streamRoomId=this._parent._streamRoomId),t._children.push(this),this._parent._childMounted(this),t.updateTransform&&(t.updateTransform(),t.aabb(!0)),t._compositeCache?this._compositeParent=!0:delete this._compositeParent,this._mounted(this._parent),this.emit("mounted",this._parent),this}return this.log("Cannot mount object because it has no _children array! If you are mounting to a custom class, ensure that you have called the prototype.init() method of your super-class during the init of your custom class.","warning"),!1}this.log("Cannot mount non-existent object!","error")},unMount:function(){if(this._parent){var t=this._parent._children,e=t.indexOf(this),i=this._parent;return e>-1&&(t.splice(e,1),this._parent._childUnMounted(this),this._parent=null,this._unMounted(i),this)}return!1},hasParent:function(t,e){var i=!1;return!e&&this._hasParent&&void 0!==this._hasParent[t]?this._hasParent[t]:(this._parent&&(i=this._parent.id()===t||this._parent.hasParent(t,e)),this._hasParent=this._hasParent||{},this._hasParent[t]=i,i)},clone:function(options){void 0===options&&(options={}),void 0===options.id&&(options.id=!1),void 0===options.mount&&(options.mount=!1),void 0===options.transform&&(options.transform=!0);var newObject=eval(this.stringify(options));return newObject},mode:function(t){return void 0!==t?(this._mode=t,this):this._mode},isometric:function(t){return!0===t?(this._mode=1,this):!1===t?(this._mode=0,this):1===this._mode},isometricMounts:function(t){return!0===t?(this._mountMode=1,this):!1===t?(this._mountMode=0,this):1===this._mountMode},indestructible:function(t){return void 0!==t?(this._indestructible=t,this):this._indestructible},layer:function(t){return void 0!==t?(this._layer=t,this):this._layer},depth:function(t){return void 0!==t?(this._depth=t,this):this._depth},destroyChildren:function(){var t,e=this._children;if(e)for(t=e.length;t--;)e[t].destroy();return this._children=[],this},destroyBehaviours:function(){delete this._updateBehaviours,delete this._tickBehaviours},destroyComponents:function(){var t,e=this._components;if(e)for(t=e.length;t--;)e[t].destroy&&e[t].destroy();return delete this._components,this},depthSortMode:function(t){return void 0!==t?(this._depthSortMode=t,this):this._depthSortMode},depthSortChildren:function(){if(-1!==this._depthSortMode){var t,e,i,o,n=this._children;if(n&&(t=n.length)>1)if(1===this._mountMode){if(0===this._depthSortMode){for(e={adj:[],c:[],p:[],order:[],order_ind:t-1},i=0;i<t;++i)for(e.c[i]=0,e.p[i]=-1,o=i+1;o<t;++o)e.adj[i]=e.adj[i]||[],e.adj[o]=e.adj[o]||[],n[i]._inView&&n[o]._inView&&n[i]._projectionOverlap&&n[o]._projectionOverlap&&n[i]._projectionOverlap(n[o])&&(n[i].isBehind(n[o])?e.adj[o].push(i):e.adj[i].push(o));for(i=0;i<t;++i)0===e.c[i]&&this._depthSortVisit(i,e);for(i=0;i<e.order.length;i++)n[e.order[i]].depth(i);this._children.sort(function(t,e){var i=e._layer-t._layer;return 0===i?e._depth-t._depth:i})}if(1===this._depthSortMode&&this._children.sort(function(t,e){var i=e._layer-t._layer;return 0===i?t.isBehind(e)?-1:1:i}),2===this._depthSortMode){for(;t--;)e=n[t],(o=e._translate)&&(e._depth=o.x+o.y+o.z);this._children.sort(function(t,e){var i=e._layer-t._layer;return 0===i?e._depth-t._depth:i})}}else this._children.sort(function(t,e){var i=e._layer-t._layer;return 0===i?e._depth-t._depth:i})}},viewChecking:function(t){return void 0!==t?(this._viewChecking=t,this):this._viewChecking},viewCheckChildren:function(){if(ige._currentViewport)for(var t,e=this._children,i=e.length,o=ige._currentViewport.viewArea();i--;)t=e[i],t._alwaysInView?t._inView=!0:t.aabb&&o.intersects(t.aabb(!0))?t._inView=!0:t._inView=!1;return this},update:function(t,e){if(this._alive){this._newBorn&&(this._newBorn=!1);var i,o,n,r=this._children;if(r)if(i=r.length,i&&!ige._headless&&(igeConfig.debug._timing?(ige._timeSpentLastTick[this.id()]||(ige._timeSpentLastTick[this.id()]={}),o=(new Date).getTime(),this.depthSortChildren(),n=(new Date).getTime()-o,ige._timeSpentLastTick[this.id()].depthSortChildren=n):this.depthSortChildren()),igeConfig.debug._timing)for(;i--;)o=(new Date).getTime(),r[i].update(t,e),n=(new Date).getTime()-o,r[i]&&(ige._timeSpentInTick[r[i].id()]||(ige._timeSpentInTick[r[i].id()]=0),ige._timeSpentLastTick[r[i].id()]||(ige._timeSpentLastTick[r[i].id()]={}),ige._timeSpentInTick[r[i].id()]+=n,ige._timeSpentLastTick[r[i].id()].tick=n);else for(;i--;)r[i].update(t,e)}},tick:function(t){if(this._alive){var e,i,o,n=this._children;if(this._viewChecking&&this.viewCheckChildren(),n)if(e=n.length,igeConfig.debug._timing)for(;e--;)n[e]?n[e]._newBorn||(t.save(),i=(new Date).getTime(),n[e].tick(t),o=(new Date).getTime()-i,n[e]&&(ige._timeSpentInTick[n[e].id()]||(ige._timeSpentInTick[n[e].id()]=0),ige._timeSpentLastTick[n[e].id()]||(ige._timeSpentLastTick[n[e].id()]={}),ige._timeSpentInTick[n[e].id()]+=o,ige._timeSpentLastTick[n[e].id()].tick=o),t.restore()):this.log("Object _children is undefined for index "+e+" and _id: "+this._id,"error");else for(;e--;)n[e]?n[e]._newBorn||(t.save(),n[e].tick(t),t.restore()):this.log("Object _children is undefined for index "+e+" and _id: "+this._id,"error")}},_depthSortVisit:function(t,e){var i,o,n=e.adj[t],r=n.length;for(e.c[t]=1,i=0;i<r;++i)o=n[i],0===e.c[o]&&(e.p[o]=t,this._depthSortVisit(o,e));e.c[t]=2,e.order[e.order_ind]=t,--e.order_ind},_resizeEvent:function(t){var e,i=this._children;if(i)for(e=i.length;e--;)i[e]._resizeEvent(t)},_processUpdateBehaviours:function(t,e){var i,o=this._updateBehaviours;if(o)for(i=o.length;i--;)o[i].method.apply(this,arguments)},_processTickBehaviours:function(t){var e,i=this._tickBehaviours;if(i)for(e=i.length;e--;)i[e].method.apply(this,arguments)},_childMounted:function(t){this._resizeEvent(null)},_childUnMounted:function(t){},_mounted:function(t){},_unMounted:function(t){},destroy:function(){return this.unMount(),this._children&&this.destroyChildren(),this.destroyComponents(),this.destroyBehaviours(),ige.unRegister(this),ige.categoryUnRegister(this),ige.groupUnRegister(this),this._alive=!1,delete this._eventListeners,this},objSave:function(){return{igeClass:this.classId(),data:this._objSaveReassign(this,[])}},objLoad:function(t){this._objLoadReassign(this,t.data)},saveSpecialProp:function(t,e){switch(e){case"_id":if(t._id)return{_id:t._id};break;case"_parent":if(t._parent)return{_parent:t._parent.id()};break;case"_children":if(t._children.length){var i,o,n=[];for(i=0;i<t._children.length;i++)o=t._children[i],n.push(o.objSave());return{_children:n}}}},loadSpecialProp:function(t,e){switch(e){case"_id":return{_id:t[e]};case"_parent":return{_parent:t[e]};case"_children":return{_children:t[e]}}},loadGraph:function(t){if(t.igeClass&&t.data){var e,i,o,n=ige.newClassInstance(t.igeClass);if(n.objLoad(t),n._parent&&(n._parent,delete n._parent),n._id&&(e=n._id,delete n._id,n.id(e)),n._children&&n._children.length)for(i=n._children,n._children=[],o=0;o<i.length;o++)n.loadGraph(i[o]);n.mount(this)}},_objSaveReassign:function(t,e){var i,o,n,r,s,a=this._specialProp;if("object"!=typeof t||t instanceof Array)return t;i={};for(s in t)if(t.hasOwnProperty(s))if("object"==typeof t[s]){if(-1===a.indexOf(s))o=e.indexOf(t[s]),o>-1?(i[s]="{ref:"+o+"}",this.log("Possible circular reference for property "+s)):(e.push(t[s]),i[s]=this._objSaveReassign(t[s],e));else if(n=this.saveSpecialProp(t,s))if("object"!=typeof n||n instanceof Array)i[s]=n;else for(r in n)n.hasOwnProperty(r)&&(i[r]=n[r])}else i[s]=t[s];return i},_objLoadReassign:function(t,e){var i,o,n,r=this._specialProp;for(n in e)if(e.hasOwnProperty(n))if(-1===r.indexOf(n))"object"==typeof e[n]&&t[n]?this._objLoadReassign(t[n],e[n]):t[n]=e[n];else if(i=this.loadSpecialProp(e,n))if("object"!=typeof i||i instanceof Array)t[n]=i;else for(o in i)i.hasOwnProperty(o)&&(t[o]=i[o])},stringify:function(t){void 0===t&&(t={});var e="new "+this.classId()+"()";return!1!==t.id&&(e+=".id('"+this.id()+"')"),!1!==t.mount&&this.parent()&&(e+=".mount(ige.$('"+this.parent().id()+"'))"),e+=this._stringify(t)},_stringify:function(t){void 0===t&&(t={});var e,i="";for(e in this)if(this.hasOwnProperty(e)&&void 0!==this[e])switch(e){case"_category":i+=".category("+this.category()+")";break;case"_drawBounds":i+=".drawBounds("+this.drawBounds()+")";break;case"_drawBoundsData":i+=".drawBoundsData("+this.drawBoundsData()+")";break;case"_drawMouse":i+=".drawMouse("+this.drawMouse()+")";break;case"_mode":i+=".mode("+this.mode()+")";break;case"_isometricMounts":i+=".isometricMounts("+this.isometricMounts()+")";break;case"_indestructible":i+=".indestructible("+this.indestructible()+")";break;case"_layer":i+=".layer("+this.layer()+")";break;case"_depth":i+=".depth("+this.depth()+")"}return i}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeObject);var IgeEntity=IgeObject.extend({classId:"IgeEntity",init:function(){IgeObject.prototype.init.call(this),this._specialProp.push("_texture"),this._specialProp.push("_eventListeners"),this._specialProp.push("_aabb"),this._anchor=new IgePoint2d(0,0),this._renderPos={x:0,y:0},this._computedOpacity=1,this._opacity=1,this._cell=1,this._deathTime=void 0,this._bornTime=ige._currentTime,this._translate=new IgePoint3d(0,0,0),this._oldTranslate=new IgePoint3d(0,0,0),this._rotate=new IgePoint3d(0,0,0),this._scale=new IgePoint3d(1,1,1),this._origin=new IgePoint3d(.5,.5,.5),this._bounds2d=new IgePoint2d(40,40),this._bounds3d=new IgePoint3d(0,0,0),this._oldBounds2d=new IgePoint2d(40,40),this._oldBounds3d=new IgePoint3d(0,0,0),this._highlight=!1,this._mouseEventsActive=!1,this._velocity=new IgePoint3d(0,0,0),this._localMatrix=new IgeMatrix2d,this._worldMatrix=new IgeMatrix2d,this._oldWorldMatrix=new IgeMatrix2d,this._inView=!0,this._hidden=!1,"undefined"!=typeof module&&void 0!==module.exports&&this.streamFloatPrecision(2),this.streamSections(["transform"])},show:function(){return this._hidden=!1,this},hide:function(){return this._hidden=!0,this},isVisible:function(){return!1===this._hidden},isHidden:function(){return!0===this._hidden},cache:function(t){if(void 0!==t){if(this._cache=t,t){ige.isClient?this._cacheCanvas=document.createElement("canvas"):this._cacheCanvas=new IgeDummyCanvas,this._cacheCtx=this._cacheCanvas.getContext("2d"),this._cacheDirty=!0;(void 0!==this._cacheSmoothing?this._cacheSmoothing:ige._globalSmoothing)?(this._cacheCtx.imageSmoothingEnabled=!0,this._cacheCtx.mozImageSmoothingEnabled=!0):(this._cacheCtx.imageSmoothingEnabled=!1,this._cacheCtx.mozImageSmoothingEnabled=!1),this.compositeCache()&&this.compositeCache(!1)}else delete this._cacheCanvas;return this}return this._cache},cacheSmoothing:function(t){return void 0!==t?(this._cacheSmoothing=t,this):this._cacheSmoothing},compositeCache:function(t){if(ige.isClient){if(void 0!==t){if(t){this.cache(!1),this._cacheCanvas=document.createElement("canvas"),this._cacheCtx=this._cacheCanvas.getContext("2d"),this._cacheDirty=!0;(void 0!==this._cacheSmoothing?this._cacheSmoothing:ige._globalSmoothing)?(this._cacheCtx.imageSmoothingEnabled=!0,this._cacheCtx.mozImageSmoothingEnabled=!0):(this._cacheCtx.imageSmoothingEnabled=!1,this._cacheCtx.mozImageSmoothingEnabled=!1)}return this._children.each(function(){t?this._compositeParent=!0:delete this._compositeParent}),this._compositeCache=t,this}return this._compositeCache}return this},cacheDirty:function(t){return void 0!==t?(this._cacheDirty=t,t&&this._compositeParent&&this._parent&&(this._parent.cacheDirty(t),this._cache||this._compositeCache||(this._cacheDirty=!1)),this):this._cacheDirty},mousePos:function(t){if(t=t||ige._currentViewport){var e=t._mousePos.clone();return this._ignoreCamera,e.x+=t._translate.x,e.y+=t._translate.y,this._transformPoint(e),e}return new IgePoint3d(0,0,0)},mousePosAbsolute:function(t){if(t=t||ige._currentViewport){var e=t._mousePos.clone();return this._transformPoint(e),e}return new IgePoint3d(0,0,0)},mousePosWorld:function(t){t=t||ige._currentViewport;var e=this.mousePos(t);return this.localToWorldPoint(e,t),this._ignoreCamera,e},rotateToPoint:function(t){var e=this.worldPosition();return this.rotateTo(this._rotate.x,this._rotate.y,Math.atan2(e.y-t.y,e.x-t.x)-this._parent._rotate.z+Math.radians(270)),this},backgroundPattern:function(t,e,i,o){return void 0!==t?(this._backgroundPattern=t,this._backgroundPatternRepeat=e||"repeat",this._backgroundPatternTrackCamera=i,this._backgroundPatternIsoTile=o,this._backgroundPatternFill=null,this):this._backgroundPattern},widthByTile:function(t,e){if(this._parent&&void 0!==this._parent._tileWidth&&void 0!==this._parent._tileHeight){var i,o=0===this._mode?this._parent._tileWidth:2*this._parent._tileWidth;this.width(t*o),e&&(this._texture?(i=this._texture._sizeX/this._bounds2d.x,this.height(this._texture._sizeY/i)):this.log("Cannot set height based on texture aspect ratio and new width because no texture is currently assigned to the entity!","error"))}else this.log("Cannot set width by tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},heightByTile:function(t,e){if(this._parent&&void 0!==this._parent._tileWidth&&void 0!==this._parent._tileHeight){var i,o=0===this._mode?this._parent._tileHeight:2*this._parent._tileHeight;this.height(t*o),e&&(this._texture?(i=this._texture._sizeY/this._bounds2d.y,this.width(this._texture._sizeX/i)):this.log("Cannot set width based on texture aspect ratio and new height because no texture is currently assigned to the entity!","error"))}else this.log("Cannot set height by tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},occupyTile:function(t,e,i,o){if(this._parent&&this._parent.IgeTileMap2d)if(void 0!==t&&void 0!==e)this._parent.occupyTile(t,e,i,o,this);else{var n=new IgePoint3d(this._translate.x-(this._tileWidth/2-.5)*this._parent._tileWidth,this._translate.y-(this._tileHeight/2-.5)*this._parent._tileHeight,0),r=this._parent.pointToTile(n);1===this._parent._mountMode&&r.thisToIso(),this._parent.occupyTile(r.x,r.y,this._tileWidth,this._tileHeight,this)}return this},unOccupyTile:function(t,e,i,o){if(this._parent&&this._parent.IgeTileMap2d)if(void 0!==t&&void 0!==e)this._parent.unOccupyTile(t,e,i,o);else{var n=new IgePoint3d(this._translate.x-(this._tileWidth/2-.5)*this._parent._tileWidth,this._translate.y-(this._tileHeight/2-.5)*this._parent._tileHeight,0),r=this._parent.pointToTile(n);1===this._parent._mountMode&&r.thisToIso(),this._parent.unOccupyTile(r.x,r.y,this._tileWidth,this._tileHeight)}return this},overTiles:function(){if(this._parent&&this._parent.IgeTileMap2d){var t,e,i=this._tileWidth||1,o=this._tileHeight||1,n=this._parent.pointToTile(this._translate),r=[];for(t=0;t<i;t++)for(e=0;e<o;e++)r.push(new IgePoint3d(n.x+t,n.y+e,0));return r}},anchor:function(t,e){return void 0!==t&&void 0!==e?(this._anchor=new IgePoint2d(t,e),this):this._anchor},width:function(t,e){if(void 0!==t){if(e){var i=t/this._bounds2d.x;this.height(this._bounds2d.y*i)}return this._bounds2d.x=t,this._bounds2d.x2=t/2,this}return this._bounds2d.x},height:function(t,e){if(void 0!==t){if(e){var i=t/this._bounds2d.y;this.width(this._bounds2d.x*i)}return this._bounds2d.y=t,this._bounds2d.y2=t/2,this}return this._bounds2d.y},bounds2d:function(t,e){return void 0!==t&&void 0!==e?(this._bounds2d=new IgePoint2d(t,e,0),this):(void 0!==t&&void 0===e&&(this._bounds2d=new IgePoint2d(t.x,t.y)),this._bounds2d)},bounds3d:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._bounds3d=new IgePoint3d(t,e,i),this):this._bounds3d},size3d:function(t,e,i){this.log("size3d has been renamed to bounds3d but is exactly the same so please search/replace your code to update calls.","warning")},lifeSpan:function(t,e){return void 0!==t?(this.deathTime(ige._currentTime+t,e),this):this.deathTime()-ige._currentTime},deathTime:function(t,e){return void 0!==t?(this._deathTime=t,void 0!==e&&(this._deathCallBack=e),this):this._deathTime},opacity:function(t){return void 0!==t?(this._opacity=t,this):this._opacity},noAabb:function(t){return void 0!==t?(this._noAabb=t,
this):this._noAabb},texture:function(t){return void 0!==t?(this._texture=t,this):this._texture},cell:function(t){return t>0||null===t?(this._cell=t,this):this._cell},cellById:function(t){if(void 0!==t)if(this._texture){var e,i=this._texture,o=i._cells;for(e=1;e<o.length;e++)if(o[e][4]===t)return this.cell(e),this;this.log('Could not find the cell id "'+t+'" in the assigned entity texture '+i.id()+', please check your sprite sheet (texture) cell definition to ensure the cell id "'+t+'" has been assigned to a cell!',"error")}else this.log("Cannot assign cell index from cell ID until an IgeSpriteSheet has been set as the texture for this entity. Please set the texture before calling cellById().","error");return this._cell},dimensionsFromTexture:function(t){return this._texture&&(void 0===t?(this.width(this._texture._sizeX),this.height(this._texture._sizeY)):(this.width(Math.floor(this._texture._sizeX/100*t)),this.height(Math.floor(this._texture._sizeY/100*t))),this.localAabb(!0)),this},dimensionsFromCell:function(t){return this._texture&&this._texture._cells&&this._texture._cells.length&&(void 0===t?(this.width(this._texture._cells[this._cell][2]),this.height(this._texture._cells[this._cell][3])):(this.width(Math.floor(this._texture._cells[this._cell][2]/100*t)),this.height(Math.floor(this._texture._cells[this._cell][3]/100*t))),this.localAabb(!0)),this},highlight:function(t){return void 0!==t?(this._highlight=t,this):this._highlight},worldPosition:function(){return new IgePoint3d(this._worldMatrix.matrix[2],this._worldMatrix.matrix[5],0)},worldRotationZ:function(){return this._worldMatrix.rotationRadians()},localToWorld:function(t,e,i){e=e||ige._currentViewport,this._adjustmentMatrix&&this._worldMatrix.multiply(this._adjustmentMatrix),i?this._localMatrix.transform(t,this):this._worldMatrix.transform(t,this),this._ignoreCamera},localToWorldPoint:function(t,e){e=e||ige._currentViewport,this._worldMatrix.transform([t],this)},screenPosition:function(){return new IgePoint3d(Math.floor((this._worldMatrix.matrix[2]-ige._currentCamera._translate.x)*ige._currentCamera._scale.x+ige._bounds2d.x2),Math.floor((this._worldMatrix.matrix[5]-ige._currentCamera._translate.y)*ige._currentCamera._scale.y+ige._bounds2d.y2),0)},localIsoBoundsPoly:function(){},localBounds3dPolygon:function(t){if(this._bounds3dPolygonDirty||!this._localBounds3dPolygon||t){var e=this._bounds3d,i=new IgePoly2d,o=Math.toIso(+e.x2,-e.y2,-e.z2),n=Math.toIso(+e.x2,+e.y2,-e.z2),r=Math.toIso(-e.x2,+e.y2,-e.z2),s=Math.toIso(-e.x2,-e.y2,e.z2),a=Math.toIso(+e.x2,-e.y2,e.z2),h=Math.toIso(-e.x2,+e.y2,e.z2);i.addPoint(s.x,s.y).addPoint(a.x,a.y).addPoint(o.x,o.y).addPoint(n.x,n.y).addPoint(r.x,r.y).addPoint(h.x,h.y).addPoint(s.x,s.y),this._localBounds3dPolygon=i,this._bounds3dPolygonDirty=!1}return this._localBounds3dPolygon},isoBoundsPoly:function(){},bounds3dPolygon:function(t){if(this._bounds3dPolygonDirty||!this._bounds3dPolygon||t){var e=this.localBounds3dPolygon(t).clone();this.localToWorld(e._poly),this._bounds3dPolygon=e}return this._bounds3dPolygon},mouseInIsoBounds:function(){},mouseInBounds3d:function(t){var e=this.localBounds3dPolygon(t),i=this.mousePos();return e.pointInside(i)},aabb:function(t,e){if(this._aabbDirty||!this._aabb||t){var i,o,n,r,s,a,h,l,c,u,m=new IgePoly2d,d=this._anchor,p=d.x,_=d.y;a=this._bounds2d,h=a.x2,l=a.y2,c=h,u=l,m.addPoint(-c+p,-u+_),m.addPoint(c+p,-u+_),m.addPoint(c+p,u+_),m.addPoint(-c+p,u+_),this._renderPos={x:-c+p,y:-u+_},this.localToWorld(m._poly,null,e),i=Math.min(m._poly[0].x,m._poly[1].x,m._poly[2].x,m._poly[3].x),o=Math.min(m._poly[0].y,m._poly[1].y,m._poly[2].y,m._poly[3].y),n=Math.max(m._poly[0].x,m._poly[1].x,m._poly[2].x,m._poly[3].x),r=Math.max(m._poly[0].y,m._poly[1].y,m._poly[2].y,m._poly[3].y),s=new IgeRect(i,o,n-i,r-o),this._aabb=s,this._aabbDirty=!1}return this._aabb},localAabb:function(t){if(!this._localAabb||t){var e=this.aabb();this._localAabb=new IgeRect(-Math.floor(e.width/2),-Math.floor(e.height/2),Math.floor(e.width),Math.floor(e.height))}return this._localAabb},compositeAabb:function(t){var e,i,o=this._children;if(i=t?this.aabb(!0,t).clone():this.aabb().clone(),o)for(e=o.length;e--;)i.thisCombineRect(o[e].compositeAabb(t));return i},compositeStream:function(t){return void 0!==t?(this._compositeStream=t,this):this._compositeStream},_childMounted:function(t){this.compositeStream()&&(t.compositeStream(!0),t.streamMode(this.streamMode()),t.streamControl(this.streamControl())),IgeObject.prototype._childMounted.call(this,t),this.compositeCache()&&this.cacheDirty(!0)},_swapVars:function(t,e){return[e,t]},_internalsOverlap:function(t,e,i,o){var n;return t>e&&(n=this._swapVars(t,e),t=n[0],e=n[1]),i>o&&(n=this._swapVars(i,o),i=n[0],o=n[1]),t>i&&(n=this._swapVars(t,i),t=n[0],i=n[1],n=this._swapVars(e,o),e=n[0],o=n[1]),i<e},_projectionOverlap:function(t){var e=this._bounds3d,i={x:this._translate.x-e.x/2,y:this._translate.y-e.y/2,z:this._translate.z-e.z},o={x:this._translate.x+e.x/2,y:this._translate.y+e.y/2,z:this._translate.z+e.z},n=t._bounds3d,r={x:t._translate.x-n.x/2,y:t._translate.y-n.y/2,z:t._translate.z-n.z},s={x:t._translate.x+n.x/2,y:t._translate.y+n.y/2,z:t._translate.z+n.z};return this._internalsOverlap(i.x-o.y,o.x-i.y,r.x-s.y,s.x-r.y)&&this._internalsOverlap(i.x-o.z,o.x-i.z,r.x-s.z,s.x-r.z)&&this._internalsOverlap(i.z-o.y,o.z-i.y,r.z-s.y,s.z-r.y)},isBehind:function(t){var e=this._bounds3d,i=t._bounds3d,o=this._translate.clone(),n=t._translate.clone();.5===this._origin.x&&.5===this._origin.y||(o.x+=this._bounds2d.x*(.5-this._origin.x),o.y+=this._bounds2d.y*(.5-this._origin.y)),.5===t._origin.x&&.5===t._origin.y||(n.x+=t._bounds2d.x*(.5-t._origin.x),n.y+=t._bounds2d.y*(.5-t._origin.y));var r=o.x,s=o.y,a=n.x,h=n.y,l=new IgePoint3d(r-e.x/2,s-e.y/2,this._translate.z),c=new IgePoint3d(r+e.x/2,s+e.y/2,this._translate.z+e.z),u=new IgePoint3d(a-i.x/2,h-i.y/2,t._translate.z),m=new IgePoint3d(a+i.x/2,h+i.y/2,t._translate.z+i.z);return!(c.x<=u.x)&&(m.x<=l.x||!(c.y<=u.y)&&(m.y<=l.y||!(c.z<=u.z)&&(m.z<=l.z||r+s+this._translate.z>a+h+t._translate.z)))},mouseEventsActive:function(t){return void 0!==t?(this._mouseEventsActive=t,this):this._mouseEventsActive},ignoreCameraComposite:function(t){var e,i=this._children,o=i.length;for(this._ignoreCamera=t,e=0;e<o;e++)i[e].ignoreCameraComposite&&i[e].ignoreCameraComposite(t)},newFrame:function(){return ige._frameAlternator!==this._frameAlternatorCurrent},_transformContext:function(t,e){this._parent?t.globalAlpha=this._computedOpacity=this._parent._computedOpacity*this._opacity:t.globalAlpha=this._computedOpacity=this._opacity,e?this._localMatrix.getInverse().transformRenderingContext(t):this._localMatrix.transformRenderingContext(t)},mouseAlwaysInside:function(t){return void 0!==t?(this._mouseAlwaysInside=t,this):this._mouseAlwaysInside},update:function(t,e){void 0!==this._deathTime&&this._deathTime<=ige._tickStart?(this._deathCallBack&&(this._deathCallBack.apply(this),delete this._deathCallback),this.destroy()):void 0===this._bornTime||ige._currentTime>=this._bornTime?(delete this._streamDataCache,this._processUpdateBehaviours(t,e),(this._velocity.x||this._velocity.y)&&(this._translate.x+=this._velocity.x/16*e,this._translate.y+=this._velocity.y/16*e),this._timeStream.length&&this._processInterpolate(ige._tickStart-ige.network.stream._renderLatency),this.updateTransform(),!this._noAabb&&this._aabbDirty&&this.aabb(),this._oldTranslate=this._translate.clone(),this._frameAlternatorCurrent=ige._frameAlternator):(this._birthMount=this._parent.id(),this.unMount(),ige.spawnQueue(this)),IgeObject.prototype.update.call(this,t,e)},tick:function(t,e){this._hidden||!this._inView||this._parent&&!this._parent._inView||this._streamJustCreated||(this._processTickBehaviours(t),this._mouseEventsActive&&(this._processTriggerHitTests()?ige.input.queueEvent(this,this._mouseInTrigger,null):ige.input.mouseMove&&this._handleMouseOut(ige.input.mouseMove)),this._dontRender||(this._cache||this._compositeCache?(this._cacheDirty&&this._refreshCache(e),this._renderCache(t)):(e||this._transformContext(t),this._renderEntity(t,e))),1===this._streamMode&&this.streamSync(),this._compositeCache?this._cacheDirty&&(IgeObject.prototype.tick.call(this,this._cacheCtx),this._renderCache(t),this._cacheDirty=!1):IgeObject.prototype.tick.call(this,t))},_processTriggerHitTests:function(){var t,e;if(ige._currentViewport){if(this._mouseAlwaysInside)return!0;if(t=this.mousePosWorld())return e=this._triggerPolygon&&this[this._triggerPolygon]?this[this._triggerPolygon](t):this._parent&&1===this._parent._mountMode?this.bounds3dPolygon():this.aabb(),e.xyInside(t.x,t.y)}return!1},_refreshCache:function(t){var e=this._cacheCanvas,i=this._cacheCtx;if(this._compositeCache){var o=this.compositeAabb(!0);this._compositeAabbCache=o,o.width>0&&o.height>0?(e.width=Math.ceil(o.width),e.height=Math.ceil(o.height)):(e.width=2,e.height=2),i.translate(-o.x,-o.y),this.emit("compositeReady")}else this._bounds2d.x>0&&this._bounds2d.y>0?(e.width=this._bounds2d.x,e.height=this._bounds2d.y):(e.width=1,e.height=1),i.translate(this._bounds2d.x2,this._bounds2d.y2),this._cacheDirty=!1;t||this._transformContext(i),this._renderEntity(i,t)},_renderEntity:function(t){if(this._opacity>0){this._backgroundPattern&&(this._backgroundPatternFill||t&&(this._backgroundPatternFill=t.createPattern(this._backgroundPattern.image,this._backgroundPatternRepeat)),this._backgroundPatternFill&&(t.save(),t.fillStyle=this._backgroundPatternFill,t.translate(-this._bounds2d.x2,-this._bounds2d.y2),t.rect(0,0,this._bounds2d.x,this._bounds2d.y),this._backgroundPatternTrackCamera&&(t.translate(-ige._currentCamera._translate.x,-ige._currentCamera._translate.y),t.scale(ige._currentCamera._scale.x,ige._currentCamera._scale.y)),t.fill(),ige._drawCount++,this._backgroundPatternIsoTile&&(t.translate(-Math.floor(this._backgroundPattern.image.width)/2,-Math.floor(this._backgroundPattern.image.height/2)),t.fill(),ige._drawCount++),t.restore()));var e=this._texture;e&&e._loaded&&(e.render(t,this,ige._tickDelta),this._highlight&&(t.globalCompositeOperation=this._highlightToGlobalCompositeOperation(this._highlight),e.render(t,this))),this._compositeCache&&ige._currentViewport._drawCompositeBounds&&(t.fillStyle="rgba(0, 0, 255, 0.3)",t.fillRect(-this._bounds2d.x2,-this._bounds2d.y2,this._bounds2d.x,this._bounds2d.y),t.fillStyle="#ffffff",t.fillText("Composite Entity",-this._bounds2d.x2,-this._bounds2d.y2-15),t.fillText(this.id(),-this._bounds2d.x2,-this._bounds2d.y2-5))}},_renderCache:function(t){if(t.save(),this._compositeCache){var e=this._compositeAabbCache;if(t.translate(this._bounds2d.x2+e.x,this._bounds2d.y2+e.y),this._parent&&this._parent._ignoreCamera){ige._currentCamera}}t.drawImage(this._cacheCanvas,-this._bounds2d.x2,-this._bounds2d.y2),ige._currentViewport._drawCompositeBounds&&(t.fillStyle="rgba(0, 255, 0, 0.5)",t.fillRect(-this._bounds2d.x2,-this._bounds2d.y2,this._cacheCanvas.width,this._cacheCanvas.height),t.fillStyle="#ffffff",t.fillText("Composite Cache",-this._bounds2d.x2,-this._bounds2d.y2-15),t.fillText(this.id(),-this._bounds2d.x2,-this._bounds2d.y2-5)),ige._drawCount++,this._highlight&&(t.globalCompositeOperation=this._highlightToGlobalCompositeOperation(this._highlight),t.drawImage(this._cacheCanvas,-this._bounds2d.x2,-this._bounds2d.y2),ige._drawCount++),t.restore()},_transformPoint:function(t){if(this._parent){var e=new IgeMatrix2d;e.copy(this._parent._worldMatrix),e.multiply(this._localMatrix),e.getInverse().transformCoord(t,this)}else this._localMatrix.transformCoord(t,this);return t},_transformPoints:function(t){for(var e,i=t.length;i--;)if(e=t[i],this._parent){var o=new IgeMatrix2d;o.copy(this._parent._worldMatrix),o.multiply(this._localMatrix),o.getInverse().transformCoord(e,this)}else this._localMatrix.transformCoord(e,this)},_stringify:function(t){void 0===t&&(t={});var e,i=IgeObject.prototype._stringify.call(this,t);for(e in this)if(this.hasOwnProperty(e)&&void 0!==this[e])switch(e){case"_opacity":i+=".opacity("+this.opacity()+")";break;case"_texture":i+=".texture(ige.$('"+this.texture().id()+"'))";break;case"_cell":i+=".cell("+this.cell()+")";break;case"_translate":!1!==t.transform&&!1!==t.translate&&(i+=".translateTo("+this._translate.x+", "+this._translate.y+", "+this._translate.z+")");break;case"_rotate":!1!==t.transform&&!1!==t.rotate&&(i+=".rotateTo("+this._rotate.x+", "+this._rotate.y+", "+this._rotate.z+")");break;case"_scale":!1!==t.transform&&!1!==t.scale&&(i+=".scaleTo("+this._scale.x+", "+this._scale.y+", "+this._scale.z+")");break;case"_origin":!1!==t.origin&&(i+=".originTo("+this._origin.x+", "+this._origin.y+", "+this._origin.z+")");break;case"_anchor":!1!==t.anchor&&(i+=".anchor("+this._anchor.x+", "+this._anchor.y+")");break;case"_width":"string"==typeof this.width()?i+=".width('"+this.width()+"')":i+=".width("+this.width()+")";break;case"_height":"string"==typeof this.height()?i+=".height('"+this.height()+"')":i+=".height("+this.height()+")";break;case"_bounds3d":i+=".bounds3d("+this._bounds3d.x+", "+this._bounds3d.y+", "+this._bounds3d.z+")";break;case"_deathTime":!1!==t.deathTime&&!1!==t.lifeSpan&&(i+=".deathTime("+this.deathTime()+")");break;case"_highlight":i+=".highlight("+this.highlight()+")"}return i},destroy:function(){this._alive=!1,1===this._streamMode&&(delete this._streamDataCache,this.streamDestroy()),this.emit("destroyed",this),IgeObject.prototype.destroy.call(this)},saveSpecialProp:function(t,e){switch(e){case"_texture":if(t._texture)return{_texture:t._texture.id()};break;default:return IgeObject.prototype.saveSpecialProp.call(this,t,e)}},loadSpecialProp:function(t,e){switch(e){case"_texture":return{_texture:ige.$(t[e])};default:return IgeObject.prototype.loadSpecialProp.call(this,t,e)}},mouseMove:function(t){return t?(this._mouseMove=t,this._mouseEventsActive=!0,this):this._mouseMove},mouseOver:function(t){return t?(this._mouseOver=t,this._mouseEventsActive=!0,this):this._mouseOver},mouseOut:function(t){return t?(this._mouseOut=t,this._mouseEventsActive=!0,this):this._mouseOut},mouseUp:function(t){return t?(this._mouseUp=t,this._mouseEventsActive=!0,this):this._mouseUp},mouseDown:function(t){return t?(this._mouseDown=t,this._mouseEventsActive=!0,this):this._mouseDown},mouseWheel:function(t){return t?(this._mouseWheel=t,this._mouseEventsActive=!0,this):this._mouseWheel},mouseMoveOff:function(){return delete this._mouseMove,this},mouseOverOff:function(){return delete this._mouseOver,this},mouseOutOff:function(){return delete this._mouseOut,this},mouseUpOff:function(){return delete this._mouseUp,this},mouseDownOff:function(){return delete this._mouseDown,this},mouseWheelOff:function(){return delete this._mouseWheel,this},triggerPolygon:function(t){return void 0!==t?(this._triggerPolygon=t,this):this._triggerPolygon},mouseEventTrigger:function(t){this.log("mouseEventTrigger is no longer in use. Please see triggerPolygon() instead.","warning")},_handleMouseIn:function(t,e,i){this._mouseStateOver||(this._mouseStateOver=!0,this._mouseOver&&this._mouseOver(t,e,i),this.emit("mouseOver",[t,e,i])),this._mouseMove&&this._mouseMove(t,e,i),this.emit("mouseMove",[t,e,i])},_handleMouseOut:function(t,e,i){this._mouseStateDown=!1,this._mouseStateOver&&(this._mouseStateOver=!1,this._mouseOut&&this._mouseOut(t,e,i),this.emit("mouseOut",[t,e,i]))},_handleMouseWheel:function(t,e,i){this._mouseWheel&&this._mouseWheel(t,e,i),this.emit("mouseWheel",[t,e,i])},_handleMouseUp:function(t,e,i){this._mouseStateDown=!1,this._mouseUp&&this._mouseUp(t,e,i),this.emit("mouseUp",[t,e,i])},_handleMouseDown:function(t,e,i){this._mouseStateDown||(this._mouseStateDown=!0,this._mouseDown&&this._mouseDown(t,e,i),this.emit("mouseDown",[t,e,i]))},_mouseInTrigger:function(t,e){ige.input.mouseMove&&this._handleMouseIn(ige.input.mouseMove,t,e),ige.input.mouseDown&&this._handleMouseDown(ige.input.mouseDown,t,e),ige.input.mouseUp&&this._handleMouseUp(ige.input.mouseUp,t,e),ige.input.mouseWheel&&this._handleMouseWheel(ige.input.mouseWheel,t,e)},debugTransforms:function(){return ige.traceSet(this._translate,"x",1,function(t){return isNaN(t)}),ige.traceSet(this._translate,"y",1,function(t){return isNaN(t)}),ige.traceSet(this._translate,"z",1,function(t){return isNaN(t)}),ige.traceSet(this._rotate,"x",1,function(t){return isNaN(t)}),ige.traceSet(this._rotate,"y",1,function(t){return isNaN(t)}),ige.traceSet(this._rotate,"z",1,function(t){return isNaN(t)}),ige.traceSet(this._scale,"x",1,function(t){return isNaN(t)}),ige.traceSet(this._scale,"y",1,function(t){return isNaN(t)}),ige.traceSet(this._scale,"z",1,function(t){return isNaN(t)}),this},velocityTo:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._velocity.x=t,this._velocity.y=e,this._velocity.z=i):this.log("velocityTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},velocityBy:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._velocity.x+=t,this._velocity.y+=e,this._velocity.z+=i):this.log("velocityBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},translateBy:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._translate.x+=t,this._translate.y+=e,this._translate.z+=i):this.log("translateBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},translateTo:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._translate.x=t,this._translate.y=e,this._translate.z=i):this.log("translateTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},translateToPoint:function(t){return void 0!==t?(this._translate.x=t.x,this._translate.y=t.y,this._translate.z=t.z):this.log("translateToPoint() called with a missing or undefined point parameter!","error"),this._entity||this},translateToTile:function(t,e,i){if(this._parent&&void 0!==this._parent._tileWidth&&void 0!==this._parent._tileHeight){var o;o=void 0!==i?i*this._parent._tileWidth:this._translate.z,this.translateTo(t*this._parent._tileWidth+this._parent._tileWidth/2,e*this._parent._tileHeight+this._parent._tileWidth/2,o)}else this.log("Cannot translate to tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},translate:function(){return arguments.length&&this.log("You called translate with arguments, did you mean translateTo or translateBy instead of translate?","warning"),this.x=this._translateAccessorX,this.y=this._translateAccessorY,this.z=this._translateAccessorZ,this._entity||this},_translateAccessorX:function(t){return void 0!==t?(this._translate.x=t,this._entity||this):this._translate.x},_translateAccessorY:function(t){return void 0!==t?(this._translate.y=t,this._entity||this):this._translate.y},_translateAccessorZ:function(t){return void 0!==t?(this._translate.z=t,this._entity||this):this._translate.z},rotateBy:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._rotate.x+=t,this._rotate.y+=e,this._rotate.z+=i):this.log("rotateBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},rotateTo:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._rotate.x=t,this._rotate.y=e,this._rotate.z=i):this.log("rotateTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},rotate:function(){return arguments.length&&this.log("You called rotate with arguments, did you mean rotateTo or rotateBy instead of rotate?","warning"),this.x=this._rotateAccessorX,this.y=this._rotateAccessorY,this.z=this._rotateAccessorZ,this._entity||this},_rotateAccessorX:function(t){return void 0!==t?(this._rotate.x=t,this._entity||this):this._rotate.x},_rotateAccessorY:function(t){return void 0!==t?(this._rotate.y=t,this._entity||this):this._rotate.y},_rotateAccessorZ:function(t){return void 0!==t?(this._rotate.z=t,this._entity||this):this._rotate.z},scaleBy:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._scale.x+=t,this._scale.y+=e,this._scale.z+=i):this.log("scaleBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},scaleTo:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._scale.x=t,this._scale.y=e,this._scale.z=i):this.log("scaleTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},scale:function(){return arguments.length&&this.log("You called scale with arguments, did you mean scaleTo or scaleBy instead of scale?","warning"),this.x=this._scaleAccessorX,this.y=this._scaleAccessorY,this.z=this._scaleAccessorZ,this._entity||this},_scaleAccessorX:function(t){return void 0!==t?(this._scale.x=t,this._entity||this):this._scale.x},_scaleAccessorY:function(t){return void 0!==t?(this._scale.y=t,this._entity||this):this._scale.y},_scaleAccessorZ:function(t){return void 0!==t?(this._scale.z=t,this._entity||this):this._scale.z},originBy:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._origin.x+=t,this._origin.y+=e,this._origin.z+=i):this.log("originBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},originTo:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._origin.x=t,this._origin.y=e,this._origin.z=i):this.log("originTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},origin:function(){return this.x=this._originAccessorX,this.y=this._originAccessorY,this.z=this._originAccessorZ,this._entity||this},_originAccessorX:function(t){return void 0!==t?(this._origin.x=t,this._entity||this):this._origin.x},_originAccessorY:function(t){return void 0!==t?(this._origin.y=t,this._entity||this):this._origin.y},_originAccessorZ:function(t){return void 0!==t?(this._origin.z=t,this._entity||this):this._origin.z},_rotatePoint:function(t,e,i){var o=Math.cos(e),n=Math.sin(e);return{x:i.x+(t.x-i.x)*o+(t.y-i.y)*n,y:i.y-(t.x-i.x)*n+(t.y-i.y)*o}},updateTransform:function(){if(this._localMatrix.identity(),0===this._mode&&this._localMatrix.multiply(this._localMatrix._newTranslate(this._translate.x,this._translate.y)),1===this._mode){var t=this._translateIso=new IgePoint3d(this._translate.x,this._translate.y,this._translate.z+this._bounds3d.z/2).toIso();this._parent&&this._parent._bounds3d.z&&(t.y+=this._parent._bounds3d.z/1.6),this._localMatrix.multiply(this._localMatrix._newTranslate(t.x,t.y))}return this._localMatrix.rotateBy(this._rotate.z),this._localMatrix.scaleBy(this._scale.x,this._scale.y),.5===this._origin.x&&.5===this._origin.y||this._localMatrix.translateBy(this._bounds2d.x*(.5-this._origin.x),this._bounds2d.y*(.5-this._origin.y)),this._parent?(this._worldMatrix.copy(this._parent._worldMatrix),this._worldMatrix.multiply(this._localMatrix)):this._worldMatrix.copy(this._localMatrix),this._worldMatrix.compare(this._oldWorldMatrix)?this._transformChanged=!1:(this._oldWorldMatrix.copy(this._worldMatrix),this._transformChanged=!0,this._aabbDirty=!0,this._bounds3dPolygonDirty=!0),this._oldBounds2d.compare(this._bounds2d)||(this._aabbDirty=!0,this._oldBounds2d.copy(this._bounds2d)),this._oldBounds3d.compare(this._bounds3d)||(this._bounds3dPolygonDirty=!0,this._oldBounds3d.copy(this._bounds3d)),this},disableInterpolation:function(t){return void 0!==t?(this._disableInterpolation=t,this):this._disableInterpolation},streamSections:function(t){return void 0!==t?(this._streamSections=t,this):this._streamSections},streamSectionsPush:function(t){return this._streamSections=this._streamSections||[],this._streamSections.push(t),this},streamSectionsPull:function(t){return this._streamSections&&this._streamSections.pull(t),this},streamProperty:function(t,e){if(this._streamProperty=this._streamProperty||{},void 0!==t)return void 0!==e?(this._streamProperty[t]=e,this):this._streamProperty[t]},streamSectionData:function(t,e,i){switch(t){case"transform":if(!e)return this._translate.toString(this._streamFloatPrecision)+","+this._scale.toString(this._streamFloatPrecision)+","+this._rotate.toString(this._streamFloatPrecision)+",";var o=e.split(",");this._disableInterpolation||i||this._streamJustCreated?(o[0]&&(this._translate.x=parseFloat(o[0])),o[1]&&(this._translate.y=parseFloat(o[1])),o[2]&&(this._translate.z=parseFloat(o[2])),o[3]&&(this._scale.x=parseFloat(o[3])),o[4]&&(this._scale.y=parseFloat(o[4])),o[5]&&(this._scale.z=parseFloat(o[5])),o[6]&&(this._rotate.x=parseFloat(o[6])),o[7]&&(this._rotate.y=parseFloat(o[7])),o[8]&&(this._rotate.z=parseFloat(o[8])),this._compositeCache&&this.cacheDirty(!0)):(o[0]&&(o[0]=parseFloat(o[0])),o[1]&&(o[1]=parseFloat(o[1])),o[2]&&(o[2]=parseFloat(o[2])),o[3]&&(o[3]=parseFloat(o[3])),o[4]&&(o[4]=parseFloat(o[4])),o[5]&&(o[5]=parseFloat(o[5])),o[6]&&(o[6]=parseFloat(o[6])),o[7]&&(o[7]=parseFloat(o[7])),o[8]&&(o[8]=parseFloat(o[8])),this._timeStream.push([ige.network.stream._streamDataTime+ige.network._latency,o]),this._timeStream.length>10&&this._timeStream.shift());break;case"depth":if(void 0===e)return String(this.depth());ige.isClient&&this.depth(parseInt(e));break;case"layer":if(void 0===e)return String(this.layer());ige.isClient&&this.layer(parseInt(e));break;case"bounds2d":if(void 0===e)return String(this._bounds2d.x+","+this._bounds2d.y);if(ige.isClient){var n=e.split(",");this.bounds2d(parseFloat(n[0]),parseFloat(n[1]))}break;case"bounds3d":if(void 0===e)return String(this._bounds3d.x+","+this._bounds3d.y+","+this._bounds3d.z);if(ige.isClient){var n=e.split(",");this.bounds3d(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]))}break;case"hidden":if(void 0===e)return String(this.isHidden());ige.isClient&&("true"==e?this.hide():this.show());break;case"mount":if(void 0===e){return this.parent()?this.parent().id():""}if(ige.isClient)if(e){var r=ige.$(e);r&&this.mount(r)}else this.unMount();break;case"origin":if(void 0===e)return String(this._origin.x+","+this._origin.y+","+this._origin.z);if(ige.isClient){var n=e.split(",");this.origin(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]))}break;case"props":var s,a;if(void 0===e){s={};for(a in this._streamProperty)this._streamProperty.hasOwnProperty(a)&&(s[a]=this._streamProperty[a]);return JSON.stringify(s)}if(ige.isClient){var h=JSON.parse(e);for(a in h)!1,h.hasOwnProperty(a)&&(this._streamProperty[a]!=h[a]&&!0,this._streamProperty[a]=h[a],this.emit("streamPropChange",[a,h[a]]))}}},streamMode:function(t){return void 0!==t?(ige.isServer&&(this._streamMode=t),this):this._streamMode},streamControl:function(t){return void 0!==t?(this._streamControl=t,this):this._streamControl},streamSyncInterval:function(t,e){return void 0!==t?(e?(this._streamSyncSectionInterval=this._streamSyncSectionInterval||{},this._streamSyncSectionDelta=this._streamSyncSectionDelta||{},t<16?delete this._streamSyncSectionInterval[e]:(this._streamSyncSectionDelta[e]=0,this._streamSyncSectionInterval[e]=t)):t<16?delete this._streamSyncInterval:(this._streamSyncDelta=0,this._streamSyncInterval=t),this):this._streamSyncInterval},streamFloatPrecision:function(t){if(void 0!==t){this._streamFloatPrecision=t;var e,i="\\.";for(e=0;e<this._streamFloatPrecision;e++)i+="0";return i+=",",this._floatRemoveRegExp=new RegExp(i,"g"),this}return this._streamFloatPrecision},streamSync:function(t){if(1===this._streamMode){if(this._streamSyncInterval){if(this._streamSyncDelta+=ige._tickDelta,this._streamSyncDelta<this._streamSyncInterval)return this;this._streamSyncDelta=0}var e,i=[],o=ige.network.clients(this._streamRoomId);for(e in o)o.hasOwnProperty(e)&&(this._streamControl?this._streamControl.apply(this,[e,this._streamRoomId])&&i.push(e):i.push(e));return this._streamSync(i),this}return 2===this._streamMode?(this._streamSync(t,this._streamRoomId),this):this},streamCreateData:function(){},streamEmitCreated:function(t){return void 0!==t?(this._streamEmitCreated=t,this):this._streamEmitCreated},_streamSync:function(t,e){var i,o,n=t.length,r=ige.network.stream,s=this.id(),a=[],h=!0;for(i=0;i<n;i++)if(o=t[i],r._streamClientCreated[s]=r._streamClientCreated[s]||{},r._streamClientCreated[s][o]||(h=this.streamCreate(o)),h){var l=this._streamData();r._streamClientData[s]=r._streamClientData[s]||{},r._streamClientData[s][o]!=l&&(a.push(o),r._streamClientData[s][o]=l)}a.length&&r.queue(s,l,a)},streamForceUpdate:function(){if(ige.isServer){var t=this.id();ige.network&&ige.network.stream&&ige.network.stream._streamClientData&&ige.network.stream._streamClientData[t]&&(ige.network.stream._streamClientData[t]={})}return this},streamCreate:function(t){if(this._parent){var e,i,o=this.id();if(ige.network.send("_igeStreamCreate",[this.classId(),o,this._parent.id(),this.streamSectionData("transform"),this.streamCreateData()],t),ige.network.stream._streamClientCreated[o]=ige.network.stream._streamClientCreated[o]||{},t)ige.network.stream._streamClientCreated[o][t]=!0;else{e=ige.network.clients();for(i in e)e.hasOwnProperty(i)&&(ige.network.stream._streamClientCreated[o][i]=!0)}return!0}return!1},streamDestroy:function(t){var e,i,o=this.id();if(ige.network.send("_igeStreamDestroy",[ige._currentTime,o],t),ige.network.stream._streamClientCreated[o]=ige.network.stream._streamClientCreated[o]||{},ige.network.stream._streamClientData[o]=ige.network.stream._streamClientData[o]||{},t)ige.network.stream._streamClientCreated[o][t]=!1,ige.network.stream._streamClientData[o][t]=void 0;else{e=ige.network.clients();for(i in e)e.hasOwnProperty(i)&&(ige.network.stream._streamClientCreated[o][i]=!1,ige.network.stream._streamClientData[o][i]=void 0)}return!0},_streamData:function(){if(this._streamDataCache)return this._streamDataCache;var t,e,i,o="",n="",r=this._streamSections,s=r.length;if(o+=this.id(),this._alive){for(e=0;e<s;e++)t="",i=r[e],this._streamSyncSectionInterval&&this._streamSyncSectionInterval[i]?(this._streamSyncSectionDelta[i]+=ige._tickDelta,this._streamSyncSectionDelta[i]>=this._streamSyncSectionInterval[i]&&(t=this.streamSectionData(i),this._streamSyncSectionDelta[i]=0)):t=this.streamSectionData(i),n+=ige.network.stream._sectionDesignator,void 0!==t&&(n+=t);n&&(o+=n),o=o.replace(this._floatRemoveRegExp,",")}return this._streamDataCache=o,o},interpolateValue:function(t,e,i,o,n){var r=e-t,s=n-i,a=o-i,h=a/s;return h<0?h=0:h>1&&(h=1),r*h+t},_processInterpolate:function(t,e){e||(e=200);for(var i,o,n,r,s,a,h,l=this._timeStream,c=[],u=1;l[u];){if(l[u][0]>t){i=l[u-1],o=l[u];break}u++}o||i?l.splice(0,u-1):l.length>2&&l[l.length-1][0]<t&&(i=l[l.length-2],o=l[l.length-1],l.shift(),this.emit("interpolationLag")),o&&i&&(isNaN(i[0])&&(i[0]=o[0]),this._timeStreamPreviousData=i,this._timeStreamNextData=o,n=o[0]-i[0],r=t-i[0],this._timeStreamDataDelta=Math.floor(n),this._timeStreamOffsetDelta=Math.floor(r),s=r/n,this._timeStreamCurrentInterpolateTime=s,a=i[1],h=o[1],c[0]=this.interpolateValue(a[0],h[0],i[0],t,o[0]),c[1]=this.interpolateValue(a[1],h[1],i[0],t,o[0]),c[2]=this.interpolateValue(a[2],h[2],i[0],t,o[0]),c[3]=this.interpolateValue(a[3],h[3],i[0],t,o[0]),c[4]=this.interpolateValue(a[4],h[4],i[0],t,o[0]),c[5]=this.interpolateValue(a[5],h[5],i[0],t,o[0]),c[6]=this.interpolateValue(a[6],h[6],i[0],t,o[0]),c[7]=this.interpolateValue(a[7],h[7],i[0],t,o[0]),c[8]=this.interpolateValue(a[8],h[8],i[0],t,o[0]),this.translateTo(parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])),this.scaleTo(parseFloat(c[3]),parseFloat(c[4]),parseFloat(c[5])),this.rotateTo(parseFloat(c[6]),parseFloat(c[7]),parseFloat(c[8])),this._lastUpdate=(new Date).getTime())},_highlightToGlobalCompositeOperation:function(t){if(t)return!0===t?"lighter":t}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeEntity);var IgeUiEntity=IgeEntity.extend([{extension:IgeUiStyleExtension,overwrite:!0},{extension:IgeUiPositionExtension,overwrite:!0}],{classId:"IgeUiEntity",init:function(){IgeEntity.prototype.init.call(this),this._color="#000000",this._borderLeftWidth=0,this._borderTopWidth=0,this._borderRightWidth=0,this._borderBottomWidth=0,this._borderTopLeftRadius=0,this._borderTopRightRadius=0,this._borderBottomRightRadius=0,this._borderBottomLeftRadius=0,
this._backgroundPosition={x:0,y:0},this._paddingLeft=0,this._paddingTop=0,this._paddingRight=0,this._paddingBottom=0},disabled:function(t){return void 0!==t?(this._disabled=t,this):this._disabled},overflow:function(t){return void 0!==t?(this._overflow=t,this):this._overflow},_renderBackground:function(t){var e,i,o,n,r=this._bounds2d;(this._backgroundColor||this._patternFill)&&(e=-r.x/2|0,i=-r.y/2|0,o=r.x,n=r.y,t.save(),t.beginPath(),this._borderTopRightRadius||this._borderBottomRightRadius||this._borderBottomLeftRadius||this._borderTopLeftRadius?(t.moveTo(e+this._borderTopLeftRadius,i),t.lineTo(e+o-this._borderTopRightRadius,i),this._borderTopRightRadius>0&&t.arcTo(e+o,i,e+o,i+this._borderTopRightRadius,this._borderTopRightRadius),t.lineTo(e+o,i+n-this._borderBottomRightRadius),this._borderBottomRightRadius>0&&t.arcTo(e+o,i+n,e+o-this._borderBottomRightRadius,i+n,this._borderBottomRightRadius),t.lineTo(e+this._borderBottomLeftRadius,i+n),this._borderBottomLeftRadius>0&&t.arcTo(e,i+n,e,i+n-this._borderBottomLeftRadius,this._borderBottomLeftRadius),t.lineTo(e,i+this._borderTopLeftRadius),this._borderTopLeftRadius>0&&t.arcTo(e,i,e+this._borderTopLeftRadius,i,this._borderTopLeftRadius),t.clip()):t.rect(e,i,o,n),this._backgroundColor&&(t.fillStyle=this._backgroundColor,t.fill()),this._patternFill&&(t.translate(-(o/2|0)+this._backgroundPosition.x,-(n/2|0)+this._backgroundPosition.y),t.fillStyle=this._patternFill,t.fill()),t.restore())},_renderBorder:function(t){var e,i=this._bounds2d,o=.5+(0|-i.x2),n=.5+(0|-i.y2),r=i.x-1,s=i.y-1;if(this._borderTopRightRadius||this._borderBottomRightRadius||this._borderBottomLeftRadius||this._borderTopLeftRadius||this._borderLeftWidth!==this._borderWidth||this._borderTopWidth!==this._borderWidth||this._borderRightWidth!==this._borderWidth||this._borderBottomWidth!==this._borderWidth){var a=function(){t.stroke(),t.beginPath()};e=Math.PI/180,t.beginPath(),this._borderTopWidth&&(t.strokeStyle=this._borderTopColor,t.lineWidth=this._borderTopWidth,this._borderTopLeftRadius>0&&t.arc(o+this._borderTopLeftRadius,n+this._borderTopLeftRadius,this._borderTopLeftRadius,225*e,270*e),t.moveTo(o+this._borderTopLeftRadius,n),t.lineTo(o+r-this._borderTopRightRadius,n),this._borderTopRightRadius>0&&t.arc(o+r-this._borderTopRightRadius,n+this._borderTopRightRadius,this._borderTopRightRadius,-90*e,-44*e)),this._borderRightWidth&&this._borderTopColor==this._borderRightColor&&this._borderTopWidth==this._borderRightWidth||a(),this._borderRightWidth&&(t.strokeStyle=this._borderRightColor,t.lineWidth=this._borderRightWidth,this._borderTopRightRadius>0&&t.arc(o+r-this._borderTopRightRadius,n+this._borderTopRightRadius,this._borderTopRightRadius,-45*e,0),t.moveTo(o+r,n+this._borderTopRightRadius),t.lineTo(o+r,n+s-this._borderBottomRightRadius),this._borderBottomRightRadius>0&&t.arc(o+r-this._borderBottomRightRadius,n+s-this._borderBottomRightRadius,this._borderTopRightRadius,0,46*e)),this._borderBottomWidth&&this._borderRightColor==this._borderBottomColor&&this._borderRightWidth==this._borderBottomWidth||a(),this._borderBottomWidth&&(t.strokeStyle=this._borderBottomColor,t.lineWidth=this._borderBottomWidth,this._borderBottomRightRadius>0&&t.arc(o+r-this._borderBottomRightRadius,n+s-this._borderBottomRightRadius,this._borderBottomRightRadius,45*e,90*e),t.moveTo(o+r-this._borderBottomRightRadius,n+s),t.lineTo(o+this._borderBottomLeftRadius,n+s),this._borderBottomLeftRadius>0&&t.arc(o+this._borderBottomLeftRadius,n+s-this._borderBottomLeftRadius,this._borderBottomLeftRadius,90*e,136*e)),this._borderLeftWidth&&this._borderBottomColor==this._borderLeftColor&&this._borderBottomWidth==this._borderLeftWidth||a(),this._borderLeftWidth&&(t.strokeStyle=this._borderLeftColor,t.lineWidth=this._borderLeftWidth,this._borderBottomLeftRadius>0&&t.arc(o+this._borderBottomLeftRadius,n+s-this._borderBottomLeftRadius,this._borderBottomLeftRadius,135*e,180*e),t.moveTo(o,n+s-this._borderBottomLeftRadius),t.lineTo(o,n+this._borderTopLeftRadius),this._borderTopLeftRadius>0&&t.arc(o+this._borderTopLeftRadius,n+this._borderTopLeftRadius,this._borderTopLeftRadius,180*e,226*e)),t.stroke()}else t.strokeStyle=this._borderColor,t.lineWidth=this._borderWidth,t.strokeRect(o,n,r,s)},cell:function(t){var e=IgeEntity.prototype.cell.call(this,t);return e===this&&this._patternTexture&&this.backgroundImage(this._patternTexture,this._patternRepeat),e},mount:function(t){var e=IgeEntity.prototype.mount.call(this,t);return this._parent&&(this._updateUiPosition&&this._updateUiPosition(),this._children.length&&this.updateUiChildren(),this._updateStyle&&this._updateStyle()),e},tick:function(t,e){if(!this._hidden&&this._inView&&(!this._parent||this._parent._inView)&&!this._streamJustCreated){if(e||this._transformContext(t),this._renderBackground(t),this._renderBorder(t),"hidden"===this._overflow){var i=this._bounds2d,o=-i.x/2+this._paddingLeft|0,n=-i.y/2+this._paddingTop|0,r=i.x+this._paddingRight,s=i.y+this._paddingBottom;t.rect(o,n,r,s),t.clip()}t.translate(this._paddingLeft,this._paddingTop),IgeEntity.prototype.tick.call(this,t,!0)}},_resizeEvent:function(t){this._updateUiPosition&&this._updateUiPosition(),this._updateStyle&&this._updateStyle(),IgeEntity.prototype._resizeEvent.call(this,t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiEntity);var IgeUiElement=IgeUiEntity.extend({classId:"IgeUiElement",init:function(){var t=this;IgeUiEntity.prototype.init.call(this),ige.ui.registerElement(this),this._focused=!1,this._allowHover=!0,this._allowFocus=!0,this._allowActive=!0;var e=function(){t._updateStyle()};this.on("mouseOver",function(){this._allowHover?(e(),ige.input.stopPropagation()):this._mouseStateOver=!1}),this.on("mouseOut",function(){this._allowHover?(e(),ige.input.stopPropagation()):this._mouseStateOver=!1}),this.on("mouseDown",function(){this._allowActive?(e(),ige.input.stopPropagation()):this._mouseStateDown=!1}),this.on("mouseUp",function(){this._allowFocus?t.focus()?ige.input.stopPropagation():e():this._allowActive&&e()}),this.mouseEventsActive(!0)},allowHover:function(t){return void 0!==t?(this._allowHover=t,this):this._allowHover},allowFocus:function(t){return void 0!==t?(this._allowFocus=t,this):this._allowFocus},allowActive:function(t){return void 0!==t?(this._allowActive=t,this):this._allowActive},styleClass:function(t){return void 0!==t?(t="."+t,this._styleClass&&this._styleClass!==t&&ige.ui.unRegisterElementStyle(this),this._styleClass=t,ige.ui.registerElementStyle(this),this._updateStyle(),this):this._styleClass},_updateStyle:function(){this._processStyle(this._classId),this._processStyle(this._styleClass),this._processStyle("#"+this._id),this._focused&&(this._processStyle(this._classId,"focus"),this._processStyle(this._styleClass,"focus"),this._processStyle("#"+this._id,"focus")),this._mouseStateOver&&(this._processStyle(this._classId,"hover"),this._processStyle(this._styleClass,"hover"),this._processStyle("#"+this._id,"hover")),this._mouseStateDown&&(this._processStyle(this._classId,"active"),this._processStyle(this._styleClass,"active"),this._processStyle("#"+this._id,"active"))},_processStyle:function(t,e){if(t){e&&(t+=":"+e);var i=ige.ui.style(t);i&&this.applyStyle(i)}},applyStyle:function(t){var e;if(void 0!==t)for(var i in t)t.hasOwnProperty(i)&&"function"==typeof this[i]&&(e=t[i]instanceof Array?t[i]:[t[i]],this[i].apply(this,e));return this},focus:function(){return!!ige.ui.focus(this)&&(this._updateStyle(),!0)},blur:function(){return!!ige.ui.blur(this)&&(this._updateStyle(),!0)},focused:function(){return this._focused},value:function(t){return void 0!==t?(this._value=t,this):this._value},_mounted:function(){this._updateStyle()},destroy:function(){ige.ui.unRegisterElement(this),IgeUiEntity.prototype.destroy.call(this)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiElement);var IgeFontEntity=IgeUiEntity.extend({classId:"IgeFontEntity",init:function(){IgeUiEntity.prototype.init.call(this),this._renderText=void 0,this._text=void 0,this._textAlignX=1,this._textAlignY=3,this._textLineSpacing=0,this._nativeMode=!1,this.cache(!0)},width:function(t,e,i,o){void 0!==t&&this._bounds2d.x!==t&&this.clearCache();var n=IgeUiEntity.prototype.width.call(this,t,e,i,o);return this._autoWrap&&this._applyAutoWrap(),n},height:function(t,e,i,o){return void 0!==t&&this._bounds2d.y!==t&&this.clearCache(),IgeUiEntity.prototype.height.call(this,t,e,i,o)},text:function(t){if(void 0!==t){var e=!1;return t=String(t),this._text!==t&&(this.clearCache(),e=!0),this._text=t,this._autoWrap&&e?this._applyAutoWrap():this._renderText=t,this}return this._text},bindData:function(t,e,i,o){return void 0!==t&&void 0!==e&&(this._bindDataObject=t,this._bindDataProperty=e,this._bindDataPreText=i||"",this._bindDataPostText=o||""),this},textAlignX:function(t){return void 0!==t?(this._textAlignX!==t&&this.clearCache(),this._textAlignX=t,this):this._textAlignX},textAlignY:function(t){return void 0!==t?(this._textAlignY!==t&&this.clearCache(),this._textAlignY=t,this):this._textAlignY},textLineSpacing:function(t){return void 0!==t?(this._textLineSpacing!==t&&this.clearCache(),this._textLineSpacing=t,this):this._textLineSpacing},colorOverlay:function(t){return void 0!==t?(this._colorOverlay!==t&&this.clearCache(),this._colorOverlay=t,this):this._colorOverlay},color:function(t){return this.colorOverlay(t)},clearCache:function(){this._cache&&this.cacheDirty(!0),this._texture&&this._texture._caching&&this._texture._cacheText[this._renderText]&&delete this._texture._cacheText[this._renderText]},nativeFont:function(t){if(void 0!==t){this._nativeFont!==t&&this.clearCache(),this._nativeFont=t;var e=new IgeTexture(IgeFontSmartTexture);return this.texture(e),this._nativeMode=!0,this}return this._nativeFont},nativeStroke:function(t){return void 0!==t?(this._nativeStroke!==t&&this.clearCache(),this._nativeStroke=t,this):this._nativeStroke},nativeStrokeColor:function(t){return void 0!==t?(this._nativeStrokeColor!==t&&this.clearCache(),this._nativeStrokeColor=t,this):this._nativeStrokeColor},autoWrap:function(t){return void 0!==t?(this._autoWrap=t,this._text&&(this._applyAutoWrap(),this.clearCache()),this):this._autoWrap},_applyAutoWrap:function(){if(this._text){var t,e,i,o=this._text.replace(/\n/g," "),n=[],r="";for(t=o.split(" "),e=0;e<t.length;e++)r&&(r+=" "),r+=t[e],i=this.measureTextWidth(r),i>=this._bounds2d.x?(r=t[e],n.push("\n"+t[e])):n.push(t[e]);this._renderText=n.join(" ")}},measureTextWidth:function(t){return t=t||this._text,0===this._texture._mode?this._texture.measureTextWidth(t):this._texture.script.measureTextWidth(t,this)},tick:function(t){this._bindDataObject&&this._bindDataProperty&&(!1===this._bindDataObject._alive?delete this._bindDataObject:this.text(this._bindDataPreText+this._bindDataObject[this._bindDataProperty]+this._bindDataPostText)),IgeUiEntity.prototype.tick.call(this,t)},_stringify:function(){var t,e=IgeUiEntity.prototype._stringify.call(this);for(t in this)if(this.hasOwnProperty(t)&&void 0!==this[t])switch(t){case"_text":e+=".text("+this.text()+")";break;case"_textAlignX":e+=".textAlignX("+this.textAlignX()+")";break;case"_textAlignY":e+=".textAlignY("+this.textAlignY()+")";break;case"_textLineSpacing":e+=".textLineSpacing("+this.textLineSpacing()+")"}return e}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeFontEntity);var IgeParticleEmitter=IgeUiEntity.extend({classId:"IgeParticleEmitter",IgeParticleEmitter:!0,init:function(){IgeUiEntity.prototype.init.call(this),this._currentDelta=0,this._started=!1,this._particles=[],this.applyDepthToParticles(!0),this.applyLayerToParticles(!0),this.quantityTimespan(1e3),this.quantityBase(10),this.quantityVariance(0,0),this.translateBaseX(0),this.translateBaseY(0),this.translateBaseZ(0),this.translateVarianceX(0,0),this.translateVarianceY(0,0),this.translateVarianceZ(0,0),this.rotateBase(0),this.rotateVariance(0,0),this.deathRotateBase(0),this.deathRotateVariance(0,0),this.scaleBaseX(1),this.scaleBaseY(1),this.scaleBaseZ(1),this.scaleVarianceX(0,0),this.scaleVarianceY(0,0),this.scaleVarianceZ(0,0),this.scaleLockAspect(!1),this.deathScaleBaseX(0),this.deathScaleBaseY(0),this.deathScaleBaseZ(0),this.deathScaleVarianceX(0,0),this.deathScaleVarianceY(0,0),this.deathScaleVarianceZ(0,0),this.deathScaleLockAspect(!1),this.opacityBase(1),this.opacityVariance(0,0),this.deathOpacityBase(1),this.deathOpacityVariance(0,0),this.lifeBase(1e3),this.lifeVariance(0,0)},particle:function(t){return this._particle=t,this},particleMountTarget:function(t){return this._particleMountTarget=t,this},applyDepthToParticles:function(t){return this._applyDepthToParticles=t,this},applyLayerToParticles:function(t){return this._applyLayerToParticles=t,this},quantityTimespan:function(t){return this._quantityTimespan=t,this},quantityBase:function(t){return this._quantityBase=t,this},quantityVariance:function(t,e){return this._quantityVariance=[t,e],this},quantityMax:function(t){return this._quantityMax=t,this._quantityProduced=0,this},translateBaseX:function(t){return this._translateBaseX=t,this},translateBaseY:function(t){return this._translateBaseY=t,this},translateBaseZ:function(t){return this._translateBaseZ=t,this},translateVarianceX:function(t,e){return this._translateVarianceX=[t,e],this},translateVarianceY:function(t,e){return this._translateVarianceY=[t,e],this},translateVarianceZ:function(t,e){return this._translateVarianceZ=[t,e],this},rotateBase:function(t){return this._rotateBase=t,this},rotateVariance:function(t,e){return this._rotateVariance=[t,e],this},deathRotateBase:function(t){return this._deathRotateBase=t,this},deathRotateVariance:function(t,e){return this._deathRotateVariance=[t,e],this},scaleBaseX:function(t){return this._scaleBaseX=t,this},scaleBaseY:function(t){return this._scaleBaseY=t,this},scaleBaseZ:function(t){return this._scaleBaseZ=t,this},scaleVarianceX:function(t,e){return this._scaleVarianceX=[t,e],this},scaleVarianceY:function(t,e){return this._scaleVarianceY=[t,e],this},scaleVarianceZ:function(t,e){return this._scaleVarianceZ=[t,e],this},scaleLockAspect:function(t){return this._scaleLockAspect=t,this},deathScaleBaseX:function(t){return this._deathScaleBaseX=t,this},deathScaleBaseY:function(t){return this._deathScaleBaseY=t,this},deathScaleBaseZ:function(t){return this._deathScaleBaseZ=t,this},deathScaleVarianceX:function(t,e){return this._deathScaleVarianceX=[t,e],this},deathScaleVarianceY:function(t,e){return this._deathScaleVarianceY=[t,e],this},deathScaleVarianceZ:function(t,e){return this._deathScaleVarianceZ=[t,e],this},deathScaleLockAspect:function(t){return this._deathScaleLockAspect=t,this},opacityBase:function(t){return this._opacityBase=t,this},opacityVariance:function(t,e){return this._opacityVariance=[t,e],this},deathOpacityBase:function(t){return this._deathOpacityBase=t,this},deathOpacityVariance:function(t,e){return this._deathOpacityVariance=[t,e],this},lifeBase:function(t){return this._lifeBase=t,this},lifeVariance:function(t,e){return this._lifeVariance=[t,e],this},velocityVector:function(t,e,i){return this._velocityVector={base:t,min:e,max:i},this},linearForceVector:function(t,e,i){return this._linearForceVector={base:t,min:e,max:i},this},start:function(){return this._particle?(this.updateTransform(),this._quantityTimespan=void 0!==this._quantityTimespan?this._quantityTimespan:1e3,this._maxParticles=this.baseAndVarianceValue(this._quantityBase,this._quantityVariance,!0),this._particlesPerTimeVector=this._quantityTimespan/this._maxParticles,this._currentDelta=0,this._quantityProduced=0,this._started=!0):this.log("Cannot start particle emitter because no particle class was specified with a call to particle()","error"),this},updateSettings:function(){this._maxParticles=this.baseAndVarianceValue(this._quantityBase,this._quantityVariance,!0),this._particlesPerTimeVector=this._quantityTimespan/this._maxParticles},stop:function(){return this._started=!1,this},stopAndKill:function(){this._started=!1;for(var t=this._particles,e=t.length;e--;)t[e].destroy();return this._particles=[],this},baseAndVarianceValue:function(t,e,i){t=t||0,e=e||[0,0];var o=0;return o=i?Math.floor(e[0]+Math.random()*(e[1]-e[0])):e[0]+Math.random()*(e[1]-e[0]),t+o},vectorFromBaseMinMax:function(t){if(t.min&&t.max){var e=t.base,i=t.min,o=t.max,n={};return n.x=e.x+(i.x+Math.random()*(o.x-i.x)),n.y=e.y+(i.y+Math.random()*(o.y-i.y)),n.z=e.z+(i.z+Math.random()*(o.z-i.z)),n}return t.base},tick:function(t){if(this._currentDelta+=ige._tickDelta,this._parent&&this._started&&(!this._quantityMax||this._quantityProduced<this._quantityMax)){var e,i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b,E,T,w,S,C,R;if(this._currentDelta>this._quantityTimespan&&(this._currentDelta=this._quantityTimespan),this._currentDelta>=this._particlesPerTimeVector&&(e=this._currentDelta/this._particlesPerTimeVector|0,this._currentDelta-=this._particlesPerTimeVector*e,e))for(;e--;){if(this._quantityMax&&++this._quantityProduced>=this._quantityMax){this.stop();break}for(i=this.baseAndVarianceValue(this._translateBaseX,this._translateVarianceX,!0),o=this.baseAndVarianceValue(this._translateBaseY,this._translateVarianceY,!0),n=this.baseAndVarianceValue(this._translateBaseZ,this._translateVarianceZ,!0),this._velocityVector&&(r=this.vectorFromBaseMinMax(this._velocityVector),h=r.x,l=r.y,c=this._worldMatrix.matrix[0],u=this._worldMatrix.matrix[3],s=h*c-l*u,a=l*c+h*u,r.x=s,r.y=a),m=this.baseAndVarianceValue(this._scaleBaseX,this._scaleVarianceX,!1),p=d=m,this._scaleLockAspect||(d=this.baseAndVarianceValue(this._scaleBaseY,this._scaleVarianceY,!1),p=this.baseAndVarianceValue(this._scaleBaseZ,this._scaleVarianceZ,!1)),_=this.baseAndVarianceValue(this._rotateBase,this._rotateVariance,!0),f=this.baseAndVarianceValue(this._opacityBase,this._opacityVariance,!1),y=this.baseAndVarianceValue(this._lifeBase,this._lifeVariance,!0),this._linearForceVector&&(g=this.vectorFromBaseMinMax(this._linearForceVector),h=g.x,l=g.y,c=this._worldMatrix.matrix[0],u=this._worldMatrix.matrix[3],s=h*c-l*u,a=l*c+h*u,g.x=s,g.y=a),void 0!==this._deathScaleBaseX&&(v=this.baseAndVarianceValue(this._deathScaleBaseX,this._deathScaleVarianceX,!1)),void 0===this._deathScaleBaseY||this._deathScaleLockAspect||(x=this.baseAndVarianceValue(this._deathScaleBaseY,this._deathScaleVarianceY,!1)),void 0===this._deathScaleBaseZ||this._deathScaleLockAspect||(b=this.baseAndVarianceValue(this._deathScaleBaseZ,this._deathScaleVarianceZ,!1)),this._deathScaleLockAspect&&(b=x=v),void 0!==this._deathRotateBase&&(E=this.baseAndVarianceValue(this._deathRotateBase,this._deathRotateVariance,!0)),void 0!==this._deathOpacityBase&&(T=this.baseAndVarianceValue(this._deathOpacityBase,this._deathOpacityVariance,!1)),w=new this._particle(this),this._ignoreCamera?(i+=this._translate.x,o+=this._translate.y):(i+=this._worldMatrix.matrix[2],o+=this._worldMatrix.matrix[5]),n+=this._translate.z,m*=this._scale.x,d*=this._scale.y,p*=this._scale.z,v*=this._scale.x,x*=this._scale.y,b*=this._scale.z,w.translateTo(i,o,n),w.rotateTo(0,0,Math.radians(_)),w.scaleTo(m,d,p),w.opacity(f),this._applyDepthToParticles&&w.depth(this._depth),this._applyLayerToParticles&&w.layer(this._layer),"object"==typeof r&&w.velocity.vector3(r,!1),"object"==typeof g&&w.velocity.linearForceVector3(g,!1),S=[],void 0!==E&&S.push((new IgeTween).targetObj(w._rotate).properties({z:Math.radians(E)}).duration(y)),void 0!==T&&S.push((new IgeTween).targetObj(w).properties({_opacity:T}).duration(y)),C={},void 0!==v&&(C.x=v),void 0!==x&&(C.y=x),void 0!==b&&(C.z=b),(C.x||C.y||C.z)&&S.push((new IgeTween).targetObj(w._scale).properties(C).duration(y)),"number"==typeof y&&w.lifeSpan(y),this._particles.push(w),w.mount(this._particleMountTarget||this._parent),R=0;R<S.length;R++)S[R].start()}}IgeUiEntity.prototype.tick.call(this,t)},particles:function(){return this._particles},_stringify:function(){var t=IgeUiEntity.prototype._stringify.call(this);return t}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeParticleEmitter);var IgeParticle=IgeEntity.extend({classId:"IgeParticle",init:function(t){this._emitter=t,IgeEntity.prototype.init.call(this),this.addComponent(IgeVelocityComponent)},destroy:function(){void 0!==this._emitter&&this._emitter._particles.pull(this),IgeEntity.prototype.destroy.call(this)}}),IgeMap2d=IgeClass.extend({classId:"IgeMap2d",init:function(t){this._mapData=t||[]},tileData:function(t,e,i){if(void 0!==t&&void 0!==e){if(void 0!==i)return this._mapData[e]=this._mapData[e]||[],this._mapData[e][t]=i,this;if(this._mapData[e])return this._mapData[e][t]}},clearData:function(t,e){return void 0!==t&&void 0!==e&&void 0!==this._mapData[e]&&(delete this._mapData[e][t],!0)},collision:function(t,e,i,o){var n,r;if(void 0===i&&(i=1),void 0===o&&(o=1),void 0!==t&&void 0!==e)for(r=0;r<o;r++)for(n=0;n<i;n++)if(this.tileData(t+n,e+r))return!0;return!1},collisionWith:function(t,e,i,o,n){var r,s;if(void 0===i&&(i=1),void 0===o&&(o=1),void 0!==t&&void 0!==e)for(s=0;s<o;s++)for(r=0;r<i;r++)if(this.tileData(t+r,e+s)===n)return!0;return!1},collisionWithOnly:function(t,e,i,o,n){var r,s,a=!1;if(void 0===i&&(i=1),void 0===o&&(o=1),void 0!==t&&void 0!==e)for(s=0;s<o;s++)for(r=0;r<i;r++)if(this.tileData(t+r,e+s)){if(this.tileData(t+r,e+s)!==n)return!1;a=!0}return a},mapData:function(t,e,i){if(void 0!==t){if(e||i){var o,n;for(n in t)for(o in t[n])this._mapData[i+parseInt(n)][e+parseInt(o)]=t[n][o]}else this._mapData=t;return this}return this._mapData},sortedMapDataAsArray:function(){var t,e,i,o,n,r,s=this.mapData(),a={};for(o=this._sortKeys(s),n=0;n<o.length;n++)for(e=o[n],i=this._sortKeys(s[e]),a[e]=a[e]||{},r=0;r<i.length;r++)t=i[r],a[e][t]=s[e][t];return a},_sortKeys:function(t){var e=[];for(var i in t)e.push(i);return e.sort(),e},mapDataString:function(){return JSON.stringify(this.mapData())},insertMapData:function(t,e,i){},rotateData:function(t,e){e},translateDataBy:function(t,e){var i,o,n,r,s,a=this.mapData(),h=[];for(o in a)if(a.hasOwnProperty(o)){r=parseInt(o,10),n=a[r],h[r+e]=h[r+e]||{};for(i in n)n.hasOwnProperty(i)&&(s=parseInt(i,10),h[r+e][s+t]=a[o][i])}this.mapData(h,0,0)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeMap2d);var IgeTileMap2d=IgeEntity.extend({classId:"IgeTileMap2d",IgeTileMap2d:!0,init:function(t,e){IgeEntity.prototype.init.call(this),t=void 0!==t?t:40,e=void 0!==e?e:40;var i=this;if(!ige.isServer){var o=new IgeTexture(IgeTileMap2dSmartTexture);i.texture(o)}i.map=new IgeMap2d,i._adjustmentMatrix=new IgeMatrix2d,i.tileWidth(t),i.tileHeight(e),i.gridSize(3,3),i._drawGrid=0,i._gridColor="#ffffff"},highlightOccupied:function(t){return void 0!==t?(this._highlightOccupied=t,this):this._highlightOccupied},highlightTileRect:function(t){return void 0!==t?(this._highlightTileRect=t,this):this._highlightTileRect},tileWidth:function(t){return void 0!==t?(this._tileWidth=t,this._gridSize&&this._gridSize.x&&(this.width(this._tileWidth*this._gridSize.x),this._updateAdjustmentMatrix()),this):this._tileWidth},tileHeight:function(t){return void 0!==t?(this._tileHeight=t,this._gridSize&&this._gridSize.y&&(this.height(this._tileHeight*this._gridSize.y),this._updateAdjustmentMatrix()),this):this._tileHeight},gridSize:function(t,e){return void 0!==t&&void 0!==e?(this._gridSize=new IgePoint2d(t,e),0===this._mountMode&&this._tileWidth&&this.width(this._tileWidth*this._gridSize.x),1===this._mountMode&&this._tileWidth&&this.width(2*this._tileWidth*this._gridSize.x),this._tileHeight&&this.height(this._tileHeight*this._gridSize.y),this._updateAdjustmentMatrix(),this):this._gridSize},drawGrid:function(t){return void 0!==t?(this._drawGrid=t,this):this._drawGrid},gridColor:function(t){return void 0!==t?(this._gridColor=t,this):this._gridColor},occupyTile:function(t,e,i,o,n){var r,s;if(void 0===i&&(i=1),void 0===o&&(o=1),t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),o=Math.floor(o),void 0!==t&&void 0!==e){for(r=0;r<i;r++)for(s=0;s<o;s++)this.map.tileData(t+r,e+s,n);n._classId&&(n._occupiedRect=new IgeRect(t,e,i,o))}return this},unOccupyTile:function(t,e,i,o){var n,r,s;if(void 0===i&&(i=1),void 0===o&&(o=1),t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),o=Math.floor(o),void 0!==t&&void 0!==e)for(n=0;n<i;n++)for(r=0;r<o;r++)s=this.map.tileData(t+n,e+r),s&&s._occupiedRect&&delete s._occupiedRect,this.map.clearData(t+n,e+r);return this},isTileOccupied:function(t,e,i,o){return void 0===i&&(i=1),void 0===o&&(o=1),this.map.collision(t,e,i,o)},tileOccupiedBy:function(t,e){return this.map.tileData(t,e)},pointToTile:function(t){var e,i,o,n=t.x,r=t.y;return 0===this._mountMode&&(e=n,i=r,o=new IgePoint3d(Math.floor(e/this._tileWidth),Math.floor(i/this._tileWidth),0)),1===this._mountMode&&(e=n,i=r,o=new IgePoint3d(Math.floor(e/this._tileWidth),Math.floor(i/this._tileHeight),0)),o},mouseTilePoint:function(){var t=this.mouseToTile().thisMultiply(this._tileWidth,this._tileHeight,1);return t.x+=this._tileWidth/2,t.y+=this._tileHeight/2,t},tileToPoint:function(t,e){var i;return 0===this._mountMode&&(i=new IgePoint3d(t,e,0).thisMultiply(this._tileWidth,this._tileHeight,1),i.x-=this._bounds2d.x2-this._tileWidth/2,i.y-=this._bounds2d.y2-this._tileHeight/2),1===this._mountMode&&(i=new IgePoint3d(t*this._tileWidth+this._tileWidth/2,e*this._tileHeight+this._tileHeight/2,0),i.x-=this._bounds2d.x2/2,i.y-=this._bounds2d.y2),i.x2=i.x/2,i.y2=i.y/2,i},mouseToTile:function(){return 0===this._mountMode?this.pointToTile(this.mousePos()):this.pointToTile(this.mousePos().to2d())},scanRects:function(t){var e,i,o=[],n=this.map._mapData.clone();for(i in n)if(n.hasOwnProperty(i))for(e in n[i])n[i].hasOwnProperty(e)&&n[i][e]&&(!t||t&&t(n[i][e],e,i))&&o.push(this._scanRects(n,parseInt(e,10),parseInt(i,10),t));return o},_scanRects:function(t,e,i,o){var n={x:e,y:i,width:1,height:1},r=e+1,s=i+1;for(t[i][e]=0;t[i][r]&&(!o||o&&o(t[i][r],r,i));)n.width++,t[i][r]=0,r++;for(;t[s]&&t[s][e]&&(!o||o&&o(t[s][e],e,s));){if(t[s][e-1]&&(!o||o&&o(t[s][e-1],e-1,s))||t[s][e+n.width]&&(!o||o&&o(t[s][e+n.width],e+n.width,s)))return n;for(r=e;r<e+n.width;r++)if(!t[s][r]||o&&!o(t[s][r],r,s))return n;for(r=e;r<e+n.width;r++)t[s][r]=0;n.height++,s++}return n},inGrid:function(t,e,i,o){return void 0===i&&(i=1),void 0===o&&(o=1),t>=0&&e>=0&&t+i<=this._gridSize.x&&e+o<=this._gridSize.y},hoverColor:function(t){return void 0!==t?(this._hoverColor=t,this):this._hoverColor},loadMap:function(t){return this.map.mapData(t.data,0,0),this},saveMap:function(){var t,e,i=0,o=0,n=this.map._mapData;for(e in n)if(n.hasOwnProperty(e))for(t in n[e])n[e].hasOwnProperty(t)&&(parseInt(t)<parseInt(i)&&(i=parseInt(t)),parseInt(e)<parseInt(o)&&(o=parseInt(e)));return JSON.stringify({data:this.map.sortedMapDataAsArray(),dataXY:[parseInt(i,10),parseInt(o,10)]})},isometricMounts:function(t){return void 0!==t?(IgeEntity.prototype.isometricMounts.call(this,t),this.tileWidth(this._tileWidth),this.tileHeight(this._tileHeight),this.gridSize(this._gridSize.x,this._gridSize.y),this._updateAdjustmentMatrix(),this):this._mountMode},tileMapHitPolygon:function(t){if(0===this._mountMode)return this.aabb();if(1===this._mountMode){var e=this.aabb(),i=new IgePoly2d;return i.addPoint(e.x+e.width/2,e.y),i.addPoint(e.x+e.width,e.y+e.height/2),i.addPoint(e.x+e.width/2,e.y+e.height-1),i.addPoint(e.x-1,e.y+e.height/2-1),i}},_processTriggerHitTests:function(){if(this._mouseEventsActive&&ige._currentViewport){if(this._mouseAlwaysInside)return!0;var t=this.mouseToTile();return t.x>=0&&t.y>=0&&t.x<this._gridSize.x&&t.y<this._gridSize.y}return!1},_updateAdjustmentMatrix:function(){this._bounds2d.x2&&this._bounds2d.y2&&this._tileWidth&&this._tileHeight&&(0===this._mountMode&&this._adjustmentMatrix.translateTo(this._bounds2d.x2,this._bounds2d.y2),1===this._mountMode&&this._adjustmentMatrix.translateTo(0,this._bounds2d.y2))},_childMounted:function(t){t.tileWidth=t.tileWidth||this.tileWidth,t.tileHeight=t.tileHeight||this.tileHeight,t._tileWidth=t._tileWidth||1,t._tileHeight=t._tileHeight||1,IgeEntity.prototype._childMounted.call(this,t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTileMap2d);var IgeTextureMap=IgeTileMap2d.extend({classId:"IgeTextureMap",init:function(t,e){IgeTileMap2d.prototype.init.call(this,t,e),this.map=new IgeMap2d,this._textureList=[],this._renderCenter=new IgePoint3d(0,0,0),this._cacheDirty=!0},autoSection:function(t){return void 0!==t?(this._autoSection=t,this):this._autoSection},drawSectionBounds:function(t){return void 0!==t?(this._drawSectionBounds=t,this):this._drawSectionBounds},cacheForceFrame:function(){this._cacheDirty=!0},negate:function(t){if(void 0!==t){var e,i,o=t.map._mapData,n=this.map._mapData;for(i in o)if(o.hasOwnProperty(i))for(e in o[i])o[i].hasOwnProperty(e)&&n[i]&&n[i][e]&&delete n[i][e]}return this},addTexture:function(t){return this._textureList.push(t),t._loaded||(this._allTexturesLoaded=!1),this._textureList.length-1},allTexturesLoaded:function(){if(!this._allTexturesLoaded)for(var t=this._textureList,e=t.length;e--;)if(!t[e]._loaded)return!1;return this._allTexturesLoaded=!0,!0},paintTile:function(t,e,i,o){void 0!==t&&void 0!==e&&void 0!==i&&((void 0===o||o<1)&&(o=1),this.map.tileData(t,e,[i,o]))},clearTile:function(t,e){this.map.clearData(t,e)},loadMap:function(map){if(map.textures){this._textureList=[];var tex=[],i,self=this;for(i=0;i<map.textures.length;i++)eval("tex["+i+"] = "+map.textures[i]),self.addTexture(tex[i]);self.map.mapData(map.data)}else this.map.mapData(map.data);return this},saveMap:function(){var t,e,i,o=[],n=0,r=0,s=this.map._mapData;for(t=0;t<this._textureList.length;t++)o.push(this._textureList[t].stringify());for(i in s)if(s.hasOwnProperty(i))for(e in s[i])s[i].hasOwnProperty(e)&&(e<n&&(n=e),i<r&&(r=i));return JSON.stringify({textures:o,data:this.map.mapData(),dataXY:[n,r]})},clearMap:function(){return this.map.mapData([]),this},reset:function(){return this.clearMap(),this._textureList=[],this},tileTextureIndex:function(t,e,i){if(void 0!==t&&void 0!==e){var o=this.map.tileData(t,e);if(void 0===i)return o[0];o[0]=i}},tileTextureCell:function(t,e,i){if(void 0!==t&&void 0!==e){var o=this.map.tileData(t,e);if(void 0===i)return o[1];o[1]=i}},convertHorizontalData:function(t){var e,i,o=[];for(e in t)if(t.hasOwnProperty(e))for(i in t[e])t[e].hasOwnProperty(i)&&(o[i]=o[i]||[],o[i][e]=t[e][i]);return o},tick:function(t){IgeTileMap2d.prototype.tick.call(this,t);var e,i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g=this.map._mapData,v=this._newTileEntity();if(this._autoSection>0){if(this._cacheDirty&&this.allTexturesLoaded()){this._sections=[],this._sectionCtx=[];for(i in g)if(g.hasOwnProperty(i))for(e in g[i])if(g[i].hasOwnProperty(e)&&(r=parseInt(e),s=parseInt(i),0===this._mountMode&&(a=r,h=s),1===this._mountMode&&(o=r*this._tileWidth,n=s*this._tileHeight,a=(o-n)/this._tileWidth,h=.5*(o+n)/this._tileHeight),l=g[i][e],c=Math.floor(a/this._autoSection),u=Math.floor(h/this._autoSection),this._ensureSectionExists(c,u),p=this._sectionCtx[c][u],l&&(_=this._renderTile(p,r,s,l,v,null,c,u))))for(y=0;y<_.length;y++)f=_[y],m=c,d=u,f.x&&(m+=f.x),f.y&&(d+=f.y),this._ensureSectionExists(m,d),p=this._sectionCtx[m][d],this._sectionTileRegion=this._sectionTileRegion||[],this._sectionTileRegion[m]=this._sectionTileRegion[m]||[],this._sectionTileRegion[m][d]=this._sectionTileRegion[m][d]||[],this._sectionTileRegion[m][d][r]=this._sectionTileRegion[m][d][r]||[],this._sectionTileRegion[m][d][r][s]||(this._sectionTileRegion[m][d][r][s]=!0,this._renderTile(p,r,s,l,v,null,m,d));this._cacheDirty=!1,delete this._sectionTileRegion}this._drawSectionsToCtx(t)}else if(this.allTexturesLoaded())for(i in g)if(g.hasOwnProperty(i))for(e in g[i])g[i].hasOwnProperty(e)&&(l=g[i][e])&&this._renderTile(t,e,i,l,v)},_ensureSectionExists:function(t,e){var i;this._sections[t]=this._sections[t]||[],this._sectionCtx[t]=this._sectionCtx[t]||[],this._sections[t][e]||(this._sections[t][e]=document.createElement("canvas"),this._sections[t][e].width=this._tileWidth*this._autoSection,
this._sections[t][e].height=this._tileHeight*this._autoSection,i=this._sectionCtx[t][e]=this._sections[t][e].getContext("2d"),ige._globalSmoothing?(i.imageSmoothingEnabled=!0,i.mozImageSmoothingEnabled=!0):(i.imageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1),i.translate(this._tileWidth/2,this._tileHeight/2))},_drawSectionsToCtx:function(t){var e,i,o,n,r,s,a,h,l,c=ige._currentViewport.viewArea();h=this._tileWidth*this._autoSection,l=this._tileHeight*this._autoSection;for(e in this._sections)if(this._sections.hasOwnProperty(e))for(i in this._sections[e])this._sections[e].hasOwnProperty(i)&&(n=e*(this._tileWidth*this._autoSection),r=i*(this._tileHeight*this._autoSection),s=this._translate.x+n-ige._currentCamera._translate.x,a=this._translate.y+r-ige._currentCamera._translate.y,1===this._mountMode&&(s-=this._tileWidth/2,a-=this._tileHeight/2),s+h+this._tileHeight/2>=-c.width/2&&s-this._tileWidth/2<=c.width/2&&a+l+this._tileHeight/2>=-c.height/2&&a<=c.height/2&&(o=this._sections[e][i],t.drawImage(o,0,0,h,l,n,r,h,l),ige._drawCount++,this._drawSectionBounds&&(t.strokeStyle="#ff00f6",t.strokeRect(e*(this._tileWidth*this._autoSection),i*(this._tileHeight*this._autoSection),this._tileWidth*this._autoSection,this._tileHeight*this._autoSection))))},_renderTile:function(t,e,i,o,n,r,s,a){var h,l,c,u,m,d,p,_,f,y,g,v,x,b=1===this._mountMode?this._tileWidth/2:0;1===this._mountMode&&this._tileHeight;if(0===this._mountMode&&(h=e*this._tileWidth,l=i*this._tileHeight),1===this._mountMode&&(f=e*this._tileWidth,y=i*this._tileHeight,g=f-y,v=.5*(f+y),h=g-this._tileWidth/2,l=v),void 0!==s&&(h-=s*this._autoSection*this._tileWidth),void 0!==a&&(l-=a*this._autoSection*this._tileHeight),!r||r.xyInside(h,l))return h-b<0&&(c=c||[],c.push({x:-1}),u=!0,_=_||{},_.x=-1),h+b>t.canvas.width-this._tileWidth&&(c=c||[],c.push({x:1}),m=!0,_=_||{},_.x=1),l-0<0&&(c=c||[],c.push({y:-1}),d=!0,_=_||{},_.y=-1),l+0>t.canvas.height-this._tileHeight&&(c=c||[],c.push({y:1}),p=!0,_=_||{},_.y=1),(u||d||m||p)&&c.push(_),t.save(),t.translate(h,l),x=this._textureList[o[0]],n._cell=o[1],x&&x.render(t,n,ige._tickDelta),t.restore(),c},_newTileEntity:function(){return 0===this._mountMode?{_cell:1,_bounds2d:{x:this._tileWidth,y:this._tileHeight},_renderPos:{x:-this._tileWidth/2,y:-this._tileHeight/2}}:1===this._mountMode?{_cell:1,_bounds2d:{x:2*this._tileWidth,y:this._tileHeight},_renderPos:{x:-this._tileWidth,y:-this._tileHeight/2}}:void 0}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTextureMap);var IgeTileMap2dSmartTexture={render:function(t,e){var i=e._tileWidth,o=e._tileHeight,n=(e.bounds2d(),e._gridSize),r=0,s=0;if(e._drawGrid){t.strokeStyle=e._gridColor;var a,h,l,c=r+i*n.x,u=s+o*n.y;for(r=0,s=0,a=0;a<=n.y;a++)h=new IgePoint2d(r,s+o*a),l=new IgePoint2d(c,s+o*a),1===e._mountMode&&(h=h.toIso(),l=l.toIso()),t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(l.x,l.y),t.stroke();for(a=0;a<=n.x;a++)h=new IgePoint2d(r+i*a,s),l=new IgePoint2d(r+i*a,u),1===e._mountMode&&(h=h.toIso(),l=l.toIso()),t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(l.x,l.y),t.stroke()}if(e._highlightOccupied){t.fillStyle="#ff0000";for(s in e.map._mapData)if(e.map._mapData[s])for(r in e.map._mapData[s])e.map._mapData[s][r]&&(m=new IgePoint2d(i*r,o*s),0===e._mountMode&&t.fillRect(m.x,m.y,i,o),1===e._mountMode&&(m.thisToIso(),t.beginPath(),t.moveTo(m.x,m.y),t.lineTo(m.x+i,m.y+o/2),t.lineTo(m.x,m.y+o),t.lineTo(m.x-i,m.y+o/2),t.lineTo(m.x,m.y),t.fill()))}if(e._highlightTileRect)for(t.fillStyle="#e4ff00",s=e._highlightTileRect.y;s<e._highlightTileRect.y+e._highlightTileRect.height;s++)for(r=e._highlightTileRect.x;r<e._highlightTileRect.x+e._highlightTileRect.width;r++)m=new IgePoint2d(i*r,o*s),0===e._mountMode&&t.fillRect(m.x,m.y,i,o),1===e._mountMode&&(m.thisToIso(),t.beginPath(),t.moveTo(m.x,m.y-o/2),t.lineTo(m.x+i,m.y),t.lineTo(m.x,m.y+o/2),t.lineTo(m.x-i,m.y),t.lineTo(m.x,m.y-o/2),t.fill());if(e._drawMouse){var m,d,p,_=e.mousePos(),f=e.mouseToTile();f.x>=0&&f.y>=0&&f.x<n.x&&f.y<n.y&&(t.fillStyle=e._hoverColor||"#6000ff",0===e._mountMode&&t.fillRect(f.x*i,f.y*o,i,o),1===e._mountMode&&(m=f.clone().thisMultiply(i,o,0).thisToIso(),m.y+=o/2,t.beginPath(),t.moveTo(m.x,m.y-o/2),t.lineTo(m.x+i,m.y),t.lineTo(m.x,m.y+o/2),t.lineTo(m.x-i,m.y),t.lineTo(m.x,m.y-o/2),t.fill()),e._drawMouseData&&(d="Tile X: "+f.x+" Y: "+f.y,p=t.measureText(d),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(Math.floor(_.x-p.width/2-5),Math.floor(_.y-40),Math.floor(p.width+10),14),t.fillStyle="#ffffff",t.fillText(d,Math.floor(_.x-p.width/2),Math.floor(_.y-30))))}}},IgeCollisionMap2d=IgeEntity.extend({classId:"IgeCollisionMap2d",init:function(t,e){IgeEntity.prototype.init.call(this);this.map=new IgeMap2d},mapData:function(t){return void 0!==t?(this.map.mapData(t),this):this.map.mapData()}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeCollisionMap2d);var IgeCamera=IgeEntity.extend({classId:"IgeCamera",init:function(t){IgeEntity.prototype.init.call(this),this._trackRotateTarget=void 0,this._trackTranslateTarget=void 0,this._trackRotateSmoothing=void 0,this._trackTranslateSmoothing=void 0,this._entity=t},limit:function(t){return void 0!==t?(this._limit=t,this._entity):this._limit},panTo:function(t,e,i){return void 0!==t&&this._translate.tween().properties({x:t.x,y:t.y,z:t.z}).duration(e).easing(i).start(),this._entity},panBy:function(t,e,i){return void 0!==t&&this._translate.tween().properties({x:t.x+this._translate.x,y:t.y+this._translate.y,z:t.z+this._translate.z}).duration(e).easing(i).start(),this._entity},trackTranslate:function(t,e,i){return void 0!==t?(this.log("Camera on viewport "+this._entity.id()+" is now tracking translation target "+t.id()),void 0!==i&&(this._trackTranslateRounding=i),void 0!==e&&(this._trackTranslateSmoothing=e>=1?e:0),this._trackTranslateTarget=t,this._entity):this._trackTranslateTarget},trackTranslateSmoothing:function(t){return void 0!==t?(this._trackTranslateSmoothing=t,this):this._trackTranslateSmoothing},trackTranslateRounding:function(t){return void 0!==t?(this._trackTranslateRounding=t,this):this._trackTranslateRounding},unTrackTranslate:function(){delete this._trackTranslateTarget},trackRotate:function(t,e){return void 0!==t?(this.log("Camera on viewport "+this._entity.id()+" is now tracking rotation of target "+t.id()),this._trackRotateSmoothing=e>=1?e:0,this._trackRotateTarget=t,this._entity):this._trackRotateTarget},trackRotateSmoothing:function(t){return void 0!==t?(this._trackRotateSmoothing=t,this):this._trackRotateSmoothing},unTrackRotate:function(){delete this._trackRotateTarget},lookAt:function(t,e,i){return void 0!==t&&(t.updateTransform(),e?this._translate.tween().properties({x:Math.floor(t._worldMatrix.matrix[2]),y:Math.floor(t._worldMatrix.matrix[5]),z:0}).duration(e).easing(i).start():(this._translate.x=Math.floor(t._worldMatrix.matrix[2]),this._translate.y=Math.floor(t._worldMatrix.matrix[5])),this.updateTransform()),this},update:function(t){if(this._processUpdateBehaviours(t),this._trackTranslateTarget){var e,i,o,n,r,s,a=this._trackTranslateTarget,h=a._worldMatrix.matrix,l=h[2],c=h[5];this._trackTranslateSmoothing?(e=this._translate.x,i=this._translate.y,o=Math.round(l-e),n=Math.round(c-i),this._trackTranslateRounding?(r=this._translate.x+Math.round(o/this._trackTranslateSmoothing),s=this._translate.y+Math.round(n/this._trackTranslateSmoothing)):(r=this._translate.x+o/this._trackTranslateSmoothing,s=this._translate.y+n/this._trackTranslateSmoothing),this._limit&&(r<this._limit.x&&(r=this._limit.x),r>this._limit.x+this._limit.width&&(r=this._limit.x+this._limit.width),s<this._limit.y&&(s=this._limit.y),s>this._limit.y+this._limit.height&&(s=this._limit.y+this._limit.height)),this._translate.x=r,this._translate.y=s):this.lookAt(this._trackTranslateTarget)}if(this._trackRotateTarget){var u,m,d=void 0!==this._trackRotateTarget._parent?this._trackRotateTarget._parent._rotate.z:0,p=-(d+this._trackRotateTarget._rotate.z);this._trackRotateSmoothing?(u=this._rotate.z,m=p-u,this._rotate.z+=m/this._trackRotateSmoothing):this._rotate.z=p}this.updateTransform()},tick:function(t){this._processTickBehaviours(t),this._localMatrix.transformRenderingContext(t)},updateTransform:function(){this._localMatrix.identity(),this._localMatrix.multiply(this._localMatrix._newRotate(this._rotate.z)),this._localMatrix.multiply(this._localMatrix._newScale(this._scale.x,this._scale.y)),this._localMatrix.multiply(this._localMatrix._newTranslate(-this._translate.x,-this._translate.y)),this._parent?(this._worldMatrix.copy(this._parent._worldMatrix),this._worldMatrix.multiply(this._localMatrix)):this._worldMatrix.copy(this._localMatrix)},_stringify:function(){var t,e=IgeEntity.prototype._stringify.call(this);for(t in this)if(this.hasOwnProperty(t)&&void 0!==this[t])switch(t){case"_trackTranslateTarget":e+=".trackTranslate(ige.$('"+this._trackTranslateTarget.id()+"'), "+this.trackTranslateSmoothing()+")";break;case"_trackRotateTarget":e+=".trackRotate(ige.$('"+this._trackRotateTarget.id()+"'), "+this.trackRotateSmoothing()+")"}return e}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeCamera);var IgeViewport=IgeEntity.extend([{extension:IgeUiStyleExtension,overwrite:!0},{extension:IgeUiPositionExtension,overwrite:!0}],{classId:"IgeViewport",IgeViewport:!0,init:function(t){var e,i;this._alwaysInView=!0,IgeEntity.prototype.init.call(this),this._mouseAlwaysInside=!0,this._mousePos=new IgePoint3d(0,0,0),this._overflow="",this._clipping=!0,this._bornTime=void 0,t&&(e=t.width,i=t.height,t&&t.scaleToWidth&&t.scaleToHeight&&(this._lockDimension=new IgePoint3d(t.scaleToWidth,t.scaleToHeight,0))),this._bounds2d=new IgePoint3d(e||ige._bounds2d.x,i||ige._bounds2d.y,0),this.camera=new IgeCamera(this),this.camera._entity=this},minimumVisibleArea:function(t,e){return this._lockDimension=new IgePoint3d(t,e,0),ige.isClient&&this._resizeEvent({}),this},autoSize:function(t){return void 0!==t?(this._autoSize=t,this):this._autoSize},scene:function(t){return void 0!==t?(this._scene=t,this):this._scene},mousePos:function(){return this._mousePos.clone()},mousePosWorld:function(){return this._transformPoint(this._mousePos.clone())},viewArea:function(){var t=this.aabb(),e=this.camera._translate,i=this.camera._scale,o=t.width*(1/i.x),n=t.height*(1/i.y);return new IgeRect(e.x-o/2,e.y-n/2,o,n)},update:function(t,e){this._scene&&(ige._currentCamera=this.camera,ige._currentViewport=this,this._scene._parent=this,this.camera.update(t,e),IgeEntity.prototype.update.call(this,t,e),this._scene.newFrame()&&this._scene.update(t,e))},tick:function(t,e){if(this._scene){if(ige._currentCamera=this.camera,ige._currentViewport=this,this._scene._parent=this,IgeEntity.prototype.tick.call(this,t),t.translate(-this._bounds2d.x*this._origin.x|0,-this._bounds2d.y*this._origin.y|0),t.clearRect(0,0,this._bounds2d.x,this._bounds2d.y),(this._clipping||this._borderColor)&&(t.beginPath(),t.rect(0,0,this._bounds2d.x/ige._scale.x,this._bounds2d.y/ige._scale.x),this._borderColor&&(t.strokeStyle=this._borderColor,t.stroke()),this._clipping&&t.clip()),t.translate((this._bounds2d.x/2|0)+ige._translate.x,(this._bounds2d.y/2|0)+ige._translate.y),1===ige._scale.x&&1===ige._scale.y||t.scale(ige._scale.x,ige._scale.y),this.camera.tick(t),t.save(),this._scene.tick(t),t.restore(),this._drawGuides&&t===ige._ctx&&(t.save(),t.translate(-this._translate.x,-this._translate.y),this.paintGuides(t),t.restore()),this._drawBounds&&t===ige._ctx&&(t.save(),t.translate(-this._translate.x,-this._translate.y),this.paintAabbs(t,this._scene,0),t.restore()),this._drawMouse&&t===ige._ctx){t.save();var i,o,n,r,s=this.mousePos();t.scale(1/this.camera._scale.x,1/this.camera._scale.y),o=Math.floor(s.x*this.camera._scale.x),n=Math.floor(s.y*this.camera._scale.y),t.fillStyle="#fc00ff",t.fillRect(o-5,n-5,10,10),i=this.id()+" X: "+o+", Y: "+n,r=t.measureText(i),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(Math.floor(o-r.width/2-5),Math.floor(n-25),Math.floor(r.width+10),14),t.fillStyle="#ffffff",t.fillText(i,o-r.width/2,n-15),t.restore()}if(this._drawViewArea){t.save();var a=this.viewArea();t.rect(a.x,a.y,a.width,a.height),t.stroke(),t.restore()}}},screenPosition:function(){return new IgePoint3d(Math.floor(this._worldMatrix.matrix[2]+ige._bounds2d.x2),Math.floor(this._worldMatrix.matrix[5]+ige._bounds2d.y2),0)},drawViewArea:function(t){return void 0!==t?(this._drawViewArea=t,this):this._drawViewArea},drawBoundsLimitId:function(t){return void 0!==t?(this._drawBoundsLimitId=t,this):this._drawBoundsLimitId},drawBoundsLimitCategory:function(t){return void 0!==t?(this._drawBoundsLimitCategory=t,this):this._drawBoundsLimitCategory},drawCompositeBounds:function(t){return void 0!==t?(this._drawCompositeBounds=t,this):this._drawCompositeBounds},drawGuides:function(t){return void 0!==t?(this._drawGuides=t,this):this._drawGuides},paintGuides:function(t){var e=ige._bounds2d;this._drawGuides&&(t.strokeStyle="#ffffff",t.translate(.5,.5),t.beginPath(),t.moveTo(0,-e.y2),t.lineTo(0,e.y),t.stroke(),t.beginPath(),t.moveTo(-e.x2,0),t.lineTo(e.x,0),t.stroke())},paintAabbs:function(t,e,i){var o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b,E,T=e._children;if(T)for(o=T.length;o--;)n=T[o],i++,!1!==n._shouldRender&&(("IgeScene2d"!==n._classId&&!this._drawBoundsLimitId&&!this._drawBoundsLimitCategory||this._drawBoundsLimitId&&(this._drawBoundsLimitId instanceof Array?this._drawBoundsLimitId.indexOf(n.id())>-1:this._drawBoundsLimitId===n.id())||this._drawBoundsLimitCategory&&this._drawBoundsLimitCategory===n.category())&&"function"==typeof n.aabb&&(r=n.aabb(),this._drawCompositeBounds&&n._compositeCache&&(s=n.compositeAabb(),t.strokeStyle="#ff0000",t.strokeRect(s.x,s.y,s.width,s.height)),r&&((n._drawBounds||void 0===n._drawBounds)&&(t.strokeStyle="#00deff",t.strokeRect(r.x,r.y,r.width,r.height),n._parent&&1===n._parent._mountMode&&(a=n.bounds3dPolygon().aabb(),t.save(),t.strokeStyle="#0068b8",t.strokeRect(a.x,a.y,a.width,a.height),t.restore(),t.save(),t.translate(a.x+a.width/2,a.y+a.height/2),l=n._bounds3d,c=new IgePoint3d(-l.x/2,0,0).toIso(),u=new IgePoint3d(+l.x/2,0,0).toIso(),m=new IgePoint3d(0,-l.y/2,0).toIso(),d=new IgePoint3d(0,+l.y/2,0).toIso(),p=new IgePoint3d(0,0,-l.z/2).toIso(),_=new IgePoint3d(0,0,+l.z/2).toIso(),new IgePoint3d(-l.x/2,-l.y/2,-l.z/2).toIso(),f=new IgePoint3d(+l.x/2,-l.y/2,-l.z/2).toIso(),y=new IgePoint3d(+l.x/2,+l.y/2,-l.z/2).toIso(),g=new IgePoint3d(-l.x/2,+l.y/2,-l.z/2).toIso(),v=new IgePoint3d(-l.x/2,-l.y/2,l.z/2).toIso(),x=new IgePoint3d(+l.x/2,-l.y/2,l.z/2).toIso(),b=new IgePoint3d(+l.x/2,+l.y/2,l.z/2).toIso(),E=new IgePoint3d(-l.x/2,+l.y/2,l.z/2).toIso(),h=t.globalAlpha,t.globalAlpha=1,t.strokeStyle="#ff0000",t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(u.x,u.y),t.stroke(),t.strokeStyle="#00ff00",t.beginPath(),t.moveTo(m.x,m.y),t.lineTo(d.x,d.y),t.stroke(),t.strokeStyle="#fffc00",t.beginPath(),t.moveTo(p.x,p.y),t.lineTo(_.x,_.y),t.stroke(),t.strokeStyle="#a200ff",n._highlight?t.globalAlpha=.9:t.globalAlpha=.6,t.fillStyle="#545454",t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(g.x,g.y),t.lineTo(E.x,E.y),t.lineTo(b.x,b.y),t.lineTo(y.x,y.y),t.fill(),t.stroke(),t.fillStyle="#282828",t.beginPath(),t.moveTo(y.x,y.y),t.lineTo(f.x,f.y),t.lineTo(x.x,x.y),t.lineTo(b.x,b.y),t.lineTo(y.x,y.y),t.fill(),t.stroke(),t.fillStyle="#676767",t.beginPath(),t.moveTo(v.x,v.y),t.lineTo(x.x,x.y),t.lineTo(b.x,b.y),t.lineTo(E.x,E.y),t.lineTo(v.x,v.y),t.fill(),t.stroke(),t.globalAlpha=h,t.restore())),this._drawBoundsData&&(n._drawBounds||void 0===n._drawBoundsData)&&(t.globalAlpha=1,t.fillStyle="#f6ff00",t.fillText("ID: "+n.id()+" ("+n.classId()+") "+n.layer()+":"+n.depth().toFixed(0),r.x+r.width+3,r.y+10),t.fillText("X: "+n._translate.x.toFixed(2)+", Y: "+n._translate.y.toFixed(2)+", Z: "+n._translate.z.toFixed(2),r.x+r.width+3,r.y+20),t.fillText("Num Children: "+n._children.length,r.x+r.width+3,r.y+40)))),this.paintAabbs(t,n,i))},_resizeEvent:function(t){if(this._autoSize&&this._parent&&(this._bounds2d=this._parent._bounds2d.clone()),this._updateUiPosition(),this._scene&&this._scene._resizeEvent(t),this._lockDimension){var e,i,o=1;this._bounds2d.x>this._lockDimension.x&&this._bounds2d.y>this._lockDimension.y?(e=this._bounds2d.x/this._lockDimension.x,i=this._bounds2d.y/this._lockDimension.y,o=e<i?e:i):(this._bounds2d.x>this._lockDimension.x&&this._bounds2d.y<this._lockDimension.y&&(o=this._bounds2d.y/this._lockDimension.y),this._bounds2d.x<this._lockDimension.x&&this._bounds2d.y>this._lockDimension.y&&(o=this._bounds2d.x/this._lockDimension.x),this._bounds2d.x<this._lockDimension.x&&this._bounds2d.y<this._lockDimension.y&&(e=this._bounds2d.x/this._lockDimension.x,i=this._bounds2d.y/this._lockDimension.y,o=e<i?e:i)),this.camera.scaleTo(o,o,o)}},_stringify:function(){var t,e=IgeEntity.prototype._stringify.call(this);for(t in this)if(this.hasOwnProperty(t)&&void 0!==this[t])switch(t){case"_autoSize":e+=".autoSize("+this._autoSize+")";break;case"_scene":e+=".scene(ige.$('"+this.scene().id()+"'))"}return e}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeViewport);var IgeScene2d=IgeEntity.extend({classId:"IgeScene2d",init:function(){this._mouseAlwaysInside=!0,this._alwaysInView=!0,IgeEntity.prototype.init.call(this),this._shouldRender=!0,this._autoSize=!0,this._bounds2d.x=ige._bounds2d.x,this._bounds2d.y=ige._bounds2d.y,this.streamSections(["transform","ignoreCamera"])},streamRoomId:function(t){return void 0!==t?(this._streamRoomId=t,this):this._streamRoomId},streamSectionData:function(t,e){switch(t){case"ignoreCamera":if(void 0===e)return String(this._ignoreCamera);"false"===e?this.ignoreCamera(!1):this.ignoreCamera(!0);break;default:IgeEntity.prototype.streamSectionData.call(this,t,e)}},autoSize:function(t){return void 0!==t?(this._autoSize=t,this):this._autoSize},shouldRender:function(t){return void 0!==t?(this._shouldRender=t,this):this._shouldRender},ignoreCamera:function(t){return void 0!==t?(this._ignoreCamera=t,this):this._ignoreCamera},update:function(t,e){if(this._ignoreCamera){var i=ige._currentCamera;this.translateTo(i._translate.x,i._translate.y,i._translate.z),this.scaleTo(1/i._scale.x,1/i._scale.y,1/i._scale.z),this.rotateTo(-i._rotate.x,-i._rotate.y,-i._rotate.z)}IgeEntity.prototype.update.call(this,t,e)},tick:function(t){this._shouldRender&&IgeEntity.prototype.tick.call(this,t)},_resizeEvent:function(t){this._autoSize&&(this._bounds2d=ige._bounds2d.clone());for(var e=this._children,i=e.length;i--;)e[i]._resizeEvent(t)},_stringify:function(){var t,e=IgeEntity.prototype._stringify.call(this);for(t in this)if(this.hasOwnProperty(t)&&void 0!==this[t])switch(t){case"_shouldRender":e+=".shouldRender("+this.shouldRender()+")";break;case"_autoSize":e+=".autoSize("+this.autoSize()+")"}return e}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeScene2d);var IgeQuest=IgeEventingClass.extend({classId:"IgeQuest",init:function(t,e){this._linear=!1,this._items=[],this._itemCount=0,this._eventCount=0,this._itemCompleteCount=0,this._eventCompleteCount=0,this._started=!1,this._isComplete=!1,void 0!==t&&this.items(t),void 0!==e&&(this._completeCallback=e)},complete:function(t){return void 0!==t?(this._completeCallback=t,this):this._completeCallback},isComplete:function(t){return void 0!==t?(this._isComplete=t,this):this._isComplete},linear:function(t){return void 0!==t?(this._linear=t,this):this._linear},items:function(t){if(void 0!==t){this._items=t;var e,i=this._items,o=i.length,n=0;for(e=0;e<o;e++)n+=i[e].count;return this._eventCount=n,this._itemCount=o,this}return this._items},itemCount:function(){return this._itemCount},eventCount:function(){return this._eventCount},eventCompleteCount:function(){return this._eventCompleteCount},itemCompleteCount:function(){return this._itemCompleteCount},percentComplete:function(){return Math.floor(100/this._eventCount*this._eventCompleteCount)},start:function(){if(this._started)this.log("Cannot start quest because it has already been started!","warning"),this.emit("alreadyStarted");else{var t,e=this._items,i=e.length;if(this._started=!0,this._linear)this._setupItemListener(e[0]);else for(t=0;t<i;t++)this._setupItemListener(e[t]);this.emit("started")}return this},stop:function(){return this._started?(this._started=!1,this.emit("stopped")):(this.log("Cannot stop quest because it has not been started yet!","warning"),this.emit("notStarted")),this},reset:function(){var t,e,i=this._items,o=i.length;for(t=0;t<o;t++)e=i[t],e._complete=!1,e._eventCount=0,e._listener&&e.emitter.off(e.eventName,e._listener),delete e._listener;return this._eventCompleteCount=0,this._itemCompleteCount=0,this._isComplete=!1,this.emit("reset"),this},_setupItemListener:function(t){var e=this;t._listener||(t._eventCount=0,t._complete=!1,t._listener=t.emitter.on(t.eventName,function(){e._started&&(t.eventEvaluate?t.eventEvaluate.apply(e,arguments)&&e._eventComplete(t):e._eventComplete(t))}))},_eventComplete:function(t){t._eventCount++,this._eventCompleteCount++,t.eventCallback&&t.eventCallback.apply(this,t),this.emit("eventComplete",t),t._eventCount===t.count&&this._itemComplete(t)},_itemComplete:function(t){var e,i=this._items;t._complete=!0,t.emitter.off(t.eventName,t._listener),delete t._listener,this._itemCompleteCount++,t.itemCallback&&t.itemCallback.apply(this,t),this.emit("itemComplete",t),this._update(),this._started&&this._linear&&this._itemCompleteCount<this.itemCount()&&(e=i.indexOf(t),this._setupItemListener(i[e+1]),this.emit("nextItem",i[e+1]))},_update:function(){this._itemCompleteCount===this.itemCount()&&(this._isComplete=!0,this._completeCallback.apply(this),this.emit("complete"),this.stop(),this.reset())}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeQuest);var IgeInterval=IgeEventingClass.extend({classId:"IgeInterval",init:function(t,e){this._method=t,this._interval=e,this._time=0,this._started=ige._currentTime,ige.time.addTimer(this)},addTime:function(t){return this._time+=t,this},cancel:function(){return ige.time.removeTimer(this),this},update:function(){return this._time>this._interval&&(this._method(ige._currentTime),this._time-=this._interval),this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeInterval);var IgeTimeout=IgeInterval.extend({classId:"IgeTimeout",init:function(t,e){IgeInterval.prototype.init.call(this,t,e)},cancel:function(){return IgeInterval.prototype.cancel.call(this)},reset:function(){this._time=0,-1==ige.time._timers.indexOf(this)&&ige.time.addTimer(this)},update:function(){return this._time>this._interval&&(this._method(ige._currentTime),ige.time.removeTimer(this)),this}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeTimeout);var IgeCuboidSmartTexture={render:function(t,e){var i=e.localIsoBoundsPoly();t.strokeStyle="#a200ff",i.render(t)}},IgeCuboid=IgeEntity.extend({classId:"IgeCuboid",init:function(){IgeEntity.prototype.init.call(this),this.bounds3d(40,40,40);var t=new IgeTexture(IgeCuboidSmartTexture);this.texture(t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeCuboid);var IgeArray=function(){};IgeArray.prototype=[];for(var methodName in IgeEntity.prototype)IgeEntity.prototype.hasOwnProperty(methodName)&&"init"!==methodName&&(IgeArray.prototype[methodName]=function(t){return function(){for(var e=this.length,i=0;i<e;i++)this[i][t].apply(this[i],arguments)}}(methodName));"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeArray);var IgeAudioComponent=IgeEventingClass.extend({classId:"IgeAudioComponent",componentId:"audio",init:function(t,e){if(this._active=!1,this._disabled=!1,this._ctx=this.getContext(),!this._ctx)return this.log("No web audio API support, cannot play sounds!","warning"),void(this._disabled=!0);this.log("Web audio API connected successfully")},active:function(t){return void 0===t||this._disabled?this._active:(this._active=t,this)},getContext:function(){var t=window.AudioContext||window.webkitAudioContext;return t?new t:void 0},load:function(t,e){var i=new IgeAudio(t);e&&i.id(e)},decode:function(t,e){this._ctx.decodeAudioData(t,function(t){e(!1,t)},function(t){e(t)})},play:function(t){var e=ige.$(t);e&&(e.prototype.play?e.play():this.log('Trying to play audio with id "" but object with this id is not an IgeAudio instance, or does not implement the .play() method!',"warnign"))}}),IgeAudio=IgeEventingClass.extend({classId:"IgeAudio",init:function(t){t&&this.load(t)},id:function(t){if(void 0!==t){if(!ige._register[t])return this._id&&ige._register[this._id]&&ige.unRegister(this),this._id=t,ige.register(this),this;if(ige._register[t]===this)return this;this.log('Cannot set ID of object to "'+t+'" because that ID is already in use by another object!',"error")}return this._id||(this._url?this._id=ige.newIdFromString(this._url):this._id=ige.newIdHex(),ige.register(this)),this._id},load:function(t,e){var i=this,o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){i._data=o.response,i._url=t,i._loaded(e)},o.onerror=function(t){e.apply(i,[t])},o.send()},_loaded:function(t){var e=this;ige.audio.decode(e._data,function(i,o){i?(e.log("Failed to decode audio data from: "+e._url,"warning"),t&&t.apply(e,[i])):(e._buffer=o,ige.audio.log("Audio file ("+e._url+") loaded successfully"),t&&t.apply(e,[!1]))})},play:function(){var t,e=this;e._buffer&&(t=ige.audio._ctx.createBufferSource(),t.buffer=e._buffer,t.connect(ige.audio._ctx.destination),t.start(0))}}),IgeBox2dComponent=IgeEventingClass.extend({classId:"IgeBox2dComponent",componentId:"box2d",init:function(t,e){0!==ige._state&&this.log("Cannot add box2d component to the ige instance once the engine has started!","error"),this._entity=t,this._options=e,this._mode=0,this.b2Color=Box2D.Common.b2Color,this.b2Vec2=Box2D.Common.Math.b2Vec2,this.b2Math=Box2D.Common.Math.b2Math,this.b2Shape=Box2D.Collision.Shapes.b2Shape,this.b2BodyDef=Box2D.Dynamics.b2BodyDef,this.b2Body=Box2D.Dynamics.b2Body,this.b2FixtureDef=Box2D.Dynamics.b2FixtureDef,this.b2Fixture=Box2D.Dynamics.b2Fixture,this.b2World=Box2D.Dynamics.b2World,this.b2MassData=Box2D.Collision.Shapes.b2MassData,this.b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,this.b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,this.b2DebugDraw=Box2D.Dynamics.b2DebugDraw,this.b2ContactListener=Box2D.Dynamics.b2ContactListener,this.b2Distance=Box2D.Collision.b2Distance,this.b2Contact=Box2D.Dynamics.Contacts.b2Contact,this.b2FilterData=Box2D.Dynamics.b2FilterData,this.b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef,this.b2Contact.prototype.igeEntityA=function(){var t=this.m_fixtureA.m_body._entity;return t._box2dOurContactFixture=this.m_fixtureA,t._box2dTheirContactFixture=this.m_fixtureB,t},this.b2Contact.prototype.igeEntityB=function(){var t=this.m_fixtureB.m_body._entity;return t._box2dOurContactFixture=this.m_fixtureB,t._box2dTheirContactFixture=this.m_fixtureA,t},this.b2Contact.prototype.igeEitherId=function(t,e){return e?!(this.m_fixtureA.m_body._entity._id!==t&&this.m_fixtureB.m_body._entity._id!==t||this.m_fixtureA.m_body._entity._id!==e&&this.m_fixtureB.m_body._entity._id!==e):this.m_fixtureA.m_body._entity._id===t||this.m_fixtureB.m_body._entity._id===t},this.b2Contact.prototype.igeEitherCategory=function(t,e){return e?!(this.m_fixtureA.m_body._entity._category!==t&&this.m_fixtureB.m_body._entity._category!==t||this.m_fixtureA.m_body._entity._category!==e&&this.m_fixtureB.m_body._entity._category!==e):this.m_fixtureA.m_body._entity._category===t||this.m_fixtureB.m_body._entity._category===t},this.b2Contact.prototype.igeBothCategories=function(t){return this.m_fixtureA.m_body._entity._category===t&&this.m_fixtureB.m_body._entity._category===t},this.b2Contact.prototype.igeEntityByCategory=function(t){return this.m_fixtureA.m_body._entity._category===t?this.igeEntityA():this.m_fixtureB.m_body._entity._category===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeEntityById=function(t){return this.m_fixtureA.m_body._entity._id===t?this.igeEntityA():this.m_fixtureB.m_body._entity._id===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeEntityByFixtureId=function(t){return this.m_fixtureA.igeId===t?this.igeEntityA():this.m_fixtureB.igeId===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeOtherEntity=function(t){return this.m_fixtureA.m_body._entity===t?this.igeEntityB():this.igeEntityA()},this._sleep=!0,this._scaleRatio=30,this._gravity=new this.b2Vec2(0,0),this._removeWhenReady=[],this.log("Physics component initiated!")},useWorker:function(t){if("undefined"!=typeof Worker)return void 0!==t?(this._useWorker=t,this._entity):this._useWorker;this.log("Web workers were not detected on this browser. Cannot access useWorker() method.","warning")},mode:function(t){return void 0!==t?(this._mode=t,this._entity):this._mode},sleep:function(t){return void 0!==t?(this._sleep=t,this._entity):this._sleep},scaleRatio:function(t){return void 0!==t?(this._scaleRatio=t,this._entity):this._scaleRatio},gravity:function(t,e){return void 0!==t&&void 0!==e?(this._gravity=new this.b2Vec2(t,e),this._entity):this._gravity},world:function(){return this._world},createWorld:function(t,e){return this._world=new this.b2World(this._gravity,this._sleep),this.log("World created"),this._entity},createFixture:function(t){var e,i=new this.b2FixtureDef;for(e in t)t.hasOwnProperty(e)&&"shape"!==e&&"filter"!==e&&(i[e]=t[e]);return i},createBody:function(t,e){var i,o,n,r,s,a,h,l,c,u,m,d,p=new this.b2BodyDef;switch(e.type){case"static":p.type=this.b2Body.b2_staticBody;break;case"dynamic":p.type=this.b2Body.b2_dynamicBody;break;case"kinematic":p.type=this.b2Body.b2_kinematicBody}for(i in e)if(e.hasOwnProperty(i))switch(i){case"type":case"gravitic":case"fixedRotation":case"fixtures":break;default:p[i]=e[i]}p.position=new this.b2Vec2(t._translate.x/this._scaleRatio,t._translate.y/this._scaleRatio),o=this._world.CreateBody(p);for(i in e)if(e.hasOwnProperty(i))switch(i){case"gravitic":e.gravitic||(o.m_nonGravitic=!0);break;case"fixedRotation":e.fixedRotation&&o.SetFixedRotation(!0);break;case"fixtures":if(e.fixtures&&e.fixtures.length)for(l=0;l<e.fixtures.length;l++){if(n=e.fixtures[l],r=this.createFixture(n),r.igeId=n.igeId,n.shape){switch(n.shape.type){case"circle":a=new this.b2CircleShape,n.shape.data&&void 0!==n.shape.data.radius?a.SetRadius(n.shape.data.radius/this._scaleRatio):a.SetRadius(t._bounds2d.x/this._scaleRatio/2),n.shape.data&&(c=void 0!==n.shape.data.x?n.shape.data.x:0,u=void 0!==n.shape.data.y?n.shape.data.y:0,a.SetLocalPosition(new this.b2Vec2(c/this._scaleRatio,u/this._scaleRatio)));break;case"polygon":a=new this.b2PolygonShape,a.SetAsArray(n.shape.data._poly,n.shape.data.length());break;case"rectangle":a=new this.b2PolygonShape,n.shape.data?(c=void 0!==n.shape.data.x?n.shape.data.x:0,u=void 0!==n.shape.data.y?n.shape.data.y:0,m=void 0!==n.shape.data.width?n.shape.data.width:t._bounds2d.x/2,d=void 0!==n.shape.data.height?n.shape.data.height:t._bounds2d.y/2):(c=0,u=0,m=t._bounds2d.x/2,d=t._bounds2d.y/2),a.SetAsOrientedBox(m/this._scaleRatio,d/this._scaleRatio,new this.b2Vec2(c/this._scaleRatio,u/this._scaleRatio),0)}a&&(r.shape=a,s=o.CreateFixture(r),s.igeId=r.igeId)}n.filter&&s&&(h=new this._entity.box2d.b2FilterData,void 0!==n.filter.categoryBits&&(h.categoryBits=n.filter.categoryBits),void 0!==n.filter.maskBits&&(h.maskBits=n.filter.maskBits),void 0!==n.filter.categoryIndex&&(h.categoryIndex=n.filter.categoryIndex),s.SetFilterData(h)),void 0!==n.density&&s&&s.SetDensity(n.density)}else this.log("Box2D body has no fixtures, have you specified fixtures correctly? They are supposed to be an array of fixture objects.","warning")}return o._entity=t,o},staticsFromMap:function(t,e){if(t.map){var i,o,n,r,s,a=t.tileWidth(),h=t.tileHeight();for(n=t.scanRects(e),r=n.length;r--;)s=n[r],i=a*(s.width/2),o=h*(s.height/2),(new IgeEntityBox2d).translateTo(s.x*a+i,s.y*h+o,0).width(s.width*a).height(s.height*h).drawBounds(!0).drawBoundsData(!1).box2dBody({type:"static",allowSleep:!0,fixtures:[{shape:{type:"rectangle"}}]})
}else this.log("Cannot extract box2d static bodies from map data because passed map does not have a .map property!","error")},contactListener:function(t,e,i,o){var n=new this.b2ContactListener;void 0!==t&&(n.BeginContact=t),void 0!==e&&(n.EndContact=e),void 0!==i&&(n.PreSolve=i),void 0!==o&&(n.PostSolve=o),this._world.SetContactListener(n)},networkDebugMode:function(t){return void 0!==t?(this._networkDebugMode=t,!0===t?this.contactListener(function(t){},function(t){},function(t){t.SetEnabled(!1)},function(t){}):this.contactListener(),this._entity):this._networkDebugMode},enableDebug:function(t){if(t){var e=new this.b2DebugDraw;this._box2dDebug=!0,e.SetSprite(ige._ctx),e.SetDrawScale(this._scaleRatio),e.SetFillAlpha(.3),e.SetLineThickness(1),e.SetFlags(this.b2DebugDraw.e_controllerBit|this.b2DebugDraw.e_jointBit|this.b2DebugDraw.e_pairBit|this.b2DebugDraw.e_shapeBit),this._world.SetDebugDraw(e),new igeClassStore.IgeBox2dDebugPainter(this._entity).depth(4e4).drawBounds(!1).mount(t)}else this.log("Cannot enable box2d debug drawing because the passed argument is not an object on the scenegraph.","error")},destroyBody:function(t){this._removeWhenReady.push(t)},updateCallback:function(t){return void 0!==t?(this._updateCallback=t,this._entity):this._updateCallback},start:function(){this._active||(this._active=!0,this._networkDebugMode||(0===this._mode?this._entity.addBehaviour("box2dStep",this._behaviour):this._intervalTimer=setInterval(this._behaviour,1e3/60)))},stop:function(){this._active&&(this._active=!1,0===this._mode?this._entity.removeBehaviour("box2dStep"):clearInterval(this._intervalTimer))},_behaviour:function(t){var e,i,o,n,r,s,a=this.box2d;if(a._active&&a._world){if(!a._world.IsLocked()&&(n=a._removeWhenReady,r=n.length)){for(s=a._world.DestroyBody;r--;)s.apply(a._world,[n[r]]);a._removeWhenReady=[],n=null}for(0===a._mode?a._world.Step(ige._tickDelta/1e3,8,3):a._world.Step(1/60,8,3),e=a._world.GetBodyList();e;)e._entity&&(i=e._entity,o=i._box2dBody,e.IsAwake()&&0!==e.m_type?(o.updating=!0,i.translateTo(e.m_xf.position.x*a._scaleRatio,e.m_xf.position.y*a._scaleRatio,i._translate.z),i.rotateTo(i._rotate.x,i._rotate.y,e.GetAngle()),o.updating=!1,o.asleep&&(o.asleep=!1,a.emit("afterAwake",i))):o.asleep||(o.asleep=!0,a.emit("afterAsleep",i))),e=e.GetNext();a._world.ClearForces(),e=null,i=null,"function"==typeof a._updateCallback&&a._updateCallback()}},destroy:function(){this._entity.removeBehaviour("box2dStep")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeBox2dComponent);var IgeBox2dMultiWorldComponent=IgeEventingClass.extend({classId:"IgeBox2dMultiWorldComponent",componentId:"box2d",init:function(t,e){this._entity=t,this._options=e,this._worlds={},this.b2Color=Box2D.Common.b2Color,this.b2Vec2=Box2D.Common.Math.b2Vec2,this.b2Math=Box2D.Common.Math.b2Math,this.b2Shape=Box2D.Collision.Shapes.b2Shape,this.b2BodyDef=Box2D.Dynamics.b2BodyDef,this.b2Body=Box2D.Dynamics.b2Body,this.b2FixtureDef=Box2D.Dynamics.b2FixtureDef,this.b2Fixture=Box2D.Dynamics.b2Fixture,this.b2World=Box2D.Dynamics.b2World,this.b2MassData=Box2D.Collision.Shapes.b2MassData,this.b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,this.b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,this.b2DebugDraw=Box2D.Dynamics.b2DebugDraw,this.b2ContactListener=Box2D.Dynamics.b2ContactListener,this.b2Distance=Box2D.Collision.b2Distance,this.b2Contact=Box2D.Dynamics.Contacts.b2Contact,this.b2FilterData=Box2D.Dynamics.b2FilterData,this.b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef,this.b2Contact.prototype.igeEntityA=function(){var t=this.m_fixtureA.m_body._entity;return t._box2dOurContactFixture=this.m_fixtureA,t._box2dTheirContactFixture=this.m_fixtureB,t},this.b2Contact.prototype.igeEntityB=function(){var t=this.m_fixtureB.m_body._entity;return t._box2dOurContactFixture=this.m_fixtureB,t._box2dTheirContactFixture=this.m_fixtureA,t},this.b2Contact.prototype.igeEitherId=function(t,e){return e?!(this.m_fixtureA.m_body._entity._id!==t&&this.m_fixtureB.m_body._entity._id!==t||this.m_fixtureA.m_body._entity._id!==e&&this.m_fixtureB.m_body._entity._id!==e):this.m_fixtureA.m_body._entity._id===t||this.m_fixtureB.m_body._entity._id===t},this.b2Contact.prototype.igeEitherCategory=function(t,e){return e?!(this.m_fixtureA.m_body._entity._category!==t&&this.m_fixtureB.m_body._entity._category!==t||this.m_fixtureA.m_body._entity._category!==e&&this.m_fixtureB.m_body._entity._category!==e):this.m_fixtureA.m_body._entity._category===t||this.m_fixtureB.m_body._entity._category===t},this.b2Contact.prototype.igeBothCategories=function(t){return this.m_fixtureA.m_body._entity._category===t&&this.m_fixtureB.m_body._entity._category===t},this.b2Contact.prototype.igeEntityByCategory=function(t){return this.m_fixtureA.m_body._entity._category===t?this.igeEntityA():this.m_fixtureB.m_body._entity._category===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeEntityById=function(t){return this.m_fixtureA.m_body._entity._id===t?this.igeEntityA():this.m_fixtureB.m_body._entity._id===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeEntityByFixtureId=function(t){return this.m_fixtureA.igeId===t?this.igeEntityA():this.m_fixtureB.igeId===t?this.igeEntityB():void 0},this.b2Contact.prototype.igeOtherEntity=function(t){return this.m_fixtureA.m_body._entity===t?this.igeEntityB():this.igeEntityA()},this.log("Physics component initiated!")},world:function(t){return this._worlds[t]},createWorld:function(t){var e;return t=t||{},t.id=t.id||ige.newIdHex(),t.gravity=t.gravity||new this.b2Vec2(0,0),t.sleep=void 0===t.sleep||t.sleep,this._worlds[t.id]=e=new IgeBox2dWorld(this,t),e}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeBox2dMultiWorldComponent);var IgeBox2dWorld=IgeEventingClass.extend({classId:"IgeBox2dWorld",init:function(t,e){this.b2Color=Box2D.Common.b2Color,this.b2Vec2=Box2D.Common.Math.b2Vec2,this.b2Math=Box2D.Common.Math.b2Math,this.b2Shape=Box2D.Collision.Shapes.b2Shape,this.b2BodyDef=Box2D.Dynamics.b2BodyDef,this.b2Body=Box2D.Dynamics.b2Body,this.b2FixtureDef=Box2D.Dynamics.b2FixtureDef,this.b2Fixture=Box2D.Dynamics.b2Fixture,this.b2World=Box2D.Dynamics.b2World,this.b2MassData=Box2D.Collision.Shapes.b2MassData,this.b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,this.b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,this.b2DebugDraw=Box2D.Dynamics.b2DebugDraw,this.b2ContactListener=Box2D.Dynamics.b2ContactListener,this.b2Distance=Box2D.Collision.b2Distance,this.b2Contact=Box2D.Dynamics.Contacts.b2Contact,this.b2FilterData=Box2D.Dynamics.b2FilterData,this.b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef,this._entity=t,e=e||{id:ige.newIdHex(),gravity:new this.b2Vec2(0,0),sleep:!0},this._id=e.id,this._sleep=e.sleep,this._scaleRatio=void 0!==e.scaleRatio?e.scaleRatio:30,this._gravity=e.gravity,this._mode=0,this._removeWhenReady=[],this._world=new this.b2World(e.gravity,e.sleep)},createFixture:function(t){var e,i=new this.b2FixtureDef;for(e in t)t.hasOwnProperty(e)&&"shape"!==e&&"filter"!==e&&(i[e]=t[e]);return i},createBody:function(t,e){var i,o,n,r,s,a,h,l,c,u,m,d,p=new this.b2BodyDef;switch(e.type){case"static":p.type=this.b2Body.b2_staticBody;break;case"dynamic":p.type=this.b2Body.b2_dynamicBody;break;case"kinematic":p.type=this.b2Body.b2_kinematicBody}for(i in e)if(e.hasOwnProperty(i))switch(i){case"type":case"gravitic":case"fixedRotation":case"fixtures":break;default:p[i]=e[i]}p.position=new this.b2Vec2(t._translate.x/this._scaleRatio,t._translate.y/this._scaleRatio),o=this._world.CreateBody(p);for(i in e)if(e.hasOwnProperty(i))switch(i){case"gravitic":e.gravitic||(o.m_nonGravitic=!0);break;case"fixedRotation":e.fixedRotation&&o.SetFixedRotation(!0);break;case"fixtures":if(e.fixtures&&e.fixtures.length)for(l=0;l<e.fixtures.length;l++){if(n=e.fixtures[l],r=this.createFixture(n),r.igeId=n.igeId,n.shape){switch(n.shape.type){case"circle":a=new this.b2CircleShape,n.shape.data&&void 0!==n.shape.data.radius?a.SetRadius(n.shape.data.radius/this._scaleRatio):a.SetRadius(t._bounds2d.x/this._scaleRatio/2),n.shape.data&&(c=void 0!==n.shape.data.x?n.shape.data.x:0,u=void 0!==n.shape.data.y?n.shape.data.y:0,a.SetLocalPosition(new this.b2Vec2(c/this._scaleRatio,u/this._scaleRatio)));break;case"polygon":a=new this.b2PolygonShape,a.SetAsArray(n.shape.data._poly,n.shape.data.length());break;case"rectangle":a=new this.b2PolygonShape,n.shape.data?(c=void 0!==n.shape.data.x?n.shape.data.x:0,u=void 0!==n.shape.data.y?n.shape.data.y:0,m=void 0!==n.shape.data.width?n.shape.data.width:t._bounds2d.x/2,d=void 0!==n.shape.data.height?n.shape.data.height:t._bounds2d.y/2):(c=0,u=0,m=t._bounds2d.x/2,d=t._bounds2d.y/2),a.SetAsOrientedBox(m/this._scaleRatio,d/this._scaleRatio,new this.b2Vec2(c/this._scaleRatio,u/this._scaleRatio),0)}a&&(r.shape=a,s=o.CreateFixture(r),s.igeId=r.igeId)}n.filter&&s&&(h=new this.b2FilterData,void 0!==n.filter.categoryBits&&(h.categoryBits=n.filter.categoryBits),void 0!==n.filter.maskBits&&(h.maskBits=n.filter.maskBits),void 0!==n.filter.categoryIndex&&(h.categoryIndex=n.filter.categoryIndex),s.SetFilterData(h)),void 0!==n.density&&s&&s.SetDensity(n.density)}else this.log("Box2D body has no fixtures, have you specified fixtures correctly? They are supposed to be an array of fixture objects.","warning")}return o._entity=t,o},staticsFromMap:function(t,e){if(t.map){var i,o,n,r,s,a=t.tileWidth(),h=t.tileHeight();for(n=t.scanRects(e),r=n.length;r--;)s=n[r],i=a*(s.width/2),o=h*(s.height/2),(new IgeEntityBox2d).translateTo(s.x*a+i,s.y*h+o,0).width(s.width*a).height(s.height*h).drawBounds(!0).drawBoundsData(!1).box2dBody({type:"static",allowSleep:!0,fixtures:[{shape:{type:"rectangle"}}]})}else this.log("Cannot extract box2d static bodies from map data because passed map does not have a .map property!","error")},contactListener:function(t,e,i,o){var n=new this.b2ContactListener;void 0!==t&&(n.BeginContact=t),void 0!==e&&(n.EndContact=e),void 0!==i&&(n.PreSolve=i),void 0!==o&&(n.PostSolve=o),this._world.SetContactListener(n)},networkDebugMode:function(t){return void 0!==t?(this._networkDebugMode=t,!0===t?this.contactListener(function(t){},function(t){},function(t){t.SetEnabled(!1)},function(t){}):this.contactListener(),this):this._networkDebugMode},enableDebug:function(t){if(t){var e=new this.b2DebugDraw;this._box2dDebug=!0,e.SetSprite(ige._ctx),e.SetDrawScale(this._scaleRatio),e.SetFillAlpha(.3),e.SetLineThickness(1),e.SetFlags(this.b2DebugDraw.e_controllerBit|this.b2DebugDraw.e_jointBit|this.b2DebugDraw.e_pairBit|this.b2DebugDraw.e_shapeBit),this._world.SetDebugDraw(e),(new igeClassStore.IgeBox2dDebugPainter).depth(4e4).drawBounds(!1).mount(t)}else this.log("Cannot enable box2d debug drawing because the passed argument is not an object on the scenegraph.","error")},destroyBody:function(t){this._removeWhenReady.push(t)},updateCallback:function(t){return void 0!==t?(this._updateCallback=t,this):this._updateCallback},start:function(){var t=this;this._active||(this._active=!0,this._networkDebugMode||(0===this._mode?ige.addBehaviour("box2dStep_"+t._id,function(){t._behaviour.apply(t,arguments)}):this._intervalTimer=setInterval(function(){t._behaviour.apply(t,arguments)},1e3/60)))},stop:function(){this._active&&(this._active=!1,0===this._mode?ige.removeBehaviour("box2dStep_"+this._id):clearInterval(this._intervalTimer))},_behaviour:function(t){var e,i,o,n,r,s,a=this;if(a._active&&a._world){if(!a._world.IsLocked()&&(n=a._removeWhenReady,r=n.length)){for(s=a._world.DestroyBody;r--;)s.apply(a._world,[n[r]]);a._removeWhenReady=[],n=null}for(0===a._mode?a._world.Step(ige._tickDelta/1e3,8,3):a._world.Step(1/60,8,3),e=a._world.GetBodyList();e;)e._entity&&(i=e._entity,o=i._box2dBody,e.IsAwake()&&0!==e.m_type?(o.updating=!0,i.translateTo(e.m_xf.position.x*i._b2dRef._scaleRatio,e.m_xf.position.y*i._b2dRef._scaleRatio,i._translate.z),i.rotateTo(i._rotate.x,i._rotate.y,e.GetAngle()),o.updating=!1,o.asleep&&(o.asleep=!1,a.emit("afterAwake",i))):o.asleep||(o.asleep=!0,a.emit("afterAsleep",i))),e=e.GetNext();a._world.ClearForces(),e=null,i=null,"function"==typeof a._updateCallback&&a._updateCallback()}},destroy:function(){this.removeBehaviour("box2dStep")}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeBox2dWorld);var IgeBox2dDebugPainter=IgeObject.extend({classId:"IgeBox2dDebugPainter",init:function(t,e){IgeObject.prototype.init.call(this),this._entity=t,this._options=e},tick:function(t){this._parent&&1===this._parent.isometricMounts()&&(t.scale(1.414,.707),t.rotate(45*Math.PI/180)),this._entity.box2d._world.DrawDebugData(),IgeObject.prototype.tick.call(this,t)}}),IgeEntityBox2d=IgeEntity.extend({classId:"IgeEntityBox2d",init:function(t){IgeEntity.prototype.init.call(this),t?("string"==typeof t&&(t=ige.box2d.world(t)),this._box2dWorld=t,this._b2dRef=t):this._b2dRef=ige.box2d,ige.box2d&&(this._b2dRef._networkDebugMode?(this._translateToProto=function(){},this._translateByProto=function(){},this._rotateToProto=function(){},this._rotateByProto=function(){},this._updateProto=this.update,this.update=this._update):(this._translateToProto=this.translateTo,this._translateByProto=this.translateBy,this._rotateToProto=this.rotateTo,this._rotateByProto=this.rotateBy,this.translateTo=this._translateTo,this.translateBy=this._translateBy,this.rotateTo=this._rotateTo,this.rotateBy=this._rotateBy))},box2dActive:function(t){return this._box2dBody?void 0!==t?(this._box2dBody.SetActive(t),this):this._box2dBody.IsActive():this},box2dBody:function(t){return void 0!==t?(this._box2dBodyDef=t,ige.box2d?this._box2dBody=this._b2dRef.createBody(this,t):this.log("You are trying to create a box2d entity but you have not added the box2d component to the ige instance!","error"),this):this._box2dBodyDef},gravitic:function(t){if(this._box2dBody)return void 0!==t?(this._box2dBody.m_nonGravitic=!t,this._box2dBodyDef.gravitic=t,this._box2dBody.SetAwake(!0),this):!this._box2dBody.m_nonGravitic},on:function(){if(3===arguments.length){var t,e=arguments[0],i=arguments[1],o=arguments[2];switch(i.substr(0,1)){case"#":t=0;break;case".":t=1}switch(i=i.substr(1,i.length-1),e){case"collisionStart":this._collisionStartListeners=this._collisionStartListeners||[],this._collisionStartListeners.push({type:t,target:i,callback:o}),this._contactListener||(this._contactListener=this._setupContactListeners());break;case"collisionEnd":this._collisionEndListeners=this._collisionEndListeners||[],this._collisionEndListeners.push({type:t,target:i,callback:o}),this._contactListener||(this._contactListener=this._setupContactListeners());break;default:this.log("Cannot add event listener, event type "+e+" not recognised","error")}}else IgeEntity.prototype.on.apply(this,arguments)},off:function(){3===arguments.length||IgeEntity.prototype.off.apply(this,arguments)},_setupContactListeners:function(){var t=this;ige.box2d.contactListener(function(e){var i=t._collisionStartListeners;i&&t._checkContact(e,i)},function(e){var i=t._collisionEndListeners;i&&t._checkContact(e,i)})},_checkContact:function(t,e){var i,o,n,r=this,s=e.length;if(t.igeEntityA()._id===r._id)i=t.igeEntityB();else{if(t.igeEntityB()._id!==r._id)return;i=t.igeEntityA()}for(n=0;n<s;n++)o=e[n],0===o.type&&i._id===o.target&&o.callback(t),1===e[n].type&&i._category===o.target&&o.callback(t)},_translateTo:function(t,e,i){var o=this._box2dBody;return this._translateToProto(t,e,i),o&&!o.updating&&(o.SetPosition({x:t/this._b2dRef._scaleRatio,y:e/this._b2dRef._scaleRatio}),o.SetAwake(!0)),this},_translateBy:function(t,e,i){this._translateTo(this._translate.x+t,this._translate.y+e,this._translate.z+i)},_rotateTo:function(t,e,i){var o=this._box2dBody;return this._rotateToProto(t,e,i),o&&!o.updating&&(o.SetAngle(i),o.SetAwake(!0)),this},_rotateBy:function(t,e,i){this._rotateTo(this._rotate.x+t,this._rotate.y+e,this._rotate.z+i)},_update:function(t){this._updateProto(t),this._translateTo(this._translate.x,this._translate.y,this._translate.z),this._rotateTo(this._rotate.x,this._rotate.y,this._rotate.z)},box2dNoDebug:function(t){return void 0!==t?(this._box2dNoDebug=t,this):this._box2dNoDebug},destroy:function(){this._box2dBody&&this._b2dRef.destroyBody(this._box2dBody),IgeEntity.prototype.destroy.call(this)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeEntityBox2d);var IgeEntityCannon=IgeEntity.extend({classId:"IgeEntityCannon",init:function(){IgeEntity.prototype.init.call(this),this._translateToProto=this.translateTo,this._translateByProto=this.translateBy,this.translateTo=this._translateTo,this.translateBy=this._translateBy},cannonBody:function(t){return void 0!==t?(this._cannonBodyDef=t,this._cannonBody=ige.cannon.createBody(this,t),this):this._cannonBodyDef},_translateTo:function(t,e,i){var o=this._cannonBody,n=ige.cannon._scaleRatio;return o&&!o._igeUpdating&&(o.position.x=t/n,o.position.y=e/n,o.position.z=(i+this._bounds3d.z2)/n),this._translateToProto(t,e,i),this},_translateBy:function(t,e,i){this._translateTo(this._translate.x+t,this._translate.y+e,this._translate.z+i)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeEntityCannon);var IgeUiDropDown=IgeUiElement.extend({classId:"IgeUiDropDown",init:function(){var t=this;IgeUiElement.prototype.init.call(this),ige.ui.style(".IgeUiDropDownOption")||(ige.ui.style(".IgeUiDropDownOption",{backgroundColor:null}),ige.ui.style(".IgeUiDropDownOption:hover",{backgroundColor:"#00b4ff",color:"#ffffff"})),this.borderColor("#000000"),this.borderWidth(1),this.backgroundColor("#ffffff"),this.color("#000000"),this.width(200),this.height(30),this._options=[],this._toggleState=!1,this._label=(new IgeUiLabel).left(0).right(30).top(0).bottom(0).mount(this),this.on("mouseUp",function(){t.toggle()})},options:function(t){if(void 0!==t){this._options=t;for(var e=t.length;e--;)if(t[e].selected)return this.selectIndex(e),this;return this.selectIndex(0),this}return this},addOption:function(t){return void 0!==t?(this._options.push(t),t.selected?(this.selectIndex(this._options.length-1),this):(this.selectIndex(0),this)):this},removeAllOptions:function(){this._options=[],this.value({text:"",value:""})},blur:function(){IgeUiElement.prototype.blur.call(this),this._toggleState&&this.toggle()},selectIndex:function(t){this._options[t]&&(this.value(this._options[t]),this.emit("change",this.value()))},value:function(t){return void 0!==t?(IgeUiElement.prototype.value.call(this,t),this._label.value(t.text),this):this._value.value},toggle:function(){if(this._toggleState=!this._toggleState,this._toggleState){var t,e,i=this,o=this._bounds2d.y+5,n=30*this._options.length;for(t=(new IgeUiElement).id(this._id+"_options").backgroundColor(this._backgroundColor).borderColor(this._borderColor).borderWidth(this._borderWidth).top(o).width(this._bounds2d.x).height(n).mount(this),e=0;e<this._options.length;e++)ige.ui.style("#"+this._id+"_options_"+e,{color:this._color}),(new IgeUiLabel).id(this._id+"_options_"+e).data("optionIndex",e).styleClass("IgeUiDropDownOption").value(this._options[e].text).top(this._bounds2d.y*e+1).left(1).width(this._bounds2d.x-2).height(this._bounds2d.y-2).allowFocus(!0).allowActive(!0).allowHover(!0).mouseUp(function(){i.selectIndex(this.data("optionIndex"))}).mount(t)}else ige.$(this._id+"_options").destroy()},tick:function(t){IgeUiElement.prototype.tick.call(this,t),t.fillStyle="#cccccc",t.fillRect(Math.floor(this._bounds2d.x2)-30,1-this._bounds2d.y2,30,this._bounds2d.y-2),t.strokeStyle=this._color,t.beginPath(),t.moveTo(this._bounds2d.x2-18.5,14.5-this._bounds2d.y2),t.lineTo(this._bounds2d.x2-14.5,2.5),t.lineTo(this._bounds2d.x2-10.5,14.5-this._bounds2d.y2),t.stroke(),this._renderBorder(t)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiDropDown);var IgeUiButton=IgeUiElement.extend({classId:"IgeUiButton",init:function(){var t=this;IgeUiElement.prototype.init.call(this),this.on("mouseDown",function(){t._autoCell&&(t.cell(this._cell+1),t.cacheDirty(!0))}),this.on("mouseUp",function(){t._autoCell&&(t.cell(this._cell-1),t.cacheDirty(!0))})},autoCell:function(t){return void 0!==t?(this._autoCell=t,t&&this.mouseEventsActive(!0),this):this._autoCell},click:function(){return this._mouseDown&&this._mouseDown(),this._mouseUp&&this._mouseUp(),this},tick:function(t){IgeUiElement.prototype.tick.call(this,t);var e=this.data("ui");e&&e.text&&(t.font=e.text.font||"normal 12px Verdana",t.textAlign=e.text.align||"center",t.textBaseline=e.text.baseline||"middle",t.fillStyle=e.text.color||"#ffffff",t.fillText(e.text.value,0,0)),this._value&&(t.textAlign="center",t.textBaseline="middle",t.fillStyle=this._color,t.fillText(this._value,0,0))}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiButton);var IgeUiRadioButton=IgeUiButton.extend({classId:"IgeUiRadioButton",radioGroup:function(t){return void 0!==t?(this._uiRadioGroup=t,this):this._uiRadioGroup},select:function(t){if(void 0!==t)return this._uiOnSelect=t,this;if(this._parent)for(var e,i=this._parent._children,o=i.length;o--;)(e=i[o])!==this&&e._uiRadioGroup===this._uiRadioGroup&&e._uiSelected&&(e._uiSelected=!1,e._uiOnDeSelect&&e._uiOnDeSelect());return this._uiSelected=!0,this._uiOnSelect&&this._uiOnSelect(),this},deSelect:function(t){return void 0!==t?(this._uiOnDeSelect=t,this):(this._uiSelected=!1,this._uiOnDeSelect&&this._uiOnDeSelect(),this)}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiRadioButton);var IgeUiProgressBar=IgeUiElement.extend({classId:"IgeUiProgressBar",init:function(){IgeUiElement.prototype.init.call(this),this._min=0,this._max=100,this._progress=0,this._barColor="#fff600",this._barText={pre:"",post:"",color:""}},barBackColor:function(t){return void 0!==t?(this._barBackColor=t,this):this._barBackColor},barColor:function(t){return void 0!==t?(this._barColor=t,this):this._barColor},barBorderColor:function(t){return void 0!==t?(this._barBorderColor=t,this):this._barBorderColor},barText:function(t,e,i){return void 0!==t&&void 0!==e&&void 0!==i?(this._barText={pre:t,post:e,color:i},this):this._barText},min:function(t){return void 0!==t?(this._min=t,this):this._min},max:function(t){return void 0!==t?(this._max=t,this):this._max},progress:function(t){return void 0!==t?(t<this._min&&(t=this._min),t>this._max&&(t=this._max),this._progress=t,this):this._progress},bindData:function(t,e){return void 0!==t&&void 0!==e&&(this._bindDataObject=t,this._bindDataProperty=e),this},render:function(t){this._bindDataObject&&this._bindDataProperty&&(!1===this._bindDataObject._alive?delete this._bindDataObject:this.progress(parseInt(this._bindDataObject[this._bindDataProperty])));var e=this._min,i=this._max,o=this._progress,n=this._bounds2d.x/(i-e),r=(o-e)*n;o>i&&(o=i),o<e&&(o=e),this._barBackColor&&(t.fillStyle=this._barBackColor,t.fillRect(-this._bounds2d.x2,-this._bounds2d.y2,this._bounds2d.x,this._bounds2d.y)),this._barColor&&(t.fillStyle=this._barColor,t.fillRect(-this._bounds2d.x2,-this._bounds2d.y2,r,this._bounds2d.y)),this._barBorderColor&&(t.strokeStyle=this._barBorderColor,t.strokeRect(-this._bounds2d.x2,-this._bounds2d.y2,this._bounds2d.x,this._bounds2d.y)),this._barText&&(this._barText.pre||this._barText.post)&&(t.textAlign="center",t.textBaseline="middle",t.fillStyle=this._barText.color,t.fillText(this._barText.pre+String(Math.floor(o))+this._barText.post,0,0))},tick:function(t){this._transformContext(t),this.render(t),IgeUiElement.prototype.tick.call(this,t,!0)}}),IgeUiTextBox=IgeUiElement.extend({classId:"IgeUiTextBox",init:function(){IgeUiElement.prototype.init.call(this);var t=this;this._value="",this._caretStart=0,this._caretEnd=0,this._fontEntity=(new IgeFontEntity).left(5).middle(0).textAlignX(0).textAlignY(0).mount(this);var e=function(){t._domElement&&(t._domElement.parentNode.removeChild(t._domElement),delete t._domElement)},i=function(){ige.input.stopPropagation(),e();var i,o,n=t.screenPosition();i=document.createElement("input"),i.setAttribute("type","text"),i.style.position="absolute",i.style.top=n.y-t._bounds2d.y2+"px",i.style.left=n.x-t._bounds2d.x2+"px",i.style.width=t._bounds2d.x+"px",i.style.zIndex=-1,i.style.opacity="0",o=document.getElementsByTagName("body")[0],o.appendChild(i),i.focus(),i.setAttribute("value",t._value),i.selectionStart=t._value.length,i.selectionEnd=t._value.length,t._caretStart=t._value.length,t._caretEnd=t._value.length,i.addEventListener("keyup",function(e){t.value(this.value),13===e.keyCode&&t.emit("enter",t._value)}),i.addEventListener("keydown",function(e){t.value(this.value)}),i.addEventListener("mouseup",function(e){t._caretStart=this.selectionStart,t._caretEnd=this.selectionEnd}),i.addEventListener("blur",function(t){this.focus()}),t._domElement=i};this.on("focus",i),this.on("mouseUp",i),this.on("mouseDown",function(){ige.input.stopPropagation()}),this.on("uiUpdate",function(){if(t._domElement){t.updateTransform();var e=t._domElement,i=t.screenPosition();e.style.top=i.y-t._bounds2d.y2+"px",e.style.left=i.x-t._bounds2d.x2+"px"}}),this.on("blur",e)},width:function(t,e,i,o){var n;return n=IgeUiElement.prototype.width.call(this,t,e,i,o),this._fontEntity.width(t-10,e,i,o),n},height:function(t,e,i,o){var n;return n=IgeUiElement.prototype.height.call(this,t,e,i,o),this._fontEntity.height(t,e,i,o),n},value:function(t){return void 0!==t?(this._value!==t&&(this._value=t,!t&&this._placeHolder?(this._fontEntity.text(this._placeHolder),this._fontEntity.color(this._placeHolderColor)):(this._mask?this._fontEntity.text(new Array(this._value.length+1).join(this._mask)):this._fontEntity.text(this._value),this._fontEntity.color(this._color)),this.emit("change",this._value)),this):this._value},placeHolder:function(t){return void 0!==t?(this._placeHolder=t,this):this._placeHolder},placeHolderColor:function(t){return void 0!==t?(this._placeHolderColor=t,this):this._placeHolderColor},mask:function(t){return void 0!==t?(this._mask=t,this):this._mask},fontSheet:function(t){return void 0!==t?(this._fontSheet=t,this._fontEntity.texture(this._fontSheet),this):this._fontSheet},font:function(t){return void 0!==t?"string"==typeof t?this.nativeFont(t):this.fontSheet(t):this._fontEntity._nativeMode?this.nativeFont():this.fontSheet()},nativeFont:function(t){return void 0!==t?(this._fontEntity.nativeFont(t),this):this._fontEntity.nativeFont()},nativeStroke:function(t){return void 0!==t?(this._fontEntity.nativeStroke(t),this):this._fontEntity.nativeStroke()},nativeStrokeColor:function(t){return void 0!==t?(this._fontEntity.nativeStrokeColor(t),this):this._fontEntity.nativeStrokeColor()},color:function(t){return void 0!==t?(this._color=t,!this._value&&this._placeHolder&&this._placeHolderColor?this._fontEntity.color(this._placeHolderColor):this._fontEntity.color(t),this):this._color},_mounted:function(){!this._value&&this._placeHolder&&(this._fontEntity.text(this._placeHolder),this._fontEntity.color(this._placeHolderColor)),IgeUiElement.prototype._mounted.call(this)},destroy:function(){this.blur(),IgeUiElement.prototype.destroy.call(this)}}),IgeUiLabel=IgeUiElement.extend({classId:"IgeUiLabel",init:function(){IgeUiElement.prototype.init.call(this);this._value="",this._fontEntity=(new IgeFontEntity).left(0).middle(0).textAlignX(0).textAlignY(0).mount(this),this.font("10px Verdana"),this.paddingLeft(5),this.allowActive(!1),this.allowFocus(!1),this.allowHover(!1)},width:function(t,e,i,o){var n;return n=IgeUiElement.prototype.width.call(this,t,e,i,o),this._fontEntity.width(t-10,e,i,o),n},height:function(t,e,i,o){var n;return n=IgeUiElement.prototype.height.call(this,t,e,i,o),this._fontEntity.height(t,e,i,o),n},value:function(t){return void 0!==t?(this._value!==t&&(this._value=t,!t&&this._placeHolder?(this._fontEntity.text(this._placeHolder),this._fontEntity.color(this._placeHolderColor)):(this._mask?this._fontEntity.text(new Array(this._value.length+1).join(this._mask)):this._fontEntity.text(this._value),this._fontEntity.color(this._color)),this.emit("change",this._value)),this):this._value},fontSheet:function(t){return void 0!==t?(this._fontSheet=t,this._fontEntity.texture(this._fontSheet),this):this._fontSheet},font:function(t){return void 0!==t?"string"==typeof t?this.nativeFont(t):this.fontSheet(t):this._fontEntity._nativeMode?this.nativeFont():this.fontSheet()},nativeFont:function(t){return void 0!==t?(this._fontEntity.nativeFont(t),this):this._fontEntity.nativeFont()},nativeStroke:function(t){return void 0!==t?(this._fontEntity.nativeStroke(t),this):this._fontEntity.nativeStroke()},nativeStrokeColor:function(t){return void 0!==t?(this._fontEntity.nativeStrokeColor(t),this):this._fontEntity.nativeStrokeColor()},color:function(t){return void 0!==t?(this._color=t,!this._value&&this._placeHolder&&this._placeHolderColor?this._fontEntity.color(this._placeHolderColor):this._fontEntity.color(t),this):this._color},_mounted:function(){!this._value&&this._placeHolder&&(this._fontEntity.text(this._placeHolder),this._fontEntity.color(this._placeHolderColor)),IgeUiElement.prototype._mounted.call(this)}}),IgeUiTooltip=IgeUiElement.extend({classId:"IgeUiTooltip",init:function(t,e,i,o,n){IgeUiElement.prototype.init.call(this);var r=this;return this.titleBox=(new IgeUiElement).left(0).top(0).width(i).height(30).mount(this),this.titleBox.borderBottomColor("#ffffff"),this.titleBox.borderBottomWidth(1),this.textBox=(new IgeUiElement).left(0).top(30).width(i).height(o-30).mount(this),this.fontEntityTitle=(new IgeFontEntity).left(5).top(-4).textAlignX(0).textAlignY(0).nativeFont("10pt Arial").textLineSpacing(-5).mount(this.titleBox),this.fontEntityText=(new IgeFontEntity).left(5).top(0).textAlignX(0).textAlignY(0).nativeFont("10pt Arial").textLineSpacing(-5).mount(this.textBox),this.setContent(n),this.hide(),this._mountEntity=e,this.mount(e),this.backgroundColor("#53B2F3"),this.depth(1e4),this.translateTo(t._translate.x,t._translate.y,t._translate.z),this.width(i),this.height(o),t._tooltip=this,t._mouseEventsActive=!0,t.on("mouseMove",r._mousemove),t.on("mouseOut",r._mouseout),this},width:function(t,e,i,o){var n;return n=IgeUiElement.prototype.width.call(this,t,e,i,o),this.fontEntityTitle.width(t,e,i,o),this.fontEntityText.width(t,e,i,o),n},height:function(t,e,i,o){var n;return n=IgeUiElement.prototype.height.call(this,t,e,i,o),this.fontEntityTitle.width(t,e,i,o),this.fontEntityText.width(t,e,i,o),n},setContent:function(t){return void 0!==t&&(this.titleBox.unMount(),this.textBox.unMount(),this._children.forEach(function(t){t.unMount(),t.destroy()}),"string"==typeof t?(this.textBox.mount(this),this.textBox.height(this._bounds2d.y),this.textBox.top(0),this.fontEntityText.text(this._value)):"object"!=typeof t||(t[0],0)||(t[1],0)?"object"==typeof t&&t.mount(this):(this.titleBox.mount(this),this.textBox.mount(this),this.textBox.height(this._bounds2d.y-this.titleBox._bounds2d.y),this.textBox.top(this.titleBox._bounds2d.y),this.fontEntityTitle.text(t[0]),this.fontEntityText.text(t[1])),this.updateUiChildren()),this},fontSheet:function(t){return void 0!==t&&(this.fontEntityTitle.texture(t),this.fontEntityText.texture(t)),this},_mousemove:function(t){var e=this._tooltip;e._hidden&&e.show();var i=e._mountEntity.worldPosition();e.translateTo(t.igeX-i.x+e._bounds2d.x2+10,t.igeY-i.y+e._bounds2d.y2,0),e.updateUiChildren()},_mouseout:function(t){this._tooltip.hide()}}),IgeUiMenu=IgeUiElement.extend({classId:"IgeUiMenu",menuData:function(t){return void 0!==t?(this._menuData=t,this.destroyChildren(),this._buildMenu(this._menuData,this),this):this._menuData},menuMode:function(t){return void 0!==t?(this._menuMode=t,this):this._menuMode},fontSheet:function(t){return void 0!==t?(this._fontSheet=t,this):this._fontSheet},addItem:function(t){},_buildMenu:function(t,e){var i,o,n=t.length,r=0,s=0;for(i=0;i<n;i++)o=t[i],this._menuMode&&(s+=this.height()),(new IgeUiMenuItem).backgroundColor("#666666").left(r).middle(s).height(this.height()).fontSheet(this._fontSheet).menuData(o).mount(e),this._menuMode||(r+=o.width)}}),IgeUiMenuItem=IgeUiElement.extend({classId:"IgeUiMenuItem",menuData:function(t){
return void 0!==t?(this._menuData=t,t.width&&this.width(t.width),t.id&&this.id(t.id),t.mouseUp&&this.mouseUp(t.mouseUp),t.mouseOver&&this.mouseOver(t.mouseOver),t.mouseOut&&this.mouseOut(t.mouseOut),this._labelEntity=(new IgeFontEntity).id(this.id()+"_label").texture(this._fontSheet).left(5).middle(0).width(t.width).height(this.height()).textAlignX(0).textAlignY(1).text(t.text).mount(this),this):this._menuData},fontSheet:function(t){return void 0!==t?(this._fontSheet=t,this):this._fontSheet},open:function(){this._menuData.items&&(this._childMenu=(new IgeUiMenu).id(this.id()+"_childMenu").depth(this.depth()+1).fontSheet(this._fontSheet).left(0).top(this.height()).width(100).height(30).menuMode(1).menuData(this._menuData.items).mount(this))},close:function(){this._childMenu&&this._childMenu.destroy()}}),IgeUiTimeStream=IgeUiElement.extend({classId:"IgeUiTimeStream",monitor:function(t){this._entity=t},tick:function(t){var e,i,o,n,r,s,a,h=ige._tickStart-ige.network.stream._renderLatency;for(IgeUiElement.prototype.tick.call(this,t),t.strokeStyle="#fffc00",t.beginPath(),t.moveTo(-200,-25.5),t.lineTo(200,-25.5),t.stroke(),t.font="normal 10px Verdana",e=0;e<9;e++)t.beginPath(),t.strokeStyle=10*(e-2)==0?"#ff6600":"#ffffff",t.moveTo(50*e-200.5,-30),t.lineTo(50*e-200.5,30),t.stroke(),i=-ige.network.stream._renderLatency+10*(e-2)+"ms",o=t.measureText(i),t.strokeText(i,50*e-200-o.width/2,-38),10*(e-2)==0&&(i="Render Point",o=t.measureText(i),t.strokeText(i,50*e-200-o.width/2,-52));if(this._entity){if((n=this._entity._timeStream)&&n.length)for(r=n.length,e=0;e<r;e++)s=n[e],a=s[0]-h,t.strokeRect(a/10*50-105,-5,10,10);ige.client.custom2.value=this._entity._timeStreamDataDelta,ige.client.custom3.value=this._entity._timeStreamOffsetDelta,ige.client.custom4.value=this._entity._timeStreamCurrentInterpolateTime}}});"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeUiTimeStream);var IgeFilters={};"undefined"!=typeof window&&(IgeFilters.tmpCanvas=document.createElement("canvas"),IgeFilters.tmpCtx=IgeFilters.tmpCanvas.getContext("2d")),"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeFilters),IgeFilters.createImageData=function(t,e){return IgeFilters.tmpCtx.createImageData(t,e)},IgeFilters._convolute=function(t,e,i){for(var o=Math.round(Math.sqrt(e.length)),n=Math.floor(o/2),r=t.data,s=t.width,a=t.height,h=s,l=a,c=IgeFilters.createImageData(h,l),u=c.data,m=i?1:0,d=0;d<l;d++)for(var p=0;p<h;p++){for(var _=d,f=p,y=4*(d*h+p),g=0,v=0,x=0,b=0,E=0;E<o;E++)for(var T=0;T<o;T++){var w=_+E-n,S=f+T-n;if(w>=0&&w<a&&S>=0&&S<s){var C=4*(w*s+S),R=e[E*o+T];g+=r[C]*R,v+=r[C+1]*R,x+=r[C+2]*R,b+=r[C+3]*R}}u[y]=g,u[y+1]=v,u[y+2]=x,u[y+3]=b+m*(255-b)}return c},IgeFilters.greyScale=function(t,e,i,o,n){e.putImageData(IgeFilters._greyScale(e.getImageData(0,0,t.width,t.height)),0,0)},IgeFilters._greyScale=function(t){var e,i,o,n,r,s,a;for(e=t.data,i=e.length,o=0;o<i;o+=4)n=e[o],r=e[o+1],s=e[o+2],a=.2126*n+.7152*r+.0722*s,e[o]=e[o+1]=e[o+2]=a;return t},IgeFilters.brighten=function(t,e,i,o,n){e.putImageData(IgeFilters._brighten(e.getImageData(0,0,t.width,t.height),o,n),0,0)},IgeFilters._brighten=function(t,e,i){var o,n,r,s=e.data("IgeFilters.brighten.value")||i.value;for(o=t.data,n=o.length,r=0;r<n;r+=4)o[r]+=s,o[r+1]+=s,o[r+2]+=s;return t},IgeFilters.threshold=function(t,e,i,o,n){e.putImageData(IgeFilters._threshold(e.getImageData(0,0,t.width,t.height),o,n),0,0)},IgeFilters._threshold=function(t,e,i){var o,n,r,s,a,h,l,c=e.data("IgeFilters.threshold.value")||i.value;for(o=t.data,n=o.length,r=0;r<n;r+=4)s=o[r],a=o[r+1],h=o[r+2],l=.2126*s+.7152*a+.0722*h>=c?255:0,o[r]=o[r+1]=o[r+2]=l;return t},IgeFilters.sharpen=function(t,e,i,o,n){var r,s=1;for(n&&n.value&&(s=n.value),r=0;r<s;r++)e.putImageData(IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[0,-1,0,-1,5,-1,0,-1,0]),0,0)},IgeFilters.blur=function(t,e,i,o,n){var r,s,a=1;for(s=e.getImageData(0,0,t.width,t.height),n&&n.value&&(a=n.value),r=0;r<a;r++)s=IgeFilters._convolute(s,[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9]);e.putImageData(s,0,0)},IgeFilters.emboss=function(t,e,i,o,n){e.putImageData(IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[-2,-1,0,-1,1,1,0,1,2]),0,0)},IgeFilters.edgeDetect=function(t,e,i,o,n){o._filterImageDrawn&&n&&n.cumulative||(e.clearRect(0,0,t.width,t.height),e.drawImage(i,0,0),o._filterImageDrawn=!0);var r,s,a,h,l,c=IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[-1,-1,-1,-1,-1,-1,2,2,2,-1,-1,2,0,2,-1,-1,2,2,2,-1,-1,-1,-1,-1,-1],!0),u=c.data,m=u.length;for(r=0;r<m;r+=4)s=u[r],a=u[r+1],h=u[r+2],l=(s+a+h)/3,l*=1.1,l=l>=n.value?255:0,u[r]=u[r+1]=u[r+2]=l;e.putImageData(c,0,0)},IgeFilters.edgeEnhance=function(t,e,i,o,n){o._filterImageDrawn&&n&&n.cumulative||(e.clearRect(0,0,t.width,t.height),e.drawImage(i,0,0),o._filterImageDrawn=!0),e.putImageData(IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[0,0,0,-1,1,0,0,0,0],!0),0,0)},IgeFilters.outlineDetect=function(t,e,i,o,n){e.putImageData(IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[0,1,0,1,-4,1,0,1,0]),0,0)},IgeFilters.colorOverlay=function(t,e,i,o,n){e.globalCompositeOperation="source-atop",e.fillStyle=n.color,e.fillRect(0,0,t.width,t.height)},IgeFilters.sobel=function(t,e,i,o,n){var r,s=1;for(n&&n.value&&(s=n.value),r=0;r<s;r++)e.putImageData(IgeFilters._convolute(e.getImageData(0,0,t.width,t.height),[-1,-1,1,-2,0,2,-1,1,1],!0),0,0)},IgeFilters._invert=function(t,e){var i,o,n,r;for(i=t.width,o=t.height,n=e.getImageData(0,0,i,o),r=0;r<i*o*4;r+=4)n.data[r]=255-n.data[r],n.data[r+1]=255-n.data[r+1],n.data[r+2]=255-n.data[r+2];e.putImageData(n,0,0)},IgeFilters.invert=function(t,e,i,o,n){var r,s,a,h;for(r=t.width,s=t.height,a=e.getImageData(0,0,r,s),h=0;h<r*s*4;h+=4)a.data[h]=255-a.data[h],a.data[h+1]=255-a.data[h+1],a.data[h+2]=255-a.data[h+2];e.putImageData(a,0,0)},IgeFilters.glowMask=function(t,e,i,o,n){var r,s,a,h;if(e.clearRect(0,0,t.width,t.height),n.blurPasses){for(e.drawImage(n.glowMask.image,0,0),r=e.getImageData(0,0,t.width,t.height),e.clearRect(0,0,t.width,t.height),h=0;h<n.blurPasses;h++)r=IgeFilters._convolute(r,[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],!1);s=document.createElement("canvas"),a=s.getContext("2d"),s.width=t.width,s.height=t.height,a.putImageData(r,0,0)}else s=n.glowMask.image;for(e.drawImage(i,0,0),e.globalCompositeOperation="lighter",h=0;h<n.glowPasses;h++)e.drawImage(s,0,0)};var THREE=THREE||{REVISION:"52"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,String.prototype.startsWith=String.prototype.startsWith||function(t){return this.slice(0,t.length)===t},String.prototype.endsWith=String.prototype.endsWith||function(t){var t=String(t),e=this.lastIndexOf(t);return(-1<e&&e)===this.length-t.length},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(e){var i=Date.now(),o=Math.max(0,16-(i-t)),n=window.setTimeout(function(){e(i+o)},o);return t=i+o,n}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(t){window.clearTimeout(t)}}(),THREE.FrontSide=0,THREE.BackSide=1,THREE.DoubleSide=2,THREE.NoShading=0,THREE.FlatShading=1,THREE.SmoothShading=2,THREE.NoColors=0,THREE.FaceColors=1,THREE.VertexColors=2,THREE.NoBlending=0,THREE.NormalBlending=1,THREE.AdditiveBlending=2,THREE.SubtractiveBlending=3,THREE.MultiplyBlending=4,THREE.CustomBlending=5,THREE.AddEquation=100,THREE.SubtractEquation=101,THREE.ReverseSubtractEquation=102,THREE.ZeroFactor=200,THREE.OneFactor=201,THREE.SrcColorFactor=202,THREE.OneMinusSrcColorFactor=203,THREE.SrcAlphaFactor=204,THREE.OneMinusSrcAlphaFactor=205,THREE.DstAlphaFactor=206,THREE.OneMinusDstAlphaFactor=207,THREE.DstColorFactor=208,THREE.OneMinusDstColorFactor=209,THREE.SrcAlphaSaturateFactor=210,THREE.MultiplyOperation=0,THREE.MixOperation=1,THREE.UVMapping=function(){},THREE.CubeReflectionMapping=function(){},THREE.CubeRefractionMapping=function(){},THREE.SphericalReflectionMapping=function(){},THREE.SphericalRefractionMapping=function(){},THREE.RepeatWrapping=1e3,THREE.ClampToEdgeWrapping=1001,THREE.MirroredRepeatWrapping=1002,THREE.NearestFilter=1003,THREE.NearestMipMapNearestFilter=1004,THREE.NearestMipMapLinearFilter=1005,THREE.LinearFilter=1006,THREE.LinearMipMapNearestFilter=1007,THREE.LinearMipMapLinearFilter=1008,THREE.UnsignedByteType=1009,THREE.ByteType=1010,THREE.ShortType=1011,THREE.UnsignedShortType=1012,THREE.IntType=1013,THREE.UnsignedIntType=1014,THREE.FloatType=1015,THREE.UnsignedShort4444Type=1016,THREE.UnsignedShort5551Type=1017,THREE.UnsignedShort565Type=1018,THREE.AlphaFormat=1019,THREE.RGBFormat=1020,THREE.RGBAFormat=1021,THREE.LuminanceFormat=1022,THREE.LuminanceAlphaFormat=1023,THREE.RGB_S3TC_DXT1_Format=2001,THREE.RGBA_S3TC_DXT1_Format=2002,THREE.RGBA_S3TC_DXT3_Format=2003,THREE.RGBA_S3TC_DXT5_Format=2004,THREE.Clock=function(t){this.autoStart=void 0===t||t,this.elapsedTime=this.oldTime=this.startTime=0,this.running=!1},THREE.Clock.prototype.start=function(){this.oldTime=this.startTime=Date.now(),this.running=!0},THREE.Clock.prototype.stop=function(){this.getElapsedTime(),this.running=!1},THREE.Clock.prototype.getElapsedTime=function(){return this.elapsedTime+=this.getDelta()},THREE.Clock.prototype.getDelta=function(){var t=0;if(this.autoStart&&!this.running&&this.start(),this.running){var e=Date.now(),t=.001*(e-this.oldTime);this.oldTime=e,this.elapsedTime+=t}return t},THREE.Color=function(t){return void 0!==t&&this.setHex(t),this},THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},copyGammaToLinear:function(t){return this.r=t.r*t.r,this.g=t.g*t.g,this.b=t.b*t.b,this},copyLinearToGamma:function(t){return this.r=Math.sqrt(t.r),this.g=Math.sqrt(t.g),this.b=Math.sqrt(t.b),this},convertGammaToLinear:function(){var t=this.r,e=this.g,i=this.b;return this.r=t*t,this.g=e*e,this.b=i*i,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},setRGB:function(t,e,i){return this.r=t,this.g=e,this.b=i,this},setHSV:function(t,e,i){var o,n,r;return 0===i?this.r=this.g=this.b=0:(o=Math.floor(6*t),n=6*t-o,t=i*(1-e),r=i*(1-e*n),e=i*(1-e*(1-n)),0===o?(this.r=i,this.g=e,this.b=t):1===o?(this.r=r,this.g=i,this.b=t):2===o?(this.r=t,this.g=i,this.b=e):3===o?(this.r=t,this.g=r,this.b=i):4===o?(this.r=e,this.g=t,this.b=i):5===o&&(this.r=i,this.g=t,this.b=r)),this},setHex:function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},lerpSelf:function(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getContextStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}},THREE.Vector2=function(t,e){this.x=t||0,this.y=e||0},THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(t,e){return this.x=t,this.y=e,this},copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divideScalar:function(t){return t?(this.x/=t,this.y/=t):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(t){return this.x*t.x+this.y*t.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,t=this.y-t.y;return e*e+t*t},setLength:function(t){return this.normalize().multiplyScalar(t)},lerpSelf:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this},equals:function(t){return t.x===this.x&&t.y===this.y},isZero:function(t){return this.lengthSq()<(void 0!==t?t:1e-4)},clone:function(){return new THREE.Vector2(this.x,this.y)}},THREE.Vector3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},multiply:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},multiplySelf:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},divideSelf:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){return t?(this.x/=t,this.y/=t,this.z/=t):this.z=this.y=this.x=0,this},negate:function(){return this.multiplyScalar(-1)},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(t){return this.normalize().multiplyScalar(t)},lerpSelf:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},cross:function(t,e){return this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this},crossSelf:function(t){var e=this.x,i=this.y,o=this.z;return this.x=i*t.z-o*t.y,this.y=o*t.x-e*t.z,this.z=e*t.y-i*t.x,this},angleTo:function(t){return Math.acos(this.dot(t)/this.length()/t.length())},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){return(new THREE.Vector3).sub(this,t).lengthSq()},getPositionFromMatrix:function(t){return this.x=t.elements[12],this.y=t.elements[13],this.z=t.elements[14],this},setEulerFromRotationMatrix:function(t,e){function i(t){return Math.min(Math.max(t,-1),1)}var o=t.elements,n=o[0],r=o[4],s=o[8],a=o[1],h=o[5],l=o[9],c=o[2],u=o[6],o=o[10];return void 0===e||"XYZ"===e?(this.y=Math.asin(i(s)),.99999>Math.abs(s)?(this.x=Math.atan2(-l,o),this.z=Math.atan2(-r,n)):(this.x=Math.atan2(u,h),this.z=0)):"YXZ"===e?(this.x=Math.asin(-i(l)),.99999>Math.abs(l)?(this.y=Math.atan2(s,o),this.z=Math.atan2(a,h)):(this.y=Math.atan2(-c,n),this.z=0)):"ZXY"===e?(this.x=Math.asin(i(u)),.99999>Math.abs(u)?(this.y=Math.atan2(-c,o),this.z=Math.atan2(-r,h)):(this.y=0,this.z=Math.atan2(a,n))):"ZYX"===e?(this.y=Math.asin(-i(c)),.99999>Math.abs(c)?(this.x=Math.atan2(u,o),this.z=Math.atan2(a,n)):(this.x=0,this.z=Math.atan2(-r,h))):"YZX"===e?(this.z=Math.asin(i(a)),.99999>Math.abs(a)?(this.x=Math.atan2(-l,h),this.y=Math.atan2(-c,n)):(this.x=0,this.y=Math.atan2(s,o))):"XZY"===e&&(this.z=Math.asin(-i(r)),.99999>Math.abs(r)?(this.x=Math.atan2(u,h),this.y=Math.atan2(s,n)):(this.x=Math.atan2(-l,o),this.y=0)),this},setEulerFromQuaternion:function(t,e){function i(t){return Math.min(Math.max(t,-1),1)}var o=t.x*t.x,n=t.y*t.y,r=t.z*t.z,s=t.w*t.w;return void 0===e||"XYZ"===e?(this.x=Math.atan2(2*(t.x*t.w-t.y*t.z),s-o-n+r),this.y=Math.asin(i(2*(t.x*t.z+t.y*t.w))),this.z=Math.atan2(2*(t.z*t.w-t.x*t.y),s+o-n-r)):"YXZ"===e?(this.x=Math.asin(i(2*(t.x*t.w-t.y*t.z))),this.y=Math.atan2(2*(t.x*t.z+t.y*t.w),s-o-n+r),this.z=Math.atan2(2*(t.x*t.y+t.z*t.w),s-o+n-r)):"ZXY"===e?(this.x=Math.asin(i(2*(t.x*t.w+t.y*t.z))),this.y=Math.atan2(2*(t.y*t.w-t.z*t.x),s-o-n+r),this.z=Math.atan2(2*(t.z*t.w-t.x*t.y),s-o+n-r)):"ZYX"===e?(this.x=Math.atan2(2*(t.x*t.w+t.z*t.y),s-o-n+r),this.y=Math.asin(i(2*(t.y*t.w-t.x*t.z))),this.z=Math.atan2(2*(t.x*t.y+t.z*t.w),s+o-n-r)):"YZX"===e?(this.x=Math.atan2(2*(t.x*t.w-t.z*t.y),s-o+n-r),this.y=Math.atan2(2*(t.y*t.w-t.x*t.z),s+o-n-r),this.z=Math.asin(i(2*(t.x*t.y+t.z*t.w)))):"XZY"===e&&(this.x=Math.atan2(2*(t.x*t.w+t.y*t.z),s-o+n-r),this.y=Math.atan2(2*(t.x*t.z+t.y*t.w),s+o-n-r),this.z=Math.asin(i(2*(t.z*t.w-t.x*t.y)))),this},getScaleFromMatrix:function(t){var e=this.set(t.elements[0],t.elements[1],t.elements[2]).length(),i=this.set(t.elements[4],t.elements[5],t.elements[6]).length(),t=this.set(t.elements[8],t.elements[9],t.elements[10]).length();return this.x=e,this.y=i,this.z=t,this},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},isZero:function(t){return this.lengthSq()<(void 0!==t?t:1e-4)},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}},THREE.Vector4=function(t,e,i,o){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==o?o:1},THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(t,e,i,o){return this.x=t,this.y=e,this.z=i,this.w=o,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},divideScalar:function(t){return t?(this.x/=t,this.y/=t,this.z/=t,this.w/=t):(this.z=this.y=this.x=0,this.w=1),this},negate:function(){return this.multiplyScalar(-1)},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSq())},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(t){return this.normalize().multiplyScalar(t)},lerpSelf:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)},setAxisAngleFromQuaternion:function(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return 1e-4>e?(this.x=1,this.z=this.y=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this},setAxisAngleFromRotationMatrix:function(t){var e,i,o,t=t.elements,n=t[0];o=t[4];var r=t[8],s=t[1],a=t[5],h=t[9];i=t[2],e=t[6];var l=t[10];return.01>Math.abs(o-s)&&.01>Math.abs(r-i)&&.01>Math.abs(h-e)?.1>Math.abs(o+s)&&.1>Math.abs(r+i)&&.1>Math.abs(h+e)&&.1>Math.abs(n+a+l-3)?(this.set(1,0,0,0),this):(t=Math.PI,n=(n+1)/2,a=(a+1)/2,l=(l+1)/2,o=(o+s)/4,r=(r+i)/4,h=(h+e)/4,n>a&&n>l?.01>n?(e=0,o=i=.707106781):(e=Math.sqrt(n),i=o/e,o=r/e):a>l?.01>a?(e=.707106781,i=0,o=.707106781):(i=Math.sqrt(a),e=o/i,o=h/i):.01>l?(i=e=.707106781,o=0):(o=Math.sqrt(l),e=r/o,i=h/o),this.set(e,i,o,t),this):(t=Math.sqrt((e-h)*(e-h)+(r-i)*(r-i)+(s-o)*(s-o)),.001>Math.abs(t)&&(t=1),this.x=(e-h)/t,this.y=(r-i)/t,this.z=(s-o)/t,this.w=Math.acos((n+a+l-1)/2),this)}},THREE.Matrix3=function(){this.elements=new Float32Array(9)},THREE.Matrix3.prototype={constructor:THREE.Matrix3,getInverse:function(t){var e=t.elements,t=e[10]*e[5]-e[6]*e[9],i=-e[10]*e[1]+e[2]*e[9],o=e[6]*e[1]-e[2]*e[5],n=-e[10]*e[4]+e[6]*e[8],r=e[10]*e[0]-e[2]*e[8],s=-e[6]*e[0]+e[2]*e[4],a=e[9]*e[4]-e[5]*e[8],h=-e[9]*e[0]+e[1]*e[8],l=e[5]*e[0]-e[1]*e[4],e=e[0]*t+e[1]*n+e[2]*a;0===e&&console.warn("Matrix3.getInverse(): determinant == 0");var e=1/e,c=this.elements;return c[0]=e*t,c[1]=e*i,c[2]=e*o,c[3]=e*n,c[4]=e*r,c[5]=e*s,c[6]=e*a,c[7]=e*h,c[8]=e*l,this},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},transposeIntoArray:function(t){var e=this.m;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}},THREE.Matrix4=function(t,e,i,o,n,r,s,a,h,l,c,u,m,d,p,_){this.elements=new Float32Array(16),this.set(void 0!==t?t:1,e||0,i||0,o||0,n||0,void 0!==r?r:1,s||0,a||0,h||0,l||0,void 0!==c?c:1,u||0,m||0,d||0,p||0,void 0!==_?_:1)},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(t,e,i,o,n,r,s,a,h,l,c,u,m,d,p,_){var f=this.elements;return f[0]=t,f[4]=e,f[8]=i,f[12]=o,f[1]=n,f[5]=r,f[9]=s,f[13]=a,f[2]=h,f[6]=l,f[10]=c,f[14]=u,f[3]=m,f[7]=d,f[11]=p,f[15]=_,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(t){return t=t.elements,this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},lookAt:function(t,e,i){var o=this.elements,n=THREE.Matrix4.__v1,r=THREE.Matrix4.__v2,s=THREE.Matrix4.__v3;return s.sub(t,e).normalize(),0===s.length()&&(s.z=1),n.cross(i,s).normalize(),0===n.length()&&(s.x+=1e-4,n.cross(i,s).normalize()),r.cross(s,n),o[0]=n.x,o[4]=r.x,o[8]=s.x,o[1]=n.y,o[5]=r.y,o[9]=s.y,o[2]=n.z,o[6]=r.z,o[10]=s.z,this},multiply:function(t,e){var i=t.elements,o=e.elements,n=this.elements,r=i[0],s=i[4],a=i[8],h=i[12],l=i[1],c=i[5],u=i[9],m=i[13],d=i[2],p=i[6],_=i[10],f=i[14],y=i[3],g=i[7],v=i[11],i=i[15],x=o[0],b=o[4],E=o[8],T=o[12],w=o[1],S=o[5],C=o[9],R=o[13],M=o[2],D=o[6],A=o[10],B=o[14],I=o[3],H=o[7],P=o[11],o=o[15];return n[0]=r*x+s*w+a*M+h*I,n[4]=r*b+s*S+a*D+h*H,n[8]=r*E+s*C+a*A+h*P,n[12]=r*T+s*R+a*B+h*o,n[1]=l*x+c*w+u*M+m*I,n[5]=l*b+c*S+u*D+m*H,n[9]=l*E+c*C+u*A+m*P,n[13]=l*T+c*R+u*B+m*o,n[2]=d*x+p*w+_*M+f*I,n[6]=d*b+p*S+_*D+f*H,n[10]=d*E+p*C+_*A+f*P,n[14]=d*T+p*R+_*B+f*o,n[3]=y*x+g*w+v*M+i*I,n[7]=y*b+g*S+v*D+i*H,n[11]=y*E+g*C+v*A+i*P,n[15]=y*T+g*R+v*B+i*o,this},multiplySelf:function(t){return this.multiply(this,t)},multiplyToArray:function(t,e,i){var o=this.elements;return this.multiply(t,e),i[0]=o[0],i[1]=o[1],i[2]=o[2],i[3]=o[3],i[4]=o[4],i[5]=o[5],i[6]=o[6],i[7]=o[7],i[8]=o[8],i[9]=o[9],i[10]=o[10],i[11]=o[11],i[12]=o[12],i[13]=o[13],i[14]=o[14],i[15]=o[15],this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},multiplyVector3:function(t){var e=this.elements,i=t.x,o=t.y,n=t.z,r=1/(e[3]*i+e[7]*o+e[11]*n+e[15]);return t.x=(e[0]*i+e[4]*o+e[8]*n+e[12])*r,t.y=(e[1]*i+e[5]*o+e[9]*n+e[13])*r,t.z=(e[2]*i+e[6]*o+e[10]*n+e[14])*r,t},multiplyVector4:function(t){var e=this.elements,i=t.x,o=t.y,n=t.z,r=t.w;return t.x=e[0]*i+e[4]*o+e[8]*n+e[12]*r,t.y=e[1]*i+e[5]*o+e[9]*n+e[13]*r,t.z=e[2]*i+e[6]*o+e[10]*n+e[14]*r,t.w=e[3]*i+e[7]*o+e[11]*n+e[15]*r,t},multiplyVector3Array:function(t){for(var e=THREE.Matrix4.__v1,i=0,o=t.length;i<o;i+=3)e.x=t[i],e.y=t[i+1],e.z=t[i+2],this.multiplyVector3(e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z;return t},rotateAxis:function(t){var e=this.elements,i=t.x,o=t.y,n=t.z;return t.x=i*e[0]+o*e[4]+n*e[8],t.y=i*e[1]+o*e[5]+n*e[9],t.z=i*e[2]+o*e[6]+n*e[10],t.normalize(),t},crossVector:function(t){var e=this.elements,i=new THREE.Vector4;return i.x=e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12]*t.w,i.y=e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13]*t.w,i.z=e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14]*t.w,i.w=t.w?e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15]*t.w:1,i},determinant:function(){var t=this.elements,e=t[0],i=t[4],o=t[8],n=t[12],r=t[1],s=t[5],a=t[9],h=t[13],l=t[2],c=t[6],u=t[10],m=t[14],d=t[3],p=t[7],_=t[11],t=t[15];return n*a*c*d-o*h*c*d-n*s*u*d+i*h*u*d+o*s*m*d-i*a*m*d-n*a*l*p+o*h*l*p+n*r*u*p-e*h*u*p-o*r*m*p+e*a*m*p+n*s*l*_-i*h*l*_-n*r*c*_+e*h*c*_+i*r*m*_-e*s*m*_-o*s*l*t+i*a*l*t+o*r*c*t-e*a*c*t-i*r*u*t+e*s*u*t},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArray:function(t){var e=this.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},flattenToArrayOffset:function(t,e){var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t},getPosition:function(){var t=this.elements;return THREE.Matrix4.__v1.set(t[12],t[13],t[14])},setPosition:function(t){var e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},getColumnX:function(){var t=this.elements;return THREE.Matrix4.__v1.set(t[0],t[1],t[2])},getColumnY:function(){var t=this.elements;return THREE.Matrix4.__v1.set(t[4],t[5],t[6])},getColumnZ:function(){var t=this.elements;return THREE.Matrix4.__v1.set(t[8],t[9],t[10])},getInverse:function(t){var e=this.elements,i=t.elements,o=i[0],n=i[4],r=i[8],s=i[12],a=i[1],h=i[5],l=i[9],c=i[13],u=i[2],m=i[6],d=i[10],p=i[14],_=i[3],f=i[7],y=i[11],i=i[15];return e[0]=l*p*f-c*d*f+c*m*y-h*p*y-l*m*i+h*d*i,e[4]=s*d*f-r*p*f-s*m*y+n*p*y+r*m*i-n*d*i,e[8]=r*c*f-s*l*f+s*h*y-n*c*y-r*h*i+n*l*i,e[12]=s*l*m-r*c*m-s*h*d+n*c*d+r*h*p-n*l*p,e[1]=c*d*_-l*p*_-c*u*y+a*p*y+l*u*i-a*d*i,e[5]=r*p*_-s*d*_+s*u*y-o*p*y-r*u*i+o*d*i,e[9]=s*l*_-r*c*_-s*a*y+o*c*y+r*a*i-o*l*i,e[13]=r*c*u-s*l*u+s*a*d-o*c*d-r*a*p+o*l*p,e[2]=h*p*_-c*m*_+c*u*f-a*p*f-h*u*i+a*m*i,e[6]=s*m*_-n*p*_-s*u*f+o*p*f+n*u*i-o*m*i,e[10]=n*c*_-s*h*_+s*a*f-o*c*f-n*a*i+o*h*i,e[14]=s*h*u-n*c*u-s*a*m+o*c*m+n*a*p-o*h*p,e[3]=l*m*_-h*d*_-l*u*f+a*d*f+h*u*y-a*m*y,e[7]=n*d*_-r*m*_+r*u*f-o*d*f-n*u*y+o*m*y,e[11]=r*h*_-n*l*_-r*a*f+o*l*f+n*a*y-o*h*y,e[15]=n*l*u-r*h*u+r*a*m-o*l*m-n*a*d+o*h*d,this.multiplyScalar(1/t.determinant()),this},setRotationFromEuler:function(t,e){var i=this.elements,o=t.x,n=t.y,r=t.z,s=Math.cos(o),o=Math.sin(o),a=Math.cos(n),n=Math.sin(n),h=Math.cos(r),r=Math.sin(r);if(void 0===e||"XYZ"===e){var l=s*h,c=s*r,u=o*h,m=o*r;i[0]=a*h,i[4]=-a*r,i[8]=n,i[1]=c+u*n,i[5]=l-m*n,i[9]=-o*a,i[2]=m-l*n,i[6]=u+c*n,i[10]=s*a}else"YXZ"===e?(l=a*h,c=a*r,u=n*h,m=n*r,i[0]=l+m*o,i[4]=u*o-c,i[8]=s*n,i[1]=s*r,i[5]=s*h,i[9]=-o,i[2]=c*o-u,i[6]=m+l*o,i[10]=s*a):"ZXY"===e?(l=a*h,c=a*r,u=n*h,m=n*r,i[0]=l-m*o,i[4]=-s*r,i[8]=u+c*o,i[1]=c+u*o,i[5]=s*h,i[9]=m-l*o,i[2]=-s*n,i[6]=o,i[10]=s*a):"ZYX"===e?(l=s*h,c=s*r,u=o*h,m=o*r,i[0]=a*h,i[4]=u*n-c,i[8]=l*n+m,i[1]=a*r,i[5]=m*n+l,i[9]=c*n-u,i[2]=-n,i[6]=o*a,i[10]=s*a):"YZX"===e?(l=s*a,c=s*n,u=o*a,m=o*n,i[0]=a*h,i[4]=m-l*r,i[8]=u*r+c,i[1]=r,i[5]=s*h,i[9]=-o*h,i[2]=-n*h,i[6]=c*r+u,i[10]=l-m*r):"XZY"===e&&(l=s*a,c=s*n,u=o*a,m=o*n,i[0]=a*h,i[4]=-r,i[8]=n*h,i[1]=l*r+m,i[5]=s*h,i[9]=c*r-u,i[2]=u*r-c,i[6]=o*h,i[10]=m*r+l);return this},setRotationFromQuaternion:function(t){var e=this.elements,i=t.x,o=t.y,n=t.z,r=t.w,s=i+i,a=o+o,h=n+n,t=i*s,l=i*a,i=i*h,c=o*a,o=o*h,n=n*h,s=r*s,a=r*a,r=r*h;return e[0]=1-(c+n),e[4]=l-r,e[8]=i+a,e[1]=l+r,e[5]=1-(t+n),e[9]=o-s,e[2]=i-a,e[6]=o+s,e[10]=1-(t+c),this},compose:function(t,e,i){var o=this.elements,n=THREE.Matrix4.__m1,r=THREE.Matrix4.__m2;return n.identity(),n.setRotationFromQuaternion(e),r.makeScale(i.x,i.y,i.z),this.multiply(n,r),o[12]=t.x,o[13]=t.y,o[14]=t.z,this},decompose:function(t,e,i){var o=this.elements,n=THREE.Matrix4.__v1,r=THREE.Matrix4.__v2,s=THREE.Matrix4.__v3;return n.set(o[0],o[1],o[2]),r.set(o[4],o[5],o[6]),s.set(o[8],o[9],o[10]),t=t instanceof THREE.Vector3?t:new THREE.Vector3,e=e instanceof THREE.Quaternion?e:new THREE.Quaternion,i=i instanceof THREE.Vector3?i:new THREE.Vector3,i.x=n.length(),i.y=r.length(),i.z=s.length(),t.x=o[12],t.y=o[13],t.z=o[14],o=THREE.Matrix4.__m1,o.copy(this),o.elements[0]/=i.x,o.elements[1]/=i.x,o.elements[2]/=i.x,o.elements[4]/=i.y,o.elements[5]/=i.y,o.elements[6]/=i.y,o.elements[8]/=i.z,o.elements[9]/=i.z,o.elements[10]/=i.z,e.setFromRotationMatrix(o),[t,e,i]},extractPosition:function(t){var e=this.elements,t=t.elements;return e[12]=t[12],e[13]=t[13],e[14]=t[14],this},extractRotation:function(t){var e=this.elements,t=t.elements,i=THREE.Matrix4.__v1,o=1/i.set(t[0],t[1],t[2]).length(),n=1/i.set(t[4],t[5],t[6]).length(),i=1/i.set(t[8],t[9],t[10]).length();return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,this},translate:function(t){var e=this.elements,i=t.x,o=t.y,t=t.z;return e[12]=e[0]*i+e[4]*o+e[8]*t+e[12],e[13]=e[1]*i+e[5]*o+e[9]*t+e[13],e[14]=e[2]*i+e[6]*o+e[10]*t+e[14],e[15]=e[3]*i+e[7]*o+e[11]*t+e[15],this},rotateX:function(t){var e=this.elements,i=e[4],o=e[5],n=e[6],r=e[7],s=e[8],a=e[9],h=e[10],l=e[11],c=Math.cos(t),t=Math.sin(t);return e[4]=c*i+t*s,e[5]=c*o+t*a,e[6]=c*n+t*h,e[7]=c*r+t*l,e[8]=c*s-t*i,e[9]=c*a-t*o,e[10]=c*h-t*n,e[11]=c*l-t*r,this},rotateY:function(t){var e=this.elements,i=e[0],o=e[1],n=e[2],r=e[3],s=e[8],a=e[9],h=e[10],l=e[11],c=Math.cos(t),t=Math.sin(t);return e[0]=c*i-t*s,e[1]=c*o-t*a,e[2]=c*n-t*h,e[3]=c*r-t*l,e[8]=c*s+t*i,e[9]=c*a+t*o,e[10]=c*h+t*n,e[11]=c*l+t*r,this},rotateZ:function(t){var e=this.elements,i=e[0],o=e[1],n=e[2],r=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=Math.cos(t),t=Math.sin(t);return e[0]=c*i+t*s,e[1]=c*o+t*a,e[2]=c*n+t*h,e[3]=c*r+t*l,e[4]=c*s-t*i,e[5]=c*a-t*o,e[6]=c*h-t*n,e[7]=c*l-t*r,this},rotateByAxis:function(t,e){var i=this.elements;if(1===t.x&&0===t.y&&0===t.z)return this.rotateX(e);if(0===t.x&&1===t.y&&0===t.z)return this.rotateY(e);if(0===t.x&&0===t.y&&1===t.z)return this.rotateZ(e);var o=t.x,n=t.y,r=t.z,s=Math.sqrt(o*o+n*n+r*r),o=o/s,n=n/s,r=r/s,s=o*o,a=n*n,h=r*r,l=Math.cos(e),c=Math.sin(e),u=1-l,m=o*n*u,d=o*r*u,u=n*r*u,o=o*c,p=n*c,c=r*c,r=s+(1-s)*l,s=m+c,n=d-p,m=m-c,a=a+(1-a)*l,c=u+o,d=d+p,u=u-o,h=h+(1-h)*l,l=i[0],o=i[1],p=i[2],_=i[3],f=i[4],y=i[5],g=i[6],v=i[7],x=i[8],b=i[9],E=i[10],T=i[11];return i[0]=r*l+s*f+n*x,i[1]=r*o+s*y+n*b,i[2]=r*p+s*g+n*E,i[3]=r*_+s*v+n*T,i[4]=m*l+a*f+c*x,i[5]=m*o+a*y+c*b,i[6]=m*p+a*g+c*E,i[7]=m*_+a*v+c*T,i[8]=d*l+u*f+h*x,i[9]=d*o+u*y+h*b,i[10]=d*p+u*g+h*E,i[11]=d*_+u*v+h*T,this},scale:function(t){var e=this.elements,i=t.x,o=t.y,t=t.z;return e[0]*=i,e[4]*=o,e[8]*=t,e[1]*=i,e[5]*=o,e[9]*=t,e[2]*=i,e[6]*=o,e[10]*=t,e[3]*=i,e[7]*=o,e[11]*=t,this},getMaxScaleOnAxis:function(){var t=this.elements;return Math.sqrt(Math.max(t[0]*t[0]+t[1]*t[1]+t[2]*t[2],Math.max(t[4]*t[4]+t[5]*t[5]+t[6]*t[6],t[8]*t[8]+t[9]*t[9]+t[10]*t[10])))},makeTranslation:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t),t=Math.sin(t);return this.set(1,0,0,0,0,e,-t,0,0,t,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t),t=Math.sin(t);return this.set(e,0,t,0,0,1,0,0,-t,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t),t=Math.sin(t);return this.set(e,-t,0,0,t,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var i=Math.cos(e),o=Math.sin(e),n=1-i,r=t.x,s=t.y,a=t.z,h=n*r,l=n*s;return this.set(h*r+i,h*s-o*a,h*a+o*s,0,h*s+o*a,l*s+i,l*a-o*r,0,h*a-o*s,l*a+o*r,n*a*a+i,0,0,0,0,1),this},makeScale:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this},makeFrustum:function(t,e,i,o,n,r){var s=this.elements;return s[0]=2*n/(e-t),s[4]=0,s[8]=(e+t)/(e-t),s[12]=0,s[1]=0,s[5]=2*n/(o-i),s[9]=(o+i)/(o-i),s[13]=0,s[2]=0,s[6]=0,s[10]=-(r+n)/(r-n),s[14]=-2*r*n/(r-n),s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(t,e,i,o){var t=i*Math.tan(t*Math.PI/360),n=-t;return this.makeFrustum(n*e,t*e,n,t,i,o)},makeOrthographic:function(t,e,i,o,n,r){var s=this.elements,a=e-t,h=i-o,l=r-n;return s[0]=2/a,s[4]=0,s[8]=0,s[12]=-(e+t)/a,s[1]=0,s[5]=2/h,s[9]=0,s[13]=-(i+o)/h,s[2]=0,s[6]=0,
s[10]=-2/l,s[14]=-(r+n)/l,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},clone:function(){var t=this.elements;return new THREE.Matrix4(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}},THREE.Matrix4.__v1=new THREE.Vector3,THREE.Matrix4.__v2=new THREE.Vector3,THREE.Matrix4.__v3=new THREE.Vector3,THREE.Matrix4.__m1=new THREE.Matrix4,THREE.Matrix4.__m2=new THREE.Matrix4,THREE.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var o=t[e].indexOf(i);-1!==o&&t[e].splice(o,1)}},THREE.Frustum=function(){this.planes=[new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4]},THREE.Frustum.prototype.setFromMatrix=function(t){var e=this.planes,i=t.elements,t=i[0],o=i[1],n=i[2],r=i[3],s=i[4],a=i[5],h=i[6],l=i[7],c=i[8],u=i[9],m=i[10],d=i[11],p=i[12],_=i[13],f=i[14],i=i[15];for(e[0].set(r-t,l-s,d-c,i-p),e[1].set(r+t,l+s,d+c,i+p),e[2].set(r+o,l+a,d+u,i+_),e[3].set(r-o,l-a,d-u,i-_),e[4].set(r-n,l-h,d-m,i-f),e[5].set(r+n,l+h,d+m,i+f),o=0;6>o;o++)t=e[o],t.divideScalar(Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z))},THREE.Frustum.prototype.contains=function(t){for(var e=0,i=this.planes,e=t.matrixWorld,o=e.elements,t=-t.geometry.boundingSphere.radius*e.getMaxScaleOnAxis(),n=0;6>n;n++)if((e=i[n].x*o[12]+i[n].y*o[13]+i[n].z*o[14]+i[n].w)<=t)return!1;return!0},THREE.Frustum.__v1=new THREE.Vector3,function(t){t.Ray=function(e,i,o,n){this.origin=e||new t.Vector3,this.direction=i||new t.Vector3,this.near=o||0,this.far=n||1/0};var e=new t.Vector3,i=new t.Vector3,o=new t.Vector3,n=new t.Vector3,r=new t.Vector3,s=new t.Vector3,a=new t.Matrix4,h=function(t,e){return t.distance-e.distance},l=new t.Vector3,c=new t.Vector3,u=new t.Vector3,m=function(t,e,i){l.sub(i,t);var o=l.dot(e),t=c.add(t,u.copy(e).multiplyScalar(o));return i.distanceTo(t)},d=function(t,e,i,o){l.sub(o,e),c.sub(i,e),u.sub(t,e);var t=l.dot(l),e=l.dot(c),i=l.dot(u),n=c.dot(c),o=c.dot(u),r=1/(t*n-e*e),n=(n*i-e*o)*r,t=(t*o-e*i)*r;return 0<=n&&0<=t&&1>n+t},p=function(h,l,c){var u,p;if(h instanceof t.Particle){if((u=m(l.origin,l.direction,h.matrixWorld.getPosition()))>h.scale.x)return c;p={distance:u,point:h.position,face:null,object:h},c.push(p)}else if(h instanceof t.Mesh){var _=h.geometry.boundingSphere.radius*h.matrixWorld.getMaxScaleOnAxis();if((u=m(l.origin,l.direction,h.matrixWorld.getPosition()))>_)return c;var f,y,g,v,x,b=h.geometry,E=b.vertices;g=h.geometry.materials,v=h.material instanceof t.MeshFaceMaterial;var T,w=l.precision;for(h.matrixRotationWorld.extractRotation(h.matrixWorld),e.copy(l.origin),a.getInverse(h.matrixWorld),i.copy(e),a.multiplyVector3(i),o.copy(l.direction),a.rotateAxis(o).normalize(),_=0,f=b.faces.length;_<f;_++)p=b.faces[_],void 0===(u=!0===v?g[p.materialIndex]:h.material)||(x=u.side,n.sub(p.centroid,i),r=p.normal,u=o.dot(r),Math.abs(u)<w||0>(y=r.dot(n)/u)||x!==t.DoubleSide&&!(x===t.FrontSide?0>u:0<u))||(s.add(i,o.multiplyScalar(y)),p instanceof t.Face3?(u=E[p.a],y=E[p.b],x=E[p.c],d(s,u,y,x)&&(y=h.matrixWorld.multiplyVector3(s.clone()),(u=e.distanceTo(y))<l.near||u>l.far||(p={distance:u,point:y,face:p,faceIndex:_,object:h},c.push(p)))):p instanceof t.Face4&&(u=E[p.a],y=E[p.b],x=E[p.c],T=E[p.d],d(s,u,y,T)||d(s,y,x,T))&&(y=h.matrixWorld.multiplyVector3(s.clone()),(u=e.distanceTo(y))<l.near||u>l.far||(p={distance:u,point:y,face:p,faceIndex:_,object:h},c.push(p))))}},_=function(t,e,i){for(var t=t.getDescendants(),o=0,n=t.length;o<n;o++)p(t[o],e,i)};t.Ray.prototype.precision=1e-4,t.Ray.prototype.set=function(t,e){this.origin=t,this.direction=e},t.Ray.prototype.intersectObject=function(t,e){var i=[];return!0===e&&_(t,this,i),p(t,this,i),i.sort(h),i},t.Ray.prototype.intersectObjects=function(t,e){for(var i=[],o=0,n=t.length;o<n;o++)p(t[o],this,i),!0===e&&_(t[o],this,i);return i.sort(h),i}}(THREE),THREE.Rectangle=function(){function t(){r=o-e,s=n-i}var e=0,i=0,o=0,n=0,r=0,s=0,a=!0;this.getX=function(){return e},this.getY=function(){return i},this.getWidth=function(){return r},this.getHeight=function(){return s},this.getLeft=function(){return e},this.getTop=function(){return i},this.getRight=function(){return o},this.getBottom=function(){return n},this.set=function(r,s,h,l){a=!1,e=r,i=s,o=h,n=l,t()},this.addPoint=function(r,s){!0===a?(a=!1,e=r,i=s,o=r,n=s):(e=e<r?e:r,i=i<s?i:s,o=o>r?o:r,n=n>s?n:s),t()},this.add3Points=function(r,s,h,l,c,u){!0===a?(a=!1,e=r<h?r<c?r:c:h<c?h:c,i=s<l?s<u?s:u:l<u?l:u,o=r>h?r>c?r:c:h>c?h:c,n=s>l?s>u?s:u:l>u?l:u):(e=r<h?r<c?r<e?r:e:c<e?c:e:h<c?h<e?h:e:c<e?c:e,i=s<l?s<u?s<i?s:i:u<i?u:i:l<u?l<i?l:i:u<i?u:i,o=r>h?r>c?r>o?r:o:c>o?c:o:h>c?h>o?h:o:c>o?c:o,n=s>l?s>u?s>n?s:n:u>n?u:n:l>u?l>n?l:n:u>n?u:n),t()},this.addRectangle=function(r){!0===a?(a=!1,e=r.getLeft(),i=r.getTop(),o=r.getRight(),n=r.getBottom()):(e=e<r.getLeft()?e:r.getLeft(),i=i<r.getTop()?i:r.getTop(),o=o>r.getRight()?o:r.getRight(),n=n>r.getBottom()?n:r.getBottom()),t()},this.inflate=function(r){e-=r,i-=r,o+=r,n+=r,t()},this.minSelf=function(r){e=e>r.getLeft()?e:r.getLeft(),i=i>r.getTop()?i:r.getTop(),o=o<r.getRight()?o:r.getRight(),n=n<r.getBottom()?n:r.getBottom(),t()},this.intersects=function(t){return!(o<t.getLeft()||e>t.getRight()||n<t.getTop()||i>t.getBottom())},this.empty=function(){a=!0,n=o=i=e=0,t()},this.isEmpty=function(){return a}},THREE.Math={clamp:function(t,e,i){return t<e?e:t>i?i:t},clampBottom:function(t,e){return t<e?e:t},mapLinear:function(t,e,i,o,n){return o+(t-e)*(n-o)/(i-e)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},sign:function(t){return 0>t?-1:0<t?1:0}},THREE.Object3D=function(){THREE.Object3DLibrary.push(this),this.id=THREE.Object3DIdCount++,this.name="",this.properties={},this.parent=void 0,this.children=[],this.up=new THREE.Vector3(0,1,0),this.position=new THREE.Vector3,this.rotation=new THREE.Vector3,this.eulerOrder=THREE.Object3D.defaultEulerOrder,this.scale=new THREE.Vector3(1,1,1),this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new THREE.Matrix4,this.matrixWorld=new THREE.Matrix4,this.matrixRotationWorld=new THREE.Matrix4,this.matrixWorldNeedsUpdate=this.matrixAutoUpdate=!0,this.quaternion=new THREE.Quaternion,this.useQuaternion=!1,this.boundRadius=0,this.boundRadiusScale=1,this.visible=!0,this.receiveShadow=this.castShadow=!1,this.frustumCulled=!0,this._vector=new THREE.Vector3},THREE.Object3D.prototype={constructor:THREE.Object3D,applyMatrix:function(t){this.matrix.multiply(t,this.matrix),this.scale.getScaleFromMatrix(this.matrix),t=(new THREE.Matrix4).extractRotation(this.matrix),this.rotation.setEulerFromRotationMatrix(t,this.eulerOrder),this.position.getPositionFromMatrix(this.matrix)},translate:function(t,e){this.matrix.rotateAxis(e),this.position.addSelf(e.multiplyScalar(t))},translateX:function(t){this.translate(t,this._vector.set(1,0,0))},translateY:function(t){this.translate(t,this._vector.set(0,1,0))},translateZ:function(t){this.translate(t,this._vector.set(0,0,1))},localToWorld:function(t){return this.matrixWorld.multiplyVector3(t)},worldToLocal:function(t){return THREE.Object3D.__m1.getInverse(this.matrixWorld).multiplyVector3(t)},lookAt:function(t){this.matrix.lookAt(t,this.position,this.up),this.rotationAutoUpdate&&this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},add:function(t){if(t===this)console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");else if(t instanceof THREE.Object3D){void 0!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t);for(var e=this;void 0!==e.parent;)e=e.parent;void 0!==e&&e instanceof THREE.Scene&&e.__addObject(t)}},remove:function(t){var e=this.children.indexOf(t);if(-1!==e){for(t.parent=void 0,this.children.splice(e,1),e=this;void 0!==e.parent;)e=e.parent;void 0!==e&&e instanceof THREE.Scene&&e.__removeObject(t)}},traverse:function(t){t(this);for(var e=0,i=this.children.length;e<i;e++)this.children[e].traverse(t)},getChildByName:function(t,e){for(var i=0,o=this.children.length;i<o;i++){var n=this.children[i];if(n.name===t||!0===e&&void 0!==(n=n.getChildByName(t,e)))return n}},getDescendants:function(t){void 0===t&&(t=[]),Array.prototype.push.apply(t,this.children);for(var e=0,i=this.children.length;e<i;e++)this.children[e].getDescendants(t);return t},updateMatrix:function(){this.matrix.setPosition(this.position),!1===this.useQuaternion?this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder):this.matrix.setRotationFromQuaternion(this.quaternion),1===this.scale.x&&1===this.scale.y&&1===this.scale.z||(this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,Math.max(this.scale.y,this.scale.z))),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==t||(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=0,i=this.children.length;e<i;e++)this.children[e].updateMatrixWorld(t)},clone:function(t){return void 0===t&&(t=new THREE.Object3D),t.name=this.name,t.up.copy(this.up),t.position.copy(this.position),t.rotation instanceof THREE.Vector3&&t.rotation.copy(this.rotation),t.eulerOrder=this.eulerOrder,t.scale.copy(this.scale),t.renderDepth=this.renderDepth,t.rotationAutoUpdate=this.rotationAutoUpdate,t.matrix.copy(this.matrix),t.matrixWorld.copy(this.matrixWorld),t.matrixRotationWorld.copy(this.matrixRotationWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.quaternion.copy(this.quaternion),t.useQuaternion=this.useQuaternion,t.boundRadius=this.boundRadius,t.boundRadiusScale=this.boundRadiusScale,t.visible=this.visible,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t.frustumCulled=this.frustumCulled,t},deallocate:function(){var t=THREE.Object3DLibrary.indexOf(this);-1!==t&&THREE.Object3DLibrary.splice(t,1)}},THREE.Object3D.__m1=new THREE.Matrix4,THREE.Object3D.defaultEulerOrder="XYZ",THREE.Object3DIdCount=0,THREE.Object3DLibrary=[],THREE.Projector=function(){function t(){if(r===f){var t=new THREE.RenderableObject;return _.push(t),f++,r++,t}return _[r++]}function e(){if(a===g){var t=new THREE.RenderableVertex;return y.push(t),g++,a++,t}return y[a++]}function i(t,e){return e.z-t.z}function o(t,e){var i=0,o=1,n=t.z+t.w,r=e.z+e.w,s=-t.z+t.w,a=-e.z+e.w;return 0<=n&&0<=r&&0<=s&&0<=a||!(0>n&&0>r||0>s&&0>a)&&(0>n?i=Math.max(i,n/(n-r)):0>r&&(o=Math.min(o,n/(n-r))),0>s?i=Math.max(i,s/(s-a)):0>a&&(o=Math.min(o,s/(s-a))),!(o<i)&&(t.lerpSelf(e,i),e.lerpSelf(t,1-o),!0))}var n,r,s,a,h,l,c,u,m,d,p,_=[],f=0,y=[],g=0,v=[],x=0,b=[],E=0,T=[],w=0,S=[],C=0,R={objects:[],sprites:[],lights:[],elements:[]},M=new THREE.Vector3,D=new THREE.Vector4,A=new THREE.Matrix4,B=new THREE.Matrix4,I=new THREE.Frustum,H=new THREE.Vector4,P=new THREE.Vector4;this.projectVector=function(t,e){return e.matrixWorldInverse.getInverse(e.matrixWorld),A.multiply(e.projectionMatrix,e.matrixWorldInverse),A.multiplyVector3(t),t},this.unprojectVector=function(t,e){return e.projectionMatrixInverse.getInverse(e.projectionMatrix),A.multiply(e.matrixWorld,e.projectionMatrixInverse),A.multiplyVector3(t),t},this.pickingRay=function(t,e){var i;return t.z=-1,i=new THREE.Vector3(t.x,t.y,1),this.unprojectVector(t,e),this.unprojectVector(i,e),i.subSelf(t).normalize(),new THREE.Ray(t,i)},this.projectScene=function(_,f,g,L){var V,k,F,z,N,U,O,G,W,j,q,J,X,Y,K,Z,$=f.near,Q=f.far,tt=!1;p=m=c=l=0,R.elements.length=0,_.updateMatrixWorld(),void 0===f.parent&&f.updateMatrixWorld(),f.matrixWorldInverse.getInverse(f.matrixWorld),A.multiply(f.projectionMatrix,f.matrixWorldInverse),I.setFromMatrix(A),r=0,R.objects.length=0,R.sprites.length=0,R.lights.length=0;var et=function(e){for(var i=0,o=e.children.length;i<o;i++){var r=e.children[i];!1!==r.visible&&(r instanceof THREE.Light?R.lights.push(r):r instanceof THREE.Mesh||r instanceof THREE.Line?!1!==r.frustumCulled&&!0!==I.contains(r)||(n=t(),n.object=r,null!==r.renderDepth?n.z=r.renderDepth:(M.copy(r.matrixWorld.getPosition()),A.multiplyVector3(M),n.z=M.z),R.objects.push(n)):r instanceof THREE.Sprite||r instanceof THREE.Particle?(n=t(),n.object=r,null!==r.renderDepth?n.z=r.renderDepth:(M.copy(r.matrixWorld.getPosition()),A.multiplyVector3(M),n.z=M.z),R.sprites.push(n)):(n=t(),n.object=r,null!==r.renderDepth?n.z=r.renderDepth:(M.copy(r.matrixWorld.getPosition()),A.multiplyVector3(M),n.z=M.z),R.objects.push(n)),et(r))}};for(et(_),!0===g&&R.objects.sort(i),_=0,g=R.objects.length;_<g;_++)if(G=R.objects[_].object,W=G.matrixWorld,a=0,G instanceof THREE.Mesh){for(j=G.geometry,q=G.geometry.materials,F=j.vertices,J=j.faces,Y=j.faceVertexUvs,j=G.matrixRotationWorld.extractRotation(W),K=G.material instanceof THREE.MeshFaceMaterial,V=0,k=F.length;V<k;V++)s=e(),s.positionWorld.copy(F[V]),W.multiplyVector3(s.positionWorld),s.positionScreen.copy(s.positionWorld),A.multiplyVector4(s.positionScreen),s.positionScreen.x/=s.positionScreen.w,s.positionScreen.y/=s.positionScreen.w,s.visible=s.positionScreen.z>$&&s.positionScreen.z<Q;for(F=0,V=J.length;F<V;F++)if(k=J[F],void 0!==(Z=!0===K?q[k.materialIndex]:G.material)){if(U=Z.side,k instanceof THREE.Face3){if(z=y[k.a],N=y[k.b],O=y[k.c],!0!==z.visible||!0!==N.visible||!0!==O.visible)continue;if(tt=0>(O.positionScreen.x-z.positionScreen.x)*(N.positionScreen.y-z.positionScreen.y)-(O.positionScreen.y-z.positionScreen.y)*(N.positionScreen.x-z.positionScreen.x),U!==THREE.DoubleSide&&tt!==(U===THREE.FrontSide))continue;l===x?(X=new THREE.RenderableFace3,v.push(X),x++,l++,h=X):h=v[l++],h.v1.copy(z),h.v2.copy(N),h.v3.copy(O)}else if(k instanceof THREE.Face4){if(z=y[k.a],N=y[k.b],O=y[k.c],X=y[k.d],!0!==z.visible||!0!==N.visible||!0!==O.visible||!0!==X.visible)continue;if(tt=0>(X.positionScreen.x-z.positionScreen.x)*(N.positionScreen.y-z.positionScreen.y)-(X.positionScreen.y-z.positionScreen.y)*(N.positionScreen.x-z.positionScreen.x)||0>(N.positionScreen.x-O.positionScreen.x)*(X.positionScreen.y-O.positionScreen.y)-(N.positionScreen.y-O.positionScreen.y)*(X.positionScreen.x-O.positionScreen.x),U!==THREE.DoubleSide&&tt!==(U===THREE.FrontSide))continue;if(c===E){var it=new THREE.RenderableFace4;b.push(it),E++,c++,h=it}else h=b[c++];h.v1.copy(z),h.v2.copy(N),h.v3.copy(O),h.v4.copy(X)}for(h.normalWorld.copy(k.normal),!1===tt&&(U===THREE.BackSide||U===THREE.DoubleSide)&&h.normalWorld.negate(),j.multiplyVector3(h.normalWorld),h.centroidWorld.copy(k.centroid),W.multiplyVector3(h.centroidWorld),h.centroidScreen.copy(h.centroidWorld),A.multiplyVector3(h.centroidScreen),O=k.vertexNormals,z=0,N=O.length;z<N;z++)X=h.vertexNormalsWorld[z],X.copy(O[z]),!1===tt&&(U===THREE.BackSide||U===THREE.DoubleSide)&&X.negate(),j.multiplyVector3(X);for(h.vertexNormalsLength=O.length,z=0,N=Y.length;z<N;z++)if(void 0!==(X=Y[z][F]))for(U=0,O=X.length;U<O;U++)h.uvs[z][U]=X[U];h.color=k.color,h.material=Z,h.z=h.centroidScreen.z,R.elements.push(h)}}else if(G instanceof THREE.Line)for(B.multiply(A,W),F=G.geometry.vertices,z=e(),z.positionScreen.copy(F[0]),B.multiplyVector4(z.positionScreen),W=G.type===THREE.LinePieces?2:1,V=1,k=F.length;V<k;V++)z=e(),z.positionScreen.copy(F[V]),B.multiplyVector4(z.positionScreen),0<(V+1)%W||(N=y[a-2],H.copy(z.positionScreen),P.copy(N.positionScreen),!0===o(H,P)&&(H.multiplyScalar(1/H.w),P.multiplyScalar(1/P.w),m===w?(q=new THREE.RenderableLine,T.push(q),w++,m++,u=q):u=T[m++],u.v1.positionScreen.copy(H),u.v2.positionScreen.copy(P),u.z=Math.max(H.z,P.z),u.material=G.material,R.elements.push(u)));for(_=0,g=R.sprites.length;_<g;_++)G=R.sprites[_].object,W=G.matrixWorld,G instanceof THREE.Particle&&(D.set(W.elements[12],W.elements[13],W.elements[14],1),A.multiplyVector4(D),D.z/=D.w,0<D.z&&1>D.z&&(p===C?($=new THREE.RenderableParticle,S.push($),C++,p++,d=$):d=S[p++],d.object=G,d.x=D.x/D.w,d.y=D.y/D.w,d.z=D.z,d.rotation=G.rotation.z,d.scale.x=G.scale.x*Math.abs(d.x-(D.x+f.projectionMatrix.elements[0])/(D.w+f.projectionMatrix.elements[12])),d.scale.y=G.scale.y*Math.abs(d.y-(D.y+f.projectionMatrix.elements[5])/(D.w+f.projectionMatrix.elements[13])),d.material=G.material,R.elements.push(d)));return!0===L&&R.elements.sort(i),R}},THREE.Quaternion=function(t,e,i,o){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==o?o:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,set:function(t,e,i,o){return this.x=t,this.y=e,this.z=i,this.w=o,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t,e){var i=Math.cos(t.x/2),o=Math.cos(t.y/2),n=Math.cos(t.z/2),r=Math.sin(t.x/2),s=Math.sin(t.y/2),a=Math.sin(t.z/2);return void 0===e||"XYZ"===e?(this.x=r*o*n+i*s*a,this.y=i*s*n-r*o*a,this.z=i*o*a+r*s*n,this.w=i*o*n-r*s*a):"YXZ"===e?(this.x=r*o*n+i*s*a,this.y=i*s*n-r*o*a,this.z=i*o*a-r*s*n,this.w=i*o*n+r*s*a):"ZXY"===e?(this.x=r*o*n-i*s*a,this.y=i*s*n+r*o*a,this.z=i*o*a+r*s*n,this.w=i*o*n-r*s*a):"ZYX"===e?(this.x=r*o*n-i*s*a,this.y=i*s*n+r*o*a,this.z=i*o*a-r*s*n,this.w=i*o*n+r*s*a):"YZX"===e?(this.x=r*o*n+i*s*a,this.y=i*s*n+r*o*a,this.z=i*o*a-r*s*n,this.w=i*o*n-r*s*a):"XZY"===e&&(this.x=r*o*n-i*s*a,this.y=i*s*n-r*o*a,this.z=i*o*a+r*s*n,this.w=i*o*n+r*s*a),this},setFromAxisAngle:function(t,e){var i=e/2,o=Math.sin(i);return this.x=t.x*o,this.y=t.y*o,this.z=t.z*o,this.w=Math.cos(i),this},setFromRotationMatrix:function(t){var e=t.elements,i=e[0],t=e[4],o=e[8],n=e[1],r=e[5],s=e[9],a=e[2],h=e[6],e=e[10],l=i+r+e;return 0<l?(i=.5/Math.sqrt(l+1),this.w=.25/i,this.x=(h-s)*i,this.y=(o-a)*i,this.z=(n-t)*i):i>r&&i>e?(i=2*Math.sqrt(1+i-r-e),this.w=(h-s)/i,this.x=.25*i,this.y=(t+n)/i,this.z=(o+a)/i):r>e?(i=2*Math.sqrt(1+r-i-e),this.w=(o-a)/i,this.x=(t+n)/i,this.y=.25*i,this.z=(s+h)/i):(i=2*Math.sqrt(1+e-i-r),this.w=(n-t)/i,this.x=(o+a)/i,this.y=(s+h)/i,this.z=.25*i),this},calculateW:function(){return this.w=-Math.sqrt(Math.abs(1-this.x*this.x-this.y*this.y-this.z*this.z)),this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?this.w=this.z=this.y=this.x=0:(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},multiply:function(t,e){var i=t.x,o=t.y,n=t.z,r=t.w,s=e.x,a=e.y,h=e.z,l=e.w;return this.x=i*l+o*h-n*a+r*s,this.y=-i*h+o*l+n*s+r*a,this.z=i*a-o*s+n*l+r*h,this.w=-i*s-o*a-n*h+r*l,this},multiplySelf:function(t){var e=this.x,i=this.y,o=this.z,n=this.w,r=t.x,s=t.y,a=t.z,t=t.w;return this.x=e*t+n*r+i*a-o*s,this.y=i*t+n*s+o*r-e*a,this.z=o*t+n*a+e*s-i*r,this.w=n*t-e*r-i*s-o*a,this},multiplyVector3:function(t,e){e||(e=t);var i=t.x,o=t.y,n=t.z,r=this.x,s=this.y,a=this.z,h=this.w,l=h*i+s*n-a*o,c=h*o+a*i-r*n,u=h*n+r*o-s*i,i=-r*i-s*o-a*n;return e.x=l*h+i*-r+c*-a-u*-s,e.y=c*h+i*-s+u*-r-l*-a,e.z=u*h+i*-a+l*-s-c*-r,e},slerpSelf:function(t,e){var i=this.x,o=this.y,n=this.z,r=this.w,s=r*t.w+i*t.x+o*t.y+n*t.z;if(0>s?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,s=-s):this.copy(t),1<=s)return this.w=r,this.x=i,this.y=o,this.z=n,this;var a=Math.acos(s),h=Math.sqrt(1-s*s);return.001>Math.abs(h)?(this.w=.5*(r+this.w),this.x=.5*(i+this.x),this.y=.5*(o+this.y),this.z=.5*(n+this.z),this):(s=Math.sin((1-e)*a)/h,a=Math.sin(e*a)/h,this.w=r*s+this.w*a,this.x=i*s+this.x*a,this.y=o*s+this.y*a,this.z=n*s+this.z*a,this)},clone:function(){return new THREE.Quaternion(this.x,this.y,this.z,this.w)}},THREE.Quaternion.slerp=function(t,e,i,o){var n=t.w*e.w+t.x*e.x+t.y*e.y+t.z*e.z;if(0>n?(i.w=-e.w,i.x=-e.x,i.y=-e.y,i.z=-e.z,n=-n):i.copy(e),1<=Math.abs(n))return i.w=t.w,i.x=t.x,i.y=t.y,i.z=t.z,i;var e=Math.acos(n),r=Math.sqrt(1-n*n);return.001>Math.abs(r)?(i.w=.5*(t.w+i.w),i.x=.5*(t.x+i.x),i.y=.5*(t.y+i.y),i.z=.5*(t.z+i.z),i):(n=Math.sin((1-o)*e)/r,o=Math.sin(o*e)/r,i.w=t.w*n+i.w*o,i.x=t.x*n+i.x*o,i.y=t.y*n+i.y*o,i.z=t.z*n+i.z*o,i)},THREE.Vertex=function(t){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),t},THREE.Face3=function(t,e,i,o,n,r){this.a=t,this.b=e,this.c=i,this.normal=o instanceof THREE.Vector3?o:new THREE.Vector3,this.vertexNormals=o instanceof Array?o:[],this.color=n instanceof THREE.Color?n:new THREE.Color,this.vertexColors=n instanceof Array?n:[],this.vertexTangents=[],this.materialIndex=r,this.centroid=new THREE.Vector3},THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var t=new THREE.Face3(this.a,this.b,this.c);t.normal.copy(this.normal),t.color.copy(this.color),t.centroid.copy(this.centroid),t.materialIndex=this.materialIndex;var e,i;for(e=0,i=this.vertexNormals.length;e<i;e++)t.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,i=this.vertexColors.length;e<i;e++)t.vertexColors[e]=this.vertexColors[e].clone();for(e=0,i=this.vertexTangents.length;e<i;e++)t.vertexTangents[e]=this.vertexTangents[e].clone();return t}},THREE.Face4=function(t,e,i,o,n,r,s){this.a=t,this.b=e,this.c=i,this.d=o,this.normal=n instanceof THREE.Vector3?n:new THREE.Vector3,this.vertexNormals=n instanceof Array?n:[],this.color=r instanceof THREE.Color?r:new THREE.Color,this.vertexColors=r instanceof Array?r:[],this.vertexTangents=[],this.materialIndex=s,this.centroid=new THREE.Vector3},THREE.Face4.prototype={constructor:THREE.Face4,clone:function(){var t=new THREE.Face4(this.a,this.b,this.c,this.d);t.normal.copy(this.normal),t.color.copy(this.color),t.centroid.copy(this.centroid),t.materialIndex=this.materialIndex;var e,i;for(e=0,i=this.vertexNormals.length;e<i;e++)t.vertexNormals[e]=this.vertexNormals[e].clone();for(e=0,i=this.vertexColors.length;e<i;e++)t.vertexColors[e]=this.vertexColors[e].clone();for(e=0,i=this.vertexTangents.length;e<i;e++)t.vertexTangents[e]=this.vertexTangents[e].clone();return t}},THREE.UV=function(t,e){this.u=t||0,this.v=e||0},THREE.UV.prototype={constructor:THREE.UV,set:function(t,e){return this.u=t,this.v=e,this},copy:function(t){return this.u=t.u,this.v=t.v,this},lerpSelf:function(t,e){return this.u+=(t.u-this.u)*e,this.v+=(t.v-this.v)*e,this},clone:function(){return new THREE.UV(this.u,this.v)}},THREE.Geometry=function(){THREE.GeometryLibrary.push(this),this.id=THREE.GeometryIdCount++,this.name="",this.vertices=[],this.colors=[],this.materials=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.boundingSphere=this.boundingBox=null,this.hasTangents=!1,this.dynamic=!0,this.colorsNeedUpdate=this.tangentsNeedUpdate=this.normalsNeedUpdate=this.uvsNeedUpdate=this.elementsNeedUpdate=this.verticesNeedUpdate=!1},THREE.Geometry.prototype={constructor:THREE.Geometry,applyMatrix:function(t){var e=new THREE.Matrix4;e.extractRotation(t);for(var i=0,o=this.vertices.length;i<o;i++)t.multiplyVector3(this.vertices[i]);for(i=0,o=this.faces.length;i<o;i++){var n=this.faces[i];e.multiplyVector3(n.normal);for(var r=0,s=n.vertexNormals.length;r<s;r++)e.multiplyVector3(n.vertexNormals[r]);t.multiplyVector3(n.centroid)}},computeCentroids:function(){var t,e,i;for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],i.centroid.set(0,0,0),i instanceof THREE.Face3?(i.centroid.addSelf(this.vertices[i.a]),i.centroid.addSelf(this.vertices[i.b]),i.centroid.addSelf(this.vertices[i.c]),i.centroid.divideScalar(3)):i instanceof THREE.Face4&&(i.centroid.addSelf(this.vertices[i.a]),i.centroid.addSelf(this.vertices[i.b]),i.centroid.addSelf(this.vertices[i.c]),i.centroid.addSelf(this.vertices[i.d]),i.centroid.divideScalar(4))},computeFaceNormals:function(){var t,e,i,o,n,r,s=new THREE.Vector3,a=new THREE.Vector3;for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],o=this.vertices[i.a],n=this.vertices[i.b],r=this.vertices[i.c],s.sub(r,n),a.sub(o,n),s.crossSelf(a),s.isZero()||s.normalize(),i.normal.copy(s)},computeVertexNormals:function(){var t,e,i,o;if(void 0===this.__tmpVertices){for(o=this.__tmpVertices=Array(this.vertices.length),t=0,e=this.vertices.length;t<e;t++)o[t]=new THREE.Vector3;for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],i instanceof THREE.Face3?i.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]:i instanceof THREE.Face4&&(i.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3])}else for(o=this.__tmpVertices,t=0,e=this.vertices.length;t<e;t++)o[t].set(0,0,0);for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],i instanceof THREE.Face3?(o[i.a].addSelf(i.normal),o[i.b].addSelf(i.normal),o[i.c].addSelf(i.normal)):i instanceof THREE.Face4&&(o[i.a].addSelf(i.normal),o[i.b].addSelf(i.normal),o[i.c].addSelf(i.normal),o[i.d].addSelf(i.normal));for(t=0,e=this.vertices.length;t<e;t++)o[t].normalize();for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],i instanceof THREE.Face3?(i.vertexNormals[0].copy(o[i.a]),i.vertexNormals[1].copy(o[i.b]),i.vertexNormals[2].copy(o[i.c])):i instanceof THREE.Face4&&(i.vertexNormals[0].copy(o[i.a]),i.vertexNormals[1].copy(o[i.b]),i.vertexNormals[2].copy(o[i.c]),i.vertexNormals[3].copy(o[i.d]))},computeMorphNormals:function(){var t,e,i,o,n;for(i=0,o=this.faces.length;i<o;i++)for(n=this.faces[i],n.__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),t=0,e=n.vertexNormals.length;t<e;t++)n.__originalVertexNormals[t]?n.__originalVertexNormals[t].copy(n.vertexNormals[t]):n.__originalVertexNormals[t]=n.vertexNormals[t].clone();var r=new THREE.Geometry;for(r.faces=this.faces,t=0,e=this.morphTargets.length;t<e;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];var s,a,h=this.morphNormals[t].faceNormals,l=this.morphNormals[t].vertexNormals;for(i=0,o=this.faces.length;i<o;i++)n=this.faces[i],s=new THREE.Vector3,a=n instanceof THREE.Face3?{a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3}:{a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3,d:new THREE.Vector3},h.push(s),l.push(a)}for(h=this.morphNormals[t],r.vertices=this.morphTargets[t].vertices,r.computeFaceNormals(),r.computeVertexNormals(),i=0,o=this.faces.length;i<o;i++)n=this.faces[i],s=h.faceNormals[i],a=h.vertexNormals[i],s.copy(n.normal),n instanceof THREE.Face3?(a.a.copy(n.vertexNormals[0]),a.b.copy(n.vertexNormals[1]),a.c.copy(n.vertexNormals[2])):(a.a.copy(n.vertexNormals[0]),a.b.copy(n.vertexNormals[1]),a.c.copy(n.vertexNormals[2]),a.d.copy(n.vertexNormals[3]))}for(i=0,o=this.faces.length;i<o;i++)n=this.faces[i],n.normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeTangents:function(){function t(t,e,i,o,n,r,w){a=t.vertices[e],h=t.vertices[i],l=t.vertices[o],c=s[n],u=s[r],m=s[w],d=h.x-a.x,p=l.x-a.x,_=h.y-a.y,f=l.y-a.y,y=h.z-a.z,g=l.z-a.z,v=u.u-c.u,x=m.u-c.u,b=u.v-c.v,E=m.v-c.v,T=1/(v*E-x*b),R.set((E*d-b*p)*T,(E*_-b*f)*T,(E*y-b*g)*T),M.set((v*p-x*d)*T,(v*f-x*_)*T,(v*g-x*y)*T),S[e].addSelf(R),S[i].addSelf(R),S[o].addSelf(R),C[e].addSelf(M),C[i].addSelf(M),C[o].addSelf(M)}var e,i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b,E,T,w,S=[],C=[],R=new THREE.Vector3,M=new THREE.Vector3,D=new THREE.Vector3,A=new THREE.Vector3,B=new THREE.Vector3;for(e=0,i=this.vertices.length;e<i;e++)S[e]=new THREE.Vector3,C[e]=new THREE.Vector3;for(e=0,i=this.faces.length;e<i;e++)r=this.faces[e],s=this.faceVertexUvs[0][e],r instanceof THREE.Face3?t(this,r.a,r.b,r.c,0,1,2):r instanceof THREE.Face4&&(t(this,r.a,r.b,r.d,0,1,3),t(this,r.b,r.c,r.d,1,2,3));var I=["a","b","c","d"];for(e=0,i=this.faces.length;e<i;e++)for(r=this.faces[e],o=0;o<r.vertexNormals.length;o++)B.copy(r.vertexNormals[o]),n=r[I[o]],w=S[n],D.copy(w),D.subSelf(B.multiplyScalar(B.dot(w))).normalize(),A.cross(r.vertexNormals[o],w),n=A.dot(C[n]),n=0>n?-1:1,r.vertexTangents[o]=new THREE.Vector4(D.x,D.y,D.z,n);this.hasTangents=!0},computeBoundingBox:function(){if(this.boundingBox||(this.boundingBox={min:new THREE.Vector3,max:new THREE.Vector3}),0<this.vertices.length){var t;t=this.vertices[0],this.boundingBox.min.copy(t),this.boundingBox.max.copy(t);for(var e=this.boundingBox.min,i=this.boundingBox.max,o=1,n=this.vertices.length;o<n;o++)t=this.vertices[o],t.x<e.x?e.x=t.x:t.x>i.x&&(i.x=t.x),t.y<e.y?e.y=t.y:t.y>i.y&&(i.y=t.y),t.z<e.z?e.z=t.z:t.z>i.z&&(i.z=t.z)}else this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){var t=0;null===this.boundingSphere&&(this.boundingSphere={radius:0});for(var e=0,i=this.vertices.length;e<i;e++){var o=this.vertices[e].lengthSq();o>t&&(t=o)}this.boundingSphere.radius=Math.sqrt(t)},mergeVertices:function(){var t,e,i,o,n,r={},s=[],a=[],h=Math.pow(10,4);for(e=0,i=this.vertices.length;e<i;e++)t=this.vertices[e],t=[Math.round(t.x*h),Math.round(t.y*h),Math.round(t.z*h)].join("_"),void 0===r[t]?(r[t]=e,s.push(this.vertices[e]),a[e]=s.length-1):a[e]=a[r[t]];for(e=0,i=this.faces.length;e<i;e++)if((r=this.faces[e])instanceof THREE.Face3)r.a=a[r.a],r.b=a[r.b],r.c=a[r.c];else if(r instanceof THREE.Face4)for(r.a=a[r.a],r.b=a[r.b],r.c=a[r.c],r.d=a[r.d],t=[r.a,r.b,r.c,r.d],h=3;0<h;h--)if(t.indexOf(r["abcd"[h]])!==h){for(t.splice(h,1),this.faces[e]=new THREE.Face3(t[0],t[1],t[2],r.normal,r.color,r.materialIndex),t=0,o=this.faceVertexUvs.length;t<o;t++)(n=this.faceVertexUvs[t][e])&&n.splice(h,1);this.faces[e].vertexColors=r.vertexColors;break}return a=this.vertices.length-s.length,this.vertices=s,a},clone:function(){},deallocate:function(){var t=THREE.GeometryLibrary.indexOf(this);-1!==t&&THREE.GeometryLibrary.splice(t,1)}},THREE.GeometryIdCount=0,THREE.GeometryLibrary=[],THREE.BufferGeometry=function(){this.id=THREE.GeometryCount++,this.attributes={},this.dynamic=!1,this.boundingSphere=this.boundingBox=null,this.hasTangents=!1,this.morphTargets=[]},THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,applyMatrix:function(t){var e,i;this.attributes.position&&(e=this.attributes.position.array),this.attributes.normal&&(i=this.attributes.normal.array),void 0!==e&&(t.multiplyVector3Array(e),this.verticesNeedUpdate=!0),void 0!==i&&(e=new THREE.Matrix4,e.extractRotation(t),e.multiplyVector3Array(i),this.normalsNeedUpdate=!0)},computeBoundingBox:function(){this.boundingBox||(this.boundingBox={min:new THREE.Vector3(1/0,1/0,1/0),max:new THREE.Vector3(-1/0,-1/0,-1/0)});var t=this.attributes.position.array;if(t)for(var e,i,o,n=this.boundingBox,r=0,s=t.length;r<s;r+=3)e=t[r],i=t[r+1],o=t[r+2],e<n.min.x?n.min.x=e:e>n.max.x&&(n.max.x=e),i<n.min.y?n.min.y=i:i>n.max.y&&(n.max.y=i),o<n.min.z?n.min.z=o:o>n.max.z&&(n.max.z=o);void 0!==t&&0!==t.length||(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0))},computeBoundingSphere:function(){this.boundingSphere||(this.boundingSphere={radius:0});var t=this.attributes.position.array;if(t){for(var e,i,o,n=0,r=0,s=t.length;r<s;r+=3)e=t[r],i=t[r+1],o=t[r+2],(e=e*e+i*i+o*o)>n&&(n=e);this.boundingSphere.radius=Math.sqrt(n)}},computeVertexNormals:function(){if(this.attributes.position&&this.attributes.index){var t,e,i,o;if(t=this.attributes.position.array.length,void 0===this.attributes.normal)this.attributes.normal={itemSize:3,array:new Float32Array(t),numItems:t};else for(t=0,e=this.attributes.normal.array.length;t<e;t++)this.attributes.normal.array[t]=0;var n,r,s,a,h,l,c=this.offsets,u=this.attributes.index.array,m=this.attributes.position.array,d=this.attributes.normal.array,p=new THREE.Vector3,_=new THREE.Vector3,f=new THREE.Vector3,y=new THREE.Vector3,g=new THREE.Vector3;for(i=0,o=c.length;i<o;++i){e=c[i].start,n=c[i].count;var v=c[i].index;for(t=e,e+=n;t<e;t+=3)n=v+u[t],r=v+u[t+1],s=v+u[t+2],a=m[3*n],h=m[3*n+1],l=m[3*n+2],p.set(a,h,l),a=m[3*r],h=m[3*r+1],l=m[3*r+2],_.set(a,h,l),a=m[3*s],h=m[3*s+1],l=m[3*s+2],f.set(a,h,l),y.sub(f,_),g.sub(p,_),y.crossSelf(g),d[3*n]+=y.x,d[3*n+1]+=y.y,d[3*n+2]+=y.z,d[3*r]+=y.x,d[3*r+1]+=y.y,d[3*r+2]+=y.z,
d[3*s]+=y.x,d[3*s+1]+=y.y,d[3*s+2]+=y.z}for(t=0,e=d.length;t<e;t+=3)a=d[t],h=d[t+1],l=d[t+2],i=1/Math.sqrt(a*a+h*h+l*l),d[t]*=i,d[t+1]*=i,d[t+2]*=i;this.normalsNeedUpdate=!0}},computeTangents:function(){function t(t){z.x=o[3*t],z.y=o[3*t+1],z.z=o[3*t+2],N.copy(z),L=h[t],k.copy(L),k.subSelf(z.multiplyScalar(z.dot(L))).normalize(),F.cross(N,L),V=F.dot(l[t]),P=0>V?-1:1,a[4*t]=k.x,a[4*t+1]=k.y,a[4*t+2]=k.z,a[4*t+3]=P}if(void 0===this.attributes.index||void 0===this.attributes.position||void 0===this.attributes.normal||void 0===this.attributes.uv)console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");else{var e=this.attributes.index.array,i=this.attributes.position.array,o=this.attributes.normal.array,n=this.attributes.uv.array,r=i.length/3;if(void 0===this.attributes.tangent){var s=4*r;this.attributes.tangent={itemSize:4,array:new Float32Array(s),numItems:s}}for(var a=this.attributes.tangent.array,h=[],l=[],s=0;s<r;s++)h[s]=new THREE.Vector3,l[s]=new THREE.Vector3;var c,u,m,d,p,_,f,y,g,v,x,b,E,T,w,S,C,R,M,D,A,B,r=new THREE.Vector3,s=new THREE.Vector3,I=this.offsets;for(R=0,M=I.length;R<M;++R){C=I[R].start,D=I[R].count;var H=I[R].index;for(S=C,C+=D;S<C;S+=3)D=H+e[S],A=H+e[S+1],B=H+e[S+2],c=i[3*D],u=i[3*D+1],m=i[3*D+2],d=i[3*A],p=i[3*A+1],_=i[3*A+2],f=i[3*B],y=i[3*B+1],g=i[3*B+2],v=n[2*D],x=n[2*D+1],b=n[2*A],E=n[2*A+1],T=n[2*B],w=n[2*B+1],d-=c,c=f-c,p-=u,u=y-u,_-=m,m=g-m,b-=v,v=T-v,E-=x,x=w-x,w=1/(b*x-v*E),r.set((x*d-E*c)*w,(x*p-E*u)*w,(x*_-E*m)*w),s.set((b*c-v*d)*w,(b*u-v*p)*w,(b*m-v*_)*w),h[D].addSelf(r),h[A].addSelf(r),h[B].addSelf(r),l[D].addSelf(s),l[A].addSelf(s),l[B].addSelf(s)}var P,L,V,k=new THREE.Vector3,F=new THREE.Vector3,z=new THREE.Vector3,N=new THREE.Vector3;for(R=0,M=I.length;R<M;++R)for(C=I[R].start,D=I[R].count,H=I[R].index,S=C,C+=D;S<C;S+=3)D=H+e[S],A=H+e[S+1],B=H+e[S+2],t(D),t(A),t(B);this.tangentsNeedUpdate=this.hasTangents=!0}}},THREE.Spline=function(t){function e(t,e,i,o,n,r,s){return t=.5*(i-t),o=.5*(o-e),(2*(e-i)+t+o)*s+(-3*(e-i)-2*t-o)*r+t*n+e}this.points=t;var i,o,n,r,s,a,h,l,c,u=[],m={x:0,y:0,z:0};this.initFromArray=function(t){this.points=[];for(var e=0;e<t.length;e++)this.points[e]={x:t[e][0],y:t[e][1],z:t[e][2]}},this.getPoint=function(t){return i=(this.points.length-1)*t,o=Math.floor(i),n=i-o,u[0]=0===o?o:o-1,u[1]=o,u[2]=o>this.points.length-2?this.points.length-1:o+1,u[3]=o>this.points.length-3?this.points.length-1:o+2,a=this.points[u[0]],h=this.points[u[1]],l=this.points[u[2]],c=this.points[u[3]],r=n*n,s=n*r,m.x=e(a.x,h.x,l.x,c.x,n,r,s),m.y=e(a.y,h.y,l.y,c.y,n,r,s),m.z=e(a.z,h.z,l.z,c.z,n,r,s),m},this.getControlPointsArray=function(){var t,e,i=this.points.length,o=[];for(t=0;t<i;t++)e=this.points[t],o[t]=[e.x,e.y,e.z];return o},this.getLength=function(t){var e,i,o,n=e=e=0,r=new THREE.Vector3,s=new THREE.Vector3,a=[],h=0;for(a[0]=0,t||(t=100),i=this.points.length*t,r.copy(this.points[0]),t=1;t<i;t++)e=t/i,o=this.getPoint(e),s.copy(o),h+=s.distanceTo(r),r.copy(o),e*=this.points.length-1,(e=Math.floor(e))!=n&&(a[e]=h,n=e);return a[a.length]=h,{chunks:a,total:h}},this.reparametrizeByArcLength=function(t){var e,i,o,n,r,s,a=[],h=new THREE.Vector3,l=this.getLength();for(a.push(h.copy(this.points[0]).clone()),e=1;e<this.points.length;e++){for(i=l.chunks[e]-l.chunks[e-1],s=Math.ceil(t*i/l.total),n=(e-1)/(this.points.length-1),r=e/(this.points.length-1),i=1;i<s-1;i++)o=n+i*(1/s)*(r-n),o=this.getPoint(o),a.push(h.copy(o).clone());a.push(h.copy(this.points[e]).clone())}this.points=a}},THREE.Camera=function(){THREE.Object3D.call(this),this.matrixWorldInverse=new THREE.Matrix4,this.projectionMatrix=new THREE.Matrix4,this.projectionMatrixInverse=new THREE.Matrix4},THREE.Camera.prototype=Object.create(THREE.Object3D.prototype),THREE.Camera.prototype.lookAt=function(t){this.matrix.lookAt(this.position,t,this.up),!0===this.rotationAutoUpdate&&this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},THREE.OrthographicCamera=function(t,e,i,o,n,r){THREE.Camera.call(this),this.left=t,this.right=e,this.top=i,this.bottom=o,this.near=void 0!==n?n:.1,this.far=void 0!==r?r:2e3,this.updateProjectionMatrix()},THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype),THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)},THREE.PerspectiveCamera=function(t,e,i,o){THREE.Camera.call(this),this.fov=void 0!==t?t:50,this.aspect=void 0!==e?e:1,this.near=void 0!==i?i:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype),THREE.PerspectiveCamera.prototype.setLens=function(t,e){void 0===e&&(e=24),this.fov=2*Math.atan(e/(2*t))*(180/Math.PI),this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.setViewOffset=function(t,e,i,o,n,r){this.fullWidth=t,this.fullHeight=e,this.x=i,this.y=o,this.width=n,this.height=r,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var t=this.fullWidth/this.fullHeight,e=Math.tan(this.fov*Math.PI/360)*this.near,i=-e,o=t*i,t=Math.abs(t*e-o),i=Math.abs(e-i);this.projectionMatrix.makeFrustum(o+this.x*t/this.fullWidth,o+(this.x+this.width)*t/this.fullWidth,e-(this.y+this.height)*i/this.fullHeight,e-this.y*i/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},THREE.Light=function(t){THREE.Object3D.call(this),this.color=new THREE.Color(t)},THREE.Light.prototype=Object.create(THREE.Object3D.prototype),THREE.AmbientLight=function(t){THREE.Light.call(this,t)},THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype),THREE.DirectionalLight=function(t,e,i){THREE.Light.call(this,t),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Object3D,this.intensity=void 0!==e?e:1,this.distance=void 0!==i?i:0,this.onlyShadow=this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraTop=this.shadowCameraRight=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype),THREE.HemisphereLight=function(t,e,i){THREE.Light.call(this,t),this.groundColor=new THREE.Color(e),this.position=new THREE.Vector3(0,100,0),this.intensity=void 0!==i?i:1},THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype),THREE.PointLight=function(t,e,i){THREE.Light.call(this,t),this.position=new THREE.Vector3(0,0,0),this.intensity=void 0!==e?e:1,this.distance=void 0!==i?i:0},THREE.PointLight.prototype=Object.create(THREE.Light.prototype),THREE.SpotLight=function(t,e,i,o,n){THREE.Light.call(this,t),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Object3D,this.intensity=void 0!==e?e:1,this.distance=void 0!==i?i:0,this.angle=void 0!==o?o:Math.PI/2,this.exponent=void 0!==n?n:10,this.onlyShadow=this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},THREE.SpotLight.prototype=Object.create(THREE.Light.prototype),THREE.Loader=function(t){this.statusDomElement=(this.showStatus=t)?THREE.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var t=document.createElement("div");return t.style.position="absolute",t.style.right="0px",t.style.top="0px",t.style.fontSize="0.8em",t.style.textAlign="left",t.style.background="rgba(0,0,0,0.25)",t.style.color="#fff",t.style.width="120px",t.style.padding="0.5em 0.5em 0.5em 0.5em",t.style.zIndex=1e3,t.innerHTML="Loading ...",t},updateProgress:function(t){var e="Loaded ",e=t.total?e+((100*t.loaded/t.total).toFixed(0)+"%"):e+((t.loaded/1e3).toFixed(2)+" KB");this.statusDomElement.innerHTML=e},extractUrlBase:function(t){return t=t.split("/"),t.pop(),(1>t.length?".":t.join("/"))+"/"},initMaterials:function(t,e,i){t.materials=[];for(var o=0;o<e.length;++o)t.materials[o]=THREE.Loader.prototype.createMaterial(e[o],i)},hasNormals:function(t){var e,i=t.materials.length;for(e=0;e<i;e++)if(t.materials[e]instanceof THREE.ShaderMaterial)return!0;return!1},createMaterial:function(t,e){function i(t){return t=Math.log(t)/Math.LN2,Math.floor(t)==t}function o(t){return t=Math.log(t)/Math.LN2,Math.pow(2,Math.round(t))}function n(t,n,r,a,h,l,c){var u=r.toLowerCase().endsWith(".dds"),m=e+"/"+r;if(u){var d=THREE.ImageUtils.loadCompressedTexture(m);t[n]=d}else d=document.createElement("canvas"),t[n]=new THREE.Texture(d);if(t[n].sourceFile=r,a&&(t[n].repeat.set(a[0],a[1]),1!==a[0]&&(t[n].wrapS=THREE.RepeatWrapping),1!==a[1])&&(t[n].wrapT=THREE.RepeatWrapping),h&&t[n].offset.set(h[0],h[1]),l&&(r={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==r[l[0]]&&(t[n].wrapS=r[l[0]]),void 0!==r[l[1]])&&(t[n].wrapT=r[l[1]]),c&&(t[n].anisotropy=c),!u){var p=t[n],t=new Image;t.onload=function(){if(i(this.width)&&i(this.height))p.image=this;else{var t=o(this.width),e=o(this.height);p.image.width=t,p.image.height=e,p.image.getContext("2d").drawImage(this,0,0,t,e)}p.needsUpdate=!0},t.crossOrigin=s.crossOrigin,t.src=m}}function r(t){return(255*t[0]<<16)+(255*t[1]<<8)+255*t[2]}var s=this,a="MeshLambertMaterial",h={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(t.shading){var l=t.shading.toLowerCase();"phong"===l?a="MeshPhongMaterial":"basic"===l&&(a="MeshBasicMaterial")}return void 0!==t.blending&&void 0!==THREE[t.blending]&&(h.blending=THREE[t.blending]),(void 0!==t.transparent||1>t.opacity)&&(h.transparent=t.transparent),void 0!==t.depthTest&&(h.depthTest=t.depthTest),void 0!==t.depthWrite&&(h.depthWrite=t.depthWrite),void 0!==t.visible&&(h.visible=t.visible),void 0!==t.flipSided&&(h.side=THREE.BackSide),void 0!==t.doubleSided&&(h.side=THREE.DoubleSide),void 0!==t.wireframe&&(h.wireframe=t.wireframe),void 0!==t.vertexColors&&("face"===t.vertexColors?h.vertexColors=THREE.FaceColors:t.vertexColors&&(h.vertexColors=THREE.VertexColors)),t.colorDiffuse?h.color=r(t.colorDiffuse):t.DbgColor&&(h.color=t.DbgColor),t.colorSpecular&&(h.specular=r(t.colorSpecular)),t.colorAmbient&&(h.ambient=r(t.colorAmbient)),t.transparency&&(h.opacity=t.transparency),t.specularCoef&&(h.shininess=t.specularCoef),t.mapDiffuse&&e&&n(h,"map",t.mapDiffuse,t.mapDiffuseRepeat,t.mapDiffuseOffset,t.mapDiffuseWrap,t.mapDiffuseAnisotropy),t.mapLight&&e&&n(h,"lightMap",t.mapLight,t.mapLightRepeat,t.mapLightOffset,t.mapLightWrap,t.mapLightAnisotropy),t.mapBump&&e&&n(h,"bumpMap",t.mapBump,t.mapBumpRepeat,t.mapBumpOffset,t.mapBumpWrap,t.mapBumpAnisotropy),t.mapNormal&&e&&n(h,"normalMap",t.mapNormal,t.mapNormalRepeat,t.mapNormalOffset,t.mapNormalWrap,t.mapNormalAnisotropy),t.mapSpecular&&e&&n(h,"specularMap",t.mapSpecular,t.mapSpecularRepeat,t.mapSpecularOffset,t.mapSpecularWrap,t.mapSpecularAnisotropy),t.mapBumpScale&&(h.bumpScale=t.mapBumpScale),t.mapNormal?(a=THREE.ShaderUtils.lib.normal,l=THREE.UniformsUtils.clone(a.uniforms),l.tNormal.value=h.normalMap,t.mapNormalFactor&&l.uNormalScale.value.set(t.mapNormalFactor,t.mapNormalFactor),h.map&&(l.tDiffuse.value=h.map,l.enableDiffuse.value=!0),h.specularMap&&(l.tSpecular.value=h.specularMap,l.enableSpecular.value=!0),h.lightMap&&(l.tAO.value=h.lightMap,l.enableAO.value=!0),l.uDiffuseColor.value.setHex(h.color),l.uSpecularColor.value.setHex(h.specular),l.uAmbientColor.value.setHex(h.ambient),l.uShininess.value=h.shininess,void 0!==h.opacity&&(l.uOpacity.value=h.opacity),h=new THREE.ShaderMaterial({fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:l,lights:!0,fog:!0})):h=new THREE[a](h),void 0!==t.DbgName&&(h.name=t.DbgName),h}},THREE.BinaryLoader=function(t){THREE.Loader.call(this,t)},THREE.BinaryLoader.prototype=Object.create(THREE.Loader.prototype),THREE.BinaryLoader.prototype.load=function(t,e,i,o){var i=i||this.extractUrlBase(t),o=o||this.extractUrlBase(t),n=this.showProgress?THREE.Loader.prototype.updateProgress:null;this.onLoadStart(),this.loadAjaxJSON(this,t,e,i,o,n)},THREE.BinaryLoader.prototype.loadAjaxJSON=function(t,e,i,o,n,r){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==s.readyState)if(200==s.status||0==s.status){var a=JSON.parse(s.responseText);t.loadAjaxBuffers(a,i,n,o,r)}else console.error("THREE.BinaryLoader: Couldn't load ["+e+"] ["+s.status+"]")},s.open("GET",e,!0),s.send(null)},THREE.BinaryLoader.prototype.loadAjaxBuffers=function(t,e,i,o,n){var r=new XMLHttpRequest,s=i+"/"+t.buffers,a=0;r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status||0==r.status){var i=r.response;void 0===i&&(i=new Uint8Array(r.responseBody).buffer),THREE.BinaryLoader.prototype.createBinModel(i,e,o,t.materials)}else console.error("THREE.BinaryLoader: Couldn't load ["+s+"] ["+r.status+"]");else 3==r.readyState?n&&(0==a&&(a=r.getResponseHeader("Content-Length")),n({total:a,loaded:r.responseText.length})):2==r.readyState&&(a=r.getResponseHeader("Content-Length"))},r.open("GET",s,!0),r.responseType="arraybuffer",r.send(null)},THREE.BinaryLoader.prototype.createBinModel=function(t,e,i,o){var n=function(e){function i(t){return t%4?4-t%4:0}function n(t,e){return new Uint8Array(t,e,1)[0]}function r(t,e){return new Uint32Array(t,e,1)[0]}function s(e,i){var o,n,r,s,a,h,l,c,u=new Uint32Array(t,i,3*e);for(o=0;o<e;o++){n=u[3*o],r=u[3*o+1],s=u[3*o+2],a=H[2*n],n=H[2*n+1],h=H[2*r],l=H[2*r+1],r=H[2*s],c=H[2*s+1],s=A.faceVertexUvs[0];var m=[];m.push(new THREE.UV(a,n)),m.push(new THREE.UV(h,l)),m.push(new THREE.UV(r,c)),s.push(m)}}function a(e,i){var o,n,r,s,a,h,l,c,u,m,d=new Uint32Array(t,i,4*e);for(o=0;o<e;o++){n=d[4*o],r=d[4*o+1],s=d[4*o+2],a=d[4*o+3],h=H[2*n],n=H[2*n+1],l=H[2*r],u=H[2*r+1],c=H[2*s],m=H[2*s+1],s=H[2*a],r=H[2*a+1],a=A.faceVertexUvs[0];var p=[];p.push(new THREE.UV(h,n)),p.push(new THREE.UV(l,u)),p.push(new THREE.UV(c,m)),p.push(new THREE.UV(s,r)),a.push(p)}}function h(e,i,o){for(var n,r,s,a,i=new Uint32Array(t,i,3*e),h=new Uint16Array(t,o,e),o=0;o<e;o++)n=i[3*o],r=i[3*o+1],s=i[3*o+2],a=h[o],A.faces.push(new THREE.Face3(n,r,s,null,null,a))}function l(e,i,o){for(var n,r,s,a,h,i=new Uint32Array(t,i,4*e),l=new Uint16Array(t,o,e),o=0;o<e;o++)n=i[4*o],r=i[4*o+1],s=i[4*o+2],a=i[4*o+3],h=l[o],A.faces.push(new THREE.Face4(n,r,s,a,null,null,h))}function c(e,i,o,n){for(var r,s,a,h,l,c,u,i=new Uint32Array(t,i,3*e),o=new Uint32Array(t,o,3*e),m=new Uint16Array(t,n,e),n=0;n<e;n++){r=i[3*n],s=i[3*n+1],a=i[3*n+2],l=o[3*n],c=o[3*n+1],u=o[3*n+2],h=m[n];var d=I[3*c],p=I[3*c+1];c=I[3*c+2];var _=I[3*u],f=I[3*u+1];u=I[3*u+2],A.faces.push(new THREE.Face3(r,s,a,[new THREE.Vector3(I[3*l],I[3*l+1],I[3*l+2]),new THREE.Vector3(d,p,c),new THREE.Vector3(_,f,u)],null,h))}}function u(e,i,o,n){for(var r,s,a,h,l,c,u,m,d,i=new Uint32Array(t,i,4*e),o=new Uint32Array(t,o,4*e),p=new Uint16Array(t,n,e),n=0;n<e;n++){r=i[4*n],s=i[4*n+1],a=i[4*n+2],h=i[4*n+3],c=o[4*n],u=o[4*n+1],m=o[4*n+2],d=o[4*n+3],l=p[n];var _=I[3*u],f=I[3*u+1];u=I[3*u+2];var y=I[3*m],g=I[3*m+1];m=I[3*m+2];var v=I[3*d],x=I[3*d+1];d=I[3*d+2],A.faces.push(new THREE.Face4(r,s,a,h,[new THREE.Vector3(I[3*c],I[3*c+1],I[3*c+2]),new THREE.Vector3(_,f,u),new THREE.Vector3(y,g,m),new THREE.Vector3(v,x,d)],null,l))}}var m,d,p,_,f,y,g,v,x,b,E,T,w,S,C,R,M,D,A=this,B=0,I=[],H=[];for(THREE.Geometry.call(this),THREE.Loader.prototype.initMaterials(A,o,e),C=t,M=B,e=new Uint8Array(C,M,12),b="",w=0;12>w;w++)b+=String.fromCharCode(e[M+w]);m=n(C,M+12),n(C,M+13),n(C,M+14),n(C,M+15),d=n(C,M+16),p=n(C,M+17),_=n(C,M+18),f=n(C,M+19),y=r(C,M+20),g=r(C,M+20+4),v=r(C,M+20+8),x=r(C,M+20+12),b=r(C,M+20+16),E=r(C,M+20+20),T=r(C,M+20+24),w=r(C,M+20+28),e=r(C,M+20+32),S=r(C,M+20+36),C=r(C,M+20+40),B+=m,M=3*d+f,D=4*d+f,R=x*M,m=b*(M+3*p),d=E*(M+3*_),f=T*(M+3*p+3*_),M=w*D,p=e*(D+4*p),_=S*(D+4*_),D=B;var P,L,V,k,B=new Float32Array(t,B,3*y);for(P=0;P<y;P++)L=B[3*P],V=B[3*P+1],k=B[3*P+2],A.vertices.push(new THREE.Vector3(L,V,k));if(y=B=D+3*y*Float32Array.BYTES_PER_ELEMENT,g)for(B=new Int8Array(t,B,3*g),D=0;D<g;D++)P=B[3*D],L=B[3*D+1],V=B[3*D+2],I.push(P/127,L/127,V/127);if(B=y+3*g*Int8Array.BYTES_PER_ELEMENT,g=B+=i(3*g),v)for(B=new Float32Array(t,B,2*v),y=0;y<v;y++)D=B[2*y],P=B[2*y+1],H.push(D,P);v=B=g+2*v*Float32Array.BYTES_PER_ELEMENT,R=v+R+i(2*x),g=R+m+i(2*b),m=g+d+i(2*E),d=m+f+i(2*T),M=d+M+i(2*w),f=M+p+i(2*e),p=f+_+i(2*S),E&&(_=g+3*E*Uint32Array.BYTES_PER_ELEMENT,h(E,g,_+3*E*Uint32Array.BYTES_PER_ELEMENT),s(E,_)),T&&(E=m+3*T*Uint32Array.BYTES_PER_ELEMENT,_=E+3*T*Uint32Array.BYTES_PER_ELEMENT,c(T,m,E,_+3*T*Uint32Array.BYTES_PER_ELEMENT),s(T,_)),S&&(T=f+4*S*Uint32Array.BYTES_PER_ELEMENT,l(S,f,T+4*S*Uint32Array.BYTES_PER_ELEMENT),a(S,T)),C&&(S=p+4*C*Uint32Array.BYTES_PER_ELEMENT,T=S+4*C*Uint32Array.BYTES_PER_ELEMENT,u(C,p,S,T+4*C*Uint32Array.BYTES_PER_ELEMENT),a(C,T)),x&&h(x,v,v+3*x*Uint32Array.BYTES_PER_ELEMENT),b&&(x=R+3*b*Uint32Array.BYTES_PER_ELEMENT,c(b,R,x,x+3*b*Uint32Array.BYTES_PER_ELEMENT)),w&&l(w,d,d+4*w*Uint32Array.BYTES_PER_ELEMENT),e&&(b=M+4*e*Uint32Array.BYTES_PER_ELEMENT,u(e,M,b,b+4*e*Uint32Array.BYTES_PER_ELEMENT)),this.computeCentroids(),this.computeFaceNormals(),THREE.Loader.prototype.hasNormals(this)&&this.computeTangents()};n.prototype=Object.create(THREE.Geometry.prototype),e(new n(i))},THREE.ImageLoader=function(){THREE.EventTarget.call(this),this.crossOrigin=null},THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,load:function(t,e){var i=this;void 0===e&&(e=new Image),e.addEventListener("load",function(){i.dispatchEvent({type:"load",content:e})},!1),e.addEventListener("error",function(){i.dispatchEvent({type:"error",message:"Couldn't load URL ["+t+"]"})},!1),i.crossOrigin&&(e.crossOrigin=i.crossOrigin),e.src=t}},THREE.JSONLoader=function(t){THREE.Loader.call(this,t)},THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype),THREE.JSONLoader.prototype.load=function(t,e,i){i=i||this.extractUrlBase(t),this.onLoadStart(),this.loadAjaxJSON(this,t,e,i)},THREE.JSONLoader.prototype.loadAjaxJSON=function(t,e,i,o,n){var r=new XMLHttpRequest,s=0;r.onreadystatechange=function(){if(r.readyState===r.DONE)if(200===r.status||0===r.status){if(r.responseText){var a=JSON.parse(r.responseText);t.createModel(a,i,o)}else console.warn("THREE.JSONLoader: ["+e+"] seems to be unreachable or file there is empty");t.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+e+"] ["+r.status+"]");else r.readyState===r.LOADING?n&&(0===s&&(s=r.getResponseHeader("Content-Length")),n({total:s,loaded:r.responseText.length})):r.readyState===r.HEADERS_RECEIVED&&(s=r.getResponseHeader("Content-Length"))},r.open("GET",e,!0),r.send(null)},THREE.JSONLoader.prototype.createModel=function(t,e,i){var o=new THREE.Geometry,n=void 0!==t.scale?1/t.scale:1;this.initMaterials(o,t.materials,i);var r,s,a,h,l,c,u,m,d,p,_,f,y,g,v=t.faces;d=t.vertices;var x=t.normals,b=t.colors,E=0;for(r=0;r<t.uvs.length;r++)t.uvs[r].length&&E++;for(r=0;r<E;r++)o.faceUvs[r]=[],o.faceVertexUvs[r]=[];for(i=0,h=d.length;i<h;)l=new THREE.Vector3,l.x=d[i++]*n,l.y=d[i++]*n,l.z=d[i++]*n,o.vertices.push(l);for(i=0,h=v.length;i<h;){if(d=v[i++],l=1&d,a=2&d,r=4&d,s=8&d,u=16&d,c=32&d,p=64&d,d&=128,l?(_=new THREE.Face4,_.a=v[i++],_.b=v[i++],_.c=v[i++],_.d=v[i++],l=4):(_=new THREE.Face3,_.a=v[i++],_.b=v[i++],_.c=v[i++],l=3),a&&(a=v[i++],_.materialIndex=a),a=o.faces.length,r)for(r=0;r<E;r++)f=t.uvs[r],m=v[i++],g=f[2*m],m=f[2*m+1],o.faceUvs[r][a]=new THREE.UV(g,m);if(s)for(r=0;r<E;r++){for(f=t.uvs[r],y=[],s=0;s<l;s++)m=v[i++],g=f[2*m],m=f[2*m+1],y[s]=new THREE.UV(g,m);o.faceVertexUvs[r][a]=y}if(u&&(u=3*v[i++],s=new THREE.Vector3,s.x=x[u++],s.y=x[u++],s.z=x[u],_.normal=s),c)for(r=0;r<l;r++)u=3*v[i++],s=new THREE.Vector3,s.x=x[u++],s.y=x[u++],s.z=x[u],_.vertexNormals.push(s);if(p&&(c=v[i++],c=new THREE.Color(b[c]),_.color=c),d)for(r=0;r<l;r++)c=v[i++],c=new THREE.Color(b[c]),_.vertexColors.push(c);o.faces.push(_)}if(t.skinWeights)for(i=0,h=t.skinWeights.length;i<h;i+=2)v=t.skinWeights[i],x=t.skinWeights[i+1],o.skinWeights.push(new THREE.Vector4(v,x,0,0));if(t.skinIndices)for(i=0,h=t.skinIndices.length;i<h;i+=2)v=t.skinIndices[i],x=t.skinIndices[i+1],o.skinIndices.push(new THREE.Vector4(v,x,0,0));if(o.bones=t.bones,o.animation=t.animation,void 0!==t.morphTargets)for(i=0,h=t.morphTargets.length;i<h;i++)for(o.morphTargets[i]={},o.morphTargets[i].name=t.morphTargets[i].name,o.morphTargets[i].vertices=[],b=o.morphTargets[i].vertices,E=t.morphTargets[i].vertices,v=0,x=E.length;v<x;v+=3)d=new THREE.Vector3,d.x=E[v]*n,d.y=E[v+1]*n,d.z=E[v+2]*n,b.push(d);if(void 0!==t.morphColors)for(i=0,h=t.morphColors.length;i<h;i++)for(o.morphColors[i]={},o.morphColors[i].name=t.morphColors[i].name,o.morphColors[i].colors=[],x=o.morphColors[i].colors,b=t.morphColors[i].colors,n=0,v=b.length;n<v;n+=3)E=new THREE.Color(16755200),E.setRGB(b[n],b[n+1],b[n+2]),x.push(E);o.computeCentroids(),o.computeFaceNormals(),this.hasNormals(o)&&o.computeTangents(),e(o)},THREE.LoadingMonitor=function(){THREE.EventTarget.call(this);var t=this,e=0,i=0,o=function(){e++,t.dispatchEvent({type:"progress",loaded:e,total:i}),e===i&&t.dispatchEvent({type:"load"})};this.add=function(t){i++,t.addEventListener("load",o,!1)}},THREE.GeometryLoader=function(){THREE.EventTarget.call(this),this.path=this.crossOrigin=null},THREE.GeometryLoader.prototype={constructor:THREE.GeometryLoader,load:function(t){var e=this,i=null;if(null===e.path){var o=t.split("/");o.pop(),e.path=1>o.length?".":o.join("/")}o=new XMLHttpRequest,o.addEventListener("load",function(o){o.target.responseText?i=e.parse(JSON.parse(o.target.responseText),n):e.dispatchEvent({type:"error",message:"Invalid file ["+t+"]"})},!1),o.addEventListener("error",function(){e.dispatchEvent({type:"error",message:"Couldn't load URL ["+t+"]"})},!1),o.open("GET",t,!0),o.send(null);var n=new THREE.LoadingMonitor;n.addEventListener("load",function(){e.dispatchEvent({type:"load",content:i})}),n.add(o)},parse:function(t,e){var i=this,o=new THREE.Geometry,n=void 0!==t.scale?1/t.scale:1;if(t.materials){o.materials=[];for(var r=0;r<t.materials.length;++r){var s=t.materials[r],a=function(t){return t=Math.log(t)/Math.LN2,Math.floor(t)==t},h=function(t){return t=Math.log(t)/Math.LN2,Math.pow(2,Math.round(t))},l=function(t,o,n,r,s,l){t[o]=new THREE.Texture,t[o].sourceFile=n,r&&(t[o].repeat.set(r[0],r[1]),1!==r[0]&&(t[o].wrapS=THREE.RepeatWrapping),1!==r[1])&&(t[o].wrapT=THREE.RepeatWrapping),s&&t[o].offset.set(s[0],s[1]),l&&(r={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==r[l[0]]&&(t[o].wrapS=r[l[0]]),void 0!==r[l[1]])&&(t[o].wrapT=r[l[1]]);var c=t[o],t=new THREE.ImageLoader;t.addEventListener("load",function(t){if(t=t.content,a(t.width)&&a(t.height))c.image=t;else{var e=h(t.width),i=h(t.height);c.image=document.createElement("canvas"),c.image.width=e,c.image.height=i,c.image.getContext("2d").drawImage(t,0,0,e,i)}c.needsUpdate=!0}),t.crossOrigin=i.crossOrigin,t.load(i.path+"/"+n),e&&e.add(t)},c=function(t){return(255*t[0]<<16)+(255*t[1]<<8)+255*t[2]},u="MeshLambertMaterial",m={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(s.shading){var d=s.shading.toLowerCase();"phong"===d?u="MeshPhongMaterial":"basic"===d&&(u="MeshBasicMaterial")}void 0!==s.blending&&void 0!==THREE[s.blending]&&(m.blending=THREE[s.blending]),(void 0!==s.transparent||1>s.opacity)&&(m.transparent=s.transparent),void 0!==s.depthTest&&(m.depthTest=s.depthTest),void 0!==s.depthWrite&&(m.depthWrite=s.depthWrite),void 0!==s.vertexColors&&("face"==s.vertexColors?m.vertexColors=THREE.FaceColors:s.vertexColors&&(m.vertexColors=THREE.VertexColors)),s.colorDiffuse?m.color=c(s.colorDiffuse):s.DbgColor&&(m.color=s.DbgColor),s.colorSpecular&&(m.specular=c(s.colorSpecular)),s.colorAmbient&&(m.ambient=c(s.colorAmbient)),s.transparency&&(m.opacity=s.transparency),s.specularCoef&&(m.shininess=s.specularCoef),void 0!==s.visible&&(m.visible=s.visible),void 0!==s.flipSided&&(m.side=THREE.BackSide),void 0!==s.doubleSided&&(m.side=THREE.DoubleSide),void 0!==s.wireframe&&(m.wireframe=s.wireframe),s.mapDiffuse&&l(m,"map",s.mapDiffuse,s.mapDiffuseRepeat,s.mapDiffuseOffset,s.mapDiffuseWrap),s.mapLight&&l(m,"lightMap",s.mapLight,s.mapLightRepeat,s.mapLightOffset,s.mapLightWrap),s.mapBump&&l(m,"bumpMap",s.mapBump,s.mapBumpRepeat,s.mapBumpOffset,s.mapBumpWrap),s.mapNormal&&l(m,"normalMap",s.mapNormal,s.mapNormalRepeat,s.mapNormalOffset,s.mapNormalWrap),s.mapSpecular&&l(m,"specularMap",s.mapSpecular,s.mapSpecularRepeat,s.mapSpecularOffset,s.mapSpecularWrap),s.mapNormal?(l=THREE.ShaderUtils.lib.normal,c=THREE.UniformsUtils.clone(l.uniforms),c.tNormal.value=m.normalMap,s.mapNormalFactor&&c.uNormalScale.value.set(s.mapNormalFactor,s.mapNormalFactor),m.map&&(c.tDiffuse.value=m.map,c.enableDiffuse.value=!0),m.specularMap&&(c.tSpecular.value=m.specularMap,c.enableSpecular.value=!0),m.lightMap&&(c.tAO.value=m.lightMap,c.enableAO.value=!0),c.uDiffuseColor.value.setHex(m.color),c.uSpecularColor.value.setHex(m.specular),c.uAmbientColor.value.setHex(m.ambient),c.uShininess.value=m.shininess,void 0!==m.opacity&&(c.uOpacity.value=m.opacity),m=new THREE.ShaderMaterial({fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,uniforms:c,lights:!0,fog:!0})):m=new THREE[u](m),void 0!==s.DbgName&&(m.name=s.DbgName),o.materials[r]=m}}var s=t.faces,p=t.vertices,m=t.normals,l=t.colors,c=0;if(t.uvs)for(r=0;r<t.uvs.length;r++)t.uvs[r].length&&c++;for(r=0;r<c;r++)o.faceUvs[r]=[],o.faceVertexUvs[r]=[];for(u=0,d=p.length;u<d;){var _=new THREE.Vector3;_.x=p[u++]*n,_.y=p[u++]*n,_.z=p[u++]*n,o.vertices.push(_)}for(u=0,d=s.length;u<d;){var f=s[u++],y=2&f,r=4&f,g=8&f,v=16&f,p=32&f,x=64&f,_=128&f;if(1&f){f=new THREE.Face4,f.a=s[u++],f.b=s[u++],f.c=s[u++],f.d=s[u++];var b=4}else f=new THREE.Face3,f.a=s[u++],f.b=s[u++],f.c=s[u++],b=3;y&&(y=s[u++],f.materialIndex=y);var E=o.faces.length;if(r)for(r=0;r<c;r++){var T=t.uvs[r],y=s[u++],w=T[2*y],y=T[2*y+1];o.faceUvs[r][E]=new THREE.UV(w,y)}if(g)for(r=0;r<c;r++){for(var T=t.uvs[r],g=[],S=0;S<b;S++)y=s[u++],w=T[2*y],y=T[2*y+1],g[S]=new THREE.UV(w,y);o.faceVertexUvs[r][E]=g}if(v&&(v=3*s[u++],y=new THREE.Vector3,y.x=m[v++],y.y=m[v++],y.z=m[v],f.normal=y),p)for(r=0;r<b;r++)v=3*s[u++],y=new THREE.Vector3,y.x=m[v++],y.y=m[v++],y.z=m[v],f.vertexNormals.push(y);if(x&&(p=s[u++],f.color=new THREE.Color(l[p])),_)for(r=0;r<b;r++)p=s[u++],f.vertexColors.push(new THREE.Color(l[p]));o.faces.push(f)}if(t.skinWeights)for(r=0,s=t.skinWeights.length;r<s;r+=2)o.skinWeights.push(new THREE.Vector4(t.skinWeights[r],t.skinWeights[r+1],0,0));if(t.skinIndices)for(r=0,s=t.skinIndices.length;r<s;r+=2)m=0,o.skinIndices.push(new THREE.Vector4(t.skinIndices[r],t.skinIndices[r+1],m,0));if(o.bones=t.bones,o.animation=t.animation,t.morphTargets)for(r=0,s=t.morphTargets.length;r<s;r++)for(o.morphTargets[r]={},o.morphTargets[r].name=t.morphTargets[r].name,o.morphTargets[r].vertices=[],m=o.morphTargets[r].vertices,l=t.morphTargets[r].vertices,y=0,c=l.length;y<c;y+=3)_=new THREE.Vector3,_.x=l[y]*n,_.y=l[y+1]*n,_.z=l[y+2]*n,m.push(_);if(t.morphColors)for(r=0,s=t.morphColors.length;r<s;r++)for(o.morphColors[r]={},o.morphColors[r].name=t.morphColors[r].name,o.morphColors[r].colors=[],n=o.morphColors[r].colors,l=t.morphColors[r].colors,m=0,c=l.length;m<c;m+=3)u=new THREE.Color(16755200),u.setRGB(l[m],l[m+1],l[m+2]),n.push(u);return o.computeCentroids(),o.computeFaceNormals(),o}},THREE.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){},this.geometryHandlerMap={},this.addGeometryHandler("ascii",THREE.JSONLoader),this.addGeometryHandler("binary",THREE.BinaryLoader)},THREE.SceneLoader.prototype.constructor=THREE.SceneLoader,THREE.SceneLoader.prototype.load=function(t,e){var i=this,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){var n=JSON.parse(o.responseText);i.parse(n,e,t)}else console.error("THREE.SceneLoader: Couldn't load ["+t+"] ["+o.status+"]")},o.open("GET",t,!0),o.send(null)},THREE.SceneLoader.prototype.addGeometryHandler=function(t,e){this.geometryHandlerMap[t]={loaderClass:e}},THREE.SceneLoader.prototype.parse=function(t,e,i){function o(t,e){return"relativeToHTML"==e?t:B+"/"+t}function n(t,e){for(var i in e)if(void 0===D.objects[i]){var o=e[i],r=null;if(void 0!==o.geometry?(x=D.geometries[o.geometry])&&(r=!1,b=D.materials[o.materials[0]],(r=b instanceof THREE.ShaderMaterial)&&x.computeTangents(),p=o.position,_=o.rotation,f=o.quaternion,y=o.scale,m=o.matrix,f=0,0===o.materials.length&&(b=new THREE.MeshFaceMaterial),1<o.materials.length&&(b=new THREE.MeshFaceMaterial),o.morph?(r=new THREE.MorphAnimMesh(x,b),void 0!==o.duration&&(r.duration=o.duration),void 0!==o.time&&(r.time=o.time),void 0!==o.mirroredLoop&&(r.mirroredLoop=o.mirroredLoop),b.morphNormals&&x.computeMorphNormals()):r=new THREE.Mesh(x,b),r.name=i,m?(r.matrixAutoUpdate=!1,r.matrix.set(m[0],m[1],m[2],m[3],m[4],m[5],m[6],m[7],m[8],m[9],m[10],m[11],m[12],m[13],m[14],m[15])):(r.position.set(p[0],p[1],p[2]),f?(r.quaternion.set(f[0],f[1],f[2],f[3]),r.useQuaternion=!0):r.rotation.set(_[0],_[1],_[2]),r.scale.set(y[0],y[1],y[2])),r.visible=o.visible,r.castShadow=o.castShadow,r.receiveShadow=o.receiveShadow,t.add(r),D.objects[i]=r):(p=o.position,_=o.rotation,f=o.quaternion,y=o.scale,f=0,r=new THREE.Object3D,r.name=i,r.position.set(p[0],p[1],p[2]),f?(r.quaternion.set(f[0],f[1],f[2],f[3]),r.useQuaternion=!0):r.rotation.set(_[0],_[1],_[2]),r.scale.set(y[0],y[1],y[2]),r.visible=void 0!==o.visible&&o.visible,t.add(r),D.objects[i]=r,D.empties[i]=r),r){if(void 0!==o.properties)for(var s in o.properties)r.properties[s]=o.properties[s];void 0!==o.children&&n(r,o.children)}}}function r(){A.callbackProgress({totalModels:R,totalTextures:M,loadedModels:R-S,loadedTextures:M-C},D),A.onLoadProgress(),0===S&&0===C&&e(D)}var s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b,E,T,w,S,C,R,M,D,A=this,B=THREE.Loader.prototype.extractUrlBase(i),I=t;for(g in this.geometryHandlerMap)this.geometryHandlerMap[g].loaderObject=new this.geometryHandlerMap[g].loaderClass;C=S=0,D={scene:new THREE.Scene,geometries:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{}},I.transform&&(t=I.transform.position,i=I.transform.rotation,g=I.transform.scale,t&&D.scene.position.set(t[0],t[1],t[2]),i&&D.scene.rotation.set(i[0],i[1],i[2]),g&&D.scene.scale.set(g[0],g[1],g[2]),t||i||g)&&(D.scene.updateMatrix(),D.scene.updateMatrixWorld()),t=function(t){return function(){C-=t,r(),A.onLoadComplete()}};for(l in I.cameras)g=I.cameras[l],"perspective"===g.type?E=new THREE.PerspectiveCamera(g.fov,g.aspect,g.near,g.far):"ortho"===g.type&&(E=new THREE.OrthographicCamera(g.left,g.right,g.top,g.bottom,g.near,g.far)),p=g.position,i=g.target,g=g.up,E.position.set(p[0],p[1],p[2]),E.target=new THREE.Vector3(i[0],i[1],i[2]),g&&E.up.set(g[0],g[1],g[2]),D.cameras[l]=E;for(h in I.lights)i=I.lights[h],l=void 0!==i.color?i.color:16777215,E=void 0!==i.intensity?i.intensity:1,"directional"===i.type?(p=i.direction,d=new THREE.DirectionalLight(l,E),d.position.set(p[0],p[1],p[2]),d.position.normalize()):"point"===i.type?(p=i.position,d=i.distance,d=new THREE.PointLight(l,E,d),d.position.set(p[0],p[1],p[2])):"ambient"===i.type&&(d=new THREE.AmbientLight(l)),
D.scene.add(d),D.lights[h]=d;for(c in I.fogs)h=I.fogs[c],"linear"===h.type?T=new THREE.Fog(0,h.near,h.far):"exp2"===h.type&&(T=new THREE.FogExp2(0,h.density)),g=h.color,T.color.setRGB(g[0],g[1],g[2]),D.fogs[c]=T;D.cameras&&I.defaults.camera&&(D.currentCamera=D.cameras[I.defaults.camera]),D.fogs&&I.defaults.fog&&(D.scene.fog=D.fogs[I.defaults.fog]),g=I.defaults.bgcolor,D.bgColor=new THREE.Color,D.bgColor.setRGB(g[0],g[1],g[2]),D.bgColorAlpha=I.defaults.bgalpha;for(s in I.geometries)c=I.geometries[s],c.type in this.geometryHandlerMap&&(S+=1,A.onLoadStart());R=S;for(s in I.geometries)if(c=I.geometries[s],"cube"===c.type)x=new THREE.CubeGeometry(c.width,c.height,c.depth,c.segmentsWidth,c.segmentsHeight,c.segmentsDepth,null,c.flipped,c.sides),D.geometries[s]=x;else if("plane"===c.type)x=new THREE.PlaneGeometry(c.width,c.height,c.segmentsWidth,c.segmentsHeight),D.geometries[s]=x;else if("sphere"===c.type)x=new THREE.SphereGeometry(c.radius,c.segmentsWidth,c.segmentsHeight),D.geometries[s]=x;else if("cylinder"===c.type)x=new THREE.CylinderGeometry(c.topRad,c.botRad,c.height,c.radSegs,c.heightSegs),D.geometries[s]=x;else if("torus"===c.type)x=new THREE.TorusGeometry(c.radius,c.tube,c.segmentsR,c.segmentsT),D.geometries[s]=x;else if("icosahedron"===c.type)x=new THREE.IcosahedronGeometry(c.radius,c.subdivisions),D.geometries[s]=x;else if(c.type in this.geometryHandlerMap){T={};for(w in c)"type"!==w&&"url"!==w&&(T[w]=c[w]);this.geometryHandlerMap[c.type].loaderObject.load(o(c.url,I.urlBaseType),function(t){return function(e){D.geometries[t]=e,n(D.scene,I.objects),S-=1,A.onLoadComplete(),r()}}(s),T)}else"embedded"===c.type&&(c=I.embeds[c.id],c.metadata=I.metadata,c&&this.geometryHandlerMap.ascii.loaderObject.createModel(c,function(t){return function(e){D.geometries[t]=e}}(s),""));for(u in I.textures)if(s=I.textures[u],s.url instanceof Array)for(C+=s.url.length,w=0;w<s.url.length;w++)A.onLoadStart();else C+=1,A.onLoadStart();M=C;for(u in I.textures){if(s=I.textures[u],void 0!==s.mapping&&void 0!==THREE[s.mapping]&&(s.mapping=new THREE[s.mapping]),s.url instanceof Array){for(c=s.url.length,T=[],w=0;w<c;w++)T[w]=o(s.url[w],I.urlBaseType);w=(w=T[0].endsWith(".dds"))?THREE.ImageUtils.loadCompressedTextureCube(T,s.mapping,t(c)):THREE.ImageUtils.loadTextureCube(T,s.mapping,t(c))}else w=s.url.toLowerCase().endsWith(".dds"),c=o(s.url,I.urlBaseType),T=t(1),w=w?THREE.ImageUtils.loadCompressedTexture(c,s.mapping,T):THREE.ImageUtils.loadTexture(c,s.mapping,T),void 0!==THREE[s.minFilter]&&(w.minFilter=THREE[s.minFilter]),void 0!==THREE[s.magFilter]&&(w.magFilter=THREE[s.magFilter]),s.anisotropy&&(w.anisotropy=s.anisotropy),s.repeat&&(w.repeat.set(s.repeat[0],s.repeat[1]),1!==s.repeat[0]&&(w.wrapS=THREE.RepeatWrapping),1!==s.repeat[1])&&(w.wrapT=THREE.RepeatWrapping),s.offset&&w.offset.set(s.offset[0],s.offset[1]),s.wrap&&(c={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==c[s.wrap[0]]&&(w.wrapS=c[s.wrap[0]]),void 0!==c[s.wrap[1]])&&(w.wrapT=c[s.wrap[1]]);D.textures[u]=w}for(a in I.materials){m=I.materials[a];for(v in m.parameters)"envMap"===v||"map"===v||"lightMap"===v||"bumpMap"===v?m.parameters[v]=D.textures[m.parameters[v]]:"shading"===v?m.parameters[v]="flat"===m.parameters[v]?THREE.FlatShading:THREE.SmoothShading:"side"===v?m.parameters[v]="double"==m.parameters[v]?THREE.DoubleSide:"back"==m.parameters[v]?THREE.BackSide:THREE.FrontSide:"blending"===v?m.parameters[v]=m.parameters[v]in THREE?THREE[m.parameters[v]]:THREE.NormalBlending:"combine"===v?m.parameters[v]="MixOperation"==m.parameters[v]?THREE.MixOperation:THREE.MultiplyOperation:"vertexColors"===v?"face"==m.parameters[v]?m.parameters[v]=THREE.FaceColors:m.parameters[v]&&(m.parameters[v]=THREE.VertexColors):"wrapRGB"===v&&(u=m.parameters[v],m.parameters[v]=new THREE.Vector3(u[0],u[1],u[2]));void 0!==m.parameters.opacity&&1>m.parameters.opacity&&(m.parameters.transparent=!0),m.parameters.normalMap?(u=THREE.ShaderUtils.lib.normal,t=THREE.UniformsUtils.clone(u.uniforms),s=m.parameters.color,w=m.parameters.specular,c=m.parameters.ambient,T=m.parameters.shininess,t.tNormal.value=D.textures[m.parameters.normalMap],m.parameters.normalScale&&t.uNormalScale.value.set(m.parameters.normalScale[0],m.parameters.normalScale[1]),m.parameters.map&&(t.tDiffuse.value=m.parameters.map,t.enableDiffuse.value=!0),m.parameters.envMap&&(t.tCube.value=m.parameters.envMap,t.enableReflection.value=!0,t.uReflectivity.value=m.parameters.reflectivity),m.parameters.lightMap&&(t.tAO.value=m.parameters.lightMap,t.enableAO.value=!0),m.parameters.specularMap&&(t.tSpecular.value=D.textures[m.parameters.specularMap],t.enableSpecular.value=!0),m.parameters.displacementMap&&(t.tDisplacement.value=D.textures[m.parameters.displacementMap],t.enableDisplacement.value=!0,t.uDisplacementBias.value=m.parameters.displacementBias,t.uDisplacementScale.value=m.parameters.displacementScale),t.uDiffuseColor.value.setHex(s),t.uSpecularColor.value.setHex(w),t.uAmbientColor.value.setHex(c),t.uShininess.value=T,m.parameters.opacity&&(t.uOpacity.value=m.parameters.opacity),b=new THREE.ShaderMaterial({fragmentShader:u.fragmentShader,vertexShader:u.vertexShader,uniforms:t,lights:!0,fog:!0})):b=new THREE[m.type](m.parameters),D.materials[a]=b}n(D.scene,I.objects),A.callbackSync(D),r()},THREE.TextureLoader=function(){THREE.EventTarget.call(this),this.crossOrigin=null},THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,load:function(t){var e=this,i=new Image;i.addEventListener("load",function(){var t=new THREE.Texture(i);t.needsUpdate=!0,e.dispatchEvent({type:"load",content:t})},!1),i.addEventListener("error",function(){e.dispatchEvent({type:"error",message:"Couldn't load URL ["+t+"]"})},!1),e.crossOrigin&&(i.crossOrigin=e.crossOrigin),i.src=t}},THREE.Material=function(){THREE.MaterialLibrary.push(this),this.id=THREE.MaterialIdCount++,this.name="",this.side=THREE.FrontSide,this.opacity=1,this.transparent=!1,this.blending=THREE.NormalBlending,this.blendSrc=THREE.SrcAlphaFactor,this.blendDst=THREE.OneMinusSrcAlphaFactor,this.blendEquation=THREE.AddEquation,this.depthWrite=this.depthTest=!0,this.polygonOffset=!1,this.alphaTest=this.polygonOffsetUnits=this.polygonOffsetFactor=0,this.overdraw=!1,this.needsUpdate=this.visible=!0},THREE.Material.prototype.setValues=function(t){if(void 0!==t)for(var e in t){var i=t[e];if(void 0===i)console.warn("THREE.Material: '"+e+"' parameter is undefined.");else if(e in this){var o=this[e];o instanceof THREE.Color&&i instanceof THREE.Color?o.copy(i):o instanceof THREE.Color&&"number"==typeof i?o.setHex(i):o instanceof THREE.Vector3&&i instanceof THREE.Vector3?o.copy(i):this[e]=i}}},THREE.Material.prototype.clone=function(t){return void 0===t&&(t=new THREE.Material),t.name=this.name,t.side=this.side,t.opacity=this.opacity,t.transparent=this.transparent,t.blending=this.blending,t.blendSrc=this.blendSrc,t.blendDst=this.blendDst,t.blendEquation=this.blendEquation,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.polygonOffset=this.polygonOffset,t.polygonOffsetFactor=this.polygonOffsetFactor,t.polygonOffsetUnits=this.polygonOffsetUnits,t.alphaTest=this.alphaTest,t.overdraw=this.overdraw,t.visible=this.visible,t},THREE.Material.prototype.deallocate=function(){var t=THREE.MaterialLibrary.indexOf(this);-1!==t&&THREE.MaterialLibrary.splice(t,1)},THREE.MaterialIdCount=0,THREE.MaterialLibrary=[],THREE.LineBasicMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.linewidth=1,this.linejoin=this.linecap="round",this.vertexColors=!1,this.fog=!0,this.setValues(t)},THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.LineBasicMaterial.prototype.clone=function(){var t=new THREE.LineBasicMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.linewidth=this.linewidth,t.linecap=this.linecap,t.linejoin=this.linejoin,t.vertexColors=this.vertexColors,t.fog=this.fog,t},THREE.MeshBasicMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.envMap=this.specularMap=this.lightMap=this.map=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphTargets=this.skinning=!1,this.setValues(t)},THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshBasicMaterial.prototype.clone=function(){var t=new THREE.MeshBasicMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.map=this.map,t.lightMap=this.lightMap,t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t},THREE.MeshLambertMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.wrapAround=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.envMap=this.specularMap=this.lightMap=this.map=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)},THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshLambertMaterial.prototype.clone=function(){var t=new THREE.MeshLambertMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.ambient.copy(this.ambient),t.emissive.copy(this.emissive),t.wrapAround=this.wrapAround,t.wrapRGB.copy(this.wrapRGB),t.map=this.map,t.lightMap=this.lightMap,t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},THREE.MeshPhongMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.specular=new THREE.Color(1118481),this.shininess=30,this.wrapAround=this.perPixel=this.metal=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.bumpMap=this.lightMap=this.map=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new THREE.Vector2(1,1),this.envMap=this.specularMap=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)},THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshPhongMaterial.prototype.clone=function(){var t=new THREE.MeshPhongMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.ambient.copy(this.ambient),t.emissive.copy(this.emissive),t.specular.copy(this.specular),t.shininess=this.shininess,t.metal=this.metal,t.perPixel=this.perPixel,t.wrapAround=this.wrapAround,t.wrapRGB.copy(this.wrapRGB),t.map=this.map,t.lightMap=this.lightMap,t.bumpMap=this.bumpMap,t.bumpScale=this.bumpScale,t.normalMap=this.normalMap,t.normalScale.copy(this.normalScale),t.specularMap=this.specularMap,t.envMap=this.envMap,t.combine=this.combine,t.reflectivity=this.reflectivity,t.refractionRatio=this.refractionRatio,t.fog=this.fog,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.wireframeLinecap=this.wireframeLinecap,t.wireframeLinejoin=this.wireframeLinejoin,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},THREE.MeshDepthMaterial=function(t){THREE.Material.call(this),this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)},THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshDepthMaterial.prototype.clone=function(){var t=new THREE.LineBasicMaterial;return THREE.Material.prototype.clone.call(this,t),t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t},THREE.MeshNormalMaterial=function(t){THREE.Material.call(this,t),this.shading=THREE.FlatShading,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)},THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshNormalMaterial.prototype.clone=function(){var t=new THREE.MeshNormalMaterial;return THREE.Material.prototype.clone.call(this,t),t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t},THREE.MeshFaceMaterial=function(){},THREE.MeshFaceMaterial.prototype.clone=function(){return new THREE.MeshFaceMaterial},THREE.ParticleBasicMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.vertexColors=!1,this.fog=!0,this.setValues(t)};THREE.ParticleBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ParticleBasicMaterial.prototype.clone=function(){var t=new THREE.ParticleBasicMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.map=this.map,t.size=this.size,t.sizeAttenuation=this.sizeAttenuation,t.vertexColors=this.vertexColors,t.fog=this.fog,t},THREE.ParticleCanvasMaterial=function(t){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(t)},THREE.ParticleCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ParticleCanvasMaterial.prototype.clone=function(){var t=new THREE.ParticleCanvasMaterial;return THREE.Material.prototype.clone.call(this,t),t.color.copy(this.color),t.program=this.program,t},THREE.ParticleDOMMaterial=function(t){this.element=t},THREE.ParticleDOMMaterial.prototype.clone=function(){return new THREE.ParticleDOMMaterial(this.element)},THREE.ShaderMaterial=function(t){THREE.Material.call(this),this.vertexShader=this.fragmentShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.lights=this.fog=!1,this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)},THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ShaderMaterial.prototype.clone=function(){var t=new THREE.ShaderMaterial;return THREE.Material.prototype.clone.call(this,t),t.fragmentShader=this.fragmentShader,t.vertexShader=this.vertexShader,t.uniforms=this.uniforms,t.attributes=this.attributes,t.defines=this.defines,t.shading=this.shading,t.wireframe=this.wireframe,t.wireframeLinewidth=this.wireframeLinewidth,t.fog=this.fog,t.lights=this.lights,t.vertexColors=this.vertexColors,t.skinning=this.skinning,t.morphTargets=this.morphTargets,t.morphNormals=this.morphNormals,t},THREE.Texture=function(t,e,i,o,n,r,s,a,h){THREE.TextureLibrary.push(this),this.id=THREE.TextureIdCount++,this.image=t,this.mapping=void 0!==e?e:new THREE.UVMapping,this.wrapS=void 0!==i?i:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==o?o:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==n?n:THREE.LinearFilter,this.minFilter=void 0!==r?r:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==h?h:1,this.format=void 0!==s?s:THREE.RGBAFormat,this.type=void 0!==a?a:THREE.UnsignedByteType,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.needsUpdate=!1,this.onUpdate=null},THREE.Texture.prototype={constructor:THREE.Texture,clone:function(){var t=new THREE.Texture;return t.image=this.image,t.mapping=this.mapping,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t},deallocate:function(){var t=THREE.TextureLibrary.indexOf(this);-1!==t&&THREE.TextureLibrary.splice(t,1)}},THREE.TextureIdCount=0,THREE.TextureLibrary=[],THREE.CompressedTexture=function(t,e,i,o,n,r,s,a,h,l){THREE.Texture.call(this,null,r,s,a,h,l,o,n),this.image={width:e,height:i},this.mipmaps=t},THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype),THREE.CompressedTexture.prototype.clone=function(){var t=new THREE.CompressedTexture;return t.image=this.image,t.mipmaps=this.mipmaps,t.format=this.format,t.type=this.type,t.mapping=this.mapping,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t},THREE.DataTexture=function(t,e,i,o,n,r,s,a,h,l){THREE.Texture.call(this,null,r,s,a,h,l,o,n),this.image={data:t,width:e,height:i}},THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype),THREE.DataTexture.prototype.clone=function(){var t=new THREE.DataTexture(this.image.data,this.image.width,this.image.height,this.format,this.type,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);return t.offset.copy(this.offset),t.repeat.copy(this.repeat),t},THREE.Particle=function(t){THREE.Object3D.call(this),this.material=t},THREE.Particle.prototype=Object.create(THREE.Object3D.prototype),THREE.Particle.prototype.clone=function(t){return void 0===t&&(t=new THREE.Particle(this.material)),THREE.Object3D.prototype.clone.call(this,t),t},THREE.ParticleSystem=function(t,e){THREE.Object3D.call(this),this.geometry=t,this.material=void 0!==e?e:new THREE.ParticleBasicMaterial({color:16777215*Math.random()}),this.sortParticles=!1,this.geometry&&(null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.boundRadius=t.boundingSphere.radius),this.frustumCulled=!1},THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype),THREE.ParticleSystem.prototype.clone=function(t){return void 0===t&&(t=new THREE.ParticleSystem(this.geometry,this.material)),t.sortParticles=this.sortParticles,THREE.Object3D.prototype.clone.call(this,t),t},THREE.Line=function(t,e,i){THREE.Object3D.call(this),this.geometry=t,this.material=void 0!==e?e:new THREE.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==i?i:THREE.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())},THREE.LineStrip=0,THREE.LinePieces=1,THREE.Line.prototype=Object.create(THREE.Object3D.prototype),THREE.Line.prototype.clone=function(t){return void 0===t&&(t=new THREE.Line(this.geometry,this.material,this.type)),THREE.Object3D.prototype.clone.call(this,t),t},THREE.Mesh=function(t,e){if(THREE.Object3D.call(this),this.geometry=t,this.material=void 0!==e?e:new THREE.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0}),this.geometry&&(null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere(),this.boundRadius=t.boundingSphere.radius,this.geometry.morphTargets.length)){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var i=0;i<this.geometry.morphTargets.length;i++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[i].name]=i}},THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype),THREE.Mesh.prototype.getMorphTargetIndexByName=function(t){return void 0!==this.morphTargetDictionary[t]?this.morphTargetDictionary[t]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+t+" does not exist. Returning 0."),0)},THREE.Mesh.prototype.clone=function(t){return void 0===t&&(t=new THREE.Mesh(this.geometry,this.material)),THREE.Object3D.prototype.clone.call(this,t),t},THREE.Bone=function(t){THREE.Object3D.call(this),this.skin=t,this.skinMatrix=new THREE.Matrix4},THREE.Bone.prototype=Object.create(THREE.Object3D.prototype),THREE.Bone.prototype.update=function(t,e){this.matrixAutoUpdate&&(e|=this.updateMatrix()),(e||this.matrixWorldNeedsUpdate)&&(t?this.skinMatrix.multiply(t,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);var i,o=this.children.length;for(i=0;i<o;i++)this.children[i].update(this.skinMatrix,e)},THREE.SkinnedMesh=function(t,e,i){THREE.Mesh.call(this,t,e),this.useVertexTexture=void 0===i||i,this.identityMatrix=new THREE.Matrix4,this.bones=[],this.boneMatrices=[];var o,n,r;if(void 0!==this.geometry.bones){for(t=0;t<this.geometry.bones.length;t++)i=this.geometry.bones[t],o=i.pos,n=i.rotq,r=i.scl,e=this.addBone(),e.name=i.name,e.position.set(o[0],o[1],o[2]),e.quaternion.set(n[0],n[1],n[2],n[3]),e.useQuaternion=!0,void 0!==r?e.scale.set(r[0],r[1],r[2]):e.scale.set(1,1,1);for(t=0;t<this.bones.length;t++)i=this.geometry.bones[t],e=this.bones[t],-1===i.parent?this.add(e):this.bones[i.parent].add(e);t=this.bones.length,this.useVertexTexture?(this.boneTextureHeight=this.boneTextureWidth=t=256<t?64:64<t?32:16<t?16:8,this.boneMatrices=new Float32Array(4*this.boneTextureWidth*this.boneTextureHeight),this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType),this.boneTexture.minFilter=THREE.NearestFilter,this.boneTexture.magFilter=THREE.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1):this.boneMatrices=new Float32Array(16*t),this.pose()}},THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.SkinnedMesh.prototype.addBone=function(t){return void 0===t&&(t=new THREE.Bone(this)),this.bones.push(t),t},THREE.SkinnedMesh.prototype.updateMatrixWorld=function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.parent?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1);for(var t=0,e=this.children.length;t<e;t++){var i=this.children[t];i instanceof THREE.Bone?i.update(this.identityMatrix,!1):i.updateMatrixWorld(!0)}if(void 0==this.boneInverses)for(this.boneInverses=[],t=0,e=this.bones.length;t<e;t++)i=new THREE.Matrix4,i.getInverse(this.bones[t].skinMatrix),this.boneInverses.push(i);for(t=0,e=this.bones.length;t<e;t++)THREE.SkinnedMesh.offsetMatrix.multiply(this.bones[t].skinMatrix,this.boneInverses[t]),THREE.SkinnedMesh.offsetMatrix.flattenToArrayOffset(this.boneMatrices,16*t);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)},THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);for(var t=0;t<this.geometry.skinIndices.length;t++){var e=this.geometry.skinWeights[t],i=1/e.lengthManhattan();1/0!==i?e.multiplyScalar(i):e.set(1)}},THREE.SkinnedMesh.prototype.clone=function(t){return void 0===t&&(t=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture)),THREE.Mesh.prototype.clone.call(this,t),t},THREE.SkinnedMesh.offsetMatrix=new THREE.Matrix4,THREE.MorphAnimMesh=function(t,e){THREE.Mesh.call(this,t,e),this.duration=1e3,this.mirroredLoop=!1,this.currentKeyframe=this.lastKeyframe=this.time=0,this.direction=1,this.directionBackwards=!1,this.setFrameRange(0,this.geometry.morphTargets.length-1)},THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphAnimMesh.prototype.setFrameRange=function(t,e){this.startKeyframe=t,this.endKeyframe=e,this.length=this.endKeyframe-this.startKeyframe+1},THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},THREE.MorphAnimMesh.prototype.parseAnimations=function(){var t=this.geometry;t.animations||(t.animations={});for(var e,i=t.animations,o=0,n=t.morphTargets.length;o<n;o++){var r=t.morphTargets[o].name.match(/([a-z]+)(\d+)/);if(r&&1<r.length){r=r[1],i[r]||(i[r]={start:1/0,end:-1/0});var s=i[r];o<s.start&&(s.start=o),o>s.end&&(s.end=o),e||(e=r)}}t.firstAnimation=e},THREE.MorphAnimMesh.prototype.setAnimationLabel=function(t,e,i){this.geometry.animations||(this.geometry.animations={}),this.geometry.animations[t]={start:e,end:i}},THREE.MorphAnimMesh.prototype.playAnimation=function(t,e){var i=this.geometry.animations[t];i?(this.setFrameRange(i.start,i.end),this.duration=(i.end-i.start)/e*1e3,this.time=0):console.warn("animation["+t+"] undefined")},THREE.MorphAnimMesh.prototype.updateAnimation=function(t){var e=this.duration/this.length;this.time+=this.direction*t,this.mirroredLoop?(this.time>this.duration||0>this.time)&&(this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),0>this.time&&(this.time=0,this.directionBackwards=!1)):(this.time%=this.duration,0>this.time&&(this.time+=this.duration)),t=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/e),0,this.length-1),t!==this.currentKeyframe&&(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[t]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=t),e=this.time%e/e,this.directionBackwards&&(e=1-e),this.morphTargetInfluences[this.currentKeyframe]=e,this.morphTargetInfluences[this.lastKeyframe]=1-e},THREE.MorphAnimMesh.prototype.clone=function(t){return void 0===t&&(t=new THREE.MorphAnimMesh(this.geometry,this.material)),t.duration=this.duration,t.mirroredLoop=this.mirroredLoop,t.time=this.time,t.lastKeyframe=this.lastKeyframe,t.currentKeyframe=this.currentKeyframe,t.direction=this.direction,t.directionBackwards=this.directionBackwards,THREE.Mesh.prototype.clone.call(this,t),t},THREE.Ribbon=function(t,e){THREE.Object3D.call(this),this.geometry=t,this.material=e},THREE.Ribbon.prototype=Object.create(THREE.Object3D.prototype),THREE.Ribbon.prototype.clone=function(t){return void 0===t&&(t=new THREE.Ribbon(this.geometry,this.material)),THREE.Object3D.prototype.clone.call(this,t),t},THREE.LOD=function(){THREE.Object3D.call(this),this.LODs=[]},THREE.LOD.prototype=Object.create(THREE.Object3D.prototype),THREE.LOD.prototype.addLevel=function(t,e){void 0===e&&(e=0);for(var e=Math.abs(e),i=0;i<this.LODs.length&&!(e<this.LODs[i].visibleAtDistance);i++);this.LODs.splice(i,0,{visibleAtDistance:e,object3D:t}),this.add(t)},THREE.LOD.prototype.update=function(t){if(1<this.LODs.length){t.matrixWorldInverse.getInverse(t.matrixWorld),t=t.matrixWorldInverse,t=-(t.elements[2]*this.matrixWorld.elements[12]+t.elements[6]*this.matrixWorld.elements[13]+t.elements[10]*this.matrixWorld.elements[14]+t.elements[14]),this.LODs[0].object3D.visible=!0;for(var e=1;e<this.LODs.length&&t>=this.LODs[e].visibleAtDistance;e++)this.LODs[e-1].object3D.visible=!1,this.LODs[e].object3D.visible=!0;for(;e<this.LODs.length;e++)this.LODs[e].object3D.visible=!1}},THREE.LOD.prototype.clone=function(){},THREE.Sprite=function(t){THREE.Object3D.call(this),this.color=void 0!==t.color?new THREE.Color(t.color):new THREE.Color(16777215),this.map=void 0!==t.map?t.map:new THREE.Texture,this.blending=void 0!==t.blending?t.blending:THREE.NormalBlending,this.blendSrc=void 0!==t.blendSrc?t.blendSrc:THREE.SrcAlphaFactor,this.blendDst=void 0!==t.blendDst?t.blendDst:THREE.OneMinusSrcAlphaFactor,this.blendEquation=void 0!==t.blendEquation?t.blendEquation:THREE.AddEquation,this.useScreenCoordinates=void 0===t.useScreenCoordinates||t.useScreenCoordinates,this.mergeWith3D=void 0!==t.mergeWith3D?t.mergeWith3D:!this.useScreenCoordinates,this.affectedByDistance=void 0!==t.affectedByDistance?t.affectedByDistance:!this.useScreenCoordinates,this.scaleByViewport=void 0!==t.scaleByViewport?t.scaleByViewport:!this.affectedByDistance,this.alignment=t.alignment instanceof THREE.Vector2?t.alignment:THREE.SpriteAlignment.center,this.rotation3d=this.rotation,this.rotation=0,this.opacity=1,this.uvOffset=new THREE.Vector2(0,0),this.uvScale=new THREE.Vector2(1,1)},THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype),THREE.Sprite.prototype.updateMatrix=function(){this.matrix.setPosition(this.position),this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d),1===this.scale.x&&1===this.scale.y||(this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,this.scale.y)),this.matrixWorldNeedsUpdate=!0},THREE.Sprite.prototype.clone=function(t){return void 0===t&&(t=new THREE.Sprite({})),t.color.copy(this.color),t.map=this.map,t.blending=this.blending,t.useScreenCoordinates=this.useScreenCoordinates,t.mergeWith3D=this.mergeWith3D,t.affectedByDistance=this.affectedByDistance,t.scaleByViewport=this.scaleByViewport,t.alignment=this.alignment,t.rotation3d.copy(this.rotation3d),t.rotation=this.rotation,t.opacity=this.opacity,t.uvOffset.copy(this.uvOffset),t.uvScale.copy(this.uvScale),THREE.Object3D.prototype.clone.call(this,t),t},THREE.SpriteAlignment={},THREE.SpriteAlignment.topLeft=new THREE.Vector2(1,-1),THREE.SpriteAlignment.topCenter=new THREE.Vector2(0,-1),THREE.SpriteAlignment.topRight=new THREE.Vector2(-1,-1),THREE.SpriteAlignment.centerLeft=new THREE.Vector2(1,0),THREE.SpriteAlignment.center=new THREE.Vector2(0,0),THREE.SpriteAlignment.centerRight=new THREE.Vector2(-1,0),THREE.SpriteAlignment.bottomLeft=new THREE.Vector2(1,1),THREE.SpriteAlignment.bottomCenter=new THREE.Vector2(0,1),THREE.SpriteAlignment.bottomRight=new THREE.Vector2(-1,1),THREE.Scene=function(){THREE.Object3D.call(this),this.overrideMaterial=this.fog=null,this.matrixAutoUpdate=!1,this.__objects=[],this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},THREE.Scene.prototype=Object.create(THREE.Object3D.prototype),THREE.Scene.prototype.__addObject=function(t){if(t instanceof THREE.Light)-1===this.__lights.indexOf(t)&&this.__lights.push(t),t.target&&void 0===t.target.parent&&this.add(t.target);else if(!(t instanceof THREE.Camera||t instanceof THREE.Bone)&&-1===this.__objects.indexOf(t)){this.__objects.push(t),this.__objectsAdded.push(t);var e=this.__objectsRemoved.indexOf(t);-1!==e&&this.__objectsRemoved.splice(e,1)}for(e=0;e<t.children.length;e++)this.__addObject(t.children[e])},THREE.Scene.prototype.__removeObject=function(t){if(t instanceof THREE.Light){var e=this.__lights.indexOf(t);-1!==e&&this.__lights.splice(e,1)}else t instanceof THREE.Camera||-1!==(e=this.__objects.indexOf(t))&&(this.__objects.splice(e,1),this.__objectsRemoved.push(t),-1!==(e=this.__objectsAdded.indexOf(t))&&this.__objectsAdded.splice(e,1));for(e=0;e<t.children.length;e++)this.__removeObject(t.children[e])},THREE.Fog=function(t,e,i){this.color=new THREE.Color(t),this.near=void 0!==e?e:1,this.far=void 0!==i?i:1e3},THREE.FogExp2=function(t,e){this.color=new THREE.Color(t),this.density=void 0!==e?e:25e-5},THREE.CanvasRenderer=function(t){function e(t){K!==t&&(K=J.globalAlpha=t)}function i(t){Z!==t&&(t===THREE.NormalBlending?J.globalCompositeOperation="source-over":t===THREE.AdditiveBlending?J.globalCompositeOperation="lighter":t===THREE.SubtractiveBlending&&(J.globalCompositeOperation="darker"),Z=t)}function o(t){$!==t&&($=J.strokeStyle=t)}function n(t){Q!==t&&(Q=J.fillStyle=t)}console.log("THREE.CanvasRenderer",THREE.REVISION)
;var r,s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b,E,T,w,S,C,R,M,D,A,B,I,H,P,L,V,k,F,z,N,U,O,G,t=t||{},W=this,j=new THREE.Projector,q=void 0!==t.canvas?t.canvas:document.createElement("canvas"),J=q.getContext("2d"),X=new THREE.Color(0),Y=0,K=1,Z=0,$=null,Q=null,tt=null,et=null,it=null,ot=new THREE.RenderableVertex,nt=new THREE.RenderableVertex,rt=new THREE.Color,st=new THREE.Color,at=new THREE.Color,ht=new THREE.Color,lt=new THREE.Color,ct=new THREE.Color,ut=new THREE.Color,mt={},dt={},pt=new THREE.Rectangle,_t=new THREE.Rectangle,ft=new THREE.Rectangle,yt=!1,gt=new THREE.Color,vt=new THREE.Color,xt=new THREE.Color,bt=new THREE.Vector3,t=16;F=document.createElement("canvas"),F.width=F.height=2,z=F.getContext("2d"),z.fillStyle="rgba(0,0,0,1)",z.fillRect(0,0,2,2),N=z.getImageData(0,0,2,2),U=N.data,O=document.createElement("canvas"),O.width=O.height=t,G=O.getContext("2d"),G.translate(-t/2,-t/2),G.scale(t,t),t--,this.domElement=q,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.setSize=function(t,e){h=t,l=e,c=Math.floor(h/2),u=Math.floor(l/2),q.width=h,q.height=l,pt.set(-c,-u,c,u),_t.set(-c,-u,c,u),K=1,Z=0,it=et=tt=Q=$=null},this.setClearColor=function(t,e){X.copy(t),Y=void 0!==e?e:1,_t.set(-c,-u,c,u)},this.setClearColorHex=function(t,e){X.setHex(t),Y=void 0!==e?e:1,_t.set(-c,-u,c,u)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){J.setTransform(1,0,0,-1,c,u),!1===_t.isEmpty()&&(_t.minSelf(pt),_t.inflate(2),1>Y&&J.clearRect(Math.floor(_t.getX()),Math.floor(_t.getY()),Math.floor(_t.getWidth()),Math.floor(_t.getHeight())),0<Y&&(i(THREE.NormalBlending),e(1),n("rgba("+Math.floor(255*X.r)+","+Math.floor(255*X.g)+","+Math.floor(255*X.b)+","+Y+")"),J.fillRect(Math.floor(_t.getX()),Math.floor(_t.getY()),Math.floor(_t.getWidth()),Math.floor(_t.getHeight()))),_t.empty())},this.render=function(t,h){function l(t,e,i){for(var o=0,n=a.length;o<n;o++){var r=a[o],s=r.color;if(r instanceof THREE.DirectionalLight){var h=r.matrixWorld.getPosition().normalize(),l=e.dot(h);0>=l||(l*=r.intensity,i.r+=s.r*l,i.g+=s.g*l,i.b+=s.b*l)}else r instanceof THREE.PointLight&&(h=r.matrixWorld.getPosition(),0>=(l=e.dot(bt.sub(h,t).normalize()))||0!=(l*=0==r.distance?1:1-Math.min(t.distanceTo(h)/r.distance,1))&&(l*=r.intensity,i.r+=s.r*l,i.g+=s.g*l,i.b+=s.b*l))}}function q(t,o,n,r,s,a,c,u){W.info.render.vertices+=3,W.info.render.faces++,e(u.opacity),i(u.blending),f=t.positionScreen.x,y=t.positionScreen.y,g=o.positionScreen.x,v=o.positionScreen.y,x=n.positionScreen.x,b=n.positionScreen.y,X(f,y,g,v,x,b),(u instanceof THREE.MeshLambertMaterial||u instanceof THREE.MeshPhongMaterial)&&null===u.map&&null===u.map?(ct.copy(u.color),ut.copy(u.emissive),u.vertexColors===THREE.FaceColors&&(ct.r*=c.color.r,ct.g*=c.color.g,ct.b*=c.color.b),!0===yt?!1===u.wireframe&&u.shading==THREE.SmoothShading&&3==c.vertexNormalsLength?(st.r=at.r=ht.r=gt.r,st.g=at.g=ht.g=gt.g,st.b=at.b=ht.b=gt.b,l(c.v1.positionWorld,c.vertexNormalsWorld[0],st),l(c.v2.positionWorld,c.vertexNormalsWorld[1],at),l(c.v3.positionWorld,c.vertexNormalsWorld[2],ht),st.r=st.r*ct.r+ut.r,st.g=st.g*ct.g+ut.g,st.b=st.b*ct.b+ut.b,at.r=at.r*ct.r+ut.r,at.g=at.g*ct.g+ut.g,at.b=at.b*ct.b+ut.b,ht.r=ht.r*ct.r+ut.r,ht.g=ht.g*ct.g+ut.g,ht.b=ht.b*ct.b+ut.b,lt.r=.5*(at.r+ht.r),lt.g=.5*(at.g+ht.g),lt.b=.5*(at.b+ht.b),A=Et(st,at,ht,lt),Q(f,y,g,v,x,b,0,0,1,0,0,1,A)):(rt.r=gt.r,rt.g=gt.g,rt.b=gt.b,l(c.centroidWorld,c.normalWorld,rt),rt.r=rt.r*ct.r+ut.r,rt.g=rt.g*ct.g+ut.g,rt.b=rt.b*ct.b+ut.b,!0===u.wireframe?K(rt,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):Z(rt)):!0===u.wireframe?K(u.color,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):Z(u.color)):u instanceof THREE.MeshBasicMaterial||u instanceof THREE.MeshLambertMaterial||u instanceof THREE.MeshPhongMaterial?null!==u.map?u.map.mapping instanceof THREE.UVMapping&&(B=c.uvs[0],$(f,y,g,v,x,b,B[r].u,B[r].v,B[s].u,B[s].v,B[a].u,B[a].v,u.map)):null!==u.envMap?u.envMap.mapping instanceof THREE.SphericalReflectionMapping&&(t=h.matrixWorldInverse,bt.copy(c.vertexNormalsWorld[r]),I=.5*(bt.x*t.elements[0]+bt.y*t.elements[4]+bt.z*t.elements[8])+.5,H=.5*(bt.x*t.elements[1]+bt.y*t.elements[5]+bt.z*t.elements[9])+.5,bt.copy(c.vertexNormalsWorld[s]),P=.5*(bt.x*t.elements[0]+bt.y*t.elements[4]+bt.z*t.elements[8])+.5,L=.5*(bt.x*t.elements[1]+bt.y*t.elements[5]+bt.z*t.elements[9])+.5,bt.copy(c.vertexNormalsWorld[a]),V=.5*(bt.x*t.elements[0]+bt.y*t.elements[4]+bt.z*t.elements[8])+.5,k=.5*(bt.x*t.elements[1]+bt.y*t.elements[5]+bt.z*t.elements[9])+.5,$(f,y,g,v,x,b,I,H,P,L,V,k,u.envMap)):(rt.copy(u.color),u.vertexColors===THREE.FaceColors&&(rt.r*=c.color.r,rt.g*=c.color.g,rt.b*=c.color.b),!0===u.wireframe?K(rt,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):Z(rt)):u instanceof THREE.MeshDepthMaterial?(M=h.near,D=h.far,st.r=st.g=st.b=1-Tt(t.positionScreen.z,M,D),at.r=at.g=at.b=1-Tt(o.positionScreen.z,M,D),ht.r=ht.g=ht.b=1-Tt(n.positionScreen.z,M,D),lt.r=.5*(at.r+ht.r),lt.g=.5*(at.g+ht.g),lt.b=.5*(at.b+ht.b),A=Et(st,at,ht,lt),Q(f,y,g,v,x,b,0,0,1,0,0,1,A)):u instanceof THREE.MeshNormalMaterial&&(rt.r=wt(c.normalWorld.x),rt.g=wt(c.normalWorld.y),rt.b=wt(c.normalWorld.z),!0===u.wireframe?K(rt,u.wireframeLinewidth,u.wireframeLinecap,u.wireframeLinejoin):Z(rt))}function X(t,e,i,o,n,r){J.beginPath(),J.moveTo(t,e),J.lineTo(i,o),J.lineTo(n,r),J.closePath()}function Y(t,e,i,o,n,r,s,a){J.beginPath(),J.moveTo(t,e),J.lineTo(i,o),J.lineTo(n,r),J.lineTo(s,a),J.closePath()}function K(t,e,i,n){tt!==e&&(tt=J.lineWidth=e),et!==i&&(et=J.lineCap=i),it!==n&&(it=J.lineJoin=n),o(t.getContextStyle()),J.stroke(),ft.inflate(2*e)}function Z(t){n(t.getContextStyle()),J.fill()}function $(t,e,i,o,r,s,a,h,l,c,u,m,d){if(!(d instanceof THREE.DataTexture||void 0===d.image||0==d.image.width)){if(!0===d.needsUpdate){var p=d.wrapS==THREE.RepeatWrapping,_=d.wrapT==THREE.RepeatWrapping;mt[d.id]=J.createPattern(d.image,!0===p&&!0===_?"repeat":!0===p&&!1===_?"repeat-x":!1===p&&!0===_?"repeat-y":"no-repeat"),d.needsUpdate=!1}n(void 0===mt[d.id]?"rgba(0,0,0,1)":mt[d.id]);var p=d.offset.x/d.repeat.x,_=d.offset.y/d.repeat.y,f=d.image.width*d.repeat.x,y=d.image.height*d.repeat.y,a=(a+p)*f,h=(1-h+_)*y,i=i-t,o=o-e,r=r-t,s=s-e,l=(l+p)*f-a,c=(1-c+_)*y-h,u=(u+p)*f-a,m=(1-m+_)*y-h,p=l*m-u*c;0===p?(void 0===dt[d.id]&&(e=document.createElement("canvas"),e.width=d.image.width,e.height=d.image.height,e=e.getContext("2d"),e.drawImage(d.image,0,0),dt[d.id]=e.getImageData(0,0,d.image.width,d.image.height).data),e=dt[d.id],a=4*(Math.floor(a)+Math.floor(h)*d.image.width),rt.setRGB(e[a]/255,e[a+1]/255,e[a+2]/255),Z(rt)):(p=1/p,d=(m*i-c*r)*p,c=(m*o-c*s)*p,i=(l*r-u*i)*p,o=(l*s-u*o)*p,t=t-d*a-i*h,a=e-c*a-o*h,J.save(),J.transform(d,c,i,o,t,a),J.fill(),J.restore())}}function Q(t,e,i,o,n,r,s,a,h,l,c,u,m){var d,p;d=m.width-1,p=m.height-1,s*=d,a*=p,i-=t,o-=e,n-=t,r-=e,h=h*d-s,l=l*p-a,c=c*d-s,u=u*p-a,p=1/(h*u-c*l),d=(u*i-l*n)*p,l=(u*o-l*r)*p,i=(h*n-c*i)*p,o=(h*r-c*o)*p,t=t-d*s-i*a,e=e-l*s-o*a,J.save(),J.transform(d,l,i,o,t,e),J.clip(),J.drawImage(m,0,0),J.restore()}function Et(t,e,i,o){return U[0]=255*t.r|0,U[1]=255*t.g|0,U[2]=255*t.b|0,U[4]=255*e.r|0,U[5]=255*e.g|0,U[6]=255*e.b|0,U[8]=255*i.r|0,U[9]=255*i.g|0,U[10]=255*i.b|0,U[12]=255*o.r|0,U[13]=255*o.g|0,U[14]=255*o.b|0,z.putImageData(N,0,0),G.drawImage(F,0,0),O}function Tt(t,e,i){return(t=(t-e)/(i-e))*t*(3-2*t)}function wt(t){return t=.5*(t+1),0>t?0:1<t?1:t}function St(t,e){var i=e.x-t.x,o=e.y-t.y,n=i*i+o*o;0!==n&&(n=1/Math.sqrt(n),i*=n,o*=n,e.x+=i,e.y+=o,t.x-=i,t.y-=o)}if(!1==h instanceof THREE.Camera)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{var Ct,Rt,Mt,Dt;if(!0===this.autoClear?this.clear():J.setTransform(1,0,0,-1,c,u),W.info.render.vertices=0,W.info.render.faces=0,r=j.projectScene(t,h,this.sortObjects,this.sortElements),s=r.elements,a=r.lights,!0===(yt=0<a.length))for(gt.setRGB(0,0,0),vt.setRGB(0,0,0),xt.setRGB(0,0,0),Ct=0,Rt=a.length;Ct<Rt;Ct++){Dt=a[Ct];var At=Dt.color;Dt instanceof THREE.AmbientLight?(gt.r+=At.r,gt.g+=At.g,gt.b+=At.b):Dt instanceof THREE.DirectionalLight?(vt.r+=At.r,vt.g+=At.g,vt.b+=At.b):Dt instanceof THREE.PointLight&&(xt.r+=At.r,xt.g+=At.g,xt.b+=At.b)}for(Ct=0,Rt=s.length;Ct<Rt;Ct++)if(Mt=s[Ct],!(void 0===(Dt=Mt.material)||!1===Dt.visible)){if(ft.empty(),Mt instanceof THREE.RenderableParticle){m=Mt,m.x*=c,m.y*=u;var At=m,Bt=Mt;e(Dt.opacity),i(Dt.blending);var It=void 0,Ht=void 0,Pt=void 0,Lt=void 0,Vt=Mt=void 0,kt=void 0;Dt instanceof THREE.ParticleBasicMaterial?null===Dt.map?(Pt=Bt.object.scale.x,Lt=Bt.object.scale.y,Pt*=Bt.scale.x*c,Lt*=Bt.scale.y*u,ft.set(At.x-Pt,At.y-Lt,At.x+Pt,At.y+Lt),!1!==pt.intersects(ft)&&(n(Dt.color.getContextStyle()),J.save(),J.translate(At.x,At.y),J.rotate(-Bt.rotation),J.scale(Pt,Lt),J.fillRect(-1,-1,2,2),J.restore())):(Mt=Dt.map.image,Vt=Mt.width>>1,kt=Mt.height>>1,Pt=Bt.scale.x*c,Lt=Bt.scale.y*u,It=Pt*Vt,Ht=Lt*kt,ft.set(At.x-It,At.y-Ht,At.x+It,At.y+Ht),!1!==pt.intersects(ft)&&(J.save(),J.translate(At.x,At.y),J.rotate(-Bt.rotation),J.scale(Pt,-Lt),J.translate(-Vt,-kt),J.drawImage(Mt,0,0),J.restore())):Dt instanceof THREE.ParticleCanvasMaterial&&(It=Bt.scale.x*c,Ht=Bt.scale.y*u,ft.set(At.x-It,At.y-Ht,At.x+It,At.y+Ht),!1!==pt.intersects(ft)&&(o(Dt.color.getContextStyle()),n(Dt.color.getContextStyle()),J.save(),J.translate(At.x,At.y),J.rotate(-Bt.rotation),J.scale(It,Ht),Dt.program(J),J.restore()))}else Mt instanceof THREE.RenderableLine?(m=Mt.v1,d=Mt.v2,m.positionScreen.x*=c,m.positionScreen.y*=u,d.positionScreen.x*=c,d.positionScreen.y*=u,ft.addPoint(m.positionScreen.x,m.positionScreen.y),ft.addPoint(d.positionScreen.x,d.positionScreen.y),!0===pt.intersects(ft)&&(At=m,Bt=d,e(Dt.opacity),i(Dt.blending),J.beginPath(),J.moveTo(At.positionScreen.x,At.positionScreen.y),J.lineTo(Bt.positionScreen.x,Bt.positionScreen.y),Dt instanceof THREE.LineBasicMaterial)&&(At=Dt.linewidth,tt!==At&&(tt=J.lineWidth=At),At=Dt.linecap,et!==At&&(et=J.lineCap=At),At=Dt.linejoin,it!==At&&(it=J.lineJoin=At),o(Dt.color.getContextStyle()),J.stroke(),ft.inflate(2*Dt.linewidth))):Mt instanceof THREE.RenderableFace3?(m=Mt.v1,d=Mt.v2,p=Mt.v3,m.positionScreen.x*=c,m.positionScreen.y*=u,d.positionScreen.x*=c,d.positionScreen.y*=u,p.positionScreen.x*=c,p.positionScreen.y*=u,!0===Dt.overdraw&&(St(m.positionScreen,d.positionScreen),St(d.positionScreen,p.positionScreen),St(p.positionScreen,m.positionScreen)),ft.add3Points(m.positionScreen.x,m.positionScreen.y,d.positionScreen.x,d.positionScreen.y,p.positionScreen.x,p.positionScreen.y),!0===pt.intersects(ft)&&q(m,d,p,0,1,2,Mt,Dt)):Mt instanceof THREE.RenderableFace4&&(m=Mt.v1,d=Mt.v2,p=Mt.v3,_=Mt.v4,m.positionScreen.x*=c,m.positionScreen.y*=u,d.positionScreen.x*=c,d.positionScreen.y*=u,p.positionScreen.x*=c,p.positionScreen.y*=u,_.positionScreen.x*=c,_.positionScreen.y*=u,ot.positionScreen.copy(d.positionScreen),nt.positionScreen.copy(_.positionScreen),!0===Dt.overdraw&&(St(m.positionScreen,d.positionScreen),St(d.positionScreen,_.positionScreen),St(_.positionScreen,m.positionScreen),St(p.positionScreen,ot.positionScreen),St(p.positionScreen,nt.positionScreen)),ft.addPoint(m.positionScreen.x,m.positionScreen.y),ft.addPoint(d.positionScreen.x,d.positionScreen.y),ft.addPoint(p.positionScreen.x,p.positionScreen.y),ft.addPoint(_.positionScreen.x,_.positionScreen.y),!0===pt.intersects(ft))&&(At=m,Bt=d,It=p,Ht=_,Pt=ot,Lt=nt,Vt=t,W.info.render.vertices+=4,W.info.render.faces++,e(Dt.opacity),i(Dt.blending),void 0!==Dt.map&&null!==Dt.map||void 0!==Dt.envMap&&null!==Dt.envMap?(q(At,Bt,Ht,0,1,3,Mt,Dt),q(Pt,It,Lt,1,2,3,Mt,Dt)):(f=At.positionScreen.x,y=At.positionScreen.y,g=Bt.positionScreen.x,v=Bt.positionScreen.y,x=It.positionScreen.x,b=It.positionScreen.y,E=Ht.positionScreen.x,T=Ht.positionScreen.y,w=Pt.positionScreen.x,S=Pt.positionScreen.y,C=Lt.positionScreen.x,R=Lt.positionScreen.y,Dt instanceof THREE.MeshLambertMaterial||Dt instanceof THREE.MeshPhongMaterial?(ct.copy(Dt.color),ut.copy(Dt.emissive),Dt.vertexColors===THREE.FaceColors&&(ct.r*=Mt.color.r,ct.g*=Mt.color.g,ct.b*=Mt.color.b),!0===yt?!1===Dt.wireframe&&Dt.shading==THREE.SmoothShading&&4==Mt.vertexNormalsLength?(st.r=at.r=ht.r=lt.r=gt.r,st.g=at.g=ht.g=lt.g=gt.g,st.b=at.b=ht.b=lt.b=gt.b,l(Mt.v1.positionWorld,Mt.vertexNormalsWorld[0],st),l(Mt.v2.positionWorld,Mt.vertexNormalsWorld[1],at),l(Mt.v4.positionWorld,Mt.vertexNormalsWorld[3],ht),l(Mt.v3.positionWorld,Mt.vertexNormalsWorld[2],lt),st.r=st.r*ct.r+ut.r,st.g=st.g*ct.g+ut.g,st.b=st.b*ct.b+ut.b,at.r=at.r*ct.r+ut.r,at.g=at.g*ct.g+ut.g,at.b=at.b*ct.b+ut.b,ht.r=ht.r*ct.r+ut.r,ht.g=ht.g*ct.g+ut.g,ht.b=ht.b*ct.b+ut.b,lt.r=lt.r*ct.r+ut.r,lt.g=lt.g*ct.g+ut.g,lt.b=lt.b*ct.b+ut.b,A=Et(st,at,ht,lt),X(f,y,g,v,E,T),Q(f,y,g,v,E,T,0,0,1,0,0,1,A),X(w,S,x,b,C,R),Q(w,S,x,b,C,R,1,0,1,1,0,1,A)):(rt.r=gt.r,rt.g=gt.g,rt.b=gt.b,l(Mt.centroidWorld,Mt.normalWorld,rt),rt.r=rt.r*ct.r+ut.r,rt.g=rt.g*ct.g+ut.g,rt.b=rt.b*ct.b+ut.b,Y(f,y,g,v,x,b,E,T),!0===Dt.wireframe?K(rt,Dt.wireframeLinewidth,Dt.wireframeLinecap,Dt.wireframeLinejoin):Z(rt)):(rt.r=ct.r+ut.r,rt.g=ct.g+ut.g,rt.b=ct.b+ut.b,Y(f,y,g,v,x,b,E,T),!0===Dt.wireframe?K(rt,Dt.wireframeLinewidth,Dt.wireframeLinecap,Dt.wireframeLinejoin):Z(rt))):Dt instanceof THREE.MeshBasicMaterial?(rt.copy(Dt.color),Dt.vertexColors===THREE.FaceColors&&(rt.r*=Mt.color.r,rt.g*=Mt.color.g,rt.b*=Mt.color.b),Y(f,y,g,v,x,b,E,T),!0===Dt.wireframe?K(rt,Dt.wireframeLinewidth,Dt.wireframeLinecap,Dt.wireframeLinejoin):Z(rt)):Dt instanceof THREE.MeshNormalMaterial?(rt.r=wt(Mt.normalWorld.x),rt.g=wt(Mt.normalWorld.y),rt.b=wt(Mt.normalWorld.z),Y(f,y,g,v,x,b,E,T),!0===Dt.wireframe?K(rt,Dt.wireframeLinewidth,Dt.wireframeLinecap,Dt.wireframeLinejoin):Z(rt)):Dt instanceof THREE.MeshDepthMaterial&&(M=h.near,D=h.far,st.r=st.g=st.b=1-Tt(At.positionScreen.z,M,D),at.r=at.g=at.b=1-Tt(Bt.positionScreen.z,M,D),ht.r=ht.g=ht.b=1-Tt(Ht.positionScreen.z,M,D),lt.r=lt.g=lt.b=1-Tt(It.positionScreen.z,M,D),A=Et(st,at,ht,lt),X(f,y,g,v,E,T),Q(f,y,g,v,E,T,0,0,1,0,0,1,A),X(w,S,x,b,C,R),Q(w,S,x,b,C,R,1,0,1,1,0,1,A))));_t.addRectangle(ft)}J.setTransform(1,0,0,1,0,0)}}},THREE.ShaderChunk={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\nuniform samplerCube envMap;\nuniform float flipEnvMap;\nuniform int combine;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nuniform bool useRefract;\nuniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_fragment:"#ifdef USE_ENVMAP\nvec3 reflectVec;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nreflectVec = refract( cameraToVertex, normal, refractionRatio );\n} else { \nreflectVec = reflect( cameraToVertex, normal );\n}\n#else\nreflectVec = vReflect;\n#endif\n#ifdef DOUBLE_SIDED\nfloat flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );\nvec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#else\nvec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#endif\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\nif ( combine == 1 ) {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );\n} else {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );\n}\n#endif",envmap_pars_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvarying vec3 vReflect;\nuniform float refractionRatio;\nuniform bool useRefract;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n#ifdef USE_SKINNING\nvec4 mPosition = modelMatrix * skinned;\n#endif\n#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 mPosition = modelMatrix * vec4( morphed, 1.0 );\n#endif\n#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 mPosition = modelMatrix * vec4( position, 1.0 );\n#endif\n#endif",envmap_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvec3 nWorld = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;\nif ( useRefract ) {\nvReflect = refract( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ), refractionRatio );\n} else {\nvReflect = reflect( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ) );\n}\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif",map_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\nuniform vec4 offsetRepeat;\n#endif",map_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",map_fragment:"#ifdef USE_MAP\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( map, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( map, vUv );\n#endif\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D lightMap;\n#endif",lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;\nuniform float bumpScale;\nvec2 dHdxy_fwd() {\nvec2 dSTdx = dFdx( vUv );\nvec2 dSTdy = dFdy( vUv );\nfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\nfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\nfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\nreturn vec2( dBx, dBy );\n}\nvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\nvec3 vSigmaX = dFdx( surf_pos );\nvec3 vSigmaY = dFdy( surf_pos );\nvec3 vN = surf_norm;\nvec3 R1 = cross( vSigmaY, vN );\nvec3 R2 = cross( vN, vSigmaX );\nfloat fDet = dot( vSigmaX, R1 );\nvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\nreturn normalize( abs( fDet ) * surf_norm - vGrad );\n}\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;\nuniform vec2 normalScale;\nvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\nvec3 q0 = dFdx( eye_pos.xyz );\nvec3 q1 = dFdy( eye_pos.xyz );\nvec2 st0 = dFdx( vUv.st );\nvec2 st1 = dFdy( vUv.st );\nvec3 S = normalize(  q0 * st1.t - q1 * st0.t );\nvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\nvec3 N = normalize( surf_norm );\nvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\nmapN.xy = normalScale * mapN.xy;\nmat3 tsn = mat3( S, T, N );\nreturn normalize( tsn * mapN );\n}\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular = texture2D( specularMap, vUv );\nspecularStrength = texelSpecular.r;\n#else\nspecularStrength = 1.0;\n#endif",lights_lambert_pars_vertex:"uniform vec3 ambient;\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightPosition[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngle[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif",lights_lambert_vertex:"vLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\nvLightBack = vec3( 0.0 );\n#endif\ntransformedNormal = normalize( transformedNormal );\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, dirVector );\nvec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\ndirectionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\ndirectionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += directionalLightColor[ i ] * directionalLightWeighting;\n#ifdef DOUBLE_SIDED\nvLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;\n#endif\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\npointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\npointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;\n#ifdef DOUBLE_SIDED\nvLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nfor( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nlVector = normalize( lVector );\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - mPosition.xyz ) );\nif ( spotEffect > spotLightAngle[ i ] ) {\nspotEffect = pow( spotEffect, spotLightExponent[ i ] );\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\nspotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\nspotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;\n#ifdef DOUBLE_SIDED\nvLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( hemisphereLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nfloat hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;\nvLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\n#ifdef DOUBLE_SIDED\nvLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );\n#endif\n}\n#endif\nvLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;\n#ifdef DOUBLE_SIDED\nvLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;\n#endif",lights_phong_pars_vertex:"#ifndef PHONG_PER_PIXEL\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\nvarying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif",lights_phong_vertex:"#ifndef PHONG_PER_PIXEL\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nvPointLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nfor( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nvSpotLight[ i ] = vec4( lVector, lDistance );\n}\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvWorldPosition = mPosition.xyz;\n#endif",lights_phong_pars_fragment:"uniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightPosition[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\n#ifdef PHONG_PER_PIXEL\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#else\nvarying vec4 vPointLight[ MAX_POINT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngle[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n#ifdef PHONG_PER_PIXEL\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#else\nvarying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];\n#endif\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",
lights_phong_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#ifdef DOUBLE_SIDED\nnormal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#ifdef USE_NORMALMAP\nnormal = perturbNormal2Arb( -viewPosition, normal );\n#elif defined( USE_BUMPMAP )\nnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse  = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n#ifdef PHONG_PER_PIXEL\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\n#else\nvec3 lVector = normalize( vPointLight[ i ].xyz );\nfloat lDistance = vPointLight[ i ].w;\n#endif\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dotProduct, 0.0 );\n#endif\npointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;\nvec3 pointHalfVector = normalize( lVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;\n#else\npointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse  = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n#ifdef PHONG_PER_PIXEL\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\n#else\nvec3 lVector = normalize( vSpotLight[ i ].xyz );\nfloat lDistance = vSpotLight[ i ].w;\n#endif\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngle[ i ] ) {\nspotEffect = pow( spotEffect, spotLightExponent[ i ] );\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dotProduct, 0.0 );\n#endif\nspotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;\nvec3 spotHalfVector = normalize( lVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;\n#else\nspotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse  = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, dirVector );\n#ifdef WRAP_AROUND\nfloat dirDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dotProduct, 0.0 );\n#endif\ndirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n#else\ndirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( hemisphereLightPosition[ i ], 1.0 );\nvec3 lVector = normalize( lPosition.xyz + vViewPosition.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += diffuse * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );\nvec3 lVectorGround = normalize( -lPosition.xyz + vViewPosition.xyz );\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n#else\nhemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;\n#endif\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, opacity );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n#ifdef GAMMA_INPUT\nvColor = color * color;\n#else\nvColor = color;\n#endif\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n#ifdef BONE_TEXTURE\nuniform sampler2D boneTexture;\nmat4 getBoneMatrix( const in float i ) {\nfloat j = i * 4.0;\nfloat x = mod( j, N_BONE_PIXEL_X );\nfloat y = floor( j / N_BONE_PIXEL_X );\nconst float dx = 1.0 / N_BONE_PIXEL_X;\nconst float dy = 1.0 / N_BONE_PIXEL_Y;\ny = dy * ( y + 0.5 );\nvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\nvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\nvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\nvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\nmat4 bone = mat4( v1, v2, v3, v4 );\nreturn bone;\n}\n#else\nuniform mat4 boneGlobalMatrices[ MAX_BONES ];\nmat4 getBoneMatrix( const in float i ) {\nmat4 bone = boneGlobalMatrices[ int(i) ];\nreturn bone;\n}\n#endif\n#endif",skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX = getBoneMatrix( skinIndex.x );\nmat4 boneMatY = getBoneMatrix( skinIndex.y );\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n#ifdef USE_MORPHTARGETS\nvec4 skinVertex = vec4( morphed, 1.0 );\n#else\nvec4 skinVertex = vec4( position, 1.0 );\n#endif\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[ 8 ];\n#else\nuniform float morphTargetInfluences[ 4 ];\n#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\nvec3 morphed = vec3( 0.0 );\nmorphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\nmorphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\nmorphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\nmorphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n#ifndef USE_MORPHNORMALS\nmorphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\nmorphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\nmorphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\nmorphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n#endif\nmorphed += position;\n#endif",default_vertex:"vec4 mvPosition;\n#ifdef USE_SKINNING\nmvPosition = modelViewMatrix * skinned;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( morphed, 1.0 );\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( position, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nvec3 morphedNormal = vec3( 0.0 );\nmorphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\nmorphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\nmorphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\nmorphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\nmorphedNormal += normal;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix = skinWeight.x * boneMatX;\nskinMatrix \t+= skinWeight.y * boneMatY;\n#ifdef USE_MORPHNORMALS\nvec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );\n#else\nvec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );\n#endif\n#endif",defaultnormal_vertex:"vec3 objectNormal;\n#ifdef USE_SKINNING\nobjectNormal = skinnedNormal.xyz;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )\nobjectNormal = morphedNormal;\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )\nobjectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\nobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\nuniform sampler2D shadowMap[ MAX_SHADOWS ];\nuniform vec2 shadowMapSize[ MAX_SHADOWS ];\nuniform float shadowDarkness[ MAX_SHADOWS ];\nuniform float shadowBias[ MAX_SHADOWS ];\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nfloat unpackDepth( const in vec4 rgba_depth ) {\nconst vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\nfloat depth = dot( rgba_depth, bit_shift );\nreturn depth;\n}\n#endif",shadowmap_fragment:"#ifdef USE_SHADOWMAP\n#ifdef SHADOWMAP_DEBUG\nvec3 frustumColors[3];\nfrustumColors[0] = vec3( 1.0, 0.5, 0.0 );\nfrustumColors[1] = vec3( 0.0, 1.0, 0.8 );\nfrustumColors[2] = vec3( 0.0, 0.5, 1.0 );\n#endif\n#ifdef SHADOWMAP_CASCADE\nint inFrustumCount = 0;\n#endif\nfloat fDepth;\nvec3 shadowColor = vec3( 1.0 );\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;\nbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\nbool inFrustum = all( inFrustumVec );\n#ifdef SHADOWMAP_CASCADE\ninFrustumCount += int( inFrustum );\nbvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );\n#else\nbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n#endif\nbool frustumTest = all( frustumTestVec );\nif ( frustumTest ) {\nshadowCoord.z += shadowBias[ i ];\n#ifdef SHADOWMAP_SOFT\nfloat shadow = 0.0;\nconst float shadowDelta = 1.0 / 9.0;\nfloat xPixelOffset = 1.0 / shadowMapSize[ i ].x;\nfloat yPixelOffset = 1.0 / shadowMapSize[ i ].y;\nfloat dx0 = -1.25 * xPixelOffset;\nfloat dy0 = -1.25 * yPixelOffset;\nfloat dx1 = 1.25 * xPixelOffset;\nfloat dy1 = 1.25 * yPixelOffset;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nshadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );\n#else\nvec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );\nfloat fDepth = unpackDepth( rgbaDepth );\nif ( fDepth < shadowCoord.z )\nshadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );\n#endif\n}\n#ifdef SHADOWMAP_DEBUG\n#ifdef SHADOWMAP_CASCADE\nif ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];\n#else\nif ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];\n#endif\n#endif\n}\n#ifdef GAMMA_OUTPUT\nshadowColor *= shadowColor;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * shadowColor;\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nuniform mat4 shadowMatrix[ MAX_SHADOWS ];\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * mPosition;\n}\n#endif",alphatest_fragment:"#ifdef ALPHATEST\nif ( gl_FragColor.a < ALPHATEST ) discard;\n#endif",linear_to_gamma_fragment:"#ifdef GAMMA_OUTPUT\ngl_FragColor.xyz = sqrt( gl_FragColor.xyz );\n#endif"},THREE.UniformsUtils={merge:function(t){var e,i,o,n={};for(e=0;e<t.length;e++)for(i in o=this.clone(t[e]))n[i]=o[i];return n},clone:function(t){var e,i,o,n={};for(e in t)for(i in n[e]={},t[e])o=t[e][i],n[e][i]=o instanceof THREE.Color||o instanceof THREE.Vector2||o instanceof THREE.Vector3||o instanceof THREE.Vector4||o instanceof THREE.Matrix4||o instanceof THREE.Texture?o.clone():o instanceof Array?o.slice():o;return n}},THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightPosition:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngle:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},THREE.ShaderLib={depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float mNear;\nuniform float mFar;\nuniform float opacity;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), opacity );\n}"},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:"varying vec3 vNormal;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvNormal = normalMatrix * normal;\ngl_Position = projectionMatrix * mvPosition;\n}",fragmentShader:"uniform float opacity;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );\n}"},basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.shadowmap]),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,"#ifdef USE_ENVMAP",THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"#endif",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED\nif ( gl_FrontFacing )\ngl_FragColor.xyz *= vLightFront;\nelse\ngl_FragColor.xyz *= vLightBack;\n#else\ngl_FragColor.xyz *= vLightFront;\n#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.bump,THREE.UniformsLib.normalmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define PHONG\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = transformedNormal;",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 ambient;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle,THREE.UniformsLib.shadowmap]),vertexShader:["uniform float size;\nuniform float scale;",THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n#else\ngl_PointSize = size;\n#endif\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_particle_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk.map_particle_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"vec4 pack_depth( const in float depth ) {\nconst vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\nconst vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\nvec4 res = fract( depth * bit_shift );\nres -= res.xxyz * bit_mask;\nreturn res;\n}\nvoid main() {\ngl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );\n}"}},THREE.WebGLRenderer=function(t){function e(t,e){var i=t.vertices.length,o=e.material;if(o.attributes){void 0===t.__webglCustomAttributesList&&(t.__webglCustomAttributesList=[]);for(var n in o.attributes){var r=o.attributes[n];if(!r.__webglInitialized||r.createUniqueBuffers){r.__webglInitialized=!0;var s=1;"v2"===r.type?s=2:"v3"===r.type?s=3:"v4"===r.type?s=4:"c"===r.type&&(s=3),r.size=s,r.array=new Float32Array(i*s),r.buffer=N.createBuffer(),r.buffer.belongsToAttribute=n,r.needsUpdate=!0}t.__webglCustomAttributesList.push(r)}}}function i(t,e){return!t.material||t.material instanceof THREE.MeshFaceMaterial?0<=e.materialIndex?t.geometry.materials[e.materialIndex]:void 0:t.material}function o(t){return!(t instanceof THREE.MeshBasicMaterial&&!t.envMap||t instanceof THREE.MeshDepthMaterial)&&(t&&void 0!==t.shading&&t.shading===THREE.SmoothShading?THREE.SmoothShading:THREE.FlatShading)}function n(t){return!!(t.map||t.lightMap||t.bumpMap||t.normalMap||t.specularMap||t instanceof THREE.ShaderMaterial)}function r(t){var e,i,o;for(e in t.attributes)o="index"===e?N.ELEMENT_ARRAY_BUFFER:N.ARRAY_BUFFER,i=t.attributes[e],i.buffer=N.createBuffer(),N.bindBuffer(o,i.buffer),N.bufferData(o,i.array,N.STATIC_DRAW)}function s(t,e,i){var o,n,r,s,a=t.vertices;s=a.length;var h=t.colors,l=h.length,c=t.__vertexArray,u=t.__colorArray,m=t.__sortArray,d=t.verticesNeedUpdate,p=t.colorsNeedUpdate,_=t.__webglCustomAttributesList;if(i.sortParticles){for(vt.copy(gt),vt.multiplySelf(i.matrixWorld),o=0;o<s;o++)n=a[o],xt.copy(n),vt.multiplyVector3(xt),m[o]=[xt.z,o];for(m.sort(function(t,e){return e[0]-t[0]}),o=0;o<s;o++)n=a[m[o][1]],r=3*o,c[r]=n.x,c[r+1]=n.y,c[r+2]=n.z;for(o=0;o<l;o++)r=3*o,n=h[m[o][1]],u[r]=n.r,u[r+1]=n.g,u[r+2]=n.b;if(_)for(h=0,l=_.length;h<l;h++)if(a=_[h],void 0===a.boundTo||"vertices"===a.boundTo)if(r=0,n=a.value.length,1===a.size)for(o=0;o<n;o++)s=m[o][1],a.array[o]=a.value[s];else if(2===a.size)for(o=0;o<n;o++)s=m[o][1],s=a.value[s],a.array[r]=s.x,a.array[r+1]=s.y,r+=2;else if(3===a.size)if("c"===a.type)for(o=0;o<n;o++)s=m[o][1],s=a.value[s],a.array[r]=s.r,a.array[r+1]=s.g,a.array[r+2]=s.b,r+=3;else for(o=0;o<n;o++)s=m[o][1],s=a.value[s],a.array[r]=s.x,a.array[r+1]=s.y,a.array[r+2]=s.z,r+=3;else if(4===a.size)for(o=0;o<n;o++)s=m[o][1],s=a.value[s],a.array[r]=s.x,a.array[r+1]=s.y,a.array[r+2]=s.z,a.array[r+3]=s.w,r+=4}else{if(d)for(o=0;o<s;o++)n=a[o],r=3*o,c[r]=n.x,c[r+1]=n.y,c[r+2]=n.z;if(p)for(o=0;o<l;o++)n=h[o],r=3*o,u[r]=n.r,u[r+1]=n.g,u[r+2]=n.b;if(_)for(h=0,l=_.length;h<l;h++)if(a=_[h],a.needsUpdate&&(void 0===a.boundTo||"vertices"===a.boundTo))if(n=a.value.length,r=0,1===a.size)for(o=0;o<n;o++)a.array[o]=a.value[o];else if(2===a.size)for(o=0;o<n;o++)s=a.value[o],a.array[r]=s.x,a.array[r+1]=s.y,r+=2;else if(3===a.size)if("c"===a.type)for(o=0;o<n;o++)s=a.value[o],a.array[r]=s.r,a.array[r+1]=s.g,a.array[r+2]=s.b,r+=3;else for(o=0;o<n;o++)s=a.value[o],a.array[r]=s.x,a.array[r+1]=s.y,a.array[r+2]=s.z,r+=3;else if(4===a.size)for(o=0;o<n;o++)s=a.value[o],a.array[r]=s.x,a.array[r+1]=s.y,a.array[r+2]=s.z,a.array[r+3]=s.w,r+=4}if((d||i.sortParticles)&&(N.bindBuffer(N.ARRAY_BUFFER,t.__webglVertexBuffer),N.bufferData(N.ARRAY_BUFFER,c,e)),(p||i.sortParticles)&&(N.bindBuffer(N.ARRAY_BUFFER,t.__webglColorBuffer),N.bufferData(N.ARRAY_BUFFER,u,e)),_)for(h=0,l=_.length;h<l;h++)a=_[h],(a.needsUpdate||i.sortParticles)&&(N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.bufferData(N.ARRAY_BUFFER,a.array,e))}function a(t,e,i){var o=t.attributes,n=o.index,r=o.position,s=o.normal,a=o.uv,h=o.color,o=o.tangent;if(t.elementsNeedUpdate&&void 0!==n&&(N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,n.buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,n.array,e)),t.verticesNeedUpdate&&void 0!==r&&(N.bindBuffer(N.ARRAY_BUFFER,r.buffer),N.bufferData(N.ARRAY_BUFFER,r.array,e)),t.normalsNeedUpdate&&void 0!==s&&(N.bindBuffer(N.ARRAY_BUFFER,s.buffer),N.bufferData(N.ARRAY_BUFFER,s.array,e)),t.uvsNeedUpdate&&void 0!==a&&(N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.bufferData(N.ARRAY_BUFFER,a.array,e)),t.colorsNeedUpdate&&void 0!==h&&(N.bindBuffer(N.ARRAY_BUFFER,h.buffer),N.bufferData(N.ARRAY_BUFFER,h.array,e)),t.tangentsNeedUpdate&&void 0!==o&&(N.bindBuffer(N.ARRAY_BUFFER,o.buffer),N.bufferData(N.ARRAY_BUFFER,o.array,e)),i)for(var l in t.attributes)delete t.attributes[l].array}function h(t,e){return e.z-t.z}function l(t,e){return e[1]-t[1]}function c(t,e,i){if(t.length)for(var o=0,n=t.length;o<n;o++)K=q=null,X=Y=tt=Q=st=rt=et=-1,Et=!0,t[o].render(e,i,_t,ft),K=q=null,X=Y=tt=Q=st=rt=et=-1,Et=!0}function u(t,e,i,o,n,r,s,a){var h,l,c,u;e?(l=t.length-1,u=e=-1):(l=0,e=t.length,u=1);for(var m=l;m!==e;m+=u)if(h=t[m],h.render){if(l=h.object,c=h.buffer,a)h=a;else{if(!(h=h[i]))continue;s&&G.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst),G.setDepthTest(h.depthTest),G.setDepthWrite(h.depthWrite),
T(h.polygonOffset,h.polygonOffsetFactor,h.polygonOffsetUnits)}G.setMaterialFaces(h),c instanceof THREE.BufferGeometry?G.renderBufferDirect(o,n,r,h,c,l):G.renderBuffer(o,n,r,h,c,l)}}function m(t,e,i,o,n,r,s){for(var a,h,l=0,c=t.length;l<c;l++)if(a=t[l],h=a.object,h.visible){if(s)a=s;else{if(!(a=a[e]))continue;r&&G.setBlending(a.blending,a.blendEquation,a.blendSrc,a.blendDst),G.setDepthTest(a.depthTest),G.setDepthWrite(a.depthWrite),T(a.polygonOffset,a.polygonOffsetFactor,a.polygonOffsetUnits)}G.renderImmediateObject(i,o,n,a,h)}}function d(t,e,i){t.push({buffer:e,object:i,opaque:null,transparent:null})}function p(t){for(var e in t.attributes)if(t.attributes[e].needsUpdate)return!0;return!1}function _(t){for(var e in t.attributes)t.attributes[e].needsUpdate=!1}function f(t,e){for(var i=t.length-1;0<=i;i--)t[i].object===e&&t.splice(i,1)}function y(t,e){for(var i=t.length-1;0<=i;i--)t[i]===e&&t.splice(i,1)}function g(t,e,i,o,n){$=0,o.needsUpdate&&(o.program&&G.deallocateMaterial(o),G.initMaterial(o,e,i,n),o.needsUpdate=!1),o.morphTargets&&!n.__webglMorphTargetInfluences&&(n.__webglMorphTargetInfluences=new Float32Array(G.maxMorphTargets));var r=!1,s=o.program,a=s.uniforms,h=o.uniforms;if(s!==q&&(N.useProgram(s),q=s,r=!0),o.id!==X&&(X=o.id,r=!0),(r||t!==K)&&(N.uniformMatrix4fv(a.projectionMatrix,!1,t._projectionMatrixArray),t!==K&&(K=t)),o.skinning)if(Mt&&n.useVertexTexture){if(null!==a.boneTexture){var l=v();N.uniform1i(a.boneTexture,l),G.setTexture(n.boneTexture,l)}}else null!==a.boneGlobalMatrices&&N.uniformMatrix4fv(a.boneGlobalMatrices,!1,n.boneMatrices);if(r){if(i&&o.fog&&(h.fogColor.value=i.color,i instanceof THREE.Fog?(h.fogNear.value=i.near,h.fogFar.value=i.far):i instanceof THREE.FogExp2&&(h.fogDensity.value=i.density)),o instanceof THREE.MeshPhongMaterial||o instanceof THREE.MeshLambertMaterial||o.lights){if(Et){for(var c,u,m,d,p=0,_=0,f=0,y=Tt,g=y.directional.colors,x=y.directional.positions,T=y.point.colors,w=y.point.positions,S=y.point.distances,R=y.spot.colors,M=y.spot.positions,B=y.spot.distances,I=y.spot.directions,H=y.spot.angles,P=y.spot.exponents,L=y.hemi.skyColors,V=y.hemi.groundColors,k=y.hemi.positions,F=0,z=0,U=0,O=0,i=c=m=m=u=0,r=e.length;i<r;i++)l=e[i],!l.onlyShadow&&l.visible&&(c=l.color,d=l.intensity,u=l.distance,l instanceof THREE.AmbientLight?G.gammaInput?(p+=c.r*c.r,_+=c.g*c.g,f+=c.b*c.b):(p+=c.r,_+=c.g,f+=c.b):l instanceof THREE.DirectionalLight?(u=3*F,G.gammaInput?b(g,u,c,d*d):E(g,u,c,d),bt.copy(l.matrixWorld.getPosition()),bt.subSelf(l.target.matrixWorld.getPosition()),bt.normalize(),x[u]=bt.x,x[u+1]=bt.y,x[u+2]=bt.z,F+=1):l instanceof THREE.PointLight?(m=3*z,G.gammaInput?b(T,m,c,d*d):E(T,m,c,d),d=l.matrixWorld.getPosition(),w[m]=d.x,w[m+1]=d.y,w[m+2]=d.z,S[z]=u,z+=1):l instanceof THREE.SpotLight?(m=3*U,G.gammaInput?b(R,m,c,d*d):E(R,m,c,d),d=l.matrixWorld.getPosition(),M[m]=d.x,M[m+1]=d.y,M[m+2]=d.z,B[U]=u,bt.copy(d),bt.subSelf(l.target.matrixWorld.getPosition()),bt.normalize(),I[m]=bt.x,I[m+1]=bt.y,I[m+2]=bt.z,H[U]=Math.cos(l.angle),P[U]=l.exponent,U+=1):l instanceof THREE.HemisphereLight&&(u=l.color,m=l.groundColor,c=3*O,G.gammaInput?(d*=d,b(L,c,u,d),b(V,c,m,d)):(E(L,c,u,d),E(V,c,m,d)),d=l.matrixWorld.getPosition(),k[c]=d.x,k[c+1]=d.y,k[c+2]=d.z,O+=1));for(i=3*F,r=g.length;i<r;i++)g[i]=0;for(i=3*z,r=T.length;i<r;i++)T[i]=0;for(i=3*U,r=R.length;i<r;i++)R[i]=0;for(i=3*O,r=L.length;i<r;i++)L[i]=0;for(i=3*O,r=V.length;i<r;i++)V[i]=0;y.directional.length=F,y.point.length=z,y.spot.length=U,y.hemi.length=O,y.ambient[0]=p,y.ambient[1]=_,y.ambient[2]=f,Et=!1}i=Tt,h.ambientLightColor.value=i.ambient,h.directionalLightColor.value=i.directional.colors,h.directionalLightDirection.value=i.directional.positions,h.pointLightColor.value=i.point.colors,h.pointLightPosition.value=i.point.positions,h.pointLightDistance.value=i.point.distances,h.spotLightColor.value=i.spot.colors,h.spotLightPosition.value=i.spot.positions,h.spotLightDistance.value=i.spot.distances,h.spotLightDirection.value=i.spot.directions,h.spotLightAngle.value=i.spot.angles,h.spotLightExponent.value=i.spot.exponents,h.hemisphereLightSkyColor.value=i.hemi.skyColors,h.hemisphereLightGroundColor.value=i.hemi.groundColors,h.hemisphereLightPosition.value=i.hemi.positions}if(o instanceof THREE.MeshBasicMaterial||o instanceof THREE.MeshLambertMaterial||o instanceof THREE.MeshPhongMaterial){h.opacity.value=o.opacity,G.gammaInput?h.diffuse.value.copyGammaToLinear(o.color):h.diffuse.value=o.color,h.map.value=o.map,h.lightMap.value=o.lightMap,h.specularMap.value=o.specularMap,o.bumpMap&&(h.bumpMap.value=o.bumpMap,h.bumpScale.value=o.bumpScale),o.normalMap&&(h.normalMap.value=o.normalMap,h.normalScale.value.copy(o.normalScale));var W;o.map?W=o.map:o.specularMap?W=o.specularMap:o.normalMap?W=o.normalMap:o.bumpMap&&(W=o.bumpMap),void 0!==W&&(i=W.offset,W=W.repeat,h.offsetRepeat.value.set(i.x,i.y,W.x,W.y)),h.envMap.value=o.envMap,h.flipEnvMap.value=o.envMap instanceof THREE.WebGLRenderTargetCube?1:-1,h.reflectivity.value=o.reflectivity,h.refractionRatio.value=o.refractionRatio,h.combine.value=o.combine,h.useRefract.value=o.envMap&&o.envMap.mapping instanceof THREE.CubeRefractionMapping}if(o instanceof THREE.LineBasicMaterial?(h.diffuse.value=o.color,h.opacity.value=o.opacity):o instanceof THREE.ParticleBasicMaterial?(h.psColor.value=o.color,h.opacity.value=o.opacity,h.size.value=o.size,h.scale.value=A.height/2,h.map.value=o.map):o instanceof THREE.MeshPhongMaterial?(h.shininess.value=o.shininess,G.gammaInput?(h.ambient.value.copyGammaToLinear(o.ambient),h.emissive.value.copyGammaToLinear(o.emissive),h.specular.value.copyGammaToLinear(o.specular)):(h.ambient.value=o.ambient,h.emissive.value=o.emissive,h.specular.value=o.specular),o.wrapAround&&h.wrapRGB.value.copy(o.wrapRGB)):o instanceof THREE.MeshLambertMaterial?(G.gammaInput?(h.ambient.value.copyGammaToLinear(o.ambient),h.emissive.value.copyGammaToLinear(o.emissive)):(h.ambient.value=o.ambient,h.emissive.value=o.emissive),o.wrapAround&&h.wrapRGB.value.copy(o.wrapRGB)):o instanceof THREE.MeshDepthMaterial?(h.mNear.value=t.near,h.mFar.value=t.far,h.opacity.value=o.opacity):o instanceof THREE.MeshNormalMaterial&&(h.opacity.value=o.opacity),n.receiveShadow&&!o._shadowPass&&h.shadowMatrix)for(i=W=0,r=e.length;i<r;i++)l=e[i],l.castShadow&&(l instanceof THREE.SpotLight||l instanceof THREE.DirectionalLight&&!l.shadowCascade)&&(h.shadowMap.value[W]=l.shadowMap,h.shadowMapSize.value[W]=l.shadowMapSize,h.shadowMatrix.value[W]=l.shadowMatrix,h.shadowDarkness.value[W]=l.shadowDarkness,h.shadowBias.value[W]=l.shadowBias,W++);for(e=o.uniformsList,h=0,W=e.length;h<W;h++)if(r=s.uniforms[e[h][1]])if(i=e[h][0],p=i.type,l=i.value,"i"===p)N.uniform1i(r,l);else if("f"===p)N.uniform1f(r,l);else if("v2"===p)N.uniform2f(r,l.x,l.y);else if("v3"===p)N.uniform3f(r,l.x,l.y,l.z);else if("v4"===p)N.uniform4f(r,l.x,l.y,l.z,l.w);else if("c"===p)N.uniform3f(r,l.r,l.g,l.b);else if("iv1"===p)N.uniform1iv(r,l);else if("iv"===p)N.uniform3iv(r,l);else if("fv1"===p)N.uniform1fv(r,l);else if("fv"===p)N.uniform3fv(r,l);else if("v2v"===p){for(void 0===i._array&&(i._array=new Float32Array(2*l.length)),p=0,_=l.length;p<_;p++)f=2*p,i._array[f]=l[p].x,i._array[f+1]=l[p].y;N.uniform2fv(r,i._array)}else if("v3v"===p){for(void 0===i._array&&(i._array=new Float32Array(3*l.length)),p=0,_=l.length;p<_;p++)f=3*p,i._array[f]=l[p].x,i._array[f+1]=l[p].y,i._array[f+2]=l[p].z;N.uniform3fv(r,i._array)}else if("v4v"===p){for(void 0===i._array&&(i._array=new Float32Array(4*l.length)),p=0,_=l.length;p<_;p++)f=4*p,i._array[f]=l[p].x,i._array[f+1]=l[p].y,i._array[f+2]=l[p].z,i._array[f+3]=l[p].w;N.uniform4fv(r,i._array)}else if("m4"===p)void 0===i._array&&(i._array=new Float32Array(16)),l.flattenToArray(i._array),N.uniformMatrix4fv(r,!1,i._array);else if("m4v"===p){for(void 0===i._array&&(i._array=new Float32Array(16*l.length)),p=0,_=l.length;p<_;p++)l[p].flattenToArrayOffset(i._array,16*p);N.uniformMatrix4fv(r,!1,i._array)}else if("t"===p){if(f=l,l=v(),N.uniform1i(r,l),f)if(f.image instanceof Array&&6===f.image.length){if(i=f,r=l,6===i.image.length)if(i.needsUpdate){for(i.image.__webglTextureCube||(i.image.__webglTextureCube=N.createTexture()),N.activeTexture(N.TEXTURE0+r),N.bindTexture(N.TEXTURE_CUBE_MAP,i.image.__webglTextureCube),N.pixelStorei(N.UNPACK_FLIP_Y_WEBGL,i.flipY),r=i instanceof THREE.CompressedTexture,l=[],p=0;6>p;p++)G.autoScaleCubemaps&&!r?(_=l,f=p,y=i.image[p],x=St,y.width<=x&&y.height<=x||(T=Math.max(y.width,y.height),g=Math.floor(y.width*x/T),x=Math.floor(y.height*x/T),T=document.createElement("canvas"),T.width=g,T.height=x,T.getContext("2d").drawImage(y,0,0,y.width,y.height,0,0,g,x),y=T),_[f]=y):l[p]=i.image[p];for(p=l[0],_=0==(p.width&p.width-1)&&0==(p.height&p.height-1),f=D(i.format),y=D(i.type),C(N.TEXTURE_CUBE_MAP,i,_),p=0;6>p;p++)if(r)for(x=l[p].mipmaps,T=0,w=x.length;T<w;T++)g=x[T],N.compressedTexImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+p,T,f,g.width,g.height,0,g.data);else N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+p,0,f,f,y,l[p]);i.generateMipmaps&&_&&N.generateMipmap(N.TEXTURE_CUBE_MAP),i.needsUpdate=!1,i.onUpdate&&i.onUpdate()}else N.activeTexture(N.TEXTURE0+r),N.bindTexture(N.TEXTURE_CUBE_MAP,i.image.__webglTextureCube)}else f instanceof THREE.WebGLRenderTargetCube?(i=f,N.activeTexture(N.TEXTURE0+l),N.bindTexture(N.TEXTURE_CUBE_MAP,i.__webglTexture)):G.setTexture(f,l)}else if("tv"===p){for(void 0===i._array&&(i._array=[]),p=0,_=i.value.length;p<_;p++)i._array[p]=v();for(N.uniform1iv(r,i._array),p=0,_=i.value.length;p<_;p++)f=i.value[p],l=i._array[p],f&&G.setTexture(f,l)}(o instanceof THREE.ShaderMaterial||o instanceof THREE.MeshPhongMaterial||o.envMap)&&null!==a.cameraPosition&&(e=t.matrixWorld.getPosition(),N.uniform3f(a.cameraPosition,e.x,e.y,e.z)),(o instanceof THREE.MeshPhongMaterial||o instanceof THREE.MeshLambertMaterial||o instanceof THREE.ShaderMaterial||o.skinning)&&null!==a.viewMatrix&&N.uniformMatrix4fv(a.viewMatrix,!1,t._viewMatrixArray)}return N.uniformMatrix4fv(a.modelViewMatrix,!1,n._modelViewMatrix.elements),a.normalMatrix&&N.uniformMatrix3fv(a.normalMatrix,!1,n._normalMatrix.elements),null!==a.modelMatrix&&N.uniformMatrix4fv(a.modelMatrix,!1,n.matrixWorld.elements),s}function v(){var t=$;return t>=wt&&console.warn("Trying to use "+t+" texture units while this GPU supports only "+wt),$+=1,t}function x(t,e){t._modelViewMatrix.multiply(e.matrixWorldInverse,t.matrixWorld),t._normalMatrix.getInverse(t._modelViewMatrix),t._normalMatrix.transpose()}function b(t,e,i,o){t[e]=i.r*i.r*o,t[e+1]=i.g*i.g*o,t[e+2]=i.b*i.b*o}function E(t,e,i,o){t[e]=i.r*o,t[e+1]=i.g*o,t[e+2]=i.b*o}function T(t,e,i){at!==t&&(t?N.enable(N.POLYGON_OFFSET_FILL):N.disable(N.POLYGON_OFFSET_FILL),at=t),!t||ht===e&&lt===i||(N.polygonOffset(e,i),ht=e,lt=i)}function w(t){for(var t=t.split("\n"),e=0,i=t.length;e<i;e++)t[e]=e+1+": "+t[e];return t.join("\n")}function S(t,e){var i;return"fragment"===t?i=N.createShader(N.FRAGMENT_SHADER):"vertex"===t&&(i=N.createShader(N.VERTEX_SHADER)),N.shaderSource(i,e),N.compileShader(i),N.getShaderParameter(i,N.COMPILE_STATUS)?i:(console.error(N.getShaderInfoLog(i)),console.error(w(e)),null)}function C(t,e,i){i?(N.texParameteri(t,N.TEXTURE_WRAP_S,D(e.wrapS)),N.texParameteri(t,N.TEXTURE_WRAP_T,D(e.wrapT)),N.texParameteri(t,N.TEXTURE_MAG_FILTER,D(e.magFilter)),N.texParameteri(t,N.TEXTURE_MIN_FILTER,D(e.minFilter))):(N.texParameteri(t,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(t,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(t,N.TEXTURE_MAG_FILTER,M(e.magFilter)),N.texParameteri(t,N.TEXTURE_MIN_FILTER,M(e.minFilter))),U&&e.type!==THREE.FloatType&&(1<e.anisotropy||e.__oldAnisotropy)&&(N.texParameterf(t,U.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(e.anisotropy,Ct)),e.__oldAnisotropy=e.anisotropy)}function R(t,e){N.bindRenderbuffer(N.RENDERBUFFER,t),e.depthBuffer&&!e.stencilBuffer?(N.renderbufferStorage(N.RENDERBUFFER,N.DEPTH_COMPONENT16,e.width,e.height),N.framebufferRenderbuffer(N.FRAMEBUFFER,N.DEPTH_ATTACHMENT,N.RENDERBUFFER,t)):e.depthBuffer&&e.stencilBuffer?(N.renderbufferStorage(N.RENDERBUFFER,N.DEPTH_STENCIL,e.width,e.height),N.framebufferRenderbuffer(N.FRAMEBUFFER,N.DEPTH_STENCIL_ATTACHMENT,N.RENDERBUFFER,t)):N.renderbufferStorage(N.RENDERBUFFER,N.RGBA4,e.width,e.height)}function M(t){return t===THREE.NearestFilter||t===THREE.NearestMipMapNearestFilter||t===THREE.NearestMipMapLinearFilter?N.NEAREST:N.LINEAR}function D(t){if(t===THREE.RepeatWrapping)return N.REPEAT;if(t===THREE.ClampToEdgeWrapping)return N.CLAMP_TO_EDGE;if(t===THREE.MirroredRepeatWrapping)return N.MIRRORED_REPEAT;if(t===THREE.NearestFilter)return N.NEAREST;if(t===THREE.NearestMipMapNearestFilter)return N.NEAREST_MIPMAP_NEAREST;if(t===THREE.NearestMipMapLinearFilter)return N.NEAREST_MIPMAP_LINEAR;if(t===THREE.LinearFilter)return N.LINEAR;if(t===THREE.LinearMipMapNearestFilter)return N.LINEAR_MIPMAP_NEAREST;if(t===THREE.LinearMipMapLinearFilter)return N.LINEAR_MIPMAP_LINEAR;if(t===THREE.UnsignedByteType)return N.UNSIGNED_BYTE;if(t===THREE.UnsignedShort4444Type)return N.UNSIGNED_SHORT_4_4_4_4;if(t===THREE.UnsignedShort5551Type)return N.UNSIGNED_SHORT_5_5_5_1;if(t===THREE.UnsignedShort565Type)return N.UNSIGNED_SHORT_5_6_5;if(t===THREE.ByteType)return N.BYTE;if(t===THREE.ShortType)return N.SHORT;if(t===THREE.UnsignedShortType)return N.UNSIGNED_SHORT;if(t===THREE.IntType)return N.INT;if(t===THREE.UnsignedIntType)return N.UNSIGNED_INT;if(t===THREE.FloatType)return N.FLOAT;if(t===THREE.AlphaFormat)return N.ALPHA;if(t===THREE.RGBFormat)return N.RGB;if(t===THREE.RGBAFormat)return N.RGBA;if(t===THREE.LuminanceFormat)return N.LUMINANCE;if(t===THREE.LuminanceAlphaFormat)return N.LUMINANCE_ALPHA;if(t===THREE.AddEquation)return N.FUNC_ADD;if(t===THREE.SubtractEquation)return N.FUNC_SUBTRACT;if(t===THREE.ReverseSubtractEquation)return N.FUNC_REVERSE_SUBTRACT;if(t===THREE.ZeroFactor)return N.ZERO;if(t===THREE.OneFactor)return N.ONE;if(t===THREE.SrcColorFactor)return N.SRC_COLOR;if(t===THREE.OneMinusSrcColorFactor)return N.ONE_MINUS_SRC_COLOR;if(t===THREE.SrcAlphaFactor)return N.SRC_ALPHA;if(t===THREE.OneMinusSrcAlphaFactor)return N.ONE_MINUS_SRC_ALPHA;if(t===THREE.DstAlphaFactor)return N.DST_ALPHA;if(t===THREE.OneMinusDstAlphaFactor)return N.ONE_MINUS_DST_ALPHA;if(t===THREE.DstColorFactor)return N.DST_COLOR;if(t===THREE.OneMinusDstColorFactor)return N.ONE_MINUS_DST_COLOR;if(t===THREE.SrcAlphaSaturateFactor)return N.SRC_ALPHA_SATURATE;if(void 0!==O){if(t===THREE.RGB_S3TC_DXT1_Format)return O.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===THREE.RGBA_S3TC_DXT1_Format)return O.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===THREE.RGBA_S3TC_DXT3_Format)return O.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===THREE.RGBA_S3TC_DXT5_Format)return O.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}console.log("THREE.WebGLRenderer",THREE.REVISION);var t=t||{},A=void 0!==t.canvas?t.canvas:document.createElement("canvas"),B=void 0!==t.precision?t.precision:"highp",I=void 0===t.alpha||t.alpha,H=void 0===t.premultipliedAlpha||t.premultipliedAlpha,P=void 0!==t.antialias&&t.antialias,L=void 0===t.stencil||t.stencil,V=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,k=void 0!==t.clearColor?new THREE.Color(t.clearColor):new THREE.Color(0),F=void 0!==t.clearAlpha?t.clearAlpha:0,z=void 0!==t.maxLights?t.maxLights:4;this.domElement=A,this.context=null,this.autoUpdateScene=this.autoUpdateObjects=this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0,this.shadowMapEnabled=this.physicallyBasedShading=this.gammaOutput=this.gammaInput=!1,this.shadowMapCullFrontFaces=this.shadowMapSoft=this.shadowMapAutoUpdate=!0,this.shadowMapCascade=this.shadowMapDebug=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var N,U,O,G=this,W=[],j=0,q=null,J=null,X=-1,Y=null,K=null,Z=0,$=0,Q=-1,tt=-1,et=-1,it=-1,ot=-1,nt=-1,rt=-1,st=-1,at=null,ht=null,lt=null,ct=null,ut=0,mt=0,dt=0,pt=0,_t=0,ft=0,yt=new THREE.Frustum,gt=new THREE.Matrix4,vt=new THREE.Matrix4,xt=new THREE.Vector4,bt=new THREE.Vector3,Et=!0,Tt={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],angles:[],exponents:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}};try{if(!(N=A.getContext("experimental-webgl",{alpha:I,premultipliedAlpha:H,antialias:P,stencil:L,preserveDrawingBuffer:V})))throw"Error creating WebGL context."}catch(t){console.error(t)}t=N.getExtension("OES_texture_float"),I=N.getExtension("OES_standard_derivatives"),U=N.getExtension("EXT_texture_filter_anisotropic")||N.getExtension("MOZ_EXT_texture_filter_anisotropic")||N.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),O=N.getExtension("WEBGL_compressed_texture_s3tc")||N.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||N.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),t||console.log("THREE.WebGLRenderer: Float textures not supported."),I||console.log("THREE.WebGLRenderer: Standard derivatives not supported."),U||console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),O||console.log("THREE.WebGLRenderer: S3TC compressed textures not supported."),N.clearColor(0,0,0,1),N.clearDepth(1),N.clearStencil(0),N.enable(N.DEPTH_TEST),N.depthFunc(N.LEQUAL),N.frontFace(N.CCW),N.cullFace(N.BACK),N.enable(N.CULL_FACE),N.enable(N.BLEND),N.blendEquation(N.FUNC_ADD),N.blendFunc(N.SRC_ALPHA,N.ONE_MINUS_SRC_ALPHA),N.clearColor(k.r,k.g,k.b,F),this.context=N;var wt=N.getParameter(N.MAX_TEXTURE_IMAGE_UNITS),I=N.getParameter(N.MAX_VERTEX_TEXTURE_IMAGE_UNITS);N.getParameter(N.MAX_TEXTURE_SIZE);var St=N.getParameter(N.MAX_CUBE_MAP_TEXTURE_SIZE),Ct=U?N.getParameter(U.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Rt=0<I,Mt=Rt&&t;O&&N.getParameter(N.COMPRESSED_TEXTURE_FORMATS),this.getContext=function(){return N},this.supportsVertexTextures=function(){return Rt},this.getMaxAnisotropy=function(){return Ct},this.setSize=function(t,e){A.width=t,A.height=e,this.setViewport(0,0,A.width,A.height)},this.setViewport=function(t,e,i,o){ut=void 0!==t?t:0,mt=void 0!==e?e:0,dt=void 0!==i?i:A.width,pt=void 0!==o?o:A.height,N.viewport(ut,mt,dt,pt)},this.setScissor=function(t,e,i,o){N.scissor(t,e,i,o)},this.enableScissorTest=function(t){t?N.enable(N.SCISSOR_TEST):N.disable(N.SCISSOR_TEST)},this.setClearColorHex=function(t,e){k.setHex(t),F=e,N.clearColor(k.r,k.g,k.b,F)},this.setClearColor=function(t,e){k.copy(t),F=e,N.clearColor(k.r,k.g,k.b,F)},this.getClearColor=function(){return k},this.getClearAlpha=function(){return F},this.clear=function(t,e,i){var o=0;(void 0===t||t)&&(o|=N.COLOR_BUFFER_BIT),(void 0===e||e)&&(o|=N.DEPTH_BUFFER_BIT),(void 0===i||i)&&(o|=N.STENCIL_BUFFER_BIT),N.clear(o)},this.clearTarget=function(t,e,i,o){this.setRenderTarget(t),this.clear(e,i,o)},this.addPostPlugin=function(t){t.init(this),this.renderPluginsPost.push(t)},this.addPrePlugin=function(t){t.init(this),this.renderPluginsPre.push(t)},this.deallocateObject=function(t){if(t.__webglInit)if(t.__webglInit=!1,delete t._modelViewMatrix,delete t._normalMatrix,delete t._normalMatrixArray,delete t._modelViewMatrixArray,delete t._modelMatrixArray,t instanceof THREE.Mesh)for(var e in t.geometry.geometryGroups){var i=t.geometry.geometryGroups[e];N.deleteBuffer(i.__webglVertexBuffer),N.deleteBuffer(i.__webglNormalBuffer),N.deleteBuffer(i.__webglTangentBuffer),N.deleteBuffer(i.__webglColorBuffer),N.deleteBuffer(i.__webglUVBuffer),N.deleteBuffer(i.__webglUV2Buffer),N.deleteBuffer(i.__webglSkinIndicesBuffer),N.deleteBuffer(i.__webglSkinWeightsBuffer),N.deleteBuffer(i.__webglFaceBuffer),N.deleteBuffer(i.__webglLineBuffer);var o=void 0,n=void 0;if(i.numMorphTargets)for(o=0,n=i.numMorphTargets;o<n;o++)N.deleteBuffer(i.__webglMorphTargetsBuffers[o]);if(i.numMorphNormals)for(o=0,n=i.numMorphNormals;o<n;o++)N.deleteBuffer(i.__webglMorphNormalsBuffers[o]);if(i.__webglCustomAttributesList)for(o in o=void 0,i.__webglCustomAttributesList)N.deleteBuffer(i.__webglCustomAttributesList[o].buffer);G.info.memory.geometries--}else t instanceof THREE.Ribbon?(t=t.geometry,N.deleteBuffer(t.__webglVertexBuffer),N.deleteBuffer(t.__webglColorBuffer),G.info.memory.geometries--):t instanceof THREE.Line?(t=t.geometry,N.deleteBuffer(t.__webglVertexBuffer),N.deleteBuffer(t.__webglColorBuffer),G.info.memory.geometries--):t instanceof THREE.ParticleSystem&&(t=t.geometry,N.deleteBuffer(t.__webglVertexBuffer),N.deleteBuffer(t.__webglColorBuffer),G.info.memory.geometries--)},this.deallocateTexture=function(t){t.__webglInit&&(t.__webglInit=!1,N.deleteTexture(t.__webglTexture),G.info.memory.textures--)},this.deallocateRenderTarget=function(t){if(t&&t.__webglTexture)if(N.deleteTexture(t.__webglTexture),t instanceof THREE.WebGLRenderTargetCube)for(var e=0;6>e;e++)N.deleteFramebuffer(t.__webglFramebuffer[e]),N.deleteRenderbuffer(t.__webglRenderbuffer[e]);else N.deleteFramebuffer(t.__webglFramebuffer),N.deleteRenderbuffer(t.__webglRenderbuffer)},this.deallocateMaterial=function(t){var e=t.program;if(e){t.program=void 0;var i,o,n=!1,t=0;for(i=W.length;t<i;t++)if(o=W[t],o.program===e){o.usedTimes--,0===o.usedTimes&&(n=!0);break}if(n){for(n=[],t=0,i=W.length;t<i;t++)o=W[t],o.program!==e&&n.push(o);W=n,N.deleteProgram(e),G.info.memory.programs--}}},this.updateShadowMap=function(t,e){q=null,X=Y=st=rt=et=-1,Et=!0,tt=Q=-1,this.shadowMapPlugin.update(t,e)},this.renderBufferImmediate=function(t,e,i){if(t.hasPositions&&!t.__webglVertexBuffer&&(t.__webglVertexBuffer=N.createBuffer()),t.hasNormals&&!t.__webglNormalBuffer&&(t.__webglNormalBuffer=N.createBuffer()),t.hasUvs&&!t.__webglUvBuffer&&(t.__webglUvBuffer=N.createBuffer()),t.hasColors&&!t.__webglColorBuffer&&(t.__webglColorBuffer=N.createBuffer()),t.hasPositions&&(N.bindBuffer(N.ARRAY_BUFFER,t.__webglVertexBuffer),N.bufferData(N.ARRAY_BUFFER,t.positionArray,N.DYNAMIC_DRAW),N.enableVertexAttribArray(e.attributes.position),N.vertexAttribPointer(e.attributes.position,3,N.FLOAT,!1,0,0)),t.hasNormals){if(N.bindBuffer(N.ARRAY_BUFFER,t.__webglNormalBuffer),i.shading===THREE.FlatShading){var o,n,r,s,a,h,l,c,u,m,d,p=3*t.count;for(d=0;d<p;d+=9)m=t.normalArray,o=m[d],n=m[d+1],r=m[d+2],s=m[d+3],h=m[d+4],c=m[d+5],a=m[d+6],l=m[d+7],u=m[d+8],o=(o+s+a)/3,n=(n+h+l)/3,r=(r+c+u)/3,m[d]=o,m[d+1]=n,m[d+2]=r,m[d+3]=o,m[d+4]=n,m[d+5]=r,m[d+6]=o,m[d+7]=n,m[d+8]=r}N.bufferData(N.ARRAY_BUFFER,t.normalArray,N.DYNAMIC_DRAW),N.enableVertexAttribArray(e.attributes.normal),N.vertexAttribPointer(e.attributes.normal,3,N.FLOAT,!1,0,0)}t.hasUvs&&i.map&&(N.bindBuffer(N.ARRAY_BUFFER,t.__webglUvBuffer),N.bufferData(N.ARRAY_BUFFER,t.uvArray,N.DYNAMIC_DRAW),N.enableVertexAttribArray(e.attributes.uv),N.vertexAttribPointer(e.attributes.uv,2,N.FLOAT,!1,0,0)),t.hasColors&&i.vertexColors!==THREE.NoColors&&(N.bindBuffer(N.ARRAY_BUFFER,t.__webglColorBuffer),N.bufferData(N.ARRAY_BUFFER,t.colorArray,N.DYNAMIC_DRAW),N.enableVertexAttribArray(e.attributes.color),N.vertexAttribPointer(e.attributes.color,3,N.FLOAT,!1,0,0)),N.drawArrays(N.TRIANGLES,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,o,n,r){if(!1!==o.visible)if(i=g(t,e,i,o,r),t=i.attributes,e=!1,o=16777215*n.id+2*i.id+(o.wireframe?1:0),o!==Y&&(Y=o,e=!0),r instanceof THREE.Mesh)for(r=n.offsets,1<r.length&&(e=!0),o=0,i=r.length;o<i;++o){var s=r[o].index;if(e){var a=n.attributes.position,h=a.itemSize;if(N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.vertexAttribPointer(t.position,h,N.FLOAT,!1,0,4*s*h),a=n.attributes.normal,0<=t.normal&&a&&(h=a.itemSize,N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.vertexAttribPointer(t.normal,h,N.FLOAT,!1,0,4*s*h)),a=n.attributes.uv,0<=t.uv&&a&&(a.buffer?(h=a.itemSize,N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.vertexAttribPointer(t.uv,h,N.FLOAT,!1,0,4*s*h),N.enableVertexAttribArray(t.uv)):N.disableVertexAttribArray(t.uv)),h=n.attributes.color,0<=t.color&&h){var l=h.itemSize;N.bindBuffer(N.ARRAY_BUFFER,h.buffer),N.vertexAttribPointer(t.color,l,N.FLOAT,!1,0,4*s*l)}a=n.attributes.tangent,0<=t.tangent&&a&&(h=a.itemSize,N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.vertexAttribPointer(t.tangent,h,N.FLOAT,!1,0,4*s*h)),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,n.attributes.index.buffer)}N.drawElements(N.TRIANGLES,r[o].count,N.UNSIGNED_SHORT,2*r[o].start),G.info.render.calls++,G.info.render.vertices+=r[o].count,G.info.render.faces+=r[o].count/3}else r instanceof THREE.ParticleSystem&&e&&(a=n.attributes.position,h=a.itemSize,N.bindBuffer(N.ARRAY_BUFFER,a.buffer),N.vertexAttribPointer(t.position,h,N.FLOAT,!1,0,0),h=n.attributes.color,0<=t.color&&h&&(l=h.itemSize,N.bindBuffer(N.ARRAY_BUFFER,h.buffer),N.vertexAttribPointer(t.color,l,N.FLOAT,!1,0,0)),N.drawArrays(N.POINTS,0,a.numItems/3),G.info.render.calls++,G.info.render.points+=a.numItems/3)},this.renderBuffer=function(t,e,i,o,n,r){if(!1!==o.visible){var s,a,i=g(t,e,i,o,r),e=i.attributes,t=!1,i=16777215*n.id+2*i.id+(o.wireframe?1:0);if(i!==Y&&(Y=i,t=!0),!o.morphTargets&&0<=e.position)t&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglVertexBuffer),N.vertexAttribPointer(e.position,3,N.FLOAT,!1,0,0));else if(r.morphTargetBase){if(i=o.program.attributes,-1!==r.morphTargetBase?(N.bindBuffer(N.ARRAY_BUFFER,n.__webglMorphTargetsBuffers[r.morphTargetBase]),N.vertexAttribPointer(i.position,3,N.FLOAT,!1,0,0)):0<=i.position&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglVertexBuffer),N.vertexAttribPointer(i.position,3,N.FLOAT,!1,0,0)),r.morphTargetForcedOrder.length){var h=0;for(a=r.morphTargetForcedOrder,s=r.morphTargetInfluences;h<o.numSupportedMorphTargets&&h<a.length;)N.bindBuffer(N.ARRAY_BUFFER,n.__webglMorphTargetsBuffers[a[h]]),N.vertexAttribPointer(i["morphTarget"+h],3,N.FLOAT,!1,0,0),o.morphNormals&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglMorphNormalsBuffers[a[h]]),N.vertexAttribPointer(i["morphNormal"+h],3,N.FLOAT,!1,0,0)),r.__webglMorphTargetInfluences[h]=s[a[h]],h++}else{a=[],s=r.morphTargetInfluences;var c,u=s.length;for(c=0;c<u;c++)0<(h=s[c])&&a.push([c,h]);for(a.length>o.numSupportedMorphTargets?(a.sort(l),a.length=o.numSupportedMorphTargets):a.length>o.numSupportedMorphNormals?a.sort(l):0===a.length&&a.push([0,0]),h=0;h<o.numSupportedMorphTargets;)a[h]?(c=a[h][0],N.bindBuffer(N.ARRAY_BUFFER,n.__webglMorphTargetsBuffers[c]),N.vertexAttribPointer(i["morphTarget"+h],3,N.FLOAT,!1,0,0),o.morphNormals&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglMorphNormalsBuffers[c]),N.vertexAttribPointer(i["morphNormal"+h],3,N.FLOAT,!1,0,0)),r.__webglMorphTargetInfluences[h]=s[c]):(N.vertexAttribPointer(i["morphTarget"+h],3,N.FLOAT,!1,0,0),o.morphNormals&&N.vertexAttribPointer(i["morphNormal"+h],3,N.FLOAT,!1,0,0),r.__webglMorphTargetInfluences[h]=0),h++}null!==o.program.uniforms.morphTargetInfluences&&N.uniform1fv(o.program.uniforms.morphTargetInfluences,r.__webglMorphTargetInfluences)}if(t){if(n.__webglCustomAttributesList)for(s=0,a=n.__webglCustomAttributesList.length;s<a;s++)i=n.__webglCustomAttributesList[s],0<=e[i.buffer.belongsToAttribute]&&(N.bindBuffer(N.ARRAY_BUFFER,i.buffer),N.vertexAttribPointer(e[i.buffer.belongsToAttribute],i.size,N.FLOAT,!1,0,0));0<=e.color&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglColorBuffer),N.vertexAttribPointer(e.color,3,N.FLOAT,!1,0,0)),0<=e.normal&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglNormalBuffer),N.vertexAttribPointer(e.normal,3,N.FLOAT,!1,0,0)),0<=e.tangent&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglTangentBuffer),N.vertexAttribPointer(e.tangent,4,N.FLOAT,!1,0,0)),0<=e.uv&&(n.__webglUVBuffer?(N.bindBuffer(N.ARRAY_BUFFER,n.__webglUVBuffer),N.vertexAttribPointer(e.uv,2,N.FLOAT,!1,0,0),N.enableVertexAttribArray(e.uv)):N.disableVertexAttribArray(e.uv)),0<=e.uv2&&(n.__webglUV2Buffer?(N.bindBuffer(N.ARRAY_BUFFER,n.__webglUV2Buffer),N.vertexAttribPointer(e.uv2,2,N.FLOAT,!1,0,0),N.enableVertexAttribArray(e.uv2)):N.disableVertexAttribArray(e.uv2)),o.skinning&&0<=e.skinIndex&&0<=e.skinWeight&&(N.bindBuffer(N.ARRAY_BUFFER,n.__webglSkinIndicesBuffer),N.vertexAttribPointer(e.skinIndex,4,N.FLOAT,!1,0,0),N.bindBuffer(N.ARRAY_BUFFER,n.__webglSkinWeightsBuffer),N.vertexAttribPointer(e.skinWeight,4,N.FLOAT,!1,0,0))}r instanceof THREE.Mesh?(o.wireframe?(o=o.wireframeLinewidth,o!==ct&&(N.lineWidth(o),ct=o),t&&N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,n.__webglLineBuffer),N.drawElements(N.LINES,n.__webglLineCount,N.UNSIGNED_SHORT,0)):(t&&N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,n.__webglFaceBuffer),N.drawElements(N.TRIANGLES,n.__webglFaceCount,N.UNSIGNED_SHORT,0)),G.info.render.calls++,G.info.render.vertices+=n.__webglFaceCount,G.info.render.faces+=n.__webglFaceCount/3):r instanceof THREE.Line?(r=r.type===THREE.LineStrip?N.LINE_STRIP:N.LINES,o=o.linewidth,o!==ct&&(N.lineWidth(o),ct=o),N.drawArrays(r,0,n.__webglLineCount),G.info.render.calls++):r instanceof THREE.ParticleSystem?(N.drawArrays(N.POINTS,0,n.__webglParticleCount),G.info.render.calls++,G.info.render.points+=n.__webglParticleCount):r instanceof THREE.Ribbon&&(N.drawArrays(N.TRIANGLE_STRIP,0,n.__webglVertexCount),G.info.render.calls++)}},this.render=function(t,e,i,o){if(!1==e instanceof THREE.Camera)console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");else{var n,r,s,a,l=t.__lights,d=t.fog;for(X=-1,Et=!0,this.autoUpdateScene&&t.updateMatrixWorld(),void 0===e.parent&&e.updateMatrixWorld(),e._viewMatrixArray||(e._viewMatrixArray=new Float32Array(16)),e._projectionMatrixArray||(e._projectionMatrixArray=new Float32Array(16)),e.matrixWorldInverse.getInverse(e.matrixWorld),e.matrixWorldInverse.flattenToArray(e._viewMatrixArray),e.projectionMatrix.flattenToArray(e._projectionMatrixArray),gt.multiply(e.projectionMatrix,e.matrixWorldInverse),yt.setFromMatrix(gt),this.autoUpdateObjects&&this.initWebGLObjects(t),c(this.renderPluginsPre,t,e),G.info.render.calls=0,G.info.render.vertices=0,G.info.render.faces=0,G.info.render.points=0,this.setRenderTarget(i),(this.autoClear||o)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),a=t.__webglObjects,o=0,n=a.length;o<n;o++)if(r=a[o],s=r.object,r.render=!1,s.visible&&(!(s instanceof THREE.Mesh||s instanceof THREE.ParticleSystem)||!s.frustumCulled||yt.contains(s))){x(s,e);var p=r,_=p.object,f=p.buffer,y=void 0,y=y=void 0,y=_.material;y instanceof THREE.MeshFaceMaterial?0<=(y=f.materialIndex)&&(y=_.geometry.materials[y],y.transparent?(p.transparent=y,p.opaque=null):(p.opaque=y,p.transparent=null)):y&&(y.transparent?(p.transparent=y,p.opaque=null):(p.opaque=y,p.transparent=null)),r.render=!0,!0===this.sortObjects&&(null!==s.renderDepth?r.z=s.renderDepth:(xt.copy(s.matrixWorld.getPosition()),gt.multiplyVector3(xt),r.z=xt.z))}for(this.sortObjects&&a.sort(h),a=t.__webglObjectsImmediate,o=0,n=a.length;o<n;o++)r=a[o],s=r.object,s.visible&&(x(s,e),s=r.object.material,s.transparent?(r.transparent=s,r.opaque=null):(r.opaque=s,r.transparent=null));t.overrideMaterial?(o=t.overrideMaterial,this.setBlending(o.blending,o.blendEquation,o.blendSrc,o.blendDst),this.setDepthTest(o.depthTest),this.setDepthWrite(o.depthWrite),T(o.polygonOffset,o.polygonOffsetFactor,o.polygonOffsetUnits),u(t.__webglObjects,!1,"",e,l,d,!0,o),m(t.__webglObjectsImmediate,"",e,l,d,!1,o)):(this.setBlending(THREE.NormalBlending),u(t.__webglObjects,!0,"opaque",e,l,d,!1),m(t.__webglObjectsImmediate,"opaque",e,l,d,!1),u(t.__webglObjects,!1,"transparent",e,l,d,!0),m(t.__webglObjectsImmediate,"transparent",e,l,d,!0)),c(this.renderPluginsPost,t,e),i&&i.generateMipmaps&&i.minFilter!==THREE.NearestFilter&&i.minFilter!==THREE.LinearFilter&&(i instanceof THREE.WebGLRenderTargetCube?(N.bindTexture(N.TEXTURE_CUBE_MAP,i.__webglTexture),N.generateMipmap(N.TEXTURE_CUBE_MAP),N.bindTexture(N.TEXTURE_CUBE_MAP,null)):(N.bindTexture(N.TEXTURE_2D,i.__webglTexture),N.generateMipmap(N.TEXTURE_2D),N.bindTexture(N.TEXTURE_2D,null))),this.setDepthTest(!0),this.setDepthWrite(!0)}},this.renderImmediateObject=function(t,e,i,o,n){var r=g(t,e,i,o,n);Y=-1,G.setMaterialFaces(o),n.immediateRenderCallback?n.immediateRenderCallback(r,N,yt):n.render(function(t){G.renderBufferImmediate(t,r,o)})},this.initWebGLObjects=function(t){for(t.__webglObjects||(t.__webglObjects=[],
t.__webglObjectsImmediate=[],t.__webglSprites=[],t.__webglFlares=[]);t.__objectsAdded.length;){var h=t.__objectsAdded[0],l=t,c=void 0,u=void 0,m=void 0;if(!h.__webglInit)if(h.__webglInit=!0,h._modelViewMatrix=new THREE.Matrix4,h._normalMatrix=new THREE.Matrix3,h instanceof THREE.Mesh)if((u=h.geometry)instanceof THREE.Geometry){if(void 0===u.geometryGroups){var g=u,v=void 0,x=void 0,b=void 0,E=void 0,T=void 0,w=void 0,S=void 0,C={},R=g.morphTargets.length,M=g.morphNormals.length;for(g.geometryGroups={},v=0,x=g.faces.length;v<x;v++)b=g.faces[v],E=b.materialIndex,w=void 0!==E?E:-1,void 0===C[w]&&(C[w]={hash:w,counter:0}),S=C[w].hash+"_"+C[w].counter,void 0===g.geometryGroups[S]&&(g.geometryGroups[S]={faces3:[],faces4:[],materialIndex:E,vertices:0,numMorphTargets:R,numMorphNormals:M}),T=b instanceof THREE.Face3?3:4,65535<g.geometryGroups[S].vertices+T&&(C[w].counter+=1,S=C[w].hash+"_"+C[w].counter,void 0===g.geometryGroups[S]&&(g.geometryGroups[S]={faces3:[],faces4:[],materialIndex:E,vertices:0,numMorphTargets:R,numMorphNormals:M})),b instanceof THREE.Face3?g.geometryGroups[S].faces3.push(v):g.geometryGroups[S].faces4.push(v),g.geometryGroups[S].vertices+=T;g.geometryGroupsList=[];var D=void 0;for(D in g.geometryGroups)g.geometryGroups[D].id=Z++,g.geometryGroupsList.push(g.geometryGroups[D])}for(c in u.geometryGroups)if(m=u.geometryGroups[c],!m.__webglVertexBuffer){var A=m;A.__webglVertexBuffer=N.createBuffer(),A.__webglNormalBuffer=N.createBuffer(),A.__webglTangentBuffer=N.createBuffer(),A.__webglColorBuffer=N.createBuffer(),A.__webglUVBuffer=N.createBuffer(),A.__webglUV2Buffer=N.createBuffer(),A.__webglSkinIndicesBuffer=N.createBuffer(),A.__webglSkinWeightsBuffer=N.createBuffer(),A.__webglFaceBuffer=N.createBuffer(),A.__webglLineBuffer=N.createBuffer();var B=void 0,I=void 0;if(A.numMorphTargets)for(A.__webglMorphTargetsBuffers=[],B=0,I=A.numMorphTargets;B<I;B++)A.__webglMorphTargetsBuffers.push(N.createBuffer());if(A.numMorphNormals)for(A.__webglMorphNormalsBuffers=[],B=0,I=A.numMorphNormals;B<I;B++)A.__webglMorphNormalsBuffers.push(N.createBuffer());G.info.memory.geometries++;var H=m,P=h,L=P.geometry,V=H.faces3,k=H.faces4,F=3*V.length+4*k.length,z=1*V.length+2*k.length,U=3*V.length+4*k.length,O=i(P,H),W=n(O),j=o(O),q=!!O.vertexColors&&O.vertexColors;H.__vertexArray=new Float32Array(3*F),j&&(H.__normalArray=new Float32Array(3*F)),L.hasTangents&&(H.__tangentArray=new Float32Array(4*F)),q&&(H.__colorArray=new Float32Array(3*F)),W&&((0<L.faceUvs.length||0<L.faceVertexUvs.length)&&(H.__uvArray=new Float32Array(2*F)),(1<L.faceUvs.length||1<L.faceVertexUvs.length)&&(H.__uv2Array=new Float32Array(2*F))),P.geometry.skinWeights.length&&P.geometry.skinIndices.length&&(H.__skinIndexArray=new Float32Array(4*F),H.__skinWeightArray=new Float32Array(4*F)),H.__faceArray=new Uint16Array(3*z),H.__lineArray=new Uint16Array(2*U);var J=void 0,X=void 0;if(H.numMorphTargets)for(H.__morphTargetsArrays=[],J=0,X=H.numMorphTargets;J<X;J++)H.__morphTargetsArrays.push(new Float32Array(3*F));if(H.numMorphNormals)for(H.__morphNormalsArrays=[],J=0,X=H.numMorphNormals;J<X;J++)H.__morphNormalsArrays.push(new Float32Array(3*F));if(H.__webglFaceCount=3*z,H.__webglLineCount=2*U,O.attributes){void 0===H.__webglCustomAttributesList&&(H.__webglCustomAttributesList=[]);var Y=void 0;for(Y in O.attributes){var K,$=O.attributes[Y],Q={};for(K in $)Q[K]=$[K];if(!Q.__webglInitialized||Q.createUniqueBuffers){Q.__webglInitialized=!0;var tt=1;"v2"===Q.type?tt=2:"v3"===Q.type?tt=3:"v4"===Q.type?tt=4:"c"===Q.type&&(tt=3),Q.size=tt,Q.array=new Float32Array(F*tt),Q.buffer=N.createBuffer(),Q.buffer.belongsToAttribute=Y,$.needsUpdate=!0,Q.__original=$}H.__webglCustomAttributesList.push(Q)}}H.__inittedArrays=!0,u.verticesNeedUpdate=!0,u.morphTargetsNeedUpdate=!0,u.elementsNeedUpdate=!0,u.uvsNeedUpdate=!0,u.normalsNeedUpdate=!0,u.tangentsNeedUpdate=!0,u.colorsNeedUpdate=!0}}else u instanceof THREE.BufferGeometry&&r(u);else if(h instanceof THREE.Ribbon){if(u=h.geometry,!u.__webglVertexBuffer){var et=u;et.__webglVertexBuffer=N.createBuffer(),et.__webglColorBuffer=N.createBuffer(),G.info.memory.geometries++;var it=u,ot=it.vertices.length;it.__vertexArray=new Float32Array(3*ot),it.__colorArray=new Float32Array(3*ot),it.__webglVertexCount=ot,u.verticesNeedUpdate=!0,u.colorsNeedUpdate=!0}}else if(h instanceof THREE.Line){if(u=h.geometry,!u.__webglVertexBuffer){var nt=u;nt.__webglVertexBuffer=N.createBuffer(),nt.__webglColorBuffer=N.createBuffer(),G.info.memory.geometries++;var rt=u,st=h,at=rt.vertices.length;rt.__vertexArray=new Float32Array(3*at),rt.__colorArray=new Float32Array(3*at),rt.__webglLineCount=at,e(rt,st),u.verticesNeedUpdate=!0,u.colorsNeedUpdate=!0}}else if(h instanceof THREE.ParticleSystem&&(u=h.geometry,!u.__webglVertexBuffer))if(u instanceof THREE.Geometry){var ht=u;ht.__webglVertexBuffer=N.createBuffer(),ht.__webglColorBuffer=N.createBuffer(),G.info.memory.geometries++;var lt=u,ct=h,ut=lt.vertices.length;lt.__vertexArray=new Float32Array(3*ut),lt.__colorArray=new Float32Array(3*ut),lt.__sortArray=[],lt.__webglParticleCount=ut,e(lt,ct),u.verticesNeedUpdate=!0,u.colorsNeedUpdate=!0}else u instanceof THREE.BufferGeometry&&r(u);if(!h.__webglActive){if(h instanceof THREE.Mesh)if((u=h.geometry)instanceof THREE.BufferGeometry)d(l.__webglObjects,u,h);else for(c in u.geometryGroups)m=u.geometryGroups[c],d(l.__webglObjects,m,h);else h instanceof THREE.Ribbon||h instanceof THREE.Line||h instanceof THREE.ParticleSystem?(u=h.geometry,d(l.__webglObjects,u,h)):h instanceof THREE.ImmediateRenderObject||h.immediateRenderCallback?l.__webglObjectsImmediate.push({object:h,opaque:null,transparent:null}):h instanceof THREE.Sprite?l.__webglSprites.push(h):h instanceof THREE.LensFlare&&l.__webglFlares.push(h);h.__webglActive=!0}t.__objectsAdded.splice(0,1)}for(;t.__objectsRemoved.length;){var mt=t.__objectsRemoved[0],dt=t;mt instanceof THREE.Mesh||mt instanceof THREE.ParticleSystem||mt instanceof THREE.Ribbon||mt instanceof THREE.Line?f(dt.__webglObjects,mt):mt instanceof THREE.Sprite?y(dt.__webglSprites,mt):mt instanceof THREE.LensFlare?y(dt.__webglFlares,mt):(mt instanceof THREE.ImmediateRenderObject||mt.immediateRenderCallback)&&f(dt.__webglObjectsImmediate,mt),mt.__webglActive=!1,t.__objectsRemoved.splice(0,1)}for(var pt=0,_t=t.__webglObjects.length;pt<_t;pt++){var ft=t.__webglObjects[pt].object,yt=ft.geometry,gt=void 0,vt=void 0,xt=void 0;if(ft instanceof THREE.Mesh)if(yt instanceof THREE.BufferGeometry)(yt.verticesNeedUpdate||yt.elementsNeedUpdate||yt.uvsNeedUpdate||yt.normalsNeedUpdate||yt.colorsNeedUpdate||yt.tangentsNeedUpdate)&&a(yt,N.DYNAMIC_DRAW,!yt.dynamic),yt.verticesNeedUpdate=!1,yt.elementsNeedUpdate=!1,yt.uvsNeedUpdate=!1,yt.normalsNeedUpdate=!1,yt.colorsNeedUpdate=!1,yt.tangentsNeedUpdate=!1;else{for(var bt=0,Et=yt.geometryGroupsList.length;bt<Et;bt++)if(gt=yt.geometryGroupsList[bt],xt=i(ft,gt),vt=xt.attributes&&p(xt),yt.verticesNeedUpdate||yt.morphTargetsNeedUpdate||yt.elementsNeedUpdate||yt.uvsNeedUpdate||yt.normalsNeedUpdate||yt.colorsNeedUpdate||yt.tangentsNeedUpdate||vt){var Tt=gt,wt=ft,St=N.DYNAMIC_DRAW,Ct=!yt.dynamic,Rt=xt;if(Tt.__inittedArrays){var Mt=o(Rt),Dt=!!Rt.vertexColors&&Rt.vertexColors,At=n(Rt),Bt=Mt===THREE.SmoothShading,It=void 0,Ht=void 0,Pt=void 0,Lt=void 0,Vt=void 0,kt=void 0,Ft=void 0,zt=void 0,Nt=void 0,Ut=void 0,Ot=void 0,Gt=void 0,Wt=void 0,jt=void 0,qt=void 0,Jt=void 0,Xt=void 0,Yt=void 0,Kt=void 0,Zt=void 0,$t=void 0,Qt=void 0,te=void 0,ee=void 0,ie=void 0,oe=void 0,ne=void 0,re=void 0,se=void 0,ae=void 0,he=void 0,le=void 0,ce=void 0,ue=void 0,me=void 0,de=void 0,pe=void 0,_e=void 0,fe=void 0,ye=void 0,ge=void 0,ve=void 0,xe=void 0,be=void 0,Ee=void 0,Te=void 0,we=0,Se=0,Ce=0,Re=0,Me=0,De=0,Ae=0,Be=0,Ie=0,He=0,Pe=0,Le=0,Ve=void 0,ke=Tt.__vertexArray,Fe=Tt.__uvArray,ze=Tt.__uv2Array,Ne=Tt.__normalArray,Ue=Tt.__tangentArray,Oe=Tt.__colorArray,Ge=Tt.__skinIndexArray,We=Tt.__skinWeightArray,je=Tt.__morphTargetsArrays,qe=Tt.__morphNormalsArrays,Je=Tt.__webglCustomAttributesList,Xe=void 0,Ye=Tt.__faceArray,Ke=Tt.__lineArray,Ze=wt.geometry,$e=Ze.elementsNeedUpdate,Qe=Ze.uvsNeedUpdate,ti=Ze.normalsNeedUpdate,ei=Ze.tangentsNeedUpdate,ii=Ze.colorsNeedUpdate,oi=Ze.morphTargetsNeedUpdate,ni=Ze.vertices,ri=Tt.faces3,si=Tt.faces4,ai=Ze.faces,hi=Ze.faceVertexUvs[0],li=Ze.faceVertexUvs[1],ci=Ze.skinIndices,ui=Ze.skinWeights,mi=Ze.morphTargets,di=Ze.morphNormals;if(Ze.verticesNeedUpdate){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Gt=ni[Lt.a],Wt=ni[Lt.b],jt=ni[Lt.c],ke[Se]=Gt.x,ke[Se+1]=Gt.y,ke[Se+2]=Gt.z,ke[Se+3]=Wt.x,ke[Se+4]=Wt.y,ke[Se+5]=Wt.z,ke[Se+6]=jt.x,ke[Se+7]=jt.y,ke[Se+8]=jt.z,Se+=9;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Gt=ni[Lt.a],Wt=ni[Lt.b],jt=ni[Lt.c],qt=ni[Lt.d],ke[Se]=Gt.x,ke[Se+1]=Gt.y,ke[Se+2]=Gt.z,ke[Se+3]=Wt.x,ke[Se+4]=Wt.y,ke[Se+5]=Wt.z,ke[Se+6]=jt.x,ke[Se+7]=jt.y,ke[Se+8]=jt.z,ke[Se+9]=qt.x,ke[Se+10]=qt.y,ke[Se+11]=qt.z,Se+=12;N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglVertexBuffer),N.bufferData(N.ARRAY_BUFFER,ke,St)}if(oi)for(ge=0,ve=mi.length;ge<ve;ge++){for(It=Pe=0,Ht=ri.length;It<Ht;It++)Ee=ri[It],Lt=ai[Ee],Gt=mi[ge].vertices[Lt.a],Wt=mi[ge].vertices[Lt.b],jt=mi[ge].vertices[Lt.c],xe=je[ge],xe[Pe]=Gt.x,xe[Pe+1]=Gt.y,xe[Pe+2]=Gt.z,xe[Pe+3]=Wt.x,xe[Pe+4]=Wt.y,xe[Pe+5]=Wt.z,xe[Pe+6]=jt.x,xe[Pe+7]=jt.y,xe[Pe+8]=jt.z,Rt.morphNormals&&(Bt?(Te=di[ge].vertexNormals[Ee],Zt=Te.a,$t=Te.b,Qt=Te.c):Qt=$t=Zt=di[ge].faceNormals[Ee],be=qe[ge],be[Pe]=Zt.x,be[Pe+1]=Zt.y,be[Pe+2]=Zt.z,be[Pe+3]=$t.x,be[Pe+4]=$t.y,be[Pe+5]=$t.z,be[Pe+6]=Qt.x,be[Pe+7]=Qt.y,be[Pe+8]=Qt.z),Pe+=9;for(It=0,Ht=si.length;It<Ht;It++)Ee=si[It],Lt=ai[Ee],Gt=mi[ge].vertices[Lt.a],Wt=mi[ge].vertices[Lt.b],jt=mi[ge].vertices[Lt.c],qt=mi[ge].vertices[Lt.d],xe=je[ge],xe[Pe]=Gt.x,xe[Pe+1]=Gt.y,xe[Pe+2]=Gt.z,xe[Pe+3]=Wt.x,xe[Pe+4]=Wt.y,xe[Pe+5]=Wt.z,xe[Pe+6]=jt.x,xe[Pe+7]=jt.y,xe[Pe+8]=jt.z,xe[Pe+9]=qt.x,xe[Pe+10]=qt.y,xe[Pe+11]=qt.z,Rt.morphNormals&&(Bt?(Te=di[ge].vertexNormals[Ee],Zt=Te.a,$t=Te.b,Qt=Te.c,te=Te.d):te=Qt=$t=Zt=di[ge].faceNormals[Ee],be=qe[ge],be[Pe]=Zt.x,be[Pe+1]=Zt.y,be[Pe+2]=Zt.z,be[Pe+3]=$t.x,be[Pe+4]=$t.y,be[Pe+5]=$t.z,be[Pe+6]=Qt.x,be[Pe+7]=Qt.y,be[Pe+8]=Qt.z,be[Pe+9]=te.x,be[Pe+10]=te.y,be[Pe+11]=te.z),Pe+=12;N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglMorphTargetsBuffers[ge]),N.bufferData(N.ARRAY_BUFFER,je[ge],St),Rt.morphNormals&&(N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglMorphNormalsBuffers[ge]),N.bufferData(N.ARRAY_BUFFER,qe[ge],St))}if(ui.length){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],re=ui[Lt.a],se=ui[Lt.b],ae=ui[Lt.c],We[He]=re.x,We[He+1]=re.y,We[He+2]=re.z,We[He+3]=re.w,We[He+4]=se.x,We[He+5]=se.y,We[He+6]=se.z,We[He+7]=se.w,We[He+8]=ae.x,We[He+9]=ae.y,We[He+10]=ae.z,We[He+11]=ae.w,le=ci[Lt.a],ce=ci[Lt.b],ue=ci[Lt.c],Ge[He]=le.x,Ge[He+1]=le.y,Ge[He+2]=le.z,Ge[He+3]=le.w,Ge[He+4]=ce.x,Ge[He+5]=ce.y,Ge[He+6]=ce.z,Ge[He+7]=ce.w,Ge[He+8]=ue.x,Ge[He+9]=ue.y,Ge[He+10]=ue.z,Ge[He+11]=ue.w,He+=12;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],re=ui[Lt.a],se=ui[Lt.b],ae=ui[Lt.c],he=ui[Lt.d],We[He]=re.x,We[He+1]=re.y,We[He+2]=re.z,We[He+3]=re.w,We[He+4]=se.x,We[He+5]=se.y,We[He+6]=se.z,We[He+7]=se.w,We[He+8]=ae.x,We[He+9]=ae.y,We[He+10]=ae.z,We[He+11]=ae.w,We[He+12]=he.x,We[He+13]=he.y,We[He+14]=he.z,We[He+15]=he.w,le=ci[Lt.a],ce=ci[Lt.b],ue=ci[Lt.c],me=ci[Lt.d],Ge[He]=le.x,Ge[He+1]=le.y,Ge[He+2]=le.z,Ge[He+3]=le.w,Ge[He+4]=ce.x,Ge[He+5]=ce.y,Ge[He+6]=ce.z,Ge[He+7]=ce.w,Ge[He+8]=ue.x,Ge[He+9]=ue.y,Ge[He+10]=ue.z,Ge[He+11]=ue.w,Ge[He+12]=me.x,Ge[He+13]=me.y,Ge[He+14]=me.z,Ge[He+15]=me.w,He+=16;0<He&&(N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglSkinIndicesBuffer),N.bufferData(N.ARRAY_BUFFER,Ge,St),N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglSkinWeightsBuffer),N.bufferData(N.ARRAY_BUFFER,We,St))}if(ii&&Dt){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Ft=Lt.vertexColors,zt=Lt.color,3===Ft.length&&Dt===THREE.VertexColors?(ee=Ft[0],ie=Ft[1],oe=Ft[2]):oe=ie=ee=zt,Oe[Ie]=ee.r,Oe[Ie+1]=ee.g,Oe[Ie+2]=ee.b,Oe[Ie+3]=ie.r,Oe[Ie+4]=ie.g,Oe[Ie+5]=ie.b,Oe[Ie+6]=oe.r,Oe[Ie+7]=oe.g,Oe[Ie+8]=oe.b,Ie+=9;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Ft=Lt.vertexColors,zt=Lt.color,4===Ft.length&&Dt===THREE.VertexColors?(ee=Ft[0],ie=Ft[1],oe=Ft[2],ne=Ft[3]):ne=oe=ie=ee=zt,Oe[Ie]=ee.r,Oe[Ie+1]=ee.g,Oe[Ie+2]=ee.b,Oe[Ie+3]=ie.r,Oe[Ie+4]=ie.g,Oe[Ie+5]=ie.b,Oe[Ie+6]=oe.r,Oe[Ie+7]=oe.g,Oe[Ie+8]=oe.b,Oe[Ie+9]=ne.r,Oe[Ie+10]=ne.g,Oe[Ie+11]=ne.b,Ie+=12;0<Ie&&(N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglColorBuffer),N.bufferData(N.ARRAY_BUFFER,Oe,St))}if(ei&&Ze.hasTangents){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Nt=Lt.vertexTangents,Jt=Nt[0],Xt=Nt[1],Yt=Nt[2],Ue[Ae]=Jt.x,Ue[Ae+1]=Jt.y,Ue[Ae+2]=Jt.z,Ue[Ae+3]=Jt.w,Ue[Ae+4]=Xt.x,Ue[Ae+5]=Xt.y,Ue[Ae+6]=Xt.z,Ue[Ae+7]=Xt.w,Ue[Ae+8]=Yt.x,Ue[Ae+9]=Yt.y,Ue[Ae+10]=Yt.z,Ue[Ae+11]=Yt.w,Ae+=12;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Nt=Lt.vertexTangents,Jt=Nt[0],Xt=Nt[1],Yt=Nt[2],Kt=Nt[3],Ue[Ae]=Jt.x,Ue[Ae+1]=Jt.y,Ue[Ae+2]=Jt.z,Ue[Ae+3]=Jt.w,Ue[Ae+4]=Xt.x,Ue[Ae+5]=Xt.y,Ue[Ae+6]=Xt.z,Ue[Ae+7]=Xt.w,Ue[Ae+8]=Yt.x,Ue[Ae+9]=Yt.y,Ue[Ae+10]=Yt.z,Ue[Ae+11]=Yt.w,Ue[Ae+12]=Kt.x,Ue[Ae+13]=Kt.y,Ue[Ae+14]=Kt.z,Ue[Ae+15]=Kt.w,Ae+=16;N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglTangentBuffer),N.bufferData(N.ARRAY_BUFFER,Ue,St)}if(ti&&Mt){for(It=0,Ht=ri.length;It<Ht;It++)if(Lt=ai[ri[It]],Vt=Lt.vertexNormals,kt=Lt.normal,3===Vt.length&&Bt)for(de=0;3>de;de++)_e=Vt[de],Ne[De]=_e.x,Ne[De+1]=_e.y,Ne[De+2]=_e.z,De+=3;else for(de=0;3>de;de++)Ne[De]=kt.x,Ne[De+1]=kt.y,Ne[De+2]=kt.z,De+=3;for(It=0,Ht=si.length;It<Ht;It++)if(Lt=ai[si[It]],Vt=Lt.vertexNormals,kt=Lt.normal,4===Vt.length&&Bt)for(de=0;4>de;de++)_e=Vt[de],Ne[De]=_e.x,Ne[De+1]=_e.y,Ne[De+2]=_e.z,De+=3;else for(de=0;4>de;de++)Ne[De]=kt.x,Ne[De+1]=kt.y,Ne[De+2]=kt.z,De+=3;N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglNormalBuffer),N.bufferData(N.ARRAY_BUFFER,Ne,St)}if(Qe&&hi&&At){for(It=0,Ht=ri.length;It<Ht;It++)if(Pt=ri[It],void 0!==(Ut=hi[Pt]))for(de=0;3>de;de++)fe=Ut[de],Fe[Ce]=fe.u,Fe[Ce+1]=fe.v,Ce+=2;for(It=0,Ht=si.length;It<Ht;It++)if(Pt=si[It],void 0!==(Ut=hi[Pt]))for(de=0;4>de;de++)fe=Ut[de],Fe[Ce]=fe.u,Fe[Ce+1]=fe.v,Ce+=2;0<Ce&&(N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglUVBuffer),N.bufferData(N.ARRAY_BUFFER,Fe,St))}if(Qe&&li&&At){for(It=0,Ht=ri.length;It<Ht;It++)if(Pt=ri[It],void 0!==(Ot=li[Pt]))for(de=0;3>de;de++)ye=Ot[de],ze[Re]=ye.u,ze[Re+1]=ye.v,Re+=2;for(It=0,Ht=si.length;It<Ht;It++)if(Pt=si[It],void 0!==(Ot=li[Pt]))for(de=0;4>de;de++)ye=Ot[de],ze[Re]=ye.u,ze[Re+1]=ye.v,Re+=2;0<Re&&(N.bindBuffer(N.ARRAY_BUFFER,Tt.__webglUV2Buffer),N.bufferData(N.ARRAY_BUFFER,ze,St))}if($e){for(It=0,Ht=ri.length;It<Ht;It++)Ye[Me]=we,Ye[Me+1]=we+1,Ye[Me+2]=we+2,Me+=3,Ke[Be]=we,Ke[Be+1]=we+1,Ke[Be+2]=we,Ke[Be+3]=we+2,Ke[Be+4]=we+1,Ke[Be+5]=we+2,Be+=6,we+=3;for(It=0,Ht=si.length;It<Ht;It++)Ye[Me]=we,Ye[Me+1]=we+1,Ye[Me+2]=we+3,Ye[Me+3]=we+1,Ye[Me+4]=we+2,Ye[Me+5]=we+3,Me+=6,Ke[Be]=we,Ke[Be+1]=we+1,Ke[Be+2]=we,Ke[Be+3]=we+3,Ke[Be+4]=we+1,Ke[Be+5]=we+2,Ke[Be+6]=we+2,Ke[Be+7]=we+3,Be+=8,we+=4;N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,Tt.__webglFaceBuffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,Ye,St),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,Tt.__webglLineBuffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,Ke,St)}if(Je)for(de=0,pe=Je.length;de<pe;de++)if(Xe=Je[de],Xe.__original.needsUpdate){if(Le=0,1===Xe.size){if(void 0===Xe.boundTo||"vertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Xe.array[Le]=Xe.value[Lt.a],Xe.array[Le+1]=Xe.value[Lt.b],Xe.array[Le+2]=Xe.value[Lt.c],Le+=3;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Xe.array[Le]=Xe.value[Lt.a],Xe.array[Le+1]=Xe.value[Lt.b],Xe.array[Le+2]=Xe.value[Lt.c],Xe.array[Le+3]=Xe.value[Lt.d],Le+=4}else if("faces"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Ve=Xe.value[ri[It]],Xe.array[Le]=Ve,Xe.array[Le+1]=Ve,Xe.array[Le+2]=Ve,Le+=3;for(It=0,Ht=si.length;It<Ht;It++)Ve=Xe.value[si[It]],Xe.array[Le]=Ve,Xe.array[Le+1]=Ve,Xe.array[Le+2]=Ve,Xe.array[Le+3]=Ve,Le+=4}}else if(2===Xe.size){if(void 0===Xe.boundTo||"vertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Wt.x,Xe.array[Le+3]=Wt.y,Xe.array[Le+4]=jt.x,Xe.array[Le+5]=jt.y,Le+=6;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],qt=Xe.value[Lt.d],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Wt.x,Xe.array[Le+3]=Wt.y,Xe.array[Le+4]=jt.x,Xe.array[Le+5]=jt.y,Xe.array[Le+6]=qt.x,Xe.array[Le+7]=qt.y,Le+=8}else if("faces"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)jt=Wt=Gt=Ve=Xe.value[ri[It]],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Wt.x,Xe.array[Le+3]=Wt.y,Xe.array[Le+4]=jt.x,Xe.array[Le+5]=jt.y,Le+=6;for(It=0,Ht=si.length;It<Ht;It++)qt=jt=Wt=Gt=Ve=Xe.value[si[It]],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Wt.x,Xe.array[Le+3]=Wt.y,Xe.array[Le+4]=jt.x,Xe.array[Le+5]=jt.y,Xe.array[Le+6]=qt.x,Xe.array[Le+7]=qt.y,Le+=8}}else if(3===Xe.size){var pi;if(pi="c"===Xe.type?["r","g","b"]:["x","y","z"],void 0===Xe.boundTo||"vertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Le+=9;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],qt=Xe.value[Lt.d],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Xe.array[Le+9]=qt[pi[0]],Xe.array[Le+10]=qt[pi[1]],Xe.array[Le+11]=qt[pi[2]],Le+=12}else if("faces"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)jt=Wt=Gt=Ve=Xe.value[ri[It]],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Le+=9;for(It=0,Ht=si.length;It<Ht;It++)qt=jt=Wt=Gt=Ve=Xe.value[si[It]],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Xe.array[Le+9]=qt[pi[0]],Xe.array[Le+10]=qt[pi[1]],Xe.array[Le+11]=qt[pi[2]],Le+=12}else if("faceVertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Ve=Xe.value[ri[It]],Gt=Ve[0],Wt=Ve[1],jt=Ve[2],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Le+=9;for(It=0,Ht=si.length;It<Ht;It++)Ve=Xe.value[si[It]],Gt=Ve[0],Wt=Ve[1],jt=Ve[2],qt=Ve[3],Xe.array[Le]=Gt[pi[0]],Xe.array[Le+1]=Gt[pi[1]],Xe.array[Le+2]=Gt[pi[2]],Xe.array[Le+3]=Wt[pi[0]],Xe.array[Le+4]=Wt[pi[1]],Xe.array[Le+5]=Wt[pi[2]],Xe.array[Le+6]=jt[pi[0]],Xe.array[Le+7]=jt[pi[1]],Xe.array[Le+8]=jt[pi[2]],Xe.array[Le+9]=qt[pi[0]],Xe.array[Le+10]=qt[pi[1]],Xe.array[Le+11]=qt[pi[2]],Le+=12}}else if(4===Xe.size)if(void 0===Xe.boundTo||"vertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Lt=ai[ri[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Le+=12;for(It=0,Ht=si.length;It<Ht;It++)Lt=ai[si[It]],Gt=Xe.value[Lt.a],Wt=Xe.value[Lt.b],jt=Xe.value[Lt.c],qt=Xe.value[Lt.d],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Xe.array[Le+12]=qt.x,Xe.array[Le+13]=qt.y,Xe.array[Le+14]=qt.z,Xe.array[Le+15]=qt.w,Le+=16}else if("faces"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)jt=Wt=Gt=Ve=Xe.value[ri[It]],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Le+=12;for(It=0,Ht=si.length;It<Ht;It++)qt=jt=Wt=Gt=Ve=Xe.value[si[It]],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Xe.array[Le+12]=qt.x,Xe.array[Le+13]=qt.y,Xe.array[Le+14]=qt.z,Xe.array[Le+15]=qt.w,Le+=16}else if("faceVertices"===Xe.boundTo){for(It=0,Ht=ri.length;It<Ht;It++)Ve=Xe.value[ri[It]],Gt=Ve[0],Wt=Ve[1],jt=Ve[2],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Le+=12;for(It=0,Ht=si.length;It<Ht;It++)Ve=Xe.value[si[It]],Gt=Ve[0],Wt=Ve[1],jt=Ve[2],qt=Ve[3],Xe.array[Le]=Gt.x,Xe.array[Le+1]=Gt.y,Xe.array[Le+2]=Gt.z,Xe.array[Le+3]=Gt.w,Xe.array[Le+4]=Wt.x,Xe.array[Le+5]=Wt.y,Xe.array[Le+6]=Wt.z,Xe.array[Le+7]=Wt.w,Xe.array[Le+8]=jt.x,Xe.array[Le+9]=jt.y,Xe.array[Le+10]=jt.z,Xe.array[Le+11]=jt.w,Xe.array[Le+12]=qt.x,Xe.array[Le+13]=qt.y,Xe.array[Le+14]=qt.z,Xe.array[Le+15]=qt.w,Le+=16}N.bindBuffer(N.ARRAY_BUFFER,Xe.buffer),N.bufferData(N.ARRAY_BUFFER,Xe.array,St)}Ct&&(delete Tt.__inittedArrays,delete Tt.__colorArray,delete Tt.__normalArray,delete Tt.__tangentArray,delete Tt.__uvArray,delete Tt.__uv2Array,delete Tt.__faceArray,delete Tt.__vertexArray,delete Tt.__lineArray,delete Tt.__skinIndexArray,delete Tt.__skinWeightArray)}}yt.verticesNeedUpdate=!1,yt.morphTargetsNeedUpdate=!1,yt.elementsNeedUpdate=!1,yt.uvsNeedUpdate=!1,yt.normalsNeedUpdate=!1,yt.colorsNeedUpdate=!1,yt.tangentsNeedUpdate=!1,xt.attributes&&_(xt)}else if(ft instanceof THREE.Ribbon){if(yt.verticesNeedUpdate||yt.colorsNeedUpdate){var _i=yt,fi=N.DYNAMIC_DRAW,yi=void 0,gi=void 0,vi=void 0,xi=void 0,bi=void 0,Ei=_i.vertices,Ti=_i.colors,wi=Ei.length,Si=Ti.length,Ci=_i.__vertexArray,Ri=_i.__colorArray,Mi=_i.colorsNeedUpdate;if(_i.verticesNeedUpdate){for(yi=0;yi<wi;yi++)vi=Ei[yi],xi=3*yi,Ci[xi]=vi.x,Ci[xi+1]=vi.y,Ci[xi+2]=vi.z;N.bindBuffer(N.ARRAY_BUFFER,_i.__webglVertexBuffer),N.bufferData(N.ARRAY_BUFFER,Ci,fi)}if(Mi){for(gi=0;gi<Si;gi++)bi=Ti[gi],xi=3*gi,Ri[xi]=bi.r,Ri[xi+1]=bi.g,Ri[xi+2]=bi.b;N.bindBuffer(N.ARRAY_BUFFER,_i.__webglColorBuffer),N.bufferData(N.ARRAY_BUFFER,Ri,fi)}}yt.verticesNeedUpdate=!1,yt.colorsNeedUpdate=!1}else if(ft instanceof THREE.Line){if(xt=i(ft,gt),vt=xt.attributes&&p(xt),yt.verticesNeedUpdate||yt.colorsNeedUpdate||vt){var Di=yt,Ai=N.DYNAMIC_DRAW,Bi=void 0,Ii=void 0,Hi=void 0,Pi=void 0,Li=void 0,Vi=Di.vertices,ki=Di.colors,Fi=Vi.length,zi=ki.length,Ni=Di.__vertexArray,Ui=Di.__colorArray,Oi=Di.colorsNeedUpdate,Gi=Di.__webglCustomAttributesList,Wi=void 0,ji=void 0,qi=void 0,Ji=void 0,Xi=void 0,Yi=void 0;if(Di.verticesNeedUpdate){for(Bi=0;Bi<Fi;Bi++)Hi=Vi[Bi],Pi=3*Bi,Ni[Pi]=Hi.x,Ni[Pi+1]=Hi.y,Ni[Pi+2]=Hi.z;N.bindBuffer(N.ARRAY_BUFFER,Di.__webglVertexBuffer),N.bufferData(N.ARRAY_BUFFER,Ni,Ai)}if(Oi){for(Ii=0;Ii<zi;Ii++)Li=ki[Ii],Pi=3*Ii,Ui[Pi]=Li.r,Ui[Pi+1]=Li.g,Ui[Pi+2]=Li.b;N.bindBuffer(N.ARRAY_BUFFER,Di.__webglColorBuffer),N.bufferData(N.ARRAY_BUFFER,Ui,Ai)}if(Gi)for(Wi=0,ji=Gi.length;Wi<ji;Wi++)if(Yi=Gi[Wi],Yi.needsUpdate&&(void 0===Yi.boundTo||"vertices"===Yi.boundTo)){if(Pi=0,Ji=Yi.value.length,1===Yi.size)for(qi=0;qi<Ji;qi++)Yi.array[qi]=Yi.value[qi];else if(2===Yi.size)for(qi=0;qi<Ji;qi++)Xi=Yi.value[qi],Yi.array[Pi]=Xi.x,Yi.array[Pi+1]=Xi.y,Pi+=2;else if(3===Yi.size)if("c"===Yi.type)for(qi=0;qi<Ji;qi++)Xi=Yi.value[qi],Yi.array[Pi]=Xi.r,Yi.array[Pi+1]=Xi.g,Yi.array[Pi+2]=Xi.b,Pi+=3;else for(qi=0;qi<Ji;qi++)Xi=Yi.value[qi],Yi.array[Pi]=Xi.x,Yi.array[Pi+1]=Xi.y,Yi.array[Pi+2]=Xi.z,Pi+=3;else if(4===Yi.size)for(qi=0;qi<Ji;qi++)Xi=Yi.value[qi],Yi.array[Pi]=Xi.x,Yi.array[Pi+1]=Xi.y,Yi.array[Pi+2]=Xi.z,Yi.array[Pi+3]=Xi.w,Pi+=4;N.bindBuffer(N.ARRAY_BUFFER,Yi.buffer),N.bufferData(N.ARRAY_BUFFER,Yi.array,Ai)}}yt.verticesNeedUpdate=!1,yt.colorsNeedUpdate=!1,xt.attributes&&_(xt)}else ft instanceof THREE.ParticleSystem&&(yt instanceof THREE.BufferGeometry?((yt.verticesNeedUpdate||yt.colorsNeedUpdate)&&a(yt,N.DYNAMIC_DRAW,!yt.dynamic),yt.verticesNeedUpdate=!1,yt.colorsNeedUpdate=!1):(xt=i(ft,gt),vt=xt.attributes&&p(xt),(yt.verticesNeedUpdate||yt.colorsNeedUpdate||ft.sortParticles||vt)&&s(yt,N.DYNAMIC_DRAW,ft),yt.verticesNeedUpdate=!1,yt.colorsNeedUpdate=!1,xt.attributes&&_(xt)))}},this.initMaterial=function(t,e,i,o){var n,r,s,a,h,l,c,u,m;if(t instanceof THREE.MeshDepthMaterial?m="depth":t instanceof THREE.MeshNormalMaterial?m="normal":t instanceof THREE.MeshBasicMaterial?m="basic":t instanceof THREE.MeshLambertMaterial?m="lambert":t instanceof THREE.MeshPhongMaterial?m="phong":t instanceof THREE.LineBasicMaterial?m="basic":t instanceof THREE.ParticleBasicMaterial&&(m="particle_basic"),m){var d=THREE.ShaderLib[m];t.uniforms=THREE.UniformsUtils.clone(d.uniforms),t.vertexShader=d.vertexShader,t.fragmentShader=d.fragmentShader}var p,_,f;for(n=p=_=f=d=0,r=e.length;n<r;n++)s=e[n],s.onlyShadow||(s instanceof THREE.DirectionalLight&&p++,s instanceof THREE.PointLight&&_++,s instanceof THREE.SpotLight&&f++,s instanceof THREE.HemisphereLight&&d++);for(_+f+p+d<=z?n=p:(n=Math.ceil(z*p/(_+p)),f=_=z-n,d=n),r=_,s=f,a=d,d=p=0,f=e.length;d<f;d++)_=e[d],_.castShadow&&(_ instanceof THREE.SpotLight&&p++,_ instanceof THREE.DirectionalLight&&!_.shadowCascade&&p++);u=p,Mt&&o&&o.useVertexTexture?c=1024:(e=N.getParameter(N.MAX_VERTEX_UNIFORM_VECTORS),e=Math.floor((e-20)/4),void 0!==o&&o instanceof THREE.SkinnedMesh&&(e=Math.min(o.bones.length,e))<o.bones.length&&console.warn("WebGLRenderer: too many bones - "+o.bones.length+", this GPU supports just "+e+" (try OpenGL instead of ANGLE)"),c=e);var y;t:{_=t.fragmentShader,f=t.vertexShader,d=t.uniforms,e=t.attributes,p=t.defines;var g,v,x,i={map:!!t.map,envMap:!!t.envMap,lightMap:!!t.lightMap,bumpMap:!!t.bumpMap,normalMap:!!t.normalMap,specularMap:!!t.specularMap,vertexColors:t.vertexColors,fog:i,useFog:t.fog,sizeAttenuation:t.sizeAttenuation,skinning:t.skinning,maxBones:c,useVertexTexture:Mt&&o&&o.useVertexTexture,boneTextureWidth:o&&o.boneTextureWidth,boneTextureHeight:o&&o.boneTextureHeight,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:n,maxPointLights:r,maxSpotLights:s,maxHemiLights:a,maxShadows:u,shadowMapEnabled:this.shadowMapEnabled&&o.receiveShadow,shadowMapSoft:this.shadowMapSoft,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:t.alphaTest,metal:t.metal,perPixel:t.perPixel,wrapAround:t.wrapAround,doubleSided:t.side===THREE.DoubleSide,flipSided:t.side===THREE.BackSide},o=[];m?o.push(m):(o.push(_),o.push(f));for(v in p)o.push(v),o.push(p[v]);for(g in i)o.push(g),o.push(i[g]);for(m=o.join(),g=0,v=W.length;g<v;g++)if(o=W[g],o.code===m){o.usedTimes++,y=o.program;break t}g=[];for(x in p)!1!==(v=p[x])&&(v="#define "+x+" "+v,g.push(v));v=g.join("\n"),x=N.createProgram(),g=["precision "+B+" float;",v,Rt?"#define VERTEX_TEXTURES":"",G.gammaInput?"#define GAMMA_INPUT":"",G.gammaOutput?"#define GAMMA_OUTPUT":"",G.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SPOT_LIGHTS "+i.maxSpotLights,"#define MAX_HEMI_LIGHTS "+i.maxHemiLights,"#define MAX_SHADOWS "+i.maxShadows,"#define MAX_BONES "+i.maxBones,i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.lightMap?"#define USE_LIGHTMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.vertexColors?"#define USE_COLOR":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.boneTextureWidth?"#define N_BONE_PIXEL_X "+i.boneTextureWidth.toFixed(1):"",i.boneTextureHeight?"#define N_BONE_PIXEL_Y "+i.boneTextureHeight.toFixed(1):"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals?"#define USE_MORPHNORMALS":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapSoft?"#define SHADOWMAP_SOFT":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec2 uv2;\n#ifdef USE_COLOR\nattribute vec3 color;\n#endif\n#ifdef USE_MORPHTARGETS\nattribute vec3 morphTarget0;\nattribute vec3 morphTarget1;\nattribute vec3 morphTarget2;\nattribute vec3 morphTarget3;\n#ifdef USE_MORPHNORMALS\nattribute vec3 morphNormal0;\nattribute vec3 morphNormal1;\nattribute vec3 morphNormal2;\nattribute vec3 morphNormal3;\n#else\nattribute vec3 morphTarget4;\nattribute vec3 morphTarget5;\nattribute vec3 morphTarget6;\nattribute vec3 morphTarget7;\n#endif\n#endif\n#ifdef USE_SKINNING\nattribute vec4 skinIndex;\nattribute vec4 skinWeight;\n#endif\n"].join("\n"),v=["precision "+B+" float;",i.bumpMap||i.normalMap?"#extension GL_OES_standard_derivatives : enable":"",v,"#define MAX_DIR_LIGHTS "+i.maxDirLights,"#define MAX_POINT_LIGHTS "+i.maxPointLights,"#define MAX_SPOT_LIGHTS "+i.maxSpotLights,"#define MAX_HEMI_LIGHTS "+i.maxHemiLights,"#define MAX_SHADOWS "+i.maxShadows,i.alphaTest?"#define ALPHATEST "+i.alphaTest:"",G.gammaInput?"#define GAMMA_INPUT":"",G.gammaOutput?"#define GAMMA_OUTPUT":"",G.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fog instanceof THREE.FogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.lightMap?"#define USE_LIGHTMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.vertexColors?"#define USE_COLOR":"",i.metal?"#define METAL":"",i.perPixel?"#define PHONG_PER_PIXEL":"",i.wrapAround?"#define WRAP_AROUND":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapSoft?"#define SHADOWMAP_SOFT":"",i.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",i.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"].join("\n"),v=S("fragment",v+_),g=S("vertex",g+f),N.attachShader(x,g),N.attachShader(x,v),N.linkProgram(x),N.getProgramParameter(x,N.LINK_STATUS)||console.error("Could not initialise shader\nVALIDATE_STATUS: "+N.getProgramParameter(x,N.VALIDATE_STATUS)+", gl error ["+N.getError()+"]"),N.deleteShader(v),N.deleteShader(g),x.uniforms={},x.attributes={};var b;g="viewMatrix modelViewMatrix projectionMatrix normalMatrix modelMatrix cameraPosition morphTargetInfluences".split(" "),i.useVertexTexture?g.push("boneTexture"):g.push("boneGlobalMatrices");for(b in d)g.push(b);for(b=g,g=0,v=b.length;g<v;g++)o=b[g],x.uniforms[o]=N.getUniformLocation(x,o);for(g="position normal uv uv2 tangent color skinIndex skinWeight".split(" "),b=0;b<i.maxMorphTargets;b++)g.push("morphTarget"+b);for(b=0;b<i.maxMorphNormals;b++)g.push("morphNormal"+b);for(y in e)g.push(y);for(y=g,b=0,g=y.length;b<g;b++)v=y[b],x.attributes[v]=N.getAttribLocation(x,v);x.id=j++,W.push({program:x,code:m,usedTimes:1}),G.info.memory.programs=W.length,y=x}if(t.program=y,y=t.program.attributes,0<=y.position&&N.enableVertexAttribArray(y.position),
0<=y.color&&N.enableVertexAttribArray(y.color),0<=y.normal&&N.enableVertexAttribArray(y.normal),0<=y.tangent&&N.enableVertexAttribArray(y.tangent),t.skinning&&0<=y.skinIndex&&0<=y.skinWeight&&(N.enableVertexAttribArray(y.skinIndex),N.enableVertexAttribArray(y.skinWeight)),t.attributes)for(l in t.attributes)void 0!==y[l]&&0<=y[l]&&N.enableVertexAttribArray(y[l]);if(t.morphTargets)for(t.numSupportedMorphTargets=0,x="morphTarget",l=0;l<this.maxMorphTargets;l++)b=x+l,0<=y[b]&&(N.enableVertexAttribArray(y[b]),t.numSupportedMorphTargets++);if(t.morphNormals)for(t.numSupportedMorphNormals=0,x="morphNormal",l=0;l<this.maxMorphNormals;l++)b=x+l,0<=y[b]&&(N.enableVertexAttribArray(y[b]),t.numSupportedMorphNormals++);t.uniformsList=[];for(h in t.uniforms)t.uniformsList.push([t.uniforms[h],h])},this.setFaceCulling=function(t,e){t?(e&&"ccw"!==e?N.frontFace(N.CW):N.frontFace(N.CCW),"back"===t?N.cullFace(N.BACK):"front"===t?N.cullFace(N.FRONT):N.cullFace(N.FRONT_AND_BACK),N.enable(N.CULL_FACE)):N.disable(N.CULL_FACE)},this.setMaterialFaces=function(t){var e=t.side===THREE.DoubleSide,t=t.side===THREE.BackSide;Q!==e&&(e?N.disable(N.CULL_FACE):N.enable(N.CULL_FACE),Q=e),tt!==t&&(t?N.frontFace(N.CW):N.frontFace(N.CCW),tt=t)},this.setDepthTest=function(t){rt!==t&&(t?N.enable(N.DEPTH_TEST):N.disable(N.DEPTH_TEST),rt=t)},this.setDepthWrite=function(t){st!==t&&(N.depthMask(t),st=t)},this.setBlending=function(t,e,i,o){t!==et&&(t===THREE.NoBlending?N.disable(N.BLEND):t===THREE.AdditiveBlending?(N.enable(N.BLEND),N.blendEquation(N.FUNC_ADD),N.blendFunc(N.SRC_ALPHA,N.ONE)):t===THREE.SubtractiveBlending?(N.enable(N.BLEND),N.blendEquation(N.FUNC_ADD),N.blendFunc(N.ZERO,N.ONE_MINUS_SRC_COLOR)):t===THREE.MultiplyBlending?(N.enable(N.BLEND),N.blendEquation(N.FUNC_ADD),N.blendFunc(N.ZERO,N.SRC_COLOR)):t===THREE.CustomBlending?N.enable(N.BLEND):(N.enable(N.BLEND),N.blendEquationSeparate(N.FUNC_ADD,N.FUNC_ADD),N.blendFuncSeparate(N.SRC_ALPHA,N.ONE_MINUS_SRC_ALPHA,N.ONE,N.ONE_MINUS_SRC_ALPHA)),et=t),t===THREE.CustomBlending?(e!==it&&(N.blendEquation(D(e)),it=e),(i!==ot||o!==nt)&&(N.blendFunc(D(i),D(o)),ot=i,nt=o)):nt=ot=it=null},this.setTexture=function(t,e){if(t.needsUpdate){t.__webglInit||(t.__webglInit=!0,t.__webglTexture=N.createTexture(),G.info.memory.textures++),N.activeTexture(N.TEXTURE0+e),N.bindTexture(N.TEXTURE_2D,t.__webglTexture),N.pixelStorei(N.UNPACK_FLIP_Y_WEBGL,t.flipY),N.pixelStorei(N.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha);var i=t.image,o=0==(i.width&i.width-1)&&0==(i.height&i.height-1),n=D(t.format),r=D(t.type);if(C(N.TEXTURE_2D,t,o),t instanceof THREE.CompressedTexture)for(var r=t.mipmaps,s=0,a=r.length;s<a;s++)i=r[s],N.compressedTexImage2D(N.TEXTURE_2D,s,n,i.width,i.height,0,i.data);else t instanceof THREE.DataTexture?N.texImage2D(N.TEXTURE_2D,0,n,i.width,i.height,0,n,r,i.data):N.texImage2D(N.TEXTURE_2D,0,n,n,r,t.image);t.generateMipmaps&&o&&N.generateMipmap(N.TEXTURE_2D),t.needsUpdate=!1,t.onUpdate&&t.onUpdate()}else N.activeTexture(N.TEXTURE0+e),N.bindTexture(N.TEXTURE_2D,t.__webglTexture)},this.setRenderTarget=function(t){var e=t instanceof THREE.WebGLRenderTargetCube;if(t&&!t.__webglFramebuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.__webglTexture=N.createTexture();var i=0==(t.width&t.width-1)&&0==(t.height&t.height-1),o=D(t.format),n=D(t.type);if(e){t.__webglFramebuffer=[],t.__webglRenderbuffer=[],N.bindTexture(N.TEXTURE_CUBE_MAP,t.__webglTexture),C(N.TEXTURE_CUBE_MAP,t,i);for(var r=0;6>r;r++){t.__webglFramebuffer[r]=N.createFramebuffer(),t.__webglRenderbuffer[r]=N.createRenderbuffer(),N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,o,t.width,t.height,0,o,n,null);var s=t,a=N.TEXTURE_CUBE_MAP_POSITIVE_X+r;N.bindFramebuffer(N.FRAMEBUFFER,t.__webglFramebuffer[r]),N.framebufferTexture2D(N.FRAMEBUFFER,N.COLOR_ATTACHMENT0,a,s.__webglTexture,0),R(t.__webglRenderbuffer[r],t)}i&&N.generateMipmap(N.TEXTURE_CUBE_MAP)}else t.__webglFramebuffer=N.createFramebuffer(),t.__webglRenderbuffer=N.createRenderbuffer(),N.bindTexture(N.TEXTURE_2D,t.__webglTexture),C(N.TEXTURE_2D,t,i),N.texImage2D(N.TEXTURE_2D,0,o,t.width,t.height,0,o,n,null),o=N.TEXTURE_2D,N.bindFramebuffer(N.FRAMEBUFFER,t.__webglFramebuffer),N.framebufferTexture2D(N.FRAMEBUFFER,N.COLOR_ATTACHMENT0,o,t.__webglTexture,0),R(t.__webglRenderbuffer,t),i&&N.generateMipmap(N.TEXTURE_2D);e?N.bindTexture(N.TEXTURE_CUBE_MAP,null):N.bindTexture(N.TEXTURE_2D,null),N.bindRenderbuffer(N.RENDERBUFFER,null),N.bindFramebuffer(N.FRAMEBUFFER,null)}t?(e=e?t.__webglFramebuffer[t.activeCubeFace]:t.__webglFramebuffer,i=t.width,t=t.height,n=o=0):(e=null,i=dt,t=pt,o=ut,n=mt),e!==J&&(N.bindFramebuffer(N.FRAMEBUFFER,e),N.viewport(o,n,i,t),J=e),_t=i,ft=t},this.shadowMapPlugin=new THREE.ShadowMapPlugin,this.addPrePlugin(this.shadowMapPlugin),this.addPostPlugin(new THREE.SpritePlugin),this.addPostPlugin(new THREE.LensFlarePlugin)},THREE.WebGLRenderTarget=function(t,e,i){this.width=t,this.height=e,i=i||{},this.wrapS=void 0!==i.wrapS?i.wrapS:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==i.wrapT?i.wrapT:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==i.magFilter?i.magFilter:THREE.LinearFilter,this.minFilter=void 0!==i.minFilter?i.minFilter:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.format=void 0!==i.format?i.format:THREE.RGBAFormat,this.type=void 0!==i.type?i.type:THREE.UnsignedByteType,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.generateMipmaps=!0},THREE.WebGLRenderTarget.prototype.clone=function(){var t=new THREE.WebGLRenderTarget(this.width,this.height);return t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.anisotropy=this.anisotropy,t.minFilter=this.minFilter,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.format=this.format,t.type=this.type,t.depthBuffer=this.depthBuffer,t.stencilBuffer=this.stencilBuffer,t.generateMipmaps=this.generateMipmaps,t},THREE.WebGLRenderTargetCube=function(t,e,i){THREE.WebGLRenderTarget.call(this,t,e,i),this.activeCubeFace=0},THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype),THREE.RenderableVertex=function(){this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(t){this.positionWorld.copy(t.positionWorld),this.positionScreen.copy(t.positionScreen)},THREE.RenderableFace3=function(){this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.material=this.color=null,this.uvs=[[]],this.z=null},THREE.RenderableFace4=function(){this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.v4=new THREE.RenderableVertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.material=this.color=null,this.uvs=[[]],this.z=null},THREE.RenderableObject=function(){this.z=this.object=null},THREE.RenderableParticle=function(){this.rotation=this.z=this.y=this.x=this.object=null,this.scale=new THREE.Vector2,this.material=null},THREE.RenderableLine=function(){this.z=null,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.material=null},THREE.ColorUtils={adjustHSV:function(t,e,i,o){var n=THREE.ColorUtils.__hsv;THREE.ColorUtils.rgbToHsv(t,n),n.h=THREE.Math.clamp(n.h+e,0,1),n.s=THREE.Math.clamp(n.s+i,0,1),n.v=THREE.Math.clamp(n.v+o,0,1),t.setHSV(n.h,n.s,n.v)},rgbToHsv:function(t,e){var i=t.r,o=t.g,n=t.b,r=Math.max(Math.max(i,o),n),s=Math.min(Math.min(i,o),n);if(s===r)s=i=0;else{var a=r-s,s=a/r,i=(i===r?(o-n)/a:o===r?2+(n-i)/a:4+(i-o)/a)/6;0>i&&(i+=1),1<i&&(i-=1)}return void 0===e&&(e={h:0,s:0,v:0}),e.h=i,e.s=s,e.v=r,e}},THREE.ColorUtils.__hsv={h:0,s:0,v:0},THREE.GeometryUtils={merge:function(t,e){for(var i,o,n=t.vertices.length,r=e instanceof THREE.Mesh?e.geometry:e,s=t.vertices,a=r.vertices,h=t.faces,l=r.faces,c=t.faceVertexUvs[0],u=r.faceVertexUvs[0],m={},d=0;d<t.materials.length;d++)m[t.materials[d].id]=d;e instanceof THREE.Mesh&&(e.matrixAutoUpdate&&e.updateMatrix(),i=e.matrix,o=new THREE.Matrix4,o.extractRotation(i,e.scale));for(var d=0,p=a.length;d<p;d++){var _=a[d].clone();i&&i.multiplyVector3(_),s.push(_)}for(d=0,p=l.length;d<p;d++){var f,y,s=l[d],g=s.vertexNormals,v=s.vertexColors;for(s instanceof THREE.Face3?f=new THREE.Face3(s.a+n,s.b+n,s.c+n):s instanceof THREE.Face4&&(f=new THREE.Face4(s.a+n,s.b+n,s.c+n,s.d+n)),f.normal.copy(s.normal),o&&o.multiplyVector3(f.normal),a=0,_=g.length;a<_;a++)y=g[a].clone(),o&&o.multiplyVector3(y),f.vertexNormals.push(y);for(f.color.copy(s.color),a=0,_=v.length;a<_;a++)y=v[a],f.vertexColors.push(y.clone());void 0!==s.materialIndex&&(a=r.materials[s.materialIndex],_=a.id,v=m[_],void 0===v&&(v=t.materials.length,m[_]=v,t.materials.push(a)),f.materialIndex=v),f.centroid.copy(s.centroid),i&&i.multiplyVector3(f.centroid),h.push(f)}for(d=0,p=u.length;d<p;d++){for(i=u[d],o=[],a=0,_=i.length;a<_;a++)o.push(new THREE.UV(i[a].u,i[a].v));c.push(o)}},clone:function(t){var e,i=new THREE.Geometry,o=t.vertices,n=t.faces,r=t.faceVertexUvs[0];for(t.materials&&(i.materials=t.materials.slice()),t=0,e=o.length;t<e;t++)i.vertices.push(o[t].clone());for(t=0,e=n.length;t<e;t++)i.faces.push(n[t].clone());for(t=0,e=r.length;t<e;t++){for(var o=r[t],n=[],s=0,a=o.length;s<a;s++)n.push(new THREE.UV(o[s].u,o[s].v));i.faceVertexUvs[0].push(n)}return i},randomPointInTriangle:function(t,e,i){var o,n,r,s=new THREE.Vector3,a=THREE.GeometryUtils.__v1;return o=THREE.GeometryUtils.random(),n=THREE.GeometryUtils.random(),1<o+n&&(o=1-o,n=1-n),r=1-o-n,s.copy(t),s.multiplyScalar(o),a.copy(e),a.multiplyScalar(n),s.addSelf(a),a.copy(i),a.multiplyScalar(r),s.addSelf(a),s},randomPointInFace:function(t,e,i){var o,n,r;if(t instanceof THREE.Face3)return o=e.vertices[t.a],n=e.vertices[t.b],r=e.vertices[t.c],THREE.GeometryUtils.randomPointInTriangle(o,n,r);if(t instanceof THREE.Face4){o=e.vertices[t.a],n=e.vertices[t.b],r=e.vertices[t.c];var s,e=e.vertices[t.d];return i?t._area1&&t._area2?(i=t._area1,s=t._area2):(i=THREE.GeometryUtils.triangleArea(o,n,e),s=THREE.GeometryUtils.triangleArea(n,r,e),t._area1=i,t._area2=s):(i=THREE.GeometryUtils.triangleArea(o,n,e),s=THREE.GeometryUtils.triangleArea(n,r,e)),THREE.GeometryUtils.random()*(i+s)<i?THREE.GeometryUtils.randomPointInTriangle(o,n,e):THREE.GeometryUtils.randomPointInTriangle(n,r,e)}},randomPointsInGeometry:function(t,e){var i,o,n,r,s,a,h=t.faces,l=t.vertices,c=h.length,u=0,m=[];for(o=0;o<c;o++)i=h[o],i instanceof THREE.Face3?(n=l[i.a],r=l[i.b],s=l[i.c],i._area=THREE.GeometryUtils.triangleArea(n,r,s)):i instanceof THREE.Face4&&(n=l[i.a],r=l[i.b],s=l[i.c],a=l[i.d],i._area1=THREE.GeometryUtils.triangleArea(n,r,a),i._area2=THREE.GeometryUtils.triangleArea(r,s,a),i._area=i._area1+i._area2),u+=i._area,m[o]=u;for(i=[],o=0;o<e;o++)l=THREE.GeometryUtils.random()*u,l=function(t){function e(i,o){if(o<i)return i;var n=i+Math.floor((o-i)/2);return m[n]>t?e(i,n-1):m[n]<t?e(n+1,o):n}return e(0,m.length-1)}(l),i[o]=THREE.GeometryUtils.randomPointInFace(h[l],t,!0);return i},triangleArea:function(t,e,i){var o,n=THREE.GeometryUtils.__v1;return n.sub(t,e),o=n.length(),n.sub(t,i),t=n.length(),n.sub(e,i),i=n.length(),e=.5*(o+t+i),Math.sqrt(e*(e-o)*(e-t)*(e-i))},center:function(t){t.computeBoundingBox();var e=t.boundingBox,i=new THREE.Vector3;return i.add(e.min,e.max),i.multiplyScalar(-.5),t.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,i.y,i.z)),t.computeBoundingBox(),i},normalizeUVs:function(t){for(var t=t.faceVertexUvs[0],e=0,i=t.length;e<i;e++)for(var o=t[e],n=0,r=o.length;n<r;n++)1!==o[n].u&&(o[n].u-=Math.floor(o[n].u)),1!==o[n].v&&(o[n].v-=Math.floor(o[n].v))},triangulateQuads:function(t){var e,i,o,n,r=[],s=[],a=[];for(e=0,i=t.faceUvs.length;e<i;e++)s[e]=[];for(e=0,i=t.faceVertexUvs.length;e<i;e++)a[e]=[];for(e=0,i=t.faces.length;e<i;e++)if((o=t.faces[e])instanceof THREE.Face4){n=o.a;var h=o.b,l=o.c,c=o.d,u=new THREE.Face3,m=new THREE.Face3;for(u.color.copy(o.color),m.color.copy(o.color),u.materialIndex=o.materialIndex,m.materialIndex=o.materialIndex,u.a=n,u.b=h,u.c=c,m.a=h,m.b=l,m.c=c,4===o.vertexColors.length&&(u.vertexColors[0]=o.vertexColors[0].clone(),u.vertexColors[1]=o.vertexColors[1].clone(),u.vertexColors[2]=o.vertexColors[3].clone(),m.vertexColors[0]=o.vertexColors[1].clone(),m.vertexColors[1]=o.vertexColors[2].clone(),m.vertexColors[2]=o.vertexColors[3].clone()),r.push(u,m),o=0,n=t.faceVertexUvs.length;o<n;o++)t.faceVertexUvs[o].length&&(u=t.faceVertexUvs[o][e],h=u[1],l=u[2],c=u[3],u=[u[0].clone(),h.clone(),c.clone()],h=[h.clone(),l.clone(),c.clone()],a[o].push(u,h));for(o=0,n=t.faceUvs.length;o<n;o++)t.faceUvs[o].length&&(h=t.faceUvs[o][e],s[o].push(h,h))}else{for(r.push(o),o=0,n=t.faceUvs.length;o<n;o++)s[o].push(t.faceUvs[o][e]);for(o=0,n=t.faceVertexUvs.length;o<n;o++)a[o].push(t.faceVertexUvs[o][e])}t.faces=r,t.faceUvs=s,t.faceVertexUvs=a,t.computeCentroids(),t.computeFaceNormals(),t.computeVertexNormals(),t.hasTangents&&t.computeTangents()},explode:function(t){for(var e=[],i=0,o=t.faces.length;i<o;i++){var n=e.length,r=t.faces[i];if(r instanceof THREE.Face4){var s=r.a,a=r.b,h=r.c,s=t.vertices[s],a=t.vertices[a],h=t.vertices[h],l=t.vertices[r.d];e.push(s.clone()),e.push(a.clone()),e.push(h.clone()),e.push(l.clone()),r.a=n,r.b=n+1,r.c=n+2,r.d=n+3}else s=r.a,a=r.b,h=r.c,s=t.vertices[s],a=t.vertices[a],h=t.vertices[h],e.push(s.clone()),e.push(a.clone()),e.push(h.clone()),r.a=n,r.b=n+1,r.c=n+2}t.vertices=e,delete t.__tmpVertices},tessellate:function(t,e){var i,o,n,r,s,a,h,l,c,u,m,d,p,_,f,y,g,v,x,b=[],E=[];for(i=0,o=t.faceVertexUvs.length;i<o;i++)E[i]=[];for(i=0,o=t.faces.length;i<o;i++)if((n=t.faces[i])instanceof THREE.Face3)if(r=n.a,s=n.b,a=n.c,l=t.vertices[r],c=t.vertices[s],u=t.vertices[a],d=l.distanceTo(c),p=c.distanceTo(u),m=l.distanceTo(u),d>e||p>e||m>e)for(h=t.vertices.length,v=n.clone(),x=n.clone(),d>=p&&d>=m?(l=l.clone(),l.lerpSelf(c,.5),v.a=r,v.b=h,v.c=a,x.a=h,x.b=s,x.c=a,3===n.vertexNormals.length&&(r=n.vertexNormals[0].clone(),r.lerpSelf(n.vertexNormals[1],.5),v.vertexNormals[1].copy(r),x.vertexNormals[0].copy(r)),3===n.vertexColors.length&&(r=n.vertexColors[0].clone(),r.lerpSelf(n.vertexColors[1],.5),v.vertexColors[1].copy(r),x.vertexColors[0].copy(r)),n=0):p>=d&&p>=m?(l=c.clone(),l.lerpSelf(u,.5),v.a=r,v.b=s,v.c=h,x.a=h,x.b=a,x.c=r,3===n.vertexNormals.length&&(r=n.vertexNormals[1].clone(),r.lerpSelf(n.vertexNormals[2],.5),v.vertexNormals[2].copy(r),x.vertexNormals[0].copy(r),x.vertexNormals[1].copy(n.vertexNormals[2]),x.vertexNormals[2].copy(n.vertexNormals[0])),3===n.vertexColors.length&&(r=n.vertexColors[1].clone(),r.lerpSelf(n.vertexColors[2],.5),v.vertexColors[2].copy(r),x.vertexColors[0].copy(r),x.vertexColors[1].copy(n.vertexColors[2]),x.vertexColors[2].copy(n.vertexColors[0])),n=1):(l=l.clone(),l.lerpSelf(u,.5),v.a=r,v.b=s,v.c=h,x.a=h,x.b=s,x.c=a,3===n.vertexNormals.length&&(r=n.vertexNormals[0].clone(),r.lerpSelf(n.vertexNormals[2],.5),v.vertexNormals[2].copy(r),x.vertexNormals[0].copy(r)),3===n.vertexColors.length&&(r=n.vertexColors[0].clone(),r.lerpSelf(n.vertexColors[2],.5),v.vertexColors[2].copy(r),x.vertexColors[0].copy(r)),n=2),b.push(v,x),t.vertices.push(l),r=0,s=t.faceVertexUvs.length;r<s;r++)t.faceVertexUvs[r].length&&(l=t.faceVertexUvs[r][i],x=l[0],a=l[1],v=l[2],0===n?(c=x.clone(),c.lerpSelf(a,.5),l=[x.clone(),c.clone(),v.clone()],a=[c.clone(),a.clone(),v.clone()]):1===n?(c=a.clone(),c.lerpSelf(v,.5),l=[x.clone(),a.clone(),c.clone()],a=[c.clone(),v.clone(),x.clone()]):(c=x.clone(),c.lerpSelf(v,.5),l=[x.clone(),a.clone(),c.clone()],a=[c.clone(),a.clone(),v.clone()]),E[r].push(l,a));else for(b.push(n),r=0,s=t.faceVertexUvs.length;r<s;r++)E[r].push(t.faceVertexUvs[r][i]);else if(r=n.a,s=n.b,a=n.c,h=n.d,l=t.vertices[r],c=t.vertices[s],u=t.vertices[a],m=t.vertices[h],d=l.distanceTo(c),p=c.distanceTo(u),_=u.distanceTo(m),f=l.distanceTo(m),d>e||p>e||_>e||f>e)for(y=t.vertices.length,g=t.vertices.length+1,v=n.clone(),x=n.clone(),d>=p&&d>=_&&d>=f||_>=p&&_>=d&&_>=f?(d=l.clone(),d.lerpSelf(c,.5),c=u.clone(),c.lerpSelf(m,.5),v.a=r,v.b=y,v.c=g,v.d=h,x.a=y,x.b=s,x.c=a,x.d=g,4===n.vertexNormals.length&&(r=n.vertexNormals[0].clone(),r.lerpSelf(n.vertexNormals[1],.5),s=n.vertexNormals[2].clone(),s.lerpSelf(n.vertexNormals[3],.5),v.vertexNormals[1].copy(r),v.vertexNormals[2].copy(s),x.vertexNormals[0].copy(r),x.vertexNormals[3].copy(s)),4===n.vertexColors.length&&(r=n.vertexColors[0].clone(),r.lerpSelf(n.vertexColors[1],.5),s=n.vertexColors[2].clone(),s.lerpSelf(n.vertexColors[3],.5),v.vertexColors[1].copy(r),v.vertexColors[2].copy(s),x.vertexColors[0].copy(r),x.vertexColors[3].copy(s)),n=0):(d=c.clone(),d.lerpSelf(u,.5),c=m.clone(),c.lerpSelf(l,.5),v.a=r,v.b=s,v.c=y,v.d=g,x.a=g,x.b=y,x.c=a,x.d=h,4===n.vertexNormals.length&&(r=n.vertexNormals[1].clone(),r.lerpSelf(n.vertexNormals[2],.5),s=n.vertexNormals[3].clone(),s.lerpSelf(n.vertexNormals[0],.5),v.vertexNormals[2].copy(r),v.vertexNormals[3].copy(s),x.vertexNormals[0].copy(s),x.vertexNormals[1].copy(r)),4===n.vertexColors.length&&(r=n.vertexColors[1].clone(),r.lerpSelf(n.vertexColors[2],.5),s=n.vertexColors[3].clone(),s.lerpSelf(n.vertexColors[0],.5),v.vertexColors[2].copy(r),v.vertexColors[3].copy(s),x.vertexColors[0].copy(s),x.vertexColors[1].copy(r)),n=1),b.push(v,x),t.vertices.push(d,c),r=0,s=t.faceVertexUvs.length;r<s;r++)t.faceVertexUvs[r].length&&(l=t.faceVertexUvs[r][i],x=l[0],a=l[1],v=l[2],l=l[3],0===n?(c=x.clone(),c.lerpSelf(a,.5),u=v.clone(),u.lerpSelf(l,.5),x=[x.clone(),c.clone(),u.clone(),l.clone()],a=[c.clone(),a.clone(),v.clone(),u.clone()]):(c=a.clone(),c.lerpSelf(v,.5),u=l.clone(),u.lerpSelf(x,.5),x=[x.clone(),a.clone(),c.clone(),u.clone()],a=[u.clone(),c.clone(),v.clone(),l.clone()]),E[r].push(x,a));else for(b.push(n),r=0,s=t.faceVertexUvs.length;r<s;r++)E[r].push(t.faceVertexUvs[r][i]);t.faces=b,t.faceVertexUvs=E}},THREE.GeometryUtils.random=THREE.Math.random16,THREE.GeometryUtils.__v1=new THREE.Vector3,THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(t,e,i,o){var n=new Image,r=new THREE.Texture(n,e),e=new THREE.ImageLoader;return e.addEventListener("load",function(t){r.image=t.content,r.needsUpdate=!0,i&&i(r)}),e.addEventListener("error",function(t){o&&o(t.message)}),e.crossOrigin=this.crossOrigin,e.load(t,n),r},loadCompressedTexture:function(t,e,i,o){var n=new THREE.CompressedTexture;n.mapping=e;var r=new XMLHttpRequest;return r.onload=function(){var t=THREE.ImageUtils.parseDDS(r.response,!0);n.format=t.format,n.mipmaps=t.mipmaps,n.image.width=t.width,n.image.height=t.height,n.generateMipmaps=!1,n.needsUpdate=!0,i&&i(n)},r.onerror=o,r.open("GET",t,!0),r.responseType="arraybuffer",r.send(null),n},loadTextureCube:function(t,e,i,o){var n=[];n.loadCount=0;var r=new THREE.Texture;r.image=n,void 0!==e&&(r.mapping=e),r.flipY=!1;for(var e=0,s=t.length;e<s;++e){var a=new Image;n[e]=a,a.onload=function(){n.loadCount=n.loadCount+1,6===n.loadCount&&(r.needsUpdate=!0,i&&i())},a.onerror=o,a.crossOrigin=this.crossOrigin,a.src=t[e]}return r},loadCompressedTextureCube:function(t,e,i,o){var n=[];n.loadCount=0;var r=new THREE.CompressedTexture;r.image=n,void 0!==e&&(r.mapping=e),r.flipY=!1,r.generateMipmaps=!1;for(var e=function(t,e){return function(){var o=THREE.ImageUtils.parseDDS(t.response,!0);e.format=o.format,e.mipmaps=o.mipmaps,e.width=o.width,e.height=o.height,n.loadCount=n.loadCount+1,6===n.loadCount&&(r.format=o.format,r.needsUpdate=!0,i&&i())}},s=0,a=t.length;s<a;++s){var h={};n[s]=h;var l=new XMLHttpRequest;l.onload=e(l,h),l.onerror=o,l.open("GET",t[s],!0),l.responseType="arraybuffer",l.send(null)}return r},parseDDS:function(t,e){function i(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var o={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},n=i("DXT1"),r=i("DXT3"),s=i("DXT5"),a=new Int32Array(t,0,31);if(542327876!==a[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),o;if(4&!a[20])return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),o;var h=a[21];switch(h){case n:n=8,o.format=THREE.RGB_S3TC_DXT1_Format;break;case r:n=16,o.format=THREE.RGBA_S3TC_DXT3_Format;break;case s:n=16,o.format=THREE.RGBA_S3TC_DXT5_Format;break;default:return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",String.fromCharCode(255&h,h>>8&255,h>>16&255,h>>24&255)),o}for(o.mipmapCount=1,131072&a[2]&&!1!==e&&(o.mipmapCount=Math.max(1,a[7])),o.width=a[4],o.height=a[3],a=a[1]+4,r=o.width,s=o.height,h=0;h<o.mipmapCount;h++){var l=Math.max(4,r)/4*Math.max(4,s)/4*n,c={data:new Uint8Array(t,a,l),width:r,height:s};o.mipmaps.push(c),a+=l,r=Math.max(.5*r,1),s=Math.max(.5*s,1)}return o},getNormalMap:function(t,e){var e=1|e,i=t.width,o=t.height,n=document.createElement("canvas");n.width=i,n.height=o;var r=n.getContext("2d");r.drawImage(t,0,0);for(var s=r.getImageData(0,0,i,o).data,a=r.createImageData(i,o),h=a.data,l=0;l<i;l++)for(var c=0;c<o;c++){var u=0>c-1?0:c-1,m=c+1>o-1?o-1:c+1,d=0>l-1?0:l-1,p=l+1>i-1?i-1:l+1,_=[],f=[0,0,s[4*(c*i+l)]/255*e];for(_.push([-1,0,s[4*(c*i+d)]/255*e]),_.push([-1,-1,s[4*(u*i+d)]/255*e]),_.push([0,-1,s[4*(u*i+l)]/255*e]),_.push([1,-1,s[4*(u*i+p)]/255*e]),_.push([1,0,s[4*(c*i+p)]/255*e]),_.push([1,1,s[4*(m*i+p)]/255*e]),_.push([0,1,s[4*(m*i+l)]/255*e]),_.push([-1,1,s[4*(m*i+d)]/255*e]),u=[],d=_.length,m=0;m<d;m++){var p=_[m],y=_[(m+1)%d],p=[p[0]-f[0],p[1]-f[1],p[2]-f[2]],y=[y[0]-f[0],y[1]-f[1],y[2]-f[2]];u.push(function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return[t[0]/e,t[1]/e,t[2]/e]}([p[1]*y[2]-p[2]*y[1],p[2]*y[0]-p[0]*y[2],p[0]*y[1]-p[1]*y[0]]))}for(_=[0,0,0],m=0;m<u.length;m++)_[0]+=u[m][0],_[1]+=u[m][1],_[2]+=u[m][2];_[0]/=u.length,_[1]/=u.length,_[2]/=u.length,f=4*(c*i+l),h[f]=(_[0]+1)/2*255|0,h[f+1]=(_[1]+1)/2*255|0,h[f+2]=255*_[2]|0,h[f+3]=255}return r.putImageData(a,0,0),n},generateDataTexture:function(t,e,i){for(var o=t*e,n=new Uint8Array(3*o),r=Math.floor(255*i.r),s=Math.floor(255*i.g),i=Math.floor(255*i.b),a=0;a<o;a++)n[3*a]=r,n[3*a+1]=s,n[3*a+2]=i;return t=new THREE.DataTexture(n,t,e,THREE.RGBFormat),t.needsUpdate=!0,t}},THREE.SceneUtils={createMultiMaterialObject:function(t,e){for(var i=new THREE.Object3D,o=0,n=e.length;o<n;o++)i.add(new THREE.Mesh(t,e[o]));return i},detach:function(t,e,i){t.applyMatrix(e.matrixWorld),e.remove(t),i.add(t)},attach:function(t,e,i){var o=new THREE.Matrix4;o.getInverse(i.matrixWorld),t.applyMatrix(o),e.remove(t),i.add(t)}},THREE.WebGLRenderer&&(THREE.ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:null}},fragmentShader:"uniform samplerCube tCube;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\nvec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nrefractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;\nrefractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;\nrefractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;\nrefractedColor.a = 1.0;\ngl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );\n}",vertexShader:"uniform float mRefractionRatio;\nuniform float mFresnelBias;\nuniform float mFresnelScale;\nuniform float mFresnelPower;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 mPosition = modelMatrix * vec4( position, 1.0 );\nvec3 nWorld = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );\nvec3 I = mPosition.xyz - cameraPosition;\nvReflect = reflect( I, nWorld );\nvRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );\nvRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );\nvRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );\nvReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );\ngl_Position = projectionMatrix * mvPosition;\n}"},normal:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new THREE.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new THREE.Color(16777215)},uSpecularColor:{type:"c",value:new THREE.Color(1118481)},uAmbientColor:{type:"c",value:new THREE.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),
fragmentShader:["uniform vec3 uAmbientColor;\nuniform vec3 uDiffuseColor;\nuniform vec3 uSpecularColor;\nuniform float uShininess;\nuniform float uOpacity;\nuniform bool enableDiffuse;\nuniform bool enableSpecular;\nuniform bool enableAO;\nuniform bool enableReflection;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tSpecular;\nuniform sampler2D tAO;\nuniform samplerCube tCube;\nuniform vec2 uNormalScale;\nuniform bool useRefract;\nuniform float uRefractionRatio;\nuniform float uReflectivity;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightPosition[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngle[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3( 1.0 ), uOpacity );\nvec3 specularTex = vec3( 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse ) {\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( tDiffuse, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );\n#endif\n}\nif( enableAO ) {\n#ifdef GAMMA_INPUT\nvec4 aoColor = texture2D( tAO, vUv );\naoColor.xyz *= aoColor.xyz;\ngl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;\n#endif\n}\nif( enableSpecular )\nspecularTex = texture2D( tSpecular, vUv ).xyz;\nmat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );\nvec3 finalNormal = tsb * normalTex;\n#ifdef FLIP_SIDED\nfinalNormal = -finalNormal;\n#endif\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 pointVector = lPosition.xyz + vViewPosition.xyz;\nfloat pointDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\npointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );\npointVector = normalize( pointVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\n#endif\npointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;\nvec3 pointHalfVector = normalize( pointVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;\n#else\npointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 spotVector = lPosition.xyz + vViewPosition.xyz;\nfloat spotDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nspotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );\nspotVector = normalize( spotVector );\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngle[ i ] ) {\nspotEffect = pow( spotEffect, spotLightExponent[ i ] );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );\n#endif\nspotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;\nvec3 spotHalfVector = normalize( spotVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;\n#else\nspotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\n#ifdef WRAP_AROUND\nfloat directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );\nfloat directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\n#endif\ndirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n#else\ndirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;\n#endif\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( hemisphereLightPosition[ i ], 1.0 );\nvec3 lVector = normalize( lPosition.xyz + vViewPosition.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += uDiffuseColor * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );\nvec3 lVectorGround = normalize( -lPosition.xyz + vViewPosition.xyz );\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );\n#ifdef PHYSICALLY_BASED_SHADING\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( uShininess + 2.0001 ) / 8.0;\nvec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n#else\nhemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;\n#endif\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;\n#endif\nif ( enableReflection ) {\nvec3 vReflect;\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nvReflect = refract( cameraToVertex, normal, uRefractionRatio );\n} else {\nvReflect = reflect( cameraToVertex, normal );\n}\nvec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );\n}",THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;\nuniform vec2 uOffset;\nuniform vec2 uRepeat;\nuniform bool enableDisplacement;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING\nvNormal = normalMatrix * skinnedNormal.xyz;\nvec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );\nvTangent = normalMatrix * skinnedTangent.xyz;\n#else\nvNormal = normalMatrix * normal;\nvTangent = normalMatrix * tangent.xyz;\n#endif\nvBinormal = cross( vNormal, vTangent ) * tangent.w;\nvUv = uv * uRepeat + uOffset;\nvec3 displacedPosition;\n#ifdef VERTEX_TEXTURES\nif ( enableDisplacement ) {\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\ndisplacedPosition = position + normalize( normal ) * df;\n} else {\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n}\n#else\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned \t  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n#endif\nvec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );\nvec4 mPosition = modelMatrix * vec4( displacedPosition, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\nvWorldPosition = mPosition.xyz;\nvViewPosition = -mvPosition.xyz;\n#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * mPosition;\n}\n#endif\n}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:"varying vec3 vViewPosition;\nvoid main() {\nvec4 mPosition = modelMatrix * vec4( position, 1.0 );\nvViewPosition = cameraPosition - mPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform samplerCube tCube;\nuniform float tFlip;\nvarying vec3 vViewPosition;\nvoid main() {\nvec3 wPos = cameraPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( tFlip * wPos.x, wPos.yz ) );\n}"}}}),THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(t){var e=t.familyName.toLowerCase();return this.faces[e]=this.faces[e]||{},this.faces[e][t.cssFontWeight]=this.faces[e][t.cssFontWeight]||{},this.faces[e][t.cssFontWeight][t.cssFontStyle]=t,this.faces[e][t.cssFontWeight][t.cssFontStyle]=t},drawText:function(t){for(var e=this.getFace(),i=this.size/e.resolution,o=0,n=String(t).split(""),r=n.length,s=[],t=0;t<r;t++){var a=new THREE.Path,a=this.extractGlyphPoints(n[t],e,i,o,a),o=o+a.offset;s.push(a.path)}return{paths:s,offset:o/2}},extractGlyphPoints:function(t,e,i,o,n){var r,s,a,h,l,c,u,m,d,p,_,f=[],y=e.glyphs[t]||e.glyphs["?"];if(y){if(y.o)for(e=y._cachedOutline||(y._cachedOutline=y.o.split(" ")),h=e.length,t=0;t<h;)switch(a=e[t++]){case"m":a=e[t++]*i+o,l=e[t++]*i,n.moveTo(a,l);break;case"l":a=e[t++]*i+o,l=e[t++]*i,n.lineTo(a,l);break;case"q":if(a=e[t++]*i+o,l=e[t++]*i,m=e[t++]*i+o,d=e[t++]*i,n.quadraticCurveTo(m,d,a,l),r=f[f.length-1])for(c=r.x,u=r.y,r=1,s=this.divisions;r<=s;r++){var g=r/s;THREE.Shape.Utils.b2(g,c,m,a),THREE.Shape.Utils.b2(g,u,d,l)}break;case"b":if(a=e[t++]*i+o,l=e[t++]*i,m=e[t++]*i+o,d=e[t++]*-i,p=e[t++]*i+o,_=e[t++]*-i,n.bezierCurveTo(a,l,m,d,p,_),r=f[f.length-1])for(c=r.x,u=r.y,r=1,s=this.divisions;r<=s;r++)g=r/s,THREE.Shape.Utils.b3(g,c,m,p,a),THREE.Shape.Utils.b3(g,u,d,_,l)}return{offset:y.ha*i,path:n}}}},THREE.FontUtils.generateShapes=function(t,e){var e=e||{},i=void 0!==e.curveSegments?e.curveSegments:4,o=void 0!==e.font?e.font:"helvetiker",n=void 0!==e.weight?e.weight:"normal",r=void 0!==e.style?e.style:"normal";for(THREE.FontUtils.size=void 0!==e.size?e.size:100,THREE.FontUtils.divisions=i,THREE.FontUtils.face=o,THREE.FontUtils.weight=n,THREE.FontUtils.style=r,i=THREE.FontUtils.drawText(t).paths,o=[],n=0,r=i.length;n<r;n++)Array.prototype.push.apply(o,i[n].toShapes());return o},function(t){var e=function(t){for(var e=t.length,i=0,o=e-1,n=0;n<e;o=n++)i+=t[o].x*t[n].y-t[n].x*t[o].y;return.5*i};t.Triangulate=function(t,i){var o=t.length;if(o<3)return null;var n,r,s,a=[],h=[],l=[];if(e(t)>0)for(r=0;r<o;r++)h[r]=r;else for(r=0;r<o;r++)h[r]=o-1-r;var c=2*o;for(r=o-1;o>2;){if(c--<=0){console.log("Warning, unable to triangulate polygon!");break}n=r,o<=n&&(n=0),r=n+1,o<=r&&(r=0),s=r+1,o<=s&&(s=0);var u;t:{u=t;var m=n,d=r,p=s,_=o,f=h,y=void 0,g=void 0,v=void 0,x=void 0,b=void 0,E=void 0,T=void 0,w=void 0,S=void 0,g=u[f[m]].x,v=u[f[m]].y,x=u[f[d]].x,b=u[f[d]].y,E=u[f[p]].x,T=u[f[p]].y;if(1e-10>(x-g)*(T-v)-(b-v)*(E-g))u=!1;else{for(y=0;y<_;y++)if(y!=m&&y!=d&&y!=p){var w=u[f[y]].x,S=u[f[y]].y,C=void 0,R=void 0,M=void 0,D=void 0,A=void 0,B=void 0,I=void 0,H=void 0,P=void 0,L=void 0,V=void 0,k=void 0,C=M=A=void 0,C=E-x,R=T-b,M=g-E,D=v-T,A=x-g,B=b-v,I=w-g,H=S-v,P=w-x,L=S-b,V=w-E,k=S-T,C=C*L-R*P,A=A*H-B*I,M=M*k-D*V;if(C>=0&&M>=0&&A>=0){u=!1;break t}}u=!0}}if(u){for(a.push([t[h[n]],t[h[r]],t[h[s]]]),l.push([h[n],h[r],h[s]]),n=r,s=r+1;s<o;n++,s++)h[n]=h[s];o--,c=2*o}}return i?l:a},t.Triangulate.area=e}(THREE.FontUtils),self._typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace},THREE.Curve=function(){},THREE.Curve.prototype.getPoint=function(){return console.log("Warning, getPoint() not implemented!"),null},THREE.Curve.prototype.getPointAt=function(t){return t=this.getUtoTmapping(t),this.getPoint(t)},THREE.Curve.prototype.getPoints=function(t){t||(t=5);var e,i=[];for(e=0;e<=t;e++)i.push(this.getPoint(e/t));return i},THREE.Curve.prototype.getSpacedPoints=function(t){t||(t=5);var e,i=[];for(e=0;e<=t;e++)i.push(this.getPointAt(e/t));return i},THREE.Curve.prototype.getLength=function(){var t=this.getLengths();return t[t.length-1]},THREE.Curve.prototype.getLengths=function(t){if(t||(t=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,i,o=[],n=this.getPoint(0),r=0;for(o.push(0),i=1;i<=t;i++)e=this.getPoint(i/t),r+=e.distanceTo(n),o.push(r),n=e;return this.cacheArcLengths=o},THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},THREE.Curve.prototype.getUtoTmapping=function(t,e){var i,o=this.getLengths(),n=0,r=o.length;i=e||t*o[r-1];for(var s,a=0,h=r-1;a<=h;)if(n=Math.floor(a+(h-a)/2),(s=o[n]-i)<0)a=n+1;else{if(!(s>0)){h=n;break}h=n-1}return n=h,o[n]==i?n/(r-1):(a=o[n],o=(n+(i-a)/(o[n+1]-a))/(r-1))},THREE.Curve.prototype.getNormalVector=function(t){return t=this.getTangent(t),new THREE.Vector2(-t.y,t.x)},THREE.Curve.prototype.getTangent=function(t){var e=t-1e-4,t=t+1e-4;return e<0&&(e=0),t>1&&(t=1),e=this.getPoint(e),this.getPoint(t).clone().subSelf(e).normalize()},THREE.Curve.prototype.getTangentAt=function(t){return t=this.getUtoTmapping(t),this.getTangent(t)},THREE.LineCurve=function(t,e){this.v1=t,this.v2=e},THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.LineCurve.prototype.getPoint=function(t){var e=this.v2.clone().subSelf(this.v1);return e.multiplyScalar(t).addSelf(this.v1),e},THREE.LineCurve.prototype.getPointAt=function(t){return this.getPoint(t)},THREE.LineCurve.prototype.getTangent=function(){return this.v2.clone().subSelf(this.v1).normalize()},THREE.QuadraticBezierCurve=function(t,e,i){this.v0=t,this.v1=e,this.v2=i},THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.QuadraticBezierCurve.prototype.getPoint=function(t){var e;return e=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),t=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),new THREE.Vector2(e,t)},THREE.QuadraticBezierCurve.prototype.getTangent=function(t){var e;return e=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x),t=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y),e=new THREE.Vector2(e,t),e.normalize(),e},THREE.CubicBezierCurve=function(t,e,i,o){this.v0=t,this.v1=e,this.v2=i,this.v3=o},THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.CubicBezierCurve.prototype.getPoint=function(t){var e;return e=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new THREE.Vector2(e,t)},THREE.CubicBezierCurve.prototype.getTangent=function(t){var e;return e=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),e=new THREE.Vector2(e,t),e.normalize(),e},THREE.SplineCurve=function(t){this.points=void 0==t?[]:t},THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.SplineCurve.prototype.getPoint=function(t){var e,i=new THREE.Vector2,o=[],n=this.points;return e=(n.length-1)*t,t=Math.floor(e),e-=t,o[0]=0==t?t:t-1,o[1]=t,o[2]=t>n.length-2?n.length-1:t+1,o[3]=t>n.length-3?n.length-1:t+2,i.x=THREE.Curve.Utils.interpolate(n[o[0]].x,n[o[1]].x,n[o[2]].x,n[o[3]].x,e),i.y=THREE.Curve.Utils.interpolate(n[o[0]].y,n[o[1]].y,n[o[2]].y,n[o[3]].y,e),i},THREE.EllipseCurve=function(t,e,i,o,n,r,s){this.aX=t,this.aY=e,this.xRadius=i,this.yRadius=o,this.aStartAngle=n,this.aEndAngle=r,this.aClockwise=s},THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype),THREE.EllipseCurve.prototype.getPoint=function(t){var e=this.aEndAngle-this.aStartAngle;return this.aClockwise||(t=1-t),e=this.aStartAngle+t*e,t=this.aX+this.xRadius*Math.cos(e),e=this.aY+this.yRadius*Math.sin(e),new THREE.Vector2(t,e)},THREE.ArcCurve=function(t,e,i,o,n,r){THREE.EllipseCurve.call(this,t,e,i,i,o,n,r)},THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype),THREE.Curve.Utils={tangentQuadraticBezier:function(t,e,i,o){return 2*(1-t)*(i-e)+2*t*(o-i)},tangentCubicBezier:function(t,e,i,o,n){return-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*o*(1-t)-3*t*t*o+3*t*t*n},tangentSpline:function(t){return 6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t)},interpolate:function(t,e,i,o,n){var t=.5*(i-t),o=.5*(o-e),r=n*n;return(2*e-2*i+t+o)*n*r+(-3*e+3*i-2*t-o)*r+t*n+e}},THREE.Curve.create=function(t,e){return t.prototype=Object.create(THREE.Curve.prototype),t.prototype.getPoint=e,t},THREE.LineCurve3=THREE.Curve.create(function(t,e){this.v1=t,this.v2=e},function(t){var e=new THREE.Vector3;return e.sub(this.v2,this.v1),e.multiplyScalar(t),e.addSelf(this.v1),e}),THREE.QuadraticBezierCurve3=THREE.Curve.create(function(t,e,i){this.v0=t,this.v1=e,this.v2=i},function(t){var e,i;return e=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x),i=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y),t=THREE.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z),new THREE.Vector3(e,i,t)}),THREE.CubicBezierCurve3=THREE.Curve.create(function(t,e,i,o){this.v0=t,this.v1=e,this.v2=i,this.v3=o},function(t){var e,i;return e=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x),i=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y),t=THREE.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new THREE.Vector3(e,i,t)}),THREE.SplineCurve3=THREE.Curve.create(function(t){this.points=void 0==t?[]:t},function(t){var e,i=new THREE.Vector3,o=[],n=this.points,t=(n.length-1)*t;e=Math.floor(t),t-=e,o[0]=0==e?e:e-1,o[1]=e,o[2]=e>n.length-2?n.length-1:e+1,o[3]=e>n.length-3?n.length-1:e+2,e=n[o[0]];var r=n[o[1]],s=n[o[2]],o=n[o[3]];return i.x=THREE.Curve.Utils.interpolate(e.x,r.x,s.x,o.x,t),i.y=THREE.Curve.Utils.interpolate(e.y,r.y,s.y,o.y,t),i.z=THREE.Curve.Utils.interpolate(e.z,r.z,s.z,o.z,t),i}),THREE.ClosedSplineCurve3=THREE.Curve.create(function(t){this.points=void 0==t?[]:t},function(t){var e,i=new THREE.Vector3,o=[],n=this.points;return e=(n.length-0)*t,t=Math.floor(e),e-=t,t+=t>0?0:(Math.floor(Math.abs(t)/n.length)+1)*n.length,o[0]=(t-1)%n.length,o[1]=t%n.length,o[2]=(t+1)%n.length,o[3]=(t+2)%n.length,i.x=THREE.Curve.Utils.interpolate(n[o[0]].x,n[o[1]].x,n[o[2]].x,n[o[3]].x,e),i.y=THREE.Curve.Utils.interpolate(n[o[0]].y,n[o[1]].y,n[o[2]].y,n[o[3]].y,e),i.z=THREE.Curve.Utils.interpolate(n[o[0]].z,n[o[1]].z,n[o[2]].z,n[o[3]].z,e),i}),THREE.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype),THREE.CurvePath.prototype.add=function(t){this.curves.push(t)},THREE.CurvePath.prototype.checkConnection=function(){},THREE.CurvePath.prototype.closePath=function(){var t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new THREE.LineCurve(e,t))},THREE.CurvePath.prototype.getPoint=function(t){for(var e=t*this.getLength(),i=this.getCurveLengths(),t=0;t<i.length;){if(i[t]>=e)return e=i[t]-e,t=this.curves[t],e=1-e/t.getLength(),t.getPointAt(e);t++}return null},THREE.CurvePath.prototype.getLength=function(){var t=this.getCurveLengths();return t[t.length-1]},THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var t,e=[],i=0,o=this.curves.length;for(t=0;t<o;t++)i+=this.curves[t].getLength(),e.push(i);return this.cacheLengths=e},THREE.CurvePath.prototype.getBoundingBox=function(){var t,e,i,o,n,r,s=this.getPoints();t=e=Number.NEGATIVE_INFINITY,o=n=Number.POSITIVE_INFINITY;var a,h,l,c,u=s[0]instanceof THREE.Vector3;for(c=u?new THREE.Vector3:new THREE.Vector2,h=0,l=s.length;h<l;h++)a=s[h],a.x>t?t=a.x:a.x<o&&(o=a.x),a.y>e?e=a.y:a.y<n&&(n=a.y),u&&(a.z>i?i=a.z:a.z<r&&(r=a.z)),c.addSelf(a);return s={minX:o,minY:n,maxX:t,maxY:e,centroid:c.divideScalar(l)},u&&(s.maxZ=i,s.minZ=r),s},THREE.CurvePath.prototype.createPointsGeometry=function(t){return t=this.getPoints(t,!0),this.createGeometry(t)},THREE.CurvePath.prototype.createSpacedPointsGeometry=function(t){return t=this.getSpacedPoints(t,!0),this.createGeometry(t)},THREE.CurvePath.prototype.createGeometry=function(t){for(var e=new THREE.Geometry,i=0;i<t.length;i++)e.vertices.push(new THREE.Vector3(t[i].x,t[i].y,t[i].z||0));return e},THREE.CurvePath.prototype.addWrapPath=function(t){this.bends.push(t)},THREE.CurvePath.prototype.getTransformedPoints=function(t,e){var i,o,n=this.getPoints(t);for(e||(e=this.bends),i=0,o=e.length;i<o;i++)n=this.getWrapPoints(n,e[i]);return n},THREE.CurvePath.prototype.getTransformedSpacedPoints=function(t,e){var i,o,n=this.getSpacedPoints(t);for(e||(e=this.bends),i=0,o=e.length;i<o;i++)n=this.getWrapPoints(n,e[i]);return n},THREE.CurvePath.prototype.getWrapPoints=function(t,e){var i,o,n,r,s,a,h=this.getBoundingBox();for(i=0,o=t.length;i<o;i++)n=t[i],r=n.x,s=n.y,a=r/h.maxX,a=e.getUtoTmapping(a,r),r=e.getPoint(a),s=e.getNormalVector(a).multiplyScalar(s),n.x=r.x+s.x,n.y=r.y+s.y;return t},THREE.Gyroscope=function(){THREE.Object3D.call(this)},THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype),THREE.Gyroscope.prototype.updateMatrixWorld=function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.parent?(this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.rotationObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=0,i=this.children.length;e<i;e++)this.children[e].updateMatrixWorld(t)},THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3,THREE.Gyroscope.prototype.translationObject=new THREE.Vector3,THREE.Gyroscope.prototype.rotationWorld=new THREE.Quaternion,THREE.Gyroscope.prototype.rotationObject=new THREE.Quaternion,THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3,THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3,THREE.Path=function(t){THREE.CurvePath.call(this),this.actions=[],t&&this.fromPoints(t)},THREE.Path.prototype=Object.create(THREE.CurvePath.prototype),THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},THREE.Path.prototype.fromPoints=function(t){this.moveTo(t[0].x,t[0].y);for(var e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y)},THREE.Path.prototype.moveTo=function(t,e){var i=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:i})},THREE.Path.prototype.lineTo=function(t,e){var i=Array.prototype.slice.call(arguments),o=this.actions[this.actions.length-1].args,o=new THREE.LineCurve(new THREE.Vector2(o[o.length-2],o[o.length-1]),new THREE.Vector2(t,e));this.curves.push(o),this.actions.push({action:THREE.PathActions.LINE_TO,args:i})},THREE.Path.prototype.quadraticCurveTo=function(t,e,i,o){var n=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,r=new THREE.QuadraticBezierCurve(new THREE.Vector2(r[r.length-2],r[r.length-1]),new THREE.Vector2(t,e),new THREE.Vector2(i,o));this.curves.push(r),this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:n})},THREE.Path.prototype.bezierCurveTo=function(t,e,i,o,n,r){var s=Array.prototype.slice.call(arguments),a=this.actions[this.actions.length-1].args,a=new THREE.CubicBezierCurve(new THREE.Vector2(a[a.length-2],a[a.length-1]),new THREE.Vector2(t,e),new THREE.Vector2(i,o),new THREE.Vector2(n,r));this.curves.push(a),this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:s})},THREE.Path.prototype.splineThru=function(t){var e=Array.prototype.slice.call(arguments),i=this.actions[this.actions.length-1].args,i=[new THREE.Vector2(i[i.length-2],i[i.length-1])];Array.prototype.push.apply(i,t),i=new THREE.SplineCurve(i),this.curves.push(i),this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:e})},THREE.Path.prototype.arc=function(t,e,i,o,n,r){var s=this.actions[this.actions.length-1].args;this.absarc(t+s[s.length-2],e+s[s.length-1],i,o,n,r)},THREE.Path.prototype.absarc=function(t,e,i,o,n,r){this.absellipse(t,e,i,i,o,n,r)},THREE.Path.prototype.ellipse=function(t,e,i,o,n,r,s){var a=this.actions[this.actions.length-1].args;this.absellipse(t+a[a.length-2],e+a[a.length-1],i,o,n,r,s)},THREE.Path.prototype.absellipse=function(t,e,i,o,n,r,s){var a=Array.prototype.slice.call(arguments),h=new THREE.EllipseCurve(t,e,i,o,n,r,s);this.curves.push(h),h=h.getPoint(s?1:0),a.push(h.x),a.push(h.y),this.actions.push({action:THREE.PathActions.ELLIPSE,args:a})},THREE.Path.prototype.getSpacedPoints=function(t){t||(t=40);for(var e=[],i=0;i<t;i++)e.push(this.getPoint(i/t));return e},THREE.Path.prototype.getPoints=function(t,e){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(t,e);var i,o,n,r,s,a,h,l,c,u,m,d,p,t=t||12,_=[];for(i=0,o=this.actions.length;i<o;i++)switch(n=this.actions[i],r=n.action,n=n.args,r){case THREE.PathActions.MOVE_TO:case THREE.PathActions.LINE_TO:_.push(new THREE.Vector2(n[0],n[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:for(s=n[2],a=n[3],c=n[0],u=n[1],_.length>0?(r=_[_.length-1],m=r.x,d=r.y):(r=this.actions[i-1].args,m=r[r.length-2],d=r[r.length-1]),n=1;n<=t;n++)p=n/t,r=THREE.Shape.Utils.b2(p,m,c,s),p=THREE.Shape.Utils.b2(p,d,u,a),_.push(new THREE.Vector2(r,p));break;case THREE.PathActions.BEZIER_CURVE_TO:for(s=n[4],a=n[5],c=n[0],u=n[1],h=n[2],l=n[3],_.length>0?(r=_[_.length-1],m=r.x,d=r.y):(r=this.actions[i-1].args,m=r[r.length-2],d=r[r.length-1]),n=1;n<=t;n++)p=n/t,r=THREE.Shape.Utils.b3(p,m,c,h,s),p=THREE.Shape.Utils.b3(p,d,u,l,a),_.push(new THREE.Vector2(r,p));break;case THREE.PathActions.CSPLINE_THRU:for(r=this.actions[i-1].args,p=[new THREE.Vector2(r[r.length-2],r[r.length-1])],r=t*n[0].length,p=p.concat(n[0]),p=new THREE.SplineCurve(p),n=1;n<=r;n++)_.push(p.getPointAt(n/r));break;case THREE.PathActions.ARC:for(s=n[0],a=n[1],u=n[2],h=n[3],r=n[4],c=!!n[5],m=r-h,d=2*t,n=1;n<=d;n++)p=n/d,c||(p=1-p),p=h+p*m,r=s+u*Math.cos(p),p=a+u*Math.sin(p),_.push(new THREE.Vector2(r,p));break;case THREE.PathActions.ELLIPSE:for(s=n[0],a=n[1],u=n[2],l=n[3],h=n[4],r=n[5],c=!!n[6],m=r-h,d=2*t,n=1;n<=d;n++)p=n/d,c||(p=1-p),p=h+p*m,r=s+u*Math.cos(p),p=a+l*Math.sin(p),_.push(new THREE.Vector2(r,p))}return i=_[_.length-1],Math.abs(i.x-_[0].x)<1e-10&&Math.abs(i.y-_[0].y)<1e-10&&_.splice(_.length-1,1),e&&_.push(_[0]),_},THREE.Path.prototype.toShapes=function(){var t,e,i,o,n=[],r=new THREE.Path;for(t=0,e=this.actions.length;t<e;t++)i=this.actions[t],o=i.args,i=i.action,i==THREE.PathActions.MOVE_TO&&0!=r.actions.length&&(n.push(r),r=new THREE.Path),r[i].apply(r,o);if(0!=r.actions.length&&n.push(r),0==n.length)return[];var s;if(o=[],
t=!THREE.Shape.Utils.isClockWise(n[0].getPoints()),1==n.length)return r=n[0],s=new THREE.Shape,s.actions=r.actions,s.curves=r.curves,o.push(s),o;if(t)for(s=new THREE.Shape,t=0,e=n.length;t<e;t++)r=n[t],THREE.Shape.Utils.isClockWise(r.getPoints())?(s.actions=r.actions,s.curves=r.curves,o.push(s),s=new THREE.Shape):s.holes.push(r);else{for(t=0,e=n.length;t<e;t++)r=n[t],THREE.Shape.Utils.isClockWise(r.getPoints())?(s&&o.push(s),s=new THREE.Shape,s.actions=r.actions,s.curves=r.curves):s.holes.push(r);o.push(s)}return o},THREE.Shape=function(){THREE.Path.apply(this,arguments),this.holes=[]},THREE.Shape.prototype=Object.create(THREE.Path.prototype),THREE.Shape.prototype.extrude=function(t){return new THREE.ExtrudeGeometry(this,t)},THREE.Shape.prototype.makeGeometry=function(t){return new THREE.ShapeGeometry(this,t)},THREE.Shape.prototype.getPointsHoles=function(t){var e,i=this.holes.length,o=[];for(e=0;e<i;e++)o[e]=this.holes[e].getTransformedPoints(t,this.bends);return o},THREE.Shape.prototype.getSpacedPointsHoles=function(t){var e,i=this.holes.length,o=[];for(e=0;e<i;e++)o[e]=this.holes[e].getTransformedSpacedPoints(t,this.bends);return o},THREE.Shape.prototype.extractAllPoints=function(t){return{shape:this.getTransformedPoints(t),holes:this.getPointsHoles(t)}};THREE.Shape.prototype.extractPoints=function(t){return this.useSpacedPoints?this.extractAllSpacedPoints(t):this.extractAllPoints(t)},THREE.Shape.prototype.extractAllSpacedPoints=function(t){return{shape:this.getTransformedSpacedPoints(t),holes:this.getSpacedPointsHoles(t)}},THREE.Shape.Utils={removeHoles:function(t,e){var i,o,n,r,s,a,h,l,c,u,m=t.concat(),d=m.concat(),p=[];for(s=0;s<e.length;s++){for(a=e[s],Array.prototype.push.apply(d,a),o=Number.POSITIVE_INFINITY,i=0;i<a.length;i++)for(c=a[i],u=[],l=0;l<m.length;l++)h=m[l],h=c.distanceToSquared(h),u.push(h),h<o&&(o=h,n=i,r=l);i=r-1>=0?r-1:m.length-1,o=n-1>=0?n-1:a.length-1;var _=[a[n],m[r],m[i]];l=THREE.FontUtils.Triangulate.area(_);var f=[a[n],a[o],m[r]];c=THREE.FontUtils.Triangulate.area(f),u=r,h=n,r+=1,n+=-1,r<0&&(r+=m.length),r%=m.length,n<0&&(n+=a.length),n%=a.length,i=r-1>=0?r-1:m.length-1,o=n-1>=0?n-1:a.length-1,_=[a[n],m[r],m[i]],_=THREE.FontUtils.Triangulate.area(_),f=[a[n],a[o],m[r]],f=THREE.FontUtils.Triangulate.area(f),l+c>_+f&&(r=u,n=h,r<0&&(r+=m.length),r%=m.length,n<0&&(n+=a.length),n%=a.length,i=r-1>=0?r-1:m.length-1,o=n-1>=0?n-1:a.length-1),l=m.slice(0,r),c=m.slice(r),u=a.slice(n),h=a.slice(0,n),o=[a[n],a[o],m[r]],p.push([a[n],m[r],m[i]]),p.push(o),m=l.concat(u).concat(h).concat(c)}return{shape:m,isolatedPts:p,allpoints:d}},triangulateShape:function(t,e){var i,o,n,r,s=THREE.Shape.Utils.removeHoles(t,e),a=s.allpoints,h=s.isolatedPts,s=THREE.FontUtils.Triangulate(s.shape,!1),l={};for(i=0,o=a.length;i<o;i++)r=a[i].x+":"+a[i].y,void 0!==l[r]&&console.log("Duplicate point",r),l[r]=i;for(i=0,o=s.length;i<o;i++)for(n=s[i],a=0;a<3;a++)r=n[a].x+":"+n[a].y,void 0!==(r=l[r])&&(n[a]=r);for(i=0,o=h.length;i<o;i++)for(n=h[i],a=0;a<3;a++)r=n[a].x+":"+n[a].y,void 0!==(r=l[r])&&(n[a]=r);return s.concat(h)},isClockWise:function(t){return THREE.FontUtils.Triangulate.area(t)<0},b2p0:function(t,e){var i=1-t;return i*i*e},b2p1:function(t,e){return 2*(1-t)*t*e},b2p2:function(t,e){return t*t*e},b2:function(t,e,i,o){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,o)},b3p0:function(t,e){var i=1-t;return i*i*i*e},b3p1:function(t,e){var i=1-t;return 3*i*i*t*e},b3p2:function(t,e){return 3*(1-t)*t*t*e},b3p3:function(t,e){return t*t*t*e},b3:function(t,e,i,o,n){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,o)+this.b3p3(t,n)}},THREE.AnimationHandler=function(){var t=[],e={},i={update:function(e){for(var i=0;i<t.length;i++)t[i].update(e)},addToUpdate:function(e){-1===t.indexOf(e)&&t.push(e)},removeFromUpdate:function(e){-1!==(e=t.indexOf(e))&&t.splice(e,1)},add:function(t){if(void 0!==e[t.name]&&console.log("THREE.AnimationHandler.add: Warning! "+t.name+" already exists in library. Overwriting."),e[t.name]=t,!0!==t.initialized){for(var i=0;i<t.hierarchy.length;i++){for(var o=0;o<t.hierarchy[i].keys.length;o++)if(t.hierarchy[i].keys[o].time<0&&(t.hierarchy[i].keys[o].time=0),void 0!==t.hierarchy[i].keys[o].rot&&!(t.hierarchy[i].keys[o].rot instanceof THREE.Quaternion)){var n=t.hierarchy[i].keys[o].rot;t.hierarchy[i].keys[o].rot=new THREE.Quaternion(n[0],n[1],n[2],n[3])}if(t.hierarchy[i].keys.length&&void 0!==t.hierarchy[i].keys[0].morphTargets){for(n={},o=0;o<t.hierarchy[i].keys.length;o++)for(var r=0;r<t.hierarchy[i].keys[o].morphTargets.length;r++){var s=t.hierarchy[i].keys[o].morphTargets[r];n[s]=-1}for(t.hierarchy[i].usedMorphTargets=n,o=0;o<t.hierarchy[i].keys.length;o++){var a={};for(s in n){for(r=0;r<t.hierarchy[i].keys[o].morphTargets.length;r++)if(t.hierarchy[i].keys[o].morphTargets[r]===s){a[s]=t.hierarchy[i].keys[o].morphTargetsInfluences[r];break}r===t.hierarchy[i].keys[o].morphTargets.length&&(a[s]=0)}t.hierarchy[i].keys[o].morphTargetsInfluences=a}}for(o=1;o<t.hierarchy[i].keys.length;o++)t.hierarchy[i].keys[o].time===t.hierarchy[i].keys[o-1].time&&(t.hierarchy[i].keys.splice(o,1),o--);for(o=0;o<t.hierarchy[i].keys.length;o++)t.hierarchy[i].keys[o].index=o}for(o=parseInt(t.length*t.fps,10),t.JIT={},t.JIT.hierarchy=[],i=0;i<t.hierarchy.length;i++)t.JIT.hierarchy.push(Array(o));t.initialized=!0}},get:function(t){if("string"==typeof t)return e[t]?e[t]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+t),null)},parse:function(t){var e=[];if(t instanceof THREE.SkinnedMesh)for(var i=0;i<t.bones.length;i++)e.push(t.bones[i]);else o(t,e);return e}},o=function(t,e){e.push(t);for(var i=0;i<t.children.length;i++)o(t.children[i],e)};return i.LINEAR=0,i.CATMULLROM=1,i.CATMULLROM_FORWARD=2,i}(),THREE.Animation=function(t,e,i){this.root=t,this.data=THREE.AnimationHandler.get(e),this.hierarchy=THREE.AnimationHandler.parse(t),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.loop=this.isPaused=!0,this.interpolationType=void 0!==i?i:THREE.AnimationHandler.LINEAR,this.points=[],this.target=new THREE.Vector3},THREE.Animation.prototype.play=function(t,e){if(!1===this.isPlaying){this.isPlaying=!0,this.loop=void 0===t||t,this.currentTime=void 0!==e?e:0;var i,o,n=this.hierarchy.length;for(i=0;i<n;i++){o=this.hierarchy[i],this.interpolationType!==THREE.AnimationHandler.CATMULLROM_FORWARD&&(o.useQuaternion=!0),o.matrixAutoUpdate=!0,void 0===o.animationCache&&(o.animationCache={},o.animationCache.prevKey={pos:0,rot:0,scl:0},o.animationCache.nextKey={pos:0,rot:0,scl:0},o.animationCache.originalMatrix=o instanceof THREE.Bone?o.skinMatrix:o.matrix);var r=o.animationCache.prevKey;o=o.animationCache.nextKey,r.pos=this.data.hierarchy[i].keys[0],r.rot=this.data.hierarchy[i].keys[0],r.scl=this.data.hierarchy[i].keys[0],o.pos=this.getNextKeyWith("pos",i,1),o.rot=this.getNextKeyWith("rot",i,1),o.scl=this.getNextKeyWith("scl",i,1)}this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.Animation.prototype.pause=function(){!0===this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.Animation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,THREE.AnimationHandler.removeFromUpdate(this)},THREE.Animation.prototype.update=function(t){if(!1!==this.isPlaying){var e,i,o,n,r,s,a,h,l,c=["pos","rot","scl"];l=this.currentTime=this.currentTime+t*this.timeScale,h=this.currentTime=this.currentTime%this.data.length,parseInt(Math.min(h*this.data.fps,this.data.length*this.data.fps),10);for(var u=0,m=this.hierarchy.length;u<m;u++){t=this.hierarchy[u],a=t.animationCache;for(var d=0;d<3;d++){if(e=c[d],r=a.prevKey[e],s=a.nextKey[e],s.time<=l){if(h<l){if(!this.loop)return void this.stop();for(r=this.data.hierarchy[u].keys[0],s=this.getNextKeyWith(e,u,1);s.time<h;)r=s,s=this.getNextKeyWith(e,u,s.index+1)}else do{r=s,s=this.getNextKeyWith(e,u,s.index+1)}while(s.time<h);a.prevKey[e]=r,a.nextKey[e]=s}t.matrixAutoUpdate=!0,t.matrixWorldNeedsUpdate=!0,i=(h-r.time)/(s.time-r.time),o=r[e],n=s[e],(i<0||i>1)&&(console.log("THREE.Animation.update: Warning! Scale out of bounds:"+i+" on bone "+u),i=i<0?0:1),"pos"===e?(e=t.position,this.interpolationType===THREE.AnimationHandler.LINEAR?(e.x=o[0]+(n[0]-o[0])*i,e.y=o[1]+(n[1]-o[1])*i,e.z=o[2]+(n[2]-o[2])*i):this.interpolationType!==THREE.AnimationHandler.CATMULLROM&&this.interpolationType!==THREE.AnimationHandler.CATMULLROM_FORWARD||(this.points[0]=this.getPrevKeyWith("pos",u,r.index-1).pos,this.points[1]=o,this.points[2]=n,this.points[3]=this.getNextKeyWith("pos",u,s.index+1).pos,i=.33*i+.33,o=this.interpolateCatmullRom(this.points,i),e.x=o[0],e.y=o[1],e.z=o[2],this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD&&(i=this.interpolateCatmullRom(this.points,1.01*i),this.target.set(i[0],i[1],i[2]),this.target.subSelf(e),this.target.y=0,this.target.normalize(),i=Math.atan2(this.target.x,this.target.z),t.rotation.set(0,i,0)))):"rot"===e?THREE.Quaternion.slerp(o,n,t.quaternion,i):"scl"===e&&(e=t.scale,e.x=o[0]+(n[0]-o[0])*i,e.y=o[1]+(n[1]-o[1])*i,e.z=o[2]+(n[2]-o[2])*i)}}}},THREE.Animation.prototype.interpolateCatmullRom=function(t,e){var i,o,n,r,s,a,h=[],l=[];return i=(t.length-1)*e,o=Math.floor(i),i-=o,h[0]=0===o?o:o-1,h[1]=o,h[2]=o>t.length-2?o:o+1,h[3]=o>t.length-3?o:o+2,o=t[h[0]],r=t[h[1]],s=t[h[2]],a=t[h[3]],h=i*i,n=i*h,l[0]=this.interpolate(o[0],r[0],s[0],a[0],i,h,n),l[1]=this.interpolate(o[1],r[1],s[1],a[1],i,h,n),l[2]=this.interpolate(o[2],r[2],s[2],a[2],i,h,n),l},THREE.Animation.prototype.interpolate=function(t,e,i,o,n,r,s){return t=.5*(i-t),o=.5*(o-e),(2*(e-i)+t+o)*s+(-3*(e-i)-2*t-o)*r+t*n+e},THREE.Animation.prototype.getNextKeyWith=function(t,e,i){for(var o=this.data.hierarchy[e].keys,i=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?i<o.length-1?i:o.length-1:i%o.length;i<o.length;i++)if(void 0!==o[i][t])return o[i];return this.data.hierarchy[e].keys[0]},THREE.Animation.prototype.getPrevKeyWith=function(t,e,i){for(var o=this.data.hierarchy[e].keys,i=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?i>0?i:0:i>=0?i:i+o.length;i>=0;i--)if(void 0!==o[i][t])return o[i];return this.data.hierarchy[e].keys[o.length-1]},THREE.KeyFrameAnimation=function(t,e,i){for(this.root=t,this.data=THREE.AnimationHandler.get(e),this.hierarchy=THREE.AnimationHandler.parse(t),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.loop=this.isPaused=!0,this.JITCompile=void 0===i||i,t=0,e=this.hierarchy.length;t<e;t++){var i=this.data.hierarchy[t].sids,o=this.hierarchy[t];if(this.data.hierarchy[t].keys.length&&i){for(var n=0;n<i.length;n++){var r=i[n],s=this.getNextKeyWith(r,t,0);s&&s.apply(r)}o.matrixAutoUpdate=!1,this.data.hierarchy[t].node.updateMatrix(),o.matrixWorldNeedsUpdate=!0}}},THREE.KeyFrameAnimation.prototype.play=function(t,e){if(!this.isPlaying){this.isPlaying=!0,this.loop=void 0===t||t,this.currentTime=void 0!==e?e:0,this.startTimeMs=e,this.startTime=1e7,this.endTime=-this.startTime;var i,o,n,r=this.hierarchy.length;for(i=0;i<r;i++)o=this.hierarchy[i],n=this.data.hierarchy[i],o.useQuaternion=!0,void 0===n.animationCache&&(n.animationCache={},n.animationCache.prevKey=null,n.animationCache.nextKey=null,n.animationCache.originalMatrix=o instanceof THREE.Bone?o.skinMatrix:o.matrix),o=this.data.hierarchy[i].keys,o.length&&(n.animationCache.prevKey=o[0],n.animationCache.nextKey=o[1],this.startTime=Math.min(o[0].time,this.startTime),this.endTime=Math.max(o[o.length-1].time,this.endTime));this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.KeyFrameAnimation.prototype.pause=function(){this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.KeyFrameAnimation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,THREE.AnimationHandler.removeFromUpdate(this);for(var t=0;t<this.data.hierarchy.length;t++){var e=this.hierarchy[t],i=this.data.hierarchy[t];if(void 0!==i.animationCache){var o=i.animationCache.originalMatrix;e instanceof THREE.Bone?(o.copy(e.skinMatrix),e.skinMatrix=o):(o.copy(e.matrix),e.matrix=o),delete i.animationCache}}},THREE.KeyFrameAnimation.prototype.update=function(t){if(this.isPlaying){var e,i,o,n,r,s,a,h=this.data.JIT.hierarchy;if(s=this.currentTime=this.currentTime+t*this.timeScale,r=this.currentTime=this.currentTime%this.data.length,r<this.startTimeMs&&(r=this.currentTime=this.startTimeMs+r),n=parseInt(Math.min(r*this.data.fps,this.data.length*this.data.fps),10),(a=r<s)&&!this.loop){for(var t=0,l=this.hierarchy.length;t<l;t++){var c=this.data.hierarchy[t].keys,h=this.data.hierarchy[t].sids;if(o=c.length-1,n=this.hierarchy[t],c.length){for(c=0;c<h.length;c++)r=h[c],(s=this.getPrevKeyWith(r,t,o))&&s.apply(r);this.data.hierarchy[t].node.updateMatrix(),n.matrixWorldNeedsUpdate=!0}}this.stop()}else if(!(r<this.startTime)){for(t=0,l=this.hierarchy.length;t<l;t++){o=this.hierarchy[t],e=this.data.hierarchy[t];var c=e.keys,u=e.animationCache;if(this.JITCompile&&void 0!==h[t][n])o instanceof THREE.Bone?(o.skinMatrix=h[t][n],o.matrixWorldNeedsUpdate=!1):(o.matrix=h[t][n],o.matrixWorldNeedsUpdate=!0);else if(c.length){if(this.JITCompile&&u&&(o instanceof THREE.Bone?o.skinMatrix=u.originalMatrix:o.matrix=u.originalMatrix),e=u.prevKey,i=u.nextKey,e&&i){if(i.time<=s){if(a&&this.loop)for(e=c[0],i=c[1];i.time<r;)e=i,i=c[e.index+1];else if(!a)for(var m=c.length-1;i.time<r&&i.index!==m;)e=i,i=c[e.index+1];u.prevKey=e,u.nextKey=i}i.time>=r?e.interpolate(i,r):e.interpolate(i,i.time)}this.data.hierarchy[t].node.updateMatrix(),o.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&void 0===h[0][n])for(this.hierarchy[0].updateMatrixWorld(!0),t=0;t<this.hierarchy.length;t++)h[t][n]=this.hierarchy[t]instanceof THREE.Bone?this.hierarchy[t].skinMatrix.clone():this.hierarchy[t].matrix.clone()}}},THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(t,e,i){for(e=this.data.hierarchy[e].keys,i%=e.length;i<e.length;i++)if(e[i].hasTarget(t))return e[i];return e[0]},THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(t,e,i){for(e=this.data.hierarchy[e].keys,i=i>=0?i:i+e.length;i>=0;i--)if(e[i].hasTarget(t))return e[i];return e[e.length-1]},THREE.CubeCamera=function(t,e,i){THREE.Object3D.call(this);var o=new THREE.PerspectiveCamera(90,1,t,e);o.up.set(0,-1,0),o.lookAt(new THREE.Vector3(1,0,0)),this.add(o);var n=new THREE.PerspectiveCamera(90,1,t,e);n.up.set(0,-1,0),n.lookAt(new THREE.Vector3(-1,0,0)),this.add(n);var r=new THREE.PerspectiveCamera(90,1,t,e);r.up.set(0,0,1),r.lookAt(new THREE.Vector3(0,1,0)),this.add(r);var s=new THREE.PerspectiveCamera(90,1,t,e);s.up.set(0,0,-1),s.lookAt(new THREE.Vector3(0,-1,0)),this.add(s);var a=new THREE.PerspectiveCamera(90,1,t,e);a.up.set(0,-1,0),a.lookAt(new THREE.Vector3(0,0,1)),this.add(a);var h=new THREE.PerspectiveCamera(90,1,t,e);h.up.set(0,-1,0),h.lookAt(new THREE.Vector3(0,0,-1)),this.add(h),this.renderTarget=new THREE.WebGLRenderTargetCube(i,i,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter}),this.updateCubeMap=function(t,e){var i=this.renderTarget,l=i.generateMipmaps;i.generateMipmaps=!1,i.activeCubeFace=0,t.render(e,o,i),i.activeCubeFace=1,t.render(e,n,i),i.activeCubeFace=2,t.render(e,r,i),i.activeCubeFace=3,t.render(e,s,i),i.activeCubeFace=4,t.render(e,a,i),i.generateMipmaps=l,i.activeCubeFace=5,t.render(e,h,i)}},THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype),THREE.CombinedCamera=function(t,e,i,o,n,r,s){THREE.Camera.call(this),this.fov=i,this.left=-t/2,this.right=t/2,this.top=e/2,this.bottom=-e/2,this.cameraO=new THREE.OrthographicCamera(t/-2,t/2,e/2,e/-2,r,s),this.cameraP=new THREE.PerspectiveCamera(i,t/e,o,n),this.zoom=1,this.toPerspective()},THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inPerspectiveMode=!0,this.inOrthographicMode=!1},THREE.CombinedCamera.prototype.toOrthographic=function(){var t=this.cameraP.aspect,e=(this.cameraP.near+this.cameraP.far)/2,e=Math.tan(this.fov/2)*e,t=2*e*t/2,e=e/this.zoom,t=t/this.zoom;this.cameraO.left=-t,this.cameraO.right=t,this.cameraO.top=e,this.cameraO.bottom=-e,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode=!1,this.inOrthographicMode=!0},THREE.CombinedCamera.prototype.setSize=function(t,e){this.cameraP.aspect=t/e,this.left=-t/2,this.right=t/2,this.top=e/2,this.bottom=-e/2},THREE.CombinedCamera.prototype.setFov=function(t){this.fov=t,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},THREE.CombinedCamera.prototype.setLens=function(t,e){void 0===e&&(e=24);var i=2*Math.atan(e/(2*t))*(180/Math.PI);return this.setFov(i),i},THREE.CombinedCamera.prototype.setZoom=function(t){this.zoom=t,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CircleGeometry=function(t,e,i,o){THREE.Geometry.call(this);var n,t=t||50,i=void 0!==i?i:0,o=void 0!==o?o:2*Math.PI,e=void 0!==e?Math.max(3,e):8,r=[];n=new THREE.Vector3;var s=new THREE.UV(.5,.5);for(this.vertices.push(n),r.push(s),n=0;n<=e;n++){var a=new THREE.Vector3;a.x=t*Math.cos(i+n/e*o),a.y=t*Math.sin(i+n/e*o),this.vertices.push(a),r.push(new THREE.UV((a.x/t+1)/2,-(a.y/t+1)/2+1))}for(i=new THREE.Vector3(0,0,-1),n=1;n<=e;n++)this.faces.push(new THREE.Face3(n,n+1,0,[i,i,i])),this.faceVertexUvs[0].push([r[n],r[n+1],s]);this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere={radius:t}},THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CubeGeometry=function(t,e,i,o,n,r,s,a){function h(t,e,i,s,a,h,l,c){var u,m=o||1,d=n||1,p=a/2,f=h/2,y=_.vertices.length;"x"===t&&"y"===e||"y"===t&&"x"===e?u="z":"x"===t&&"z"===e||"z"===t&&"x"===e?(u="y",d=r||1):("z"===t&&"y"===e||"y"===t&&"z"===e)&&(u="x",m=r||1);var g=m+1,v=d+1,x=a/m,b=h/d,E=new THREE.Vector3;for(E[u]=l>0?1:-1,a=0;a<v;a++)for(h=0;h<g;h++){var T=new THREE.Vector3;T[t]=(h*x-p)*i,T[e]=(a*b-f)*s,T[u]=l,_.vertices.push(T)}for(a=0;a<d;a++)for(h=0;h<m;h++)t=new THREE.Face4(h+g*a+y,h+g*(a+1)+y,h+1+g*(a+1)+y,h+1+g*a+y),t.normal.copy(E),t.vertexNormals.push(E.clone(),E.clone(),E.clone(),E.clone()),t.materialIndex=c,_.faces.push(t),_.faceVertexUvs[0].push([new THREE.UV(h/m,1-a/d),new THREE.UV(h/m,1-(a+1)/d),new THREE.UV((h+1)/m,1-(a+1)/d),new THREE.UV((h+1)/m,1-a/d)])}THREE.Geometry.call(this);var l,c,u,m,d,p,_=this,f=t/2,y=e/2,g=i/2;if(void 0!==s){if(s instanceof Array)this.materials=s;else for(this.materials=[],l=0;l<6;l++)this.materials.push(s);l=0,m=1,c=2,d=3,u=4,p=5}else this.materials=[];if(this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0},void 0!=a)for(var v in a)void 0!==this.sides[v]&&(this.sides[v]=a[v]);this.sides.px&&h("z","y",-1,-1,i,e,f,l),this.sides.nx&&h("z","y",1,-1,i,e,-f,m),this.sides.py&&h("x","z",1,1,t,i,y,c),this.sides.ny&&h("x","z",1,-1,t,i,-y,d),this.sides.pz&&h("x","y",1,-1,t,e,g,u),this.sides.nz&&h("x","y",-1,-1,t,e,-g,p),this.computeCentroids(),this.mergeVertices()},THREE.CubeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CylinderGeometry=function(t,e,i,o,n,r){THREE.Geometry.call(this);var s,a,t=void 0!==t?t:20,e=void 0!==e?e:20,i=void 0!==i?i:100,h=i/2,o=o||8,n=n||1,l=[],c=[];for(a=0;a<=n;a++){var u=[],m=[],d=a/n,p=d*(e-t)+t;for(s=0;s<=o;s++){var _=s/o,f=new THREE.Vector3;f.x=p*Math.sin(_*Math.PI*2),f.y=-d*i+h,f.z=p*Math.cos(_*Math.PI*2),this.vertices.push(f),u.push(this.vertices.length-1),m.push(new THREE.UV(_,1-d))}l.push(u),c.push(m)}for(i=(e-t)/i,s=0;s<o;s++)for(0!==t?(u=this.vertices[l[0][s]].clone(),m=this.vertices[l[0][s+1]].clone()):(u=this.vertices[l[1][s]].clone(),m=this.vertices[l[1][s+1]].clone()),u.setY(Math.sqrt(u.x*u.x+u.z*u.z)*i).normalize(),m.setY(Math.sqrt(m.x*m.x+m.z*m.z)*i).normalize(),a=0;a<n;a++){var d=l[a][s],p=l[a+1][s],_=l[a+1][s+1],f=l[a][s+1],y=u.clone(),g=u.clone(),v=m.clone(),x=m.clone(),b=c[a][s].clone(),E=c[a+1][s].clone(),T=c[a+1][s+1].clone(),w=c[a][s+1].clone();this.faces.push(new THREE.Face4(d,p,_,f,[y,g,v,x])),this.faceVertexUvs[0].push([b,E,T,w])}if(!r&&t>0)for(this.vertices.push(new THREE.Vector3(0,h,0)),s=0;s<o;s++)d=l[0][s],p=l[0][s+1],_=this.vertices.length-1,y=new THREE.Vector3(0,1,0),g=new THREE.Vector3(0,1,0),v=new THREE.Vector3(0,1,0),b=c[0][s].clone(),E=c[0][s+1].clone(),T=new THREE.UV(E.u,0),this.faces.push(new THREE.Face3(d,p,_,[y,g,v])),this.faceVertexUvs[0].push([b,E,T]);if(!r&&e>0)for(this.vertices.push(new THREE.Vector3(0,-h,0)),s=0;s<o;s++)d=l[a][s+1],p=l[a][s],_=this.vertices.length-1,y=new THREE.Vector3(0,-1,0),g=new THREE.Vector3(0,-1,0),v=new THREE.Vector3(0,-1,0),b=c[a][s+1].clone(),E=c[a][s].clone(),T=new THREE.UV(E.u,1),this.faces.push(new THREE.Face3(d,p,_,[y,g,v])),this.faceVertexUvs[0].push([b,E,T]);this.computeCentroids(),this.computeFaceNormals()},THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry=function(t,e){void 0!==t&&(THREE.Geometry.call(this),t=t instanceof Array?t:[t],this.shapebb=t[t.length-1].getBoundingBox(),this.addShapeList(t,e),this.computeCentroids(),this.computeFaceNormals())},THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry.prototype.addShapeList=function(t,e){for(var i=t.length,o=0;o<i;o++)this.addShape(t[o],e)},THREE.ExtrudeGeometry.prototype.addShape=function(t,e){function i(t,e,i){return e||console.log("die"),e.clone().multiplyScalar(i).addSelf(t)}function o(t,e,i){var o=THREE.ExtrudeGeometry.__v1,n=THREE.ExtrudeGeometry.__v2,r=THREE.ExtrudeGeometry.__v3,s=THREE.ExtrudeGeometry.__v4,a=THREE.ExtrudeGeometry.__v5,h=THREE.ExtrudeGeometry.__v6;return o.set(t.x-e.x,t.y-e.y),n.set(t.x-i.x,t.y-i.y),o=o.normalize(),n=n.normalize(),r.set(-o.y,o.x),s.set(n.y,-n.x),a.copy(t).addSelf(r),h.copy(t).addSelf(s),a.equals(h)?s.clone():(a.copy(e).addSelf(r),h.copy(i).addSelf(s),r=o.dot(s),s=h.subSelf(a).dot(s),0===r&&(console.log("Either infinite or no solutions!"),0===s?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),s/=r,s<0?(e=Math.atan2(e.y-t.y,e.x-t.x),t=Math.atan2(i.y-t.y,i.x-t.x),e>t&&(t+=2*Math.PI),i=(e+t)/2,t=-Math.cos(i),i=-Math.sin(i),new THREE.Vector2(t,i)):o.multiplyScalar(s).addSelf(a).subSelf(t).clone())}function n(i,o){var n,r;for(F=i.length;--F>=0;){n=F,r=F-1,r<0&&(r=i.length-1);for(var s=0,a=y+2*_,s=0;s<a;s++){var h=L*s,l=L*(s+1),c=o+n+h,h=o+r+h,u=o+r+l,l=o+n+l,m=i,d=s,p=a,f=n,g=r,c=c+R,h=h+R,u=u+R,l=l+R;C.faces.push(new THREE.Face4(c,h,u,l,null,null,b)),c=E.generateSideWallUV(C,t,m,e,c,h,u,l,d,p,f,g),C.faceVertexUvs[0].push(c)}}}function r(t,e,i){C.vertices.push(new THREE.Vector3(t,e,i))}function s(i,o,n,r){i+=R,o+=R,n+=R,C.faces.push(new THREE.Face3(i,o,n,null,null,x)),i=r?E.generateBottomUV(C,t,e,i,o,n):E.generateTopUV(C,t,e,i,o,n),C.faceVertexUvs[0].push(i)}var a,h,l,c,u,m=void 0!==e.amount?e.amount:100,d=void 0!==e.bevelThickness?e.bevelThickness:6,p=void 0!==e.bevelSize?e.bevelSize:d-2,_=void 0!==e.bevelSegments?e.bevelSegments:3,f=void 0===e.bevelEnabled||e.bevelEnabled,y=void 0!==e.steps?e.steps:1,g=e.extrudePath,v=!1,x=e.material,b=e.extrudeMaterial,E=void 0!==e.UVGenerator?e.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator;g&&(a=g.getSpacedPoints(y),v=!0,f=!1,h=void 0!==e.frames?e.frames:new THREE.TubeGeometry.FrenetFrames(g,y,!1),l=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3),f||(p=d=_=0);var T,w,S,C=this,R=this.vertices.length,g=t.extractPoints(),M=g.shape,g=g.holes,D=!THREE.Shape.Utils.isClockWise(M);if(D){for(M=M.reverse(),w=0,S=g.length;w<S;w++)T=g[w],THREE.Shape.Utils.isClockWise(T)&&(g[w]=T.reverse());D=!1}var A=THREE.Shape.Utils.triangulateShape(M,g),D=M;for(w=0,S=g.length;w<S;w++)T=g[w],M=M.concat(T);var B,I,H,P,L=M.length,V=A.length,k=[],F=0,z=D.length;for(B=z-1,I=F+1;F<z;F++,B++,I++)B===z&&(B=0),I===z&&(I=0),k[F]=o(D[F],D[B],D[I]);var N,U=[],O=k.concat();for(w=0,S=g.length;w<S;w++){for(T=g[w],N=[],F=0,z=T.length,B=z-1,I=F+1;F<z;F++,B++,I++)B===z&&(B=0),I===z&&(I=0),N[F]=o(T[F],T[B],T[I]);U.push(N),O=O.concat(N)}for(B=0;B<_;B++){for(T=B/_,H=d*(1-T),I=p*Math.sin(T*Math.PI/2),F=0,z=D.length;F<z;F++)P=i(D[F],k[F],I),r(P.x,P.y,-H);for(w=0,S=g.length;w<S;w++)for(T=g[w],N=U[w],F=0,z=T.length;F<z;F++)P=i(T[F],N[F],I),r(P.x,P.y,-H)}for(I=p,F=0;F<L;F++)P=f?i(M[F],O[F],I):M[F],v?(c.copy(h.normals[0]).multiplyScalar(P.x),l.copy(h.binormals[0]).multiplyScalar(P.y),u.copy(a[0]).addSelf(c).addSelf(l),r(u.x,u.y,u.z)):r(P.x,P.y,0);for(T=1;T<=y;T++)for(F=0;F<L;F++)P=f?i(M[F],O[F],I):M[F],v?(c.copy(h.normals[T]).multiplyScalar(P.x),l.copy(h.binormals[T]).multiplyScalar(P.y),u.copy(a[T]).addSelf(c).addSelf(l),r(u.x,u.y,u.z)):r(P.x,P.y,m/y*T);for(B=_-1;B>=0;B--){for(T=B/_,H=d*(1-T),I=p*Math.sin(T*Math.PI/2),F=0,z=D.length;F<z;F++)P=i(D[F],k[F],I),r(P.x,P.y,m+H);for(w=0,S=g.length;w<S;w++)for(T=g[w],N=U[w],F=0,z=T.length;F<z;F++)P=i(T[F],N[F],I),v?r(P.x,P.y+a[y-1].y,a[y-1].x+H):r(P.x,P.y,m+H)}if(f){for(d=0*L,F=0;F<V;F++)m=A[F],s(m[2]+d,m[1]+d,m[0]+d,!0);for(d=L*(y+2*_),F=0;F<V;F++)m=A[F],s(m[0]+d,m[1]+d,m[2]+d,!1)}else{for(F=0;F<V;F++)m=A[F],s(m[2],m[1],m[0],!0);for(F=0;F<V;F++)m=A[F],s(m[0]+L*y,m[1]+L*y,m[2]+L*y,!1)}for(m=0,n(D,m),m+=D.length,w=0,S=g.length;w<S;w++)T=g[w],n(T,m),m+=T.length},THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(t,e,i,o,n,r){return e=t.vertices[n].x,n=t.vertices[n].y,i=t.vertices[r].x,r=t.vertices[r].y,[new THREE.UV(t.vertices[o].x,t.vertices[o].y),new THREE.UV(e,n),new THREE.UV(i,r)]},generateBottomUV:function(t,e,i,o,n,r){return this.generateTopUV(t,e,i,o,n,r)},generateSideWallUV:function(t,e,i,o,n,r,s,a){var e=t.vertices[n].x,i=t.vertices[n].y,n=t.vertices[n].z,o=t.vertices[r].x,h=t.vertices[r].y,r=t.vertices[r].z,l=t.vertices[s].x,c=t.vertices[s].y,s=t.vertices[s].z,u=t.vertices[a].x,m=t.vertices[a].y,t=t.vertices[a].z;return Math.abs(i-h)<.01?[new THREE.UV(e,1-n),new THREE.UV(o,1-r),new THREE.UV(l,1-s),new THREE.UV(u,1-t)]:[new THREE.UV(i,1-n),new THREE.UV(h,1-r),new THREE.UV(c,1-s),new THREE.UV(m,1-t)]}},THREE.ExtrudeGeometry.__v1=new THREE.Vector2,THREE.ExtrudeGeometry.__v2=new THREE.Vector2,THREE.ExtrudeGeometry.__v3=new THREE.Vector2,THREE.ExtrudeGeometry.__v4=new THREE.Vector2,THREE.ExtrudeGeometry.__v5=new THREE.Vector2,THREE.ExtrudeGeometry.__v6=new THREE.Vector2,THREE.ShapeGeometry=function(t,e){THREE.Geometry.call(this),t instanceof Array==!1&&(t=[t]),this.shapebb=t[t.length-1].getBoundingBox(),this.addShapeList(t,e),this.computeCentroids(),this.computeFaceNormals()},THREE.ShapeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ShapeGeometry.prototype.addShapeList=function(t,e){for(var i=0,o=t.length;i<o;i++)this.addShape(t[i],e);return this},THREE.ShapeGeometry.prototype.addShape=function(t,e){void 0===e&&(e={});var i,o,n,r=e.material,s=void 0===e.UVGenerator?THREE.ExtrudeGeometry.WorldUVGenerator:e.UVGenerator,a=this.vertices.length;i=t.extractPoints();var h=i.shape,l=i.holes;if(!THREE.Shape.Utils.isClockWise(h))for(h=h.reverse(),i=0,o=l.length;i<o;i++)n=l[i],THREE.Shape.Utils.isClockWise(n)&&(l[i]=n.reverse());var c=THREE.Shape.Utils.triangulateShape(h,l);for(i=0,o=l.length;i<o;i++)n=l[i],h=h.concat(n);for(l=h.length,o=c.length,i=0;i<l;i++)n=h[i],this.vertices.push(new THREE.Vector3(n.x,n.y,0));for(i=0;i<o;i++)l=c[i],h=l[0]+a,n=l[1]+a,l=l[2]+a,this.faces.push(new THREE.Face3(h,n,l,null,null,r)),this.faceVertexUvs[0].push(s.generateBottomUV(this,t,e,h,n,l))},THREE.LatheGeometry=function(t,e,i){THREE.Geometry.call(this);for(var e=e||12,i=i||2*Math.PI,o=[],n=(new THREE.Matrix4).makeRotationZ(i/e),r=0;r<t.length;r++)o[r]=t[r].clone(),this.vertices.push(o[r]);for(var s=e+1,i=0;i<s;i++)for(r=0;r<o.length;r++)o[r]=n.multiplyVector3(o[r].clone()),this.vertices.push(o[r]);for(i=0;i<e;i++)for(o=0,n=t.length;o<n-1;o++)this.faces.push(new THREE.Face4(i*n+o,(i+1)%s*n+o,(i+1)%s*n+(o+1)%n,i*n+(o+1)%n)),this.faceVertexUvs[0].push([new THREE.UV(1-i/e,o/n),new THREE.UV(1-(i+1)/e,o/n),new THREE.UV(1-(i+1)/e,(o+1)/n),new THREE.UV(1-i/e,(o+1)/n)]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.PlaneGeometry=function(t,e,i,o){THREE.Geometry.call(this);for(var n=t/2,r=e/2,i=i||1,o=o||1,s=i+1,a=o+1,h=t/i,l=e/o,c=new THREE.Vector3(0,0,1),t=0;t<a;t++)for(e=0;e<s;e++)this.vertices.push(new THREE.Vector3(e*h-n,-(t*l-r),0));for(t=0;t<o;t++)for(e=0;e<i;e++)n=new THREE.Face4(e+s*t,e+s*(t+1),e+1+s*(t+1),e+1+s*t),n.normal.copy(c),n.vertexNormals.push(c.clone(),c.clone(),c.clone(),c.clone()),this.faces.push(n),this.faceVertexUvs[0].push([new THREE.UV(e/i,1-t/o),new THREE.UV(e/i,1-(t+1)/o),new THREE.UV((e+1)/i,1-(t+1)/o),new THREE.UV((e+1)/i,1-t/o)]);this.computeCentroids()},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.SphereGeometry=function(t,e,i,o,n,r,s){THREE.Geometry.call(this);var a,h,t=t||50,o=void 0!==o?o:0,n=void 0!==n?n:2*Math.PI,r=void 0!==r?r:0,s=void 0!==s?s:Math.PI,e=Math.max(3,Math.floor(e)||8),i=Math.max(2,Math.floor(i)||6),l=[],c=[];for(h=0;h<=i;h++){var u=[],m=[];for(a=0;a<=e;a++){var d=a/e,p=h/i,_=new THREE.Vector3;_.x=-t*Math.cos(o+d*n)*Math.sin(r+p*s),_.y=t*Math.cos(r+p*s),_.z=t*Math.sin(o+d*n)*Math.sin(r+p*s),this.vertices.push(_),u.push(this.vertices.length-1),m.push(new THREE.UV(d,1-p))}l.push(u),c.push(m)}for(h=0;h<i;h++)for(a=0;a<e;a++){var o=l[h][a+1],n=l[h][a],r=l[h+1][a],s=l[h+1][a+1],u=this.vertices[o].clone().normalize(),m=this.vertices[n].clone().normalize(),d=this.vertices[r].clone().normalize(),p=this.vertices[s].clone().normalize(),_=c[h][a+1].clone(),f=c[h][a].clone(),y=c[h+1][a].clone(),g=c[h+1][a+1].clone();Math.abs(this.vertices[o].y)==t?(this.faces.push(new THREE.Face3(o,r,s,[u,d,p])),this.faceVertexUvs[0].push([_,y,g])):Math.abs(this.vertices[r].y)==t?(this.faces.push(new THREE.Face3(o,n,r,[u,m,d])),this.faceVertexUvs[0].push([_,f,y])):(this.faces.push(new THREE.Face4(o,n,r,s,[u,m,d,p])),this.faceVertexUvs[0].push([_,f,y,g]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere={radius:t}},THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TextGeometry=function(t,e){var i=THREE.FontUtils.generateShapes(t,e);e.amount=void 0!==e.height?e.height:50,void 0===e.bevelThickness&&(e.bevelThickness=10),void 0===e.bevelSize&&(e.bevelSize=8),void 0===e.bevelEnabled&&(e.bevelEnabled=!1),THREE.ExtrudeGeometry.call(this,i,e)},THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype),THREE.TorusGeometry=function(t,e,i,o,n){for(THREE.Geometry.call(this),this.radius=t||100,this.tube=e||40,this.radialSegments=i||8,this.tubularSegments=o||6,this.arc=n||2*Math.PI,n=new THREE.Vector3,t=[],e=[],
i=0;i<=this.radialSegments;i++)for(o=0;o<=this.tubularSegments;o++){var r=o/this.tubularSegments*this.arc,s=i/this.radialSegments*Math.PI*2;n.x=this.radius*Math.cos(r),n.y=this.radius*Math.sin(r);var a=new THREE.Vector3;a.x=(this.radius+this.tube*Math.cos(s))*Math.cos(r),a.y=(this.radius+this.tube*Math.cos(s))*Math.sin(r),a.z=this.tube*Math.sin(s),this.vertices.push(a),t.push(new THREE.UV(o/this.tubularSegments,i/this.radialSegments)),e.push(a.clone().subSelf(n).normalize())}for(i=1;i<=this.radialSegments;i++)for(o=1;o<=this.tubularSegments;o++){var n=(this.tubularSegments+1)*i+o-1,r=(this.tubularSegments+1)*(i-1)+o-1,s=(this.tubularSegments+1)*(i-1)+o,a=(this.tubularSegments+1)*i+o,h=new THREE.Face4(n,r,s,a,[e[n],e[r],e[s],e[a]]);h.normal.addSelf(e[n]),h.normal.addSelf(e[r]),h.normal.addSelf(e[s]),h.normal.addSelf(e[a]),h.normal.normalize(),this.faces.push(h),this.faceVertexUvs[0].push([t[n].clone(),t[r].clone(),t[s].clone(),t[a].clone()])}this.computeCentroids()},THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TorusKnotGeometry=function(t,e,i,o,n,r,s){function a(t,e,i,o,n,r){var s=Math.cos(t);return Math.cos(e),e=Math.sin(t),t*=i/o,i=Math.cos(t),s*=n*(2+i)*.5,e=n*(2+i)*e*.5,n=r*n*Math.sin(t)*.5,new THREE.Vector3(s,e,n)}for(THREE.Geometry.call(this),this.radius=t||200,this.tube=e||40,this.radialSegments=i||64,this.tubularSegments=o||8,this.p=n||2,this.q=r||3,this.heightScale=s||1,this.grid=Array(this.radialSegments),i=new THREE.Vector3,o=new THREE.Vector3,n=new THREE.Vector3,t=0;t<this.radialSegments;++t)for(this.grid[t]=Array(this.tubularSegments),e=0;e<this.tubularSegments;++e){var h=t/this.radialSegments*2*this.p*Math.PI,s=e/this.tubularSegments*2*Math.PI,r=a(h,s,this.q,this.p,this.radius,this.heightScale),h=a(h+.01,s,this.q,this.p,this.radius,this.heightScale);i.sub(h,r),o.add(h,r),n.cross(i,o),o.cross(n,i),n.normalize(),o.normalize(),h=-this.tube*Math.cos(s),s=this.tube*Math.sin(s),r.x=r.x+(h*o.x+s*n.x),r.y=r.y+(h*o.y+s*n.y),r.z=r.z+(h*o.z+s*n.z),this.grid[t][e]=this.vertices.push(new THREE.Vector3(r.x,r.y,r.z))-1}for(t=0;t<this.radialSegments;++t)for(e=0;e<this.tubularSegments;++e){var n=(t+1)%this.radialSegments,r=(e+1)%this.tubularSegments,i=this.grid[t][e],o=this.grid[n][e],n=this.grid[n][r],r=this.grid[t][r],s=new THREE.UV(t/this.radialSegments,e/this.tubularSegments),h=new THREE.UV((t+1)/this.radialSegments,e/this.tubularSegments),l=new THREE.UV((t+1)/this.radialSegments,(e+1)/this.tubularSegments),c=new THREE.UV(t/this.radialSegments,(e+1)/this.tubularSegments);this.faces.push(new THREE.Face4(i,o,n,r)),this.faceVertexUvs[0].push([s,h,l,c])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry=function(t,e,i,o,n,r){THREE.Geometry.call(this),this.path=t,this.segments=e||64,this.radius=i||1,this.radiusSegments=o||8,this.closed=n||!1,r&&(this.debug=new THREE.Object3D),this.grid=[];var s,a,h,l,c,u,m,d,r=this.segments+1,p=new THREE.Vector3,e=new THREE.TubeGeometry.FrenetFrames(t,e,n);for(u=e.tangents,m=e.normals,d=e.binormals,this.tangents=u,this.normals=m,this.binormals=d,e=0;e<r;e++)for(this.grid[e]=[],o=e/(r-1),c=t.getPointAt(o),o=u[e],s=m[e],a=d[e],this.debug&&(this.debug.add(new THREE.ArrowHelper(o,c,i,255)),this.debug.add(new THREE.ArrowHelper(s,c,i,16711680)),this.debug.add(new THREE.ArrowHelper(a,c,i,65280))),o=0;o<this.radiusSegments;o++)h=o/this.radiusSegments*2*Math.PI,l=-this.radius*Math.cos(h),h=this.radius*Math.sin(h),p.copy(c),p.x=p.x+(l*s.x+h*a.x),p.y=p.y+(l*s.y+h*a.y),p.z=p.z+(l*s.z+h*a.z),this.grid[e][o]=this.vertices.push(new THREE.Vector3(p.x,p.y,p.z))-1;for(e=0;e<this.segments;e++)for(o=0;o<this.radiusSegments;o++)r=n?(e+1)%this.segments:e+1,p=(o+1)%this.radiusSegments,t=this.grid[e][o],i=this.grid[r][o],r=this.grid[r][p],p=this.grid[e][p],u=new THREE.UV(e/this.segments,o/this.radiusSegments),m=new THREE.UV((e+1)/this.segments,o/this.radiusSegments),d=new THREE.UV((e+1)/this.segments,(o+1)/this.radiusSegments),s=new THREE.UV(e/this.segments,(o+1)/this.radiusSegments),this.faces.push(new THREE.Face4(t,i,r,p)),this.faceVertexUvs[0].push([u,m,d,s]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry.FrenetFrames=function(t,e,i){new THREE.Vector3;var o=new THREE.Vector3;new THREE.Vector3;var n,r,s,a=[],h=[],l=[],c=new THREE.Vector3,u=new THREE.Matrix4,e=e+1;for(this.tangents=a,this.normals=h,this.binormals=l,n=0;n<e;n++)r=n/(e-1),a[n]=t.getTangentAt(r),a[n].normalize();for(h[0]=new THREE.Vector3,l[0]=new THREE.Vector3,t=Number.MAX_VALUE,n=Math.abs(a[0].x),r=Math.abs(a[0].y),s=Math.abs(a[0].z),n<=t&&(t=n,o.set(1,0,0)),r<=t&&(t=r,o.set(0,1,0)),s<=t&&o.set(0,0,1),c.cross(a[0],o).normalize(),h[0].cross(a[0],c),l[0].cross(a[0],h[0]),n=1;n<e;n++)h[n]=h[n-1].clone(),l[n]=l[n-1].clone(),c.cross(a[n-1],a[n]),c.length()>1e-4&&(c.normalize(),o=Math.acos(a[n-1].dot(a[n])),u.makeRotationAxis(c,o).multiplyVector3(h[n])),l[n].cross(a[n],h[n]);if(i)for(o=Math.acos(h[0].dot(h[e-1])),o/=e-1,a[0].dot(c.cross(h[0],h[e-1]))>0&&(o=-o),n=1;n<e;n++)u.makeRotationAxis(a[n],o*n).multiplyVector3(h[n]),l[n].cross(a[n],h[n])},THREE.PolyhedronGeometry=function(t,e,i,o){function n(t){var e=t.normalize().clone();e.index=h.vertices.push(e)-1;var i=Math.atan2(t.z,-t.x)/2/Math.PI+.5,t=Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5;return e.uv=new THREE.UV(i,1-t),e}function r(t,e,i,o){o<1?(o=new THREE.Face3(t.index,e.index,i.index,[t.clone(),e.clone(),i.clone()]),o.centroid.addSelf(t).addSelf(e).addSelf(i).divideScalar(3),o.normal=o.centroid.clone().normalize(),h.faces.push(o),o=Math.atan2(o.centroid.z,-o.centroid.x),h.faceVertexUvs[0].push([a(t.uv,t,o),a(e.uv,e,o),a(i.uv,i,o)])):(o-=1,r(t,s(t,e),s(t,i),o),r(s(t,e),e,s(e,i),o),r(s(t,i),s(e,i),i,o),r(s(t,e),s(e,i),s(t,i),o))}function s(t,e){u[t.index]||(u[t.index]=[]),u[e.index]||(u[e.index]=[]);var i=u[t.index][e.index];return void 0===i&&(u[t.index][e.index]=u[e.index][t.index]=i=n((new THREE.Vector3).add(t,e).divideScalar(2))),i}function a(t,e,i){return i<0&&1===t.u&&(t=new THREE.UV(t.u-1,t.v)),0===e.x&&0===e.z&&(t=new THREE.UV(i/2/Math.PI+.5,t.v)),t}THREE.Geometry.call(this);for(var i=i||1,o=o||0,h=this,l=0,c=t.length;l<c;l++)n(new THREE.Vector3(t[l][0],t[l][1],t[l][2]));for(var u=[],t=this.vertices,l=0,c=e.length;l<c;l++)r(t[e[l][0]],t[e[l][1]],t[e[l][2]],o);for(this.mergeVertices(),l=0,c=this.vertices.length;l<c;l++)this.vertices[l].multiplyScalar(i);this.computeCentroids(),this.boundingSphere={radius:i}},THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.IcosahedronGeometry=function(t,e){var i=(1+Math.sqrt(5))/2;THREE.PolyhedronGeometry.call(this,[[-1,i,0],[1,i,0],[-1,-i,0],[1,-i,0],[0,-1,i],[0,1,i],[0,-1,-i],[0,1,-i],[i,0,-1],[i,0,1],[-i,0,-1],[-i,0,1]],[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],t,e)},THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.OctahedronGeometry=function(t,e){THREE.PolyhedronGeometry.call(this,[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]],t,e)},THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TetrahedronGeometry=function(t,e){THREE.PolyhedronGeometry.call(this,[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],[[2,1,0],[0,3,2],[1,3,0],[2,3,1]],t,e)},THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ParametricGeometry=function(t,e,i,o){THREE.Geometry.call(this);var n,r,s,a,h=this.vertices,l=this.faces,c=this.faceVertexUvs[0],o=void 0!==o&&o,u=e+1;for(n=0;n<=i;n++)for(a=n/i,r=0;r<=e;r++)s=r/e,s=t(s,a),h.push(s);var m,d,p,_;for(n=0;n<i;n++)for(r=0;r<e;r++)t=n*u+r,h=n*u+r+1,a=(n+1)*u+r,s=(n+1)*u+r+1,m=new THREE.UV(r/e,n/i),d=new THREE.UV((r+1)/e,n/i),p=new THREE.UV(r/e,(n+1)/i),_=new THREE.UV((r+1)/e,(n+1)/i),o?(l.push(new THREE.Face3(t,h,a)),l.push(new THREE.Face3(h,s,a)),c.push([m,d,p]),c.push([d,_,p])):(l.push(new THREE.Face4(t,h,s,a)),c.push([m,d,_,p]));this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ConvexGeometry=function(t){function e(t){var e=t.length();return new THREE.UV(t.x/e,t.y/e)}THREE.Geometry.call(this);for(var i=[[0,1,2],[0,2,1]],o=3;o<t.length;o++){var n=o,r=t[n].clone(),s=r.length();r.x=r.x+s*(Math.random()-.5)*2e-6,r.y=r.y+s*(Math.random()-.5)*2e-6,r.z=r.z+s*(Math.random()-.5)*2e-6;for(var s=[],a=0;a<i.length;){var h,l=i[a],c=r,u=t[l[0]];h=u;var m=t[l[1]],d=t[l[2]],p=new THREE.Vector3,_=new THREE.Vector3;if(p.sub(d,m),_.sub(h,m),p.crossSelf(_),p.isZero()||p.normalize(),h=p,u=h.dot(u),h.dot(c)>=u){for(c=0;c<3;c++){for(u=[l[c],l[(c+1)%3]],h=!0,m=0;m<s.length;m++)if(s[m][0]===u[1]&&s[m][1]===u[0]){s[m]=s[s.length-1],s.pop(),h=!1;break}h&&s.push(u)}i[a]=i[i.length-1],i.pop()}else a++}for(m=0;m<s.length;m++)i.push([s[m][0],s[m][1],n])}for(n=0,r=Array(t.length),o=0;o<i.length;o++)for(s=i[o],a=0;a<3;a++)void 0===r[s[a]]&&(r[s[a]]=n++,this.vertices.push(t[s[a]])),s[a]=r[s[a]];for(o=0;o<i.length;o++)this.faces.push(new THREE.Face3(i[o][0],i[o][1],i[o][2]));for(o=0;o<this.faces.length;o++)s=this.faces[o],this.faceVertexUvs[0].push([e(this.vertices[s.a]),e(this.vertices[s.b]),e(this.vertices[s.c])]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.AxisHelper=function(t){var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3,new THREE.Vector3(t||1,0,0),new THREE.Vector3,new THREE.Vector3(0,t||1,0),new THREE.Vector3,new THREE.Vector3(0,0,t||1)),e.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775)),t=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),THREE.Line.call(this,e,t,THREE.LinePieces)},THREE.AxisHelper.prototype=Object.create(THREE.Line.prototype),THREE.ArrowHelper=function(t,e,i,o){THREE.Object3D.call(this),void 0===o&&(o=16776960),void 0===i&&(i=20);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,0,0)),n.vertices.push(new THREE.Vector3(0,1,0)),this.line=new THREE.Line(n,new THREE.LineBasicMaterial({color:o})),this.add(this.line),n=new THREE.CylinderGeometry(0,.05,.25,5,1),this.cone=new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:o})),this.cone.position.set(0,1,0),this.add(this.cone),e instanceof THREE.Vector3&&(this.position=e),this.setDirection(t),this.setLength(i)},THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.ArrowHelper.prototype.setDirection=function(t){var e=new THREE.Vector3(0,1,0).crossSelf(t),t=Math.acos(new THREE.Vector3(0,1,0).dot(t.clone().normalize()));this.matrix=(new THREE.Matrix4).makeRotationAxis(e.normalize(),t),this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},THREE.ArrowHelper.prototype.setLength=function(t){this.scale.set(t,t,t)},THREE.ArrowHelper.prototype.setColor=function(t){this.line.material.color.setHex(t),this.cone.material.color.setHex(t)},THREE.CameraHelper=function(t){function e(t,e,o){i(t,o),i(e,o)}function i(t,e){o.geometry.vertices.push(new THREE.Vector3),o.geometry.colors.push(new THREE.Color(e)),void 0===o.pointMap[t]&&(o.pointMap[t]=[]),o.pointMap[t].push(o.geometry.vertices.length-1)}THREE.Line.call(this);var o=this;this.geometry=new THREE.Geometry,this.material=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors}),this.type=THREE.LinePieces,this.matrixWorld=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap={},e("n1","n2",16755200),e("n2","n4",16755200),e("n4","n3",16755200),e("n3","n1",16755200),e("f1","f2",16755200),e("f2","f4",16755200),e("f4","f3",16755200),e("f3","f1",16755200),e("n1","f1",16755200),e("n2","f2",16755200),e("n3","f3",16755200),e("n4","f4",16755200),e("p","n1",16711680),e("p","n2",16711680),e("p","n3",16711680),e("p","n4",16711680),e("u1","u2",43775),e("u2","u3",43775),e("u3","u1",43775),e("c","t",16777215),e("p","c",3355443),e("cn1","cn2",3355443),e("cn3","cn4",3355443),e("cf1","cf2",3355443),e("cf3","cf4",3355443),this.camera=t,this.update(t)},THREE.CameraHelper.prototype=Object.create(THREE.Line.prototype),THREE.CameraHelper.prototype.update=function(){function t(t,i,o,n){if(THREE.CameraHelper.__v.set(i,o,n),THREE.CameraHelper.__projector.unprojectVector(THREE.CameraHelper.__v,THREE.CameraHelper.__c),void 0!==(t=e.pointMap[t]))for(i=0,o=t.length;i<o;i++)e.geometry.vertices[t[i]].copy(THREE.CameraHelper.__v)}var e=this;THREE.CameraHelper.__c.projectionMatrix.copy(this.camera.projectionMatrix),t("c",0,0,-1),t("t",0,0,1),t("n1",-1,-1,-1),t("n2",1,-1,-1),t("n3",-1,1,-1),t("n4",1,1,-1),t("f1",-1,-1,1),t("f2",1,-1,1),t("f3",-1,1,1),t("f4",1,1,1),t("u1",.7,1.1,-1),t("u2",-.7,1.1,-1),t("u3",0,2,-1),t("cf1",-1,0,1),t("cf2",1,0,1),t("cf3",0,-1,1),t("cf4",0,1,1),t("cn1",-1,0,-1),t("cn2",1,0,-1),t("cn3",0,-1,-1),t("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0},THREE.CameraHelper.__projector=new THREE.Projector,THREE.CameraHelper.__v=new THREE.Vector3,THREE.CameraHelper.__c=new THREE.Camera,THREE.SubdivisionModifier=function(t){this.subdivisions=void 0===t?1:t,this.useOldVertexColors=!1,this.supportUVs=!0,this.debug=!1},THREE.SubdivisionModifier.prototype.modify=function(t){for(var e=this.subdivisions;e-- >0;)this.smooth(t)},THREE.GeometryUtils.orderedKey=function(t,e){return Math.min(t,e)+"_"+Math.max(t,e)},THREE.GeometryUtils.computeEdgeFaces=function(t){function e(t,e){void 0===s[t]&&(s[t]=[]),s[t].push(e)}var i,o,n,r,s={},a=THREE.GeometryUtils.orderedKey;for(i=0,o=t.faces.length;i<o;i++)n=t.faces[i],n instanceof THREE.Face3?(r=a(n.a,n.b),e(r,i),r=a(n.b,n.c),e(r,i),r=a(n.c,n.a),e(r,i)):n instanceof THREE.Face4&&(r=a(n.a,n.b),e(r,i),r=a(n.b,n.c),e(r,i),r=a(n.c,n.d),e(r,i),r=a(n.d,n.a),e(r,i));return s},THREE.SubdivisionModifier.prototype.smooth=function(t){function e(){f.debug&&console&&console.assert&&console.assert.apply(console,arguments)}function i(){f.debug&&console.log.apply(console,arguments)}function o(){console&&console.log.apply(console,arguments)}function n(t,e,o,n,s,a,h){var l=new THREE.Face4(t,e,o,n,null,s.color,s.materialIndex);if(f.useOldVertexColors){l.vertexColors=[];for(var c,u,m,d=0;d<4;d++){m=a[d],c=new THREE.Color,c.setRGB(0,0,0);for(var y=0;y<m.length;y++)u=s.vertexColors[m[y]-1],c.r=c.r+u.r,c.g=c.g+u.g,c.b=c.b+u.b;c.r=c.r/m.length,c.g=c.g/m.length,c.b=c.b/m.length,l.vertexColors[d]=c}}p.push(l),f.supportUVs&&(s=[r(t,""),r(e,h),r(o,h),r(n,h)],s[0]?s[1]?s[2]?s[3]?_.push(s):i("d :( ",n+":"+h):i("c :( ",o+":"+h):i("b :( ",e+":"+h):i("a :( ",t+":"+h))}function r(t,e){var n=t+":"+e,r=S[n];return r||(i(t>=b&&t<b+x.length?"face pt":"edge pt"),o("warning, UV not found for",n),null)}function s(t,e,i){var n=t+":"+e;n in S?o("dup vertexNo",t,"oldFaceNo",e,"value",i,"key",n,S[n]):S[n]=i}var a,h,l,c,u,m,d=[],p=[],_=[],f=this,y=THREE.GeometryUtils.orderedKey,g=THREE.GeometryUtils.computeEdgeFaces,v=t.vertices,x=t.faces,b=v.length,d=v.concat(),E=[],T={},w={},S={},C=t.faceVertexUvs[0];if(i("originalFaces, uvs, originalVerticesLength",x.length,C.length,b),f.supportUVs)for(a=0,h=C.length;a<h;a++)for(l=0,c=C[a].length;l<c;l++)m=x[a]["abcd".charAt(l)],s(m,a,C[a][l]);0==C.length&&(f.supportUVs=!1),a=0;for(var R in S)a++;for(a||(f.supportUVs=!1,i("no uvs")),a=0,h=x.length;a<h;a++)u=x[a],E.push(u.centroid),d.push(u.centroid),f.supportUVs&&(c=new THREE.UV,u instanceof THREE.Face3?(c.u=r(u.a,a).u+r(u.b,a).u+r(u.c,a).u,c.v=r(u.a,a).v+r(u.b,a).v+r(u.c,a).v,c.u=c.u/3,c.v=c.v/3):u instanceof THREE.Face4&&(c.u=r(u.a,a).u+r(u.b,a).u+r(u.c,a).u+r(u.d,a).u,c.v=r(u.a,a).v+r(u.b,a).v+r(u.c,a).v+r(u.d,a).v,c.u=c.u/4,c.v=c.v/4),s(b+a,"",c));var M,g=g(t);h=0;var D,A;R={},C={};for(a in g){for(m=g[a],D=a.split("_"),A=D[0],D=D[1],l=A,u=[A,D],void 0===R[l]&&(R[l]=[]),R[l].push(u),l=D,u=[A,D],void 0===R[l]&&(R[l]=[]),R[l].push(u),l=0,c=m.length;l<c;l++){u=m[l],M=A;var B=u,I=a;void 0===C[M]&&(C[M]={}),C[M][B]=I,M=D,B=a,void 0===C[M]&&(C[M]={}),C[M][u]=B}m.length<2&&(w[a]=!0)}for(a in g)m=g[a],u=m[0],M=m[1],D=a.split("_"),A=D[0],D=D[1],c=new THREE.Vector3,e(m.length>0,"an edge without faces?!"),1==m.length?(c.addSelf(v[A]),c.addSelf(v[D]),c.multiplyScalar(.5)):(c.addSelf(E[u]),c.addSelf(E[M]),c.addSelf(v[A]),c.addSelf(v[D]),c.multiplyScalar(.25)),T[a]=b+x.length+h,d.push(c),h++,f.supportUVs&&(c=new THREE.UV,c.u=r(A,u).u+r(D,u).u,c.v=r(A,u).v+r(D,u).v,c.u=c.u/2,c.v=c.v/2,s(T[a],u,c),m.length>=2&&(e(2==m.length,"did we plan for more than 2 edges?"),c=new THREE.UV,c.u=r(A,M).u+r(D,M).u,c.v=r(A,M).v+r(D,M).v,c.u=c.u/2,c.v=c.v/2,s(T[a],M,c)));i("-- Step 2 done");var H,P;c=["123","12","2","23"],M=["123","23","3","31"];var B=["123","31","1","12"],I=["1234","12","2","23"],L=["1234","23","3","34"],V=["1234","34","4","41"],k=["1234","41","1","12"];for(a=0,h=E.length;a<h;a++)u=x[a],m=b+a,u instanceof THREE.Face3?(A=y(u.a,u.b),D=y(u.b,u.c),H=y(u.c,u.a),n(m,T[A],u.b,T[D],u,c,a),n(m,T[D],u.c,T[H],u,M,a),n(m,T[H],u.a,T[A],u,B,a)):u instanceof THREE.Face4?(A=y(u.a,u.b),D=y(u.b,u.c),H=y(u.c,u.d),P=y(u.d,u.a),n(m,T[A],u.b,T[D],u,I,a),n(m,T[D],u.c,T[H],u,L,a),n(m,T[H],u.d,T[P],u,V,a),n(m,T[P],u.a,T[A],u,k,a)):i("face should be a face!",u);for(T=new THREE.Vector3,u=new THREE.Vector3,a=0,h=v.length;a<h;a++)if(void 0!==R[a]){T.set(0,0,0),u.set(0,0,0),D=new THREE.Vector3(0,0,0),m=0;for(l in C[a])T.addSelf(E[l]),m++;for(M=0,A=R[a].length,c=m!=A,l=0;l<A;l++)w[y(R[a][l][0],R[a][l][1])]&&M++;if(T.divideScalar(m),M=0,c){for(l=0;l<A;l++)m=R[a][l],(B=1==g[y(m[0],m[1])].length)&&(m=v[m[0]].clone().addSelf(v[m[1]]).divideScalar(2),u.addSelf(m),M++);u.divideScalar(4),e(2==M,"should have only 2 boundary edges")}else{for(l=0;l<A;l++)m=R[a][l],m=v[m[0]].clone().addSelf(v[m[1]]).divideScalar(2),u.addSelf(m);u.divideScalar(A)}D.addSelf(v[a]),c?(D.divideScalar(2),D.addSelf(u)):(D.multiplyScalar(A-3),D.addSelf(T),D.addSelf(u.multiplyScalar(2)),D.divideScalar(A)),d[a]=D}t.vertices=d,t.faces=p,t.faceVertexUvs[0]=_,delete t.__tmpVertices,t.computeCentroids(),t.computeFaceNormals(),t.computeVertexNormals()},THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this),this.render=function(){}},THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare=function(t,e,i,o,n){THREE.Object3D.call(this),this.lensFlares=[],this.positionScreen=new THREE.Vector3,this.customUpdateCallback=void 0,void 0!==t&&this.add(t,e,i,o,n)},THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare.prototype.add=function(t,e,i,o,n,r){void 0===e&&(e=-1),void 0===i&&(i=0),void 0===r&&(r=1),void 0===n&&(n=new THREE.Color(16777215)),void 0===o&&(o=THREE.NormalBlending),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:t,size:e,distance:i,x:0,y:0,z:0,scale:1,rotation:1,opacity:r,color:n,blending:o})},THREE.LensFlare.prototype.updateLensFlares=function(){var t,e,i=this.lensFlares.length,o=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(t=0;t<i;t++)e=this.lensFlares[t],e.x=this.positionScreen.x+o*e.distance,e.y=this.positionScreen.y+n*e.distance,e.wantedRotation=e.x*Math.PI*.25,e.rotation=e.rotation+.25*(e.wantedRotation-e.rotation)},THREE.MorphBlendMesh=function(t,e){THREE.Mesh.call(this,t,e),this.animationsMap={},this.animationsList=[];var i=this.geometry.morphTargets.length;this.createAnimation("__default",0,i-1,i/1),this.setAnimationWeight("__default",1)},THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphBlendMesh.prototype.createAnimation=function(t,e,i,o){e={startFrame:e,endFrame:i,length:i-e+1,fps:o,duration:(i-e)/o,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1},this.animationsMap[t]=e,this.animationsList.push(e)},THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(t){for(var e,i={},o=this.geometry,n=0,r=o.morphTargets.length;n<r;n++){var s=o.morphTargets[n].name.match(/([a-z]+)(\d+)/);if(s&&s.length>1){var a=s[1];i[a]||(i[a]={start:1/0,end:-1/0}),s=i[a],n<s.start&&(s.start=n),n>s.end&&(s.end=n),e||(e=a)}}for(a in i)s=i[a],this.createAnimation(a,s.start,s.end,t);this.firstAnimation=e},THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(t){(t=this.animationsMap[t])&&(t.direction=1,t.directionBackwards=!1)},THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(t){(t=this.animationsMap[t])&&(t.direction=-1,t.directionBackwards=!0)},THREE.MorphBlendMesh.prototype.setAnimationFPS=function(t,e){var i=this.animationsMap[t];i&&(i.fps=e,i.duration=(i.end-i.start)/i.fps)},THREE.MorphBlendMesh.prototype.setAnimationDuration=function(t,e){var i=this.animationsMap[t];i&&(i.duration=e,i.fps=(i.end-i.start)/i.duration)},THREE.MorphBlendMesh.prototype.setAnimationWeight=function(t,e){var i=this.animationsMap[t];i&&(i.weight=e)},THREE.MorphBlendMesh.prototype.setAnimationTime=function(t,e){var i=this.animationsMap[t];i&&(i.time=e)},THREE.MorphBlendMesh.prototype.getAnimationTime=function(t){var e=0;return(t=this.animationsMap[t])&&(e=t.time),e},THREE.MorphBlendMesh.prototype.getAnimationDuration=function(t){var e=-1;return(t=this.animationsMap[t])&&(e=t.duration),e},THREE.MorphBlendMesh.prototype.playAnimation=function(t){var e=this.animationsMap[t];e?(e.time=0,e.active=!0):console.warn("animation["+t+"] undefined")},THREE.MorphBlendMesh.prototype.stopAnimation=function(t){(t=this.animationsMap[t])&&(t.active=!1)},THREE.MorphBlendMesh.prototype.update=function(t){for(var e=0,i=this.animationsList.length;e<i;e++){var o=this.animationsList[e];if(o.active){var n=o.duration/o.length;o.time=o.time+o.direction*t,o.mirroredLoop?(o.time>o.duration||o.time<0)&&(o.direction=-1*o.direction,o.time>o.duration&&(o.time=o.duration,o.directionBackwards=!0),o.time<0&&(o.time=0,o.directionBackwards=!1)):(o.time=o.time%o.duration,o.time<0&&(o.time=o.time+o.duration));var r=o.startFrame+THREE.Math.clamp(Math.floor(o.time/n),0,o.length-1),s=o.weight;r!==o.currentFrame&&(this.morphTargetInfluences[o.lastFrame]=0,this.morphTargetInfluences[o.currentFrame]=1*s,this.morphTargetInfluences[r]=0,o.lastFrame=o.currentFrame,o.currentFrame=r),n=o.time%n/n,o.directionBackwards&&(n=1-n),this.morphTargetInfluences[o.currentFrame]=n*s,this.morphTargetInfluences[o.lastFrame]=(1-n)*s}}},THREE.LensFlarePlugin=function(){function t(t){var i=e.createProgram(),o=e.createShader(e.FRAGMENT_SHADER),n=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,t.fragmentShader),e.shaderSource(n,t.vertexShader),e.compileShader(o),e.compileShader(n),e.attachShader(i,o),e.attachShader(i,n),e.linkProgram(i),i}var e,i,o,n,r,s,a,h,l,c,u,m,d;this.init=function(p){e=p.context,i=p,o=new Float32Array(16),n=new Uint16Array(6),p=0,o[p++]=-1,o[p++]=-1,o[p++]=0,o[p++]=0,o[p++]=1,o[p++]=-1,o[p++]=1,o[p++]=0,o[p++]=1,o[p++]=1,o[p++]=1,o[p++]=1,o[p++]=-1,o[p++]=1,o[p++]=0,o[p++]=1,p=0,n[p++]=0,n[p++]=1,n[p++]=2,n[p++]=0,n[p++]=2,n[p++]=3,r=e.createBuffer(),s=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n,e.STATIC_DRAW),a=e.createTexture(),h=e.createTexture(),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGB,16,16,0,e.RGB,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.bindTexture(e.TEXTURE_2D,h),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,16,16,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0?(l=!1,c=t(THREE.ShaderFlares.lensFlare)):(l=!0,c=t(THREE.ShaderFlares.lensFlareVertexTexture)),u={},m={},u.vertex=e.getAttribLocation(c,"position"),u.uv=e.getAttribLocation(c,"uv"),m.renderType=e.getUniformLocation(c,"renderType"),m.map=e.getUniformLocation(c,"map"),m.occlusionMap=e.getUniformLocation(c,"occlusionMap"),m.opacity=e.getUniformLocation(c,"opacity"),m.color=e.getUniformLocation(c,"color"),m.scale=e.getUniformLocation(c,"scale"),m.rotation=e.getUniformLocation(c,"rotation"),m.screenPosition=e.getUniformLocation(c,"screenPosition"),d=!1},this.render=function(t,o,n,p){var t=t.__webglFlares,_=t.length;if(_){var f=new THREE.Vector3,y=p/n,g=.5*n,v=.5*p,x=16/p,b=new THREE.Vector2(x*y,x),E=new THREE.Vector3(1,1,0),T=new THREE.Vector2(1,1),w=m,x=u;e.useProgram(c),d||(e.enableVertexAttribArray(u.vertex),e.enableVertexAttribArray(u.uv),d=!0),e.uniform1i(w.occlusionMap,0),e.uniform1i(w.map,1),e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(x.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(x.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.disable(e.CULL_FACE),e.depthMask(!1);var S,C,R,M,D;for(S=0;S<_;S++)if(x=16/p,b.set(x*y,x),M=t[S],f.set(M.matrixWorld.elements[12],M.matrixWorld.elements[13],M.matrixWorld.elements[14]),o.matrixWorldInverse.multiplyVector3(f),o.projectionMatrix.multiplyVector3(f),E.copy(f),T.x=E.x*g+g,T.y=E.y*v+v,l||T.x>0&&T.x<n&&T.y>0&&T.y<p)for(e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,a),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGB,T.x-8,T.y-8,16,16,0),e.uniform1i(w.renderType,0),e.uniform2f(w.scale,b.x,b.y),e.uniform3f(w.screenPosition,E.x,E.y,E.z),e.disable(e.BLEND),e.enable(e.DEPTH_TEST),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,h),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,T.x-8,T.y-8,16,16,0),e.uniform1i(w.renderType,1),e.disable(e.DEPTH_TEST),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,a),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),M.positionScreen.copy(E),M.customUpdateCallback?M.customUpdateCallback(M):M.updateLensFlares(),e.uniform1i(w.renderType,2),e.enable(e.BLEND),C=0,R=M.lensFlares.length;C<R;C++)D=M.lensFlares[C],D.opacity>.001&&D.scale>.001&&(E.x=D.x,E.y=D.y,E.z=D.z,x=D.size*D.scale/p,b.x=x*y,b.y=x,e.uniform3f(w.screenPosition,E.x,E.y,E.z),e.uniform2f(w.scale,b.x,b.y),e.uniform1f(w.rotation,D.rotation),e.uniform1f(w.opacity,D.opacity),e.uniform3f(w.color,D.color.r,D.color.g,D.color.b),i.setBlending(D.blending,D.blendEquation,D.blendSrc,D.blendDst),i.setTexture(D.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0));e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},THREE.ShadowMapPlugin=function(){var t,e,i,o,n,r,s=new THREE.Frustum,a=new THREE.Matrix4,h=new THREE.Vector3,l=new THREE.Vector3;this.init=function(s){t=s.context,e=s;var s=THREE.ShaderLib.depthRGBA,a=THREE.UniformsUtils.clone(s.uniforms);i=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:a}),o=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:a,morphTargets:!0}),n=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:a,skinning:!0}),r=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:a,morphTargets:!0,skinning:!0}),i._shadowPass=!0,o._shadowPass=!0,n._shadowPass=!0,r._shadowPass=!0},this.render=function(t,i){e.shadowMapEnabled&&e.shadowMapAutoUpdate&&this.update(t,i)},this.update=function(c,u){var m,d,p,_,f,y,g,v,x,b=[];for(_=0,t.clearColor(1,1,1,1),t.disable(t.BLEND),t.enable(t.CULL_FACE),t.frontFace(t.CCW),e.shadowMapCullFrontFaces?t.cullFace(t.FRONT):t.cullFace(t.BACK),e.setDepthTest(!0),m=0,d=c.__lights.length;m<d;m++)if(p=c.__lights[m],p.castShadow)if(p instanceof THREE.DirectionalLight&&p.shadowCascade)for(f=0;f<p.shadowCascadeCount;f++){var E;if(p.shadowCascadeArray[f])E=p.shadowCascadeArray[f];else{x=p,g=f,E=new THREE.DirectionalLight,E.isVirtual=!0,E.onlyShadow=!0,E.castShadow=!0,E.shadowCameraNear=x.shadowCameraNear,E.shadowCameraFar=x.shadowCameraFar,E.shadowCameraLeft=x.shadowCameraLeft,E.shadowCameraRight=x.shadowCameraRight,E.shadowCameraBottom=x.shadowCameraBottom,E.shadowCameraTop=x.shadowCameraTop,E.shadowCameraVisible=x.shadowCameraVisible,E.shadowDarkness=x.shadowDarkness,E.shadowBias=x.shadowCascadeBias[g],E.shadowMapWidth=x.shadowCascadeWidth[g],E.shadowMapHeight=x.shadowCascadeHeight[g],E.pointsWorld=[],E.pointsFrustum=[],v=E.pointsWorld,y=E.pointsFrustum;for(var T=0;T<8;T++)v[T]=new THREE.Vector3,y[T]=new THREE.Vector3;v=x.shadowCascadeNearZ[g],x=x.shadowCascadeFarZ[g],y[0].set(-1,-1,v),y[1].set(1,-1,v),y[2].set(-1,1,v),y[3].set(1,1,v),y[4].set(-1,-1,x),y[5].set(1,-1,x),y[6].set(-1,1,x),y[7].set(1,1,x),E.originalCamera=u,y=new THREE.Gyroscope,y.position=p.shadowCascadeOffset,y.add(E),y.add(E.target),u.add(y),p.shadowCascadeArray[f]=E,console.log("Created virtualLight",E)}g=p,v=f,x=g.shadowCascadeArray[v],x.position.copy(g.position),x.target.position.copy(g.target.position),x.lookAt(x.target),x.shadowCameraVisible=g.shadowCameraVisible,x.shadowDarkness=g.shadowDarkness,x.shadowBias=g.shadowCascadeBias[v],y=g.shadowCascadeNearZ[v],g=g.shadowCascadeFarZ[v],x=x.pointsFrustum,x[0].z=y,x[1].z=y,x[2].z=y,x[3].z=y,x[4].z=g,x[5].z=g,x[6].z=g,x[7].z=g,b[_]=E,_++}else b[_]=p,_++;for(m=0,d=b.length;m<d;m++){if(p=b[m],p.shadowMap||(p.shadowMap=new THREE.WebGLRenderTarget(p.shadowMapWidth,p.shadowMapHeight,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),p.shadowMapSize=new THREE.Vector2(p.shadowMapWidth,p.shadowMapHeight),p.shadowMatrix=new THREE.Matrix4),!p.shadowCamera){if(p instanceof THREE.SpotLight)p.shadowCamera=new THREE.PerspectiveCamera(p.shadowCameraFov,p.shadowMapWidth/p.shadowMapHeight,p.shadowCameraNear,p.shadowCameraFar);else{if(!(p instanceof THREE.DirectionalLight)){console.error("Unsupported light type for shadow");continue}p.shadowCamera=new THREE.OrthographicCamera(p.shadowCameraLeft,p.shadowCameraRight,p.shadowCameraTop,p.shadowCameraBottom,p.shadowCameraNear,p.shadowCameraFar)}c.add(p.shadowCamera),e.autoUpdateScene&&c.updateMatrixWorld()}if(p.shadowCameraVisible&&!p.cameraHelper&&(p.cameraHelper=new THREE.CameraHelper(p.shadowCamera),p.shadowCamera.add(p.cameraHelper)),p.isVirtual&&E.originalCamera==u){for(f=u,_=p.shadowCamera,y=p.pointsFrustum,x=p.pointsWorld,h.set(1/0,1/0,1/0),l.set(-1/0,-1/0,-1/0),g=0;g<8;g++)v=x[g],v.copy(y[g]),THREE.ShadowMapPlugin.__projector.unprojectVector(v,f),_.matrixWorldInverse.multiplyVector3(v),v.x<h.x&&(h.x=v.x),v.x>l.x&&(l.x=v.x),v.y<h.y&&(h.y=v.y),v.y>l.y&&(l.y=v.y),v.z<h.z&&(h.z=v.z),v.z>l.z&&(l.z=v.z);_.left=h.x,_.right=l.x,_.top=l.y,_.bottom=h.y,_.updateProjectionMatrix()}for(_=p.shadowMap,y=p.shadowMatrix,f=p.shadowCamera,f.position.copy(p.matrixWorld.getPosition()),f.lookAt(p.target.matrixWorld.getPosition()),f.updateMatrixWorld(),f.matrixWorldInverse.getInverse(f.matrixWorld),p.cameraHelper&&(p.cameraHelper.visible=p.shadowCameraVisible),p.shadowCameraVisible&&p.cameraHelper.update(),y.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),y.multiplySelf(f.projectionMatrix),y.multiplySelf(f.matrixWorldInverse),f._viewMatrixArray||(f._viewMatrixArray=new Float32Array(16)),f._projectionMatrixArray||(f._projectionMatrixArray=new Float32Array(16)),f.matrixWorldInverse.flattenToArray(f._viewMatrixArray),f.projectionMatrix.flattenToArray(f._projectionMatrixArray),a.multiply(f.projectionMatrix,f.matrixWorldInverse),s.setFromMatrix(a),e.setRenderTarget(_),e.clear(),x=c.__webglObjects,p=0,_=x.length;p<_;p++)g=x[p],y=g.object,g.render=!1,!y.visible||!y.castShadow||y instanceof THREE.Mesh&&y.frustumCulled&&!s.contains(y)||(y._modelViewMatrix.multiply(f.matrixWorldInverse,y.matrixWorld),g.render=!0);for(p=0,_=x.length;p<_;p++)g=x[p],
g.render&&(y=g.object,g=g.buffer,T=y.material instanceof THREE.MeshFaceMaterial?y.geometry.materials[0]:y.material,v=y.geometry.morphTargets.length>0&&T.morphTargets,T=y instanceof THREE.SkinnedMesh&&T.skinning,v=y.customDepthMaterial?y.customDepthMaterial:T?v?r:n:v?o:i,g instanceof THREE.BufferGeometry?e.renderBufferDirect(f,c.__lights,null,v,g,y):e.renderBuffer(f,c.__lights,null,v,g,y));for(x=c.__webglObjectsImmediate,p=0,_=x.length;p<_;p++)g=x[p],y=g.object,y.visible&&y.castShadow&&(y._modelViewMatrix.multiply(f.matrixWorldInverse,y.matrixWorld),e.renderImmediateObject(f,c.__lights,null,i,y))}m=e.getClearColor(),d=e.getClearAlpha(),t.clearColor(m.r,m.g,m.b,d),t.enable(t.BLEND),e.shadowMapCullFrontFaces&&t.cullFace(t.BACK)}},THREE.ShadowMapPlugin.__projector=new THREE.Projector,THREE.SpritePlugin=function(){function t(t,e){return e.z-t.z}var e,i,o,n,r,s,a,h,l,c;this.init=function(t){e=t.context,i=t,o=new Float32Array(16),n=new Uint16Array(6),t=0,o[t++]=-1,o[t++]=-1,o[t++]=0,o[t++]=0,o[t++]=1,o[t++]=-1,o[t++]=1,o[t++]=0,o[t++]=1,o[t++]=1,o[t++]=1,o[t++]=1,o[t++]=-1,o[t++]=1,o[t++]=0,o[t++]=1,t=0,n[t++]=0,n[t++]=1,n[t++]=2,n[t++]=0,n[t++]=2,n[t++]=3,r=e.createBuffer(),s=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n,e.STATIC_DRAW);var t=THREE.ShaderSprite.sprite,u=e.createProgram(),m=e.createShader(e.FRAGMENT_SHADER),d=e.createShader(e.VERTEX_SHADER);e.shaderSource(m,t.fragmentShader),e.shaderSource(d,t.vertexShader),e.compileShader(m),e.compileShader(d),e.attachShader(u,m),e.attachShader(u,d),e.linkProgram(u),a=u,h={},l={},h.position=e.getAttribLocation(a,"position"),h.uv=e.getAttribLocation(a,"uv"),l.uvOffset=e.getUniformLocation(a,"uvOffset"),l.uvScale=e.getUniformLocation(a,"uvScale"),l.rotation=e.getUniformLocation(a,"rotation"),l.scale=e.getUniformLocation(a,"scale"),l.alignment=e.getUniformLocation(a,"alignment"),l.color=e.getUniformLocation(a,"color"),l.map=e.getUniformLocation(a,"map"),l.opacity=e.getUniformLocation(a,"opacity"),l.useScreenCoordinates=e.getUniformLocation(a,"useScreenCoordinates"),l.affectedByDistance=e.getUniformLocation(a,"affectedByDistance"),l.screenPosition=e.getUniformLocation(a,"screenPosition"),l.modelViewMatrix=e.getUniformLocation(a,"modelViewMatrix"),l.projectionMatrix=e.getUniformLocation(a,"projectionMatrix"),c=!1},this.render=function(o,n,u,m){var o=o.__webglSprites,d=o.length;if(d){var p=h,_=l,f=m/u,u=.5*u,y=.5*m,g=!0;e.useProgram(a),c||(e.enableVertexAttribArray(p.position),e.enableVertexAttribArray(p.uv),c=!0),e.disable(e.CULL_FACE),e.enable(e.BLEND),e.depthMask(!0),e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(p.position,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(p.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.uniformMatrix4fv(_.projectionMatrix,!1,n._projectionMatrixArray),e.activeTexture(e.TEXTURE0),e.uniform1i(_.map,0);for(var v,x=[],p=0;p<d;p++)v=o[p],v.visible&&0!==v.opacity&&(v.useScreenCoordinates?v.z=-v.position.z:(v._modelViewMatrix.multiply(n.matrixWorldInverse,v.matrixWorld),v.z=-v._modelViewMatrix.elements[14]));for(o.sort(t),p=0;p<d;p++)v=o[p],v.visible&&0!==v.opacity&&v.map&&v.map.image&&v.map.image.width&&(v.useScreenCoordinates?(e.uniform1i(_.useScreenCoordinates,1),e.uniform3f(_.screenPosition,(v.position.x-u)/u,(y-v.position.y)/y,Math.max(0,Math.min(1,v.position.z)))):(e.uniform1i(_.useScreenCoordinates,0),e.uniform1i(_.affectedByDistance,v.affectedByDistance?1:0),e.uniformMatrix4fv(_.modelViewMatrix,!1,v._modelViewMatrix.elements)),n=v.map.image.width/(v.scaleByViewport?m:1),x[0]=n*f*v.scale.x,x[1]=n*v.scale.y,e.uniform2f(_.uvScale,v.uvScale.x,v.uvScale.y),e.uniform2f(_.uvOffset,v.uvOffset.x,v.uvOffset.y),e.uniform2f(_.alignment,v.alignment.x,v.alignment.y),e.uniform1f(_.opacity,v.opacity),e.uniform3f(_.color,v.color.r,v.color.g,v.color.b),e.uniform1f(_.rotation,v.rotation),e.uniform2fv(_.scale,x),v.mergeWith3D&&!g?(e.enable(e.DEPTH_TEST),g=!0):!v.mergeWith3D&&g&&(e.disable(e.DEPTH_TEST),g=!1),i.setBlending(v.blending,v.blendEquation,v.blendSrc,v.blendDst),i.setTexture(v.map,0),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0));e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}}},THREE.DepthPassPlugin=function(){this.enabled=!1,this.renderTarget=null;var t,e,i,o,n=new THREE.Frustum,r=new THREE.Matrix4;this.init=function(n){t=n.context,e=n;var n=THREE.ShaderLib.depthRGBA,r=THREE.UniformsUtils.clone(n.uniforms);i=new THREE.ShaderMaterial({fragmentShader:n.fragmentShader,vertexShader:n.vertexShader,uniforms:r}),o=new THREE.ShaderMaterial({fragmentShader:n.fragmentShader,vertexShader:n.vertexShader,uniforms:r,morphTargets:!0}),i._shadowPass=!0,o._shadowPass=!0},this.render=function(t,e){this.enabled&&this.update(t,e)},this.update=function(s,a){var h,l,c,u,m,d;for(t.clearColor(1,1,1,1),t.disable(t.BLEND),e.setDepthTest(!0),e.autoUpdateScene&&s.updateMatrixWorld(),a._viewMatrixArray||(a._viewMatrixArray=new Float32Array(16)),a._projectionMatrixArray||(a._projectionMatrixArray=new Float32Array(16)),a.matrixWorldInverse.getInverse(a.matrixWorld),a.matrixWorldInverse.flattenToArray(a._viewMatrixArray),a.projectionMatrix.flattenToArray(a._projectionMatrixArray),r.multiply(a.projectionMatrix,a.matrixWorldInverse),n.setFromMatrix(r),e.setRenderTarget(this.renderTarget),e.clear(),d=s.__webglObjects,h=0,l=d.length;h<l;h++)c=d[h],m=c.object,c.render=!1,!m.visible||m instanceof THREE.Mesh&&m.frustumCulled&&!n.contains(m)||(m._modelViewMatrix.multiply(a.matrixWorldInverse,m.matrixWorld),c.render=!0);for(h=0,l=d.length;h<l;h++)c=d[h],c.render&&(m=c.object,c=c.buffer,m.material&&e.setMaterialFaces(m.material),u=m.customDepthMaterial?m.customDepthMaterial:m.geometry.morphTargets.length?o:i,c instanceof THREE.BufferGeometry?e.renderBufferDirect(a,s.__lights,null,u,c,m):e.renderBuffer(a,s.__lights,null,u,c,m));for(d=s.__webglObjectsImmediate,h=0,l=d.length;h<l;h++)c=d[h],m=c.object,m.visible&&m.castShadow&&(m._modelViewMatrix.multiply(a.matrixWorldInverse,m.matrixWorld),e.renderImmediateObject(a,s.__lights,null,i,m));h=e.getClearColor(),l=e.getClearAlpha(),t.clearColor(h.r,h.g,h.b,l),t.enable(t.BLEND)}},THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:"uniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform int renderType;\nuniform sampler2D occlusionMap;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\nvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +\ntexture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +\ntexture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +\ntexture2D( occlusionMap, vec2( 0.5, 0.5 ) );\nvVisibility = (       visibility.r / 9.0 ) *\n( 1.0 - visibility.g / 9.0 ) *\n(       visibility.b / 9.0 ) *\n( 1.0 - visibility.a / 9.0 );\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"precision mediump float;\nuniform sampler2D map;\nuniform float opacity;\nuniform int renderType;\nuniform vec3 color;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * vVisibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"},lensFlare:{vertexShader:"uniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform int renderType;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"precision mediump float;\nuniform sampler2D map;\nuniform sampler2D occlusionMap;\nuniform float opacity;\nuniform int renderType;\nuniform vec3 color;\nvarying vec2 vUV;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nfloat visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +\ntexture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +\ntexture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +\ntexture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;\nvisibility = ( 1.0 - visibility / 4.0 );\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * visibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"}},THREE.ShaderSprite={sprite:{vertexShader:"uniform int useScreenCoordinates;\nuniform int affectedByDistance;\nuniform vec3 screenPosition;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float rotation;\nuniform vec2 scale;\nuniform vec2 alignment;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uvOffset + uv * uvScale;\nvec2 alignedPosition = position + alignment;\nvec2 rotatedPosition;\nrotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;\nrotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;\nvec4 finalPosition;\nif( useScreenCoordinates != 0 ) {\nfinalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );\n} else {\nfinalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\nfinalPosition.xy += rotatedPosition * ( affectedByDistance == 1 ? 1.0 : finalPosition.z );\n}\ngl_Position = finalPosition;\n}",fragmentShader:"precision mediump float;\nuniform vec3 color;\nuniform sampler2D map;\nuniform float opacity;\nvarying vec2 vUV;\nvoid main() {\nvec4 texture = texture2D( map, vUV );\ngl_FragColor = vec4( color * texture.xyz, texture.a * opacity );\n}"}};var IgeThree=IgeEventingClass.extend({classId:"IgeThree",componentId:"three",init:function(t,e){this._entity=t,this._options=e,this._loader=new THREE.JSONLoader,this._geometryLoader=new THREE.GeometryLoader,IgeEngine.prototype._frontBufferSetup=this.IgeEngine_frontBufferSetup,IgeEntity.prototype._transformContext=this.IgeEntity_transformContext,IgeEntity.prototype._renderEntity=this.IgeEntity_renderEntity,IgeEntity.prototype.material=this.IgeEntity_material,IgeEntity.prototype.model=this.IgeEntity_model,IgeEntity.prototype.mesh=this.IgeEntity_mesh,IgeEntity.prototype._$mount=IgeEntity.prototype.mount,IgeEntity.prototype.mount=this.IgeEntity_mount,IgeEntity.prototype._$unMount=IgeEntity.prototype.unMount,IgeEntity.prototype.unMount=this.IgeEntity_unMount,IgeScene2d.prototype._$init=IgeScene2d.prototype.init,IgeScene2d.prototype.init=this.IgeScene2d_init,IgeCamera.prototype._$init=IgeCamera.prototype.init,IgeCamera.prototype.init=this.IgeCamera_init,IgeCamera.prototype.tick=this.IgeCamera_tick,IgeViewport.prototype.tick=this.IgeViewport_tick},IgeCamera_init:function(t){this._$init(t),this._threeObj=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,1e4)},IgeCamera_tick:function(t){if(this._trackTranslateTarget){var e,i,o,n,r=this._trackTranslateTarget,s=r._translate.x,a=r._translate.y;this._trackTranslateSmoothing?(e=this._translate.x,i=this._translate.y,o=s-e,n=a-i,this._translate.x+=o/this._trackTranslateSmoothing,this._translate.y+=n/this._trackTranslateSmoothing):this.lookAt(this._trackTranslateTarget)}if(this._trackRotateTarget){var h,l,c=void 0!==this._trackRotateTarget._parent?this._trackRotateTarget._parent._rotate.z:0,u=-(c+this._trackRotateTarget._rotate.z);this._trackRotateSmoothing?(h=this._rotate.z,l=u-h,this._rotate.z+=l/this._trackRotateSmoothing):this._rotate.z=u}this._threeObj.position.x=this._translate.x,this._threeObj.position.y=-this._translate.y,this._threeObj.position.z=this._translate.z,this._threeObj.rotation.x=this._rotate.x,this._threeObj.rotation.y=this._rotate.y,this._threeObj.rotation.z=this._rotate.z},IgeViewport_tick:function(t,e){this._scene&&(ige._currentCamera=this.camera,ige._currentViewport=this,this._scene._parent=this,IgeEntity.prototype.tick.apply(this,[t]),this.camera.tick(t),this._scene.tick(t,e),ige._threeRenderer.clear(),ige._threeRenderer.render(this._scene._threeObj,this.camera._threeObj))},IgeScene2d_init:function(t){this._$init(t),this._threeObj=new THREE.Scene;var e=new THREE.AmbientLight(2368548);this._threeObj.add(e);var i=new THREE.SpotLight(14082815,1,0,Math.PI,1);i.position.set(600,400,1e3),i.target.position.set(0,0,0),i.castShadow=!0,i.shadowCameraNear=200,i.shadowCameraFar=1800,i.shadowCameraFov=45,i.shadowBias=5e-4,i.shadowDarkness=.55,i.shadowMapWidth=2048,i.shadowMapHeight=2048,i.shadowMapSoft=!0,this._threeObj.add(i)},IgeEngine_frontBufferSetup:function(t,e){this._threeRenderer=new THREE.WebGLRenderer({antialias:!1}),this._threeRenderer.setSize(window.innerWidth,window.innerHeight),this._threeRenderer.autoClear=!1,this.three._canvas=this._threeRenderer.domElement,document.body.appendChild(this.three._canvas),ige._bounds2d=new IgePoint2d(this.three._canvas.width,this.three._canvas.height)},IgeEntity_transformContext:function(t){},IgeEntity_renderEntity:function(t,e){var i=this._threeObj;i&&(i.position&&(i.position.x=this._translate.x,i.position.y=-this._translate.y,i.position.z=this._translate.z),i.rotation&&(i.rotation.x=this._rotate.x,i.rotation.y=this._rotate.y,i.rotation.z=-this._rotate.z),i.scale&&(i.scale.x=this._scale.x,i.scale.y=this._scale.y,i.scale.z=this._scale.z))},IgeEntity_material:function(t){return void 0!==t?(this._material=t,this):this._material},IgeEntity_model:function(t){return void 0!==t?(ige.three._geometryLoader.path="./models",this._threeObj=new THREE.Mesh(ige.three._geometryLoader.parse(t),this._material||new THREE.MeshFaceMaterial),this._threeObj.receiveShadow=!0,this._threeObj.castShadow=!0,this):this._threeObj},IgeEntity_mesh:function(t){return void 0!==t?(this._threeObj=new THREE.Mesh(t,this._material||new THREE.MeshBasicMaterial({color:255,wireframe:!0})),this):this._threeObj},IgeEntity_mount:function(t){return this._threeObj&&(t._threeObj.add(this._threeObj),this._threeObj._igeEntity=this),this._$mount(t)},IgeEntity_unMount:function(){return this._threeObj&&(delete this._threeObj._igeEntity,this._parent._threeObj.remove(this._threeObj)),this._$unMount()}}),IgeEngine=IgeEntity.extend({classId:"IgeEngine",init:function(){igeConfig.debug&&(igeConfig.debug._enabled||(igeConfig.debug._timing=!1)),this._alwaysInView=!0,this._id="ige",this.basePath="",this.isServer="undefined"!=typeof module&&void 0!==module.exports,this.isClient=!this.isServer,ige=this,IgeEntity.prototype.init.call(this),this.isClient&&this.addComponent(IgeCocoonJsComponent),this._textureStore=[],this._idCounter=(new Date).getTime(),this.addComponent(IgeInputComponent),this.addComponent(IgeTweenComponent),this.addComponent(IgeTimeComponent),this.isClient&&this.addComponent(IgeUiManagerComponent),this._renderModes=["2d","three"],this._requireScriptTotal=0,this._requireScriptLoading=0,this._loadingPreText=void 0,this._enableUpdates=!0,this._enableRenders=!0,this._showSgTree=!1,this._debugEvents={},this._renderContext="2d",this._renderMode=this._renderModes[this._renderContext],this._tickTime="NA",this._updateTime="NA",this._renderTime="NA",this._tickDelta=0,this._fpsRate=60,this._state=0,this._textureImageStore={},this._texturesLoading=0,this._texturesTotal=0,this._dependencyQueue=[],this._drawCount=0,this._dps=0,this._dpf=0,this._frames=0,this._fps=0,this._clientNetDiff=0,this._frameAlternator=!1,this._viewportDepth=!1,this._mousePos=new IgePoint3d(0,0,0),this._currentViewport=null,this._currentCamera=null,this._currentTime=0,this._globalSmoothing=!1,this._register={ige:this},this._categoryRegister={},this._groupRegister={},this._postTick=[],this._timeSpentInUpdate={},this._timeSpentLastUpdate={},this._timeSpentInTick={},this._timeSpentLastTick={},this._timeScale=1,this._globalScale=new IgePoint3d(1,1,1),this._graphInstances=[],this._spawnQueue=[],this._ctx=IgeDummyContext,this._headless=!0,this.dependencyTimeout(3e4),this._dependencyQueue.push(this.texturesLoaded),this._secondTimer=setInterval(this._secondTick,1e3)},$:function(t){return"string"==typeof t?this._register[t]:"object"==typeof t?t:this},$$:function(t){return this._categoryRegister[t]||new IgeArray},$$$:function(t){return this._groupRegister[t]||new IgeArray},register:function(t){return void 0!==t?this._register[t.id()]?(t._registered=!1,this.log('Cannot add object id "'+t.id()+'" to scenegraph because there is already another object in the graph with the same ID!',"error"),!1):(this._register[t.id()]=t,t._registered=!0,this):this._register},unRegister:function(t){return void 0!==t&&this._register[t.id()]&&(delete this._register[t.id()],t._registered=!1),this},categoryRegister:function(t){return void 0!==t&&(this._categoryRegister[t._category]=this._categoryRegister[t._category]||new IgeArray,this._categoryRegister[t._category].push(t),t._categoryRegistered=!0),this._register},categoryUnRegister:function(t){return void 0!==t&&this._categoryRegister[t._category]&&(this._categoryRegister[t._category].pull(t),t._categoryRegistered=!1),this},groupRegister:function(t,e){return void 0!==t&&(this._groupRegister[e]=this._groupRegister[e]||new IgeArray,this._groupRegister[e].push(t),t._groupRegistered=!0),this._register},groupUnRegister:function(t,e){return void 0!==t&&(void 0!==e?this._groupRegister[e]&&(this._groupRegister[e].pull(t),t.groupCount()||(t._groupRegister=!1)):t.removeAllGroups()),this},sync:function(t,e){"string"==typeof e&&(e=[e]),this._syncArr=this._syncArr||[],this._syncArr.push({method:t,attrArr:e}),1===this._syncArr.length&&(this._syncIndex=0,this._processSync())},_processSync:function(){var t;ige._syncIndex<ige._syncArr.length?(t=ige._syncArr[ige._syncIndex],t.attrArr.push(function(){ige._syncIndex++,setTimeout(ige._processSync,1)}),t.method.apply(ige,t.attrArr)):(delete ige._syncArr,delete ige._syncIndex,ige.emit("syncComplete"))},requireScript:function(t,e){if(void 0!==t){var i=this;i._requireScriptTotal++,i._requireScriptLoading++;var o=document.createElement("script");o.addEventListener("load",function(){i._requireScriptLoaded(this),e&&setTimeout(function(){e()},100)}),document.body.appendChild(o),o.src=t,this.log("Loading script from: "+t),this.emit("requireScriptLoading",t)}},_requireScriptLoaded:function(t){this._requireScriptLoading--,this.emit("requireScriptLoaded",t.src),0===this._requireScriptLoading&&this.emit("allRequireScriptsLoaded")},requireStylesheet:function(t){if(void 0!==t){var e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.media="all",e.href=t,document.getElementsByTagName("head")[0].appendChild(e),this.log("Load css stylesheet from: "+t)}},addGraph:function(t,e){if(void 0!==t){var i,o=this.getClass(t);o?(this.log("Loading SceneGraph data class: "+t),i=this.newClassInstance(t),"function"==typeof i.addGraph&&"function"==typeof i.removeGraph?(i.addGraph(e),this._graphInstances[t]=i):this.log('Could not load graph for class name "'+t+'" because the class does not implement both the require methods "addGraph()" and "removeGraph()".',"error")):this.log('Cannot load graph for class name "'+t+'" because the class could not be found. Have you included it in your server/clientConfig.js file?',"error")}return this},removeGraph:function(t,e){if(void 0!==t){var i=this._graphInstances[t];i?(this.log("Removing SceneGraph data class: "+t),i.removeGraph(e),delete this._graphInstances[t]):this.log('Cannot remove graph for class name "'+t+'" because the class instance could not be found. Did you add it via ige.addGraph() ?',"error")}return this},enableUpdates:function(t){return void 0!==t?(this._enableUpdates=t,this):this._enableUpdates},enableRenders:function(t){return void 0!==t?(this._enableRenders=t,this):this._enableRenders},debugEnabled:function(t){return void 0!==t?(igeConfig.debug&&(igeConfig.debug._enabled=t),this):igeConfig.debug._enabled},debugTiming:function(t){return void 0!==t?(igeConfig.debug&&(igeConfig.debug._timing=t),this):igeConfig.debug._timing},debug:function(t){!0===this._debugEvents[t]||(this._debugEvents[t],ige._frames)},debugEventOn:function(t){this._debugEvents[t]=!0},debugEventOff:function(t){this._debugEvents[t]=!1},triggerDebugEventFrame:function(t){this._debugEvents[t]=ige._frames},hideAllExcept:function(t){var e,i=this._register;for(e in i)e!==t&&i[e].opacity(0)},showAll:function(){var t,e=this._register;for(t in e)e[t].show()},setFps:function(t){void 0!==t&&(this.isServer?requestAnimFrame=function(e,i){setTimeout(function(){e((new Date).getTime())},1e3/t)}:window.requestAnimFrame=function(e,i){setTimeout(function(){e((new Date).getTime())},1e3/t)})},showStats:function(){this.log("showStats has been removed from the ige in favour of the new editor component, please remove this call from your code.")},defineClass:function(t,e){igeClassStore[t]=e},getClass:function(t){return igeClassStore[t]},classDefined:function(t){return Boolean(igeClassStore[t])},newClassInstance:function(t,e){return new igeClassStore[t](e)},dependencyCheck:function(){for(var t=this._dependencyQueue,e=t.length;e--;)if(!this._dependencyQueue[e]())return!1;return!0},viewportDepth:function(t){return void 0!==t?(this._viewportDepth=t,this):this._viewportDepth},dependencyTimeout:function(t){this._dependencyCheckTimeout=t},updateProgress:function(){if("undefined"!=typeof document&&document.getElementById){var t=document.getElementById("loadingProgressBar"),e=document.getElementById("loadingText");if(t){var i=parseInt(t.parentNode.offsetWidth),o=Math.floor(i/this._texturesTotal*(this._texturesTotal-this._texturesLoading));t.style.width=o+"px",e&&(void 0===this._loadingPreText&&(this._loadingPreText=e.innerHTML),e.innerHTML=this._loadingPreText+" "+Math.floor(100/this._texturesTotal*(this._texturesTotal-this._texturesLoading))+"%")}}},textureLoadStart:function(t,e){this._texturesLoading++,this._texturesTotal++,this.updateProgress(),this.emit("textureLoadStart",e)},textureLoadEnd:function(t,e){var i=this;e._destroyed||this._textureStore.push(e),this._texturesLoading--,this.updateProgress(),this.emit("textureLoadEnd",e),0===this._texturesLoading&&(this.updateProgress(),setTimeout(function(){i._allTexturesLoaded()},100))},textureFromUrl:function(t){for(var e,i=this._textureStore,o=i.length;o--;)if(e=i[o],e._url===t)return e},texturesLoaded:function(){return 0===ige._texturesLoading},_allTexturesLoaded:function(){this._loggedATL||(this._loggedATL=!0,this.log("All textures have loaded")),this.emit("texturesLoaded")},globalSmoothing:function(t){return void 0!==t?(this._globalSmoothing=t,this):this._globalSmoothing},canvasReady:function(){return void 0!==ige._canvas||ige.isServer},newId:function(){return this._idCounter++,String(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)))},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},newIdFromString:function(t){if(void 0!==t){var e,i,o=0,n=t.length;for(i=0;i<n;i++)o+=t.charCodeAt(i)*Math.pow(10,17);for(e=o.toString(16);ige.$(e);)o+=Math.pow(10,17),e=o.toString(16);return e}},start:function(t){if(!ige._state)if(ige.dependencyCheck()){if(ige.log("Starting engine..."),ige._state=1,this.isClient&&document.getElementsByClassName&&document.getElementsByClassName("igeLoading"))for(var e=document.getElementsByClassName("igeLoading"),i=e.length;i--;)e[i].parentNode.removeChild(e[i]);requestAnimFrame(ige.engineStep),ige.log("Engine started"),"function"==typeof t&&t(!0)}else{var o=(new Date).getTime();ige._dependencyCheckStart||(ige._dependencyCheckStart=o),o-ige._dependencyCheckStart>this._dependencyCheckTimeout?(this.log("Engine start failed because the dependency check timed out after "+this._dependencyCheckTimeout/1e3+" seconds","error"),"function"==typeof t&&t(!1)):setTimeout(function(){ige.start(t)},200)}},stop:function(){return!!this._state&&(this.log("Stopping engine..."),this._state=0,!0)},autoSize:function(t){return void 0!==t?(this._autoSize=t,this):this._autoSize},pixelRatioScaling:function(t){return void 0!==t?(this._pixelRatioScaling=t,this):this._pixelRatioScaling},renderContext:function(t){return void 0!==t?(this._renderContext=t,this._renderMode=this._renderModes[t],this.log("Rendering mode set to: "+t),this):this._renderContext},createFrontBuffer:function(t,e){this.isClient&&(this._canvas||(this._createdFrontBuffer=!0,this._pixelRatioScaling=!e,this._frontBufferSetup(t,e)))},_frontBufferSetup:function(t,e){var i=document.createElement("canvas");i.id="igeFrontBuffer",this.canvas(i,t),document.body.appendChild(i)},canvas:function(t,e){return void 0!==t&&(this._canvas||(this._canvas=t,this._ctx=this._canvas.getContext(this._renderContext),this._pixelRatioScaling?(this._devicePixelRatio=window.devicePixelRatio||1,this._backingStoreRatio=this._ctx.webkitBackingStorePixelRatio||this._ctx.mozBackingStorePixelRatio||this._ctx.msBackingStorePixelRatio||this._ctx.oBackingStorePixelRatio||this._ctx.backingStorePixelRatio||1,this._deviceFinalDrawRatio=this._devicePixelRatio/this._backingStoreRatio):(this._devicePixelRatio=1,this._backingStoreRatio=1,this._deviceFinalDrawRatio=1),e&&(this._autoSize=e),window.addEventListener("resize",this._resizeEvent),this._resizeEvent(),this._ctx=this._canvas.getContext(this._renderContext),this._headless=!1,this.input.setupListeners(this._canvas))),this._canvas},clearCanvas:function(){this._ctx&&this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)},removeCanvas:function(){this.input&&this.input.destroyListeners(),window.removeEventListener("resize",this._resizeEvent),this._createdFrontBuffer&&document.body.removeChild(this._canvas),delete this._canvas,delete this._ctx,this._ctx=IgeDummyContext,this._headless=!0},openUrl:function(t){void 0!==t&&(ige.cocoonJs&&ige.cocoonJs.detected?ige.cocoonJs.openUrl(t):window.open(t))},showWebView:function(t){if(ige.cocoonJs&&ige.cocoonJs.detected)ige.cocoonJs.showWebView(t);else{var e=document.getElementById("igeOverlay");e||(e=document.createElement("iframe"),e.id="igeOverlay",e.style.position="absolute",e.style.border="none",e.style.left="0px",e.style.top="0px",e.style.width="100%",e.style.height="100%",document.body.appendChild(e)),void 0!==t&&(e.src=t),e.style.display="block"}return this},hideWebView:function(){if(ige.cocoonJs&&ige.cocoonJs.detected)ige.cocoonJs.hideWebView();else{var t=document.getElementById("igeOverlay");t&&(t.style.display="none")}return this},layerCall:function(js){void 0!==js&&eval(js)},mousePos:function(){return this._mousePos.clone()},mouseOverList:function(t,e){var i,o,n,r,s=!1;if(t||(t=ige,e=[],s=!0),t===ige){if(i=t._children)for(o=i.length;o--;)i[o]._scene&&i[o]._scene._shouldRender&&this.mouseOverList(i[o]._scene,e)}else if(n=this.mousePosWorld(),n&&t.aabb&&(r=t.aabb(),r.xyInside(n.x,n.y)&&e.push(t)),i=t._children)for(o=i.length;o--;)this.mouseOverList(i[o],e);return s&&e.reverse(),e},_resizeEvent:function(t){var e;if(ige._autoSize){var i=window.innerWidth,o=window.innerHeight,n=ige._children,r=n.length;for(ige._canvas&&(e=ige._canvasPosition(),i-=parseInt(e.left),o-=parseInt(e.top),i%2&&i--,o%2&&o--,ige._canvas.width=i*ige._deviceFinalDrawRatio,ige._canvas.height=o*ige._deviceFinalDrawRatio,1!==ige._deviceFinalDrawRatio&&(ige._canvas.style.width=i+"px",ige._canvas.style.height=o+"px",ige._ctx.scale(ige._deviceFinalDrawRatio,ige._deviceFinalDrawRatio))),ige._bounds2d=new IgePoint3d(i,o,0);r--;)n[r]._resizeEvent(t)}else ige._canvas&&(ige._bounds2d=new IgePoint3d(ige._canvas.width,ige._canvas.height,0));if(ige._showSgTree){var s=document.getElementById("igeSgTree");e=ige._canvasPosition(),s.style.top=parseInt(e.top)+5+"px",s.style.left=parseInt(e.left)+5+"px",s.style.height=ige._bounds2d.y-30+"px"}ige._resized=!0},_canvasPosition:function(){try{return ige._canvas.getBoundingClientRect()}catch(t){return{top:ige._canvas.offsetTop,left:ige._canvas.offsetLeft}}},toggleFullScreen:function(){var t=this._canvas;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen()},watchStart:function(t){return this._watch=this._watch||[],this._watch.push(t),this._watch.length-1},watchStop:function(t){this._watch=this._watch||[],this._watch.splice(t,1)},traceSet:function(t,e,i,o){t.___igeTraceCurrentVal=t.___igeTraceCurrentVal||{},t.___igeTraceCurrentVal[e]=t[e],t.___igeTraceMax=i||1,t.___igeTraceCount=0,Object.defineProperty(t,e,{get:function(){return t.___igeTraceCurrentVal[e]},set:function(i){o&&o(i),t.___igeTraceCurrentVal[e]=i,++t.___igeTraceCount===t.___igeTraceMax&&ige.traceSetOff(t,e)}})},traceSetOff:function(t,e){Object.defineProperty(t,e,{set:function(t){this.___igeTraceCurrentVal[e]=t}})},findBaseClass:function(t){return t&&t._classId?"Ige"===t._classId.substr(0,3)?t._classId:t.__proto__._classId?this.findBaseClass(t.__proto__):"":""},getClassDerivedList:function(t,e){return e?t._classId&&e.push(t._classId):e=[],t.__proto__._classId&&this.getClassDerivedList(t.__proto__,e),e},spawnQueue:function(t){return void 0!==t?(this._spawnQueue.push(t),this):this._spawnQueue},_secondTick:function(){var t=ige;t._fps=t._frames,t._dps=t._dpf*t._fps,t._frames=0,t._drawCount=0},timeScale:function(t){return void 0!==t?(this._timeScale=t,this):this._timeScale},incrementTime:function(t,e){return this._pause||(e||(e=t),this._currentTime+=(t-e)*this._timeScale),this._currentTime},currentTime:function(){return this._currentTime},pause:function(t){return void 0!==t?(this._pause=t,this):this._pause},useManualTicks:function(t){return void 0!==t?(this._useManualTicks=t,this):this._useManualTicks},manualTick:function(){this._manualFrameAlternator!==this._frameAlternator&&(this._manualFrameAlternator=this._frameAlternator,requestAnimFrame(this.engineStep))},useManualRender:function(t){return void 0!==t?(this._useManualRender=t,this):this._useManualRender},manualRender:function(){this._manualRender=!0},engineStep:function(t,e){var i,o,n,r,s,a,h,l,c,u=ige,m=u._postTick,d=m.length;if(u.incrementTime(t,u._timeScaleLastTimestamp),u._timeScaleLastTimestamp=t,t=Math.floor(u._currentTime),igeConfig.debug._timing&&(i=(new Date).getTime()),u._state){for(void 0===e&&(e=u._ctx),u._frameAlternator=!u._frameAlternator,ige._useManualTicks?u._manualFrameAlternator=!u._frameAlternator:requestAnimFrame(u.engineStep),u._tickStart=t,u._tickStart-=u._clientNetDiff,u.lastTick?u._tickDelta=u._tickStart-u.lastTick:(u.lastTick=0,u._tickDelta=0),a=ige._spawnQueue,h=a.length,l=h-1;l>=0;l--)c=a[l],ige._currentTime>=c._bornTime&&(c.mount(ige.$(c._birthMount)),a.splice(l,1));for(u._enableUpdates&&(igeConfig.debug._timing?(n=(new Date).getTime(),u.updateSceneGraph(e),ige._updateTime=(new Date).getTime()-n):u.updateSceneGraph(e)),u._enableRenders&&(u._useManualRender?u._manualRender&&(igeConfig.debug._timing?(r=(new Date).getTime(),u.renderSceneGraph(e),ige._renderTime=(new Date).getTime()-r):u.renderSceneGraph(e),u._manualRender=!1):igeConfig.debug._timing?(r=(new Date).getTime(),u.renderSceneGraph(e),ige._renderTime=(new Date).getTime()-r):u.renderSceneGraph(e)),s=0;s<d;s++)m[s]();u.lastTick=u._tickStart,u._frames++,u._dpf=u._drawCount,u._drawCount=0,u.input.tick()}
u._resized=!1,igeConfig.debug._timing&&(o=(new Date).getTime(),ige._tickTime=o-i)},updateSceneGraph:function(t){var e,i,o,n=this._children,r=ige._tickDelta;if(this._processUpdateBehaviours(t,r),n)if(e=n.length,igeConfig.debug._timing)for(;e--;)i=(new Date).getTime(),n[e].update(t,r),o=(new Date).getTime()-i,n[e]&&(ige._timeSpentInUpdate[n[e].id()]||(ige._timeSpentInUpdate[n[e].id()]=0),ige._timeSpentLastUpdate[n[e].id()]||(ige._timeSpentLastUpdate[n[e].id()]={}),ige._timeSpentInUpdate[n[e].id()]+=o,ige._timeSpentLastUpdate[n[e].id()].ms=o);else for(;e--;)n[e].update(t,r)},renderSceneGraph:function(t){var e,i;this._processTickBehaviours(t),this._viewportDepth&&(igeConfig.debug._timing?(e=(new Date).getTime(),this.depthSortChildren(),i=(new Date).getTime()-e,ige._timeSpentLastTick[this.id()]||(ige._timeSpentLastTick[this.id()]={}),ige._timeSpentLastTick[this.id()].depthSortChildren=i):this.depthSortChildren()),t.save(),t.translate(this._bounds2d.x2,this._bounds2d.y2);var o,n=this._children;if(n)if(o=n.length,igeConfig.debug._timing)for(;o--;)t.save(),e=(new Date).getTime(),n[o].tick(t),i=(new Date).getTime()-e,n[o]&&(ige._timeSpentInTick[n[o].id()]||(ige._timeSpentInTick[n[o].id()]=0),ige._timeSpentLastTick[n[o].id()]||(ige._timeSpentLastTick[n[o].id()]={}),ige._timeSpentInTick[n[o].id()]+=i,ige._timeSpentLastTick[n[o].id()].ms=i),t.restore();else for(;o--;)t.save(),n[o].tick(t),t.restore();t.restore()},fps:function(){return this._fps},dpf:function(){return this._dpf},dps:function(){return this._dps},analyseTiming:function(){igeConfig.debug._timing||this.log("Cannot analyse timing because the igeConfig.debug._timing flag is not enabled so no timing data has been recorded!","warning")},saveSceneGraph:function(t){var e,i,o;if(t||(t=this.getSceneGraphData()),t.obj.stringify?t.str=t.obj.stringify():console.log("Class "+t.classId+" has no stringify() method! For object: "+t.id,t.obj),e=t.items)for(i=e.length,o=0;o<i;o++)this.saveSceneGraph(e[o]);return t},sceneGraph:function(t,e,i){var o,n,r,s,a="";for(void 0===e&&(e=0),t||(t=ige),o=0;o<e;o++)a+="----";if(igeConfig.debug._timing?(n="",n+="T: "+ige._timeSpentInTick[t.id()],ige._timeSpentLastTick[t.id()]&&("number"==typeof ige._timeSpentLastTick[t.id()].ms&&(n+=" | LastTick: "+ige._timeSpentLastTick[t.id()].ms),"number"==typeof ige._timeSpentLastTick[t.id()].depthSortChildren&&(n+=" | ChildDepthSort: "+ige._timeSpentLastTick[t.id()].depthSortChildren)),console.log(a+t.id()+" ("+t._classId+") : "+t._inView+" Timing("+n+")")):console.log(a+t.id()+" ("+t._classId+") : "+t._inView),e++,t===ige){if(r=t._children)for(s=r.length;s--;)r[s]._scene&&r[s]._scene._shouldRender&&(igeConfig.debug._timing?(n="",n+="T: "+ige._timeSpentInTick[r[s].id()],ige._timeSpentLastTick[r[s].id()]&&("number"==typeof ige._timeSpentLastTick[r[s].id()].ms&&(n+=" | LastTick: "+ige._timeSpentLastTick[r[s].id()].ms),"number"==typeof ige._timeSpentLastTick[r[s].id()].depthSortChildren&&(n+=" | ChildDepthSort: "+ige._timeSpentLastTick[r[s].id()].depthSortChildren)),console.log(a+"----"+r[s].id()+" ("+r[s]._classId+") : "+r[s]._inView+" Timing("+n+")")):console.log(a+"----"+r[s].id()+" ("+r[s]._classId+") : "+r[s]._inView),this.sceneGraph(r[s]._scene,e+1))}else if(r=t._children)for(s=r.length;s--;)this.sceneGraph(r[s],e)},getSceneGraphData:function(t,e){var i,o,n,r,s,a,h=[];if(t||(t=ige),i={text:"["+t._classId+"] "+t.id(),id:t.id(),classId:t.classId()},e?t._parent?i.parentId=t._parent.id():i.parentId="sceneGraph":(i.parent=t._parent,i.obj=t),t===ige){if(s=t._children)for(a=s.length;a--;)o={text:"["+s[a]._classId+"] "+s[a].id(),id:s[a].id(),classId:s[a].classId()},e?s[a]._parent&&(o.parentId=s[a]._parent.id()):(o.parent=s[a]._parent,o.obj=s[a]),s[a].camera?(r={text:"[IgeCamera] "+s[a].id(),id:s[a].camera.id(),classId:s[a].camera.classId()},e?r.parentId=s[a].id():(r.parent=s[a],r.obj=s[a].camera),s[a]._scene&&(n=this.getSceneGraphData(s[a]._scene,e),o.items=[r,n])):s[a]._scene&&(n=this.getSceneGraphData(s[a]._scene,e),o.items=[n]),h.push(o)}else if(s=t._children)for(a=s.length;a--;)o=this.getSceneGraphData(s[a],e),h.push(o);return h.length>0&&(i.items=h),i},_childMounted:function(t){t.IgeViewport&&(ige._currentViewport||(ige._currentViewport=t,ige._currentCamera=t.camera)),IgeEntity.prototype._childMounted.call(this,t)},destroy:function(){this.stop(),this.isClient&&this.removeCanvas(),IgeEntity.prototype.destroy.call(this),this.log("Engine destroy complete.")}});window.IgeEngine=IgeEngine,"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=IgeEngine);
//# sourceMappingURL=engine.min.js.map
